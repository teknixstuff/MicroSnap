<!DOCTYPE html>
<html>
    <head>
        <title>Snap! Build Your Own Blocks</title>
        <link rel="icon" href="data:image/x-icon;base64,AAABAAMAICAAAAEAIAAoEQAANgAAABgYAAABACAAuAkAAF4RAAAQEAAAAQAgAGgEAAAWGwAAKAAAACAAAABAAAAAAQAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABkZ3VKYG593mFte9RgZnMoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcHaDKTJPYK8fdonyKkVYxKenryAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAExYZcADq8n/CtPq/wOhw/9qcYAkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAE9ca2QDk7H/D9Tv/xDj//8Drs7/g4qU3AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtJ6iRw+Env8V8v//Ed/9/yRfc+u/v78EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACCgo4tA4ek/xbv//8X5v//Ed77/wObuP+BiJTKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8JO2t9/w7Z+f8W6///C5ax/5+VmmUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////Aixfc+kP2Pf/Fuf//xTP6v84aXn/ZWt4/6estjEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACDgoutBpm3/xbs//8M0fH/Rm9//f/b2wcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACyqq5CEX6X/xXr//8U5P//FW+H/8qztv////8sAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANjNzS4ecIP/EeT//xXq//8OeJH/taqvYAAAAAAAAAAAAAAAAAAAAAAAAAAA////AW14hNoHtdL/F+n//wi72/9Xbnz//f39fQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AmhzgPYKvN7/F+v//way0f9qeIT2////AwAAAAAAAAAAAAAAAAAAAAD06uoYKWt9/xDc/P8U7f//DoKc/7Cip/////8JAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbC1axKEnf8U6P//EuL+/yVtgv/i1tY+AAAAAAAAAAAAAAAAAAAAAK+orGkOiqP/Fev//xHb+v8saHz/8+jogwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/7+8QQWp7/wzR9P8X7P//B5Ku/4SEjdIAAAAAAAAAAAAAAAD///8BaHaD5we62/8X6f//BrXU/2h0gP////8TAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACdkpi4C5e0/xbt//8P0/H/LVtt//Pz8xYAAAAAAAAAAOjc3BYoboH/EN/9/xTs//8OgJv/rKCmvgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAO7e3i4wYnX/D9/8/xXq//8SepP/ta6zawAAAAAAAAAAq6SobQyNp/8U7P//Edv6/ypkd//w5uY0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////An5vee8Jnbv/F/D//wez1P9qdoPeAAAAAP///wVOZ3f4CsDh/xfq//8Gr87/cXuH+v///wMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA0rq6YCFqgf8T6f//EOD//yVvg/////8D6tragx9ug/8S4///FOv//w9+lv+1qa9/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8NWmh2/wi/4P8V8f//DIGc/7Slqva3rrL/DJCr/xXr//8Q2fv/LGN1//bt7RwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACom6K4C4Oa/xbw//8LxeT/anaA/25reP8KwOH/Fu3//widu/96eoPr////AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPbo6Dg8bX3/Dtr4/xft//8caoD/G0tf/xfh+/8S6f//GHGJ/8y4umgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////BoOEjv8Go8D/FvH//xueu/8cnrr/Fuz//wzO8f9LXm7///PzFgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA2svOrR5zh/8S4///GOH//xjg//8V6f//C5y4/5KJkOL///8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///tGaXN//wm63P8W5f//Ft///xLn//8dcor/1sPDXQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///xXFsbX/G3mR/xPl/f8X4f//Cszt/1Bjcv/v7+8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////BP3z8v9HV2b/Dczv/xTt//8LmbP/lo+VyAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA0L7B/x9ziv8R5v3/Eub//yBzi//cx8c7AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///wGDgoz/B5y5/xbt//8KwOL/W2p5+v///wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//DwETtRY/8O0/P/FvD//wZ+m/+Nho9yAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////Av///xKQhY3EDY+r/xXm//8S4f3/IWR4/+vY2A0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAXWx4VXuJlPKNjZj/cXF7/xpofv8T3/r/Fu7//weiwv9ta3eNAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAdj6PAA6K7/wdsi/8Jm7j/FeL//xjp//8P2fT/G1lt/9W/vwwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACKJoYgL8P//EfT//xHy//8S5f//Ccfj/w9Xcv+jnKNQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVWp7VyN2h/8ijKD/IYyh/yN9jv9HX3H/vbjAXQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////Ad/f3wj39fWh3c/S7c66ve3Otbrt2svO7fnz88X///8K////A////wH///8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKAAAABgAAAAwAAAAAQAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABu7O4Yb6utFL///8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8BopyoWIygqeu5tr1JAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACqqqoDA3CL/wavwf83eI2f////AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///wE1cYaqA6O//wO72f8ueI3lAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMYie6Qv6//8Inbv/taqxSAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFx8jX0Dw+T/FvP//wS82v80fI/gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAfpGbfwa/4f8I2Pb/X4mY+P///wQAAAAAAAAAAAAAAAAAAAAA5dPTHRmGn/8R9P//EazI/46JkP/Kw8dNAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA0sbGKBeNpv8Q9P//Fo2n/9XHy0kAAAAAAAAAAAAAAAAAAAAAl5ykwgey0v8M4vv/PnyP///q6gwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////A1+IlvoJ2vj/Bb3e/4SWoNQAAAAAAAAAAAAAAAD/7u4PTIeW/wnh/v8GsdX/mJukxgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALqxtn0Ko8L/Duz//zB/lP/v398QAAAAAAAAAADZzdBRGZKs/w/z//8ZjKX/3NDTUQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPTq6hg9g5f/DOv//wWgvv+ioqdaAAAAAAAAAACSm6TEBrna/wrd/v9Nf5D/////DgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACYlZ3OB7LT/wna+f9UgZHv////A////xJHhZb/CeP+/wax0f+ZnaXKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADp09M6KXuR/w3y//8ZkKr/6NrcvNXJzNgPka3/EPP//xyJof/h0dVDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8Dc4aS+AbM7f8FuNj/oJ6l/6Cor/8GveD/CNn6/1KBkf////8HAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAx7e8chGWsP8M6///SnyN/0pxgv8M6P//CKTE/6Ogp5wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////E0uElf8K6P//FpKw/xaGof8P8v//K4CX//Hd3SUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKKlq9QHr87/GN/6/xnc+v8Gzu//bISR7f///wEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPDh4VUyhZv/Dub//xTr//8MoL7/uK2vXQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///xiPj5j/CbPV/w7s//8whJj//+rqDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///wiDjpj/B7/i/wbQ8/9zi5itAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPPc3BYwe5D/DO///wyVsv++srgrAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8C////L6acodoLnr//De///yx0iu////8CAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIiZmQ+nqrLpmJSb/yeBl/8Q7///BLLV/4OLlWMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABWasrMDn7v/CKPD/xLr//8I2/b/KXCE/+vr6w0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////ASuCmf8Iwtv/Dcjm/w2pvf81d47/z8XJtQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8D/Pz8ScvHy+6mpq3unp+o7q6rr+7s4uLu////KwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8tAAAAAP///yPw5+ji9OLl4v///xsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AQAAAAAAAAAAY5mo+kWisv/U2NyCAAAAAAAAAAAAAAAAAAAAAM7O1h9Ap7zKJ6C4683P2FsAAAAAAAAAAAAAAAAAAAAAAAAAAGqotzUDv9n/cKe3/f///wMAAAAAAAAAAP/f3wg9n7P6A9Pr/yaasP/JztGiAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEbjR/yKzyP/g19s5AAAAAAAAAAC+wslLB7vW/yuxxf/gzc70////CgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFWsvLADwN7/l7S90P///wEAAAAAdrO9wgPC3/94q7r/////RwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACxvMgXA73X/z2nvP/27e1V8+fnKjGwyP8GuNL/wMXL7f///wIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADenvf8GttD/0dDU/8fM0f8Eu9X/Nq3E/+/j41EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACPrrjMA7zZ/4Ort/+ArLr/A8Pi/3yvuv////8GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA2s/VMB22zf8mnrP/Kpqu/xK50//FxMeFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP+AgAJnrbz/A8Ti/wbO6/9Jprj/9evrGQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAxMXL/xi/2P8D1O7/j6y51v///wEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAObY2ekkqsX/ELXR/9DQ0EYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACqtLztA7vT/0eluf////8GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACus7u+OK/B/wO+2v+XrraQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAfmbOeA7DP/wPJ4/9Qpbf/9+fnIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8MAAAAAAAAAAD///80hbG841mvveN6p7Hj5Nvd4////0P///8F////AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" type="image/x-icon">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="white"/>
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="apple-mobile-web-app-title" content="Snap!">
        <meta name="msapplication-TileColor" content="#FFFFFF">
        <script>var morphicVersion="2022-April-26";var modules={};var useBlurredShadows=true;const ZERO=new Point;const BLACK=new Color;const WHITE=new Color(255,255,255);const CLEAR=new Color(0,0,0,0);Object.freeze(ZERO);Object.freeze(BLACK);Object.freeze(WHITE);Object.freeze(CLEAR);var standardSettings={minimumFontHeight:getMinimumFontHeight(),globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:12,bubbleHelpFontSize:10,prompterFontName:"sans-serif",prompterFontSize:12,prompterSliderSize:10,handleSize:15,scrollBarSize:9,mouseScrollAmount:40,useSliderForInput:false,isTouchDevice:false,pngPayloadMarker:"Data\tPayload\tEmbedded",rasterizeSVGs:false,isFlat:false,grabThreshold:5,showHoles:false};var touchScreenSettings={minimumFontHeight:standardSettings.minimumFontHeight,globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:24,bubbleHelpFontSize:18,prompterFontName:"sans-serif",prompterFontSize:24,prompterSliderSize:20,handleSize:26,scrollBarSize:24,mouseScrollAmount:40,useSliderForInput:false,isTouchDevice:true,pngPayloadMarker:"Data\tPayload\tEmbedded",rasterizeSVGs:false,isFlat:false,grabThreshold:5,showHoles:false};var MorphicPreferences=standardSettings;enableRetinaSupport();function nop(){return null}function localize(string){return string}function isNil(thing){return thing===undefined||thing===null}function contains(list,element){return list.indexOf(element)!==-1}function detect(list,predicate){var i,size=list.length;for(i=0;i<size;i+=1){if(predicate.call(null,list[i])){return list[i]}}return null}function sizeOf(object){var size=0,key;for(key in object){if(Object.prototype.hasOwnProperty.call(object,key)){size+=1}}return size}function isString(target){return typeof target==="string"||target instanceof String}function isObject(target){return target!==null&&(typeof target==="object"||target instanceof Object)}function radians(degrees){return degrees*Math.PI/180}function degrees(radians){return radians*180/Math.PI}function fontHeight(height){var minHeight=Math.max(height,MorphicPreferences.minimumFontHeight);return minHeight*1.2}function isWordChar(aCharacter){return aCharacter.match(/[A-zÀ-ÿ0-9]/)}function isURLChar(aCharacter){return aCharacter.match(/[A-z0-9./:?&_+%-]/)}function isURL(text){return/^https?:\/\//.test(text)}function newCanvas(extentPoint,nonRetina,recycleMe){var canvas,ext;nonRetina=nonRetina||false;ext=(extentPoint||(recycleMe?new Point(recycleMe.width,recycleMe.height):new Point(0,0))).ceil();if(recycleMe&&!recycleMe.dataset.morphicShare&&(recycleMe.isRetinaEnabled||false)!==nonRetina&&ext.x===recycleMe.width&&ext.y===recycleMe.height){canvas=recycleMe;canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height);return canvas}else{canvas=document.createElement("canvas");canvas.width=ext.x;canvas.height=ext.y}if(nonRetina&&canvas.isRetinaEnabled){canvas.isRetinaEnabled=false}return canvas}function copyCanvas(aCanvas){var c;if(aCanvas&&aCanvas.width&&aCanvas.height){c=newCanvas(new Point(aCanvas.width,aCanvas.height),!aCanvas.isRetinaEnabled);c.getContext("2d").drawImage(aCanvas,0,0);return c}return aCanvas}function getMinimumFontHeight(){var str="I",size=50,canvas=document.createElement("canvas"),ctx,maxX,data,x,y;canvas.width=size;canvas.height=size;ctx=canvas.getContext("2d");ctx.font="1px serif";maxX=ctx.measureText(str).width;ctx.fillStyle="black";ctx.textBaseline="bottom";ctx.fillText(str,0,size);for(y=0;y<size;y+=1){for(x=0;x<maxX;x+=1){data=ctx.getImageData(x,y,1,1);if(data.data[3]!==0){return size-y+1}}}return 0}function getDocumentPositionOf(aDOMelement){var rect=aDOMelement.getBoundingClientRect(),scrollLeft=window.pageXOffset||document.documentElement.scrollLeft,scrollTop=window.pageYOffset||document.documentElement.scrollTop;return{x:rect.left+scrollLeft,y:rect.top+scrollTop}}function copy(target){var value,c,property,keys,l,i;if(typeof target!=="object"){return target}value=target.valueOf();if(target!==value){return new target.constructor(value)}if(target instanceof target.constructor&&target.constructor!==Object){c=Object.create(target.constructor.prototype);keys=Object.keys(target);for(l=keys.length,i=0;i<l;i+=1){property=keys[i];if(target[property]instanceof HTMLCanvasElement){target[property].dataset.morphicShare="true"}c[property]=target[property]}}else{c={};for(property in target){c[property]=target[property]}}return c}function embedMetadataPNG(aCanvas,aString){var embedTag=MorphicPreferences.pngPayloadMarker,crc32=(str,crc)=>{let table=[...Array(256).keys()].map(it=>[...Array(8)].reduce(cc=>cc&1?3988292384^cc>>>1:cc>>>1,it));crc=[...str].reduce((crc,ch)=>crc>>>8^table[(crc^ch.charCodeAt(0))&255],(crc?crc=0:crc)^-1);return(crc^-1)>>>0},arr2Str=arr=>arr.reduce((res,byte)=>res+String.fromCharCode(byte),""),int2BStr=val=>arr2Str(Array.from(new Uint8Array(new Uint32Array([val]).buffer)).reverse()),buildChunk=data=>{let res="iTXt"+data;return int2BStr(data.length)+res+int2BStr(crc32(res))},parts=aCanvas.toDataURL("image/png").split(","),bPart=atob(parts[1]).split(""),newChunk=buildChunk("Snap!_SRC\0\0\0\0\0"+embedTag+encodeURIComponent(aString)+embedTag);bPart.splice(-12,0,...newChunk);parts[1]=btoa(bPart.join(""));return parts.join(",")}function enableRetinaSupport(){var ctx=document.createElement("canvas").getContext("2d"),backingStorePixelRatio=ctx.webkitBackingStorePixelRatio||ctx.mozBackingStorePixelRatio||ctx.msBackingStorePixelRatio||ctx.oBackingStorePixelRatio||ctx.backingStorePixelRatio||1,originalDevicePixelRatio=Math.ceil(window.devicePixelRatio),canvasProto=HTMLCanvasElement.prototype,contextProto=CanvasRenderingContext2D.prototype,uber={drawImage:contextProto.drawImage,getImageData:contextProto.getImageData,width:Object.getOwnPropertyDescriptor(canvasProto,"width"),height:Object.getOwnPropertyDescriptor(canvasProto,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(contextProto,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(contextProto,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(contextProto,"shadowBlur")};if(backingStorePixelRatio===originalDevicePixelRatio){return}if(Object.keys(uber).some(any=>{var prop=uber[any];return prop.hasOwnProperty("configurable")&&!prop.configurable})){return}function getPixelRatio(imageSource){return imageSource.isRetinaEnabled?(originalDevicePixelRatio||1)/backingStorePixelRatio:1}canvasProto._isRetinaEnabled=true;canvasProto._bak=uber;Object.defineProperty(canvasProto,"isRetinaEnabled",{get:function(){return this._isRetinaEnabled},set:function(enabled){var prevPixelRatio=getPixelRatio(this),prevWidth=this.width,prevHeight=this.height;this._isRetinaEnabled=enabled;if(getPixelRatio(this)!=prevPixelRatio){this.width=prevWidth;this.height=prevHeight}},configurable:true});Object.defineProperty(canvasProto,"width",{get:function(){return uber.width.get.call(this)/getPixelRatio(this)},set:function(width){try{var pixelRatio=getPixelRatio(this),context;uber.width.set.call(this,width*pixelRatio);context=this.getContext("2d");context.scale(pixelRatio,pixelRatio)}catch(err){console.log("Retina Display Support Problem",err);uber.width.set.call(this,width)}}});Object.defineProperty(canvasProto,"height",{get:function(){return uber.height.get.call(this)/getPixelRatio(this)},set:function(height){var pixelRatio=getPixelRatio(this),context;uber.height.set.call(this,height*pixelRatio);context=this.getContext("2d");context.scale(pixelRatio,pixelRatio)}});contextProto.drawImage=function(image){var pixelRatio=getPixelRatio(image),sx,sy,sWidth,sHeight,dx,dy,dWidth,dHeight;switch(arguments.length){case 9:sx=arguments[1];sy=arguments[2];sWidth=arguments[3];sHeight=arguments[4];dx=arguments[5];dy=arguments[6];dWidth=arguments[7];dHeight=arguments[8];break;case 5:sx=0;sy=0;sWidth=image.width;sHeight=image.height;dx=arguments[1];dy=arguments[2];dWidth=arguments[3];dHeight=arguments[4];break;case 3:sx=0;sy=0;sWidth=image.width;sHeight=image.height;dx=arguments[1];dy=arguments[2];dWidth=image.width;dHeight=image.height;break;default:throw Error("Called drawImage() with "+arguments.length+" arguments")}uber.drawImage.call(this,image,sx*pixelRatio,sy*pixelRatio,sWidth*pixelRatio,sHeight*pixelRatio,dx,dy,dWidth,dHeight)};contextProto.getImageData=function(sx,sy,sw,sh){var pixelRatio=getPixelRatio(this.canvas);return uber.getImageData.call(this,sx*pixelRatio,sy*pixelRatio,sw*pixelRatio,sh*pixelRatio)};Object.defineProperty(contextProto,"shadowOffsetX",{get:function(){return uber.shadowOffsetX.get.call(this)/getPixelRatio(this.canvas)},set:function(offset){var pixelRatio=getPixelRatio(this.canvas);uber.shadowOffsetX.set.call(this,offset*pixelRatio)}});Object.defineProperty(contextProto,"shadowOffsetY",{get:function(){return uber.shadowOffsetY.get.call(this)/getPixelRatio(this.canvas)},set:function(offset){var pixelRatio=getPixelRatio(this.canvas);uber.shadowOffsetY.set.call(this,offset*pixelRatio)}});Object.defineProperty(contextProto,"shadowBlur",{get:function(){return uber.shadowBlur.get.call(this)/getPixelRatio(this.canvas)},set:function(blur){var pixelRatio=getPixelRatio(this.canvas);uber.shadowBlur.set.call(this,blur*pixelRatio)}})}function isRetinaSupported(){var ctx=document.createElement("canvas").getContext("2d"),backingStorePixelRatio=ctx.webkitBackingStorePixelRatio||ctx.mozBackingStorePixelRatio||ctx.msBackingStorePixelRatio||ctx.oBackingStorePixelRatio||ctx.backingStorePixelRatio||1,canvasProto=HTMLCanvasElement.prototype,contextProto=CanvasRenderingContext2D.prototype,uber={drawImage:contextProto.drawImage,getImageData:contextProto.getImageData,width:Object.getOwnPropertyDescriptor(canvasProto,"width"),height:Object.getOwnPropertyDescriptor(canvasProto,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(contextProto,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(contextProto,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(contextProto,"shadowBlur")};return backingStorePixelRatio!==window.devicePixelRatio&&!Object.keys(uber).some(any=>{var prop=uber[any];return prop.hasOwnProperty("configurable")&&!prop.configurable})}function isRetinaEnabled(){return HTMLCanvasElement.prototype.hasOwnProperty("_isRetinaEnabled")}function disableRetinaSupport(){var canvasProto,contextProto,uber;if(!isRetinaEnabled()){return}canvasProto=HTMLCanvasElement.prototype;contextProto=CanvasRenderingContext2D.prototype;uber=canvasProto._bak;Object.defineProperty(canvasProto,"width",uber.width);Object.defineProperty(canvasProto,"height",uber.height);contextProto.drawImage=uber.drawImage;contextProto.getImageData=uber.getImageData;Object.defineProperty(contextProto,"shadowOffsetX",uber.shadowOffsetX);Object.defineProperty(contextProto,"shadowOffsetY",uber.shadowOffsetY);Object.defineProperty(contextProto,"shadowBlur",uber.shadowBlur);delete canvasProto._isRetinaEnabled;delete canvasProto.isRetinaEnabled;delete canvasProto._bak}function normalizeCanvas(aCanvas,getCopy){var cpy;if(!aCanvas.isRetinaEnabled){return aCanvas}cpy=newCanvas(new Point(aCanvas.width,aCanvas.height),true);cpy.getContext("2d").drawImage(aCanvas,0,0);if(getCopy){return cpy}aCanvas.isRetinaEnabled=false;aCanvas.width=cpy.width;aCanvas.height=cpy.height;aCanvas.getContext("2d").drawImage(cpy,0,0);return aCanvas}function Animation(setter,getter,delta,duration,easing,onComplete){this.setter=setter;this.getter=getter;this.delta=delta||0;this.duration=duration||0;this.easing=isString(easing)?this.easings[easing]||this.easings.sinusoidal:easing||this.easings.sinusoidal;this.onComplete=onComplete||null;this.endTime=null;this.destination=null;this.isActive=false;this.start()}Animation.prototype.easings={linear:t=>t,sinusoidal:t=>1-Math.cos(radians(t*90)),quadratic:t=>t<.5?2*t*t:(4-2*t)*t-1,cubic:t=>{return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},elastic:t=>{return(t-=.5)<0?(.01+.01/t)*Math.sin(50*t):(.02-.01/t)*Math.sin(50*t)+1},sine_in:t=>1-Math.sin(radians(90+t*90)),quad_in:t=>t*t,cubic_in:t=>t*t*t,elastic_in:t=>(.04-.04/t)*Math.sin(25*t)+1,sine_out:t=>Math.sin(radians(t*90)),quad_out:t=>t*(2-t),elastic_out:t=>.04*t/--t*Math.sin(25*t)};Animation.prototype.start=function(){this.endTime=Date.now()+this.duration;this.destination=this.getter.call(this)+this.delta;this.isActive=true};Animation.prototype.step=function(){if(!this.isActive){return}var now=Date.now();if(now>this.endTime){this.setter(this.destination);this.isActive=false;if(this.onComplete){this.onComplete()}}else{this.setter(this.destination-this.delta*this.easing((this.endTime-now)/this.duration))}};function Color(r,g,b,a){this.r=r||0;this.g=g||0;this.b=b||0;this.a=a||(a===0?0:1)}Color.prototype.toString=function(){return"rgba("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+","+this.a+")"};Color.prototype.toRGBstring=function(){return"rgb("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+")"};Color.fromString=function(aString){var components=aString.split(/[\(),]/).slice(1,5);return new Color(components[0],components[1],components[2],components[3])};Color.prototype.copy=function(){return new Color(this.r,this.g,this.b,this.a)};Color.prototype.eq=function(aColor,observeAlpha){return aColor&&this.r===aColor.r&&this.g===aColor.g&&this.b===aColor.b&&(observeAlpha?this.a===aColor.a:true)};Color.prototype.isCloseTo=function(aColor,observeAlpha,tolerance){var thres=2.55*(tolerance||10);function dist(a,b){var diff=a-b;return diff<0?255+diff:diff}return aColor&&dist(this.r,aColor.r)<thres&&dist(this.g,aColor.g)<thres&&dist(this.b,aColor.b)<thres&&(observeAlpha?this.a===aColor.a:true)};Color.prototype.hsv=function(){var max,min,h,s,v,d,rr=this.r/255,gg=this.g/255,bb=this.b/255;max=Math.max(rr,gg,bb);min=Math.min(rr,gg,bb);h=max;s=max;v=max;d=max-min;s=max===0?0:d/max;if(max===min){h=0}else{switch(max){case rr:h=(gg-bb)/d+(gg<bb?6:0);break;case gg:h=(bb-rr)/d+2;break;case bb:h=(rr-gg)/d+4;break}h/=6}return[h,s,v]};Color.prototype.set_hsv=function(h,s,v){var i,f,p,q,t;i=Math.floor(h*6);f=h*6-i;p=v*(1-s);q=v*(1-f*s);t=v*(1-(1-f)*s);switch(i%6){case 0:this.r=v;this.g=t;this.b=p;break;case 1:this.r=q;this.g=v;this.b=p;break;case 2:this.r=p;this.g=v;this.b=t;break;case 3:this.r=p;this.g=q;this.b=v;break;case 4:this.r=t;this.g=p;this.b=v;break;case 5:this.r=v;this.g=p;this.b=q;break}this.r*=255;this.g*=255;this.b*=255};Color.prototype.hsl=function(){var rr=this.r/255,gg=this.g/255,bb=this.b/255,max=Math.max(rr,gg,bb),min=Math.min(rr,gg,bb),h,s,l=(max+min)/2,d;if(max===min){h=0;s=0}else{d=max-min;s=l>.5?d/(2-max-min):d/(max+min);switch(max){case rr:h=(gg-bb)/d+(gg<bb?6:0);break;case gg:h=(bb-rr)/d+2;break;case bb:h=(rr-gg)/d+4;break}h/=6}return[h,s,l]};Color.prototype.set_hsl=function(h,s,l){var q,p;function hue2rgb(p,q,t){if(t<0){t+=1}if(t>1){t-=1}if(t<1/6){return p+(q-p)*6*t}if(t<1/2){return q}if(t<2/3){return p+(q-p)*(2/3-t)*6}return p}if(s==0){this.r=l;this.g=l;this.b=l}else{q=l<.5?l*(1+s):l+s-l*s;p=2*l-q;this.r=hue2rgb(p,q,h+1/3);this.g=hue2rgb(p,q,h);this.b=hue2rgb(p,q,h-1/3)}this.r*=255;this.g*=255;this.b*=255};Color.prototype.mixed=function(proportion,otherColor){var frac1=Math.min(Math.max(proportion,0),1),frac2=1-frac1;return new Color(this.r*frac1+otherColor.r*frac2,this.g*frac1+otherColor.g*frac2,this.b*frac1+otherColor.b*frac2)};Color.prototype.darker=function(percent){var fract=.8333;if(percent){fract=(100-percent)/100}return this.mixed(fract,new Color(0,0,0))};Color.prototype.lighter=function(percent){var fract=.8333;if(percent){fract=(100-percent)/100}return this.mixed(fract,WHITE)};Color.prototype.dansDarker=function(){var hsv=this.hsv(),result=new Color,vv=Math.max(hsv[2]-.16,0);result.set_hsv(hsv[0],hsv[1],vv);return result};Color.prototype.inverted=function(){return new Color(255-this.r,255-this.g,255-this.b)};Color.prototype.solid=function(){return new Color(this.r,this.g,this.b)};function Point(x,y){this.x=x||0;this.y=y||0}Point.prototype.toString=function(){return Math.round(this.x.toString())+"@"+Math.round(this.y.toString())};Point.prototype.copy=function(){return new Point(this.x,this.y)};Point.prototype.eq=function(aPoint){return this.x===aPoint.x&&this.y===aPoint.y};Point.prototype.lt=function(aPoint){return this.x<aPoint.x&&this.y<aPoint.y};Point.prototype.gt=function(aPoint){return this.x>aPoint.x&&this.y>aPoint.y};Point.prototype.ge=function(aPoint){return this.x>=aPoint.x&&this.y>=aPoint.y};Point.prototype.le=function(aPoint){return this.x<=aPoint.x&&this.y<=aPoint.y};Point.prototype.max=function(aPoint){return new Point(Math.max(this.x,aPoint.x),Math.max(this.y,aPoint.y))};Point.prototype.min=function(aPoint){return new Point(Math.min(this.x,aPoint.x),Math.min(this.y,aPoint.y))};Point.prototype.round=function(){return new Point(Math.round(this.x),Math.round(this.y))};Point.prototype.abs=function(){return new Point(Math.abs(this.x),Math.abs(this.y))};Point.prototype.neg=function(){return new Point(-this.x,-this.y)};Point.prototype.mirror=function(){return new Point(this.y,this.x)};Point.prototype.floor=function(){return new Point(Math.max(Math.floor(this.x),0),Math.max(Math.floor(this.y),0))};Point.prototype.ceil=function(){return new Point(Math.ceil(this.x),Math.ceil(this.y))};Point.prototype.add=function(other){if(other instanceof Point){return new Point(this.x+other.x,this.y+other.y)}return new Point(this.x+other,this.y+other)};Point.prototype.subtract=function(other){if(other instanceof Point){return new Point(this.x-other.x,this.y-other.y)}return new Point(this.x-other,this.y-other)};Point.prototype.multiplyBy=function(other){if(other instanceof Point){return new Point(this.x*other.x,this.y*other.y)}return new Point(this.x*other,this.y*other)};Point.prototype.divideBy=function(other){if(other instanceof Point){return new Point(this.x/other.x,this.y/other.y)}return new Point(this.x/other,this.y/other)};Point.prototype.floorDivideBy=function(other){if(other instanceof Point){return new Point(Math.floor(this.x/other.x),Math.floor(this.y/other.y))}return new Point(Math.floor(this.x/other),Math.floor(this.y/other))};Point.prototype.r=function(){var t=this.multiplyBy(this);return Math.sqrt(t.x+t.y)};Point.prototype.degrees=function(){var tan,theta;if(this.x===0){if(this.y>=0){return 90}return 270}tan=this.y/this.x;theta=Math.atan(tan);if(this.x>=0){if(this.y>=0){return degrees(theta)}return 360+degrees(theta)}return 180+degrees(theta)};Point.prototype.theta=function(){var tan,theta;if(this.x===0){if(this.y>=0){return radians(90)}return radians(270)}tan=this.y/this.x;theta=Math.atan(tan);if(this.x>=0){if(this.y>=0){return theta}return radians(360)+theta}return radians(180)+theta};Point.prototype.crossProduct=function(aPoint){return this.multiplyBy(aPoint.mirror())};Point.prototype.distanceTo=function(aPoint){return aPoint.subtract(this).r()};Point.prototype.rotate=function(direction,center){var offset=this.subtract(center);if(direction==="right"){return new Point(-offset.y,offset.y).add(center)}if(direction==="left"){return new Point(offset.y,-offset.y).add(center)}return center.subtract(offset)};Point.prototype.flip=function(direction,center){if(direction==="vertical"){return new Point(this.x,center.y*2-this.y)}return new Point(center.x*2-this.x,this.y)};Point.prototype.distanceAngle=function(dist,angle){var deg=angle,x,y;if(deg>270){deg=deg-360}else if(deg<-270){deg=deg+360}if(-90<=deg&&deg<=90){x=Math.sin(radians(deg))*dist;y=Math.sqrt(dist*dist-x*x);return new Point(x+this.x,this.y-y)}x=Math.sin(radians(180-deg))*dist;y=Math.sqrt(dist*dist-x*x);return new Point(x+this.x,this.y+y)};Point.prototype.scaleBy=function(scalePoint){return this.multiplyBy(scalePoint)};Point.prototype.translateBy=function(deltaPoint){return this.add(deltaPoint)};Point.prototype.rotateBy=function(angle,centerPoint){var center=centerPoint||ZERO,p=this.subtract(center),r=p.r(),theta=angle-p.theta();return new Point(center.x+r*Math.cos(theta),center.y-r*Math.sin(theta))};Point.prototype.asArray=function(){return[this.x,this.y]};function Rectangle(left,top,right,bottom){this.init(new Point(left||0,top||0),new Point(right||0,bottom||0))}Rectangle.prototype.init=function(originPoint,cornerPoint){this.origin=originPoint;this.corner=cornerPoint};Rectangle.prototype.toString=function(){return"["+this.origin.toString()+" | "+this.extent().toString()+"]"};Rectangle.prototype.copy=function(){return new Rectangle(this.left(),this.top(),this.right(),this.bottom())};Point.prototype.corner=function(cornerPoint){return new Rectangle(this.x,this.y,cornerPoint.x,cornerPoint.y)};Point.prototype.rectangle=function(aPoint){var org,crn;org=this.min(aPoint);crn=this.max(aPoint);return new Rectangle(org.x,org.y,crn.x,crn.y)};Point.prototype.extent=function(aPoint){var crn=this.add(aPoint);return new Rectangle(this.x,this.y,crn.x,crn.y)};Rectangle.prototype.setTo=function(left,top,right,bottom){this.origin=new Point(left||(left===0?0:this.left()),top||(top===0?0:this.top()));this.corner=new Point(right||(right===0?0:this.right()),bottom||(bottom===0?0:this.bottom()))};Rectangle.prototype.setExtent=function(aPoint){this.setWidth(aPoint.x);this.setHeight(aPoint.y)};Rectangle.prototype.setWidth=function(width){this.corner.x=this.origin.x+width};Rectangle.prototype.setHeight=function(height){this.corner.y=this.origin.y+height};Rectangle.prototype.area=function(){var w=this.width();if(w<0){return 0}return Math.max(w*this.height(),0)};Rectangle.prototype.bottom=function(){return this.corner.y};Rectangle.prototype.bottomCenter=function(){return new Point(this.center().x,this.bottom())};Rectangle.prototype.bottomLeft=function(){return new Point(this.origin.x,this.corner.y)};Rectangle.prototype.bottomRight=function(){return this.corner.copy()};Rectangle.prototype.boundingBox=function(){return this};Rectangle.prototype.center=function(){return this.origin.add(this.corner.subtract(this.origin).floorDivideBy(2))};Rectangle.prototype.corners=function(){return[this.origin,this.bottomLeft(),this.corner,this.topRight()]};Rectangle.prototype.extent=function(){return this.corner.subtract(this.origin)};Rectangle.prototype.height=function(){return this.corner.y-this.origin.y};Rectangle.prototype.left=function(){return this.origin.x};Rectangle.prototype.leftCenter=function(){return new Point(this.left(),this.center().y)};Rectangle.prototype.right=function(){return this.corner.x};Rectangle.prototype.rightCenter=function(){return new Point(this.right(),this.center().y)};Rectangle.prototype.top=function(){return this.origin.y};Rectangle.prototype.topCenter=function(){return new Point(this.center().x,this.top())};Rectangle.prototype.topLeft=function(){return this.origin};Rectangle.prototype.topRight=function(){return new Point(this.corner.x,this.origin.y)};Rectangle.prototype.width=function(){return this.corner.x-this.origin.x};Rectangle.prototype.position=function(){return this.origin};Rectangle.prototype.eq=function(aRect){return this.origin.eq(aRect.origin)&&this.corner.eq(aRect.corner)};Rectangle.prototype.abs=function(){var newOrigin,newCorner;newOrigin=this.origin.abs();newCorner=this.corner.max(newOrigin);return newOrigin.corner(newCorner)};Rectangle.prototype.insetBy=function(delta){var result=new Rectangle;result.origin=this.origin.add(delta);result.corner=this.corner.subtract(delta);return result};Rectangle.prototype.expandBy=function(delta){var result=new Rectangle;result.origin=this.origin.subtract(delta);result.corner=this.corner.add(delta);return result};Rectangle.prototype.growBy=function(delta){var result=new Rectangle;result.origin=this.origin.copy();result.corner=this.corner.add(delta);return result};Rectangle.prototype.intersect=function(aRect){var result=new Rectangle;result.origin=this.origin.max(aRect.origin);result.corner=this.corner.min(aRect.corner);return result};Rectangle.prototype.merge=function(aRect){var result=new Rectangle;result.origin=this.origin.min(aRect.origin);result.corner=this.corner.max(aRect.corner);return result};Rectangle.prototype.mergeWith=function(aRect){this.origin=this.origin.min(aRect.origin);this.corner=this.corner.max(aRect.corner)};Rectangle.prototype.round=function(){return this.origin.round().corner(this.corner.round())};Rectangle.prototype.spread=function(){return this.origin.floor().corner(this.corner.ceil())};Rectangle.prototype.amountToTranslateWithin=function(aRect){var dx=0,dy=0;if(this.right()>aRect.right()){dx=aRect.right()-this.right()}if(this.bottom()>aRect.bottom()){dy=aRect.bottom()-this.bottom()}if(this.left()+dx<aRect.left()){dx=aRect.left()-this.left()}if(this.top()+dy<aRect.top()){dy=aRect.top()-this.top()}return new Point(dx,dy)};Rectangle.prototype.regionsAround=function(aRect){var regions=[];if(!this.intersects(aRect)){return regions}if(aRect.left()>this.left()){regions.push(new Rectangle(this.left(),this.top(),aRect.left(),this.bottom()))}if(aRect.top()>this.top()){regions.push(new Rectangle(this.left(),this.top(),this.right(),aRect.top()))}if(aRect.right()<this.right()){regions.push(new Rectangle(aRect.right(),this.top(),this.right(),this.bottom()))}if(aRect.bottom()<this.bottom()){regions.push(new Rectangle(this.left(),aRect.bottom(),this.right(),this.bottom()))}return regions};Rectangle.prototype.containsPoint=function(aPoint){return this.origin.le(aPoint)&&aPoint.lt(this.corner)};Rectangle.prototype.containsRectangle=function(aRect){return aRect.origin.gt(this.origin)&&aRect.corner.lt(this.corner)};Rectangle.prototype.intersects=function(aRect){var ro=aRect.origin,rc=aRect.corner;return rc.x>=this.origin.x&&rc.y>=this.origin.y&&ro.x<=this.corner.x&&ro.y<=this.corner.y};Rectangle.prototype.isNearTo=function(aRect,threshold){var ro=aRect.origin,rc=aRect.corner,border=threshold||0;return rc.x+border>=this.origin.x&&rc.y+border>=this.origin.y&&ro.x-border<=this.corner.x&&ro.y-border<=this.corner.y};Rectangle.prototype.scaleBy=function(scale){var o=this.origin.multiplyBy(scale),c=this.corner.multiplyBy(scale);return new Rectangle(o.x,o.y,c.x,c.y)};Rectangle.prototype.translateBy=function(delta){var o=this.origin.add(delta),c=this.corner.add(delta);return new Rectangle(o.x,o.y,c.x,c.y)};Rectangle.prototype.asArray=function(){return[this.left(),this.top(),this.right(),this.bottom()]};Rectangle.prototype.asArray_xywh=function(){return[this.left(),this.top(),this.width(),this.height()]};function Node(parent,childrenArray){this.init(parent||null,childrenArray||[])}Node.prototype.init=function(parent,childrenArray){this.parent=parent||null;this.children=childrenArray||[]};Node.prototype.toString=function(){return"a Node"+"["+this.children.length.toString()+"]"};Node.prototype.addChild=function(aNode){this.children.push(aNode);aNode.parent=this};Node.prototype.addChildFirst=function(aNode){this.children.splice(0,null,aNode);aNode.parent=this};Node.prototype.removeChild=function(aNode){var idx=this.children.indexOf(aNode);if(idx!==-1){this.children.splice(idx,1)}};Node.prototype.root=function(){if(this.parent===null){return this}return this.parent.root()};Node.prototype.depth=function(){if(this.parent===null){return 0}return this.parent.depth()+1};Node.prototype.allChildren=function(){var result=[this];this.children.forEach(child=>{result=result.concat(child.allChildren())});return result};Node.prototype.forAllChildren=function(aFunction){if(this.children.length>0){this.children.forEach(child=>child.forAllChildren(aFunction))}aFunction.call(null,this)};Node.prototype.anyChild=function(aPredicate){var i;if(aPredicate.call(null,this)){return true}for(i=0;i<this.children.length;i+=1){if(this.children[i].anyChild(aPredicate)){return true}}return false};Node.prototype.allLeafs=function(){var result=[];this.allChildren().forEach(element=>{if(element.children.length===0){result.push(element)}});return result};Node.prototype.allParents=function(){var result=[this];if(this.parent!==null){result=result.concat(this.parent.allParents())}return result};Node.prototype.siblings=function(){if(this.parent===null){return[]}return this.parent.children.filter(child=>child!==this)};Node.prototype.parentThatIsA=function(){var i;for(i=0;i<arguments.length;i+=1){if(this instanceof arguments[i]){return this}}if(!this.parent){return null}return this.parentThatIsA.apply(this.parent,arguments)};Node.prototype.parentThatIsAnyOf=function(constructors){return this.parentThatIsA.apply(this,constructors)};Node.prototype.childThatIsA=function(){var i,hit;for(i=0;i<arguments.length;i+=1){if(this instanceof arguments[i]){return this}}if(!this.children.length){return null}for(i=0;i<this.children.length;i+=1){hit=this.childThatIsA.apply(this.children[i],arguments);if(hit){return hit}}return null};var Morph;var WorldMorph;var HandMorph;var ShadowMorph;var FrameMorph;var MenuMorph;var HandleMorph;var StringFieldMorph;var ColorPickerMorph;var SliderMorph;var ScrollFrameMorph;var InspectorMorph;var StringMorph;var TextMorph;Morph.prototype=new Node;Morph.prototype.constructor=Morph;Morph.uber=Node.prototype;Morph.prototype.shadowBlur=4;function Morph(){this.init()}Morph.prototype.init=function(){Morph.uber.init.call(this);this.isMorph=true;this.cachedImage=null;this.isCachingImage=false;this.shouldRerender=false;this.bounds=new Rectangle(0,0,50,40);this.holes=[];this.color=new Color(80,80,80);this.texture=null;this.cachedTexture=null;this.alpha=1;this.isVisible=true;this.isDraggable=false;this.isTemplate=false;this.acceptsDrops=false;this.isFreeForm=false;this.noDropShadow=false;this.fullShadowSource=true;this.fps=0;this.customContextMenu=null;this.lastTime=Date.now();this.onNextStep=null};Morph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+" "+this.children.length.toString()+" "+this.bounds};Morph.prototype.destroy=function(){if(this.parent!==null){this.fullChanged();this.parent.removeChild(this)}};Morph.prototype.stepFrame=function(){if(!this.step){return null}var current,elapsed,leftover,nxt;current=Date.now();elapsed=current-this.lastTime;if(this.fps>0){leftover=1e3/this.fps-elapsed}else{leftover=0}if(leftover<1){this.lastTime=current;if(this.onNextStep){nxt=this.onNextStep;this.onNextStep=null;nxt.call(this)}this.step();this.children.forEach(child=>child.stepFrame())}};Morph.prototype.nextSteps=function(arrayOfFunctions){var lst=arrayOfFunctions||[],nxt=lst.shift();if(nxt){this.onNextStep=()=>{nxt.call(this);this.nextSteps(lst)}}};Morph.prototype.step=nop;Morph.prototype.left=function(){return this.bounds.left()};Morph.prototype.right=function(){return this.bounds.right()};Morph.prototype.top=function(){return this.bounds.top()};Morph.prototype.bottom=function(){return this.bounds.bottom()};Morph.prototype.center=function(){return this.bounds.center()};Morph.prototype.bottomCenter=function(){return this.bounds.bottomCenter()};Morph.prototype.bottomLeft=function(){return this.bounds.bottomLeft()};Morph.prototype.bottomRight=function(){return this.bounds.bottomRight()};Morph.prototype.boundingBox=function(){return this.bounds};Morph.prototype.corners=function(){return this.bounds.corners()};Morph.prototype.leftCenter=function(){return this.bounds.leftCenter()};Morph.prototype.rightCenter=function(){return this.bounds.rightCenter()};Morph.prototype.topCenter=function(){return this.bounds.topCenter()};Morph.prototype.topLeft=function(){return this.bounds.topLeft()};Morph.prototype.topRight=function(){return this.bounds.topRight()};Morph.prototype.position=function(){return this.bounds.origin};Morph.prototype.extent=function(){return this.bounds.extent()};Morph.prototype.width=function(){return this.bounds.width()};Morph.prototype.height=function(){return this.bounds.height()};Morph.prototype.fullBounds=function(){var result;result=this.bounds;this.children.forEach(child=>{if(child.isVisible){result=result.merge(child.fullBounds())}});return result};Morph.prototype.fullBoundsNoShadow=function(){var result;result=this.bounds;this.children.forEach(child=>{if(!(child instanceof ShadowMorph)&&child.isVisible){result=result.merge(child.fullBounds())}});return result};Morph.prototype.visibleBounds=function(){var visible=this.bounds,frames=this.allParents().filter(p=>p instanceof FrameMorph);frames.forEach(f=>visible=visible.intersect(f.bounds));return visible};Morph.prototype.moveBy=function(delta){var children=this.children,i=children.length;this.changed();this.bounds=this.bounds.translateBy(delta);this.changed();for(i;i>0;i-=1){children[i-1].moveBy(delta)}};Morph.prototype.setPosition=function(aPoint){var delta=aPoint.subtract(this.topLeft());if(!delta.eq(ZERO)){this.moveBy(delta)}};Morph.prototype.setLeft=function(x){this.setPosition(new Point(x,this.top()))};Morph.prototype.setRight=function(x){this.setPosition(new Point(x-this.width(),this.top()))};Morph.prototype.setTop=function(y){this.setPosition(new Point(this.left(),y))};Morph.prototype.setBottom=function(y){this.setPosition(new Point(this.left(),y-this.height()))};Morph.prototype.setCenter=function(aPoint){this.setPosition(aPoint.subtract(this.extent().floorDivideBy(2)))};Morph.prototype.setFullCenter=function(aPoint){this.setPosition(aPoint.subtract(this.fullBounds().extent().floorDivideBy(2)))};Morph.prototype.keepWithin=function(aMorph){var leftOff,rightOff,topOff,bottomOff;rightOff=this.fullBounds().right()-aMorph.right();if(rightOff>0){this.moveBy(new Point(-rightOff,0))}leftOff=this.fullBounds().left()-aMorph.left();if(leftOff<0){this.moveBy(new Point(-leftOff,0))}bottomOff=this.fullBounds().bottom()-aMorph.bottom();if(bottomOff>0){this.moveBy(new Point(0,-bottomOff))}topOff=this.fullBounds().top()-aMorph.top();if(topOff<0){this.moveBy(new Point(0,-topOff))}};Morph.prototype.scrollIntoView=function(){var leftOff,rightOff,topOff,bottomOff,sf=this.parentThatIsA(ScrollFrameMorph);if(!sf){return}rightOff=Math.min(this.fullBounds().right()-sf.right(),sf.contents.right()-sf.right());if(rightOff>0){sf.contents.moveBy(new Point(-rightOff,0))}leftOff=this.fullBounds().left()-sf.left();if(leftOff<0){sf.contents.moveBy(new Point(-leftOff,0))}topOff=this.fullBounds().top()-sf.top();if(topOff<0){sf.contents.moveBy(new Point(0,-topOff))}bottomOff=this.fullBounds().bottom()-sf.bottom();if(bottomOff>0){sf.contents.moveBy(new Point(0,-bottomOff))}sf.adjustScrollBars()};Morph.prototype.setExtent=function(aPoint){if(aPoint.eq(this.extent())){return}this.changed();this.bounds.setWidth(aPoint.x);this.bounds.setHeight(aPoint.y);this.fixLayout();this.rerender()};Morph.prototype.setWidth=function(width){this.setExtent(new Point(width||0,this.height()))};Morph.prototype.setHeight=function(height){this.setExtent(new Point(this.width(),height||0))};Morph.prototype.setColor=function(aColor){if(aColor){if(!this.color.eq(aColor)){this.color=aColor;this.rerender()}}};Morph.prototype.getImage=function(){var img;if(this.cachedImage&&!this.shouldRerender){return this.cachedImage}img=newCanvas(this.extent(),false,this.cachedImage);if(this.isCachingImage){this.cachedImage=img}this.render(img.getContext("2d"));this.shouldRerender=false;return img};Morph.prototype.render=function(aContext){aContext.fillStyle=this.getRenderColor().toString();aContext.fillRect(0,0,this.width(),this.height());if(this.cachedTexture){this.renderCachedTexture(aContext)}else if(this.texture){this.renderTexture(this.texture,aContext)}};Morph.prototype.getRenderColor=function(){return this.color};Morph.prototype.fixLayout=function(){return};Morph.prototype.fixHolesLayout=function(){return};Morph.prototype.renderTexture=function(url,ctx){this.cachedTexture=new Image;this.cachedTexture.onload=()=>this.changed();this.cachedTexture.src=this.texture=url};Morph.prototype.renderCachedTexture=function(ctx){var bg=this.cachedTexture,cols=Math.floor(this.width()/bg.width),lines=Math.floor(this.height()/bg.height),x,y;ctx.save();ctx.globalAlpha=this.alpha;ctx.beginPath();ctx.rect(0,0,this.width(),this.height());ctx.clip();for(y=0;y<=lines;y+=1){for(x=0;x<=cols;x+=1){ctx.drawImage(bg,x*bg.width,y*bg.height)}}ctx.restore()};Morph.prototype.drawOn=function(ctx,rect){var clipped=rect.intersect(this.bounds),pos=this.position(),pic,src,w,h,sl,st;if(!clipped.extent().gt(ZERO)){return}ctx.save();ctx.globalAlpha=this.alpha;if(this.isCachingImage){pic=this.getImage();src=clipped.translateBy(pos.neg());sl=src.left();st=src.top();w=Math.min(src.width(),pic.width-sl);h=Math.min(src.height(),pic.height-st);if(w<1||h<1){return}ctx.drawImage(pic,sl,st,w,h,clipped.left(),clipped.top(),w,h)}else{ctx.beginPath();ctx.rect(clipped.left(),clipped.top(),clipped.width(),clipped.height());ctx.clip();ctx.translate(pos.x,pos.y);this.render(ctx);if(MorphicPreferences.showHoles){ctx.translate(-pos.x,-pos.y);ctx.globalAlpha=.25;ctx.fillStyle="white";this.holes.forEach(hole=>{var sect=hole.translateBy(pos).intersect(clipped);ctx.fillRect(sect.left(),sect.top(),sect.width(),sect.height())})}}ctx.restore()};Morph.prototype.fullDrawOn=function(aContext,aRect){if(!this.isVisible){return}this.drawOn(aContext,aRect);this.children.forEach(child=>child.fullDrawOn(aContext,aRect))};Morph.prototype.hide=function(){this.isVisible=false;this.changed()};Morph.prototype.show=function(){this.isVisible=true;this.changed()};Morph.prototype.toggleVisibility=function(){this.isVisible=!this.isVisible;this.changed()};Morph.prototype.fullImage=function(){var fb=this.fullBounds(),img=newCanvas(fb.extent()),ctx=img.getContext("2d");ctx.translate(-fb.origin.x,-fb.origin.y);this.fullDrawOn(ctx,fb);return img};Morph.prototype.shadowImage=function(off,color){var fb,img,outline,sha,ctx,offset=off||new Point(7,7),clr=color||new Color(0,0,0);if(this.fullShadowSource){fb=this.fullBounds().extent();img=this.fullImage()}else{fb=this.extent();img=this.getImage()}outline=newCanvas(fb);ctx=outline.getContext("2d");ctx.drawImage(img,0,0);ctx.globalCompositeOperation="destination-out";ctx.drawImage(img,-offset.x,-offset.y);sha=newCanvas(fb);ctx=sha.getContext("2d");ctx.drawImage(outline,0,0);ctx.globalCompositeOperation="source-atop";ctx.fillStyle=clr.toString();ctx.fillRect(0,0,fb.x,fb.y);return sha};Morph.prototype.shadowImageBlurred=function(off,color){var fb,img,sha,ctx,offset=off||new Point(7,7),blur=this.shadowBlur,clr=color||new Color(0,0,0);if(this.fullShadowSource){fb=this.fullBounds().extent().add(blur*2);img=this.fullImage()}else{fb=this.extent().add(blur*2);img=this.getImage()}sha=newCanvas(fb);ctx=sha.getContext("2d");ctx.shadowOffsetX=offset.x;ctx.shadowOffsetY=offset.y;ctx.shadowBlur=blur;ctx.shadowColor=clr.toString();ctx.drawImage(img,blur-offset.x,blur-offset.y);ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.shadowBlur=0;ctx.globalCompositeOperation="destination-out";ctx.drawImage(img,blur-offset.x,blur-offset.y);return sha};Morph.prototype.shadow=function(off,a,color){var shadow=new ShadowMorph,offset=off||new Point(7,7),alpha=a||(a===0?0:.2),fb=this.fullBounds();shadow.setExtent(fb.extent().add(this.shadowBlur*2));if(useBlurredShadows){shadow.cachedImage=this.shadowImageBlurred(offset,color);shadow.alpha=alpha;shadow.setPosition(fb.origin.add(offset).subtract(this.shadowBlur))}else{shadow.cachedImage=this.shadowImage(offset,color);shadow.alpha=alpha;shadow.setPosition(fb.origin.add(offset))}shadow.shouldRerender=false;return shadow};Morph.prototype.addShadow=function(off,a,color){var shadow,offset=off||new Point(7,7),alpha=a||(a===0?0:.2);shadow=this.shadow(offset,alpha,color);this.addBack(shadow);this.fullChanged();return shadow};Morph.prototype.getShadow=function(){var shadows;shadows=this.children.slice(0).reverse().filter(child=>child instanceof ShadowMorph);if(shadows.length!==0){return shadows[0]}return null};Morph.prototype.removeShadow=function(){var shadow=this.getShadow();if(shadow!==null){this.fullChanged();this.removeChild(shadow)}};Morph.prototype.penTrails=function(){return this.getImage()};Morph.prototype.rerender=function(){this.shouldRerender=true;this.changed()};Morph.prototype.changed=function(){var w=this.root();if(w instanceof WorldMorph){w.broken.push(this.visibleBounds().spread())}if(this.parent){this.parent.childChanged(this)}};Morph.prototype.fullChanged=function(){var w=this.root();if(w instanceof WorldMorph){w.broken.push(this.fullBounds().spread())}};Morph.prototype.childChanged=function(){if(this.parent){this.parent.childChanged(this)}};Morph.prototype.world=function(){var root=this.root();if(root instanceof WorldMorph){return root}if(root instanceof HandMorph){return root.world}return null};Morph.prototype.add=function(aMorph){var owner=aMorph.parent;if(owner!==null){owner.removeChild(aMorph)}this.addChild(aMorph)};Morph.prototype.addBack=function(aMorph){var owner=aMorph.parent;if(owner!==null){owner.removeChild(aMorph)}this.addChildFirst(aMorph)};Morph.prototype.topMorphAt=function(point){var i,result;if(!this.isVisible){return null}for(i=this.children.length-1;i>=0;i-=1){result=this.children[i].topMorphAt(point);if(result){return result}}if(this.bounds.containsPoint(point)){if(this.holes.some(any=>any.translateBy(this.position()).containsPoint(point))){return null}if(this.isFreeForm){if(!this.isTransparentAt(point)){return this}}else{return this}}return null};Morph.prototype.topMorphSuchThat=function(predicate){var next;if(predicate.call(null,this)){next=detect(this.children.slice(0).reverse(),predicate);if(next){return next.topMorphSuchThat(predicate)}return this}return null};Morph.prototype.overlappedMorphs=function(){var world=this.world(),fb=this.fullBounds(),allParents=this.allParents(),allChildren=this.allChildren(),morphs;morphs=world.allChildren();return morphs.filter(m=>{return m.isVisible&&m!==this&&m!==world&&!contains(allParents,m)&&!contains(allChildren,m)&&m.fullBounds().intersects(fb)})};Morph.prototype.getPixelColor=function(aPoint){var point,context,data;point=aPoint.subtract(this.bounds.origin);context=this.getImage().getContext("2d");data=context.getImageData(point.x,point.y,1,1);return new Color(data.data[0],data.data[1],data.data[2],data.data[3]/255)};Morph.prototype.isTransparentAt=function(aPoint){var point,context,data;if(this.bounds.containsPoint(aPoint)){if(this.texture){return false}point=aPoint.subtract(this.bounds.origin);context=this.getImage().getContext("2d");data=context.getImageData(Math.floor(point.x),Math.floor(point.y),1,1);return data.data[3]===0}return false};Morph.prototype.copy=function(){var c=copy(this);c.parent=null;c.children=[];c.bounds=this.bounds.copy();return c};Morph.prototype.fullCopy=function(){var map=new Map,c;c=this.copyRecordingReferences(map);c.forAllChildren(m=>m.updateReferences(map));return c};Morph.prototype.copyRecordingReferences=function(map){var c=this.copy();map.set(this,c);this.children.forEach(m=>c.add(m.copyRecordingReferences(map)));return c};Morph.prototype.updateReferences=function(map){var properties=Object.keys(this),l=properties.length,property,value,reference,i;for(i=0;i<l;i+=1){property=properties[i];value=this[property];if(value&&value.isMorph){reference=map.get(value);if(reference){this[property]=reference}}}};Morph.prototype.rootForGrab=function(){if(this instanceof ShadowMorph){return this.parent.rootForGrab()}if(this.parent instanceof ScrollFrameMorph){return this.parent}if(this.parent===null||this.parent instanceof WorldMorph||this.parent instanceof FrameMorph||this.isDraggable===true){return this}return this.parent.rootForGrab()};Morph.prototype.isCorrectingOutsideDrag=function(){return true};Morph.prototype.wantsDropOf=function(aMorph){if(aMorph instanceof HandleMorph||aMorph instanceof MenuMorph||aMorph instanceof InspectorMorph){return false}return this.acceptsDrops};Morph.prototype.pickUp=function(wrrld){var world=wrrld||this.world();this.setPosition(world.hand.position().subtract(this.extent().floorDivideBy(2)));world.hand.grab(this)};Morph.prototype.isPickedUp=function(){return this.parentThatIsA(HandMorph)!==null};Morph.prototype.situation=function(){if(this.parent){return{origin:this.parent,position:this.position().subtract(this.parent.position())}}return null};Morph.prototype.slideBackTo=function(situation,msecs,onBeforeDrop,onComplete){var pos=situation.origin.position().add(situation.position);this.glideTo(pos,msecs,null,()=>{situation.origin.add(this);if(onBeforeDrop){onBeforeDrop()}if(this.justDropped){this.justDropped()}if(situation.origin.reactToDropOf){situation.origin.reactToDropOf(this)}if(onComplete){onComplete()}})};Morph.prototype.glideTo=function(endPoint,msecs,easing,onComplete){var world=this.world(),horizontal=new Animation(x=>this.setLeft(x),()=>this.left(),-(this.left()-endPoint.x),msecs===0?0:msecs||100,easing);world.animations.push(horizontal);world.animations.push(new Animation(y=>this.setTop(y),()=>this.top(),-(this.top()-endPoint.y),msecs===0?0:msecs||100,easing,()=>{horizontal.setter(horizontal.destination);horizontal.isActive=false;onComplete()}))};Morph.prototype.fadeTo=function(endAlpha,msecs,easing,onComplete){var world=this.world(),oldAlpha=this.alpha;this.children.forEach(child=>child.fadeTo(endAlpha,msecs,easing));world.animations.push(new Animation(n=>{this.alpha=n;this.changed()},()=>this.alpha,endAlpha-this.alpha,msecs===0?0:msecs||200,easing,()=>{this.alpha=oldAlpha;if(onComplete){onComplete()}}))};Morph.prototype.perish=function(msecs,onComplete){this.fadeTo(0,msecs===0?0:msecs||100,null,()=>{this.destroy();if(onComplete){onComplete()}})};Morph.prototype.nop=nop;Morph.prototype.resize=function(){this.world().activeHandle=new HandleMorph(this)};Morph.prototype.move=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"move")};Morph.prototype.moveCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"moveCenter")};Morph.prototype.hint=function(msg){var m,text;text=msg;if(msg){if(msg.toString){text=msg.toString()}}else{text="NULL"}m=new MenuMorph(this,text);m.isDraggable=true;m.popUpCenteredAtHand(this.world())};Morph.prototype.inform=function(msg){var m,text;text=msg;if(msg){if(msg.toString){text=msg.toString()}}else{text="NULL"}m=new MenuMorph(this,text);m.addItem("Ok");m.isDraggable=true;m.popUpCenteredAtHand(this.world())};Morph.prototype.prompt=function(msg,callback,environment,defaultContents,width,floorNum,ceilingNum,isRounded,action=nop){var menu,entryField,slider,isNumeric;if(ceilingNum){isNumeric=true}menu=new MenuMorph(callback||null,msg||"",environment||null);entryField=new StringFieldMorph(defaultContents||"",width||100,MorphicPreferences.prompterFontSize,MorphicPreferences.prompterFontName,false,false,isNumeric);menu.items.push(entryField);if(ceilingNum||MorphicPreferences.useSliderForInput){slider=new SliderMorph(floorNum||0,ceilingNum,parseFloat(defaultContents),Math.floor((ceilingNum-floorNum)/4),"horizontal");slider.alpha=1;slider.color=new Color(225,225,225);slider.button.color=menu.borderColor;slider.button.highlightColor=slider.button.color.copy();slider.button.highlightColor.b+=100;slider.button.pressColor=slider.button.color.copy();slider.button.pressColor.b+=150;slider.setHeight(MorphicPreferences.prompterSliderSize);if(isRounded){slider.action=num=>{entryField.changed();entryField.text.text=Math.round(num).toString();entryField.text.fixLayout();entryField.text.changed();entryField.text.edit();action(Math.round(num))}}else{slider.action=num=>{entryField.changed();entryField.text.text=num.toString();entryField.text.fixLayout();entryField.text.changed();action(num)}}menu.items.push(slider)}menu.addLine(2);menu.addItem("Ok",()=>entryField.string());menu.addItem("Cancel",()=>{action(defaultContents);return null});menu.isDraggable=true;menu.popUpAtHand(this.world());entryField.text.edit()};Morph.prototype.pickColor=function(msg,callback,environment,defaultContents){var menu,colorPicker;menu=new MenuMorph(callback||null,msg||"",environment||null);colorPicker=new ColorPickerMorph(defaultContents);menu.items.push(colorPicker);menu.addLine(2);menu.addItem("Ok",()=>colorPicker.getChoice());menu.addItem("Cancel",()=>null);menu.isDraggable=true;menu.popUpAtHand(this.world())};Morph.prototype.inspect=function(anotherObject){var world=this.world instanceof Function?this.world():this.root()||this.world,inspector,inspectee=this;if(anotherObject){inspectee=anotherObject}inspector=new InspectorMorph(inspectee);inspector.setPosition(world.hand.position());inspector.keepWithin(world);world.add(inspector);inspector.changed()};Morph.prototype.inspectKeyEvent=function(event){this.inform("Key pressed: "+String.fromCharCode(event.charCode)+"\n------------------------"+"\ncharCode: "+event.charCode.toString()+"\nkeyCode: "+event.keyCode.toString()+"\nkey: "+event.key.toString()+"\nshiftKey: "+event.shiftKey.toString()+"\naltKey: "+event.altKey.toString()+"\nctrlKey: "+event.ctrlKey.toString()+"\ncmdKey: "+event.metaKey.toString())};Morph.prototype.contextMenu=function(){var world;if(this.customContextMenu){return this.customContextMenu}world=this.world instanceof Function?this.world():this.world;if(world&&world.isDevMode){if(this.parent===world){return this.developersMenu()}return this.hierarchyMenu()}return this.userMenu()||this.parent&&this.parent.userMenu()};Morph.prototype.hierarchyMenu=function(){var parents=this.allParents(),world=this.world instanceof Function?this.world():this.world,menu=new MenuMorph(this,null);parents.forEach(each=>{if(each.developersMenu&&each!==world){menu.addMenu(each.toString().slice(0,50),each.developersMenu())}});return menu};Morph.prototype.developersMenu=function(){var world=this.world instanceof Function?this.world():this.world,userMenu=this.userMenu()||this.parent&&this.parent.userMenu(),menu=new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]);if(userMenu){menu.addMenu("user features",userMenu);menu.addLine()}menu.addItem("color...",()=>{this.pickColor(menu.title+localize("\ncolor:"),this.setColor,this,this.color)},"choose another color \nfor this morph");menu.addItem("transparency...",()=>{this.prompt(menu.title+localize("\nalpha\nvalue:"),this.setAlphaScaled,this,(this.alpha*100).toString(),null,1,100,true)},"set this morph's\nalpha value");menu.addItem("resize...","resize","show a handle\nwhich can be dragged\nto change this morph's"+" extent");menu.addLine();menu.addItem("duplicate",()=>this.fullCopy().pickUp(this.world()),"make a copy\nand pick it up");menu.addItem("pick up","pickUp","detach and put \ninto the hand");menu.addItem("attach...","attach","stick this morph\nto another one");menu.addItem("move...","move","show a handle\nwhich can be dragged\nto move this morph");menu.addItem("inspect...","inspect","open a window\non all properties");menu.addItem("pic...",()=>window.open(this.fullImage().toDataURL()),"open a new window\nwith a picture of this morph");menu.addLine();if(this.isDraggable){menu.addItem("lock","toggleIsDraggable","make this morph\nunmovable")}else{menu.addItem("unlock","toggleIsDraggable","make this morph\nmovable")}menu.addItem("hide","hide");menu.addItem("delete","destroy");if(!(this instanceof WorldMorph)){menu.addLine();menu.addItem("World...",()=>world.contextMenu().popUpAtHand(world),"show the\nWorld's menu")}return menu};Morph.prototype.userMenu=function(){return null};Morph.prototype.addToDemoMenu=function(aMorphOrMenuArray){WorldMorph.prototype.customMorphs.push(aMorphOrMenuArray)};Morph.prototype.setAlphaScaled=function(alpha){var newAlpha,unscaled;if(typeof alpha==="number"){unscaled=alpha/100;this.alpha=Math.min(Math.max(unscaled,0),1)}else{newAlpha=parseFloat(alpha);if(!isNaN(newAlpha)){unscaled=newAlpha/100;this.alpha=Math.min(Math.max(unscaled,0),1)}}this.changed()};Morph.prototype.attach=function(){var choices=this.overlappedMorphs(),menu=new MenuMorph(this,"choose new parent:");choices.forEach(each=>{menu.addItem(each.toString().slice(0,50),()=>{each.add(this);this.isDraggable=false})});if(choices.length>0){menu.popUpAtHand(this.world())}};Morph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable};Morph.prototype.colorSetters=function(){return["color"]};Morph.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled"]};Morph.prototype.allEntryFields=function(){return this.allChildren().filter(each=>{return each.isEditable&&(each instanceof StringMorph||each instanceof TextMorph)})};Morph.prototype.nextEntryField=function(current){var fields=this.allEntryFields(),idx=fields.indexOf(current);if(idx!==-1){if(fields.length>idx+1){return fields[idx+1]}}return fields[0]};Morph.prototype.previousEntryField=function(current){var fields=this.allEntryFields(),idx=fields.indexOf(current);if(idx!==-1){if(idx>0){return fields[idx-1]}return fields[fields.length-1]}return fields[0]};Morph.prototype.tab=function(editField){if(this.nextTab){this.nextTab(editField)}else if(this.parent){this.parent.tab(editField)}};Morph.prototype.backTab=function(editField){if(this.previousTab){this.previousTab(editField)}else if(this.parent){this.parent.backTab(editField)}};Morph.prototype.escalateEvent=function(functionName,arg){var handler=this.parent;while(!handler[functionName]&&handler.parent!==null){handler=handler.parent}if(handler[functionName]){handler[functionName](arg)}};Morph.prototype.evaluateString=function(code){var result;try{result=eval(code);this.changed()}catch(err){this.inform(err)}return result};Morph.prototype.isTouching=function(otherMorph){var data=this.overlappingPixels(otherMorph),len,i;if(!data){return false}len=data[0].length;for(i=3;i<len;i+=4){if(data[0][i]&&data[1][i]){return true}}return false};Morph.prototype.overlappingPixels=function(otherMorph){var fb=this.fullBounds(),otherFb=otherMorph.fullBounds(),oRect=fb.intersect(otherFb),thisImg,thatImg;if(oRect.width()<1||oRect.height()<1){return false}thisImg=this.fullImage();thatImg=otherMorph.fullImage();if(thisImg.isRetinaEnabled!==thatImg.isRetinaEnabled){thisImg=normalizeCanvas(thisImg,true);thatImg=normalizeCanvas(thatImg,true)}return[thisImg.getContext("2d").getImageData(oRect.left()-this.left(),oRect.top()-this.top(),oRect.width(),oRect.height()).data,thatImg.getContext("2d").getImageData(oRect.left()-otherMorph.left(),oRect.top()-otherMorph.top(),oRect.width(),oRect.height()).data]};ShadowMorph.prototype=new Morph;ShadowMorph.prototype.constructor=ShadowMorph;ShadowMorph.uber=Morph.prototype;function ShadowMorph(){this.init()}ShadowMorph.prototype.init=function(){ShadowMorph.uber.init.call(this);this.isCachingImage=true};ShadowMorph.prototype.topMorphAt=function(){return null};HandleMorph.prototype=new Morph;HandleMorph.prototype.constructor=HandleMorph;HandleMorph.uber=Morph.prototype;function HandleMorph(target,minX,minY,insetX,insetY,type){this.init(target,minX,minY,insetX,insetY,type)}HandleMorph.prototype.init=function(target,minX,minY,insetX,insetY,type){var size=MorphicPreferences.handleSize;this.target=target||null;this.minExtent=new Point(minX||0,minY||0);this.inset=new Point(insetX||0,insetY||insetX||0);this.type=type||"resize";this.isHighlighted=false;HandleMorph.uber.init.call(this);this.color=WHITE;this.isDraggable=false;if(this.type==="movePivot"){size*=2}this.setExtent(new Point(size,size));this.fixLayout()};HandleMorph.prototype.fixLayout=function(){if(this.target){if(this.type==="moveCenter"){this.setCenter(this.target.center())}else if(this.type==="movePivot"){this.setCenter(this.target.rotationCenter())}else{this.setPosition(this.target.bottomRight().subtract(this.extent().add(this.inset)))}this.target.add(this);this.target.changed()}};HandleMorph.prototype.render=function(ctx){if(this.type==="movePivot"){if(this.isHighlighted){this.renderCrosshairsOn(ctx,.5)}else{this.renderCrosshairsOn(ctx,.6)}}else{if(this.isHighlighted){this.renderHandleOn(ctx,new Color(100,100,255),WHITE)}else{this.renderHandleOn(ctx,this.color,new Color(100,100,100))}}};HandleMorph.prototype.renderCrosshairsOn=function(ctx,fract){var r=this.width()/2;ctx.fillStyle="rgba(255, 255, 255, 0.5)";ctx.beginPath();ctx.arc(r,r,r*.9,radians(0),radians(360),false);ctx.fill();ctx.strokeStyle="black";ctx.lineWidth=1;ctx.beginPath();ctx.arc(r,r,r*fract,radians(0),radians(360),false);ctx.stroke();ctx.moveTo(0,r);ctx.lineTo(this.width(),r);ctx.stroke();ctx.moveTo(r,0);ctx.lineTo(r,this.height());ctx.stroke()};HandleMorph.prototype.renderHandleOn=function(ctx,color,shadowColor){var isSquare=this.type.indexOf("move")===0,p1=new Point(0,this.height()),p2=new Point(this.width(),0),p11,p22,i;ctx.lineWidth=1;ctx.lineCap="round";ctx.strokeStyle=color.toString();if(isSquare){p11=p1.copy();p22=p2.copy();for(i=0;i<=this.height();i=i+6){p11.y=p1.y-i;p22.y=p2.y-i;ctx.beginPath();ctx.moveTo(p11.x,p11.y);ctx.lineTo(p22.x,p22.y);ctx.closePath();ctx.stroke()}}p11=p1.copy();p22=p2.copy();for(i=0;i<=this.width();i=i+6){p11.x=p1.x+i;p22.x=p2.x+i;ctx.beginPath();ctx.moveTo(p11.x,p11.y);ctx.lineTo(p22.x,p22.y);ctx.closePath();ctx.stroke()}ctx.strokeStyle=shadowColor.toString();if(isSquare){p11=p1.copy();p22=p2.copy();for(i=-2;i<=this.height();i=i+6){p11.y=p1.y-i;p22.y=p2.y-i;ctx.beginPath();ctx.moveTo(p11.x,p11.y);ctx.lineTo(p22.x,p22.y);ctx.closePath();ctx.stroke()}}p11=p1.copy();p22=p2.copy();for(i=2;i<=this.width();i=i+6){p11.x=p1.x+i;p22.x=p2.x+i;ctx.beginPath();ctx.moveTo(p11.x,p11.y);ctx.lineTo(p22.x,p22.y);ctx.closePath();ctx.stroke()}};HandleMorph.prototype.step=null;HandleMorph.prototype.mouseDownLeft=function(pos){var world=this.root(),offset;if(!this.target){return null}if(this.type.indexOf("move")===0){offset=pos.subtract(this.center())}else{offset=pos.subtract(this.bounds.origin)}this.step=()=>{var newPos,newExt;if(world.hand.mouseButton){newPos=world.hand.bounds.origin.copy().subtract(offset);if(this.type==="resize"){newExt=newPos.add(this.extent().add(this.inset)).subtract(this.target.bounds.origin);newExt=newExt.max(this.minExtent);this.target.setExtent(newExt);this.setPosition(this.target.bottomRight().subtract(this.extent().add(this.inset)))}else if(this.type==="moveCenter"){this.target.setCenter(newPos)}else if(this.type==="movePivot"){this.target.setPivot(newPos);this.setCenter(this.target.rotationCenter())}else{this.target.setPosition(newPos.subtract(this.target.extent()).add(this.extent()))}}else{this.step=null}};if(!this.target.step){this.target.step=nop}};HandleMorph.prototype.rootForGrab=function(){return this};HandleMorph.prototype.mouseEnter=function(){this.isHighlighted=true;this.changed()};HandleMorph.prototype.mouseLeave=function(){this.isHighlighted=false;this.changed()};HandleMorph.prototype.attach=function(){var choices=this.overlappedMorphs(),menu=new MenuMorph(this,"choose target:");choices.forEach(each=>{menu.addItem(each.toString().slice(0,50),()=>{this.isDraggable=false;this.target=each;this.fixLayout()})});if(choices.length>0){menu.popUpAtHand(this.world())}};var PenMorph;PenMorph.prototype=new Morph;PenMorph.prototype.constructor=PenMorph;PenMorph.uber=Morph.prototype;function PenMorph(){this.init()}PenMorph.prototype.init=function(){var size=MorphicPreferences.handleSize*4;this.isWarped=false;this.heading=0;this.isDown=true;this.size=1;this.penPoint="tip";this.penBounds=null;HandleMorph.uber.init.call(this);this.setExtent(new Point(size,size))};PenMorph.prototype.changed=function(){if(this.isWarped){return}PenMorph.uber.changed.call(this)};PenMorph.prototype.render=function(ctx,facing){var start,dest,left,right,len,direction=facing||this.heading;len=this.width()/2;start=this.center().subtract(this.bounds.origin);if(this.penPoint==="tip"){dest=start.distanceAngle(len*.75,direction-180);left=start.distanceAngle(len,direction+195);right=start.distanceAngle(len,direction-195)}else{dest=start.distanceAngle(len*.75,direction);left=start.distanceAngle(len*.33,direction+230);right=start.distanceAngle(len*.33,direction-230)}this.penBounds=new Rectangle(Math.min(start.x,dest.x,left.x,right.x),Math.min(start.y,dest.y,left.y,right.y),Math.max(start.x,dest.x,left.x,right.x),Math.max(start.y,dest.y,left.y,right.y));ctx.fillStyle=this.color.toString();ctx.beginPath();ctx.moveTo(start.x,start.y);ctx.lineTo(left.x,left.y);ctx.lineTo(dest.x,dest.y);ctx.lineTo(right.x,right.y);ctx.closePath();ctx.strokeStyle="white";ctx.lineWidth=3;ctx.stroke();ctx.strokeStyle="black";ctx.lineWidth=1;ctx.stroke();ctx.fill()};PenMorph.prototype.setHeading=function(degrees){this.heading=(+degrees%360+360)%360;this.fixLayout();this.rerender()};PenMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled","setHeading"]};PenMorph.prototype.developersMenu=function(){var menu=PenMorph.uber.developersMenu.call(this);menu.addLine();menu.addItem("set rotation","setRotation","interactively turn this morph\nusing a dial widget");return menu};PenMorph.prototype.setRotation=function(){var menu,dial,name=this.name||this.constructor.name;if(name.length>10){name=name.slice(0,9)+"..."}menu=new MenuMorph(this,name);dial=new DialMorph(null,null,this.heading);dial.rootForGrab=()=>dial;dial.target=this;dial.action="setHeading";menu.items.push(dial);menu.addLine();menu.addItem("(90) right",()=>this.setHeading(90));menu.addItem("(-90) left",()=>this.setHeading(-90));menu.addItem("(0) up",()=>this.setHeading(0));menu.addItem("(180) down",()=>this.setHeading(180));menu.isDraggable=true;menu.popUpAtHand(this.world())};PenMorph.prototype.drawLine=function(start,dest){var context=this.parent.penTrails().getContext("2d"),from=start.subtract(this.parent.bounds.origin),to=dest.subtract(this.parent.bounds.origin);if(this.isDown){context.lineWidth=this.size;context.strokeStyle=this.color.toString();context.lineCap="round";context.lineJoin="round";context.beginPath();context.moveTo(from.x,from.y);context.lineTo(to.x,to.y);context.stroke();if(this.isWarped===false){this.world().broken.push(start.rectangle(dest).expandBy(Math.max(this.size/2,1)).intersect(this.parent.visibleBounds()).spread())}}};PenMorph.prototype.turn=function(degrees){this.setHeading(this.heading+parseFloat(degrees))};PenMorph.prototype.forward=function(steps){var start=this.center(),dest,dist=parseFloat(steps);if(dist>=0){dest=this.position().distanceAngle(dist,this.heading)}else{dest=this.position().distanceAngle(Math.abs(dist),this.heading-180)}this.setPosition(dest);this.drawLine(start,this.center())};PenMorph.prototype.down=function(){this.isDown=true};PenMorph.prototype.up=function(){this.isDown=false};PenMorph.prototype.clear=function(){this.parent.rerender()};PenMorph.prototype.startWarp=function(){this.isWarped=true};PenMorph.prototype.endWarp=function(){this.isWarped=false;this.parent.changed()};PenMorph.prototype.warp=function(fun){this.startWarp();fun.call(this);this.endWarp()};PenMorph.prototype.warpOp=function(selector,argsArray){this.startWarp();this[selector].apply(this,argsArray);this.endWarp()};PenMorph.prototype.warpSierpinski=function(length,min){this.warpOp("sierpinski",[length,min])};PenMorph.prototype.sierpinski=function(length,min){var i;if(length>min){for(i=0;i<3;i+=1){this.sierpinski(length*.5,min);this.turn(120);this.forward(length)}}};PenMorph.prototype.warpTree=function(level,length,angle){this.warpOp("tree",[level,length,angle])};PenMorph.prototype.tree=function(level,length,angle){if(level>0){this.size=level;this.forward(length);this.turn(angle);this.tree(level-1,length*.75,angle);this.turn(angle*-2);this.tree(level-1,length*.75,angle);this.turn(angle);this.forward(-length)}};var ColorPaletteMorph;ColorPaletteMorph.prototype=new Morph;ColorPaletteMorph.prototype.constructor=ColorPaletteMorph;ColorPaletteMorph.uber=Morph.prototype;function ColorPaletteMorph(target,sizePoint){this.init(target||null,sizePoint||new Point(80,50))}ColorPaletteMorph.prototype.init=function(target,size){ColorPaletteMorph.uber.init.call(this);this.isCachingImage=true;this.target=target;this.targetSetter="color";this.setExtent(size);this.choice=null};ColorPaletteMorph.prototype.render=function(ctx){var ext=this.extent(),x,y,h,l;this.choice=BLACK;for(x=0;x<=ext.x;x+=1){h=360*x/ext.x;for(y=0;y<=ext.y;y+=1){l=100-y/ext.y*100;ctx.fillStyle="hsl("+h+",100%,"+l+"%)";ctx.fillRect(x,y,1,1)}}};ColorPaletteMorph.prototype.mouseMove=function(pos){this.choice=this.getPixelColor(pos);this.updateTarget()};ColorPaletteMorph.prototype.mouseDownLeft=function(pos){this.choice=this.getPixelColor(pos);this.updateTarget()};ColorPaletteMorph.prototype.updateTarget=function(){if(this.target instanceof Morph&&this.choice!==null){if(this.target[this.targetSetter]instanceof Function){this.target[this.targetSetter](this.choice)}else{this.target[this.targetSetter]=this.choice;this.target.rerender()}}};ColorPaletteMorph.prototype.developersMenu=function(){var menu=ColorPaletteMorph.uber.developersMenu.call(this);menu.addLine();menu.addItem("set target","setTarget","choose another morph\nwhose color property\n will be"+" controlled by this one");return menu};ColorPaletteMorph.prototype.setTarget=function(){var choices=this.overlappedMorphs(),menu=new MenuMorph(this,"choose target:");choices.push(this.world());choices.forEach(each=>{menu.addItem(each.toString().slice(0,50),()=>{this.target=each;this.setTargetSetter()})});if(choices.length===1){this.target=choices[0];this.setTargetSetter()}else if(choices.length>0){menu.popUpAtHand(this.world())}};ColorPaletteMorph.prototype.setTargetSetter=function(){var choices=this.target.colorSetters(),menu=new MenuMorph(this,"choose target property:");choices.forEach(each=>{menu.addItem(each,()=>this.targetSetter=each)});if(choices.length===1){this.targetSetter=choices[0]}else if(choices.length>0){menu.popUpAtHand(this.world())}};var GrayPaletteMorph;GrayPaletteMorph.prototype=new ColorPaletteMorph;GrayPaletteMorph.prototype.constructor=GrayPaletteMorph;GrayPaletteMorph.uber=ColorPaletteMorph.prototype;function GrayPaletteMorph(target,sizePoint){this.init(target||null,sizePoint||new Point(80,10))}GrayPaletteMorph.prototype.render=function(ctx){var ext=this.extent(),gradient;this.choice=BLACK;gradient=ctx.createLinearGradient(0,0,ext.x,ext.y);gradient.addColorStop(0,"black");gradient.addColorStop(1,"white");ctx.fillStyle=gradient;ctx.fillRect(0,0,ext.x,ext.y)};ColorPickerMorph.prototype=new Morph;ColorPickerMorph.prototype.constructor=ColorPickerMorph;ColorPickerMorph.uber=Morph.prototype;function ColorPickerMorph(defaultColor){this.init(defaultColor||WHITE)}ColorPickerMorph.prototype.init=function(defaultColor){this.choice=defaultColor;ColorPickerMorph.uber.init.call(this);this.color=WHITE;this.setExtent(new Point(80,80))};ColorPickerMorph.prototype.fixLayout=function(){var cpal,gpal,x,y;this.children.forEach(child=>child.destroy());this.children=[];this.feedback=new Morph;this.feedback.color=this.choice;this.feedback.setExtent(new Point(20,20));cpal=new ColorPaletteMorph(this.feedback,new Point(this.width(),50));gpal=new GrayPaletteMorph(this.feedback,new Point(this.width(),5));cpal.setPosition(this.bounds.origin);this.add(cpal);gpal.setPosition(cpal.bottomLeft());this.add(gpal);x=gpal.left()+Math.floor((gpal.width()-this.feedback.width())/2);y=gpal.bottom()+Math.floor((this.bottom()-gpal.bottom()-this.feedback.height())/2);this.feedback.setPosition(new Point(x,y));this.add(this.feedback)};ColorPickerMorph.prototype.getChoice=function(){return this.feedback.color};ColorPickerMorph.prototype.rootForGrab=function(){return this};var BlinkerMorph;BlinkerMorph.prototype=new Morph;BlinkerMorph.prototype.constructor=BlinkerMorph;BlinkerMorph.uber=Morph.prototype;function BlinkerMorph(rate){this.init(rate)}BlinkerMorph.prototype.init=function(rate){BlinkerMorph.uber.init.call(this);this.color=new Color(0,0,0);this.fps=rate||2};BlinkerMorph.prototype.step=function(){this.toggleVisibility()};var CursorMorph;CursorMorph.prototype=new BlinkerMorph;CursorMorph.prototype.constructor=CursorMorph;CursorMorph.uber=BlinkerMorph.prototype;CursorMorph.prototype.viewPadding=1;function CursorMorph(aStringOrTextMorph,aTextarea){this.init(aStringOrTextMorph,aTextarea)}CursorMorph.prototype.init=function(aStringOrTextMorph,aTextarea){var ls;this.keyDownEventUsed=false;this.target=aStringOrTextMorph;this.originalContents=this.target.text;this.originalAlignment=this.target.alignment;this.slot=this.target.text.length;this.textarea=aTextarea;CursorMorph.uber.init.call(this);ls=fontHeight(this.target.fontSize);this.setExtent(new Point(Math.max(Math.floor(ls/20),1),ls));if(this.target instanceof TextMorph&&this.target.alignment!=="left"){this.target.setAlignmentToLeft()}this.textarea.value=this.target.text;this.textarea.style.fontSize=this.target.fontSize+"px";this.gotoSlot(this.slot);this.updateTextAreaPosition();this.syncTextareaSelectionWith(this.target)};CursorMorph.prototype.processKeyDown=function(event){var keyName=event.key,shift=event.shiftKey,singleLineText=this.target instanceof StringMorph,dest;if(!isNil(this.target.receiver)&&(event.ctrlKey||event.metaKey)){if(keyName==="d"){event.preventDefault();this.target.doIt();return}else if(keyName==="i"){event.preventDefault();this.target.inspectIt();return}else if(keyName==="p"){event.preventDefault();this.target.showIt();return}}if(keyName==="Tab"||keyName==="U+0009"){if(shift){this.target.backTab(this.target)}else{this.target.tab(this.target)}event.preventDefault();this.target.escalateEvent("reactToEdit",this.target)}else if(keyName==="Escape"){this.cancel()}else if(keyName==="Enter"&&(singleLineText||shift)){this.accept()}else{if(keyName==="ArrowDown"){dest=this.target.downFrom(this.slot);this.textarea.setSelectionRange(dest,dest);event.preventDefault()}if(keyName==="ArrowUp"){dest=this.target.upFrom(this.slot);this.textarea.setSelectionRange(dest,dest);event.preventDefault()}this.target.escalateEvent("reactToKeystroke",event)}};CursorMorph.prototype.processKeyUp=function(event){var textarea=this.textarea,target=this.target;if(textarea.selectionStart===textarea.selectionEnd){target.startMark=null;target.endMark=null}else{if(textarea.selectionDirection==="backward"){target.startMark=textarea.selectionEnd;target.endMark=textarea.selectionStart}else{target.startMark=textarea.selectionStart;target.endMark=textarea.selectionEnd}}target.fixLayout();target.rerender();this.gotoSlot(textarea.selectionEnd)};CursorMorph.prototype.processInput=function(event){var target=this.target,textarea=this.textarea,filteredContent,caret;function filterText(content){var points=0,hasE=false,result="",i,ch,valid;for(i=0;i<content.length;i+=1){ch=content.charAt(i);valid="0"<=ch&&ch<="9"||ch.toLowerCase()==="e"||(i===0||hasE)&&ch==="-"||ch==="."&&points===0;if(valid){result+=ch;if(ch==="."){points+=1}if(ch.toLowerCase()==="e"){hasE=true}}}return result}if(target.isNumeric){filteredContent=filterText(textarea.value)}else{filteredContent=textarea.value}if(filteredContent.length<textarea.value.length){textarea.value=filteredContent;caret=Math.min(textarea.selectionStart,filteredContent.length);textarea.selectionEnd=caret;textarea.selectionStart=caret}target.text=filteredContent;if(textarea.selectionStart===textarea.selectionEnd){target.startMark=null;target.endMark=null}else{if(textarea.selectionDirection==="backward"){target.startMark=textarea.selectionEnd;target.endMark=textarea.selectionStart}else{target.startMark=textarea.selectionStart;target.endMark=textarea.selectionEnd}}target.changed();target.fixLayout();target.rerender();this.gotoSlot(textarea.selectionStart);this.updateTextAreaPosition();this.target.escalateEvent("reactToInput",event)};CursorMorph.prototype.updateTextAreaPosition=function(){var pos=getDocumentPositionOf(this.target.world().worldCanvas),origin=this.target.bounds.origin.add(new Point(pos.x,pos.y));function number2px(n){return Math.ceil(n)+"px"}this.textarea.style.top=number2px(origin.y);this.textarea.style.left=number2px(origin.x)};CursorMorph.prototype.syncTextareaSelectionWith=function(targetMorph){var start=targetMorph.startMark,end=targetMorph.endMark;if(start===end){this.textarea.setSelectionRange(this.slot,this.slot,"none")}else if(start<end){this.textarea.setSelectionRange(start,end,"forward")}else{this.textarea.setSelectionRange(end,start,"backward")}this.textarea.focus()};CursorMorph.prototype.gotoSlot=function(slot){var length=this.target.text.length,pos=this.target.slotPosition(slot),right,left;this.slot=slot<0?0:slot>length?length:slot;if(this.parent&&this.target.isScrollable){right=this.parent.right()-this.viewPadding;left=this.parent.left()+this.viewPadding;if(pos.x>right){this.target.setLeft(this.target.left()+right-pos.x);pos.x=right}if(pos.x<left){left=Math.min(this.parent.left(),left);this.target.setLeft(this.target.left()+left-pos.x);pos.x=left}if(this.target.right()<right&&right-this.target.width()<left){pos.x+=right-this.target.right();this.target.setRight(right)}}this.show();this.setPosition(pos);if(this.parent&&this.parent.parent instanceof ScrollFrameMorph&&this.target.isScrollable){this.parent.parent.scrollCursorIntoView(this)}};CursorMorph.prototype.gotoPos=function(aPoint){this.gotoSlot(this.target.slotAt(aPoint));this.show()};CursorMorph.prototype.updateSelection=function(shift){if(shift){if(isNil(this.target.endMark)&&isNil(this.target.startMark)){this.target.startMark=this.slot;this.target.endMark=this.slot}else if(this.target.endMark!==this.slot){this.target.endMark=this.slot;this.target.changed()}}else{this.target.clearSelection()}};CursorMorph.prototype.accept=function(){var world=this.root();if(world){world.stopEditing()}this.escalateEvent("accept",this)};CursorMorph.prototype.cancel=function(){var world=this.root();this.undo();if(world){world.stopEditing()}this.escalateEvent("cancel",this)};CursorMorph.prototype.undo=function(){this.target.text=this.originalContents;this.target.changed();this.target.fixLayout();this.target.changed();this.gotoSlot(0)};CursorMorph.prototype.destroy=function(){if(this.target.alignment!==this.originalAlignment){this.target.alignment=this.originalAlignment;this.target.changed()}CursorMorph.uber.destroy.call(this);this.target.world().resetKeyboardHandler()};var BoxMorph;BoxMorph.prototype=new Morph;BoxMorph.prototype.constructor=BoxMorph;BoxMorph.uber=Morph.prototype;function BoxMorph(edge,border,borderColor){this.init(edge,border,borderColor)}BoxMorph.prototype.init=function(edge,border,borderColor){this.edge=edge||4;this.border=border||(border===0?0:2);this.borderColor=borderColor||BLACK;BoxMorph.uber.init.call(this)};BoxMorph.prototype.render=function(ctx){if(this.edge===0&&this.border===0){BoxMorph.uber.render.call(this,ctx);return}ctx.fillStyle=this.color.toString();ctx.beginPath();this.outlinePath(ctx,Math.max(this.edge-this.border,0),this.border);ctx.closePath();ctx.fill();if(this.border>0){ctx.lineWidth=this.border;ctx.strokeStyle=this.borderColor.toString();ctx.beginPath();this.outlinePath(ctx,this.edge,this.border/2);ctx.closePath();ctx.stroke()}};BoxMorph.prototype.outlinePath=function(ctx,corner,inset){var w=this.width(),h=this.height(),radius=Math.min(corner,(Math.min(w,h)-inset)/2),offset=radius+inset;ctx.arc(offset,offset,radius,radians(-180),radians(-90),false);ctx.arc(w-offset,offset,radius,radians(-90),radians(-0),false);ctx.arc(w-offset,h-offset,radius,radians(0),radians(90),false);ctx.arc(offset,h-offset,radius,radians(90),radians(180),false)};BoxMorph.prototype.developersMenu=function(){var menu=BoxMorph.uber.developersMenu.call(this);menu.addLine();menu.addItem("border width...",()=>{this.prompt(menu.title+"\nborder\nwidth:",this.setBorderWidth,this,this.border.toString(),null,0,100,true)},"set the border's\nline size");menu.addItem("border color...",()=>{this.pickColor(menu.title+"\nborder color:",this.setBorderColor,this,this.borderColor)},"set the border's\nline color");menu.addItem("corner size...",()=>{this.prompt(menu.title+"\ncorner\nsize:",this.setCornerSize,this,this.edge.toString(),null,0,100,true)},"set the corner's\nradius");return menu};BoxMorph.prototype.setBorderWidth=function(size){var newSize;if(typeof size==="number"){this.border=Math.max(size,0)}else{newSize=parseFloat(size);if(!isNaN(newSize)){this.border=Math.max(newSize,0)}}this.changed()};BoxMorph.prototype.setBorderColor=function(color){if(color){this.borderColor=color;this.changed()}};BoxMorph.prototype.setCornerSize=function(size){var newSize;if(typeof size==="number"){this.edge=Math.max(size,0)}else{newSize=parseFloat(size);if(!isNaN(newSize)){this.edge=Math.max(newSize,0)}}this.changed()};BoxMorph.prototype.colorSetters=function(){return["color","borderColor"]};BoxMorph.prototype.numericalSetters=function(){var list=BoxMorph.uber.numericalSetters.call(this);list.push("setBorderWidth","setCornerSize");return list};var SpeechBubbleMorph;SpeechBubbleMorph.prototype=new BoxMorph;SpeechBubbleMorph.prototype.constructor=SpeechBubbleMorph;SpeechBubbleMorph.uber=BoxMorph.prototype;function SpeechBubbleMorph(contents,color,edge,border,borderColor,padding,isThought,noShadow){this.init(contents,color,edge,border,borderColor,padding,isThought,noShadow)}SpeechBubbleMorph.prototype.init=function(contents,color,edge,border,borderColor,padding,isThought,noShadow){this.isPointingRight=true;this.contents=contents||"";this.padding=padding||0;this.isThought=isThought||false;this.isClickable=false;SpeechBubbleMorph.uber.init.call(this,edge||6,border||(border===0?0:1),borderColor||new Color(140,140,140));this.hasShadow=noShadow!==true;this.noDropShadow=true;this.fullShadowSource=false;this.color=color||new Color(230,230,230);this.fixLayout()};SpeechBubbleMorph.prototype.popUp=function(world,pos,isClickable){this.fixLayout();this.setPosition(pos.subtract(new Point(0,this.height())));this.keepWithin(world);world.add(this);this.fullChanged();world.hand.destroyTemporaries();world.hand.temporaries.push(this);if(!isClickable){this.mouseEnter=this.destroy}else{this.isClickable=true}};SpeechBubbleMorph.prototype.fixLayout=function(){if(this.contentsMorph){this.contentsMorph.destroy()}if(this.contents instanceof Morph){this.contentsMorph=this.contents}else if(isString(this.contents)){this.contentsMorph=new TextMorph(this.contents,MorphicPreferences.bubbleHelpFontSize,null,false,true,"center")}else if(this.contents instanceof HTMLCanvasElement){this.contentsMorph=new Morph;this.contentsMorph.setExtent(new Point(this.contents.width,this.contents.height));this.contentsMorph.cachedImage=this.contents}else{this.contentsMorph=new TextMorph(this.contents.toString(),MorphicPreferences.bubbleHelpFontSize,null,false,true,"center")}this.add(this.contentsMorph);this.bounds.setExtent(new Point(this.contentsMorph.width()+(this.padding?this.padding*2:this.edge*2),this.contentsMorph.height()+this.edge+this.border*2+this.padding*2+2));this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)));if(this.hasShadow){this.removeShadow();this.addShadow(new Point(2,2),80)}};SpeechBubbleMorph.prototype.outlinePath=function(ctx,radius,inset){var offset=radius+inset,w=this.width(),h=this.height(),rad;function circle(x,y,r){ctx.moveTo(x+r,y);ctx.arc(x,y,r,radians(0),radians(360))}ctx.arc(offset,offset,radius,radians(-180),radians(-90),false);ctx.arc(w-offset,offset,radius,radians(-90),radians(-0),false);ctx.arc(w-offset,h-offset-radius,radius,radians(0),radians(90),false);if(!this.isThought){if(this.isPointingRight){ctx.lineTo(offset+radius,h-offset);ctx.lineTo(radius/2+inset,h-inset)}else{ctx.lineTo(w-(radius/2+inset),h-inset);ctx.lineTo(w-(offset+radius),h-offset)}}ctx.arc(offset,h-offset-radius,radius,radians(90),radians(180),false);if(this.isThought===true){ctx.lineTo(inset,offset);if(this.isPointingRight){rad=radius/4;circle(rad+inset,h-rad-inset,rad);rad=radius/3.2;circle(rad*2+inset,h-rad-inset*2,rad);rad=radius/2.8;circle(rad*3+inset*2,h-rad-inset*4,rad)}else{rad=radius/4;circle(w-(rad+inset),h-rad-inset,rad);rad=radius/3.2;circle(w-(rad*2+inset),h-rad-inset*2,rad);rad=radius/2.8;circle(w-(rad*3+inset*2),h-rad-inset*4,rad)}}};SpeechBubbleMorph.prototype.shadowImage=function(off,color){var fb,img,outline,sha,ctx,offset=off||new Point(7,7),clr=color||new Color(0,0,0);fb=this.extent();img=this.getImage();outline=newCanvas(fb);ctx=outline.getContext("2d");ctx.drawImage(img,0,0);ctx.globalCompositeOperation="destination-out";ctx.drawImage(img,-offset.x,-offset.y);sha=newCanvas(fb);ctx=sha.getContext("2d");ctx.drawImage(outline,0,0);ctx.globalCompositeOperation="source-atop";ctx.fillStyle=clr.toString();ctx.fillRect(0,0,fb.x,fb.y);return sha};SpeechBubbleMorph.prototype.shadowImageBlurred=function(off,color){var fb,img,sha,ctx,offset=off||new Point(7,7),blur=this.shadowBlur,clr=color||new Color(0,0,0);fb=this.extent().add(blur*2);img=this.getImage();sha=newCanvas(fb);ctx=sha.getContext("2d");ctx.shadowOffsetX=offset.x;ctx.shadowOffsetY=offset.y;ctx.shadowBlur=blur;ctx.shadowColor=clr.toString();ctx.drawImage(img,blur-offset.x,blur-offset.y);ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.shadowBlur=0;ctx.globalCompositeOperation="destination-out";ctx.drawImage(img,blur-offset.x,blur-offset.y);return sha};var DialMorph;DialMorph.prototype=new Morph;DialMorph.prototype.constructor=DialMorph;DialMorph.uber=Morph.prototype;function DialMorph(min,max,value,tick,radius){this.init(min,max,value,tick,radius)}DialMorph.prototype.init=function(min,max,value,tick,radius){this.target=null;this.action=null;this.min=min||0;this.max=max||360;this.value=Math.max(this.min,(value||0)%this.max);this.tick=tick||15;this.fillColor=null;DialMorph.uber.init.call(this);this.color=new Color(230,230,230);this.setRadius(radius||MorphicPreferences.menuFontSize*4)};DialMorph.prototype.setRadius=function(radius){this.radius=radius;this.setExtent(new Point(this.radius*2,this.radius*2))};DialMorph.prototype.setValue=function(value,snapToTick,noUpdate){var range=this.max-this.min;value=value||0;this.value=this.min+(+value%range+range)%range;if(snapToTick){if(this.value<this.tick){this.value=this.min}else{this.value-=this.value%this.tick%this.value}}this.changed();if(noUpdate){return}this.updateTarget()};DialMorph.prototype.getValueOf=function(point){var range=this.max-this.min,center=this.center(),deltaX=point.x-center.x,deltaY=center.y-point.y,angle=Math.abs(deltaX)<.001?deltaY<0?90:270:Math.round((deltaX>=0?0:180)-Math.atan(deltaY/deltaX)*57.2957795131),value=angle+90%360,ratio=value/360;return range*ratio+this.min};DialMorph.prototype.setExtent=function(aPoint){var size=Math.min(aPoint.x,aPoint.y);this.radius=size/2;DialMorph.uber.setExtent.call(this,new Point(size,size))};DialMorph.prototype.render=function(ctx){var i,angle,x1,y1,x2,y2,light=this.color.lighter().toString(),range=this.max-this.min,ticks=range/this.tick,face=this.radius*.75,inner=face*.85,outer=face*.95;ctx.fillStyle=light;ctx.beginPath();ctx.arc(this.radius,this.radius,face+Math.min(1,this.radius-face),0,2*Math.PI,false);ctx.closePath();ctx.fill();ctx.fillStyle=this.color.toString();ctx.beginPath();ctx.arc(this.radius,this.radius,face,0,2*Math.PI,false);ctx.closePath();ctx.fill();angle=(this.value-this.min)*(Math.PI*2)/range-Math.PI/2;ctx.fillStyle=(this.fillColor||this.color.darker()).toString();ctx.beginPath();ctx.arc(this.radius,this.radius,face,Math.PI/-2,angle,false);ctx.lineTo(this.radius,this.radius);ctx.closePath();ctx.fill();ctx.strokeStyle=new Color(35,35,35).toString();ctx.lineWidth=1;for(i=0;i<ticks;i+=1){angle=(i-3)*(Math.PI*2)/ticks-Math.PI/2;ctx.beginPath();x1=this.radius+Math.cos(angle)*inner;y1=this.radius+Math.sin(angle)*inner;x2=this.radius+Math.cos(angle)*outer;y2=this.radius+Math.sin(angle)*outer;ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke()}inner=face*.05;ctx.fillStyle="black";ctx.beginPath();ctx.arc(this.radius,this.radius,inner,0,2*Math.PI,false);ctx.closePath();ctx.fill();ctx.strokeStyle="black";ctx.lineWidth=1;angle=(this.value-this.min)*(Math.PI*2)/range-Math.PI/2;outer=face*.8;x1=this.radius+Math.cos(angle)*inner;y1=this.radius+Math.sin(angle)*inner;x2=this.radius+Math.cos(angle)*outer;y2=this.radius+Math.sin(angle)*outer;ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();inner=inner*2;x2=this.radius+Math.cos(angle)*(outer+inner);y2=this.radius+Math.sin(angle)*(outer+inner);ctx.fillStyle="black";ctx.beginPath();ctx.arc(x2,y2,inner,0,2*Math.PI,false);ctx.closePath();ctx.stroke();angle=(this.value-this.min)*(Math.PI*2)/range-Math.PI/2;x1=this.radius+Math.cos(angle)*face;y1=this.radius+Math.sin(angle)*face;x2=this.radius+Math.cos(angle)*(this.radius-1);y2=this.radius+Math.sin(angle)*(this.radius-1);ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.lineWidth=3;ctx.strokeStyle=light;ctx.stroke();ctx.lineWidth=1;ctx.strokeStyle="black";ctx.stroke();angle=radians(degrees(angle)-4);x1=this.radius+Math.cos(angle)*this.radius*.9;y1=this.radius+Math.sin(angle)*this.radius*.9;ctx.beginPath();ctx.moveTo(x1,y1);angle=radians(degrees(angle)+8);x1=this.radius+Math.cos(angle)*this.radius*.9;y1=this.radius+Math.sin(angle)*this.radius*.9;ctx.lineTo(x1,y1);ctx.lineTo(x2,y2);ctx.closePath();ctx.lineWidth=3;ctx.strokeStyle=light;ctx.stroke();ctx.lineWidth=1;ctx.strokeStyle="black";ctx.stroke();ctx.fill()};DialMorph.prototype.step=null;DialMorph.prototype.mouseDownLeft=function(pos){var world=this.root();this.step=()=>{if(world.hand.mouseButton){this.setValue(this.getValueOf(world.hand.bounds.origin),world.currentKey!==16)}else{this.step=null}}};DialMorph.prototype.developersMenu=function(){var menu=DialMorph.uber.developersMenu.call(this);menu.addLine();menu.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be "+"controlled by this one");return menu};DialMorph.prototype.setTarget=function(){var choices=this.overlappedMorphs(),menu=new MenuMorph(this,"choose target:");choices.push(this.world());choices.forEach(each=>{menu.addItem(each.toString().slice(0,50),()=>{this.target=each;this.setTargetSetter()})});if(choices.length===1){this.target=choices[0];this.setTargetSetter()}else if(choices.length>0){menu.popUpAtHand(this.world())}};DialMorph.prototype.setTargetSetter=function(){var choices=this.target.numericalSetters(),menu=new MenuMorph(this,"choose target property:");choices.forEach(each=>{menu.addItem(each,()=>this.action=each)});if(choices.length===1){this.action=choices[0]}else if(choices.length>0){menu.popUpAtHand(this.world())}};DialMorph.prototype.updateTarget=function(){if(this.action){if(typeof this.action==="function"){this.action.call(this.target,this.value)}else{this.target[this.action](this.value)}}};var CircleBoxMorph;CircleBoxMorph.prototype=new Morph;CircleBoxMorph.prototype.constructor=CircleBoxMorph;CircleBoxMorph.uber=Morph.prototype;function CircleBoxMorph(orientation){this.init(orientation||"vertical")}CircleBoxMorph.prototype.init=function(orientation){CircleBoxMorph.uber.init.call(this);this.orientation=orientation;this.autoOrient=true;this.setExtent(new Point(20,100))};CircleBoxMorph.prototype.autoOrientation=function(){if(this.height()>this.width()){this.orientation="vertical"}else{this.orientation="horizontal"}};CircleBoxMorph.prototype.render=function(ctx){var w=this.width(),h=this.height(),radius;if(this.autoOrient){this.autoOrientation()}if(this.orientation==="vertical"){radius=w/2;ctx.beginPath();ctx.arc(radius,radius,radius,radians(180),radians(0),false);ctx.lineTo(w,h-radius);ctx.arc(radius,h-radius,radius,radians(0),radians(180),false)}else{radius=h/2;ctx.beginPath();ctx.arc(radius,radius,radius,radians(90),radians(-90),false);ctx.lineTo(w-radius,0);ctx.arc(w-radius,radius,radius,radians(-90),radians(90),false)}ctx.closePath();ctx.fillStyle=this.color.toString();ctx.fill()};CircleBoxMorph.prototype.developersMenu=function(){var menu=CircleBoxMorph.uber.developersMenu.call(this);menu.addLine();if(this.orientation==="vertical"){menu.addItem("horizontal...","toggleOrientation","toggle the\norientation")}else{menu.addItem("vertical...","toggleOrientation","toggle the\norientation")}return menu};CircleBoxMorph.prototype.toggleOrientation=function(){var center=this.center();this.changed();if(this.orientation==="vertical"){this.orientation="horizontal"}else{this.orientation="vertical"}this.setExtent(new Point(this.height(),this.width()));this.setCenter(center)};var SliderButtonMorph;SliderButtonMorph.prototype=new CircleBoxMorph;SliderButtonMorph.prototype.constructor=SliderButtonMorph;SliderButtonMorph.uber=CircleBoxMorph.prototype;function SliderButtonMorph(orientation){this.init(orientation)}SliderButtonMorph.prototype.init=function(orientation){this.color=new Color(80,80,80);this.highlightColor=new Color(90,90,140);this.pressColor=new Color(80,80,160);this.userState="normal";this.is3D=false;this.hasMiddleDip=true;SliderButtonMorph.uber.init.call(this,orientation)};SliderButtonMorph.prototype.autoOrientation=nop;SliderButtonMorph.prototype.render=function(ctx){var colorBak=this.color;if(this.userState==="highlight"){this.color=this.highlightColor}else if(this.userState==="pressed"){this.color=this.pressColor}SliderButtonMorph.uber.render.call(this,ctx);if(this.is3D||!MorphicPreferences.isFlat){this.renderEdges(ctx)}this.color=colorBak};SliderButtonMorph.prototype.renderEdges=function(ctx){var gradient,radius,w=this.width(),h=this.height();ctx.lineJoin="round";ctx.lineCap="round";if(this.orientation==="vertical"){ctx.lineWidth=w/3;gradient=ctx.createLinearGradient(0,0,ctx.lineWidth,0);gradient.addColorStop(0,"white");gradient.addColorStop(1,this.color.toString());ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(ctx.lineWidth*.5,w/2);ctx.lineTo(ctx.lineWidth*.5,h-w/2);ctx.stroke();gradient=ctx.createLinearGradient(w-ctx.lineWidth,0,w,0);gradient.addColorStop(0,this.color.toString());gradient.addColorStop(1,"black");ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(w-ctx.lineWidth*.5,w/2);ctx.lineTo(w-ctx.lineWidth*.5,h-w/2);ctx.stroke();if(this.hasMiddleDip){gradient=ctx.createLinearGradient(ctx.lineWidth,0,w-ctx.lineWidth,0);radius=w/4;gradient.addColorStop(0,"black");gradient.addColorStop(.35,this.color.toString());gradient.addColorStop(.65,this.color.toString());gradient.addColorStop(1,"white");ctx.fillStyle=gradient;ctx.beginPath();ctx.arc(w/2,h/2,radius,radians(0),radians(360),false);ctx.closePath();ctx.fill()}}else if(this.orientation==="horizontal"){ctx.lineWidth=h/3;gradient=ctx.createLinearGradient(0,0,0,ctx.lineWidth);gradient.addColorStop(0,"white");gradient.addColorStop(1,this.color.toString());ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(h/2,ctx.lineWidth*.5);ctx.lineTo(w-h/2,ctx.lineWidth*.5);ctx.stroke();gradient=ctx.createLinearGradient(0,h-ctx.lineWidth,0,h);gradient.addColorStop(0,this.color.toString());gradient.addColorStop(1,"black");ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(h/2,h-ctx.lineWidth*.5);ctx.lineTo(w-h/2,h-ctx.lineWidth*.5);ctx.stroke();if(this.hasMiddleDip){gradient=ctx.createLinearGradient(0,ctx.lineWidth,0,h-ctx.lineWidth);radius=h/4;gradient.addColorStop(0,"black");gradient.addColorStop(.35,this.color.toString());gradient.addColorStop(.65,this.color.toString());gradient.addColorStop(1,"white");ctx.fillStyle=gradient;ctx.beginPath();ctx.arc(this.width()/2,this.height()/2,radius,radians(0),radians(360),false);ctx.closePath();ctx.fill()}}};SliderButtonMorph.prototype.mouseEnter=function(){this.userState="highlight";this.rerender()};SliderButtonMorph.prototype.mouseLeave=function(){this.userState="normal";this.rerender()};SliderButtonMorph.prototype.mouseDownLeft=function(pos){this.userState="pressed";this.rerender();this.escalateEvent("mouseDownLeft",pos)};SliderButtonMorph.prototype.mouseClickLeft=function(){this.userState="highlight";this.rerender()};SliderButtonMorph.prototype.mouseMove=function(){nop()};SliderMorph.prototype=new CircleBoxMorph;SliderMorph.prototype.constructor=SliderMorph;SliderMorph.uber=CircleBoxMorph.prototype;function SliderMorph(start,stop,value,size,orientation,color){this.init(start||0,stop||100,value||0,size||10,orientation||"vertical",color)}SliderMorph.prototype.init=function(start,stop,value,size,orientation,color){this.target=null;this.action=null;this.start=start;this.stop=stop;this.value=value;this.size=size;this.offset=null;this.button=new SliderButtonMorph;this.button.isDraggable=false;this.button.alpha=MorphicPreferences.isFlat?.7:1;this.button.color=new Color(200,200,200);this.button.highlightColor=new Color(210,210,255);this.button.pressColor=new Color(180,180,255);SliderMorph.uber.init.call(this,orientation);this.add(this.button);this.alpha=MorphicPreferences.isFlat?0:.3;this.color=color||new Color(0,0,0);this.setExtent(new Point(20,100));this.fixLayout()};SliderMorph.prototype.autoOrientation=nop;SliderMorph.prototype.rangeSize=function(){return this.stop-this.start};SliderMorph.prototype.ratio=function(){return this.size/(this.rangeSize()+1)};SliderMorph.prototype.unitSize=function(){if(this.orientation==="vertical"){return(this.height()-this.button.height())/this.rangeSize()}return(this.width()-this.button.width())/this.rangeSize()};SliderMorph.prototype.fixLayout=function(){var bw,bh,posX,posY;this.button.orientation=this.orientation;if(this.orientation==="vertical"){bw=this.width()-2;bh=Math.max(bw,Math.round(this.height()*this.ratio()));this.button.setExtent(new Point(bw,bh));posX=1;posY=Math.max(Math.min(Math.round((this.value-this.start)*this.unitSize()),this.height()-this.button.height()),0)}else{bh=this.height()-2;bw=Math.max(bh,Math.round(this.width()*this.ratio()));this.button.setExtent(new Point(bw,bh));posY=1;posX=Math.max(Math.min(Math.round((this.value-this.start)*this.unitSize()),this.width()-this.button.width()),0)}this.button.setPosition(new Point(posX,posY).add(this.bounds.origin))};SliderMorph.prototype.updateValue=function(){var relPos;if(this.orientation==="vertical"){relPos=this.button.top()-this.top()}else{relPos=this.button.left()-this.left()}this.value=Math.round(relPos/this.unitSize()+this.start);this.updateTarget()};SliderMorph.prototype.updateTarget=function(){if(this.action){if(typeof this.action==="function"){this.action.call(this.target,this.value)}else{this.target[this.action](this.value)}}};SliderMorph.prototype.developersMenu=function(){var menu=SliderMorph.uber.developersMenu.call(this);menu.addItem("show value...","showValue","display a dialog box\nshowing the selected number");menu.addItem("floor...",()=>{this.prompt(menu.title+"\nfloor:",this.setStart,this,this.start.toString(),null,0,this.stop-this.size,true)},"set the minimum value\nwhich can be selected");menu.addItem("ceiling...",()=>{this.prompt(menu.title+"\nceiling:",this.setStop,this,this.stop.toString(),null,this.start+this.size,this.size*100,true)},"set the maximum value\nwhich can be selected");menu.addItem("button size...",()=>{this.prompt(menu.title+"\nbutton size:",this.setSize,this,this.size.toString(),null,1,this.stop-this.start,true)},"set the range\ncovered by\nthe slider button");menu.addLine();menu.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be "+"controlled by this one");return menu};SliderMorph.prototype.showValue=function(){this.inform(this.value)};SliderMorph.prototype.userSetStart=function(num){this.start=Math.max(num,this.stop)};SliderMorph.prototype.setStart=function(num,noUpdate){var newStart;if(typeof num==="number"){this.start=Math.min(num,this.stop-this.size)}else{newStart=parseFloat(num);if(!isNaN(newStart)){this.start=Math.min(newStart,this.stop-this.size)}}this.value=Math.max(this.value,this.start);if(!noUpdate){this.updateTarget()}this.fixLayout();this.rerender()};SliderMorph.prototype.setStop=function(num,noUpdate){var newStop;if(typeof num==="number"){this.stop=Math.max(num,this.start+this.size)}else{newStop=parseFloat(num);if(!isNaN(newStop)){this.stop=Math.max(newStop,this.start+this.size)}}this.value=Math.min(this.value,this.stop);if(!noUpdate){this.updateTarget()}this.fixLayout();this.rerender()};SliderMorph.prototype.setSize=function(num,noUpdate){var newSize;if(typeof num==="number"){this.size=Math.min(Math.max(num,1),this.stop-this.start)}else{newSize=parseFloat(num);if(!isNaN(newSize)){this.size=Math.min(Math.max(newSize,1),this.stop-this.start)}}this.value=Math.min(this.value,this.stop-this.size);if(!noUpdate){this.updateTarget()}this.fixLayout();this.rerender()};SliderMorph.prototype.setTarget=function(){var choices=this.overlappedMorphs(),menu=new MenuMorph(this,"choose target:");choices.push(this.world());choices.forEach(each=>{menu.addItem(each.toString().slice(0,50),()=>{this.target=each;this.setTargetSetter()})});if(choices.length===1){this.target=choices[0];this.setTargetSetter()}else if(choices.length>0){menu.popUpAtHand(this.world())}};SliderMorph.prototype.setTargetSetter=function(){var choices=this.target.numericalSetters(),menu=new MenuMorph(this,"choose target property:");choices.forEach(each=>{menu.addItem(each,()=>this.action=each)});if(choices.length===1){this.action=choices[0]}else if(choices.length>0){menu.popUpAtHand(this.world())}};SliderMorph.prototype.numericalSetters=function(){var list=SliderMorph.uber.numericalSetters.call(this);list.push("setStart","setStop","setSize");return list};SliderMorph.prototype.step=null;SliderMorph.prototype.mouseDownLeft=function(pos){var world;if(!this.button.bounds.containsPoint(pos)){this.offset=new Point}else{this.offset=pos.subtract(this.button.bounds.origin)}world=this.root();this.step=()=>{var mousePos,newX,newY;if(world.hand.mouseButton){mousePos=world.hand.bounds.origin;if(this.orientation==="vertical"){newX=this.button.bounds.origin.x;newY=Math.max(Math.min(mousePos.y-this.offset.y,this.bottom()-this.button.height()),this.top())}else{newY=this.button.bounds.origin.y;newX=Math.max(Math.min(mousePos.x-this.offset.x,this.right()-this.button.width()),this.left())}this.button.setPosition(new Point(newX,newY));this.updateValue()}else{this.step=null}}};var MouseSensorMorph;MouseSensorMorph.prototype=new BoxMorph;MouseSensorMorph.prototype.constructor=MouseSensorMorph;MouseSensorMorph.uber=BoxMorph.prototype;function MouseSensorMorph(edge,border,borderColor){this.init(edge,border,borderColor)}MouseSensorMorph.prototype.init=function(edge,border,borderColor){MouseSensorMorph.uber.init.call(this);this.edge=edge||4;this.border=border||2;this.color=WHITE;this.borderColor=borderColor||BLACK;this.isTouched=false;this.upStep=.05;this.downStep=.02};MouseSensorMorph.prototype.touch=function(){if(!this.isTouched){this.isTouched=true;this.alpha=.6;this.step=()=>{if(this.isTouched){if(this.alpha<1){this.alpha+=this.upStep}}else if(this.alpha>this.downStep){this.alpha-=this.downStep}else{this.alpha=0;this.step=null}this.changed()}}};MouseSensorMorph.prototype.unTouch=function(){this.isTouched=false};MouseSensorMorph.prototype.mouseEnter=function(){this.touch()};MouseSensorMorph.prototype.mouseLeave=function(){this.unTouch()};MouseSensorMorph.prototype.mouseDownLeft=function(){this.touch()};MouseSensorMorph.prototype.mouseClickLeft=function(){this.unTouch()};var ListMorph;var TriggerMorph;InspectorMorph.prototype=new BoxMorph;InspectorMorph.prototype.constructor=InspectorMorph;InspectorMorph.uber=BoxMorph.prototype;function InspectorMorph(target){this.init(target)}InspectorMorph.prototype.init=function(target){this.target=target;this.currentProperty=null;this.showing="attributes";this.markOwnProperties=false;this.hasUserEditedDetails=false;InspectorMorph.uber.init.call(this);this.isDraggable=true;this.border=1;this.edge=MorphicPreferences.isFlat?1:5;this.color=new Color(60,60,60);this.borderColor=new Color(95,95,95);this.fps=25;this.label=null;this.list=null;this.detail=null;this.work=null;this.buttonInspect=null;this.buttonClose=null;this.buttonSubset=null;this.buttonEdit=null;this.resizer=null;if(this.target){this.buildPanes()}this.setExtent(new Point(MorphicPreferences.handleSize*20,MorphicPreferences.handleSize*20*2/3))};InspectorMorph.prototype.setTarget=function(target){this.target=target;this.currentProperty=null;this.buildPanes()};InspectorMorph.prototype.updateCurrentSelection=function(){var val,txt,cnts,sel=this.list.selected,currentTxt=this.detail.contents.children[0],root=this.root();if(root&&root.keyboardFocus instanceof CursorMorph&&root.keyboardFocus.target===currentTxt){this.hasUserEditedDetails=true;return}if(isNil(sel)||this.hasUserEditedDetails){return}val=this.target[sel];this.currentProperty=val;if(isNil(val)){txt="NULL"}else if(isString(val)){txt=val}else{txt=val.toString()}if(currentTxt.text===txt){return}cnts=new TextMorph(txt);cnts.isEditable=true;cnts.enableSelecting();cnts.setReceiver(this.target);this.detail.setContents(cnts)};InspectorMorph.prototype.buildPanes=function(){var attribs=[],property,ctrl,ev,doubleClickAction;this.children.forEach(m=>{if(m!==this.work){m.destroy()}});this.children=[];this.label=new TextMorph(this.target.toString());this.label.fontSize=MorphicPreferences.menuFontSize;this.label.isBold=true;this.label.color=WHITE;this.add(this.label);for(property in this.target){if(property){attribs.push(property)}}if(this.showing==="attributes"){attribs=attribs.filter(prop=>typeof this.target[prop]!=="function")}else if(this.showing==="methods"){attribs=attribs.filter(prop=>typeof this.target[prop]==="function")}doubleClickAction=()=>{var world,inspector;if(!isObject(this.currentProperty)){return}world=this.world();inspector=new InspectorMorph(this.currentProperty);inspector.setPosition(world.hand.position());inspector.keepWithin(world);world.add(inspector);inspector.changed()};this.list=new ListMorph(this.target instanceof Array?attribs:attribs.sort(),null,this.markOwnProperties?[[new Color(0,0,180),element=>{return Object.prototype.hasOwnProperty.call(this.target,element)}]]:null,doubleClickAction);this.list.action=()=>{this.hasUserEditedDetails=false;this.updateCurrentSelection()};this.list.hBar.alpha=.6;this.list.vBar.alpha=.6;this.list.contents.step=null;this.add(this.list);this.detail=new ScrollFrameMorph;this.detail.acceptsDrops=false;this.detail.contents.acceptsDrops=false;this.detail.isTextLineWrapping=true;this.detail.color=WHITE;this.detail.hBar.alpha=.6;this.detail.vBar.alpha=.6;ctrl=new TextMorph("");ctrl.isEditable=true;ctrl.enableSelecting();ctrl.setReceiver(this.target);this.detail.setContents(ctrl);this.add(this.detail);if(this.work===null){this.work=new ScrollFrameMorph;this.work.acceptsDrops=false;this.work.contents.acceptsDrops=false;this.work.isTextLineWrapping=true;this.work.color=WHITE;this.work.hBar.alpha=.6;this.work.vBar.alpha=.6;ev=new TextMorph("");ev.isEditable=true;ev.enableSelecting();ev.setReceiver(this.target);this.work.setContents(ev)}this.add(this.work);this.buttonSubset=new TriggerMorph;this.buttonSubset.labelString="show...";this.buttonSubset.createLabel();this.buttonSubset.action=()=>{var menu;menu=new MenuMorph;menu.addItem("attributes",()=>{this.showing="attributes";this.buildPanes()});menu.addItem("methods",()=>{this.showing="methods";this.buildPanes()});menu.addItem("all",()=>{this.showing="all";this.buildPanes()});menu.addLine();menu.addItem(this.markOwnProperties?"un-mark own":"mark own",()=>{this.markOwnProperties=!this.markOwnProperties;this.buildPanes()},"highlight\n'own' properties");menu.popUpAtHand(this.world())};this.add(this.buttonSubset);this.buttonInspect=new TriggerMorph;this.buttonInspect.labelString="inspect...";this.buttonInspect.createLabel();this.buttonInspect.action=()=>{var menu,world,inspector;if(isObject(this.currentProperty)){menu=new MenuMorph;menu.addItem("in new inspector...",()=>{world=this.world();inspector=new InspectorMorph(this.currentProperty);inspector.setPosition(world.hand.position());inspector.keepWithin(world);world.add(inspector);inspector.changed()});menu.addItem("here...",()=>this.setTarget(this.currentProperty));menu.popUpAtHand(this.world())}else{this.inform((this.currentProperty===null?"null":typeof this.currentProperty)+"\nis not inspectable")}};this.add(this.buttonInspect);this.buttonEdit=new TriggerMorph;this.buttonEdit.labelString="edit...";this.buttonEdit.createLabel();this.buttonEdit.action=()=>{var menu=new MenuMorph(this);menu.addItem("save","save","accept changes");menu.addLine();menu.addItem("add property...","addProperty");menu.addItem("rename...","renameProperty");menu.addItem("remove...","removeProperty");menu.popUpAtHand(this.world())};this.add(this.buttonEdit);this.buttonClose=new TriggerMorph;this.buttonClose.labelString="close";this.buttonClose.createLabel();this.buttonClose.action=()=>this.destroy();this.add(this.buttonClose);this.resizer=new HandleMorph(this,150,100,this.edge,this.edge);this.fixLayout()};InspectorMorph.prototype.fixLayout=function(){var x,y,r,b,w,h;x=this.left()+this.edge;y=this.top()+this.edge;r=this.right()-this.edge;w=r-x;this.label.setPosition(new Point(x,y));this.label.setWidth(w);if(this.label.height()>this.height()-50){this.bounds.setHeight(this.label.height()+50)}y=this.label.bottom()+2;w=Math.min(Math.floor(this.width()/3),this.list.listContents.width());w-=this.edge;b=this.bottom()-2*this.edge-MorphicPreferences.handleSize;h=b-y;this.list.setPosition(new Point(x,y));this.list.setExtent(new Point(w,h));x=this.list.right()+this.edge;r=this.right()-this.edge;w=r-x;this.detail.setPosition(new Point(x,y));this.detail.setExtent(new Point(w,h*2/3-this.edge));y=this.detail.bottom()+this.edge;this.work.setPosition(new Point(x,y));this.work.setExtent(new Point(w,h/3));x=this.list.left();y=this.list.bottom()+this.edge;w=this.list.width();h=MorphicPreferences.handleSize;this.buttonSubset.setPosition(new Point(x,y));this.buttonSubset.setExtent(new Point(w,h));x=this.detail.left();w=this.detail.width()-this.edge-MorphicPreferences.handleSize;w=w/3-this.edge/3;this.buttonInspect.setPosition(new Point(x,y));this.buttonInspect.setExtent(new Point(w,h));x=this.buttonInspect.right()+this.edge;this.buttonEdit.setPosition(new Point(x,y));this.buttonEdit.setExtent(new Point(w,h));x=this.buttonEdit.right()+this.edge;r=this.detail.right()-this.edge-MorphicPreferences.handleSize;w=r-x;this.buttonClose.setPosition(new Point(x,y));this.buttonClose.setExtent(new Point(w,h));this.resizer.fixLayout()};InspectorMorph.prototype.save=function(){var txt=this.detail.contents.children[0].text.toString(),prop=this.list.selected;try{this.target.evaluateString("this."+prop+" = "+txt);this.hasUserEditedDetails=false;this.target.changed()}catch(err){this.inform(err)}};InspectorMorph.prototype.addProperty=function(){this.prompt("new property name:",prop=>{if(prop){this.target[prop]=null;this.buildPanes();this.target.changed()}},this,"property")};InspectorMorph.prototype.renameProperty=function(){var propertyName=this.list.selected;this.prompt("property name:",prop=>{try{delete this.target[propertyName];this.target[prop]=this.currentProperty}catch(err){this.inform(err)}this.buildPanes();this.target.changed()},this,propertyName)};InspectorMorph.prototype.removeProperty=function(){var prop=this.list.selected;try{delete this.target[prop];this.currentProperty=null;this.buildPanes();this.target.changed()}catch(err){this.inform(err)}};InspectorMorph.prototype.step=function(){this.updateCurrentSelection();var lbl=this.target.toString();if(this.label.text===lbl){return}this.label.text=lbl;this.fixLayout()};InspectorMorph.prototype.updateReferences=function(map){var active=this.list.activeIndex();InspectorMorph.uber.updateReferences.call(this,map);this.buildPanes();this.list.activateIndex(active)};var MenuItemMorph;MenuMorph.prototype=new BoxMorph;MenuMorph.prototype.constructor=MenuMorph;MenuMorph.uber=BoxMorph.prototype;function MenuMorph(target,title,environment,fontSize){this.init(target,title,environment,fontSize)}MenuMorph.prototype.init=function(target,title,environment,fontSize){this.target=target;this.title=title||null;this.environment=environment||null;this.fontSize=fontSize||null;this.items=[];this.label=null;this.world=null;this.isListContents=false;this.hasFocus=false;this.selection=null;this.submenu=null;MenuMorph.uber.init.call(this);this.isDraggable=false;this.noDropShadow=true;this.fullShadowSource=false;this.border=null;this.edge=null};MenuMorph.prototype.addItem=function(labelString,action,hint,color,bold,italic,doubleClickAction,shortcut,verbatim){this.items.push([verbatim?labelString||"close":localize(labelString||"close"),action===0?0:action||nop,hint,color,bold||false,italic||false,doubleClickAction,shortcut,verbatim])};MenuMorph.prototype.addMenu=function(label,aMenu,indicator,verbatim){this.addPair(label,aMenu,isNil(indicator)?"►":indicator,null,verbatim)};MenuMorph.prototype.addPair=function(label,action,shortcut,hint,verbatim){this.addItem(label,action,hint,null,null,null,null,shortcut,verbatim)};MenuMorph.prototype.addLine=function(width){this.items.push([0,width||1])};MenuMorph.prototype.createLabel=function(){var text;if(this.label!==null){this.label.destroy()}text=new TextMorph(localize(this.title),this.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,true,false,"center");text.alignment="center";text.color=WHITE;text.backgroundColor=this.borderColor;text.fixLayout();this.label=new BoxMorph(3,0);if(MorphicPreferences.isFlat){this.label.edge=0}this.label.color=this.borderColor;this.label.borderColor=this.borderColor;this.label.setExtent(text.extent().add(4));this.label.add(text);this.label.text=text};MenuMorph.prototype.createItems=function(){var item,fb,x,y,isLine=false;this.children.forEach(m=>m.destroy());this.children=[];if(!this.isListContents){this.edge=MorphicPreferences.isFlat?0:5;this.border=MorphicPreferences.isFlat?1:2}this.color=WHITE;this.borderColor=new Color(60,60,60);this.setExtent(new Point(0,0));y=2;x=this.left()+4;if(!this.isListContents){if(this.title){this.createLabel();this.label.setPosition(this.bounds.origin.add(4));this.add(this.label);y=this.label.bottom()}else{y=this.top()+4}}y+=1;this.items.forEach(tuple=>{isLine=false;if(tuple instanceof StringFieldMorph||tuple instanceof ColorPickerMorph||tuple instanceof SliderMorph||tuple instanceof DialMorph){item=tuple}else if(tuple[0]===0){isLine=true;item=new Morph;item.color=this.borderColor;item.setHeight(tuple[1])}else{item=new MenuItemMorph(this.target,tuple[1],tuple[0],this.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,this.environment,tuple[2],tuple[3],tuple[4],tuple[5],tuple[6],tuple[7])}if(isLine){y+=1}item.setPosition(new Point(x,y));this.add(item);y=y+item.height();if(isLine){y+=1}});fb=this.fullBounds();this.setExtent(fb.extent().add(4));this.adjustWidths()};MenuMorph.prototype.maxWidth=function(){var w=0;if(this.parent instanceof FrameMorph){if(this.parent.scrollFrame instanceof ScrollFrameMorph){w=this.parent.scrollFrame.width()}}this.children.forEach(item=>{if(item instanceof MenuItemMorph){w=Math.max(w,item.label.width()+8+(item.shortcut?item.shortcut.width()+4:0))}else if(item instanceof StringFieldMorph||item instanceof ColorPickerMorph||item instanceof SliderMorph||item instanceof DialMorph){w=Math.max(w,item.width())}});if(this.label){w=Math.max(w,this.label.width())}return w};MenuMorph.prototype.adjustWidths=function(){var w=this.maxWidth();this.children.forEach(item=>{if(!(item instanceof DialMorph)){item.setWidth(w)}item.fixLayout();if(item===this.label){item.text.setPosition(item.center().subtract(item.text.extent().floorDivideBy(2)))}})};MenuMorph.prototype.unselectAllItems=function(){this.children.forEach(item=>{if(item instanceof MenuItemMorph){if(item.userState!=="normal"){item.userState="normal";item.rerender()}}else if(item instanceof ScrollFrameMorph){item.contents.children.forEach(morph=>{if(morph instanceof MenuItemMorph&&morph.userState!=="normal"){morph.userState="normal";morph.rerender()}})}})};MenuMorph.prototype.popup=function(world,pos){var scroller;this.createItems();this.setPosition(pos);this.addShadow(new Point(2,2),80);this.keepWithin(world);if(this.bottom()>world.bottom()){this.removeShadow();scroller=this.scroll();this.bounds.corner.y=world.bottom()-2;this.addShadow(new Point(2,2),80);scroller.setHeight(world.bottom()-scroller.top()-6);scroller.adjustScrollBars()}if(world.activeMenu){world.activeMenu.destroy()}if(this.items.length<1&&!this.title){return}world.add(this);world.activeMenu=this;this.world=world;this.fullChanged()};MenuMorph.prototype.scroll=function(){var scroller=new ScrollFrameMorph,start=this.label?1:0,first=this.children[start];scroller.setPosition(first.position());this.children.slice(start).forEach(morph=>scroller.addContents(morph));this.add(scroller);scroller.setWidth(first.width());return scroller};MenuMorph.prototype.popUpAtHand=function(world){var wrrld=world||this.world;this.popup(wrrld,wrrld.hand.position())};MenuMorph.prototype.popUpCenteredAtHand=function(world){var wrrld=world||this.world;this.fixLayout();this.createItems();this.popup(wrrld,wrrld.hand.position().subtract(this.extent().floorDivideBy(2)))};MenuMorph.prototype.popUpCenteredInWorld=function(world){var wrrld=world||this.world;this.fixLayout();this.createItems();this.popup(wrrld,wrrld.center().subtract(this.extent().floorDivideBy(2)))};MenuMorph.prototype.closeRootMenu=function(){if(this.parent instanceof MenuMorph){this.parent.closeRootMenu()}else{this.destroy()}};MenuMorph.prototype.closeSubmenu=function(){if(this.submenu){this.submenu.destroy();this.submenu=null;this.unselectAllItems();this.world.activeMenu=this}};MenuMorph.prototype.getFocus=function(){this.world.keyboardFocus=this;this.selection=null;this.selectFirst();this.hasFocus=true};MenuMorph.prototype.processKeyDown=function(event){switch(event.keyCode){case 13:case 32:if(this.selection){this.selection.mouseClickLeft();if(this.submenu){this.submenu.getFocus()}}return;case 27:return this.destroy();case 37:return this.leaveSubmenu();case 38:return this.selectUp();case 39:return this.enterSubmenu();case 40:return this.selectDown();default:nop()}};MenuMorph.prototype.processKeyUp=function(event){nop(event)};MenuMorph.prototype.processKeyPress=function(event){nop(event)};MenuMorph.prototype.selectFirst=function(){var scroller,items,i;scroller=detect(this.children,morph=>morph instanceof ScrollFrameMorph);items=scroller?scroller.contents.children:this.children;for(i=0;i<items.length;i+=1){if(items[i]instanceof MenuItemMorph){this.select(items[i]);return}}};MenuMorph.prototype.selectUp=function(){var scroller,triggers,idx;scroller=detect(this.children,morph=>morph instanceof ScrollFrameMorph);triggers=(scroller?scroller.contents.children:this.children).filter(each=>each instanceof MenuItemMorph);if(!this.selection){if(triggers.length){this.select(triggers[0])}return}idx=triggers.indexOf(this.selection)-1;if(idx<0){idx=triggers.length-1}this.select(triggers[idx])};MenuMorph.prototype.selectDown=function(){var scroller,triggers,idx;scroller=detect(this.children,morph=>morph instanceof ScrollFrameMorph);triggers=(scroller?scroller.contents.children:this.children).filter(each=>each instanceof MenuItemMorph);if(!this.selection){if(triggers.length){this.select(triggers[0])}return}idx=triggers.indexOf(this.selection)+1;if(idx>=triggers.length){idx=0}this.select(triggers[idx])};MenuMorph.prototype.enterSubmenu=function(){if(this.selection&&this.selection.action instanceof MenuMorph){this.selection.popUpSubmenu();if(this.submenu){this.submenu.getFocus()}}};MenuMorph.prototype.leaveSubmenu=function(){var menu=this.parent;if(this.parent instanceof MenuMorph){menu.submenu=null;menu.hasFocus=true;this.destroy();menu.world.keyboardFocus=menu;menu.world.activeMenu=menu}};MenuMorph.prototype.select=function(aMenuItem){this.unselectAllItems();aMenuItem.userState="highlight";aMenuItem.rerender();aMenuItem.scrollIntoView();this.selection=aMenuItem};MenuMorph.prototype.destroy=function(){if(this.hasFocus){this.world.keyboardFocus=null}if(!this.isListContents&&this.world.activeMenu===this){this.world.activeMenu=null}MenuMorph.uber.destroy.call(this)};StringMorph.prototype=new Morph;StringMorph.prototype.constructor=StringMorph;StringMorph.uber=Morph.prototype;StringMorph.prototype.measureCtx=newCanvas().getContext("2d");function StringMorph(text,fontSize,fontStyle,bold,italic,isNumeric,shadowOffset,shadowColor,color,fontName){this.init(text,fontSize,fontStyle,bold,italic,isNumeric,shadowOffset,shadowColor,color,fontName)}StringMorph.prototype.init=function(text,fontSize,fontStyle,bold,italic,isNumeric,shadowOffset,shadowColor,color,fontName){this.text=text||(text===""?"":"StringMorph");this.fontSize=fontSize||12;this.fontName=fontName||MorphicPreferences.globalFontFamily;this.fontStyle=fontStyle||"sans-serif";this.isBold=bold||false;this.isItalic=italic||false;this.isEditable=false;this.enableLinks=false;this.isNumeric=isNumeric||false;this.isPassword=false;this.shadowOffset=shadowOffset||ZERO;this.shadowColor=shadowColor||null;this.isShowingBlanks=false;this.blanksColor=new Color(180,140,140);this.isScrollable=true;this.currentlySelecting=false;this.startMark=0;this.endMark=0;this.markedTextColor=WHITE;this.markedBackgoundColor=new Color(60,60,120);StringMorph.uber.init.call(this,true);this.color=color||new Color(0,0,0);this.fixLayout()};StringMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+'("'+this.text.slice(0,30)+'...")'};StringMorph.prototype.password=function(letter,length){var ans="",i;for(i=0;i<length;i+=1){ans+=letter}return ans};StringMorph.prototype.font=function(){var font="";if(this.isBold){font=font+"bold "}if(this.isItalic){font=font+"italic "}return font+this.fontSize+"px "+(this.fontName?this.fontName+", ":"")+this.fontStyle};StringMorph.prototype.getShadowRenderColor=function(){return this.shadowColor};StringMorph.prototype.fixLayout=function(justMe){var width,shadowOffset=this.shadowOffset||ZERO,txt=this.isPassword?this.password("*",this.text.length):this.text;this.measureCtx.font=this.font();width=Math.max(this.measureCtx.measureText(txt).width+Math.abs(shadowOffset.x),1);this.bounds.corner=this.bounds.origin.add(new Point(width,fontHeight(this.fontSize)+Math.abs(shadowOffset.y)));if(!justMe&&this.parent){if(this.parent.fixLayout){this.parent.fixLayout()}}};StringMorph.prototype.render=function(ctx){var start,stop,i,p,c,x,y,shadowOffset=this.shadowOffset||ZERO,shadowColor=this.getShadowRenderColor(),txt=this.isPassword?this.password("*",this.text.length):this.text;ctx.font=this.font();ctx.textAlign="left";ctx.textBaseline="bottom";if(shadowColor){x=Math.max(shadowOffset.x,0);y=Math.max(shadowOffset.y,0);ctx.fillStyle=shadowColor.toString();ctx.fillText(txt,x,fontHeight(this.fontSize)+y)}x=Math.abs(Math.min(shadowOffset.x,0));y=Math.abs(Math.min(shadowOffset.y,0));ctx.fillStyle=this.getRenderColor().toString();if(this.isShowingBlanks){this.renderWithBlanks(ctx,x,fontHeight(this.fontSize)+y)}else{ctx.fillText(txt,x,fontHeight(this.fontSize)+y)}start=Math.min(this.startMark,this.endMark);stop=Math.max(this.startMark,this.endMark);for(i=start;i<stop;i+=1){p=this.slotPosition(i).subtract(this.position());c=txt.charAt(i);ctx.fillStyle=this.markedBackgoundColor.toString();ctx.fillRect(p.x,p.y,ctx.measureText(c).width+1+x,fontHeight(this.fontSize)+y);ctx.fillStyle=this.markedTextColor.toString();ctx.fillText(c,p.x,fontHeight(this.fontSize)+p.y)}};StringMorph.prototype.renderWithBlanks=function(ctx,startX,y){var space=ctx.measureText(" ").width,blanksColor=this.blanksColor.toString(),top=y-this.height()/2,words=this.text.split(" "),x=startX||0,isFirst=true;function drawBlank(){ctx.fillStyle=blanksColor;ctx.beginPath();ctx.arc(x+space/2,top,space/2,radians(0),radians(360));ctx.fill();x+=space}words.forEach(word=>{if(!isFirst){drawBlank()}isFirst=false;if(word!==""){ctx.fillStyle=this.getRenderColor().toString();ctx.fillText(word,x,y);x+=ctx.measureText(word).width}})};StringMorph.prototype.slotPosition=function(slot){var txt=this.isPassword?this.password("*",this.text.length):this.text,dest=Math.min(Math.max(slot,0),txt.length);this.measureCtx.font=this.font();this.pos=dest;return new Point(this.left()+this.measureCtx.measureText(txt.slice(0,dest)).width,this.top())};StringMorph.prototype.slotAt=function(aPoint){var txt=this.isPassword?this.password("*",this.text.length):this.text,idx=0,charX=0;this.measureCtx.font=this.font();while(aPoint.x-this.left()>charX){charX+=this.measureCtx.measureText(txt[idx]).width;idx+=1;if(idx===txt.length){if(this.measureCtx.measureText(txt).width-this.measureCtx.measureText(txt[idx-1]).width/2<aPoint.x-this.left()){return idx}}}if(aPoint.x-this.left()>charX-this.measureCtx.measureText(txt[idx-1]).width/2){return idx}else{return idx-1}};StringMorph.prototype.upFrom=function(slot){return slot};StringMorph.prototype.downFrom=function(slot){return slot};StringMorph.prototype.startOfLine=function(){return 0};StringMorph.prototype.endOfLine=function(){return this.text.length};StringMorph.prototype.previousWordFrom=function(aSlot){var index=aSlot-1;while(index>0&&!isWordChar(this.text[index])){index-=1}while(index>0&&isWordChar(this.text[index-1])){index-=1}return index};StringMorph.prototype.nextWordFrom=function(aSlot){var index=aSlot;while(index<this.endOfLine()&&!isWordChar(this.text[index])){index+=1}while(index<this.endOfLine()&&isWordChar(this.text[index])){index+=1}return index};StringMorph.prototype.rawHeight=function(){return this.height()/1.2};StringMorph.prototype.developersMenu=function(){var menu=StringMorph.uber.developersMenu.call(this);menu.addLine();menu.addItem("edit","edit");menu.addItem("font size...",()=>{this.prompt(menu.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,500,true)},"set this String's\nfont point size");if(this.fontStyle!=="serif"){menu.addItem("serif","setSerif")}if(this.fontStyle!=="sans-serif"){menu.addItem("sans-serif","setSansSerif")}if(this.isBold){menu.addItem("normal weight","toggleWeight")}else{menu.addItem("bold","toggleWeight")}if(this.isItalic){menu.addItem("normal style","toggleItalic")}else{menu.addItem("italic","toggleItalic")}if(this.isShowingBlanks){menu.addItem("hide blanks","toggleShowBlanks")}else{menu.addItem("show blanks","toggleShowBlanks")}if(this.isPassword){menu.addItem("show characters","toggleIsPassword")}else{menu.addItem("hide characters","toggleIsPassword")}return menu};StringMorph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable;if(this.isDraggable){this.disableSelecting()}else{this.enableSelecting()}};StringMorph.prototype.toggleShowBlanks=function(){this.isShowingBlanks=!this.isShowingBlanks;this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.toggleWeight=function(){this.isBold=!this.isBold;this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.toggleItalic=function(){this.isItalic=!this.isItalic;this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.toggleIsPassword=function(){this.isPassword=!this.isPassword;this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.setSerif=function(){this.fontStyle="serif";this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.setSansSerif=function(){this.fontStyle="sans-serif";this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.setFontSize=function(size){var newSize;if(typeof size==="number"){this.fontSize=Math.round(Math.min(Math.max(size,4),500))}else{newSize=parseFloat(size);if(!isNaN(newSize)){this.fontSize=Math.round(Math.min(Math.max(newSize,4),500))}}this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.setText=function(size){this.text=Math.round(size).toString();this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setAlphaScaled","setFontSize","setText"]};StringMorph.prototype.edit=function(){this.root().edit(this)};StringMorph.prototype.selection=function(){var start,stop;start=Math.min(this.startMark,this.endMark);stop=Math.max(this.startMark,this.endMark);return this.text.slice(start,stop)};StringMorph.prototype.selectionStartSlot=function(){return Math.min(this.startMark,this.endMark)};StringMorph.prototype.clearSelection=function(){if(!this.currentlySelecting&&isNil(this.startMark)&&isNil(this.endMark)){return}this.currentlySelecting=false;this.startMark=null;this.endMark=null;this.changed()};StringMorph.prototype.deleteSelection=function(){var start,stop,text;text=this.text;start=Math.min(this.startMark,this.endMark);stop=Math.max(this.startMark,this.endMark);this.text=text.slice(0,start)+text.slice(stop);this.changed();this.clearSelection()};StringMorph.prototype.selectAll=function(){var cursor;if(this.isEditable){this.startMark=0;cursor=this.root().cursor;this.endMark=this.text.length;if(cursor){cursor.gotoSlot(this.text.length);cursor.syncTextareaSelectionWith(this)}this.fixLayout();this.rerender()}};StringMorph.prototype.mouseDownLeft=function(pos){if(this.world().currentKey===16){this.shiftClick(pos)}else if(this.isEditable){this.clearSelection()}else{this.escalateEvent("mouseDownLeft",pos)}};StringMorph.prototype.shiftClick=function(pos){var cursor=this.root().cursor;if(cursor){if(!this.startMark){this.startMark=cursor.slot}cursor.gotoPos(pos);this.endMark=cursor.slot;cursor.syncTextareaSelectionWith(this);this.changed()}this.currentlySelecting=false;this.escalateEvent("mouseDownLeft",pos)};StringMorph.prototype.mouseClickLeft=function(pos){var cursor,slot,clickedText,startMark,endMark;if(this.isEditable){if(!this.currentlySelecting){this.edit()}cursor=this.root().cursor;if(cursor){cursor.gotoPos(pos)}this.currentlySelecting=true}else if(this.enableLinks){slot=this.slotAt(pos);if(slot===this.text.length){slot-=1}startMark=slot;while(startMark>1&&isURLChar(this.text[startMark-1])){startMark-=1}endMark=slot;while(endMark<this.text.length-1&&isURLChar(this.text[endMark+1])){endMark+=1}clickedText=this.text.substring(startMark,endMark+1);if(isURL(clickedText)){window.open(clickedText,"_blank")}else{this.escalateEvent("mouseClickLeft",pos)}}else{this.escalateEvent("mouseClickLeft",pos)}};StringMorph.prototype.mouseDoubleClick=function(pos){var slot=this.slotAt(pos);if(this.isEditable){this.edit();if(slot===this.text.length){slot-=1}if(this.text[slot]&&isWordChar(this.text[slot])){this.selectWordAt(slot)}else if(this.text[slot]){this.selectBetweenWordsAt(slot)}else{this.selectAll()}this.root().cursor.syncTextareaSelectionWith(this)}else{this.escalateEvent("mouseDoubleClick",pos)}};StringMorph.prototype.selectWordAt=function(slot){var cursor=this.root().cursor;if(slot===0||isWordChar(this.text[slot-1])){cursor.gotoSlot(this.previousWordFrom(slot));this.startMark=cursor.slot;this.endMark=this.nextWordFrom(cursor.slot)}else{cursor.gotoSlot(slot);this.startMark=slot;this.endMark=this.nextWordFrom(slot)}this.changed()};StringMorph.prototype.selectBetweenWordsAt=function(slot){var cursor=this.root().cursor;cursor.gotoSlot(this.nextWordFrom(this.previousWordFrom(slot)));this.startMark=cursor.slot;this.endMark=cursor.slot;while(this.endMark<this.text.length&&!isWordChar(this.text[this.endMark])){this.endMark+=1}this.changed()};StringMorph.prototype.enableSelecting=function(){this.mouseDownLeft=function(pos){var crs=this.root().cursor,already=crs?crs.target===this:false;if(this.world().currentKey===16){this.shiftClick(pos)}else{this.clearSelection();if(this.isEditable&&!this.isDraggable){this.edit();this.root().cursor.gotoPos(pos);this.startMark=this.slotAt(pos);this.endMark=this.startMark;this.currentlySelecting=true;this.root().cursor.syncTextareaSelectionWith(this);if(!already){this.escalateEvent("mouseDownLeft",pos)}}}};this.mouseMove=function(pos){if(this.isEditable&&this.currentlySelecting&&!this.isDraggable){var newMark=this.slotAt(pos);if(newMark!==this.endMark){this.endMark=newMark;this.root().cursor.syncTextareaSelectionWith(this);this.changed()}}}};StringMorph.prototype.disableSelecting=function(){this.mouseDownLeft=StringMorph.prototype.mouseDownLeft;delete this.mouseMove};TextMorph.prototype=new Morph;TextMorph.prototype.constructor=TextMorph;TextMorph.uber=Morph.prototype;TextMorph.prototype.measureCtx=StringMorph.prototype.measureCtx;function TextMorph(text,fontSize,fontStyle,bold,italic,alignment,width,fontName,shadowOffset,shadowColor){this.init(text,fontSize,fontStyle,bold,italic,alignment,width,fontName,shadowOffset,shadowColor)}TextMorph.prototype.init=function(text,fontSize,fontStyle,bold,italic,alignment,width,fontName,shadowOffset,shadowColor){this.text=text||(text===""?text:"TextMorph");this.words=[];this.lines=[];this.lineSlots=[];this.fontSize=fontSize||12;this.fontName=fontName||MorphicPreferences.globalFontFamily;this.fontStyle=fontStyle||"sans-serif";this.isBold=bold||false;this.isItalic=italic||false;this.alignment=alignment||"left";this.shadowOffset=shadowOffset||ZERO;this.shadowColor=shadowColor||null;this.maxWidth=width||0;this.maxLineWidth=0;this.backgroundColor=null;this.isEditable=false;this.enableLinks=false;this.receiver=null;this.isScrollable=true;this.currentlySelecting=false;this.startMark=0;this.endMark=0;this.markedTextColor=WHITE;this.markedBackgoundColor=new Color(60,60,120);TextMorph.uber.init.call(this);this.color=new Color(0,0,0);this.fixLayout()};TextMorph.prototype.toString=function(){return"a TextMorph"+'("'+this.text.slice(0,30)+'...")'};TextMorph.prototype.font=StringMorph.prototype.font;TextMorph.prototype.parse=function(){var paragraphs=this.text.split("\n"),context=this.measureCtx,oldline="",newline,w,slot=0;context.font=this.font();this.maxLineWidth=0;this.lines=[];this.lineSlots=[0];this.words=[];paragraphs.forEach(p=>{this.words=this.words.concat(p.split(" "));this.words.push("\n")});this.words.forEach(word=>{if(word==="\n"){this.lines.push(oldline);this.lineSlots.push(slot);this.maxLineWidth=Math.max(this.maxLineWidth,context.measureText(oldline).width);oldline=""}else{if(this.maxWidth>0){newline=oldline+word+" ";w=context.measureText(newline).width;if(w>this.maxWidth){this.lines.push(oldline);this.lineSlots.push(slot);this.maxLineWidth=Math.max(this.maxLineWidth,context.measureText(oldline).width);oldline=word+" "}else{oldline=newline}}else{oldline=oldline+word+" "}slot+=word.length+1}})};TextMorph.prototype.fixLayout=function(){var height,shadowHeight,shadowWidth;this.parse();shadowWidth=Math.abs(this.shadowOffset.x);shadowHeight=Math.abs(this.shadowOffset.y);height=this.lines.length*(fontHeight(this.fontSize)+shadowHeight);if(this.maxWidth===0){this.bounds=this.bounds.origin.extent(new Point(this.maxLineWidth+shadowWidth,height))}else{this.bounds=this.bounds.origin.extent(new Point(this.maxWidth+shadowWidth,height))}if(this.parent){if(this.parent.layoutChanged){this.parent.layoutChanged()}}};TextMorph.prototype.render=function(ctx){var shadowWidth=Math.abs(this.shadowOffset.x),shadowHeight=Math.abs(this.shadowOffset.y),shadowColor=this.getShadowRenderColor(),i,line,width,offx,offy,x,y,start,stop,p,c;ctx.font=this.font();ctx.textAlign="left";ctx.textBaseline="bottom";if(this.backgroundColor){ctx.fillStyle=this.backgroundColor.toString();ctx.fillRect(0,0,this.width(),this.height())}if(shadowColor){offx=Math.max(this.shadowOffset.x,0);offy=Math.max(this.shadowOffset.y,0);ctx.fillStyle=shadowColor.toString();for(i=0;i<this.lines.length;i=i+1){line=this.lines[i];width=ctx.measureText(line).width+shadowWidth;if(this.alignment==="right"){x=this.width()-width}else if(this.alignment==="center"){x=(this.width()-width)/2}else{x=0}y=(i+1)*(fontHeight(this.fontSize)+shadowHeight)-shadowHeight;ctx.fillText(line,x+offx,y+offy)}}offx=Math.abs(Math.min(this.shadowOffset.x,0));offy=Math.abs(Math.min(this.shadowOffset.y,0));ctx.fillStyle=this.getRenderColor().toString();for(i=0;i<this.lines.length;i=i+1){line=this.lines[i];width=ctx.measureText(line).width+shadowWidth;if(this.alignment==="right"){x=this.width()-width}else if(this.alignment==="center"){x=(this.width()-width)/2}else{x=0}y=(i+1)*(fontHeight(this.fontSize)+shadowHeight)-shadowHeight;ctx.fillText(line,x+offx,y+offy)}start=Math.min(this.startMark,this.endMark);stop=Math.max(this.startMark,this.endMark);for(i=start;i<stop;i+=1){p=this.slotPosition(i).subtract(this.position());c=this.text.charAt(i);ctx.fillStyle=this.markedBackgoundColor.toString();ctx.fillRect(p.x,p.y,ctx.measureText(c).width+1,fontHeight(this.fontSize));ctx.fillStyle=this.markedTextColor.toString();ctx.fillText(c,p.x,p.y+fontHeight(this.fontSize))}};TextMorph.prototype.getShadowRenderColor=StringMorph.prototype.getShadowRenderColor;TextMorph.prototype.setExtent=function(aPoint){this.maxWidth=Math.max(aPoint.x,0);this.changed();this.fixLayout();this.rerender()};TextMorph.prototype.columnRow=function(slot){var row,col,idx=0;for(row=0;row<this.lines.length;row+=1){idx=this.lineSlots[row];for(col=0;col<this.lines[row].length;col+=1){if(idx===slot){return new Point(col,row)}idx+=1}}return new Point(this.lines[this.lines.length-1].length-1,this.lines.length-1)};TextMorph.prototype.slotPosition=function(slot){var colRow=this.columnRow(slot),ctx=this.measureCtx,shadowHeight=Math.abs(this.shadowOffset.y),xOffset=0,yOffset;ctx.font=this.font();yOffset=colRow.y*(fontHeight(this.fontSize)+shadowHeight);xOffset=ctx.measureText(this.lines[colRow.y].slice(0,colRow.x)).width;return new Point(this.left()+xOffset,this.top()+yOffset)};TextMorph.prototype.slotAt=function(aPoint){var charX,row=0,col=0,columnLength,shadowHeight=Math.abs(this.shadowOffset.y),ctx=this.measureCtx,textWidth;while(aPoint.y-this.top()>(fontHeight(this.fontSize)+shadowHeight)*row){row+=1}row=Math.max(row,1);ctx.font=this.font();textWidth=ctx.measureText(this.lines[row-1]).width;if(this.alignment==="right"){charX=this.width()-textWidth}else if(this.alignment==="center"){charX=(this.width()-textWidth)/2}else{charX=0}columnLength=this.lines[row-1].length;while(col<columnLength-1&&aPoint.x-this.left()>charX){charX+=ctx.measureText(this.lines[row-1][col]).width;col+=1}if(aPoint.x-this.left()>charX-ctx.measureText(this.lines[row-1][col]).width/2){return this.lineSlots[Math.max(row-1,0)]+col}else{return this.lineSlots[Math.max(row-1,0)]+col-1}};TextMorph.prototype.upFrom=function(slot){var above,colRow=this.columnRow(slot);if(colRow.y<1){return slot}above=this.lines[colRow.y-1];if(above.length<colRow.x-1){return this.lineSlots[colRow.y-1]+above.length}return this.lineSlots[colRow.y-1]+colRow.x};TextMorph.prototype.downFrom=function(slot){var below,colRow=this.columnRow(slot);if(colRow.y>this.lines.length-2){return slot}below=this.lines[colRow.y+1];if(below.length<colRow.x-1){return this.lineSlots[colRow.y+1]+below.length}return this.lineSlots[colRow.y+1]+colRow.x};TextMorph.prototype.startOfLine=function(slot){return this.lineSlots[this.columnRow(slot).y]};TextMorph.prototype.endOfLine=function(slot){return this.startOfLine(slot)+this.lines[this.columnRow(slot).y].length-1};TextMorph.prototype.previousWordFrom=StringMorph.prototype.previousWordFrom;TextMorph.prototype.nextWordFrom=StringMorph.prototype.nextWordFrom;TextMorph.prototype.edit=StringMorph.prototype.edit;TextMorph.prototype.selection=StringMorph.prototype.selection;TextMorph.prototype.selectionStartSlot=StringMorph.prototype.selectionStartSlot;TextMorph.prototype.clearSelection=StringMorph.prototype.clearSelection;TextMorph.prototype.deleteSelection=StringMorph.prototype.deleteSelection;TextMorph.prototype.selectAll=StringMorph.prototype.selectAll;TextMorph.prototype.mouseDownLeft=StringMorph.prototype.mouseDownLeft;TextMorph.prototype.shiftClick=StringMorph.prototype.shiftClick;TextMorph.prototype.mouseClickLeft=StringMorph.prototype.mouseClickLeft;TextMorph.prototype.mouseDoubleClick=StringMorph.prototype.mouseDoubleClick;TextMorph.prototype.selectWordAt=StringMorph.prototype.selectWordAt;TextMorph.prototype.selectBetweenWordsAt=StringMorph.prototype.selectBetweenWordsAt;TextMorph.prototype.enableSelecting=StringMorph.prototype.enableSelecting;TextMorph.prototype.disableSelecting=StringMorph.prototype.disableSelecting;TextMorph.prototype.selectAllAndEdit=function(){this.edit();this.selectAll()};TextMorph.prototype.developersMenu=function(){var menu=TextMorph.uber.developersMenu.call(this);menu.addLine();menu.addItem("edit","edit");menu.addItem("font size...",()=>{this.prompt(menu.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,100,true)},"set this Text's\nfont point size");if(this.alignment!=="left"){menu.addItem("align left","setAlignmentToLeft")}if(this.alignment!=="right"){menu.addItem("align right","setAlignmentToRight")}if(this.alignment!=="center"){menu.addItem("align center","setAlignmentToCenter")}menu.addLine();if(this.fontStyle!=="serif"){menu.addItem("serif","setSerif")}if(this.fontStyle!=="sans-serif"){menu.addItem("sans-serif","setSansSerif")}if(this.isBold){menu.addItem("normal weight","toggleWeight")}else{menu.addItem("bold","toggleWeight")}if(this.isItalic){menu.addItem("normal style","toggleItalic")}else{menu.addItem("italic","toggleItalic")}return menu};TextMorph.prototype.setAlignmentToLeft=function(){this.alignment="left";this.rerender()};TextMorph.prototype.setAlignmentToRight=function(){this.alignment="right";this.rerender()};TextMorph.prototype.setAlignmentToCenter=function(){this.alignment="center";this.rerender()};TextMorph.prototype.toggleIsDraggable=StringMorph.prototype.toggleIsDraggable;TextMorph.prototype.toggleWeight=StringMorph.prototype.toggleWeight;TextMorph.prototype.toggleItalic=StringMorph.prototype.toggleItalic;TextMorph.prototype.setSerif=StringMorph.prototype.setSerif;TextMorph.prototype.setSansSerif=StringMorph.prototype.setSansSerif;TextMorph.prototype.setText=StringMorph.prototype.setText;TextMorph.prototype.setFontSize=StringMorph.prototype.setFontSize;TextMorph.prototype.numericalSetters=StringMorph.prototype.numericalSetters;TextMorph.prototype.evaluationMenu=function(){var menu=new MenuMorph(this,null);menu.addItem("do it","doIt","evaluate the\nselected expression");menu.addItem("show it","showIt","evaluate the\nselected expression\nand show the result");menu.addItem("inspect it","inspectIt","evaluate the\nselected expression\nand inspect the result");menu.addLine();menu.addItem("select all","selectAllAndEdit");return menu};TextMorph.prototype.setReceiver=function(obj){this.receiver=obj;this.customContextMenu=this.evaluationMenu()};TextMorph.prototype.doIt=function(){this.receiver.evaluateString(this.selection());this.edit()};TextMorph.prototype.showIt=function(){var result=this.receiver.evaluateString(this.selection());if(result!==null){this.inform(result)}};TextMorph.prototype.inspectIt=function(){var result=this.receiver.evaluateString(this.selection()),world=this.world(),inspector;if(isObject(result)){inspector=new InspectorMorph(result);inspector.setPosition(world.hand.position());inspector.keepWithin(world);world.add(inspector);inspector.changed()}};TriggerMorph.prototype=new Morph;TriggerMorph.prototype.constructor=TriggerMorph;TriggerMorph.uber=Morph.prototype;function TriggerMorph(target,action,labelString,fontSize,fontStyle,environment,hint,labelColor,labelBold,labelItalic,doubleClickAction){this.init(target,action,labelString,fontSize,fontStyle,environment,hint,labelColor,labelBold,labelItalic,doubleClickAction)}TriggerMorph.prototype.init=function(target,action,labelString,fontSize,fontStyle,environment,hint,labelColor,labelBold,labelItalic,doubleClickAction){this.target=target||null;this.action=action===0?0:action||null;this.doubleClickAction=doubleClickAction||null;this.environment=environment||null;this.labelString=labelString||" ";this.label=null;this.hint=hint||null;this.schedule=null;this.fontSize=fontSize||MorphicPreferences.menuFontSize;this.fontStyle=fontStyle||"sans-serif";this.highlightColor=new Color(192,192,192);this.pressColor=new Color(128,128,128);this.labelColor=labelColor||new Color(0,0,0);this.labelBold=labelBold||false;this.labelItalic=labelItalic||false;this.userState="normal";TriggerMorph.uber.init.call(this);this.color=WHITE;this.createLabel()};TriggerMorph.prototype.render=function(ctx){var colorBak=this.color;if(this.userState==="highlight"){this.color=this.highlightColor}else if(this.userState==="pressed"){this.color=this.pressColor}TriggerMorph.uber.render.call(this,ctx);this.color=colorBak};TriggerMorph.prototype.createLabel=function(){if(this.label!==null){this.label.destroy()}this.label=new StringMorph(this.labelString,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic,false,null,null,this.labelColor);this.fixLayout();this.add(this.label)};TriggerMorph.prototype.fixLayout=function(){this.label.setPosition(this.center().subtract(this.label.extent().floorDivideBy(2)))};TriggerMorph.prototype.trigger=function(){if(this.schedule){this.schedule.isActive=false}if(typeof this.target==="function"){if(typeof this.action==="function"){this.target.call(this.environment,this.action.call(),this)}else{this.target.call(this.environment,this.action,this)}}else{if(typeof this.action==="function"){this.action.call(this.target)}else{this.target[this.action]()}}};TriggerMorph.prototype.triggerDoubleClick=function(){if(!this.doubleClickAction){return}if(this.schedule){this.schedule.isActive=false}if(typeof this.target==="function"){if(typeof this.doubleClickAction==="function"){this.target.call(this.environment,this.doubleClickAction.call(),this)}else{this.target.call(this.environment,this.doubleClickAction,this)}}else{if(typeof this.doubleClickAction==="function"){this.doubleClickAction.call(this.target)}else{this.target[this.doubleClickAction]()}}};TriggerMorph.prototype.mouseEnter=function(){var contents=this.hint instanceof Function?this.hint():this.hint;this.userState="highlight";this.rerender();if(contents){this.bubbleHelp(contents)}};TriggerMorph.prototype.mouseLeave=function(){this.userState="normal";this.rerender();if(this.schedule){this.schedule.isActive=false}if(this.hint){this.world().hand.destroyTemporaries()}};TriggerMorph.prototype.mouseDownLeft=function(){this.userState="pressed";this.rerender()};TriggerMorph.prototype.mouseClickLeft=function(){this.userState="highlight";this.rerender();this.trigger()};TriggerMorph.prototype.mouseDoubleClick=function(){this.triggerDoubleClick()};TriggerMorph.prototype.rootForGrab=function(){return this.isDraggable?TriggerMorph.uber.rootForGrab.call(this):null};TriggerMorph.prototype.bubbleHelp=function(contents){var world=this.world();this.schedule=new Animation(nop,nop,0,500,nop,()=>this.popUpbubbleHelp(contents));world.animations.push(this.schedule)};TriggerMorph.prototype.popUpbubbleHelp=function(contents){new SpeechBubbleMorph(localize(contents),null,null,1).popUp(this.world(),this.rightCenter().add(new Point(-8,0)))};var MenuItemMorph;MenuItemMorph.prototype=new TriggerMorph;MenuItemMorph.prototype.constructor=MenuItemMorph;MenuItemMorph.uber=TriggerMorph.prototype;function MenuItemMorph(target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction,shortcut){this.shortcutString=shortcut||null;this.shortcut=null;this.init(target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction)}MenuItemMorph.prototype.createLabel=function(){var w,h;if(this.label){this.label.destroy()}this.label=this.createLabelPart(this.labelString);this.add(this.label);w=this.label.width();h=this.label.height();if(this.shortcut){this.shortcut.destroy()}if(this.shortcutString){this.shortcut=this.createLabelPart(this.shortcutString);w+=this.shortcut.width()+4;h=Math.max(h,this.shortcut.height());this.add(this.shortcut)}this.setExtent(new Point(w+8,h))};MenuItemMorph.prototype.fixLayout=function(){var cntr=this.center();this.label.setCenter(cntr);this.label.setLeft(this.left()+4);if(this.shortcut){this.shortcut.setCenter(cntr);this.shortcut.setRight(this.right()-4)}};MenuItemMorph.prototype.createLabelPart=function(source){var part,icon,lbl;if(isString(source)){return this.createLabelString(source)}if(source instanceof Array){part=new Morph;part.alpha=0;icon=this.createIcon(source[0]);part.add(icon);lbl=this.createLabelString(source[1]);part.add(lbl);lbl.setCenter(icon.center());lbl.setLeft(icon.right()+4);part.bounds=icon.bounds.merge(lbl.bounds);part.rerender();return part}return this.createIcon(source)};MenuItemMorph.prototype.createIcon=function(source){var icon;if(source instanceof Morph){return source.fullCopy()}icon=new Morph;icon.isCachingImage=true;icon.cachedImage=source;icon.bounds.setWidth(source.width);icon.bounds.setHeight(source.height);return icon};MenuItemMorph.prototype.createLabelString=function(string){var lbl=new TextMorph(string,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic);lbl.setColor(this.labelColor);return lbl};MenuItemMorph.prototype.mouseEnter=function(){var menu=this.parentThatIsA(MenuMorph);if(this.isShowingSubmenu()){return}if(menu){menu.closeSubmenu()}if(!this.isListItem()){this.userState="highlight";this.rerender()}if(this.action instanceof MenuMorph){this.delaySubmenu()}else if(this.hint){this.bubbleHelp(this.hint)}};MenuItemMorph.prototype.mouseLeave=function(){if(!this.isListItem()){if(this.isShowingSubmenu()){this.userState="highlight"}else{this.userState="normal"}this.rerender()}if(this.schedule){this.schedule.isActive=false}if(this.hint){this.world().hand.destroyTemporaries()}};MenuItemMorph.prototype.mouseDownLeft=function(pos){if(this.isListItem()){this.parentThatIsA(MenuMorph).unselectAllItems();this.escalateEvent("mouseDownLeft",pos)}this.userState="pressed";this.rerender()};MenuItemMorph.prototype.mouseMove=function(){if(this.isListItem()){this.escalateEvent("mouseMove")}};MenuItemMorph.prototype.mouseClickLeft=function(){if(this.action instanceof MenuMorph){this.popUpSubmenu()}else{if(!this.isListItem()){this.parentThatIsA(MenuMorph).closeRootMenu();this.world().activeMenu=null}this.trigger()}};MenuItemMorph.prototype.isListItem=function(){var menu=this.parentThatIsA(MenuMorph);if(menu){return menu.isListContents}return false};MenuItemMorph.prototype.isSelectedListItem=function(){if(this.isListItem()){return this.userState==="pressed"}return false};MenuItemMorph.prototype.isShowingSubmenu=function(){var menu=this.parentThatIsA(MenuMorph);if(menu&&this.action instanceof MenuMorph){return menu.submenu===this.action}return false};MenuItemMorph.prototype.delaySubmenu=function(){var world=this.world();this.schedule=new Animation(nop,nop,0,500,nop,()=>this.popUpSubmenu());world.animations.push(this.schedule)};MenuItemMorph.prototype.popUpSubmenu=function(){var menu=this.parentThatIsA(MenuMorph),world=this.world(),scroller;if(!(this.action instanceof MenuMorph)){return}this.action.createItems();this.action.setPosition(this.topRight().subtract(new Point(0,5)));this.action.addShadow(new Point(2,2),80);this.action.keepWithin(this.world());if(this.action.items.length<1&&!this.action.title){return}if(this.action.bottom()>world.bottom()){this.action.removeShadow();scroller=this.action.scroll();this.action.bounds.corner.y=world.bottom()-2;this.action.addShadow(new Point(2,2),80);scroller.setHeight(world.bottom()-scroller.top()-6);scroller.adjustScrollBars()}menu.add(this.action);menu.submenu=this.action;menu.submenu.world=menu.world;this.action.fullChanged()};FrameMorph.prototype=new Morph;FrameMorph.prototype.constructor=FrameMorph;FrameMorph.uber=Morph.prototype;function FrameMorph(aScrollFrame){this.init(aScrollFrame)}FrameMorph.prototype.init=function(aScrollFrame){this.scrollFrame=aScrollFrame||null;FrameMorph.uber.init.call(this);this.color=new Color(255,250,245);this.acceptsDrops=true;if(this.scrollFrame){this.isDraggable=false;this.alpha=0}};FrameMorph.prototype.fullBounds=function(){var shadow=this.getShadow();if(shadow!==null){return this.bounds.merge(shadow.bounds)}return this.bounds};FrameMorph.prototype.fullImage=function(){return this.getImage()};FrameMorph.prototype.fullDrawOn=function(ctx,aRect){var shadow,clipped;if(!this.isVisible){return}clipped=this.bounds.intersect(aRect);if(!clipped.extent().gt(ZERO)){return}this.drawOn(ctx,clipped);this.children.forEach(child=>{if(child instanceof ShadowMorph){shadow=child}else{child.fullDrawOn(ctx,clipped)}});if(shadow){shadow.drawOn(ctx,aRect)}};FrameMorph.prototype.topMorphAt=function(point){var i,result;if(!(this.isVisible&&this.bounds.containsPoint(point))){return null}for(i=this.children.length-1;i>=0;i-=1){result=this.children[i].topMorphAt(point);if(result){return result}}if(this.isFreeForm){return this.isTransparentAt(point)?null:this}return this};FrameMorph.prototype.submorphBounds=function(){var result=null;if(this.children.length>0){result=this.children[0].bounds;this.children.forEach(child=>{result=result.merge(child.fullBounds())})}return result};FrameMorph.prototype.keepInScrollFrame=function(){if(this.scrollFrame===null){return null}if(this.left()>this.scrollFrame.left()){this.moveBy(new Point(this.scrollFrame.left()-this.left(),0))}if(this.right()<this.scrollFrame.right()){this.moveBy(new Point(this.scrollFrame.right()-this.right(),0))}if(this.top()>this.scrollFrame.top()){this.moveBy(new Point(0,this.scrollFrame.top()-this.top()))}if(this.bottom()<this.scrollFrame.bottom()){this.moveBy(0,new Point(this.scrollFrame.bottom()-this.bottom(),0))}};FrameMorph.prototype.adjustBounds=function(){var subBounds,newBounds;if(this.scrollFrame===null){return}subBounds=this.submorphBounds();if(subBounds&&!this.scrollFrame.isTextLineWrapping){newBounds=subBounds.expandBy(this.scrollFrame.padding).growBy(this.scrollFrame.growth).merge(this.scrollFrame.bounds)}else{newBounds=this.scrollFrame.bounds.copy()}if(!this.bounds.eq(newBounds)){this.bounds=newBounds;this.keepInScrollFrame()}if(this.scrollFrame.isTextLineWrapping){this.children.forEach(morph=>{if(morph instanceof TextMorph){morph.setWidth(this.width());this.setHeight(Math.max(morph.height(),this.scrollFrame.height()))}})}this.scrollFrame.adjustScrollBars()};FrameMorph.prototype.reactToDropOf=function(){this.adjustBounds()};FrameMorph.prototype.reactToGrabOf=function(){this.adjustBounds()};FrameMorph.prototype.developersMenu=function(){var menu=FrameMorph.uber.developersMenu.call(this);if(this.children.length>0){menu.addLine();menu.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible")}return menu};FrameMorph.prototype.keepAllSubmorphsWithin=function(){this.children.forEach(m=>m.keepWithin(this))};ScrollFrameMorph.prototype=new FrameMorph;ScrollFrameMorph.prototype.constructor=ScrollFrameMorph;ScrollFrameMorph.uber=FrameMorph.prototype;function ScrollFrameMorph(scroller,size,sliderColor){this.init(scroller,size,sliderColor)}ScrollFrameMorph.prototype.init=function(scroller,size,sliderColor){ScrollFrameMorph.uber.init.call(this);this.scrollBarSize=size||MorphicPreferences.scrollBarSize;this.autoScrollTrigger=null;this.enableAutoScrolling=true;this.isScrollingByDragging=true;this.hasVelocity=true;this.padding=0;this.growth=0;this.isTextLineWrapping=false;this.contents=scroller||new FrameMorph(this);this.add(this.contents);this.hBar=new SliderMorph(null,null,null,null,"horizontal",sliderColor);this.hBar.setHeight(this.scrollBarSize);this.hBar.action=num=>{this.contents.setPosition(new Point(this.left()-num,this.contents.position().y))};this.hBar.isDraggable=false;this.add(this.hBar);this.vBar=new SliderMorph(null,null,null,null,"vertical",sliderColor);this.vBar.setWidth(this.scrollBarSize);this.vBar.action=num=>{this.contents.setPosition(new Point(this.contents.position().x,this.top()-num))};this.vBar.isDraggable=false;this.add(this.vBar);this.toolBar=null};ScrollFrameMorph.prototype.adjustScrollBars=function(){var hWidth=this.width()-this.scrollBarSize,vHeight=this.height()-this.scrollBarSize;this.changed();if(this.contents.width()>this.width()){this.hBar.show();if(this.hBar.width()!==hWidth){this.hBar.setWidth(hWidth)}this.hBar.setPosition(new Point(this.left(),this.bottom()-this.hBar.height()));this.hBar.start=0;this.hBar.stop=this.contents.width()-this.width()+this.scrollBarSize;this.hBar.size=this.width()/this.contents.width()*this.hBar.stop;this.hBar.value=this.left()-this.contents.left();this.hBar.fixLayout()}else{this.hBar.hide()}if(this.contents.height()>this.height()){this.vBar.show();if(this.vBar.height()!==vHeight){this.vBar.setHeight(vHeight)}this.vBar.setPosition(new Point(this.right()-this.vBar.width(),this.top()));this.vBar.start=0;this.vBar.stop=this.contents.height()-this.height()+this.scrollBarSize;this.vBar.size=this.height()/this.contents.height()*this.vBar.stop;this.vBar.value=this.top()-this.contents.top();this.vBar.fixLayout()}else{this.vBar.hide()}this.adjustToolBar()};ScrollFrameMorph.prototype.adjustToolBar=function(){var padding=3;if(this.toolBar){this.toolBar.setTop(this.top()+padding);this.toolBar.setRight((this.vBar.isVisible?this.vBar.left():this.right())-padding)}};ScrollFrameMorph.prototype.addContents=function(aMorph){this.contents.add(aMorph);this.contents.adjustBounds()};ScrollFrameMorph.prototype.setContents=function(aMorph){this.contents.children.forEach(m=>m.destroy());this.contents.children=[];aMorph.setPosition(this.position().add(this.padding+2));this.addContents(aMorph)};ScrollFrameMorph.prototype.setExtent=function(aPoint){if(this.isTextLineWrapping){this.contents.setPosition(this.position().copy())}ScrollFrameMorph.uber.setExtent.call(this,aPoint);this.contents.adjustBounds()};ScrollFrameMorph.prototype.scrollX=function(steps){var cl=this.contents.left(),l=this.left(),cw=this.contents.width(),r=this.right(),newX;if(this.vBar.isVisible){r-=this.scrollBarSize}newX=cl+steps;if(newX+cw<r){newX=r-cw}if(newX>l){newX=l}if(newX!==cl){this.contents.setLeft(newX)}};ScrollFrameMorph.prototype.scrollY=function(steps){var ct=this.contents.top(),t=this.top(),ch=this.contents.height(),b=this.bottom(),newY;if(this.hBar.isVisible){b-=this.scrollBarSize}newY=ct+steps;if(newY+ch<b){newY=b-ch}if(newY>t){newY=t}if(newY!==ct){this.contents.setTop(newY)}};ScrollFrameMorph.prototype.step=nop;ScrollFrameMorph.prototype.mouseDownLeft=function(pos){if(!this.isScrollingByDragging){return null}var world=this.root(),hand=world.hand,oldPos=pos,deltaX=0,deltaY=0,friction=.8;this.step=()=>{var newPos;if(hand.mouseButton&&hand.children.length===0&&this.bounds.containsPoint(hand.bounds.origin)){if(hand.grabPosition&&hand.grabPosition.distanceTo(hand.position())<=MorphicPreferences.grabThreshold){return null}newPos=hand.bounds.origin;deltaX=newPos.x-oldPos.x;if(deltaX!==0){this.scrollX(deltaX)}deltaY=newPos.y-oldPos.y;if(deltaY!==0){this.scrollY(deltaY)}oldPos=newPos}else{if(!this.hasVelocity){this.step=nop}else{if(Math.abs(deltaX)<.5&&Math.abs(deltaY)<.5){this.step=nop}else{deltaX=deltaX*friction;this.scrollX(Math.round(deltaX));deltaY=deltaY*friction;this.scrollY(Math.round(deltaY))}}}this.adjustScrollBars()}};ScrollFrameMorph.prototype.startAutoScrolling=function(){var inset=MorphicPreferences.scrollBarSize*3,world=this.world(),hand,inner,pos;if(!world){return null}hand=world.hand;if(!this.autoScrollTrigger){this.autoScrollTrigger=Date.now()}this.step=()=>{pos=hand.bounds.origin;inner=this.bounds.insetBy(inset);if(this.bounds.containsPoint(pos)&&!inner.containsPoint(pos)&&hand.children.length>0){this.autoScroll(pos)}else{this.step=nop;this.autoScrollTrigger=null}}};ScrollFrameMorph.prototype.autoScroll=function(pos){var inset,area;if(Date.now()-this.autoScrollTrigger<500){return null}inset=MorphicPreferences.scrollBarSize*3;area=this.topLeft().extent(new Point(this.width(),inset));if(area.containsPoint(pos)){this.scrollY(inset-(pos.y-this.top()))}area=this.topLeft().extent(new Point(inset,this.height()));if(area.containsPoint(pos)){this.scrollX(inset-(pos.x-this.left()))}area=new Point(this.right()-inset,this.top()).extent(new Point(inset,this.height()));if(area.containsPoint(pos)){this.scrollX(-(inset-(this.right()-pos.x)))}area=new Point(this.left(),this.bottom()-inset).extent(new Point(this.width(),inset));if(area.containsPoint(pos)){this.scrollY(-(inset-(this.bottom()-pos.y)))}this.adjustScrollBars()};ScrollFrameMorph.prototype.scrollCursorIntoView=function(morph){var txt=morph.target,offset=txt.position().subtract(this.contents.position()),ft=this.top()+this.padding,fb=this.bottom()-this.padding;this.contents.setExtent(txt.extent().add(offset).add(this.padding));if(morph.top()<ft){this.contents.setTop(this.contents.top()+ft-morph.top());morph.setTop(ft)}else if(morph.bottom()>fb){this.contents.setBottom(this.contents.bottom()+fb-morph.bottom());morph.setBottom(fb)}this.adjustScrollBars()};ScrollFrameMorph.prototype.mouseScroll=function(y,x){if(y){this.scrollY(y*MorphicPreferences.mouseScrollAmount)}if(x){this.scrollX(x*MorphicPreferences.mouseScrollAmount)}this.adjustScrollBars()};ScrollFrameMorph.prototype.updateReferences=function(map){ScrollFrameMorph.uber.updateReferences.call(this,map);if(this.hBar){this.hBar.action=num=>{this.contents.setPosition(new Point(this.left()-num,this.contents.position().y))}}if(this.vBar){this.vBar.action=num=>{this.contents.setPosition(new Point(this.contents.position().x,this.top()-num))}}};ScrollFrameMorph.prototype.developersMenu=function(){var menu=ScrollFrameMorph.uber.developersMenu.call(this);if(this.isTextLineWrapping){menu.addItem("auto line wrap off...","toggleTextLineWrapping","turn automatic\nline wrapping\noff")}else{menu.addItem("auto line wrap on...","toggleTextLineWrapping","enable automatic\nline wrapping")}return menu};ScrollFrameMorph.prototype.toggleTextLineWrapping=function(){this.isTextLineWrapping=!this.isTextLineWrapping};ListMorph.prototype=new ScrollFrameMorph;ListMorph.prototype.constructor=ListMorph;ListMorph.uber=ScrollFrameMorph.prototype;function ListMorph(elements,labelGetter,format,onDoubleClick,separator,verbatim){this.init(elements||[],labelGetter||function(element){if(isString(element)){return element}if(element.toSource){return element.toSource()}return element.toString()},format||[],onDoubleClick,separator,verbatim)}ListMorph.prototype.init=function(elements,labelGetter,format,onDoubleClick,separator,verbatim){ListMorph.uber.init.call(this);this.contents.acceptsDrops=false;this.color=WHITE;this.hBar.alpha=.6;this.vBar.alpha=.6;this.elements=elements||[];this.labelGetter=labelGetter;this.format=format;this.listContents=null;this.selected=null;this.active=null;this.action=null;this.doubleClickAction=onDoubleClick||null;this.separator=separator||"";this.verbatim=isNil(verbatim)?true:verbatim;this.acceptsDrops=false;this.buildListContents()};ListMorph.prototype.buildListContents=function(){if(this.listContents){this.listContents.destroy()}this.listContents=new MenuMorph(this.select,null,this);if(this.elements.length===0){this.elements=["(empty)"]}this.elements.forEach(element=>{var color=null,bold=false,italic=false,label;this.format.forEach(pair=>{if(pair[1].call(null,element)){if(pair[0]==="bold"){bold=true}else if(pair[0]==="italic"){italic=true}else{color=pair[0]}}});label=this.labelGetter(element);if(label===this.separator){this.listContents.addLine()}else{this.listContents.addItem(label,element,null,color,bold,italic,this.doubleClickAction,null,this.verbatim)}});this.listContents.isListContents=true;this.listContents.createItems();this.listContents.setPosition(this.contents.position());this.addContents(this.listContents)};ListMorph.prototype.select=function(item,trigger){if(isNil(item)){return}this.selected=item;this.active=trigger;if(this.action){this.action.call(null,item)}};ListMorph.prototype.setExtent=function(aPoint){var lb=this.listContents.bounds,nb=this.bounds.origin.copy().corner(this.bounds.origin.add(aPoint));if(nb.right()>lb.right()&&nb.width()<=lb.width()){this.listContents.setRight(nb.right())}if(nb.bottom()>lb.bottom()&&nb.height()<=lb.height()){this.listContents.setBottom(nb.bottom())}ListMorph.uber.setExtent.call(this,aPoint)};ListMorph.prototype.activeIndex=function(){return this.listContents.children.indexOf(this.active)};ListMorph.prototype.activateIndex=function(idx){var item=this.listContents.children[idx];if(!item){return}item.userState="pressed";item.rerender();item.trigger()};StringFieldMorph.prototype=new FrameMorph;StringFieldMorph.prototype.constructor=StringFieldMorph;StringFieldMorph.uber=FrameMorph.prototype;function StringFieldMorph(defaultContents,minWidth,fontSize,fontStyle,bold,italic,isNumeric){this.init(defaultContents||"",minWidth||100,fontSize||12,fontStyle||"sans-serif",bold||false,italic||false,isNumeric)}StringFieldMorph.prototype.init=function(defaultContents,minWidth,fontSize,fontStyle,bold,italic,isNumeric){this.defaultContents=defaultContents;this.minWidth=minWidth;this.fontSize=fontSize;this.fontStyle=fontStyle;this.isBold=bold;this.isItalic=italic;this.isNumeric=isNumeric||false;this.text=null;StringFieldMorph.uber.init.call(this);this.color=WHITE;this.isEditable=true;this.acceptsDrops=false;this.createText()};StringFieldMorph.prototype.createText=function(){var txt;txt=this.text?this.string():this.defaultContents;this.text=null;this.children.forEach(child=>child.destroy());this.children=[];this.text=new StringMorph(txt,this.fontSize,this.fontStyle,this.isBold,this.isItalic,this.isNumeric);this.text.isNumeric=this.isNumeric;this.text.setPosition(this.bounds.origin.copy());this.text.isEditable=this.isEditable;this.text.isDraggable=false;this.text.enableSelecting();this.setExtent(new Point(Math.max(this.width(),this.minWidth),this.text.height()));this.add(this.text)};StringFieldMorph.prototype.string=function(){return this.text.text};StringFieldMorph.prototype.mouseClickLeft=function(pos){if(this.isEditable){this.text.edit()}else{this.escalateEvent("mouseClickLeft",pos)}};var BouncerMorph;BouncerMorph.prototype=new Morph;BouncerMorph.prototype.constructor=BouncerMorph;BouncerMorph.uber=Morph.prototype;function BouncerMorph(){this.init()}BouncerMorph.prototype.init=function(type,speed){BouncerMorph.uber.init.call(this);this.fps=50;this.isStopped=false;this.type=type||"vertical";if(this.type==="vertical"){this.direction="down"}else{this.direction="right"}this.speed=speed||1};BouncerMorph.prototype.moveUp=function(){this.moveBy(new Point(0,-this.speed))};BouncerMorph.prototype.moveDown=function(){this.moveBy(new Point(0,this.speed))};BouncerMorph.prototype.moveRight=function(){this.moveBy(new Point(this.speed,0))};BouncerMorph.prototype.moveLeft=function(){this.moveBy(new Point(-this.speed,0))};BouncerMorph.prototype.step=function(){if(!this.isStopped){if(this.type==="vertical"){if(this.direction==="down"){this.moveDown()}else{this.moveUp()}if(this.fullBounds().top()<this.parent.top()&&this.direction==="up"){this.direction="down"}if(this.fullBounds().bottom()>this.parent.bottom()&&this.direction==="down"){this.direction="up"}}else if(this.type==="horizontal"){if(this.direction==="right"){this.moveRight()}else{this.moveLeft()}if(this.fullBounds().left()<this.parent.left()&&this.direction==="left"){this.direction="right"}if(this.fullBounds().right()>this.parent.right()&&this.direction==="right"){this.direction="left"}}}};HandMorph.prototype=new Morph;HandMorph.prototype.constructor=HandMorph;HandMorph.uber=Morph.prototype;function HandMorph(aWorld){this.init(aWorld)}HandMorph.prototype.init=function(aWorld){HandMorph.uber.init.call(this,true);this.bounds=new Rectangle;this.world=aWorld;this.mouseButton=null;this.mouseOverList=[];this.mouseOverBounds=[];this.morphToGrab=null;this.grabPosition=null;this.grabOrigin=null;this.temporaries=[];this.touchHoldTimeout=null;this.contextMenuEnabled=false;this.cachedFullImage=null;this.cachedFullBounds=null};HandMorph.prototype.changed=function(){var b;if(this.world!==null){b=this.cachedFullBounds||this.fullBounds();if(!b.extent().eq(ZERO)){this.world.broken.push(b.spread())}}};HandMorph.prototype.moveBy=function(delta){var children=this.children,i=children.length;this.changed();this.bounds=this.bounds.translateBy(delta);if(this.cachedFullBounds){this.cachedFullBounds=this.cachedFullBounds.translateBy(delta)}this.changed();for(i;i>0;i-=1){children[i-1].moveBy(delta)}};HandMorph.prototype.fullChanged=HandMorph.prototype.changed;HandMorph.prototype.fullDrawOn=function(ctx,rect){if(!this.cachedFullBounds){HandMorph.uber.fullDrawOn.call(this,ctx,rect);return}var clipped=rect.intersect(this.cachedFullBounds),pos=this.cachedFullBounds.origin,pic,src,w,h,sl,st;if(!clipped.extent().gt(ZERO)){return}ctx.save();ctx.globalAlpha=this.alpha;pic=this.cachedFullImage;src=clipped.translateBy(pos.neg());sl=src.left();st=src.top();w=Math.min(src.width(),pic.width-sl);h=Math.min(src.height(),pic.height-st);if(w<1||h<1){return}ctx.drawImage(pic,sl,st,w,h,clipped.left(),clipped.top(),w,h);ctx.restore()};HandMorph.prototype.morphAtPointer=function(){return this.world.topMorphAt(this.bounds.origin)||this.world};HandMorph.prototype.allMorphsAtPointer=function(){return this.world.allChildren().filter(m=>m.isVisible&&m.visibleBounds().containsPoint(this.bounds.origin)&&!m.holes.some(any=>any.translateBy(m.position()).containsPoint(this.bounds.origin)))};HandMorph.prototype.dropTargetFor=function(aMorph){var target=this.morphAtPointer();while(!target.wantsDropOf(aMorph)){target=target.parent}return target};HandMorph.prototype.grab=function(aMorph){var oldParent;if(!aMorph){return null}oldParent=aMorph.parent;if(aMorph instanceof WorldMorph){return null}if(this.children.length===0){this.world.stopEditing();this.grabOrigin=aMorph.situation();if(aMorph.prepareToBeGrabbed){aMorph.prepareToBeGrabbed(this)}if(!aMorph.noDropShadow){aMorph.addShadow()}this.add(aMorph);this.cachedFullImage=aMorph.fullImage();this.cachedFullBounds=aMorph.fullBounds();this.changed();if(oldParent&&oldParent.reactToGrabOf){oldParent.reactToGrabOf(aMorph)}}};HandMorph.prototype.drop=function(){var target,morphToDrop;this.alpha=1;if(this.children.length!==0){morphToDrop=this.children[0];target=this.dropTargetFor(morphToDrop);target=target.selectForEdit?target.selectForEdit():target;this.changed();target.add(morphToDrop);morphToDrop.changed();this.cachedFullImage=null;this.cachedFullBounds=null;if(!morphToDrop.noDropShadow){morphToDrop.removeShadow()}this.children=[];this.setExtent(new Point);if(morphToDrop.justDropped){morphToDrop.justDropped(this)}if(target.reactToDropOf){target.reactToDropOf(morphToDrop,this)}}};HandMorph.prototype.processMouseDown=function(event){var morph,actualClick,posInDocument=getDocumentPositionOf(this.world.worldCanvas);if(event.pageX){this.setPosition(new Point(event.pageX-posInDocument.x,event.pageY-posInDocument.y))}this.destroyTemporaries();this.contextMenuEnabled=true;this.morphToGrab=null;this.grabPosition=null;if(this.children.length!==0){this.drop();this.mouseButton=null}else{morph=this.morphAtPointer();if(this.world.activeMenu){if(!contains(morph.allParents(),this.world.activeMenu)){this.world.activeMenu.destroy()}else{clearInterval(this.touchHoldTimeout)}}if(this.world.activeHandle){if(morph!==this.world.activeHandle){this.world.activeHandle.destroy()}}if(this.world.cursor){if(morph!==this.world.cursor.target){this.world.stopEditing()}}if(!morph.mouseMove){this.morphToGrab=morph.rootForGrab();this.grabPosition=this.bounds.origin.copy()}if(event.button===2||event.ctrlKey){this.mouseButton="right";actualClick="mouseDownRight"}else{this.mouseButton="left";actualClick="mouseDownLeft"}while(!morph[actualClick]){morph=morph.parent}morph[actualClick](this.bounds.origin)}};HandMorph.prototype.processTouchStart=function(event){MorphicPreferences.isTouchDevice=true;clearInterval(this.touchHoldTimeout);if(event.touches.length===1){this.touchHoldTimeout=setInterval(()=>{this.processMouseDown({button:2});this.processMouseUp({button:2});event.preventDefault();clearInterval(this.touchHoldTimeout)},400);this.processMouseMove(event.touches[0]);this.processMouseDown({button:0});event.preventDefault()}};HandMorph.prototype.processTouchMove=function(event){MorphicPreferences.isTouchDevice=true;if(event.touches.length===1){var touch=event.touches[0];this.processMouseMove(touch);clearInterval(this.touchHoldTimeout)}};HandMorph.prototype.processTouchEnd=function(event){MorphicPreferences.isTouchDevice=true;clearInterval(this.touchHoldTimeout);nop(event);this.processMouseUp({button:0})};HandMorph.prototype.processMouseUp=function(){var morph=this.morphAtPointer(),context,contextMenu,expectedClick;this.destroyTemporaries();if(this.children.length!==0){this.drop()}else{if(this.mouseButton==="left"){expectedClick="mouseClickLeft"}else{expectedClick="mouseClickRight";if(this.mouseButton&&this.contextMenuEnabled){context=morph;contextMenu=context.contextMenu();while(!contextMenu&&context.parent){context=context.parent;contextMenu=context.contextMenu()}if(contextMenu){contextMenu.popUpAtHand(this.world)}}}while(!morph[expectedClick]){morph=morph.parent}morph[expectedClick](this.bounds.origin)}this.mouseButton=null};HandMorph.prototype.processDoubleClick=function(){var morph=this.morphAtPointer();this.destroyTemporaries();if(this.children.length!==0){this.drop()}else{while(morph&&!morph.mouseDoubleClick){morph=morph.parent}if(morph){morph.mouseDoubleClick(this.bounds.origin)}}this.mouseButton=null};HandMorph.prototype.processMouseMove=function(event){var pos,posInDocument=getDocumentPositionOf(this.world.worldCanvas),mouseOverNew,mouseOverBoundsNew,morph,topMorph;pos=new Point(event.pageX-posInDocument.x,event.pageY-posInDocument.y);this.setPosition(pos);mouseOverNew=this.morphAtPointer().allParents();mouseOverBoundsNew=mouseOverNew.filter(m=>m.isVisible&&m.visibleBounds().containsPoint(this.bounds.origin)&&!m.holes.some(any=>any.translateBy(m.position()).containsPoint(this.bounds.origin)));if(!this.children.length&&this.mouseButton){topMorph=this.morphAtPointer();morph=topMorph.rootForGrab();if(topMorph.mouseMove){topMorph.mouseMove(pos,this.mouseButton);if(this.mouseButton==="right"){this.contextMenuEnabled=false}}if(this.mouseButton==="left"&&this.morphToGrab&&this.grabPosition.distanceTo(this.bounds.origin)>MorphicPreferences.grabThreshold){this.setPosition(this.grabPosition);if(this.morphToGrab.isDraggable){morph=this.morphToGrab.selectForEdit?this.morphToGrab.selectForEdit():this.morphToGrab;this.grab(morph)}else if(this.morphToGrab.isTemplate){this.world.stopEditing();morph=this.morphToGrab.fullCopy();morph.isTemplate=false;morph.isDraggable=true;if(morph.reactToTemplateCopy){morph.reactToTemplateCopy()}this.grab(morph);this.grabOrigin=this.morphToGrab.situation()}this.setPosition(pos)}}this.mouseOverBounds.forEach(old=>{if(!contains(mouseOverBoundsNew,old)){if(old.mouseLeaveBounds){old.mouseLeaveBounds(this.children[0])}}});mouseOverBoundsNew.forEach(newMorph=>{if(!contains(this.mouseOverBounds,newMorph)){if(newMorph.mouseEnterBounds){newMorph.mouseEnterBounds(this.children[0])}}});this.mouseOverList.forEach(old=>{if(!contains(mouseOverNew,old)){if(old.mouseLeave){old.mouseLeave()}if(old.mouseLeaveDragging&&this.mouseButton){old.mouseLeaveDragging(this.children[0])}}});mouseOverNew.forEach(newMorph=>{if(!contains(this.mouseOverList,newMorph)){if(newMorph.mouseEnter){newMorph.mouseEnter()}if(newMorph.mouseEnterDragging&&this.mouseButton){newMorph.mouseEnterDragging(this.children[0])}}if(this.children.length>0){if(newMorph instanceof ScrollFrameMorph&&newMorph.enableAutoScrolling&&newMorph.contents.allChildren().some(any=>{return any.wantsDropOf(this.children[0])})){if(!newMorph.bounds.insetBy(MorphicPreferences.scrollBarSize*3).containsPoint(this.bounds.origin)){newMorph.startAutoScrolling()}}}});this.mouseOverList=mouseOverNew;this.mouseOverBounds=mouseOverBoundsNew};HandMorph.prototype.processMouseScroll=function(event){var morph=this.morphAtPointer();while(morph&&!morph.mouseScroll){morph=morph.parent}if(morph){morph.mouseScroll(event.detail/-3||(Object.prototype.hasOwnProperty.call(event,"wheelDeltaY")?event.wheelDeltaY/120:event.wheelDelta/120),event.wheelDeltaX/120||0)}};HandMorph.prototype.processDrop=function(event){var files=event instanceof FileList?event:event.target.files||event.dataTransfer.files,file,fileCount,url=event.dataTransfer?event.dataTransfer.getData("URL"):null,txt=event.dataTransfer?event.dataTransfer.getData("Text/HTML"):null,suffix,src,target=this.morphAtPointer(),img=new Image,canvas,i;function readSVG(aFile){var pic=new Image,frd=new FileReader,trg=target;while(!trg.droppedSVG){trg=trg.parent}pic.onload=()=>{trg.droppedSVG(pic,aFile.name);bulkDrop()};frd=new FileReader;frd.onloadend=e=>pic.src=e.target.result;frd.readAsDataURL(aFile)}function readImage(aFile){var pic=new Image,frd=new FileReader,trg=target,embedTag=MorphicPreferences.pngPayloadMarker;while(!trg.droppedImage){trg=trg.parent}pic.onload=()=>{(async()=>{var buff=new Uint8Array(await aFile?.arrayBuffer()),strBuff=buff.reduce((acc,b)=>acc+String.fromCharCode(b),""),embedded;if(strBuff.includes(embedTag)){try{embedded=decodeURIComponent(strBuff?.split(embedTag)[1])}catch(err){console.log(err)}}canvas=newCanvas(new Point(pic.width,pic.height),true);canvas.getContext("2d").drawImage(pic,0,0);trg.droppedImage(canvas,aFile.name,embedded);bulkDrop()})()};frd=new FileReader;frd.onloadend=e=>pic.src=e.target.result;frd.readAsDataURL(aFile)}function readAudio(aFile){var snd=new Audio,frd=new FileReader,trg=target;while(!trg.droppedAudio){trg=trg.parent}frd.onloadend=e=>{snd.src=e.target.result;trg.droppedAudio(snd,aFile.name);bulkDrop()};frd.readAsDataURL(aFile)}function readText(aFile){var frd=new FileReader,trg=target;while(!trg.droppedText){trg=trg.parent}frd.onloadend=e=>{trg.droppedText(e.target.result,aFile.name,aFile.type);bulkDrop()};frd.readAsText(aFile)}function readBinary(aFile){var frd=new FileReader,trg=target;while(!trg.droppedBinary){trg=trg.parent}frd.onloadend=e=>{trg.droppedBinary(e.target.result,aFile.name);bulkDrop()};frd.readAsArrayBuffer(aFile)}function beginBulkDrop(){var trg=target;while(!trg.beginBulkDrop){trg=trg.parent}trg.beginBulkDrop()}function bulkDrop(){var trg=target;fileCount-=1;if(files.length>1&&fileCount===0){while(!trg.endBulkDrop){trg=trg.parent}trg.endBulkDrop()}}function readURL(url,callback){var request=new XMLHttpRequest;request.open("GET",url);request.onreadystatechange=()=>{if(request.readyState===4){if(request.responseText){callback(request.responseText)}else{throw new Error("unable to retrieve "+url)}}};request.send()}function parseImgURL(html){var iurl="",idx,c,start=html.indexOf('<img src="');if(start===-1){return null}start+=10;for(idx=start;idx<html.length;idx+=1){c=html[idx];if(c==='"'){return iurl}iurl=iurl.concat(c)}return null}if(files.length>0){fileCount=files.length;if(fileCount>1){beginBulkDrop()}for(i=0;i<files.length;i+=1){file=files[i];suffix=file.name.slice(file.name.lastIndexOf(".")+1).toLowerCase();if(file.type.indexOf("svg")!==-1&&!MorphicPreferences.rasterizeSVGs){readSVG(file)}else if(file.type.indexOf("image")===0){readImage(file)}else if(file.type.indexOf("audio")===0||file.type.indexOf("ogg")>-1){readAudio(file)}else if(file.type.indexOf("text")===0||contains(["txt","csv","json"],suffix)){readText(file)}else{readBinary(file)}}}else if(url){suffix=url.slice(url.lastIndexOf(".")+1).toLowerCase();if(contains(["gif","png","jpg","jpeg","bmp"],suffix)){while(!target.droppedImage){target=target.parent}img=new Image;img.onload=()=>{canvas=newCanvas(new Point(img.width,img.height),true);canvas.getContext("2d").drawImage(img,0,0);target.droppedImage(canvas)};img.src=url}else if(suffix==="svg"&&!MorphicPreferences.rasterizeSVGs){while(!target.droppedSVG){target=target.parent}readURL(url,txt=>{var pic=new Image;pic.onload=()=>{target.droppedSVG(pic,url.slice(url.lastIndexOf("/")+1,url.lastIndexOf(".")))};pic.src="data:image/svg+xml;utf8,"+encodeURIComponent(txt)})}}else if(txt){while(!target.droppedImage){target=target.parent}img=new Image;img.onload=()=>{canvas=newCanvas(new Point(img.width,img.height),true);canvas.getContext("2d").drawImage(img,0,0);target.droppedImage(canvas)};src=parseImgURL(txt);if(src){img.src=src}}};HandMorph.prototype.destroyTemporaries=function(){this.temporaries.forEach(morph=>{if(!(morph.isClickable&&morph.bounds.containsPoint(this.position()))){morph.destroy();this.temporaries.splice(this.temporaries.indexOf(morph),1)}})};WorldMorph.prototype=new FrameMorph;WorldMorph.prototype.constructor=WorldMorph;WorldMorph.uber=FrameMorph.prototype;WorldMorph.prototype.customMorphs=[];function WorldMorph(aCanvas,fillPage){this.init(aCanvas,fillPage)}WorldMorph.prototype.init=function(aCanvas,fillPage){WorldMorph.uber.init.call(this);this.color=new Color(205,205,205);this.alpha=1;this.bounds=new Rectangle(0,0,aCanvas.width,aCanvas.height);this.isVisible=true;this.isDraggable=false;this.currentKey=null;this.worldCanvas=aCanvas;this.stamp=Date.now();while(this.stamp===Date.now()){nop()}this.stamp=Date.now();this.useFillPage=fillPage;if(this.useFillPage===undefined){this.useFillPage=true}this.isDevMode=false;this.broken=[];this.animations=[];this.hand=new HandMorph(this);this.keyboardHandler=null;this.keyboardFocus=null;this.cursor=null;this.lastEditedText=null;this.activeMenu=null;this.activeHandle=null;this.initKeyboardHandler();this.resetKeyboardHandler();this.initEventListeners()};WorldMorph.prototype.fullDrawOn=function(aContext,aRect){WorldMorph.uber.fullDrawOn.call(this,aContext,aRect);this.hand.fullDrawOn(aContext,aRect)};WorldMorph.prototype.updateBroken=function(){var ctx=this.worldCanvas.getContext("2d");this.condenseDamages();this.broken.forEach(rect=>{if(rect.extent().gt(ZERO)){this.fullDrawOn(ctx,rect)}});this.broken=[]};WorldMorph.prototype.stepAnimations=function(){this.animations.forEach(anim=>anim.step());this.animations=this.animations.filter(anim=>anim.isActive)};WorldMorph.prototype.condenseDamages=function(){function condense(src){var trgt=[],len=src.length,rect,test=each=>each.isNearTo(rect,20),hit,i;for(i=0;i<len;i+=1){rect=src[i];hit=detect(trgt,test);if(hit){hit.mergeWith(rect)}else{trgt.push(rect)}}return trgt}function mergeAll(rects){var left=rects[0].origin.x,top=rects[0].origin.y,right=rects[0].corner.x,bottom=rects[0].corner.y,len=rects.length,each,i;for(i=1;i<len;i+=1){each=rects[i];left=Math.min(left,each.origin.x);top=Math.min(top,each.origin.y);right=Math.max(right,each.corner.x);bottom=Math.max(bottom,each.corner.y)}return new Rectangle(left,top,right,bottom)}if(this.broken.length>1e3){this.broken=[mergeAll(this.broken)]}else{this.broken=condense(this.broken)}};WorldMorph.prototype.doOneCycle=function(){this.stepFrame();this.stepAnimations();this.updateBroken()};WorldMorph.prototype.fillPage=function(){var clientHeight=window.innerHeight,clientWidth=window.innerWidth;this.worldCanvas.style.position="absolute";this.worldCanvas.style.left="0px";this.worldCanvas.style.right="0px";this.worldCanvas.style.width="100%";this.worldCanvas.style.height="100%";if(document.documentElement.scrollTop){clientHeight=document.documentElement.clientHeight}if(document.documentElement.scrollLeft){clientWidth=document.documentElement.clientWidth}if(this.worldCanvas.width!==clientWidth){this.worldCanvas.width=clientWidth;this.setWidth(clientWidth)}if(this.worldCanvas.height!==clientHeight){this.worldCanvas.height=clientHeight;this.setHeight(clientHeight)}this.children.forEach(child=>{if(child.reactToWorldResize){child.reactToWorldResize(this.bounds.copy())}})};WorldMorph.prototype.getGlobalPixelColor=function(point){var dta=this.worldCanvas.getContext("2d").getImageData(point.x,point.y,1,1).data;return new Color(dta[0],dta[1],dta[2])};WorldMorph.prototype.initKeyboardHandler=function(){var kbd=document.getElementById("morphic_keyboard");if(kbd){this.keyboardHandler=kbd;return}kbd=document.createElement("textarea");kbd.setAttribute("id","morphic_keyboard");kbd.setAttribute("style","caret-color:transparent;");kbd.style.position="absolute";kbd.style.overflow="hidden";kbd.style.border="none";kbd.style.resize="none";kbd.wrap="off";kbd.world=this;kbd.style.zIndex=-1;kbd.autofocus=true;document.body.appendChild(kbd);this.keyboardHandler=kbd;kbd.addEventListener("keydown",event=>{kbd.world.currentKey=event.keyCode;if(kbd.world.activeMenu&&!kbd.world.activeMenu.hasFocus){kbd.world.stopEditing();kbd.world.activeMenu.getFocus()}if(kbd.world.keyboardFocus&&kbd.world.keyboardFocus.processKeyDown){kbd.world.keyboardFocus.processKeyDown(event)}if(event.keyCode===9){if(kbd.world.keyboardFocus&&kbd.world.keyboardFocus.processKeyPress){kbd.world.keyboardFocus.processKeyPress(event)}event.preventDefault()}if((event.ctrlKey||event.metaKey)&&"dfiops".includes(event.key)){event.preventDefault()}},true);kbd.addEventListener("keyup",event=>{kbd.world.currentKey=null;if(kbd.world.keyboardFocus&&kbd.world.keyboardFocus.processKeyUp){kbd.world.keyboardFocus.processKeyUp(event)}event.preventDefault()},false);kbd.addEventListener("keypress",event=>{if(kbd.world.keyboardFocus&&kbd.world.keyboardFocus.processKeyPress){kbd.world.keyboardFocus.processKeyPress(event);event.preventDefault()}},false);kbd.addEventListener("input",event=>{if(kbd.world.keyboardFocus&&kbd.world.keyboardFocus.processInput){kbd.world.currentKey=null;kbd.world.keyboardFocus.processInput(event)}else{kbd.world.keyboardHandler.value=""}event.preventDefault()},false)};WorldMorph.prototype.resetKeyboardHandler=function(keepValue){var pos=getDocumentPositionOf(this.worldCanvas);function number2px(n){return Math.ceil(n)+"px"}if(!keepValue){this.keyboardHandler.value=""}this.keyboardHandler.style.top=number2px(pos.y);this.keyboardHandler.style.left=number2px(pos.x)};WorldMorph.prototype.initEventListeners=function(){var canvas=this.worldCanvas;if(this.useFillPage){this.fillPage()}else{this.changed()}canvas.addEventListener("mousedown",event=>{event.preventDefault();this.keyboardHandler.world=this;this.resetKeyboardHandler(true);if(!this.onNextStep){this.keyboardHandler.blur();this.onNextStep=()=>this.keyboardHandler.focus()}this.hand.processMouseDown(event)},true);canvas.addEventListener("touchstart",event=>this.hand.processTouchStart(event),false);canvas.addEventListener("mouseup",event=>{event.preventDefault();this.hand.processMouseUp(event)},false);canvas.addEventListener("dblclick",event=>{event.preventDefault();this.hand.processDoubleClick(event)},false);canvas.addEventListener("touchend",event=>this.hand.processTouchEnd(event),false);canvas.addEventListener("mousemove",event=>this.hand.processMouseMove(event),false);canvas.addEventListener("touchmove",event=>this.hand.processTouchMove(event),{passive:true});canvas.addEventListener("contextmenu",event=>event.preventDefault(),true);canvas.addEventListener("mousewheel",event=>{this.hand.processMouseScroll(event);event.preventDefault()},false);canvas.addEventListener("DOMMouseScroll",event=>{this.hand.processMouseScroll(event);event.preventDefault()},false);window.addEventListener("dragover",event=>event.preventDefault(),true);window.addEventListener("drop",event=>{this.hand.processMouseMove(event);this.hand.processDrop(event);event.preventDefault()},false);window.addEventListener("resize",()=>{if(this.useFillPage){this.fillPage()}},false);window.onbeforeunload=evt=>{var e=evt||window.event,msg="Are you sure you want to leave?";if(e){e.returnValue=msg}return msg}};WorldMorph.prototype.mouseDownLeft=nop;WorldMorph.prototype.mouseClickLeft=nop;WorldMorph.prototype.mouseDownRight=nop;WorldMorph.prototype.mouseClickRight=nop;WorldMorph.prototype.wantsDropOf=function(){return this.acceptsDrops};WorldMorph.prototype.droppedImage=nop;WorldMorph.prototype.droppedSVG=nop;WorldMorph.prototype.droppedAudio=nop;WorldMorph.prototype.droppedText=nop;WorldMorph.prototype.beginBulkDrop=nop;WorldMorph.prototype.endBulkDrop=nop;WorldMorph.prototype.nextTab=function(editField){var next=this.nextEntryField(editField);if(next){editField.clearSelection();next.selectAll();next.edit()}};WorldMorph.prototype.previousTab=function(editField){var prev=this.previousEntryField(editField);if(prev){editField.clearSelection();prev.selectAll();prev.edit()}};WorldMorph.prototype.contextMenu=function(){var menu;if(this.isDevMode){menu=new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])}else{menu=new MenuMorph(this,"Morphic")}if(this.isDevMode){menu.addItem("demo...","userCreateMorph","sample morphs");menu.addLine();menu.addItem("hide all...","hideAll");menu.addItem("show all...","showAllHiddens");menu.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible");menu.addItem("inspect...","inspect","open a window on\nall properties");menu.addItem("screenshot...",()=>window.open(this.fullImage().toDataURL()),"open a new window\nwith a picture of this morph");menu.addLine();menu.addItem("restore display","changed","redraw the\nscreen once");menu.addItem("fill page...","fillPage","let the World automatically\nadjust to browser resizing");if(useBlurredShadows){menu.addItem("sharp shadows...","toggleBlurredShadows","sharp drop shadows\nuse for old browsers")}else{menu.addItem("blurred shadows...","toggleBlurredShadows","blurry shades,\n use for new browsers")}menu.addItem("color...",()=>{this.pickColor(menu.title+localize("\ncolor:"),this.setColor,this,this.color)},"choose the World's\nbackground color");if(MorphicPreferences===standardSettings){menu.addItem("touch screen settings","togglePreferences","bigger menu fonts\nand sliders")}else{menu.addItem("standard settings","togglePreferences","smaller menu fonts\nand sliders")}if(MorphicPreferences.showHoles){menu.addItem("hide holes","toggleHolesDisplay","debug untouchable regions")}else{menu.addItem("show holes","toggleHolesDisplay","debug untouchable regions")}menu.addLine()}if(this.isDevMode){menu.addItem("user mode...","toggleDevMode","disable developers'\ncontext menus")}else{menu.addItem("development mode...","toggleDevMode")}menu.addItem("about morphic.js...","about");return menu};WorldMorph.prototype.userCreateMorph=function(){var myself=this,menu,newMorph;function create(aMorph){var cpy=aMorph.fullCopy();cpy.isDraggable=true;cpy.pickUp(myself)}menu=new MenuMorph(this,"make a morph");menu.addItem("rectangle",()=>create(new Morph));menu.addItem("box",()=>create(new BoxMorph));menu.addItem("circle box",()=>create(new CircleBoxMorph));menu.addLine();menu.addItem("slider",()=>create(new SliderMorph));menu.addItem("dial",()=>{newMorph=new DialMorph;newMorph.pickUp(this)});menu.addItem("frame",()=>{newMorph=new FrameMorph;newMorph.setExtent(new Point(350,250));create(newMorph)});menu.addItem("scroll frame",()=>{newMorph=new ScrollFrameMorph;newMorph.contents.acceptsDrops=true;newMorph.contents.adjustBounds();newMorph.setExtent(new Point(350,250));create(newMorph)});menu.addItem("handle",()=>create(new HandleMorph));menu.addLine();menu.addItem("string",()=>{newMorph=new StringMorph("Hello, World!");newMorph.isEditable=true;create(newMorph)});menu.addItem("text",()=>{newMorph=new TextMorph("Ich weiß nicht, was soll es bedeuten, dass ich so "+"traurig bin, ein Märchen aus uralten Zeiten, das "+"kommt mir nicht aus dem Sinn. Die Luft ist kühl "+"und es dunkelt, und ruhig fließt der Rhein; der "+"Gipfel des Berges funkelt im Abendsonnenschein. "+"Die schönste Jungfrau sitzet dort oben wunderbar, "+"ihr gold'nes Geschmeide blitzet, sie kämmt ihr "+"goldenes Haar, sie kämmt es mit goldenem Kamme, "+"und singt ein Lied dabei; das hat eine wundersame, "+"gewalt'ge Melodei. Den Schiffer im kleinen "+"Schiffe, ergreift es mit wildem Weh; er schaut "+"nicht die Felsenriffe, er schaut nur hinauf in "+"die Höh'. Ich glaube, die Wellen verschlingen "+"am Ende Schiffer und Kahn, und das hat mit ihrem "+"Singen, die Loreley getan.");newMorph.isEditable=true;newMorph.maxWidth=300;newMorph.fixLayout();create(newMorph)});menu.addItem("speech bubble",()=>{newMorph=new SpeechBubbleMorph("Hello, World!");create(newMorph)});menu.addLine();menu.addItem("gray scale palette",()=>create(new GrayPaletteMorph));menu.addItem("color palette",()=>create(new ColorPaletteMorph));menu.addItem("color picker",()=>create(new ColorPickerMorph));menu.addLine();menu.addItem("sensor demo",()=>{newMorph=new MouseSensorMorph;newMorph.setColor(new Color(230,200,100));newMorph.edge=35;newMorph.border=15;newMorph.borderColor=new Color(200,100,50);newMorph.alpha=.2;newMorph.setExtent(new Point(100,100));create(newMorph)});menu.addItem("animation demo",()=>{var foo,bar,baz,garply,fred;foo=new BouncerMorph;foo.setPosition(new Point(50,20));foo.setExtent(new Point(300,200));foo.alpha=.9;foo.speed=3;bar=new BouncerMorph;bar.setColor(new Color(50,50,50));bar.setPosition(new Point(80,80));bar.setExtent(new Point(80,250));bar.type="horizontal";bar.direction="right";bar.alpha=.9;bar.speed=5;baz=new BouncerMorph;baz.setColor(new Color(20,20,20));baz.setPosition(new Point(90,140));baz.setExtent(new Point(40,30));baz.type="horizontal";baz.direction="right";baz.speed=3;garply=new BouncerMorph;garply.setColor(new Color(200,20,20));garply.setPosition(new Point(90,140));garply.setExtent(new Point(20,20));garply.type="vertical";garply.direction="up";garply.speed=8;fred=new BouncerMorph;fred.setColor(new Color(20,200,20));fred.setPosition(new Point(120,140));fred.setExtent(new Point(20,20));fred.type="vertical";fred.direction="down";fred.speed=4;bar.add(garply);bar.add(baz);foo.add(fred);foo.add(bar);create(foo)});menu.addItem("pen",()=>create(new PenMorph));if(this.customMorphs.length){menu.addLine();this.customMorphs.forEach(item=>{var sub;if(item instanceof Array){sub=new MenuMorph;item[1].forEach(morph=>sub.addItem(morph,()=>create(morph instanceof Array?morph[0]:morph)));menu.addMenu(item[0],sub)}else{menu.addItem(item.toString(),()=>create(item))}})}menu.popUpAtHand(this)};WorldMorph.prototype.toggleDevMode=function(){this.isDevMode=!this.isDevMode};WorldMorph.prototype.hideAll=function(){this.children.forEach(child=>child.hide())};WorldMorph.prototype.showAllHiddens=function(){this.forAllChildren(child=>{if(!child.isVisible){child.show()}})};WorldMorph.prototype.about=function(){var versions="",module;for(module in modules){if(Object.prototype.hasOwnProperty.call(modules,module)){versions+="\n"+module+" ("+modules[module]+")"}}if(versions!==""){versions="\n\nmodules:\n\n"+"morphic ("+morphicVersion+")"+versions}this.inform("morphic.js\n\n"+"a lively Web GUI\ninspired by Squeak\n"+morphicVersion+"\n\nwritten by Jens Mönig\njens@moenig.org"+versions)};WorldMorph.prototype.edit=function(aStringOrTextMorph){if(this.lastEditedText===aStringOrTextMorph){return}if(!isNil(this.lastEditedText)){this.stopEditing()}if(!aStringOrTextMorph.isEditable){return null}if(this.cursor){this.cursor.destroy()}this.worldCanvas.focus();this.keyboardHandler.focus();this.cursor=new CursorMorph(aStringOrTextMorph,this.keyboardHandler);this.keyboardFocus=this.cursor;aStringOrTextMorph.parent.add(this.cursor);this.cursor.rerender();if(MorphicPreferences.useSliderForInput){if(!aStringOrTextMorph.parentThatIsA(MenuMorph)){this.slide(aStringOrTextMorph)}}if(this.lastEditedText!==aStringOrTextMorph){aStringOrTextMorph.escalateEvent("freshTextEdit",aStringOrTextMorph)}this.lastEditedText=aStringOrTextMorph};WorldMorph.prototype.slide=function(aStringOrTextMorph){var val=parseFloat(aStringOrTextMorph.text),menu,slider;if(isNaN(val)){val=0}menu=new MenuMorph;slider=new SliderMorph(val-25,val+25,val,10,"horizontal");slider.alpha=1;slider.color=new Color(225,225,225);slider.button.color=menu.borderColor;slider.button.highlightColor=slider.button.color.copy();slider.button.highlightColor.b+=100;slider.button.pressColor=slider.button.color.copy();slider.button.pressColor.b+=150;slider.setExtent(new Point(MorphicPreferences.scrollBarSize*10,MorphicPreferences.menuFontSize));slider.action=num=>{aStringOrTextMorph.changed();aStringOrTextMorph.text=Math.round(num).toString();aStringOrTextMorph.fixLayout();aStringOrTextMorph.rerender();aStringOrTextMorph.escalateEvent("reactToSliderEdit",aStringOrTextMorph)};menu.items.push(slider);menu.popup(this,aStringOrTextMorph.bottomLeft().add(new Point(0,5)))};WorldMorph.prototype.stopEditing=function(){if(this.cursor){this.cursor.target.escalateEvent("reactToEdit",this.cursor.target);this.cursor.target.clearSelection();this.cursor.destroy();this.cursor=null}if(this.keyboardFocus&&this.keyboardFocus.stopEditing){this.keyboardFocus.stopEditing()}this.keyboardFocus=null;this.lastEditedText=null};WorldMorph.prototype.toggleBlurredShadows=function(){useBlurredShadows=!useBlurredShadows};WorldMorph.prototype.togglePreferences=function(){if(MorphicPreferences===standardSettings){MorphicPreferences=touchScreenSettings}else{MorphicPreferences=standardSettings}};WorldMorph.prototype.toggleHolesDisplay=function(){MorphicPreferences.showHoles=!MorphicPreferences.showHoles;this.rerender()};</script>
        <script>modules.symbols="2021-March-03";var SymbolMorph;SymbolMorph.prototype=new Morph;SymbolMorph.prototype.constructor=SymbolMorph;SymbolMorph.uber=Morph.prototype;SymbolMorph.prototype.names=["square","pointRight","stepForward","gears","gearPartial","gearBig","file","fullScreen","grow","normalScreen","shrink","smallStage","normalStage","turtle","turtleOutline","stage","pause","flag","octagon","cloud","cloudGradient","cloudOutline","turnRight","turnLeft","turnAround","storage","poster","flash","brush","tick","checkedBox","rectangle","rectangleSolid","circle","circleSolid","ellipse","line","cross","crosshairs","paintbucket","eraser","pipette","speechBubble","speechBubbleOutline","loop","turnBack","turnForward","arrowUp","arrowUpOutline","arrowUpThin","arrowUpDownThin","arrowLeft","arrowLeftOutline","arrowLeftThin","arrowLeftRightThin","arrowDown","arrowDownOutline","arrowDownThin","arrowRight","arrowRightOutline","arrowRightThin","robot","magnifyingGlass","magnifierOutline","selection","polygon","closedBrush","notes","camera","location","footprints","keyboard","keyboardFilled","globe","globeBig","list","flipVertical","flipHorizontal","trash","trashFull"];function SymbolMorph(name,size,color,shadowOffset,shadowColor){this.init(name,size,color,shadowOffset,shadowColor)}SymbolMorph.prototype.init=function(name,size,color,shadowOffset,shadowColor){this.isProtectedLabel=false;this.isReadOnly=true;this.name=name||"square";this.size=size||50;this.shadowOffset=shadowOffset||ZERO;this.shadowColor=shadowColor||null;SymbolMorph.uber.init.call(this);this.color=color||BLACK;this.fixLayout();this.rerender()};SymbolMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+': "'+this.name+'" '+this.bounds};SymbolMorph.prototype.setLabelColor=function(textColor,shadowColor,shadowOffset){this.shadowOffset=shadowOffset||new Point;this.shadowColor=shadowColor;this.setColor(textColor)};SymbolMorph.prototype.getShadowRenderColor=function(){return this.shadowColor};SymbolMorph.prototype.setExtent=function(aPoint){if(this.size===aPoint.y){return}this.changed();this.size=aPoint.y;this.fixLayout();this.rerender()};SymbolMorph.prototype.fixLayout=function(){this.bounds.setWidth(this.symbolWidth()+Math.abs(this.shadowOffset.x));this.bounds.setHeight(this.size+Math.abs(this.shadowOffset.y))};SymbolMorph.prototype.render=function(ctx){var sx=this.shadowOffset.x<0?0:this.shadowOffset.x,sy=this.shadowOffset.y<0?0:this.shadowOffset.y,x=this.shadowOffset.x<0?Math.abs(this.shadowOffset.x):0,y=this.shadowOffset.y<0?Math.abs(this.shadowOffset.y):0;if(this.shadowColor){ctx.save();ctx.translate(sx,sy);this.renderShape(ctx,this.getShadowRenderColor());ctx.restore()}ctx.save();ctx.translate(x,y);this.renderShape(ctx,this.getRenderColor());ctx.restore()};SymbolMorph.prototype.renderShape=function(ctx,aColor){switch(this.name){case"square":this.renderSymbolStop(ctx,aColor);break;case"pointRight":this.renderSymbolPointRight(ctx,aColor);break;case"stepForward":this.renderSymbolStepForward(ctx,aColor);break;case"gears":this.renderSymbolGears(ctx,aColor);break;case"gearBig":this.renderSymbolGearBig(ctx,aColor);break;case"gearPartial":this.renderSymbolGearPartial(ctx,aColor);break;case"file":this.renderSymbolFile(ctx,aColor);break;case"fullScreen":this.renderSymbolFullScreen(ctx,aColor);break;case"grow":this.renderSymbolGrow(ctx,aColor);break;case"normalScreen":this.renderSymbolNormalScreen(ctx,aColor);break;case"smallStage":this.renderSymbolSmallStage(ctx,aColor);break;case"normalStage":this.renderSymbolNormalStage(ctx,aColor);break;case"shrink":this.renderSymbolShrink(ctx,aColor);break;case"turtle":this.renderSymbolTurtle(ctx,aColor);break;case"turtleOutline":this.renderSymbolTurtleOutline(ctx,aColor);break;case"stage":this.renderSymbolStop(ctx,aColor);break;case"pause":this.renderSymbolPause(ctx,aColor);break;case"flag":this.renderSymbolFlag(ctx,aColor);break;case"octagon":this.renderSymbolOctagon(ctx,aColor);break;case"cloud":this.renderSymbolCloud(ctx,aColor);break;case"cloudGradient":this.renderSymbolCloudGradient(ctx,aColor);break;case"cloudOutline":this.renderSymbolCloudOutline(ctx,aColor);break;case"turnRight":this.renderSymbolTurnRight(ctx,aColor);break;case"turnLeft":this.renderSymbolTurnLeft(ctx,aColor);break;case"turnAround":this.renderSymbolTurnAround(ctx,aColor);break;case"storage":this.renderSymbolStorage(ctx,aColor);break;case"poster":this.renderSymbolPoster(ctx,aColor);break;case"flash":this.renderSymbolFlash(ctx,aColor);break;case"brush":this.renderSymbolBrush(ctx,aColor);break;case"tick":this.renderSymbolTick(ctx,aColor);break;case"checkedBox":this.renderSymbolCheckedBox(ctx,aColor);break;case"rectangle":this.renderSymbolRectangle(ctx,aColor);break;case"rectangleSolid":this.renderSymbolRectangleSolid(ctx,aColor);break;case"circle":this.renderSymbolCircle(ctx,aColor);break;case"circleSolid":this.renderSymbolCircleSolid(ctx,aColor);break;case"ellipse":this.renderSymbolCircle(ctx,aColor);break;case"line":this.renderSymbolLine(ctx,aColor);break;case"cross":this.renderSymbolCross(ctx,aColor);break;case"crosshairs":this.renderSymbolCrosshairs(ctx,aColor);break;case"paintbucket":this.renderSymbolPaintbucket(ctx,aColor);break;case"eraser":this.renderSymbolEraser(ctx,aColor);break;case"pipette":this.renderSymbolPipette(ctx,aColor);break;case"speechBubble":this.renderSymbolSpeechBubble(ctx,aColor);break;case"speechBubbleOutline":this.renderSymbolSpeechBubbleOutline(ctx,aColor);break;case"loop":this.renderSymbolLoop(ctx,aColor);break;case"turnBack":this.renderSymbolTurnBack(ctx,aColor);break;case"turnForward":this.renderSymbolTurnForward(ctx,aColor);break;case"arrowUp":this.renderSymbolArrowUp(ctx,aColor);break;case"arrowUpOutline":this.renderSymbolArrowUpOutline(ctx,aColor);break;case"arrowUpThin":this.renderSymbolArrowUpThin(ctx,aColor);break;case"arrowUpDownThin":this.renderSymbolArrowUpDownThin(ctx,aColor);break;case"arrowLeft":this.renderSymbolArrowLeft(ctx,aColor);break;case"arrowLeftOutline":this.renderSymbolArrowLeftOutline(ctx,aColor);break;case"arrowLeftThin":this.renderSymbolArrowLeftThin(ctx,aColor);break;case"arrowLeftRightThin":this.renderSymbolArrowLeftRightThin(ctx,aColor);break;case"arrowDown":this.renderSymbolArrowDown(ctx,aColor);break;case"arrowDownOutline":this.renderSymbolArrowDownOutline(ctx,aColor);break;case"arrowDownThin":this.renderSymbolArrowDownThin(ctx,aColor);break;case"arrowRight":this.renderSymbolArrowRight(ctx,aColor);break;case"arrowRightOutline":this.renderSymbolArrowRightOutline(ctx,aColor);break;case"arrowRightThin":this.renderSymbolArrowRightThin(ctx,aColor);break;case"robot":this.renderSymbolRobot(ctx,aColor);break;case"magnifyingGlass":this.renderSymbolMagnifyingGlass(ctx,aColor);break;case"magnifierOutline":this.renderSymbolMagnifierOutline(ctx,aColor);break;case"selection":this.renderSymbolSelection(ctx,aColor);break;case"polygon":this.renderSymbolOctagonOutline(ctx,aColor);break;case"closedBrush":this.renderSymbolClosedBrushPath(ctx,aColor);break;case"notes":this.renderSymbolNotes(ctx,aColor);break;case"camera":this.renderSymbolCamera(ctx,aColor);break;case"location":this.renderSymbolLocation(ctx,aColor);break;case"footprints":this.renderSymbolFootprints(ctx,aColor);break;case"keyboard":this.renderSymbolKeyboard(ctx,aColor);break;case"keyboardFilled":this.renderSymbolKeyboardFilled(ctx,aColor);break;case"globe":this.renderSymbolGlobe(ctx,aColor);break;case"globeBig":this.renderSymbolGlobeBig(ctx,aColor);break;case"list":this.renderSymbolList(ctx,aColor);break;case"flipVertical":this.renderSymbolFlipVertical(ctx,aColor);break;case"flipHorizontal":this.renderSymbolFlipHorizontal(ctx,aColor);break;case"trash":this.renderSymbolTrash(ctx,aColor);break;case"trashFull":this.renderSymbolTrashFull(ctx,aColor);break;default:throw new Error('unknown symbol name: "'+this.name+'"')}};SymbolMorph.prototype.symbolWidth=function(){var size=this.size;switch(this.name){case"pointRight":return Math.sqrt(size*size-Math.pow(size/2,2));case"location":return size*.6;case"flash":case"file":case"list":return size*.8;case"smallStage":case"normalStage":return size*1.2;case"turtle":case"turtleOutline":case"stage":return size*1.3;case"cloud":case"cloudGradient":case"cloudOutline":case"turnBack":case"turnForward":case"keyboard":case"keyboardFilled":return size*1.6;case"turnRight":case"turnLeft":return size/3*2;case"loop":return size*2;default:return size}};SymbolMorph.prototype.renderSymbolStop=function(ctx,color){ctx.fillStyle=color.toString();ctx.fillRect(0,0,this.symbolWidth(),this.size)};SymbolMorph.prototype.renderSymbolPointRight=function(ctx,color){ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(this.symbolWidth(),Math.round(this.size/2));ctx.lineTo(0,this.size);ctx.lineTo(0,0);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolStepForward=function(ctx,color){var w=this.symbolWidth(),h=this.size;ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(w*.75,Math.round(h/2));ctx.lineTo(0,h);ctx.lineTo(0,0);ctx.closePath();ctx.fill();ctx.fillRect(w*.75,0,w*.25,h)};SymbolMorph.prototype.renderSymbolGears=function(ctx,color){var w=this.symbolWidth(),r=w/2,spikes=8,off=8,shift=10,angle,turn,i;ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(w,r);angle=360/spikes;turn=angle*.5;for(i=0;i<spikes;i+=1){ctx.arc(r,r,r,radians(i*angle+turn),radians(i*angle+off+turn));ctx.arc(r,r,r*.7,radians(i*angle-shift+angle*.5+turn),radians(i*angle+shift+angle*.5+turn));ctx.arc(r,r,r,radians((i+1)*angle-off+turn),radians((i+1)*angle+turn))}ctx.lineTo(w,r);ctx.arc(r,r,r*.3,radians(0),radians(360));ctx.clip("evenodd");ctx.fillRect(0,0,w,w)};SymbolMorph.prototype.renderSymbolGearBig=function(ctx,color){var w=this.symbolWidth(),r=w/2,spikes=10,off=7,shift=8,angle,i;ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(w,r);angle=360/spikes;for(i=0;i<spikes;i+=1){ctx.arc(r,r,r,radians(i*angle),radians(i*angle+off));ctx.arc(r,r,r*.8,radians(i*angle-shift+angle*.5),radians(i*angle+shift+angle*.5));ctx.arc(r,r,r,radians((i+1)*angle-off),radians((i+1)*angle))}ctx.lineTo(w,r);ctx.arc(r,r,r*.6,radians(0),radians(360));ctx.arc(r,r,r*.2,radians(0),radians(360));ctx.clip("evenodd");ctx.fillRect(0,0,w,w)};SymbolMorph.prototype.renderSymbolGearPartial=function(ctx,color){var w=this.symbolWidth(),r=w*.75,spikes=8,off=8,shift=10,angle,turn,i;ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(w,r);angle=360/spikes;turn=angle*.5;for(i=0;i<spikes;i+=1){ctx.arc(r,r,r,radians(i*angle+turn),radians(i*angle+off+turn));ctx.arc(r,r,r*.7,radians(i*angle-shift+angle*.5+turn),radians(i*angle+shift+angle*.5+turn));ctx.arc(r,r,r,radians((i+1)*angle-off+turn),radians((i+1)*angle+turn))}ctx.lineTo(w,r);ctx.arc(r,r,r*.3,radians(0),radians(360));ctx.clip("evenodd");ctx.fillRect(0,0,w,w)};SymbolMorph.prototype.renderSymbolFile=function(ctx,color){var height=this.size,width=this.symbolWidth(),w=Math.min(width,height)/2;ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(w,0);ctx.lineTo(w,w);ctx.lineTo(width,w);ctx.lineTo(width,height);ctx.lineTo(0,height);ctx.closePath();ctx.fill();ctx.fillStyle=color.darker(25).toString();ctx.beginPath();ctx.moveTo(w,0);ctx.lineTo(width,w);ctx.lineTo(w,w);ctx.lineTo(w,0);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolFullScreen=function(ctx,color){var h=this.size,width=this.symbolWidth(),c=width/2,off=width/20,w=width/2;ctx.strokeStyle=color.toString();ctx.lineWidth=width/5;ctx.beginPath();ctx.moveTo(c-off,c+off);ctx.lineTo(off*2,h-off*2);ctx.stroke();ctx.strokeStyle=color.toString();ctx.lineWidth=width/5;ctx.beginPath();ctx.moveTo(c+off,c-off);ctx.lineTo(h-off*2,off*2);ctx.stroke();ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(0,h);ctx.lineTo(0,h-w);ctx.lineTo(w,h);ctx.closePath();ctx.fill();ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(h,0);ctx.lineTo(h-w,0);ctx.lineTo(h,w);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolGrow=function(ctx,color){var h=this.size,width=this.symbolWidth(),c=width/2,off=width/20,w=width/3;function arrows(){ctx.strokeStyle=color.toString();ctx.lineWidth=width/7;ctx.beginPath();ctx.moveTo(c-off*3,c+off*3);ctx.lineTo(off*2,h-off*2);ctx.stroke();ctx.strokeStyle=color.toString();ctx.lineWidth=width/7;ctx.beginPath();ctx.moveTo(c+off*3,c-off*3);ctx.lineTo(h-off*2,off*2);ctx.stroke();ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(0,h);ctx.lineTo(0,h-w);ctx.lineTo(w,h);ctx.closePath();ctx.fill();ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(h,0);ctx.lineTo(h-w,0);ctx.lineTo(h,w);ctx.closePath();ctx.fill()}arrows();ctx.translate(this.size,0);ctx.rotate(radians(90));arrows()};SymbolMorph.prototype.renderSymbolNormalScreen=function(ctx,color){var h=this.size,w=this.symbolWidth(),c=w/2,off=w/20;ctx.strokeStyle=color.toString();ctx.lineWidth=w/5;ctx.beginPath();ctx.moveTo(c-off*3,c+off*3);ctx.lineTo(off,h-off);ctx.stroke();ctx.strokeStyle=color.toString();ctx.lineWidth=w/5;ctx.beginPath();ctx.moveTo(c+off*3,c-off*3);ctx.lineTo(h-off,off);ctx.stroke();ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(c+off,c-off);ctx.lineTo(w,c-off);ctx.lineTo(c+off,0);ctx.closePath();ctx.fill();ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(c-off,c+off);ctx.lineTo(0,c+off);ctx.lineTo(c-off,w);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolShrink=function(ctx,color){var h=this.size,w=this.symbolWidth(),c=w/2,off=w/20;function arrows(){ctx.strokeStyle=color.toString();ctx.lineWidth=w/8;ctx.beginPath();ctx.moveTo(c-off*3,c+off*3);ctx.lineTo(off,h-off);ctx.stroke();ctx.strokeStyle=color.toString();ctx.lineWidth=w/8;ctx.beginPath();ctx.moveTo(c+off*3,c-off*3);ctx.lineTo(h-off,off);ctx.stroke();ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(c+off*2,c-off*2);ctx.lineTo(w-off,c-off*2);ctx.lineTo(c+off*2,0+off);ctx.closePath();ctx.fill();ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(c-off*2,c+off*2);ctx.lineTo(0+off,c+off*2);ctx.lineTo(c-off*2,w-off);ctx.closePath();ctx.fill()}arrows();ctx.translate(this.size,0);ctx.rotate(radians(90));arrows()};SymbolMorph.prototype.renderSymbolSmallStage=function(ctx,color){var w=this.symbolWidth(),h=this.size,w2=w/2,h2=h/2;ctx.fillStyle=color.darker(50).toString();ctx.fillRect(0,0,w,h);ctx.fillStyle=color.toString();ctx.fillRect(w2,0,w2,h2)};SymbolMorph.prototype.renderSymbolNormalStage=function(ctx,color){var w=this.symbolWidth(),h=this.size,w2=w/2,h2=h/2;ctx.fillStyle=color.toString();ctx.fillRect(0,0,w,h);ctx.fillStyle=color.darker(50).toString();ctx.fillRect(w2,0,w2,h2)};SymbolMorph.prototype.renderSymbolTurtle=function(ctx,color){var w=this.symbolWidth(),h=this.size;ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(w,h/2);ctx.lineTo(0,h);ctx.lineTo(h/2,h/2);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolTurtleOutline=function(ctx,color){var w=this.symbolWidth(),h=this.size;ctx.strokeStyle=color.toString();ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(w,h/2);ctx.lineTo(0,h);ctx.lineTo(h/2,h/2);ctx.closePath();ctx.stroke()};SymbolMorph.prototype.renderSymbolPause=function(ctx,color){var w=this.symbolWidth()/5,h=this.size;ctx.fillStyle=color.toString();ctx.fillRect(0,0,w*2,h);ctx.fillRect(w*3,0,w*2,h)};SymbolMorph.prototype.renderSymbolFlag=function(ctx,color){var w=this.symbolWidth(),h=this.size,l=Math.max(w/12,1);ctx.lineWidth=l;ctx.strokeStyle=color.toString();ctx.beginPath();ctx.moveTo(l/2,0);ctx.lineTo(l/2,h);ctx.stroke();ctx.lineWidth=h/2;ctx.beginPath();ctx.moveTo(0,h/4);ctx.bezierCurveTo(w*.8,h/4,w*.1,h*.5,w,h*.5);ctx.stroke()};SymbolMorph.prototype.renderSymbolOctagon=function(ctx,color){var side=this.symbolWidth(),vert=(side-side*.383)/2;ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(vert,0);ctx.lineTo(side-vert,0);ctx.lineTo(side,vert);ctx.lineTo(side,side-vert);ctx.lineTo(side-vert,side);ctx.lineTo(vert,side);ctx.lineTo(0,side-vert);ctx.lineTo(0,vert);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolCloud=function(ctx,color){var w=this.symbolWidth(),h=this.size,r1=h*2/5,r2=h/4,r3=h*3/10,r4=h/5;ctx.fillStyle=color.toString();ctx.beginPath();ctx.arc(r2,h-r2,r2,radians(90),radians(259),false);ctx.arc(w/20*5,h/9*4,r4,radians(165),radians(300),false);ctx.arc(w/20*11,r1,r1,radians(200),radians(357),false);ctx.arc(w-r3,h-r3,r3,radians(269),radians(90),false);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolCloudGradient=function(ctx,color){var w=this.symbolWidth(),h=this.size,gradient,r1=h*2/5,r2=h/4,r3=h*3/10,r4=h/5;gradient=ctx.createRadialGradient(0,0,0,0,0,w);gradient.addColorStop(0,color.lighter(25).toString());gradient.addColorStop(1,color.darker(25).toString());ctx.fillStyle=gradient;ctx.beginPath();ctx.arc(r2,h-r2,r2,radians(90),radians(259),false);ctx.arc(w/20*5,h/9*4,r4,radians(165),radians(300),false);ctx.arc(w/20*11,r1,r1,radians(200),radians(357),false);ctx.arc(w-r3,h-r3,r3,radians(269),radians(90),false);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolCloudOutline=function(ctx,color){var w=this.symbolWidth(),h=this.size,r1=h*2/5,r2=h/4,r3=h*3/10,r4=h/5;ctx.strokeStyle=color.toString();ctx.beginPath();ctx.arc(r2+1,h-r2-1,r2,radians(90),radians(180),false);ctx.arc(w/20*5,h/9*4,r4,radians(150),radians(300),false);ctx.arc(w/20*11,r1+1,r1,radians(210),radians(335),false);ctx.arc(w-r3-1,h-r3-1,r3,radians(280),radians(90),false);ctx.closePath();ctx.stroke()};SymbolMorph.prototype.renderSymbolTurnRight=function(ctx,color){var w=this.symbolWidth(),l=Math.max(w/10,1),r=w/2;ctx.lineWidth=l;ctx.strokeStyle=color.toString();ctx.beginPath();ctx.arc(r,r*2,r-l/2,radians(0),radians(-90),false);ctx.stroke();ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(w,r);ctx.lineTo(r,0);ctx.lineTo(r,r*2);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolTurnLeft=function(ctx,color){var w=this.symbolWidth(),l=Math.max(w/10,1),r=w/2;ctx.lineWidth=l;ctx.strokeStyle=color.toString();ctx.beginPath();ctx.arc(r,r*2,r-l/2,radians(180),radians(-90),true);ctx.stroke();ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(0,r);ctx.lineTo(r,0);ctx.lineTo(r,r*2);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolTurnAround=function(ctx,color){var w=this.symbolWidth(),l=Math.max(w/10,1),r=w/2;ctx.lineWidth=l;ctx.strokeStyle=color.toString();ctx.beginPath();ctx.arc(r,r,r-l/2,radians(-45),radians(225),false);ctx.stroke();ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(0,r*.1);ctx.lineTo(r*.8,0);ctx.lineTo(r*.7,r*.7);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolStorage=function(ctx,color){var w=this.symbolWidth(),h=this.size,r=h,unit=h/11;function drawDisk(bottom){ctx.fillStyle=color.toString();ctx.beginPath();ctx.arc(w/2,bottom-h,r,radians(60),radians(120),false);ctx.lineTo(0,bottom-unit*2);ctx.arc(w/2,bottom-h-unit*2,r,radians(120),radians(60),true);ctx.closePath();ctx.fill();ctx.fillStyle=color.darker(25).toString();ctx.beginPath();ctx.arc(w/2,bottom+unit*6+1,r,radians(-120),radians(-60),false);ctx.stroke()}ctx.strokeStyle=color.toString();drawDisk(h);drawDisk(h-unit*3);drawDisk(h-unit*6)};SymbolMorph.prototype.renderSymbolPoster=function(ctx,color){var w=this.symbolWidth(),h=this.size,bottom=h*.75,edge=h/5;ctx.fillStyle=color.toString();ctx.strokeStyle=color.toString();ctx.lineWidth=w/15;ctx.beginPath();ctx.moveTo(w/2,h/3);ctx.lineTo(w/6,h);ctx.stroke();ctx.beginPath();ctx.moveTo(w/2,h/3);ctx.lineTo(w/2,h);ctx.stroke();ctx.beginPath();ctx.moveTo(w/2,h/3);ctx.lineTo(w*5/6,h);ctx.stroke();ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(w,0);ctx.lineTo(w,bottom-edge);ctx.lineTo(w-edge,bottom-edge);ctx.lineTo(w-edge,bottom);ctx.lineTo(0,bottom);ctx.closePath();ctx.fill();ctx.fillStyle=color.darker(25).toString();ctx.beginPath();ctx.moveTo(w,bottom-edge);ctx.lineTo(w-edge,bottom-edge);ctx.lineTo(w-edge,bottom);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolFlash=function(ctx,color){var w=this.symbolWidth(),h=this.size,w3=w/3,h3=h/3,off=h3/3;ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(w3,0);ctx.lineTo(0,h3);ctx.lineTo(w3,h3);ctx.lineTo(0,h3*2);ctx.lineTo(w3,h3*2);ctx.lineTo(0,h);ctx.lineTo(w,h3*2-off);ctx.lineTo(w3*2,h3*2-off);ctx.lineTo(w,h3-off);ctx.lineTo(w3*2,h3-off);ctx.lineTo(w,0);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolBrush=function(ctx,color){var w=this.symbolWidth(),h=this.size,l=Math.max(w/30,.5);ctx.fillStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(w/8*3,h/2);ctx.quadraticCurveTo(0,h/2,l,h-l);ctx.quadraticCurveTo(w/2,h,w/2,h/8*5);ctx.closePath();ctx.fill();ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=color.toString();ctx.moveTo(w/8*3,h/2);ctx.lineTo(w*.75,l);ctx.quadraticCurveTo(w,0,w-l,h*.25);ctx.stroke();ctx.moveTo(w/2,h/8*5);ctx.lineTo(w-l,h*.25);ctx.stroke()};SymbolMorph.prototype.renderSymbolTick=function(ctx,color){var w=this.symbolWidth(),h=this.size;ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(w*.2,h*.5);ctx.lineTo(w*.5,h);ctx.lineTo(w*.8,h*.3);ctx.lineTo(w,0);ctx.lineTo(w*.65,h*.2);ctx.lineTo(w*.5,h*.65);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolCheckedBox=function(ctx,color){this.renderSymbolRectangle(ctx,color);this.renderSymbolTick(ctx,color)};SymbolMorph.prototype.renderSymbolRectangle=function(ctx,color){var w=this.symbolWidth(),h=this.size,l=Math.max(w/20,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(l,l);ctx.lineTo(w-l,l);ctx.lineTo(w-l,h-l);ctx.lineTo(l,h-l);ctx.closePath();ctx.stroke()};SymbolMorph.prototype.renderSymbolRectangleSolid=function(ctx,color){var w=this.symbolWidth(),h=this.size;ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(w,0);ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolCircle=function(ctx,color){var w=this.symbolWidth(),l=Math.max(w/20,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.arc(w/2,w/2,w/2-l,radians(0),radians(360),false);ctx.stroke()};SymbolMorph.prototype.renderSymbolCircleSolid=function(ctx,color){var w=this.symbolWidth();ctx.fillStyle=color.toString();ctx.beginPath();ctx.arc(w/2,w/2,w/2,radians(0),radians(360),false);ctx.fill()};SymbolMorph.prototype.renderSymbolLine=function(ctx,color){var w=this.symbolWidth(),h=this.size,l=Math.max(w/20,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.lineCap="round";ctx.beginPath();ctx.moveTo(l,l);ctx.lineTo(w-l,h-l);ctx.stroke()};SymbolMorph.prototype.renderSymbolCross=function(ctx,color){var w=this.symbolWidth(),l=Math.max(w/20,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.lineCap="round";ctx.beginPath();ctx.moveTo(l,w/2);ctx.lineTo(w-l,w/2);ctx.stroke();ctx.beginPath();ctx.moveTo(w/2,l);ctx.lineTo(w/2,w-l);ctx.stroke()};SymbolMorph.prototype.renderSymbolCrosshairs=function(ctx,color){var w=this.symbolWidth(),h=this.size,l=.5;ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(l,h/2);ctx.lineTo(w-l,h/2);ctx.stroke();ctx.beginPath();ctx.moveTo(w/2,l);ctx.lineTo(w/2,h-l);ctx.stroke();ctx.beginPath();ctx.moveTo(w/2,h/2);ctx.arc(w/2,w/2,w/3-l,radians(0),radians(360),false);ctx.stroke()};SymbolMorph.prototype.renderSymbolPaintbucket=function(ctx,color){var w=this.symbolWidth(),h=this.size,n=w/5,l=Math.max(w/30,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(n*2,n);ctx.lineTo(n*4,n*3);ctx.lineTo(n*3,n*4);ctx.quadraticCurveTo(n*2,h,n,n*4);ctx.quadraticCurveTo(0,n*3,n,n*2);ctx.closePath();ctx.stroke();ctx.lineWidth=l;ctx.moveTo(n*2,n*2.5);ctx.arc(n*2,n*2.5,l,radians(0),radians(360),false);ctx.stroke();ctx.moveTo(n*2,n*2.5);ctx.lineTo(n*2,n/2+l);ctx.stroke();ctx.arc(n*1.5,n/2+l,n/2,radians(0),radians(180),true);ctx.stroke();ctx.moveTo(n,n/2+l);ctx.lineTo(n,n*2);ctx.stroke();ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(n*3.5,n*3.5);ctx.quadraticCurveTo(w,n*3.5,w-l,h);ctx.lineTo(w,h);ctx.quadraticCurveTo(w,n*2,n*2.5,n*1.5);ctx.lineTo(n*4,n*3);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolEraser=function(ctx,color){var w=this.symbolWidth(),h=this.size,n=w/4,l=Math.max(w/20,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(n*3,l);ctx.lineTo(l,n*3);ctx.quadraticCurveTo(n,h,n*2,n*3);ctx.lineTo(w-l,n);ctx.closePath();ctx.stroke();ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(n*3,0);ctx.lineTo(n*1.5,n*1.5);ctx.lineTo(n*2.5,n*2.5);ctx.lineTo(w,n);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolPipette=function(ctx,color){var w=this.symbolWidth(),h=this.size,n=w/4,n2=n/2,l=Math.max(w/20,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(l,h-l);ctx.quadraticCurveTo(n2,h-n2,n2,h-n);ctx.lineTo(n*2,n*1.5);ctx.stroke();ctx.beginPath();ctx.moveTo(l,h-l);ctx.quadraticCurveTo(n2,h-n2,n,h-n2);ctx.lineTo(n*2.5,n*2);ctx.stroke();ctx.fillStyle=color.toString();ctx.arc(n*3,n,n-l,radians(0),radians(360),false);ctx.fill();ctx.beginPath();ctx.moveTo(n*2,n);ctx.lineTo(n*3,n*2);ctx.stroke()};SymbolMorph.prototype.renderSymbolSpeechBubble=function(ctx,color){var w=this.symbolWidth(),h=this.size,n=w/3,l=Math.max(w/20,.5);ctx.fillStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(n,n*2);ctx.quadraticCurveTo(l,n*2,l,n);ctx.quadraticCurveTo(l,l,n,l);ctx.lineTo(n*2,l);ctx.quadraticCurveTo(w-l,l,w-l,n);ctx.quadraticCurveTo(w-l,n*2,n*2,n*2);ctx.lineTo(n/2,h-l);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolSpeechBubbleOutline=function(ctx,color){var w=this.symbolWidth(),h=this.size,n=w/3,l=Math.max(w/20,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(n,n*2);ctx.quadraticCurveTo(l,n*2,l,n);ctx.quadraticCurveTo(l,l,n,l);ctx.lineTo(n*2,l);ctx.quadraticCurveTo(w-l,l,w-l,n);ctx.quadraticCurveTo(w-l,n*2,n*2,n*2);ctx.lineTo(n/2,h-l);ctx.closePath();ctx.stroke()};SymbolMorph.prototype.renderSymbolLoop=function(ctx,aColor){var w=this.symbolWidth(),h=this.size,w2=w/2,w4=w2/2,h2=h/2,l=Math.max(h/10,.5);ctx.lineWidth=l*2;ctx.strokeStyle=aColor.toString();ctx.beginPath();ctx.moveTo(0,h-l);ctx.lineTo(w2,h-l);ctx.arc(w2,h2,h2-l,radians(90),radians(0),true);ctx.stroke();ctx.fillStyle=aColor.toString();ctx.beginPath();ctx.moveTo(w4*3-l,0);ctx.lineTo(w2-l,h2);ctx.lineTo(w,h2);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolTurnBack=function(ctx,aColor){var w=this.symbolWidth(),h=this.size,w2=w/2,h2=h/2,l=Math.max(w/20,.5);ctx.fillStyle=aColor.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(0,h2);ctx.lineTo(w2,0);ctx.lineTo(w2,h);ctx.closePath();ctx.fill();ctx.lineWidth=l*3;ctx.strokeStyle=aColor.toString();ctx.beginPath();ctx.arc(w2,h,h2,radians(0),radians(-90),true);ctx.stroke()};SymbolMorph.prototype.renderSymbolTurnForward=function(ctx,aColor){var w=this.symbolWidth(),h=this.size,w2=w/2,h2=h/2,l=Math.max(w/20,.5);ctx.fillStyle=aColor.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(w,h2);ctx.lineTo(w2,0);ctx.lineTo(w2,h);ctx.closePath();ctx.fill();ctx.lineWidth=l*3;ctx.strokeStyle=aColor.toString();ctx.beginPath();ctx.arc(w2,h,h2,radians(-180),radians(-90),false);ctx.stroke()};SymbolMorph.prototype.renderSymbolArrowUp=function(ctx,color){var w=this.symbolWidth(),h=this.size,n=w/2,l=Math.max(w/20,.5);ctx.fillStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(l,n);ctx.lineTo(n,l);ctx.lineTo(w-l,n);ctx.lineTo(w*.65,n);ctx.lineTo(w*.65,h-l);ctx.lineTo(w*.35,h-l);ctx.lineTo(w*.35,n);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolArrowUpOutline=function(ctx,color){var w=this.symbolWidth(),h=this.size,n=w/2,l=Math.max(w/20,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(l,n);ctx.lineTo(n,l);ctx.lineTo(w-l,n);ctx.lineTo(w*.65,n);ctx.lineTo(w*.65,h-l);ctx.lineTo(w*.35,h-l);ctx.lineTo(w*.35,n);ctx.closePath();ctx.stroke()};SymbolMorph.prototype.renderSymbolArrowUpThin=function(ctx,color){var w=this.symbolWidth(),h=this.size,n=w/3,l=Math.max(w/20,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(w-n,n);ctx.lineTo(w/2,l*2);ctx.lineTo(n,n);ctx.moveTo(w/2,l*2);ctx.lineTo(w/2,h-l);ctx.stroke()};SymbolMorph.prototype.renderSymbolArrowUpDownThin=function(ctx,color){var w=this.symbolWidth(),h=this.size,n=w/3,l=Math.max(w/20,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(w-n,n);ctx.lineTo(w/2,l*2);ctx.lineTo(n,n);ctx.moveTo(w-n,h-n);ctx.lineTo(w/2,h-l*2);ctx.lineTo(n,h-n);ctx.moveTo(w/2,l*2);ctx.lineTo(w/2,h-l*2);ctx.stroke()};SymbolMorph.prototype.renderSymbolArrowDown=function(ctx,color){var w=this.symbolWidth();ctx.save();ctx.translate(w,w);ctx.rotate(radians(180));this.renderSymbolArrowUp(ctx,color);ctx.restore()};SymbolMorph.prototype.renderSymbolArrowDownOutline=function(ctx,color){var w=this.symbolWidth();ctx.save();ctx.translate(w,w);ctx.rotate(radians(180));this.renderSymbolArrowUpOutline(ctx,color);ctx.restore()};SymbolMorph.prototype.renderSymbolArrowDownThin=function(ctx,color){var w=this.symbolWidth();ctx.save();ctx.translate(w,w);ctx.rotate(radians(180));this.renderSymbolArrowUpThin(ctx,color);ctx.restore()};SymbolMorph.prototype.renderSymbolArrowLeft=function(ctx,color){var w=this.symbolWidth();ctx.save();ctx.translate(0,w);ctx.rotate(radians(-90));this.renderSymbolArrowUp(ctx,color);ctx.restore()};SymbolMorph.prototype.renderSymbolArrowLeftOutline=function(ctx,color){var w=this.symbolWidth();ctx.save();ctx.translate(0,w);ctx.rotate(radians(-90));this.renderSymbolArrowUpOutline(ctx,color);ctx.restore()};SymbolMorph.prototype.renderSymbolArrowLeftThin=function(ctx,color){var w=this.symbolWidth();ctx.save();ctx.translate(0,w);ctx.rotate(radians(-90));this.renderSymbolArrowUpThin(ctx,color);ctx.restore()};SymbolMorph.prototype.renderSymbolArrowLeftRightThin=function(ctx,color){var w=this.symbolWidth();ctx.save();ctx.translate(0,w);ctx.rotate(radians(-90));this.renderSymbolArrowUpDownThin(ctx,color);ctx.restore()};SymbolMorph.prototype.renderSymbolArrowRight=function(ctx,color){var w=this.symbolWidth();ctx.save();ctx.translate(w,0);ctx.rotate(radians(90));this.renderSymbolArrowUp(ctx,color);ctx.restore()};SymbolMorph.prototype.renderSymbolArrowRightOutline=function(ctx,color){var w=this.symbolWidth();ctx.save();ctx.translate(w,0);ctx.rotate(radians(90));this.renderSymbolArrowUpOutline(ctx,color);ctx.restore()};SymbolMorph.prototype.renderSymbolArrowRightThin=function(ctx,color){var w=this.symbolWidth();ctx.save();ctx.translate(w,0);ctx.rotate(radians(90));this.renderSymbolArrowUpThin(ctx,color);ctx.restore()};SymbolMorph.prototype.renderSymbolRobot=function(ctx,color){var w=this.symbolWidth(),h=this.size,n=w/6,n2=n/2,l=Math.max(w/20,.5);ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(n+l,n);ctx.lineTo(n*2,n);ctx.lineTo(n*2.5,n*1.5);ctx.lineTo(n*3.5,n*1.5);ctx.lineTo(n*4,n);ctx.lineTo(n*5-l,n);ctx.lineTo(n*4,n*3);ctx.lineTo(n*4,n*4-l);ctx.lineTo(n*2,n*4-l);ctx.lineTo(n*2,n*3);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(n*2.75,n+l);ctx.lineTo(n*2.4,n);ctx.lineTo(n*2.2,0);ctx.lineTo(n*3.8,0);ctx.lineTo(n*3.6,n);ctx.lineTo(n*3.25,n+l);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(n*2.5,n*4);ctx.lineTo(n,n*4);ctx.lineTo(n2+l,h);ctx.lineTo(n*2,h);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(n*3.5,n*4);ctx.lineTo(n*5,n*4);ctx.lineTo(w-(n2+l),h);ctx.lineTo(n*4,h);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(n,n);ctx.lineTo(l,n*1.5);ctx.lineTo(l,n*3.25);ctx.lineTo(n*1.5,n*3.5);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(n*5,n);ctx.lineTo(w-l,n*1.5);ctx.lineTo(w-l,n*3.25);ctx.lineTo(n*4.5,n*3.5);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolMagnifyingGlass=function(ctx,color){var w=this.symbolWidth(),h=this.size,gradient,r=w*.3,x=w*2/3-Math.sqrt(r),y=h/3+Math.sqrt(r),l=Math.max(w/5,.5);ctx.strokeStyle=color.toString();gradient=ctx.createRadialGradient(x,y,0,x+r,y+r,w);gradient.addColorStop(0,color.inverted().lighter(50).toString());gradient.addColorStop(1,color.inverted().darker(25).toString());ctx.fillStyle=gradient;ctx.beginPath();ctx.arc(x,y,r,radians(0),radians(360),false);ctx.fill();ctx.lineWidth=l/2;ctx.beginPath();ctx.arc(x,y,r,radians(0),radians(360),false);ctx.stroke();ctx.lineWidth=l;ctx.beginPath();ctx.moveTo(l/2,h-l/2);ctx.lineTo(x-Math.sqrt(r+l),y+Math.sqrt(r+l));ctx.closePath();ctx.stroke()};SymbolMorph.prototype.renderSymbolMagnifierOutline=function(ctx,color){var w=this.symbolWidth(),h=this.size,r=w*.3,x=w*2/3-Math.sqrt(r),y=h/3+Math.sqrt(r),l=Math.max(w/5,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*.5;ctx.beginPath();ctx.arc(x,y,r,radians(0),radians(360),false);ctx.stroke();ctx.lineWidth=l;ctx.beginPath();ctx.moveTo(l/2,h-l/2);ctx.lineTo(x-Math.sqrt(r+l),y+Math.sqrt(r+l));ctx.closePath();ctx.stroke()};SymbolMorph.prototype.renderSymbolSelection=function(ctx,color){var w=this.symbolWidth(),h=this.size;ctx.save();ctx.setLineDash([3]);this.renderSymbolRectangle(ctx,color);ctx.restore();ctx.save();ctx.fillStyle=color.toString();ctx.translate(.7*w,.4*h);ctx.scale(.5,.5);ctx.rotate(radians(135));this.renderSymbolArrowDownOutline(ctx,color);ctx.fill();ctx.restore()};SymbolMorph.prototype.renderSymbolOctagonOutline=function(ctx,color){var side=this.symbolWidth(),vert=(side-side*.383)/2,l=Math.max(side/20,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.moveTo(vert,l);ctx.lineTo(side-vert,l);ctx.lineTo(side-l,vert);ctx.lineTo(side-l,side-vert);ctx.lineTo(side-vert,side-l);ctx.lineTo(vert,side-l);ctx.lineTo(l,side-vert);ctx.lineTo(l,vert);ctx.closePath();ctx.stroke()};SymbolMorph.prototype.renderSymbolClosedBrushPath=SymbolMorph.prototype.renderSymbolCloudOutline;SymbolMorph.prototype.renderSymbolNotes=function(ctx,color){var size=this.symbolWidth(),r=size/6,l=Math.max(r/3,1);ctx.strokeStyle=color.toString();ctx.fillStyle=color.toString();ctx.beginPath();ctx.arc(r,size-r,r,radians(0),radians(360),false);ctx.fill();ctx.beginPath();ctx.arc(size-r,size-r*2,r,radians(0),radians(360),false);ctx.fill();ctx.beginPath();ctx.moveTo(r*2-l,r);ctx.lineTo(size,0);ctx.lineTo(size,r);ctx.lineTo(r*2-l,r*2);ctx.closePath();ctx.fill();ctx.lineWidth=l;ctx.beginPath();ctx.moveTo(r*2-l/2,size-r);ctx.lineTo(r*2-l/2,r+l);ctx.stroke();ctx.beginPath();ctx.moveTo(size-l/2,size-r*2);ctx.lineTo(size-l/2,l);ctx.stroke()};SymbolMorph.prototype.renderSymbolCamera=function(ctx,color){var w=this.symbolWidth(),h=this.size,r=w*.16,l=Math.max(w/20,.5);ctx.lineWidth=l*2;ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(l,h*5/6);ctx.lineTo(w-l,h*5/6);ctx.lineTo(w-l,h/4);ctx.lineTo(w*3/4,h/4);ctx.lineTo(w*5/8,l);ctx.lineTo(w*3/8,l);ctx.lineTo(w/4,h/4);ctx.lineTo(l,h/4);ctx.lineTo(l,h*5/6);ctx.arc(w/2,h/2,r,radians(0),radians(360),false);ctx.clip();ctx.fillRect(0,0,w,h)};SymbolMorph.prototype.renderSymbolLocation=function(ctx,color){var w=this.symbolWidth(),h=this.size,r=w/2;ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(0,r);ctx.arc(r,r,r,radians(-180),radians(0),false);ctx.lineTo(r,h);ctx.lineTo(0,r);ctx.arc(r,r,r*.5,radians(0),radians(360),false);ctx.clip("evenodd");ctx.fillRect(0,0,w,h)};SymbolMorph.prototype.renderSymbolFootprints=function(ctx,color){var w=this.symbolWidth(),u=w/10,r=u*1.5;ctx.fillStyle=color.toString();ctx.beginPath();ctx.arc(r,r,r,radians(-200),radians(0),false);ctx.lineTo(r*2,u*5.5);ctx.lineTo(u,u*6);ctx.closePath();ctx.fill();ctx.beginPath();ctx.arc(u*2.25,u*6.75,u,radians(-40),radians(-170),false);ctx.closePath();ctx.fill();ctx.beginPath();ctx.arc(w-r,u*4.5,r,radians(-180),radians(20),false);ctx.lineTo(w-u,u*8.5);ctx.lineTo(w-r*2,u*8);ctx.closePath();ctx.fill();ctx.beginPath();ctx.arc(w-u*2.25,u*9,u,radians(0),radians(-150),false);ctx.closePath();ctx.fill()};SymbolMorph.prototype.renderSymbolKeyboard=function(ctx,color){var h=this.size,u=h/10,k=h/5,row,col;ctx.fillStyle=color.toString();for(row=0;row<2;row+=1){for(col=0;col<5;col+=1){ctx.fillRect((u+k)*col+u,(u+k)*row+u,k,k)}}ctx.fillRect(u*4,u*7,k*4,k)};SymbolMorph.prototype.renderSymbolKeyboardFilled=function(ctx,color){var w=this.symbolWidth(),h=this.size,u=h/10,k=h/5,row,col;ctx.fillStyle=color.toString();ctx.beginPath();ctx.rect(0,0,w,h);for(row=0;row<2;row+=1){for(col=0;col<5;col+=1){ctx.rect((u+k)*col+u,(u+k)*row+u,k,k)}}ctx.rect(u*4,u*7,k*4,k);ctx.clip("evenodd");ctx.fillRect(0,0,w,h)};SymbolMorph.prototype.renderSymbolGlobeBig=function(ctx,color){this.renderSymbolGlobe(ctx,color,true)};SymbolMorph.prototype.renderSymbolGlobe=function(ctx,color,detailed){var w=this.symbolWidth(),l=Math.max(w/30,.5);ctx.strokeStyle=color.toString();ctx.lineWidth=l*2;ctx.beginPath();ctx.arc(w/2,w/2,w/2-l,radians(0),radians(360),false);ctx.stroke();if(detailed){ctx.moveTo(l*3,w*.3);ctx.lineTo(w-l*3,w*.3);ctx.stroke();ctx.moveTo(l*3,w*.7);ctx.lineTo(w-l*3,w*.7);ctx.stroke()}ctx.beginPath();ctx.moveTo(l,w/2);ctx.lineTo(w-l,w/2);ctx.stroke();ctx.beginPath();ctx.moveTo(w/2,l/2);ctx.arcTo(0,w/2,w/2,w,w*.75);ctx.stroke();ctx.beginPath();ctx.moveTo(w/2,l/2);ctx.arcTo(w,w/2,w/2,w,w*.75);ctx.stroke()};SymbolMorph.prototype.renderSymbolList=function(ctx,color){var w=this.symbolWidth(),h=this.size,padding=h/10,item=h/5,row;ctx.fillStyle=color.toString();ctx.beginPath();ctx.rect(0,0,w,h);for(row=0;row<4;row+=1){ctx.rect(padding,(padding+item)*row+padding,w-item,item)}ctx.clip("evenodd");ctx.fillRect(0,0,w,h)};SymbolMorph.prototype.renderSymbolFlipHorizontal=function(ctx,color){var w=this.symbolWidth(),h=this.size,c=w/2,off=w/15;ctx.strokeStyle=color.toString();ctx.lineWidth=w/15;ctx.beginPath();ctx.moveTo(0+off,h-off/2);ctx.lineTo(c-off*1.2,h-off/2);ctx.lineTo(c-off*1.2,off*2);ctx.closePath();ctx.stroke();ctx.fillStyle=color.toString();ctx.lineWidth=w/15;ctx.beginPath();ctx.moveTo(w-off,h-off/2);ctx.lineTo(c+off*1.2,h-off/2);ctx.lineTo(c+off*1.2,off*2);ctx.closePath();ctx.stroke();ctx.fill()};SymbolMorph.prototype.renderSymbolFlipVertical=function(ctx,color){ctx.translate(0,this.size);ctx.rotate(radians(-90));this.renderSymbolFlipHorizontal(ctx,color)};SymbolMorph.prototype.renderSymbolTrash=function(ctx,color){var w=this.symbolWidth(),h=this.size,step=w/10;function stripe(x){var half=step/2;ctx.moveTo(x-half,step*4);ctx.arc(x,step*4,half,radians(180),radians(0));ctx.lineTo(x+half,step*8.5);ctx.arc(x,step*8.5,half,radians(0),radians(180));ctx.lineTo(x-half,step*4)}ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(step,step*2.5);ctx.lineTo(step*1.5,step*9.5);ctx.lineTo(step*2.5,h);ctx.lineTo(step*7.5,h);ctx.lineTo(step*8.5,step*9.5);ctx.lineTo(step*9,step*2.5);ctx.lineTo(step,step*2.5);stripe(w*.3);stripe(w*.5);stripe(w*.7);ctx.save();ctx.clip();ctx.fillRect(0,0,w,h);ctx.restore();ctx.lineWidth=step;ctx.lineJoin="round";ctx.strokeStyle=color.toString();ctx.lineWidth=step;ctx.beginPath();ctx.moveTo(step/2,step*1.5);ctx.lineTo(step*9.5,step*1.5);ctx.stroke();ctx.lineWidth=step/2;ctx.beginPath();ctx.moveTo(step*3,step*1.5);ctx.lineTo(step*4,step*.25);ctx.lineTo(step*6,step*.25);ctx.lineTo(step*7,step*1.5);ctx.stroke()};SymbolMorph.prototype.renderSymbolTrashFull=function(ctx,color){var w=this.symbolWidth(),h=this.size,step=w/10;function stripe(x){var half=step/2;ctx.moveTo(x-half,step*5.5);ctx.arc(x,step*5.5,half,radians(180),radians(0));ctx.lineTo(x+half,step*8.5);ctx.arc(x,step*8.5,half,radians(0),radians(180));ctx.lineTo(x-half,step*5.5)}ctx.fillStyle=color.toString();ctx.beginPath();ctx.moveTo(step,step*4);ctx.lineTo(step*1.5,step*9.5);ctx.lineTo(step*2.5,h);ctx.lineTo(step*7.5,h);ctx.lineTo(step*8.5,step*9.5);ctx.lineTo(step*9,step*4);ctx.lineTo(step,step*4);stripe(w*.3);stripe(w*.5);stripe(w*.7);ctx.save();ctx.clip();ctx.fillRect(0,0,w,h);ctx.restore();ctx.beginPath();ctx.moveTo(step*2,0);ctx.lineTo(step*6,0);ctx.lineTo(step*8,step*2);ctx.lineTo(step*8,step*3.5);ctx.lineTo(step*2,step*3.5);ctx.closePath();ctx.fill();ctx.fillStyle=color.darker(25).toString();ctx.beginPath();ctx.moveTo(step*6,0);ctx.lineTo(step*8,step*2);ctx.lineTo(step*6,step*2);ctx.closePath();ctx.fill()};</script>
        <script>modules.widgets="2022-August-01";var PushButtonMorph;var ToggleButtonMorph;var TabMorph;var ToggleMorph;var ToggleElementMorph;var DialogBoxMorph;var AlignmentMorph;var InputFieldMorph;var PianoMenuMorph;var PianoKeyMorph;PushButtonMorph.prototype=new TriggerMorph;PushButtonMorph.prototype.constructor=PushButtonMorph;PushButtonMorph.uber=TriggerMorph.prototype;PushButtonMorph.prototype.fontSize=10;PushButtonMorph.prototype.fontStyle="sans-serif";PushButtonMorph.prototype.labelColor=BLACK;PushButtonMorph.prototype.labelShadowColor=WHITE;PushButtonMorph.prototype.labelShadowOffset=new Point(1,1);PushButtonMorph.prototype.color=new Color(220,220,220);PushButtonMorph.prototype.pressColor=new Color(115,180,240);PushButtonMorph.prototype.highlightColor=PushButtonMorph.prototype.pressColor.lighter(50);PushButtonMorph.prototype.outlineColor=new Color(30,30,30);PushButtonMorph.prototype.outlineGradient=false;PushButtonMorph.prototype.contrast=60;PushButtonMorph.prototype.edge=2;PushButtonMorph.prototype.corner=5;PushButtonMorph.prototype.outline=1;PushButtonMorph.prototype.padding=3;function PushButtonMorph(target,action,labelString,environment,hint){this.init(target,action,labelString,environment,hint)}PushButtonMorph.prototype.init=function(target,action,labelString,environment,hint){this.is3D=false;this.target=target||null;this.action=action||null;this.environment=environment||null;this.labelString=labelString||null;this.label=null;this.labelMinExtent=ZERO;this.hint=hint||null;this.isDisabled=false;TriggerMorph.uber.init.call(this);this.color=PushButtonMorph.prototype.color;this.createLabel();this.fixLayout();this.rerender()};PushButtonMorph.prototype.fixLayout=function(){if(this.label!==null){this.updateLabelColors();var padding=this.padding*2+this.outline*2+this.edge*2;this.bounds.setWidth(Math.max(this.label.width(),this.labelMinExtent.x)+padding);this.bounds.setHeight(Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+padding);this.label.setCenter(this.center())}};PushButtonMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this);if(this.label){this.label.setCenter(this.center().add(1))}};PushButtonMorph.prototype.mouseClickLeft=function(){if(this.isDisabled){return}PushButtonMorph.uber.mouseClickLeft.call(this);if(this.label){this.label.setCenter(this.center())}};PushButtonMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this);if(this.label){this.label.setCenter(this.center())}};PushButtonMorph.prototype.render=function(ctx){if(this.userState==="highlight"){this.drawOutline(ctx);this.drawBackground(ctx,this.highlightColor);this.drawEdges(ctx,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast))}else if(this.userState==="pressed"){this.drawOutline(ctx);this.drawBackground(ctx,this.pressColor);this.drawEdges(ctx,this.pressColor,this.pressColor.darker(this.contrast),this.pressColor.lighter(this.contrast))}else{this.drawOutline(ctx);this.drawBackground(ctx,this.color);this.drawEdges(ctx,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast))}};PushButtonMorph.prototype.drawOutline=function(ctx){var outlineStyle,isFlat=MorphicPreferences.isFlat&&!this.is3D;if(!this.outline||isFlat){return null}if(this.outlineGradient){outlineStyle=ctx.createLinearGradient(0,0,0,this.height());outlineStyle.addColorStop(0,this.outlineColor.darker().toString());outlineStyle.addColorStop(1,"white")}else{outlineStyle=this.outlineColor.toString()}ctx.fillStyle=outlineStyle;ctx.beginPath();this.outlinePath(ctx,isFlat?0:this.corner,0);ctx.closePath();ctx.fill()};PushButtonMorph.prototype.drawBackground=function(ctx,color){var isFlat=MorphicPreferences.isFlat&&!this.is3D;ctx.fillStyle=color.toString();ctx.beginPath();this.outlinePath(ctx,isFlat?0:Math.max(this.corner-this.outline,0),this.outline);ctx.closePath();ctx.fill();ctx.lineWidth=this.outline};PushButtonMorph.prototype.drawEdges=function(ctx,color,topColor,bottomColor){if(MorphicPreferences.isFlat&&!this.is3D){return}var minInset=Math.max(this.corner,this.outline+this.edge),w=this.width(),h=this.height(),gradient;gradient=ctx.createLinearGradient(0,this.outline,0,this.outline+this.edge);gradient.addColorStop(0,topColor.toString());gradient.addColorStop(1,color.toString());ctx.strokeStyle=gradient;ctx.lineCap="round";ctx.lineWidth=this.edge;ctx.beginPath();ctx.moveTo(minInset,this.outline+this.edge/2);ctx.lineTo(w-minInset,this.outline+this.edge/2);ctx.stroke();gradient=ctx.createRadialGradient(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge,0),this.corner,this.corner,Math.max(this.corner-this.outline,0));gradient.addColorStop(0,color.toString());gradient.addColorStop(1,topColor.toString());ctx.strokeStyle=gradient;ctx.lineCap="round";ctx.lineWidth=this.edge;ctx.beginPath();ctx.arc(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(180),radians(270),false);ctx.stroke();gradient=ctx.createLinearGradient(this.outline,0,this.outline+this.edge,0);gradient.addColorStop(0,topColor.toString());gradient.addColorStop(1,color.toString());ctx.strokeStyle=gradient;ctx.lineCap="round";ctx.lineWidth=this.edge;ctx.beginPath();ctx.moveTo(this.outline+this.edge/2,minInset);ctx.lineTo(this.outline+this.edge/2,h-minInset);ctx.stroke();gradient=ctx.createLinearGradient(0,h-this.outline,0,h-this.outline-this.edge);gradient.addColorStop(0,bottomColor.toString());gradient.addColorStop(1,color.toString());ctx.strokeStyle=gradient;ctx.lineCap="round";ctx.lineWidth=this.edge;ctx.beginPath();ctx.moveTo(minInset,h-this.outline-this.edge/2);ctx.lineTo(w-minInset,h-this.outline-this.edge/2);ctx.stroke();gradient=ctx.createRadialGradient(w-this.corner,h-this.corner,Math.max(this.corner-this.outline-this.edge,0),w-this.corner,h-this.corner,Math.max(this.corner-this.outline,0));gradient.addColorStop(0,color.toString());gradient.addColorStop(1,bottomColor.toString());ctx.strokeStyle=gradient;ctx.lineCap="round";ctx.lineWidth=this.edge;ctx.beginPath();ctx.arc(w-this.corner,h-this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(0),radians(90),false);ctx.stroke();gradient=ctx.createLinearGradient(w-this.outline,0,w-this.outline-this.edge,0);gradient.addColorStop(0,bottomColor.toString());gradient.addColorStop(1,color.toString());ctx.strokeStyle=gradient;ctx.lineCap="round";ctx.lineWidth=this.edge;ctx.beginPath();ctx.moveTo(w-this.outline-this.edge/2,minInset);ctx.lineTo(w-this.outline-this.edge/2,h-minInset);ctx.stroke()};PushButtonMorph.prototype.outlinePath=BoxMorph.prototype.outlinePath;PushButtonMorph.prototype.createLabel=function(){var shading=!MorphicPreferences.isFlat||this.is3D;if(this.label!==null){this.label.destroy()}if(this.labelString instanceof SymbolMorph){this.label=this.labelString.fullCopy();if(shading){this.label.shadowOffset=this.labelShadowOffset;this.label.shadowColor=this.labelShadowColor}this.label.color=this.labelColor}else{this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,true,false,false,shading?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor)}this.add(this.label)};PushButtonMorph.prototype.updateLabelColors=function(){var shading=!MorphicPreferences.isFlat||this.is3D;if(this.label){this.label.color=this.labelColor;this.label.fontSize=this.fontSize;if(shading){this.label.shadowOffset=this.labelShadowOffset;this.label.shadowColor=this.labelShadowColor}this.label.fixLayout(true)}};PushButtonMorph.prototype.disable=function(){this.isDisabled=true;this.forAllChildren(child=>child.alpha=.3);this.rerender()};PushButtonMorph.prototype.enable=function(){this.isDisabled=false;this.forAllChildren(child=>child.alpha=1);this.rerender()};ToggleButtonMorph.prototype=new PushButtonMorph;ToggleButtonMorph.prototype.constructor=ToggleButtonMorph;ToggleButtonMorph.uber=PushButtonMorph.prototype;ToggleButtonMorph.prototype.contrast=30;ToggleButtonMorph.prototype.labelPressColor=null;function ToggleButtonMorph(colors,target,action,labelString,query,environment,hint,minWidth,hasPreview,isPicture){this.init(colors,target,action,labelString,query,environment,hint,minWidth,hasPreview,isPicture)}ToggleButtonMorph.prototype.init=function(colors,target,action,labelString,query,environment,hint,minWidth,hasPreview,isPicture){this.state=false;this.query=query||(()=>true);this.minWidth=minWidth||null;this.hasPreview=hasPreview||false;this.isPicture=isPicture||false;this.hasNeutralBackground=false;this.trueStateLabel=null;ToggleButtonMorph.uber.init.call(this,target,action,labelString,environment,hint);if(colors){this.color=colors[0];this.highlightColor=colors[1];this.pressColor=colors[2]}this.refresh();this.rerender()};ToggleButtonMorph.prototype.mouseEnter=function(){var contents=this.hint instanceof Function?this.hint():this.hint;if(!this.state||this.hasNeutralBackground){this.userState="highlight";this.rerender()}if(contents){this.bubbleHelp(contents)}};ToggleButtonMorph.prototype.mouseLeave=function(){if(!this.state||this.hasNeutralBackground){this.userState="normal";this.rerender()}if(this.schedule){this.schedule.isActive=false}if(this.hint){this.world().hand.destroyTemporaries()}};ToggleButtonMorph.prototype.mouseDownLeft=function(){if(!this.state){this.userState="pressed";this.rerender()}};ToggleButtonMorph.prototype.mouseClickLeft=function(){if(!this.state){this.userState="highlight";this.rerender()}this.trigger()};ToggleButtonMorph.prototype.trigger=function(){ToggleButtonMorph.uber.trigger.call(this);this.refresh()};ToggleButtonMorph.prototype.refresh=function(){if(typeof this.query==="function"){this.state=this.query.call(this.target)}else{this.state=this.target[this.query]()}if(this.state){this.userState="pressed";if(this.labelPressColor){this.label.setColor(this.labelPressColor)}if(this.trueStateLabel){this.label.hide();this.trueStateLabel.show()}}else{this.userState="normal";if(this.labelPressColor){this.label.setColor(this.labelColor)}if(this.trueStateLabel){this.label.show();this.trueStateLabel.hide()}}this.rerender()};ToggleButtonMorph.prototype.fixLayout=function(){if(this.label!==null){var padding=this.padding*2+this.outline*2+this.edge*2,lw;this.updateLabelColors();lw=Math.max(this.label.width(),this.labelMinExtent.x);this.bounds.setWidth(this.minWidth?Math.max(this.minWidth,lw)+padding:lw+padding);this.bounds.setHeight(Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+padding);this.label.setCenter(this.center());if(this.trueStateLabel){this.trueStateLabel.setCenter(this.center())}if(this.minWidth){this.label.setLeft(this.left()+this.outline+this.edge+this.corner+this.padding)}}};ToggleButtonMorph.prototype.render=function(ctx){switch(this.userState){case"highlight":this.drawOutline(ctx);this.drawBackground(ctx,this.highlightColor);this.drawEdges(ctx,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast));break;case"pressed":this.drawOutline(ctx);this.drawBackground(ctx,this.getPressRenderColor());this.drawEdges(ctx,this.pressColor,this.pressColor.lighter(40),this.pressColor.darker(40));break;default:this.drawOutline(ctx);this.drawBackground(ctx,this.color);this.drawEdges(ctx,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast))}};ToggleButtonMorph.prototype.getPressRenderColor=function(){return this.pressColor};ToggleButtonMorph.prototype.drawEdges=function(ctx,color,topColor,bottomColor){var gradient;ToggleButtonMorph.uber.drawEdges.call(this,ctx,color,topColor,bottomColor);if(this.hasPreview){if(MorphicPreferences.isFlat&&!this.is3D){ctx.fillStyle=this.pressColor.toString();ctx.fillRect(this.outline,this.outline,this.corner,this.height()-this.outline*2);return}gradient=ctx.createLinearGradient(0,0,this.corner,0);gradient.addColorStop(0,this.pressColor.lighter(40).toString());gradient.addColorStop(1,this.pressColor.darker(40).toString());ctx.fillStyle=gradient;ctx.beginPath();this.previewPath(ctx,Math.max(this.corner-this.outline,0),this.outline);ctx.closePath();ctx.fill()}};ToggleButtonMorph.prototype.previewPath=function(ctx,radius,inset){var offset=radius+inset,h=this.height();ctx.arc(offset,offset,radius,radians(-180),radians(-90),false);ctx.arc(offset,h-offset,radius,radians(90),radians(180),false)};ToggleButtonMorph.prototype.createLabel=function(){var shading=!MorphicPreferences.isFlat||this.is3D;if(this.label!==null){this.label.destroy()}if(this.trueStateLabel!==null){this.trueStateLabel.destroy()}if(this.labelString instanceof Array&&this.labelString.length===2){if(this.labelString[0]instanceof SymbolMorph){this.label=this.labelString[0].fullCopy();this.trueStateLabel=this.labelString[1].fullCopy();if(!this.isPicture){this.label.shadowOffset=shading?this.labelShadowOffset:ZERO;this.label.shadowColor=this.labelShadowColor;this.label.color=this.labelColor;this.label.fixLayout();this.label.rerender();this.trueStateLabel.shadowOffset=shading?this.labelShadowOffset:ZERO;this.trueStateLabel.shadowColor=this.labelShadowColor;this.trueStateLabel.color=this.labelColor;this.trueStateLabel.fixLayout();this.trueStateLabel.rerender()}}else if(this.labelString[0]instanceof Morph){this.label=this.labelString[0].fullCopy();this.trueStateLabel=this.labelString[1].fullCopy()}else{this.label=new StringMorph(localize(this.labelString[0]),this.fontSize,this.fontStyle,true,false,false,shading?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor);this.trueStateLabel=new StringMorph(localize(this.labelString[1]),this.fontSize,this.fontStyle,true,false,false,shading?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor)}}else{if(this.labelString instanceof SymbolMorph){this.label=this.labelString.fullCopy();if(!this.isPicture){this.label.shadowOffset=shading?this.labelShadowOffset:ZERO;this.label.shadowColor=this.labelShadowColor;this.label.color=this.labelColor;this.label.fixLayout();this.label.rerender()}}else if(this.labelString instanceof Morph){this.label=this.labelString.fullCopy()}else{this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,true,false,false,shading?this.labelShadowOffset:ZERO,this.labelShadowColor,this.labelColor)}}this.add(this.label);if(this.trueStateLabel){this.add(this.trueStateLabel)}};ToggleButtonMorph.prototype.updateLabelColors=function(){var shading=!MorphicPreferences.isFlat||this.is3D;ToggleButtonMorph.uber.updateLabelColors.call(this);if(this.trueStateLabel){this.trueStateLabel.color=this.labelColor;if(shading){this.trueStateLabel.shadowOffset=this.labelShadowOffset;this.trueStateLabel.shadowColor=this.labelShadowColor}this.trueStateLabel.fixLayout(true)}};TabMorph.prototype=new ToggleButtonMorph;TabMorph.prototype.constructor=TabMorph;TabMorph.uber=ToggleButtonMorph.prototype;function TabMorph(colors,target,action,labelString,query,environment,hint){this.init(colors,target,action,labelString,query,environment,hint)}TabMorph.prototype.fixLayout=function(){if(this.label!==null){this.updateLabelColors();this.setExtent(new Point(this.label.width()+this.padding*2+this.corner*3+this.edge*2,(this.label instanceof StringMorph?this.label.rawHeight():this.label.height())+this.padding*2+this.edge));this.label.setCenter(this.center())}};TabMorph.prototype.refresh=function(){if(this.state){if(this.parent){this.parent.add(this)}}TabMorph.uber.refresh.call(this)};TabMorph.prototype.drawBackground=function(context,color){var w=this.width(),h=this.height(),c=this.corner;context.fillStyle=color.toString();context.beginPath();context.moveTo(0,h);context.bezierCurveTo(c,h,c,0,c*2,0);context.lineTo(w-c*2,0);context.bezierCurveTo(w-c,0,w-c,h,w,h);context.closePath();context.fill()};TabMorph.prototype.drawOutline=function(){nop()};TabMorph.prototype.drawEdges=function(context,color,topColor,bottomColor){if(MorphicPreferences.isFlat&&!this.is3D){return}var w=this.width(),h=this.height(),c=this.corner,e=this.edge,eh=e/2,gradient;nop(color);gradient=context.createLinearGradient(0,0,w,0);gradient.addColorStop(0,topColor.toString());gradient.addColorStop(1,bottomColor.toString());context.strokeStyle=gradient;context.lineCap="round";context.lineWidth=e;context.beginPath();context.moveTo(0,h+eh);context.bezierCurveTo(c,h,c,0,c*2,eh);context.lineTo(w-c*2,eh);context.bezierCurveTo(w-c,0,w-c,h,w,h+eh);context.stroke()};ToggleMorph.prototype=new PushButtonMorph;ToggleMorph.prototype.constructor=ToggleMorph;ToggleMorph.uber=PushButtonMorph.prototype;function ToggleMorph(style,target,action,labelString,query,environment,hint,element,builder){this.init(style,target,action,labelString,query,environment,hint,element,builder)}ToggleMorph.prototype.init=function(style,target,action,labelString,query,environment,hint,element,builder){this.padding=1;style=style||"checkbox";this.corner=style==="checkbox"?0:fontHeight(this.fontSize)/2+this.outline+this.padding;this.state=false;this.query=query||(()=>true);this.tick=null;this.captionString=labelString||null;this.labelAlignment="right";this.element=element||null;this.builder=builder||null;this.toggleElement=null;ToggleMorph.uber.init.call(this,target,action,style==="checkbox"?"✓":"●",environment,hint);this.fixLayout();this.refresh()};ToggleMorph.prototype.fixLayout=function(){var padding=this.padding*2+this.outline*2,y;if(this.tick!==null){this.bounds.setHeight(this.tick.rawHeight()+padding);this.bounds.setWidth(this.tick.width()+padding);this.bounds.setWidth(Math.max(this.width(),this.height()));this.bounds.setHeight(Math.max(this.width(),this.height()));this.tick.setCenter(this.center())}if(this.state){this.tick.show()}else{this.tick.hide()}if(this.toggleElement&&this.labelAlignment==="right"){y=this.top()+(this.height()-this.toggleElement.height())/2;this.toggleElement.setPosition(new Point(this.right()+padding,y))}if(this.label!==null){y=this.top()+(this.height()-this.label.height())/2;if(this.labelAlignment==="right"){this.label.setPosition(new Point(this.toggleElement?this.toggleElement instanceof ToggleElementMorph?this.toggleElement.right():this.toggleElement.right()+padding:this.right()+padding,y))}else{this.label.setPosition(new Point(this.left()-this.label.width()-padding,y))}}};ToggleMorph.prototype.createLabel=function(){var shading=!MorphicPreferences.isFlat||this.is3D;if(this.label===null){if(this.captionString){this.label=new TextMorph(localize(this.captionString),this.fontSize,this.fontStyle,true);this.add(this.label)}}if(this.tick===null){this.tick=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,true,false,false,shading?new Point(1,1):null,new Color(240,240,240));this.add(this.tick)}if(this.toggleElement===null){if(this.element){if(this.element instanceof Morph){if(this.element.isTemplate){this.toggleElement=this.element;if(!this.element.mouseDownLeft){this.element.mouseDownLeft=nop}}else{this.toggleElement=new ToggleElementMorph(this.target,this.action,this.element,this.query,this.environment,this.hint,this.builder)}}else if(this.element instanceof HTMLCanvasElement){this.toggleElement=new Morph;this.toggleElement.isCachingImage=true;this.toggleElement.bounds.setExtent(new Point(this.element.width,this.element.height));this.toggleElement.cachedImage=this.element}this.add(this.toggleElement)}}};ToggleMorph.prototype.trigger=function(){ToggleMorph.uber.trigger.call(this);this.refresh()};ToggleMorph.prototype.refresh=function(){if(typeof this.query==="function"){this.state=this.query.call(this.target)}else{this.state=this.target[this.query]()}if(this.state){this.tick.show()}else{this.tick.hide()}if(this.toggleElement&&this.toggleElement.refresh&&!this.toggleElement.isToggleLabel){this.toggleElement.refresh()}};ToggleMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this);if(this.tick){this.tick.setCenter(this.center().add(1))}};ToggleMorph.prototype.mouseClickLeft=function(){PushButtonMorph.uber.mouseClickLeft.call(this);if(this.tick){this.tick.setCenter(this.center())}};ToggleMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this);if(this.tick){this.tick.setCenter(this.center())}};ToggleElementMorph.prototype=new TriggerMorph;ToggleElementMorph.prototype.constructor=ToggleElementMorph;ToggleElementMorph.uber=TriggerMorph.prototype;ToggleElementMorph.prototype.contrast=50;ToggleElementMorph.prototype.shadowOffset=new Point(2,2);ToggleElementMorph.prototype.shadowAlpha=.6;ToggleElementMorph.prototype.fontSize=10;ToggleElementMorph.prototype.inactiveColor=new Color(180,180,180);function ToggleElementMorph(target,action,element,query,environment,hint,builder,labelString){this.init(target,action,element,query,environment,hint,builder,labelString)}ToggleElementMorph.prototype.init=function(target,action,element,query,environment,hint,builder,labelString){this.target=target||null;this.action=action||null;this.element=element;this.query=query||(()=>true);this.environment=environment||null;this.hint=hint||null;this.builder=builder||"nop";this.captionString=labelString||null;this.labelAlignment="right";this.state=false;TriggerMorph.uber.init.call(this);this.color=element.color;this.createLabel()};ToggleElementMorph.prototype.render=function(ctx){var shading=!MorphicPreferences.isFlat||this.is3D,shadow=()=>{if(shading){this.element.addShadow(this.shadowOffset,this.userState==="normal"?0:this.shadowAlpha)}};this.color=this.element.color;this.element.removeShadow();this.element[this.builder]();if(this.userState!=="pressed"){this.element.removeShadow();this.element.setColor(this.inactiveColor);this.element[this.builder](this.contrast);if(this.userState==="highlight"){this.element.removeShadow();this.element.setColor(this.color.lighter(this.contrast));this.element[this.builder](this.contrast)}}if(this.element.doWithAlpha){ctx.drawImage(this.element.doWithAlpha(1,()=>{shadow();return this.element.fullImage()}),0,0)}else{shadow();ctx.drawImage(this.element.fullImage(),0,0)}this.element.removeShadow();this.element.setColor(this.color);this.element[this.builder]()};ToggleElementMorph.prototype.setColor=function(aColor){this.element.setColor(aColor);this.fixLayout();this.refresh()};ToggleElementMorph.prototype.fixLayout=function(){this.element.fixLayout();this.bounds.setExtent(this.element.fullBounds().extent().add(this.shadowBlur*2))};ToggleElementMorph.prototype.createLabel=function(){var y;if(this.captionString){this.label=new StringMorph(this.captionString,this.fontSize,this.fontStyle,true);this.add(this.label);y=this.top()+(this.height()-this.label.height())/2;if(this.labelAlignment==="right"){this.label.setPosition(new Point(this.right(),y))}else{this.label.setPosition(new Point(this.left()-this.label.width(),y))}}};ToggleElementMorph.prototype.trigger=ToggleButtonMorph.prototype.trigger;ToggleElementMorph.prototype.refresh=ToggleButtonMorph.prototype.refresh;ToggleElementMorph.prototype.mouseEnter=ToggleButtonMorph.prototype.mouseEnter;ToggleElementMorph.prototype.mouseLeave=ToggleButtonMorph.prototype.mouseLeave;ToggleElementMorph.prototype.mouseDownLeft=ToggleButtonMorph.prototype.mouseDownLeft;ToggleElementMorph.prototype.mouseClickLeft=ToggleButtonMorph.prototype.mouseClickLeft;DialogBoxMorph.prototype=new Morph;DialogBoxMorph.prototype.constructor=DialogBoxMorph;DialogBoxMorph.uber=Morph.prototype;DialogBoxMorph.prototype.fontSize=12;DialogBoxMorph.prototype.titleFontSize=14;DialogBoxMorph.prototype.fontStyle="sans-serif";DialogBoxMorph.prototype.color=PushButtonMorph.prototype.color;DialogBoxMorph.prototype.titleTextColor=WHITE;DialogBoxMorph.prototype.titleBarColor=PushButtonMorph.prototype.pressColor;DialogBoxMorph.prototype.contrast=40;DialogBoxMorph.prototype.corner=12;DialogBoxMorph.prototype.padding=14;DialogBoxMorph.prototype.titlePadding=6;DialogBoxMorph.prototype.buttonContrast=50;DialogBoxMorph.prototype.buttonFontSize=12;DialogBoxMorph.prototype.buttonCorner=12;DialogBoxMorph.prototype.buttonEdge=6;DialogBoxMorph.prototype.buttonPadding=0;DialogBoxMorph.prototype.buttonOutline=3;DialogBoxMorph.prototype.buttonOutlineColor=PushButtonMorph.prototype.color;DialogBoxMorph.prototype.buttonOutlineGradient=true;DialogBoxMorph.prototype.instances={};function DialogBoxMorph(target,action,environment){this.init(target,action,environment)}DialogBoxMorph.prototype.init=function(target,action,environment){this.is3D=false;this.target=target||null;this.action=action||null;this.environment=environment||null;this.key=null;this.labelString=null;this.label=null;this.head=null;this.body=null;this.buttons=null;DialogBoxMorph.uber.init.call(this);this.isDraggable=true;this.noDropShadow=true;this.fullShadowSource=false;this.color=PushButtonMorph.prototype.color;this.createLabel();this.createButtons();this.setExtent(new Point(300,150))};DialogBoxMorph.prototype.inform=function(title,textString,world,pic){var txt=new TextMorph(textString,this.fontSize,this.fontStyle,true,false,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE);if(!this.key){this.key="inform"+title+textString}txt.enableLinks=true;this.labelString=title;this.createLabel();if(pic){this.setPicture(pic)}if(textString){this.addBody(txt)}this.addButton("ok","OK");this.fixLayout();this.popUp(world)};DialogBoxMorph.prototype.askYesNo=function(title,textString,world,pic){var txt=new TextMorph(textString,this.fontSize,this.fontStyle,true,false,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE);if(!this.key){this.key="decide"+title+textString}this.labelString=title;this.createLabel();if(pic){this.setPicture(pic)}this.addBody(txt);this.addButton("ok","Yes");this.addButton("cancel","No");this.fixLayout();this.popUp(world)};DialogBoxMorph.prototype.prompt=function(title,defaultString,world,pic,choices,isReadOnly,isNumeric,sliderMin,sliderMax,sliderAction,decimals=2){var sld,head,precision=Math.pow(10,decimals),txt=new InputFieldMorph(defaultString,isNumeric||false,choices||null,choices?isReadOnly||false:false);txt.setWidth(250);if(isNumeric){if(pic){head=new AlignmentMorph("column",this.padding);pic.setPosition(head.position());head.add(pic)}if(!isNil(sliderMin)&&!isNil(sliderMax)){sld=new SliderMorph(sliderMin*precision,sliderMax*precision,parseFloat(defaultString)*precision,(sliderMax-sliderMin)/10*precision,"horizontal");sld.alpha=1;sld.color=this.color.lighter(50);sld.setHeight(txt.height()*.7);sld.setWidth(txt.width());sld.action=num=>{if(sliderAction){sliderAction(num/precision)}txt.setContents(num/precision);txt.edit()};if(!head){head=new AlignmentMorph("column",this.padding)}head.add(sld)}if(head){head.fixLayout();this.setPicture(head);head.fixLayout()}}else{if(pic){this.setPicture(pic)}}this.reactToChoice=function(inp){if(sld){sld.value=inp*precision;sld.fixLayout();sld.rerender()}if(sliderAction){sliderAction(inp)}};txt.reactToInput=function(){var inp=txt.getValue();if(sld){inp=Math.max(inp,sliderMin);sld.value=inp*precision;sld.fixLayout();sld.rerender()}if(sliderAction){sliderAction(inp)}};this.labelString=title;this.createLabel();if(!this.key){this.key="prompt"+title+defaultString}this.addBody(txt);txt.fixLayout();this.addButton("ok","OK");this.addButton("cancel","Cancel");this.fixLayout();this.popUp(world)};DialogBoxMorph.prototype.promptCode=function(title,defaultString,world,pic,instructions){var frame=new ScrollFrameMorph,text=new TextMorph(defaultString||""),bdy=new AlignmentMorph("column",this.padding),size=pic?Math.max(pic.width,400):400;this.getInput=function(){return text.text};function remarkText(string){return new TextMorph(localize(string),10,null,false,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE)}frame.padding=6;frame.setWidth(size);frame.acceptsDrops=false;frame.contents.acceptsDrops=false;text.fontName="monospace";text.fontStyle="monospace";text.fontSize=11;text.setPosition(frame.topLeft().add(frame.padding));text.enableSelecting();text.isEditable=true;frame.setHeight(size/4);frame.fixLayout=nop;frame.edge=InputFieldMorph.prototype.edge;frame.fontSize=InputFieldMorph.prototype.fontSize;frame.typeInPadding=InputFieldMorph.prototype.typeInPadding;frame.contrast=InputFieldMorph.prototype.contrast;frame.render=InputFieldMorph.prototype.render;frame.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;frame.addContents(text);text.fixLayout();if(pic){this.setPicture(pic)}this.labelString=title;this.createLabel();if(!this.key){this.key="promptCode"+title+defaultString}bdy.setColor(this.color);bdy.add(frame);if(instructions){bdy.add(remarkText(instructions))}bdy.fixLayout();this.addBody(bdy);this.addButton("ok","OK");this.addButton("cancel","Cancel");this.fixLayout();this.popUp(world);text.edit()};DialogBoxMorph.prototype.promptVector=function(title,point,deflt,xLabel,yLabel,world,pic,msg){var vec=new AlignmentMorph("row",4),xInp=new InputFieldMorph(point.x.toString(),true),yInp=new InputFieldMorph(point.y.toString(),true),xCol=new AlignmentMorph("column",2),yCol=new AlignmentMorph("column",2),inp=new AlignmentMorph("column",2),bdy=new AlignmentMorph("column",this.padding);function labelText(string){return new TextMorph(localize(string),10,null,false,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE)}inp.alignment="left";inp.setColor(this.color);bdy.setColor(this.color);xCol.alignment="left";xCol.setColor(this.color);yCol.alignment="left";yCol.setColor(this.color);xCol.add(labelText(xLabel));xCol.add(xInp);yCol.add(labelText(yLabel));yCol.add(yInp);vec.add(xCol);vec.add(yCol);inp.add(vec);if(msg){bdy.add(labelText(msg))}bdy.add(inp);vec.fixLayout();xCol.fixLayout();yCol.fixLayout();inp.fixLayout();bdy.fixLayout();this.labelString=title;this.createLabel();if(pic){this.setPicture(pic)}this.addBody(bdy);this.addButton("ok","OK");if(deflt instanceof Point){this.addButton(()=>{xInp.setContents(deflt.x.toString());yInp.setContents(deflt.y.toString())},"Default")}this.addButton("cancel","Cancel");this.fixLayout();this.edit=function(){xInp.edit()};this.getInput=function(){return new Point(xInp.getValue(),yInp.getValue())};if(!this.key){this.key="vector"+title}this.popUp(world)};DialogBoxMorph.prototype.promptRGB=function(title,color,world,pic,msg){var clr=new AlignmentMorph("row",4),iw=this.fontSize*4,rInp=new InputFieldMorph(color.r.toString(),true),gInp=new InputFieldMorph(color.g.toString(),true),bInp=new InputFieldMorph(color.b.toString(),true),rCol=new AlignmentMorph("column",2),gCol=new AlignmentMorph("column",2),bCol=new AlignmentMorph("column",2),inp=new AlignmentMorph("column",2),bdy=new AlignmentMorph("column",this.padding);function labelText(string){return new TextMorph(localize(string),10,null,false,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE)}function constrain(num){return Math.max(0,Math.min(num,255))}rInp.contents().minWidth=iw;rInp.setWidth(iw);gInp.contents().minWidth=iw;gInp.setWidth(iw);bInp.contents().minWidth=iw;bInp.setWidth(iw);inp.alignment="left";inp.setColor(this.color);bdy.setColor(this.color);rCol.alignment="left";rCol.setColor(this.color);gCol.alignment="left";gCol.setColor(this.color);bCol.alignment="left";bCol.setColor(this.color);rCol.add(labelText("red"));rCol.add(rInp);gCol.add(labelText("green"));gCol.add(gInp);bCol.add(labelText("blue"));bCol.add(bInp);clr.add(rCol);clr.add(gCol);clr.add(bCol);inp.add(clr);if(msg){bdy.add(labelText(msg))}bdy.add(inp);clr.fixLayout();rCol.fixLayout();gCol.fixLayout();bCol.fixLayout();inp.fixLayout();bdy.fixLayout();this.labelString=title;this.createLabel();if(pic){this.setPicture(pic)}this.addBody(bdy);this.addButton("ok","OK");this.addButton("cancel","Cancel");this.fixLayout();this.edit=function(){rInp.edit()};this.getInput=function(){return new Color(constrain(rInp.getValue()),constrain(gInp.getValue()),constrain(bInp.getValue()))};if(!this.key){this.key="RGB"+title}this.popUp(world)};DialogBoxMorph.prototype.promptCategory=function(title,name,color,world,pic,msg){var row=new AlignmentMorph("row",4),field=new InputFieldMorph(name),picker=new BoxMorph(2,1),inp=new AlignmentMorph("column",2),bdy=new AlignmentMorph("column",this.padding),side;function labelText(string){return new TextMorph(localize(string),10,null,false,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE)}field.setWidth(160);side=field.height()*.8;picker.setExtent(new Point(side,side));picker.setColor(color);picker.mouseClickLeft=()=>{var hand=world.hand,posInDocument=getDocumentPositionOf(world.worldCanvas),mouseMoveBak=hand.processMouseMove,mouseDownBak=hand.processMouseDown,mouseUpBak=hand.processMouseUp,pal=new ColorPaletteMorph(null,new Point(160,100));world.add(pal);pal.setPosition(picker.topRight().add(new Point(this.edge,0)));hand.processMouseMove=event=>{var clr=world.getGlobalPixelColor(hand.position());hand.setPosition(new Point(event.pageX-posInDocument.x,event.pageY-posInDocument.y));if(!clr.a){return}picker.setColor(clr)};hand.processMouseDown=nop;hand.processMouseUp=()=>{pal.destroy();hand.processMouseMove=mouseMoveBak;hand.processMouseDown=mouseDownBak;hand.processMouseUp=mouseUpBak}};picker.mouseClickRight=()=>{new DialogBoxMorph(this,clr=>picker.setColor(clr),this).promptRGB("Category color",picker.color,this.world(),null,null)};inp.alignment="left";inp.setColor(this.color);bdy.setColor(this.color);row.setColor(this.color);row.add(field);row.add(picker);inp.add(row);if(msg){bdy.add(labelText(msg))}bdy.add(inp);row.fixLayout();field.fixLayout();picker.fixLayout();inp.fixLayout();bdy.fixLayout();this.labelString=title;this.createLabel();if(pic){this.setPicture(pic)}this.addBody(bdy);this.addButton("ok","OK");this.addButton("cancel","Cancel");this.fixLayout();this.edit=function(){field.edit()};this.getInput=function(){return{name:field.getValue(),color:picker.color.copy()}};if(!this.key){this.key="category"+title}this.popUp(world)};DialogBoxMorph.prototype.promptCredentials=function(title,purpose,tosURL,tosLabel,prvURL,prvLabel,checkBoxLabel,world,pic,msg){var usr=new InputFieldMorph,bmn,byr,emlLabel,eml=new InputFieldMorph,pw1=new InputFieldMorph,pw2=new InputFieldMorph,opw=new InputFieldMorph,agree=false,chk,dof=new AlignmentMorph("row",4),mCol=new AlignmentMorph("column",2),yCol=new AlignmentMorph("column",2),inp=new AlignmentMorph("column",2),lnk=new AlignmentMorph("row",4),bdy=new AlignmentMorph("column",this.padding),years={},currentYear=(new Date).getFullYear(),firstYear=currentYear-20,myself=this;function labelText(string){return new TextMorph(localize(string),10,null,false,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE)}function linkButton(label,url){var btn=new PushButtonMorph(myself,()=>window.open(url),"  "+localize(label)+"  ");btn.fontSize=10;btn.corner=myself.buttonCorner;btn.edge=myself.buttonEdge;btn.outline=myself.buttonOutline;btn.outlineColor=myself.buttonOutlineColor;btn.outlineGradient=myself.buttonOutlineGradient;btn.padding=myself.buttonPadding;btn.contrast=myself.buttonContrast;btn.fixLayout();return btn}function age(){var today=(new Date).getFullYear()+(new Date).getMonth()/12,year=+byr.getValue()||0,monthName=bmn.getValue(),month,birthday;if(monthName instanceof Array){monthName=monthName[0]}if(isNaN(year)){year=0}month=["January","February","March","April","May","June","July","August","September","October","November","December"].indexOf(monthName);if(isNaN(month)){month=0}birthday=year+month/12;return today-birthday}bmn=new InputFieldMorph(null,false,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},true);for(currentYear;currentYear>firstYear;currentYear-=1){years[currentYear.toString()+" "]=currentYear}years[firstYear+" "+localize("or before")]="< "+currentYear;byr=new InputFieldMorph(null,false,years,true);inp.alignment="left";inp.setColor(this.color);bdy.setColor(this.color);mCol.alignment="left";mCol.setColor(this.color);yCol.alignment="left";yCol.setColor(this.color);usr.setWidth(200);bmn.setWidth(100);byr.contents().minWidth=80;byr.setWidth(80);eml.setWidth(200);pw1.setWidth(200);pw2.setWidth(200);opw.setWidth(200);pw1.contents().text.toggleIsPassword();pw2.contents().text.toggleIsPassword();opw.contents().text.toggleIsPassword();if(purpose==="login"){inp.add(labelText("User name:"));inp.add(usr)}if(purpose==="signup"){inp.add(labelText("User name:"));inp.add(usr);mCol.add(labelText("Birth date:"));mCol.add(bmn);yCol.add(labelText("year:"));yCol.add(byr);dof.add(mCol);dof.add(yCol);inp.add(dof);emlLabel=labelText("foo");inp.add(emlLabel);inp.add(eml);inp.add(labelText("Password:"));inp.add(pw1);inp.add(labelText("Repeat Password:"));inp.add(pw2)}if(purpose==="login"){inp.add(labelText("Password:"));inp.add(pw1)}if(purpose==="changePassword"){inp.add(labelText("Old password:"));inp.add(opw);inp.add(labelText("New password:"));inp.add(pw1);inp.add(labelText("Repeat new password:"));inp.add(pw2)}if(purpose==="resetPassword"||purpose==="resendVerification"){inp.add(labelText("User name:"));inp.add(usr)}if(msg){bdy.add(labelText(msg))}bdy.add(inp);if(tosURL||prvURL){bdy.add(lnk)}if(tosURL){lnk.add(linkButton(tosLabel,tosURL))}if(prvURL){lnk.add(linkButton(prvLabel,prvURL))}if(checkBoxLabel){chk=new ToggleMorph("checkbox",this,()=>agree=!agree,checkBoxLabel,()=>agree);chk.edge=this.buttonEdge/2;chk.outline=this.buttonOutline/2;chk.outlineColor=this.buttonOutlineColor;chk.outlineGradient=this.buttonOutlineGradient;chk.contrast=this.buttonContrast;chk.fixLayout();bdy.add(chk)}dof.fixLayout();mCol.fixLayout();yCol.fixLayout();inp.fixLayout();lnk.fixLayout();bdy.fixLayout();this.labelString=title;this.createLabel();if(pic){this.setPicture(pic)}this.addBody(bdy);this.addButton("ok","OK");this.addButton("cancel","Cancel");this.fixLayout();function validInputs(){var checklist,empty,em=eml.getValue();function indicate(morph,string){var bubble=new SpeechBubbleMorph(localize(string));bubble.isPointingRight=false;bubble.fixLayout();bubble.popUp(world,morph.leftCenter().subtract(new Point(bubble.width()+2,0)));if(morph.edit){morph.edit()}}if(purpose==="login"){checklist=[usr,pw1]}else if(purpose==="signup"){checklist=[usr,bmn,byr,eml,pw1,pw2]}else if(purpose==="changePassword"){checklist=[opw,pw1,pw2]}else if(purpose==="resetPassword"||purpose==="resendVerification"){checklist=[usr]}empty=detect(checklist,inp=>!inp.getValue());if(empty){indicate(empty,"please fill out\nthis field");return false}if(purpose==="signup"){if(usr.getValue().length<4){indicate(usr,"User name must be four\ncharacters or longer");return false}if(em.indexOf(" ")>-1||em.indexOf("@")===-1||em.indexOf(".")===-1||em.length<5){indicate(eml,"please provide a valid\nemail address");return false}}if(purpose==="changePassword"||purpose==="signup"){if(pw1.getValue().length<6){indicate(pw1,"password must be six\ncharacters or longer");return false}if(pw1.getValue()!==pw2.getValue()){indicate(pw2,"passwords do\nnot match");return false}}if(purpose==="signup"){if(!agree){indicate(chk,"please agree to\nthe TOS");return false}}return true}this.accept=function(){if(validInputs()){DialogBoxMorph.prototype.accept.call(myself)}};this.edit=function(){if(purpose==="changePassword"){opw.edit()}else{usr.edit()}};this.getInput=function(){return{username:usr.getValue(),email:eml.getValue(),oldpassword:opw.getValue(),password:pw1.getValue(),passwordRepeat:pw2.getValue(),choice:agree}};this.reactToChoice=function(){if(purpose==="signup"){emlLabel.changed();emlLabel.text=age()<=13?"E-mail address of parent or guardian:":"E-mail address:";emlLabel.text=localize(emlLabel.text);emlLabel.fixLayout();emlLabel.rerender()}};this.reactToChoice();if(!this.key){this.key="credentials"+title+purpose}this.popUp(world)};DialogBoxMorph.prototype.accept=function(){if(this.action){if(typeof this.target==="function"){if(typeof this.action==="function"){this.target.call(this.environment,this.action.call())}else{this.target.call(this.environment,this.action)}}else{if(typeof this.action==="function"){this.action.call(this.target,this.getInput())}else{this.target[this.action](this.getInput())}}}this.destroy()};DialogBoxMorph.prototype.withKey=function(key){this.key=key;return this};DialogBoxMorph.prototype.popUp=function(world){if(world){if(this.key){if(this.instances[world.stamp]){if(this.instances[world.stamp][this.key]){this.instances[world.stamp][this.key].destroy()}this.instances[world.stamp][this.key]=this}else{this.instances[world.stamp]={};this.instances[world.stamp][this.key]=this}}world.add(this);world.keyboardFocus=this;this.setCenter(world.center());this.edit()}};DialogBoxMorph.prototype.destroy=function(){DialogBoxMorph.uber.destroy.call(this);if(this.key){delete this.instances[this.key]}};DialogBoxMorph.prototype.ok=function(){this.accept()};DialogBoxMorph.prototype.cancel=function(){this.destroy()};DialogBoxMorph.prototype.edit=function(){this.children.forEach(c=>{if(c.edit){c.edit()}})};DialogBoxMorph.prototype.getInput=function(){if(this.body instanceof InputFieldMorph){return this.body.getValue()}return null};DialogBoxMorph.prototype.justDropped=function(hand){hand.world.keyboardFocus=this;this.edit()};DialogBoxMorph.prototype.destroy=function(){var world=this.world();world.keyboardFocus=null;world.hand.destroyTemporaries();DialogBoxMorph.uber.destroy.call(this)};DialogBoxMorph.prototype.normalizeSpaces=function(string){var ans="",i,c,flag=false;for(i=0;i<string.length;i+=1){c=string[i];if(c===" "){if(flag){ans+=c;flag=false}}else{ans+=c;flag=true}}return ans.trim()};DialogBoxMorph.prototype.createLabel=function(){var shading=!MorphicPreferences.isFlat||this.is3D;if(this.label){this.label.destroy()}if(this.labelString){this.label=new StringMorph(localize(this.labelString),this.titleFontSize,this.fontStyle,true,false,false,shading?new Point(2,1):null,this.titleBarColor.darker(this.contrast));this.label.color=this.titleTextColor;this.label.fixLayout();this.add(this.label)}};DialogBoxMorph.prototype.createButtons=function(){if(this.buttons){this.buttons.destroy()}this.buttons=new AlignmentMorph("row",this.padding);this.add(this.buttons)};DialogBoxMorph.prototype.addButton=function(action,label){var button=new PushButtonMorph(this,action||"ok","  "+localize(label||"OK")+"  ");button.fontSize=this.buttonFontSize;button.corner=this.buttonCorner;button.edge=this.buttonEdge;button.outline=this.buttonOutline;button.outlineColor=this.buttonOutlineColor;button.outlineGradient=this.buttonOutlineGradient;button.padding=this.buttonPadding;button.contrast=this.buttonContrast;button.fixLayout();this.buttons.add(button);return button};DialogBoxMorph.prototype.setPicture=function(aMorphOrCanvas){var morph;if(aMorphOrCanvas instanceof Morph){morph=aMorphOrCanvas}else{morph=new Morph;morph.isCachingImage=true;morph.cachedImage=aMorphOrCanvas;morph.bounds.setWidth(aMorphOrCanvas.width);morph.bounds.setHeight(aMorphOrCanvas.height)}this.addHead(morph)};DialogBoxMorph.prototype.addHead=function(aMorph){if(this.head){this.head.destroy()}this.head=aMorph;this.add(this.head)};DialogBoxMorph.prototype.addBody=function(aMorph){if(this.body){this.body.destroy()}this.body=aMorph;this.add(this.body)};DialogBoxMorph.prototype.fixLayout=function(){var th=fontHeight(this.titleFontSize)+this.titlePadding*2,w;if(this.head){this.head.setPosition(this.position().add(new Point(this.padding,th+this.padding)));this.bounds.setWidth(this.head.width()+this.padding*2);this.bounds.setHeight(this.head.height()+this.padding*2+th)}if(this.body){if(this.head){this.body.setPosition(this.head.bottomLeft().add(new Point(0,this.padding)));this.bounds.setWidth(Math.max(this.width(),this.body.width()+this.padding*2));this.bounds.setHeight(this.height()+this.body.height()+this.padding);w=this.width();this.head.setLeft(this.left()+Math.round((w-this.head.width())/2));this.body.setLeft(this.left()+Math.round((w-this.body.width())/2))}else{this.body.setPosition(this.position().add(new Point(this.padding,th+this.padding)));this.bounds.setWidth(this.body.width()+this.padding*2);this.bounds.setHeight(this.body.height()+this.padding*2+th)}}if(this.label){this.label.setCenter(this.center());this.label.setTop(this.top()+(th-this.label.height())/2)}if(this.buttons&&this.buttons.children.length>0){this.buttons.fixLayout();this.bounds.setHeight(this.height()+this.buttons.height()+this.padding);this.bounds.setWidth(Math.max(this.width(),this.buttons.width()+2*this.padding));this.buttons.setCenter(this.center());this.buttons.setBottom(this.bottom()-this.padding)}this.removeShadow();this.addShadow()};DialogBoxMorph.prototype.processKeyPress=nop;DialogBoxMorph.prototype.processKeyDown=function(event){switch(event.keyCode){case 13:this.ok();break;case 27:this.cancel();break;default:nop()}};DialogBoxMorph.prototype.render=function(ctx){var gradient,w=this.width(),h=this.height(),th=Math.floor(fontHeight(this.titleFontSize)+this.titlePadding*2),shift=this.corner/2,x,y,isFlat=MorphicPreferences.isFlat&&!this.is3D;if(isFlat){ctx.fillStyle=this.titleBarColor.toString()}else{gradient=ctx.createLinearGradient(0,0,0,th);gradient.addColorStop(0,this.titleBarColor.lighter(this.contrast/2).toString());gradient.addColorStop(1,this.titleBarColor.darker(this.contrast).toString());ctx.fillStyle=gradient}ctx.beginPath();this.outlinePathTitle(ctx,isFlat?0:this.corner);ctx.closePath();ctx.fill();ctx.fillStyle=this.color.toString();ctx.beginPath();this.outlinePathBody(ctx,isFlat?0:this.corner);ctx.closePath();ctx.fill();if(isFlat){return}gradient=ctx.createLinearGradient(0,h-this.corner,0,h);gradient.addColorStop(0,this.color.toString());gradient.addColorStop(1,this.color.darker(this.contrast.toString()));ctx.lineWidth=this.corner;ctx.lineCap="round";ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(this.corner,h-shift);ctx.lineTo(this.corner+1,h-shift);ctx.stroke();gradient=ctx.createLinearGradient(0,h-this.corner,0,h);gradient.addColorStop(0,this.color.toString());gradient.addColorStop(1,this.color.darker(this.contrast.toString()));ctx.lineWidth=this.corner;ctx.lineCap="butt";ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(this.corner,h-shift);ctx.lineTo(w-this.corner,h-shift);ctx.stroke();gradient=ctx.createLinearGradient(w-this.corner,0,w,0);gradient.addColorStop(0,this.color.toString());gradient.addColorStop(1,this.color.darker(this.contrast).toString());ctx.lineWidth=this.corner;ctx.lineCap="butt";ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(w-shift,th);ctx.lineTo(w-shift,h-this.corner);ctx.stroke();x=w-this.corner;y=h-this.corner;gradient=ctx.createRadialGradient(x,y,0,x,y,this.corner);gradient.addColorStop(0,this.color.toString());gradient.addColorStop(1,this.color.darker(this.contrast.toString()));ctx.lineCap="butt";ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(x,y,shift,radians(90),radians(0),true);ctx.stroke();gradient=ctx.createLinearGradient(0,0,this.corner,0);gradient.addColorStop(0,this.color.lighter(this.contrast).toString());gradient.addColorStop(1,this.color.toString());ctx.lineCap="butt";ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,th);ctx.lineTo(shift,h-this.corner*2);ctx.stroke();gradient=ctx.createLinearGradient(0,0,this.corner,0);gradient.addColorStop(0,this.color.lighter(this.contrast).toString());gradient.addColorStop(1,this.color.toString());ctx.lineCap="round";ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,h-this.corner*2);ctx.lineTo(shift,h-this.corner-shift);ctx.stroke()};DialogBoxMorph.prototype.outlinePathTitle=function(ctx,radius){var w=this.width(),h=Math.ceil(fontHeight(this.titleFontSize))+this.titlePadding*2;ctx.arc(radius,radius,radius,radians(-180),radians(-90),false);ctx.arc(w-radius,radius,radius,radians(-90),radians(-0),false);ctx.lineTo(w,h);ctx.lineTo(0,h)};DialogBoxMorph.prototype.outlinePathBody=function(ctx,radius){var w=this.width(),h=this.height(),th=Math.floor(fontHeight(this.titleFontSize))+this.titlePadding*2;ctx.moveTo(0,th);ctx.lineTo(w,th);ctx.arc(w-radius,h-radius,radius,radians(0),radians(90),false);ctx.arc(radius,h-radius,radius,radians(90),radians(180),false)};AlignmentMorph.prototype=new Morph;AlignmentMorph.prototype.constructor=AlignmentMorph;AlignmentMorph.uber=Morph.prototype;function AlignmentMorph(orientation,padding){this.init(orientation,padding)}AlignmentMorph.prototype.init=function(orientation,padding){this.orientation=orientation||"row";this.alignment="center";this.padding=padding||0;this.respectHiddens=false;AlignmentMorph.uber.init.call(this)};AlignmentMorph.prototype.render=function(ctx){nop(ctx)};AlignmentMorph.prototype.fixLayout=function(){var last=null,newBounds;if(this.children.length===0){return null}this.children.forEach(c=>{var cfb=c.fullBounds(),lfb;if(c.isVisible||this.respectHiddens){if(last){lfb=last.fullBounds();if(this.orientation==="row"){c.setPosition(lfb.topRight().add(new Point(this.padding,(lfb.height()-cfb.height())/2)))}else{c.setPosition(lfb.bottomLeft().add(new Point(this.alignment==="center"?(lfb.width()-cfb.width())/2:0,this.padding)))}cfb=c.fullBounds();newBounds=newBounds.merge(cfb)}else{newBounds=cfb}last=c}});this.bounds=newBounds};InputFieldMorph.prototype=new Morph;InputFieldMorph.prototype.constructor=InputFieldMorph;InputFieldMorph.uber=Morph.prototype;InputFieldMorph.prototype.edge=2;InputFieldMorph.prototype.fontSize=12;InputFieldMorph.prototype.typeInPadding=2;InputFieldMorph.prototype.contrast=65;function InputFieldMorph(text,isNumeric,choiceDict,isReadOnly){this.init(text,isNumeric,choiceDict,isReadOnly)}InputFieldMorph.prototype.init=function(text,isNumeric,choiceDict,isReadOnly){var contents=new StringFieldMorph(text||"",null,null,null,null,null,isNumeric||false),arrow=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));this.choices=choiceDict||null;this.isReadOnly=isReadOnly||false;this.isNumeric=isNumeric||false;contents.alpha=0;contents.fontSize=this.fontSize;contents.fixLayout();this.oldContentsExtent=contents.extent();InputFieldMorph.uber.init.call(this);this.color=WHITE;this.add(contents);this.add(arrow);contents.isDraggable=false;this.fixLayout()};InputFieldMorph.prototype.contents=function(){return detect(this.children,child=>child instanceof StringFieldMorph)};InputFieldMorph.prototype.arrow=function(){return detect(this.children,child=>child instanceof ArrowMorph)};InputFieldMorph.prototype.setChoice=function(aStringOrFloat){this.setContents(aStringOrFloat);this.escalateEvent("reactToChoice",aStringOrFloat)};InputFieldMorph.prototype.setContents=function(aStringOrFloat){var cnts=this.contents();cnts.text.text=aStringOrFloat;if(aStringOrFloat===undefined){return null}if(aStringOrFloat===null){cnts.text.text=""}else if(aStringOrFloat.toString){cnts.text.text=aStringOrFloat.toString()}cnts.text.fixLayout();cnts.changed();cnts.fixLayout();cnts.rerender()};InputFieldMorph.prototype.edit=function(){var c=this.contents();c.text.edit();c.text.selectAll()};InputFieldMorph.prototype.setIsNumeric=function(bool){var value;this.isNumeric=bool;this.contents().isNumeric=bool;this.contents().text.isNumeric=bool;value=this.getValue();if(this.isNumeric){value=parseFloat(value);if(isNaN(value)){value=null}}this.setContents(value)};InputFieldMorph.prototype.dropDownMenu=function(){var choices=this.choices,key,menu=new MenuMorph(this.setChoice,null,this,this.fontSize);if(choices instanceof Function){choices=choices.call(this)}else if(isString(choices)){choices=this[choices]()}if(!choices){return null}menu.addItem(" ",null);if(choices instanceof Array){choices.forEach(choice=>menu.addItem(choice[0],choice[1]))}else{for(key in choices){if(Object.prototype.hasOwnProperty.call(choices,key)){if(key[0]==="~"){menu.addLine()}else{menu.addItem(key,choices[key])}}}}if(menu.items.length>0){menu.popUpAtHand(this.world())}else{return null}};InputFieldMorph.prototype.fixLayout=function(){var contents=this.contents(),arrow=this.arrow();if(!contents){return null}contents.isNumeric=this.isNumeric;contents.isEditable=!this.isReadOnly;if(this.choices){arrow.setSize(this.fontSize);arrow.show()}else{arrow.setSize(0);arrow.hide()}this.bounds.setHeight(contents.height()+this.edge*2+this.typeInPadding*2);this.bounds.setWidth(Math.max(contents.minWidth+this.edge*2+this.typeInPadding*2,this.width()));contents.setWidth(this.width()-this.edge-this.typeInPadding-(this.choices?arrow.width()+this.typeInPadding:0));contents.setPosition(new Point(this.edge,this.edge).add(this.typeInPadding).add(this.position()));arrow.setPosition(new Point(this.right()-arrow.width()-this.edge,contents.top()))};InputFieldMorph.prototype.mouseClickLeft=function(pos){if(this.arrow().bounds.containsPoint(pos)){this.dropDownMenu()}else if(this.isReadOnly){this.dropDownMenu()}else{this.escalateEvent("mouseClickLeft",pos)}};InputFieldMorph.prototype.getValue=function(){var num,contents=this.contents();if(this.isNumeric){num=parseFloat(contents.text.text);if(!isNaN(num)){return num}}return this.normalizeSpaces(contents.string())};InputFieldMorph.prototype.normalizeSpaces=DialogBoxMorph.prototype.normalizeSpaces;InputFieldMorph.prototype.render=function(ctx){var borderColor;if(this.parent){if(this.parent.color.eq(WHITE)){this.color=this.parent.color.darker(this.contrast*.1)}else{this.color=this.parent.color.lighter(this.contrast*.75)}borderColor=this.parent.color}else{borderColor=new Color(120,120,120)}ctx.fillStyle=this.color.toString();this.cachedClr=borderColor.toString();this.cachedClrBright=borderColor.lighter(this.contrast).toString();this.cachedClrDark=borderColor.darker(this.contrast).toString();ctx.fillRect(this.edge,this.edge,this.width()-this.edge*2,this.height()-this.edge*2);this.drawRectBorder(ctx)};InputFieldMorph.prototype.drawRectBorder=function(ctx){var shift=this.edge*.5,gradient;if(MorphicPreferences.isFlat&&!this.is3D){return}ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";if(useBlurredShadows){ctx.shadowOffsetY=shift;ctx.shadowBlur=this.edge*4;ctx.shadowColor=this.cachedClrDark}gradient=ctx.createLinearGradient(0,0,0,this.edge);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(this.edge,shift);ctx.lineTo(this.width()-this.edge-shift,shift);ctx.stroke();ctx.shadowOffsetY=0;gradient=ctx.createLinearGradient(0,0,this.edge,0);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,this.edge);ctx.lineTo(shift,this.height()-this.edge-shift);ctx.stroke();ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.shadowBlur=0;gradient=ctx.createLinearGradient(0,this.height()-this.edge,0,this.height());gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(this.edge,this.height()-shift);ctx.lineTo(this.width()-this.edge,this.height()-shift);ctx.stroke();gradient=ctx.createLinearGradient(this.width()-this.edge,0,this.width(),0);gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(this.width()-shift,this.edge);ctx.lineTo(this.width()-shift,this.height()-this.edge);ctx.stroke()};PianoMenuMorph.prototype=new MenuMorph;PianoMenuMorph.prototype.constructor=PianoMenuMorph;PianoMenuMorph.uber=MenuMorph.prototype;function PianoMenuMorph(target,environment,fontSize,soundType){this.init(target,environment,fontSize,soundType)}PianoMenuMorph.prototype.init=function(target,environment,fontSize,soundType){var choices,key;this.soundType=soundType;PianoMenuMorph.uber.init.call(this,target,null,environment,fontSize);choices={"C (48)":48,"D (50)":50,"C# (49)":49,"E (52)":52,"Eb (51)":51,"F (53)":53,"G (55)":55,"F# (54)":54,"A (57)":57,"G# (56)":56,"B (59)":59,"Bb (58)":58,"C (60)":60,"D (62)":62,"C# (61)":61,"E (64)":64,"Eb (63)":63,"F (65)":65,"G (67)":67,"F# (66)":66,"A (69)":69,"G# (68)":68,"B (71)":71,"Bb (70)":70,"C (72)":72};for(key in choices){if(Object.prototype.hasOwnProperty.call(choices,key)){this.addItem(key,choices[key])}}};PianoMenuMorph.prototype.createItems=function(){var item,fb,x,y,label,blackkey,key,keycolor,keywidth,keyheight,keyposition;this.children.forEach(m=>m.destroy());this.children=[];if(!this.isListContents){this.edge=MorphicPreferences.isFlat?0:5;this.border=MorphicPreferences.isFlat?1:2}this.color=WHITE;this.borderColor=new Color(60,60,60);this.bounds.setExtent(ZERO);x=this.left()+1;y=this.top()+this.fontSize*1.5+2;label=new StringMorph("",this.fontSize);this.items.forEach(tuple=>{blackkey=tuple[0][1]!==" ";key=new BoxMorph(1,1);if(blackkey){keycolor=BLACK;keywidth=this.fontSize;keyheight=this.fontSize*2.5;keyposition=new Point(x+2-this.fontSize*2,y)}else{keycolor=WHITE;keywidth=this.fontSize*1.5;keyheight=this.fontSize*4;keyposition=new Point(x+1,y);x+=keywidth-1}key.setColor(keycolor);key.setWidth(keywidth);key.setHeight(keyheight);item=new PianoKeyMorph(this.target,tuple[1],[key,tuple[0]],this.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,this.environment,tuple[2],tuple[3],tuple[4],tuple[5],tuple[6],label);item.setPosition(keyposition);this.add(item)});fb=this.fullBounds();label.setPosition(new Point(fb.width()/2-this.fontSize,2));this.add(label);fb=this.fullBounds();this.bounds.setExtent(fb.extent().add(2))};PianoMenuMorph.prototype.select=function(aPianoKeyItem){this.unselectAllItems();aPianoKeyItem.mouseEnter();this.selection=aPianoKeyItem;this.world.keyboardFocus=this;this.hasFocus=true};PianoMenuMorph.prototype.unselectAllItems=function(){this.children.forEach(item=>{if(item instanceof MenuItemMorph){item.mouseLeave()}});this.changed()};PianoMenuMorph.prototype.selectKey=function(midiNum){var key;if(isNil(midiNum)){return}key=detect(this.children,each=>each.action===midiNum);if(key){this.select(key)}else{this.selectKey(48)}};PianoMenuMorph.prototype.processKeyDown=function(event){switch(event.keyCode){case 13:case 32:if(this.selection){this.selection.mouseClickLeft()}return;case 27:return this.destroy();case 37:case 40:case 189:return this.selectDown();case 38:case 39:case 187:case 220:return this.selectUp();default:switch(event.key){case"C":return this.selectKey(48);case"c":return this.selectKey(60);case"D":return this.selectKey(50);case"d":return this.selectKey(62);case"E":return this.selectKey(52);case"e":return this.selectKey(64);case"F":return this.selectKey(53);case"f":return this.selectKey(65);case"G":return this.selectKey(55);case"g":return this.selectKey(67);case"A":return this.selectKey(57);case"a":return this.selectKey(69);case"B":case"H":return this.selectKey(59);case"b":case"h":return this.selectKey(71);default:nop()}}};PianoMenuMorph.prototype.selectUp=function(){var next=48;if(this.selection){next=this.selection.action+1;if(next>72){next=48}}this.selectKey(next)};PianoMenuMorph.prototype.selectDown=function(){var next=48;if(this.selection){next=this.selection.action-1;if(next<48){next=72}}this.selectKey(next)};PianoMenuMorph.prototype.destroy=function(){this.children.forEach(key=>{if(key.note){key.note.stop()}});PianoMenuMorph.uber.destroy.call(this)};PianoKeyMorph.prototype=new MenuItemMorph;PianoKeyMorph.prototype.constructor=PianoKeyMorph;PianoKeyMorph.uber=MenuItemMorph.prototype;function PianoKeyMorph(target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction,label){this.init(target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction,label);this.feedback=label}PianoKeyMorph.prototype.init=function(target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction,label){this.note=new Note(action);PianoKeyMorph.uber.init.call(this,target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction,label)};PianoKeyMorph.prototype.createLabel=function(){var icon;if(this.label!==null){this.label.destroy()}this.label=new Morph;icon=this.createIcon(this.labelString[0]);this.label.add(icon);this.bounds.setExtent(icon.extent());this.label.bounds=this.position().extent(this.label.extent());this.label.bounds.setExtent(ZERO);this.add(this.label)};PianoKeyMorph.prototype.mouseEnter=function(){var piano=this.parentThatIsA(PianoMenuMorph),soundType=piano?piano.soundType:1;if(piano){piano.unselectAllItems();piano.selection=this;piano.world.keyboardFocus=piano;piano.hasFocus=true}this.label.children[0].hide();this.userState="highlight";this.rerender();this.feedback.text=this.labelString[1];this.feedback.fixLayout();this.note.play(soundType);setTimeout(()=>this.note.stop(true),400)};PianoKeyMorph.prototype.mouseLeave=function(){this.note.stop(true);this.label.children[0].show();this.userState="normal";this.rerender()};</script>
        <script>modules.blocks="2022-August-03";var SyntaxElementMorph;var BlockMorph;var BlockLabelMorph;var BlockSymbolMorph;var CommandBlockMorph;var ReporterBlockMorph;var ScriptsMorph;var ArgMorph;var CommandSlotMorph;var CSlotMorph;var InputSlotMorph;var InputSlotStringMorph;var InputSlotTextMorph;var BooleanSlotMorph;var ArrowMorph;var ColorSlotMorph;var HatBlockMorph;var BlockHighlightMorph;var MultiArgMorph;var TemplateSlotMorph;var FunctionSlotMorph;var ReporterSlotMorph;var RingMorph;var RingCommandSlotMorph;var RingReporterSlotMorph;var CommentMorph;var ArgLabelMorph;var TextSlotMorph;var ScriptFocusMorph;SyntaxElementMorph.prototype=new Morph;SyntaxElementMorph.prototype.constructor=SyntaxElementMorph;SyntaxElementMorph.uber=Morph.prototype;SyntaxElementMorph.prototype.contrast=65;SyntaxElementMorph.prototype.setScale=function(num){var scale=Math.min(Math.max(num,1),25);this.scale=scale;this.corner=3*scale;this.rounding=9*scale;this.edge=scale;this.flatEdge=scale*.5;this.jag=5*scale;this.inset=6*scale;this.hatHeight=12*scale;this.hatWidth=70*scale;this.rfBorder=3*scale;this.minWidth=0;this.dent=8*scale;this.bottomPadding=3*scale;this.cSlotPadding=4*scale;this.typeInPadding=scale;this.labelPadding=4*scale;this.labelFontName="Verdana";this.labelFontStyle="sans-serif";this.fontSize=10*scale;this.embossing=new Point(-1*Math.max(scale/2,1),-1*Math.max(scale/2,1));this.labelWidth=450*scale;this.labelWordWrap=true;this.dynamicInputLabels=true;this.feedbackMinHeight=5;this.minSnapDistance=20;this.reporterDropFeedbackPadding=10*scale;this.labelContrast=25;this.activeHighlight=new Color(153,255,213);this.errorHighlight=new Color(173,15,0);this.activeBlur=20;this.activeBorder=4;this.rfColor=new Color(120,120,120)};SyntaxElementMorph.prototype.setScale(1);SyntaxElementMorph.prototype.isCachingInputs=false;SyntaxElementMorph.prototype.alpha=1;SyntaxElementMorph.prototype.labelParts={"%s":{type:"input"},"%n":{type:"input",tags:"numeric"},"%txt":{type:"input",tags:"landscape"},"%anyUE":{type:"input",tags:"unevaluated"},"%dir":{type:"input",tags:"numeric",menu:{"§_dir":null,"(90) right":90,"(-90) left":-90,"(0) up":0,"(180) down":180,random:["random"]}},"%note":{type:"input",tags:"numeric",menu:"pianoKeyboardMenu"},"%inst":{type:"input",tags:"numeric",menu:{"(1) sine":1,"(2) square":2,"(3) sawtooth":3,"(4) triangle":4}},"%prim":{type:"input",tags:"read-only static",menu:"primitivesMenu"},"%audio":{type:"input",tags:"read-only static",menu:"audioMenu"},"%aa":{type:"input",tags:"read-only static",menu:{name:["name"],duration:["duration"],length:["length"],"number of channels":["number of channels"],"sample rate":["sample rate"],samples:["samples"]}},"%img":{type:"input",tags:"read-only static",menu:{name:["name"],width:["width"],height:["height"],pixels:["pixels"]}},"%imgsource":{type:"input",tags:"read-only",menu:{"pen trails":["pen trails"],"stage image":["stage image"]}},"%rate":{type:"input",tags:"numeric",menu:{"22.05 kHz":22050,"44.1 kHz":44100,"48 kHz":48e3,"88.2 kHz":88200,"96 kHz":96e3}},"%interaction":{type:"input",tags:"read-only static",menu:{clicked:["clicked"],pressed:["pressed"],dropped:["dropped"],"mouse-entered":["mouse-entered"],"mouse-departed":["mouse-departed"],"scrolled-up":["scrolled-up"],"scrolled-down":["scrolled-down"],stopped:["stopped"]}},"%dates":{type:"input",tags:"read-only static",menu:{year:["year"],month:["month"],date:["date"],"day of week":["day of week"],hour:["hour"],minute:["minute"],second:["second"],"time in milliseconds":["time in milliseconds"]}},"%delim":{type:"input",menu:{letter:["letter"],word:["word"],line:["line"],tab:["tab"],cr:["cr"],csv:["csv"],json:["json"],"~":null,blocks:["blocks"]}},"%ida":{type:"input",tags:"numeric",menu:{1:1,last:["last"],"~":null,all:["all"]}},"%idx":{type:"input",tags:"numeric",menu:{1:1,last:["last"],any:["any"]}},"%la":{type:"input",tags:"read-only static",menu:{length:["length"],rank:["rank"],dimensions:["dimensions"],flatten:["flatten"],columns:["columns"],reverse:["reverse"],"~":null,lines:["lines"],csv:["csv"],json:["json"]}},"%mlfunc":{type:"input",tags:"read-only static",menu:{append:["append"],"cross product":["cross product"]}},"%dim":{type:"input",tags:"numeric",menu:{current:["current"]}},"%rel":{type:"input",tags:"read-only static",menu:{distance:["distance"],direction:["direction"],"ray length":["ray length"]}},"%loc":{type:"input",tags:"read-only",menu:"locationMenu"},"%rcv":{type:"input",tags:"read-only",menu:"receiversMenu",value:["all"]},"%spr":{type:"input",tags:"read-only",menu:"objectsMenu"},"%self":{type:"input",tags:"read-only",menu:"objectsMenuWithSelf"},"%col":{type:"input",tags:"read-only",menu:"collidablesMenu"},"%dst":{type:"input",tags:"read-only",menu:"distancesMenu"},"%cln":{type:"input",tags:"read-only",menu:"clonablesMenu"},"%get":{type:"input",tags:"read-only static",menu:"gettablesMenu"},"%cst":{type:"input",tags:"read-only",menu:"costumesMenu"},"%eff":{type:"input",tags:"read-only static",menu:{color:["color"],saturation:["saturation"],brightness:["brightness"],ghost:["ghost"],fisheye:["fisheye"],whirl:["whirl"],pixelate:["pixelate"],mosaic:["mosaic"],negative:["negative"]}},"%snd":{type:"input",tags:"read-only",menu:"soundsMenu"},"%key":{type:"input",tags:"read-only",menu:"keysMenu"},"%keyHat":{type:"input",tags:"read-only static",menu:"keysMenu",react:"updateEventUpvar"},"%msg":{type:"input",tags:"read-only",menu:"messagesMenu"},"%msgHat":{type:"input",tags:"read-only static",menu:"messagesReceivedMenu"},"%msgSend":{type:"input",menu:"eventsMenu"},"%att":{type:"input",tags:"read-only",menu:"attributesMenu"},"%fun":{type:"input",tags:"read-only static",menu:{abs:["abs"],neg:["neg"],sign:["sign"],ceiling:["ceiling"],floor:["floor"],sqrt:["sqrt"],sin:["sin"],cos:["cos"],tan:["tan"],asin:["asin"],acos:["acos"],atan:["atan"],ln:["ln"],log:["log"],lg:["lg"],"e^":["e^"],"10^":["10^"],"2^":["2^"],id:["id"]}},"%layer":{type:"input",tags:"read-only static",menu:{front:["front"],back:["back"]}},"%clrdim":{type:"input",tags:"read-only static",menu:{hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"],"~":null,"r-g-b(-a)":["r-g-b(-a)"]}},"%pen":{type:"input",tags:"read-only static",menu:{size:["size"],hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"],"~":null,"r-g-b-a":["r-g-b-a"]}},"%asp":{type:"input",tags:"read-only static",menu:{hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"],"r-g-b-a":["r-g-b-a"],"~":null,sprites:["sprites"]}},"%txtfun":{type:"input",tags:"read-only static",menu:{"encode URI":["encode URI"],"decode URI":["decode URI"],"encode URI component":["encode URI component"],"decode URI component":["decode URI component"],"XML escape":["XML escape"],"XML unescape":["XML unescape"],"hex sha512 hash":["hex sha512 hash"]}},"%stopChoices":{type:"input",tags:"read-only static",menu:{all:["all"],"all scenes":["all scenes"],"this script":["this script"],"this block":["this block"],"all but this script":["all but this script"],"other scripts in sprite":["other scripts in sprite"]}},"%setting":{type:"input",tags:"read-only static",menu:{"turbo mode":["turbo mode"],"flat line ends":["flat line ends"],"log pen vectors":["log pen vectors"],"video capture":["video capture"],"mirror video":["mirror video"]}},"%typ":{type:"input",tags:"read-only static",menu:"typesMenu"},"%mapValue":{type:"input",tags:"read-only static",menu:{String:["String"],Number:["Number"],true:["true"],false:["false"]}},"%var":{type:"input",tags:"read-only static",menu:"getVarNamesDict"},"%shd":{type:"input",tags:"read-only",menu:"shadowedVariablesMenu"},"%codeKind":{type:"input",tags:"read-only",menu:{code:["code"],header:["header"]}},"%codeListPart":{type:"input",tags:"read-only",menu:{list:["list"],item:["item"],delimiter:["delimiter"]}},"%codeListKind":{type:"input",tags:"read-only",menu:{collection:["collection"],variables:["variables"],parameters:["parameters"]}},"%scn":{type:"input",tags:"read-only",menu:"scenesMenu"},"%vid":{type:"input",tags:"read-only static",menu:{snap:["snap"],motion:["motion"],direction:["direction"]}},"%block":{type:"input",tags:"read-only static",menu:{label:["label"],definition:["definition"],category:["category"],"custom?":["custom?"],"global?":["global?"],type:["type"],scope:["scope"],slots:["slots"],"~":null,defaults:["defaults"],menus:["menus"],editables:["editables"]}},"%byob":{type:"input",tags:"read-only static",menu:{label:["label"],definition:["definition"],category:["category"],type:["type"],scope:["scope"],slots:["slots"],"~":null,defaults:["defaults"],menus:["menus"],editables:["editables"]}},"%mlt":{type:"text entry"},"%code":{type:"text entry",tags:"monospace"},"%b":{type:"boolean"},"%boolUE":{type:"boolean",tags:"unevaluated"},"%bool":{type:"boolean",tags:"static"},"%obj":{type:"slot",kind:"object"},"%l":{type:"slot",kind:"list"},"%turtle":{type:"symbol",name:"turtle",scale:1.2},"%turtleOutline":{type:"symbol",name:"turtleOutline",tags:"protected"},"%clockwise":{type:"symbol",name:"turnRight",scale:1.5},"%counterclockwise":{type:"symbol",name:"turnLeft",scale:1.5},"%greenflag":{type:"symbol",name:"flag",color:new Color(0,200,0),scale:1.5,tags:"protected"},"%blitz":{type:"symbol",name:"flash"},"%list":{type:"symbol",name:"list"},"%pause":{type:"symbol",name:"pause",color:new Color(255,220,0),tags:"protected"},"%loopArrow":{type:"symbol",name:"loop",scale:.7,tags:"fading"},"%c":{type:"c",tags:"static"},"%cs":{type:"c"},"%ca":{type:"c",tags:"loop"},"%cl":{type:"c",tags:"static lambda"},"%cla":{type:"c",tags:"static lambda loop"},"%loop":{type:"c",tags:"static loop"},"%cmd":{type:"command slot"},"%cmdRing":{type:"ring",selector:"reifyScript",spec:"%rc %ringparms"},"%repRing":{type:"ring",tags:"static",selector:"reifyReporter",spec:"%rr %ringparms"},"%predRing":{type:"ring",tags:"static",selector:"reifyPredicate",spec:"%rp %ringparms"},"%rc":{type:"ring slot",tags:"static",kind:"command"},"%rr":{type:"ring slot",tags:"static",kind:"reporter"},"%rp":{type:"ring slot",tags:"static",kind:"predicate"},"%t":{type:"template",label:" "},"%upvar":{type:"template",label:" "},"%clr":{type:"color",tags:"static"},"%br":{type:"break"},"%inputName":{type:"variable"},"%inputs":{type:"multi",slots:"%s",label:"with inputs",tags:"widget"},"%send":{type:"multi",slots:["%msgSend","%s"],label:["and send","with data"],tags:"static",max:2},"%receive":{type:"multi",slots:["%rcv","%s"],label:["to","with data"],tags:"static",max:2},"%scriptVars":{type:"multi",slots:"%t",tags:"widget",min:1},"%blockVars":{type:"multi",slots:"%t",label:"block variables",tags:"widget"},"%message":{type:"multi",slots:"%t",tags:"widget",max:1},"%keyName":{type:"multi",slots:"%t",tags:"widget",max:1},"%parms":{type:"multi",slots:"%t",label:"Input Names:",tags:"widget"},"%ringparms":{type:"multi",slots:"%t",label:"input names:"},"%words":{type:"multi",slots:"%s",defaults:2},"%lists":{type:"multi",slots:"%l",defaults:2},"%nums":{type:"multi",slots:"%n",defaults:2},"%exp":{type:"multi",slots:"%s",defaults:1,tags:"static widget"},"%sum":{type:"multi",slots:"%n",min:2,infix:"+",collapse:"sum"},"%product":{type:"multi",slots:"%n",min:2,infix:"×",collapse:"product"},"%min":{type:"multi",slots:"%n",min:2,infix:"min",collapse:"minimum"},"%max":{type:"multi",slots:"%n",min:2,infix:"max",collapse:"maximum"}};function SyntaxElementMorph(){this.init()}SyntaxElementMorph.prototype.init=function(){this.cachedClr=null;this.cachedClrBright=null;this.cachedClrDark=null;this.cachedNormalColor=null;this.isStatic=false;SyntaxElementMorph.uber.init.call(this);this.defaults=[];this.cachedInputs=null;delete this.alpha};SyntaxElementMorph.prototype.parts=function(){var nb=null;if(this.nextBlock){nb=this.nextBlock()}return this.children.filter(child=>child!==nb&&!(child instanceof ShadowMorph)&&!(child instanceof BlockHighlightMorph))};SyntaxElementMorph.prototype.inputs=function(){if(isNil(this.cachedInputs)||!this.isCachingInputs){this.cachedInputs=this.parts().filter(part=>part instanceof SyntaxElementMorph)}return this.cachedInputs};SyntaxElementMorph.prototype.debugCachedInputs=function(){var realInputs,i;if(!isNil(this.cachedInputs)){realInputs=this.parts().filter(part=>part instanceof SyntaxElementMorph)}if(this.cachedInputs.length!==realInputs.length){throw new Error("cached inputs size do not match: "+this.constructor.name)}for(i=0;i<realInputs.length;i+=1){if(this.cachedInputs[i]!==realInputs[i]){throw new Error("cached input does not match: "+this.constructor.name+" #"+i+" "+this.cachedInputs[i].constructor.name+" != "+realInputs[i].constructor.name)}}};SyntaxElementMorph.prototype.allInputs=function(){return this.allChildren().slice(0).reverse().filter(child=>child instanceof ArgMorph||child instanceof ReporterBlockMorph&&child!==this)};SyntaxElementMorph.prototype.allEmptySlots=function(){var empty=[];if(!(this instanceof RingMorph)&&this.selector!=="reportJSFunction"){this.children.forEach(morph=>{if(morph.isEmptySlot&&morph.isEmptySlot()){empty.push(morph)}else if(morph.allEmptySlots){empty=empty.concat(morph.allEmptySlots())}})}return empty};SyntaxElementMorph.prototype.tagExitBlocks=function(stopTag,isCommand){if(this.selector==="doReport"){this.partOfCustomCommand=isCommand}else if(this.selector==="doStopThis"){this.exitTag=stopTag}else{if(!(this instanceof RingMorph)){this.children.forEach(morph=>{if(morph.tagExitBlocks){morph.tagExitBlocks(stopTag,isCommand)}})}}};SyntaxElementMorph.prototype.replaceInput=function(oldArg,newArg){var scripts=this.parentThatIsA(ScriptsMorph),replacement=newArg,idx=this.children.indexOf(oldArg),i=0;if(idx===-1&&newArg instanceof MultiArgMorph){this.children.forEach(morph=>{if(morph instanceof ArgLabelMorph&&morph.argMorph()===oldArg){idx=i}i+=1})}if(oldArg.cachedSlotSpec){oldArg.cachedSlotSpec=null}if(newArg.cachedSlotSpec){newArg.cachedSlotSpec=null}this.changed();if(newArg.parent){newArg.parent.removeChild(newArg)}if(oldArg instanceof MultiArgMorph){oldArg.inputs().forEach(inp=>oldArg.replaceInput(inp,new InputSlotMorph));if((this.dynamicInputLabels||oldArg.collapse)&&newArg instanceof ReporterBlockMorph){replacement=new ArgLabelMorph(newArg,oldArg.collapse)}}replacement.parent=this;this.children[idx]=replacement;if(oldArg instanceof ReporterBlockMorph&&scripts&&!oldArg.isPrototype){if(!(oldArg instanceof RingMorph)||oldArg instanceof RingMorph&&oldArg.contents()){scripts.add(oldArg);oldArg.moveBy(replacement.extent());oldArg.fixBlockColor()}}if(replacement instanceof MultiArgMorph||replacement instanceof ArgLabelMorph||replacement.constructor===CommandSlotMorph){replacement.fixLayout();if(this.fixLabelColor){this.fixLabelColor()}}else{this.fixLayout()}this.cachedInputs=null};SyntaxElementMorph.prototype.revertToDefaultInput=function(arg,noValues){var deflt=this.revertToEmptyInput(arg),inp=this.inputs().indexOf(deflt),def;if(noValues||inp<0){return deflt}if(this instanceof BlockMorph){if(this.isCustomBlock){def=this.isGlobal?this.definition:this.scriptTarget().getMethod(this.blockSpec);if(!noValues&&(deflt instanceof InputSlotMorph||deflt instanceof BooleanSlotMorph)){deflt.setContents(def.defaultValueOfInputIdx(inp))}}}if(deflt instanceof MultiArgMorph&&!inp){deflt.setContents(this.defaults);deflt.defaults=this.defaults}else if(!isNil(this.defaults[inp])){deflt.setContents(this.defaults[inp]);if(deflt instanceof MultiArgMorph){deflt.defaults=this.defaults[inp]}}return deflt};SyntaxElementMorph.prototype.revertToEmptyInput=function(arg){var idx=this.parts().indexOf(arg),inp=this.inputs().indexOf(arg),deflt=new InputSlotMorph,rcvr,def;if(idx!==-1){if(this instanceof BlockMorph){deflt=this.labelPart(this.parseSpec(this.blockSpec)[idx]);if(this.isCustomBlock){if(this.isGlobal){def=this.definition}else{rcvr=this.scriptTarget(true);if(rcvr){def=rcvr.getMethod(this.blockSpec)}}if(def&&deflt instanceof InputSlotMorph){deflt.setChoices.apply(deflt,def.inputOptionsOfIdx(inp))}}}else if(this instanceof MultiArgMorph){deflt=this.labelPart(this.slotSpecFor(inp))}else if(this instanceof ReporterSlotMorph){deflt=this.emptySlot()}}if(deflt.icon||deflt instanceof BooleanSlotMorph){deflt.fixLayout()}this.replaceInput(arg,deflt);if(deflt instanceof MultiArgMorph){deflt.refresh()}else if(deflt instanceof RingMorph){deflt.fixBlockColor()}this.cachedInputs=null;return deflt};SyntaxElementMorph.prototype.isLocked=function(){return this.isStatic};SyntaxElementMorph.prototype.topBlock=function(){if(this.parent&&this.parent.topBlock){return this.parent.topBlock()}return this};SyntaxElementMorph.prototype.getVarNamesDict=function(){var block=this.parentThatIsA(BlockMorph),rcvr,tempVars=[],dict;if(!block){return{}}rcvr=block.scriptTarget();block.allParents().forEach(morph=>{if(morph instanceof PrototypeHatBlockMorph){tempVars.push.apply(tempVars,morph.variableNames());tempVars.push.apply(tempVars,morph.inputs()[0].inputFragmentNames())}else if(morph instanceof BlockMorph){morph.inputs().forEach(inp=>{inp.allChildren().forEach(child=>{if(child instanceof TemplateSlotMorph){tempVars.push(child.contents())}else if(child instanceof MultiArgMorph){child.children.forEach(m=>{if(m instanceof TemplateSlotMorph){tempVars.push(m.contents())}})}})})}});if(rcvr){dict=rcvr.variables.allNamesDict();tempVars.forEach(name=>dict[name]=name);if(block.selector==="doSetVar"){dict["~"]=null;dict.my=[{anchor:["my anchor"],parent:["my parent"],name:["my name"],"temporary?":["my temporary?"],"dangling?":["my dangling?"],"draggable?":["my draggable?"],"rotation style":["my rotation style"],"rotation x":["my rotation x"],"rotation y":["my rotation y"]}];if(this.world().currentKey===16){dict.my[0]["~"]=null;dict.my[0]["microphone modifier"]=["microphone modifier"]}}return dict}return{}};SyntaxElementMorph.prototype.refactorVarInStack=function(oldName,newName,isScriptVar){if(this instanceof RingMorph&&contains(this.inputNames(),oldName)||!isScriptVar&&this.definesScriptVariable(oldName)){return}if(this.selector==="reportGetVar"&&this.blockSpec===oldName){this.setSpec(newName);this.fullChanged();this.fixLabelColor()}if(this.choices==="getVarNamesDict"&&this.contents().text===oldName){this.setContents(newName)}if(this instanceof CustomCommandBlockMorph&&this.definition.body&&isNil(this.definition.declarations.get(oldName))&&!contains(this.definition.variableNames,oldName)){this.definition.body.expression.refactorVarInStack(oldName,newName)}this.inputs().forEach(input=>input.refactorVarInStack(oldName,newName));if(this.nextBlock){var nb=this.nextBlock();if(nb){nb.refactorVarInStack(oldName,newName)}}};SyntaxElementMorph.prototype.definesScriptVariable=function(name){return(this.selector==="doDeclareVariables"||this.blockSpec&&this.blockSpec.match("%upvar"))&&detect(this.inputs()[0].allInputs(),input=>input.selector==="reportGetVar"&&input.blockSpec===name)};SyntaxElementMorph.prototype.selectForEdit=function(){var scripts=this.parentThatIsA(ScriptsMorph),ide=this.parentThatIsA(IDE_Morph),rcvr=ide?ide.currentSprite:null,selected;if(scripts&&rcvr&&rcvr.inheritsAttribute("scripts")){this.selectionID=true;rcvr.shadowAttribute("scripts");selected=detect(rcvr.scripts.allChildren(),m=>m.selectionID);delete this.selectionID;delete selected.selectionID;return selected}return this};SyntaxElementMorph.prototype.reactToGrabOf=function(grabbedMorph){var topBlock=this.topBlock(),affected;if(grabbedMorph instanceof CommandBlockMorph){affected=this.parentThatIsA(CommandSlotMorph,ReporterSlotMorph);if(affected){affected.fixLayout()}}if(topBlock){topBlock.allComments().forEach(comment=>comment.align(topBlock));if(topBlock.getHighlight()){topBlock.addHighlight(topBlock.removeHighlight())}}};SyntaxElementMorph.prototype.bright=function(){return this.color.lighter(this.contrast).toString()};SyntaxElementMorph.prototype.dark=function(){return this.color.darker(this.contrast).toString()};SyntaxElementMorph.prototype.setColor=function(aColor){var block;if(aColor){if(!this.color.eq(aColor)){block=this.parentThatIsA(BlockMorph);this.color=aColor;this.children.forEach(morph=>{if(block&&(morph instanceof StringMorph||morph instanceof SymbolMorph)){morph.shadowColor=block.color.darker(block.labelContrast);morph.rerender()}else if(morph instanceof CommandSlotMorph){morph.setColor(aColor)}});this.rerender()}}};SyntaxElementMorph.prototype.setLabelColor=function(textColor,shadowColor,shadowOffset){this.children.forEach(morph=>{if(morph instanceof StringMorph&&!morph.isProtectedLabel){morph.shadowOffset=shadowOffset||morph.shadowOffset;morph.shadowColor=shadowColor||morph.shadowColor;morph.setColor(textColor)}else if(morph instanceof MultiArgMorph||morph instanceof ArgLabelMorph||morph instanceof SymbolMorph&&!morph.isProtectedLabel||morph instanceof InputSlotMorph&&morph.isReadOnly){morph.setLabelColor(textColor,shadowColor,shadowOffset)}else if(morph.isLoop){morph.loop().setLabelColor(textColor,shadowColor,shadowOffset)}})};SyntaxElementMorph.prototype.flash=function(){if(!this.cachedNormalColor){this.cachedNormalColor=this.color;this.setColor(this.activeHighlight)}};SyntaxElementMorph.prototype.unflash=function(){if(this.cachedNormalColor){var clr=this.cachedNormalColor;this.cachedNormalColor=null;this.setColor(clr)}};SyntaxElementMorph.prototype.doWithAlpha=function(alpha,callback){var current=SyntaxElementMorph.prototype.alpha,result;SyntaxElementMorph.prototype.alpha=alpha;result=callback();SyntaxElementMorph.prototype.alpha=current;return result};SyntaxElementMorph.prototype.fixBlockColor=function(nearestBlock,isForced){this.children.forEach(morph=>{if(morph instanceof SyntaxElementMorph){morph.fixBlockColor(nearestBlock,isForced)}})};SyntaxElementMorph.prototype.labelPart=function(spec){var part,info,tokens,cnts,i;if(spec[0]==="%"&&spec.length>1&&(this.selector!=="reportGetVar"||spec==="%turtleOutline"&&this.isObjInputFragment())){if(spec.length>5&&spec.slice(0,5)==="%mult"){part=new MultiArgMorph(spec.slice(5));part.addInput();return part}info=this.labelParts[spec];if(!info){throw new Error('label part spec not found: "'+spec+'"')}switch(info.type){case"input":part=new InputSlotMorph(null,null,info.menu);part.onSetContents=info.react||null;break;case"text entry":part=new TextSlotMorph;break;case"slot":part=new ArgMorph(info.kind);break;case"boolean":part=new BooleanSlotMorph;break;case"symbol":part=new BlockSymbolMorph(info.name);part.size=this.fontSize*(info.scale||1);part.color=info.color||WHITE;part.shadowColor=this.color.darker(this.labelContrast);part.shadowOffset=MorphicPreferences.isFlat?ZERO:this.embossing;part.fixLayout();break;case"c":part=new CSlotMorph;break;case"command slot":part=new CommandSlotMorph;break;case"ring":part=new RingMorph;part.color=SpriteMorph.prototype.blockColor.other;part.selector=info.selector;part.setSpec(info.spec);part.isDraggable=true;break;case"ring slot":switch(info.kind){case"command":part=new RingCommandSlotMorph;break;case"reporter":part=new RingReporterSlotMorph;break;case"predicate":part=new RingReporterSlotMorph(true);break;default:throw new Error('unknown ring kind: "'+info.kind+'"')}break;case"template":part=new TemplateSlotMorph(info.label);break;case"color":part=new ColorSlotMorph;break;case"break":part=new Morph;part.setExtent(ZERO);part.isBlockLabelBreak=true;part.getSpec=()=>"%br";break;case"variable":part=new TemplateSlotMorph(info.label);part=new ReporterBlockMorph;part.category="variables";part.color=SpriteMorph.prototype.blockColor.variables;part.setSpec(localize("Input name"));break;case"multi":part=new MultiArgMorph(info.slots,info.label,info.min||0,spec,null,null,null,null,null,info.infix,info.collapse);part.maxInputs=info.max;for(i=0;i<info.defaults||0;i+=1){part.addInput()}break;default:throw new Error('unknown label part type: "'+info.type+'"')}if(info.tags){info.tags.split(" ").forEach(tag=>{if(tag){switch(tag){case"numeric":part.isNumeric=true;break;case"read-only":part.isReadOnly=true;if(!MorphicPreferences.isFlat){cnts=part.contents();cnts.shadowOffset=new Point(1,1);cnts.fixLayout()}break;case"unevaluated":part.isUnevaluated=true;break;case"static":part.isStatic=true;break;case"landscape":part.minWidth=part.height()*1.7;break;case"monospace":part.contents().fontName="monospace";part.contents().fontStyle="monospace";break;case"fading":part.isFading=true;break;case"protected":part.isProtectedLabel=true;break;case"loop":part.isLoop=true;part.add(this.labelPart("%loopArrow"));break;case"lambda":part.isLambda=true;break;case"widget":part.canBeEmpty=false;break;default:throw new Error('unknown label part tag: "'+tag+'"')}}});part.fixLayout()}if(!isNil(info.value)){part.setContents(info.value)}}else if(spec[0]==="$"&&spec.length>1&&this.selector!=="reportGetVar"){tokens=spec.slice(1).split("-");if(!contains(SymbolMorph.prototype.names,tokens[0])){part=new StringMorph(tokens[0]);part.fontName=this.labelFontName;part.fontStyle=this.labelFontStyle;part.fontSize=this.fontSize*(+tokens[1]||1)}else{part=new BlockSymbolMorph(tokens[0]);part.size=this.fontSize*(+tokens[1]||1.2)}part.color=new Color(+tokens[2]===0?0:+tokens[2]||255,+tokens[3]===0?0:+tokens[3]||255,+tokens[4]===0?0:+tokens[4]||255);part.isProtectedLabel=tokens.length>2;part.shadowColor=this.color.darker(this.labelContrast);part.shadowOffset=MorphicPreferences.isFlat?ZERO:this.embossing;part.fixLayout()}else{part=new BlockLabelMorph(spec,this.fontSize,this.labelFontStyle,true,false,false,MorphicPreferences.isFlat?ZERO:this.embossing,this.color.darker(this.labelContrast),WHITE,this.labelFontName)}return part};SyntaxElementMorph.prototype.isObjInputFragment=function(){return this.selector==="reportGetVar"&&this.getSlotSpec()==="%t"&&this.parent.fragment.type==="%obj"};SyntaxElementMorph.prototype.fixLayout=function(){var nb,parts=this.parts(),pos=this.position(),x=0,y,lineHeight=0,maxX=0,blockWidth=this.minWidth,blockHeight,l=[],lines=[],space=this.isPrototype?1:Math.floor(fontHeight(this.fontSize)/3),ico=this instanceof BlockMorph&&this.hasLocationPin()?this.methodIconExtent().x+space:0,bottomCorrection,rightMost,hasLoopCSlot=false,hasLoopArrow=false;if(this instanceof MultiArgMorph&&this.slotSpec!=="%cs"){blockWidth+=this.arrows().width()}else if(this instanceof ReporterBlockMorph){blockWidth+=this.rounding*2+this.edge*2}else{blockWidth+=this.corner*4+this.edge*2+this.inset*3+this.dent}if(this.nextBlock){nb=this.nextBlock()}parts.forEach(part=>{if(part instanceof CSlotMorph||part.slotSpec==="%cs"){if(l.length>0){lines.push(l);lines.push([part]);l=[];x=0}else{lines.push([part])}}else if(this.isVertical()&&!(part instanceof FrameMorph)){if(l.length>0){lines.push(l)}l=[part];x=part.fullBounds().width()+space}else{if(part.isVisible){x+=part.fullBounds().width()+space}if(x>this.labelWidth||part.isBlockLabelBreak){if(l.length>0){lines.push(l);l=[];x=part.fullBounds().width()+space}}l.push(part);if(part.isBlockLabelBreak){x=0}}});if(l.length>0){lines.push(l)}if(this instanceof CommandBlockMorph){y=this.top()+this.corner+this.edge;if(this instanceof HatBlockMorph){y+=this.hatHeight}}else if(this instanceof ReporterBlockMorph){y=this.top()+this.edge*2}else if(this instanceof MultiArgMorph||this instanceof ArgLabelMorph){y=this.top();if(this.slotSpec==="%cs"&&this.inputs().length>0){y-=this.rounding}}lines.forEach(line=>{if(hasLoopCSlot){hasLoopArrow=true;hasLoopCSlot=false}x=this.left()+ico+this.edge+this.labelPadding;if(this instanceof RingMorph){x=this.left()+space}else if(this.isPredicate){x=this.left()+ico+this.rounding}else if(this instanceof MultiArgMorph||this instanceof ArgLabelMorph){x=this.left()}y+=lineHeight;lineHeight=0;line.forEach(part=>{if(part.isLoop){hasLoopCSlot=true}if(part instanceof CSlotMorph){x-=this.labelPadding;if(this.isPredicate){x=this.left()+ico+this.rounding}part.setColor(this.color);part.setPosition(new Point(x,y));lineHeight=part.height()}else if(part instanceof MultiArgMorph&&part.slotSpec==="%cs"){if(this.isPredicate){x+=this.corner}part.setPosition(new Point(x,y));lineHeight=part.height()}else{part.setPosition(new Point(x,y));if(!part.isBlockLabelBreak){if(part.slotSpec==="%c"||part.slotSpec==="%loop"){x+=part.width()}else if(part.isVisible){x+=part.fullBounds().width()+space}}maxX=Math.max(maxX,x);lineHeight=Math.max(lineHeight,part instanceof StringMorph?part.rawHeight():part.height())}});if(hasLoopArrow){x+=this.fontSize*1.5;maxX=Math.max(maxX,x);hasLoopArrow=false}line.forEach(part=>{part.moveBy(new Point(0,Math.floor((lineHeight-part.height())/2)))})});y+=lineHeight;if(this.children.some(any=>any instanceof CSlotMorph)){bottomCorrection=this.bottomPadding;if(this instanceof ReporterBlockMorph&&!this.isPredicate){bottomCorrection=Math.max(this.bottomPadding,this.rounding-this.bottomPadding)}y+=bottomCorrection}if(this instanceof CommandBlockMorph){blockHeight=y-this.top()+this.corner*2}else if(this instanceof ReporterBlockMorph){blockHeight=y-this.top()+this.edge*2}else if(this instanceof MultiArgMorph||this instanceof ArgLabelMorph){blockHeight=y-this.top()}if(this.isPredicate){blockWidth=Math.max(blockWidth,maxX-this.left()+this.rounding)}else if(this instanceof MultiArgMorph&&this.slotSpec!=="%cs"||this instanceof ArgLabelMorph){blockWidth=Math.max(blockWidth,maxX-this.left()-space)}else{blockWidth=Math.max(blockWidth,maxX-this.left()+this.labelPadding-this.edge);rightMost=parts[parts.length-1];if(rightMost instanceof MultiArgMorph&&rightMost.isVisible&&lines.length===1){blockWidth-=space}if(this instanceof HatBlockMorph){blockWidth=Math.max(blockWidth,this.hatWidth*1.5)}}this.bounds.setWidth(blockWidth);this.bounds.setHeight(blockHeight);this.holes=[];parts.forEach(part=>{var adjustMultiWidth=0;if(part instanceof CSlotMorph||part.slotSpec==="%cs"){if(this.isPredicate){part.bounds.setWidth(blockWidth-ico-this.rounding-this.inset-this.corner);adjustMultiWidth=this.corner}else{part.bounds.setWidth(blockWidth-this.edge-ico);adjustMultiWidth=this.corner+this.edge}if(part.fixLoopLayout){part.fixLoopLayout()}}if(part.slotSpec==="%cs"){part.inputs().forEach(slot=>slot.bounds.setWidth(part.right()-slot.left()-adjustMultiWidth))}part.fixHolesLayout();this.holes.push.apply(this.holes,part.holes.map(hole=>hole.translateBy(part.position().subtract(pos))))});if(nb){nb.setPosition(new Point(this.left(),this.bottom()-this.corner))}if(this instanceof BlockMorph&&this.parent&&this.parent.fixLayout){this.parent.fixLayout();this.parent.changed();if(this.parent instanceof SyntaxElementMorph){return}}this.fixHighlight()};SyntaxElementMorph.prototype.fixHighlight=function(){var top=this.topBlock();if(top.getHighlight&&top.getHighlight()){top.addHighlight(top.removeHighlight())}};SyntaxElementMorph.prototype.methodIconExtent=function(){var ico=this.fontSize*1.2;return this.hasLocationPin()?new Point(ico*.66,ico):new Point(0,0)};SyntaxElementMorph.prototype.isVertical=function(){return false};SyntaxElementMorph.prototype.evaluate=function(){return null};SyntaxElementMorph.prototype.isEmptySlot=function(){return false};SyntaxElementMorph.prototype.showBubble=function(value,exportPic,target){var bubble,txt,img,morphToShow,isClickable=true,ide=this.parentThatIsA(IDE_Morph)||target.parentThatIsA(IDE_Morph),anchor=this,pos=this.rightCenter().add(new Point(2,0)),sf=this.parentThatIsA(ScrollFrameMorph),wrrld=this.world()||target.world();if(value===undefined||!wrrld){return null}if(value instanceof ListWatcherMorph){morphToShow=value;morphToShow.update(true);morphToShow.step=value.update;morphToShow.isDraggable=false;morphToShow.expand(this.parentThatIsA(ScrollFrameMorph).extent());isClickable=true}else if(value instanceof TableFrameMorph){morphToShow=value;morphToShow.isDraggable=false;morphToShow.expand(this.parentThatIsA(ScrollFrameMorph).extent());isClickable=true}else if(value instanceof Morph){if(isSnapObject(value)){img=value.thumbnail(new Point(40,40));morphToShow=new Morph;morphToShow.isCachingImage=true;morphToShow.bounds.setWidth(img.width);morphToShow.bounds.setHeight(img.height);morphToShow.cachedImage=img;morphToShow.version=value.version;morphToShow.step=function(){if(this.version!==value.version){img=value.thumbnail(new Point(40,40));this.cachedImage=img;this.version=value.version;this.changed()}}}else{img=value.fullImage();morphToShow=new Morph;morphToShow.isCachingImage=true;morphToShow.bounds.setWidth(img.width);morphToShow.bounds.setHeight(img.height);morphToShow.cachedImage=img}}else if(value instanceof Costume){img=value.thumbnail(new Point(40,40));morphToShow=new Morph;morphToShow=new Morph;morphToShow.isCachingImage=true;morphToShow.bounds.setWidth(img.width);morphToShow.bounds.setHeight(img.height);morphToShow.cachedImage=img;morphToShow.isDraggable=true;morphToShow.selectForEdit=function(){var cst=value.copy(),icon,prepare;cst.name=ide.currentSprite.newCostumeName(cst.name);icon=new CostumeIconMorph(cst);prepare=icon.prepareToBeGrabbed;icon.prepareToBeGrabbed=function(hand){hand.grabOrigin={origin:ide.palette,position:ide.palette.center()};this.prepareToBeGrabbed=prepare};icon.setCenter(this.center());return icon};morphToShow.userMenu=function(){var menu=new MenuMorph(this);menu.addItem("export",()=>{if(value instanceof SVG_Costume){ide.saveFileAs(value.contents.src,"text/svg",value.name)}else{ide.saveCanvasAs(value.contents,value.name)}});return menu}}else if(value instanceof Sound){morphToShow=new SymbolMorph("notes",30);morphToShow.isDraggable=true;morphToShow.selectForEdit=function(){var snd=value.copy(),icon,prepare;snd.name=ide.currentSprite.newSoundName(snd.name);icon=new SoundIconMorph(snd);prepare=icon.prepareToBeGrabbed;icon.prepareToBeGrabbed=function(hand){hand.grabOrigin={origin:ide.palette,position:ide.palette.center()};this.prepareToBeGrabbed=prepare};icon.setCenter(this.center());return icon};morphToShow.userMenu=function(){var menu=new MenuMorph(this);menu.addItem("export",()=>ide.saveAudioAs(value.audio,value.name));return menu}}else if(value instanceof Context){img=value.image();morphToShow=new Morph;morphToShow.isCachingImage=true;morphToShow.bounds.setWidth(img.width);morphToShow.bounds.setHeight(img.height);morphToShow.cachedImage=img;morphToShow.version=value.version;morphToShow.step=function(){if(this.version!==value.version){img=value.image();this.cachedImage=img;this.version=value.version;this.changed()}};morphToShow.isDraggable=true;morphToShow.selectForEdit=function(){var script=value.toBlock(),prepare=script.prepareToBeGrabbed;script.prepareToBeGrabbed=function(hand){prepare.call(this,hand);hand.grabOrigin={origin:ide.palette,position:ide.palette.center()};this.prepareToBeGrabbed=prepare};script.setPosition(this.position());return script}}else if(typeof value==="boolean"){morphToShow=SpriteMorph.prototype.booleanMorph.call(null,value)}else if(isString(value)){txt=value.length>500?value.slice(0,500)+"...":value;morphToShow=new TextMorph(txt,this.fontSize);morphToShow.userMenu=function(){var menu=new MenuMorph(this);menu.addItem("export",()=>ide.saveFileAs(value,"text/plain;charset=utf-8",localize("data")));return menu}}else if(value===null){morphToShow=new TextMorph("",this.fontSize)}else if(value===0){morphToShow=new TextMorph("0",this.fontSize)}else if(value.toString){return this.showBubble(value.toString(),exportPic,target)}if(ide&&ide.currentSprite!==target){if(target instanceof StageMorph){anchor=ide.corral.stageIcon}else if(target){if(target.isTemporary){target=detect(target.allExemplars(),each=>!each.isTemporary)}anchor=detect(ide.corral.frame.contents.children,icon=>icon.object===target)}else{target=ide}pos=anchor.center()}bubble=new SpeechBubbleMorph(morphToShow,null,Math.max(this.rounding-2,6),0);bubble.popUp(wrrld,pos,isClickable);if(exportPic){this.exportPictureWithResult(bubble)}if(anchor instanceof SpriteIconMorph){bubble.keepWithin(ide.corral)}else if(sf){bubble.keepWithin(sf)}};SyntaxElementMorph.prototype.exportPictureWithResult=function(aBubble){var ide=this.parentThatIsA(IDE_Morph)||this.parentThatIsA(BlockEditorMorph).target.parentThatIsA(IDE_Morph),scr=this.fullImage(),bub=aBubble.fullImage(),taller=Math.max(0,bub.height-scr.height),pic=newCanvas(new Point(scr.width+bub.width+2,scr.height+taller)),ctx=pic.getContext("2d");ctx.drawImage(scr,0,pic.height-scr.height);ctx.drawImage(bub,scr.width+2,0);ide.saveFileAs(embedMetadataPNG(pic,this.toXMLString()),"image/png",(ide.getProjectName()||localize("untitled"))+" "+localize("script pic"))};SyntaxElementMorph.prototype.mappedCode=function(definitions){var result=this.evaluate();if(result instanceof BlockMorph){return result.mappedCode(definitions)}return result};BlockLabelMorph.prototype=new StringMorph;BlockLabelMorph.prototype.constructor=BlockLabelMorph;BlockLabelMorph.uber=StringMorph.prototype;function BlockLabelMorph(text,fontSize,fontStyle,bold,italic,isNumeric,shadowOffset,shadowColor,color,fontName){this.init(text,fontSize,fontStyle,bold,italic,isNumeric,shadowOffset,shadowColor,color,fontName)}BlockLabelMorph.prototype.getRenderColor=function(){var block=this.parentThatIsA(BlockMorph);if(MorphicPreferences.isFlat){return block.alpha>.5?this.color:block.color.solid().darker(Math.max(block.alpha*200,.1))}return block.alpha>.5?this.color:block.color.solid().lighter(Math.max(block.alpha*200,.1))};BlockLabelMorph.prototype.getShadowRenderColor=function(){return this.parentThatIsA(BlockMorph).alpha>.5?this.shadowColor:CLEAR};BlockSymbolMorph.prototype=new SymbolMorph;BlockSymbolMorph.prototype.constructor=BlockSymbolMorph;BlockSymbolMorph.uber=SymbolMorph.prototype;function BlockSymbolMorph(name,size,color,shadowOffset,shadowColor){this.init(name,size,color,shadowOffset,shadowColor)}BlockSymbolMorph.prototype.getRenderColor=function(){var block=this.parentThatIsA(BlockMorph);if(MorphicPreferences.isFlat){if(this.isFading){return this.color.mixed(block.alpha,WHITE)}if(this.color.eq(WHITE)){return this.parent.alpha>.5?this.color:block.color.solid().darker(Math.max(block.alpha*200,.1))}if(this.color.eq(BLACK)){return this.parent.alpha>.5?this.color:block.color.solid().darker(Math.max(block.alpha*200,.1))}return this.color}if(this.isFading){return this.color.mixed(block.alpha,SpriteMorph.prototype.paletteColor)}if(this.color.eq(BLACK)){return block.alpha>.5?this.color:block.color.solid().lighter(Math.max(block.alpha*200,.1))}if(this.color.eq(WHITE)){return this.parent.alpha>.5?this.color:block.color.solid().lighter(Math.max(block.alpha*200,.1))}return this.color};BlockSymbolMorph.prototype.getShadowRenderColor=function(){return this.parent.alpha>.5?this.shadowColor:CLEAR};BlockMorph.prototype=new SyntaxElementMorph;BlockMorph.prototype.constructor=BlockMorph;BlockMorph.uber=SyntaxElementMorph.prototype;BlockMorph.prototype.isCachingInputs=true;BlockMorph.prototype.zebraContrast=40;BlockMorph.prototype.snapSound=null;BlockMorph.prototype.toggleSnapSound=function(){if(this.snapSound!==null){this.snapSound=null}else{BlockMorph.prototype.snapSound=document.createElement("audio");BlockMorph.prototype.snapSound.src="data:audio/wav;base64,UklGRgASAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YdQJAAAzAZnlzc5mIMwWmQzMJWYCzdeZFZkYmsf/ApkAZvaZKmYaM+DMEP8FmtOZ9P8OZvzME5kYAPcz9cwHZvkA7mYI/wiZ7swB/w5m/AD3ZvaZ+pkA/w4zCpkAAPoA/QD3zPgzBAAAAPozE/8FzPJmAjMBZu2Z/ZkDZvyZA8wKZvzM/sz7zPgz+2b8MwEzBJkAMwH/AjP7zP6ZADP+ZvwzATMBZgKZ+pn3zAQA/Zn6zAHMBAAAzP5m/2YCZvbM9TMHMwHM+8wH/wIz+2b8mf3M/mb8M/uZAMwBM/7/AjMBM/7/Asz+AP1m/2b/M/4z/sz7Zv/MAQD9M/7M/mb/AACZADP+ZvwzAf8CzAEz/mYCzAEA+pn9MwGZ/WYCMwEA/QAAzP6ZAJkAmf2ZAMwBM/6ZADMBM/uZ/TMBAACZADMBM/7M/sz+AP3MBMwBzPtm/wAAM/5m/wAAmQAAADMBAACZAAAAZv/M+5n6M/7MAWYCmQMAAJkAAAAA/ZkAAAAz+2b/Zv+ZAJkDmQBm/zP+Zvlm/2b/zP4AAJkAmQAz/jMBmQDM/mb/mf1m/2b/Zv8AAMz+mQDMAWb/MwHMAZn9AAAAAJn9M/7/AjMBzP4AAGb/M/4AAGb/ZvyZ/TMBmQAA/TP+zPtm+f8C/wIzB2YFmf0A+pkDAP0z+8wBzP6ZAP8FzAFm//8CM/4z+zP7mf2ZA2YF/wIzAQAAZv9m/wD9mf3M/sz+ZgKZA2YCzP5m/5n9AP0A/Wb/zAHMAf8CAADM/pkAZv+Z/QAAZv8zAf8CzP7M/pkAM/4A/ZkAzP5m/8wBAADM/jP+AAAAAMz+mf3M/swBzAEzAcz+mQAzAcz+Zv8AAAAAZv9mAmb/mf2ZAGb/zP7M/jMBmQAz/mb/mQAz/jMBmQDM/mYCMwGZ/Wb/Zv/M/sz+Zv/M/swBZgKZAAAAZv9m/5kAmQAz/mb/zP5mAswBZv8AAMz+M/7M/pkAAAAzATMBAAAAADP+AABm/2b/ZgLM/mb/MwEz/jP+mQAzAQAAZv8AAAAAmQAz/pn9M/6Z/ZkAMwGZAJkAZv8z/sz+ZvwAAJkDZv8AAAD9mf0AAAAAZv9m/AAAMwGZAAAAZv+Z/TP+AAAzATMBZgLMAZn9ZvzM/mb8zP5m/2b/zAHMAQAAAABm/Jn9AP0z/gAAmQAAADMBAABm/2b/mf2Z/cz+MwGZAJkAAAAz/gAAzP6Z/TMBmQDM/gAAZv9m/8z+mQBm/8z+MwEzAQAAZv9m/8z+AACZ/TP+MwEAAGb/mQAz/mb8zP4z/pn9mQDM/pn9mQCZAGb/M/4A/Zn9Zv/M/pkAmQCZ/Wb/AABm/Gb/Zv/M/jMBZv/M/pkAZv9m/Gb8zP7M/gAAmQBm/zP+AADM/gD9zP6ZAAAAMwFm/8z+Zv+Z/QD9M/5m/5kAMwEz/jP+Zv/M/sz+Zv8z/jMBmQCZADP+zP4AAJn9M/7M/mb/zAFmApkAM/5m/wAAM/5m/5kAZv8zAcwBAADM/mb/mf1m/2b/AACZAMwBMwHM/mb/mf0z/pkAzAFm/8wBzAFm/2b/zP4A/Wb/MwGZAJkAZv8z/sz+Zv8z/jP+MwHMAZkAAAAAADP+AADM/jP+mQDMAf8CAADM/gAAMwFm/8z+Zv8AAMwB/wIAAAAAMwEz/sz+mQDM/mYCZgIAAMz+MwHM/mb/Zv+ZADMBMwEzAQAAzP7M/mb/Zv+ZAJkAmQBm/wAAzP5m/8z+Zv+ZAJkAAABm/8z+Zv/M/mb/zP6ZAMwBzAFm/zP+mf2Z/Wb/AAAAAP8CmQAAAJkAzP4z/mb/mQAzATMBzAFm/wD9Zv/M/sz+AADM/gAAzAFm/5n9mQDM/gAAMwEzATP4ZvYz/mYIMwQzBMz7mfEz/swNMwGZADMHmQAz7Jn6mQZmDv8L/wgA/QDuzeZm/8wTmQmZ+pn0mfSZ9DP7zBBmGpkGAPGZ98z7Zvkz9cz4/wVmCGb/ZgszAcz7zA1mC2btZuHM9QD9ZgLMEzMNMwRmBWYLM/UA6zPyZv/M/mYOMwrM+AD0mfrM8v8O/xoAAAD0mfTM9ZkAzArMEJkGzPuZ+mb2zO8z9f8LMw2ZA5n3ZvyZBmYCZgXMB5n0M+mZ9Jn6ZggzE8wQMwoz+8zyM/WZ+jP+ZgUAAAD6mf3/BWYFZgUAAAD9mfoz+2b8ZgJm/zMBmQAA/cz4Zv+ZBjMK/wVmAgD3mfRm+cwBmQNmBQAAM/5m/Jn9MwEzCjMEmfrM+Gb2mfozBMwH/wj/BWb8APeZ95n6AACZADMBmQP/Asz+AP0z+wAAZv8z/sz7Zv8zBGYFzAT/BZkAZvbM9TP7AABmBcwEmQBm/zP+Zvlm/8wBZv8AAJn9zP4zAZkAAAAAADP7zPsAAJkDMwRmBZkAmf2Z/TP7ZvzM/mb8MwGZAzMBmQAzAcz+M/5m/Jn9mf0AAAAAmQDMAZkDmQAzAZn9zPsz/mb/M/7/AgAAzP4zAcwBZv8zAQD9zP6ZADMBM/7MAZkAzP4AAJkAAAAAAMz+AAAA/TP+Zv+ZAMz+ZgIzAcz+zP7M/sz+Zvwz/jMBM/7MAcwEmQBm/2b/M/6Z+pn9M/4AAP8CMwFm/2b/AP2ZAGb/zP6ZADMBM/5m/8z+M/6ZAGb/M/4zAZkAmQAAAGb/AP3M+5n9AACZ/Wb/zAFmAjMB/wIz/jP+Zv/M/pn9MwGZAGYCMwGZAMz+AAAz/pn9zPuZAP8CZgJm/8z+M/4z/gD9Zv9m/wAAAAD/AswBMwFm/wAAZv9m/2b/AAAAAMwBZv/M/jP+M/5m/8wBZgIAAAAAZv9m/zP+mQAAAMz+zP5m/8z+AAAAAGYCAABm/wAAZv8A/Wb8M/5m/zMBzAFm/wAAzP5m/wAAzP7M/jP+zP5m/5kAZv9m/2b/AP2Z/Zn9mQDM/pkAZv9m/5kAZv8z/mb/AAAAAJkAzP4z/pkAAABm/wAAzP7M+zP+M/5m/5kAMwGZ/TP+AACZADMBmQMzAcz7Zvwz/jP+AAAzATP+M/7MAZkAM/5m/8z+AP0z/pkAAADMAZkAAACZAGb/zP4zAWb/zP5m/8z+zP6ZAGb/MwHMAcz+mQAzATP+AAAAAGb/M/4AADMBMwEAAGb/zP7M/jP+M/5m/5kAZv/MATMBmQCZADP+M/5m/2b/AACZAMwBAADM/sz+Zv+Z/TP+M/6ZAAAAMwEzATP+Zv8AAMz+AACZAGb8mf3MAWb/zP5m/zMBAAAzAWb/mQDM/gAAAAAAADP+Zv8z/sz+AADMAWb/mQAz/gAAmf1m/8z+AAAAADMBMwEzAWb/M/4AAJkAMwGZAMwBzP5m/Jn9zP7MAWYC/wIzAWb/mQBm/5n9mQDMAQAAAABm/zMBAABm/2ZhY3QEAAAARklMVERJU1AsBwAACAAAACgAAAAdAAAAGAAAAAEACAAAAAAAAAMAAAAAAAAAAAAAAAEAAAABAAAAAAAAAACAAACAAAAAgIAAgAAAAIAAgACAgAAAwMDAAMDcwADwyqYA////AAAAAAD/gAAAgEAAAP8AQAAAQIAAgP//AID/AAD//4AA/4CAAIAA/wBAgP8AAAAAAAAAAABAgIAAQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADw+/8ApKCgAICAgAAAAP8AAP8AAAD//wD/AAAA/wD/AP//AAD///8A//////////////////////////////////////8AAAD//////////////////////////////////////wAAAP//////////////////////////////////////AAAA//////////////////////////////////////8AAAD//////////////////////////////////////wAAAP//////////////AAAAAP//////////////////AAAA////////////AAD7+/v7AAD///////////////8AAAD//////////wD7+/v7+/v7+wD//////////////wAAAP/////////4+/v4AAAAAPj7+wD/////////////AAAA//////////j7+AD7+/v7APj7AP////////////8AAAD////////4+/sA+/v7+/v7APv7AP///////////wAAAP////////j7+wD7+/v7+/sA+/sA////////////AAAA////////+Pv7+/v7+/v7+/v7+wD///////////8AAAD////////4+/v7AAD7+wAA+/v7AP///////////wAAAP/////////4+/sAAPv7AAD7+wD/////////////AAAA//////////j7+/v7+/v7+/v7AP////////////8AAAD///////////j7+/v7+/v7+wD//////////////wAAAP////////////j4+/v7+/j4////////////////AAAA///////////////4+Pj4//////////////////8AAAD//////////////////////////////////////wAAAP//////////////////////////////////////AAAA//////////////////////////////////////8AAAD//////////////////////////////////////wAAAP//////////////////////////////////////AAAARElTUCMAAAABAAAAV2luZG93cyA5NSBVdG9waWEgU291bmQgU2NoZW1lAABMSVNUlAAAAElORk9JQ01URgAAAE1heiAmIEtpbGdvcmUNCjIwOCBXLiAzMHRoICM3MDENCk5ldyBZb3JrLCBOWSAxMDAwMQ0KbWF6cm9iQHBhbml4LmNvbQBJQ09QGwAAADE5OTUgTWljcm9zb2Z0IENvcnBvcmF0aW9uAABJU0JKFgAAAFV0b3BpYSBDbG9zZSBQcm9ncmFtIAA="}CommentMorph.prototype.snapSound=BlockMorph.prototype.snapSound};function BlockMorph(){this.init()}BlockMorph.prototype.init=function(){this.selector=null;this.blockSpec="";this.comment=null;this.instantiationSpec=null;this.category=null;this.isCorpse=false;BlockMorph.uber.init.call(this);this.color=new Color(102,102,102);this.cachedInputs=null};BlockMorph.prototype.scriptTarget=function(noError){var scripts=this.parentThatIsA(ScriptsMorph),ide,dlg;if(scripts){return scripts.scriptTarget()}ide=this.parentThatIsA(IDE_Morph);if(ide){return ide.currentSprite}dlg=this.parentThatIsA(DialogBoxMorph);if(dlg){if(isSnapObject(dlg.target)){return dlg.target}if(dlg.target instanceof IDE_Morph){return dlg.target.currentSprite}}if(noError){return null}throw new Error("script target cannot be found for orphaned block")};BlockMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+' ("'+this.blockSpec.slice(0,30)+'...")'};BlockMorph.prototype.parseSpec=function(spec){var result=[],words,word="";words=isString(spec)?spec.split(" "):[];if(words.length===0){words=[spec]}if(this.labelWordWrap){return words}function addWord(w){if(w[0]==="%"&&w.length>1){if(word!==""){result.push(word);word=""}result.push(w)}else{if(word!==""){word+=" "+w}else{word=w}}}words.forEach(each=>addWord(each));if(word!==""){result.push(word)}return result};BlockMorph.prototype.setSpec=function(spec,definition){var part,inputIdx=-1;if(!spec){return}this.parts().forEach(part=>part.destroy());if(this.isPrototype){this.add(this.placeHolder())}this.parseSpec(spec).forEach((word,idx,arr)=>{if(word[0]==="%"&&word!=="%br"){inputIdx+=1}part=this.labelPart(word);if(isNil(part)){return}this.add(part);if(!(part instanceof CommandSlotMorph||part instanceof StringMorph)){part.fixLayout();part.rerender()}if(part instanceof RingMorph){part.fixBlockColor()}if(part instanceof MultiArgMorph||part.constructor===CommandSlotMorph||part.constructor===RingCommandSlotMorph){part.fixLayout()}if(this.isPrototype){this.add(this.placeHolder())}if(part instanceof InputSlotMorph&&this.isCustomBlock){part.setChoices.apply(part,(definition||this.definition).inputOptionsOfIdx(inputIdx))}});this.blockSpec=spec;this.fixLayout();this.rerender();this.cachedInputs=null};BlockMorph.prototype.userSetSpec=function(spec){var tb=this.topBlock();tb.fullChanged();this.setSpec(spec);tb.fullChanged()};BlockMorph.prototype.buildSpec=function(){this.blockSpec="";this.parts().forEach(part=>{if(part instanceof StringMorph){this.blockSpec+=part.text}else if(part instanceof ArgMorph){this.blockSpec+=part.getSpec()}else if(part.isBlockLabelBreak){this.blockSpec+=part.getSpec()}else{this.blockSpec+="[undefined]"}this.blockSpec+=" "});this.blockSpec=this.blockSpec.trim()};BlockMorph.prototype.rebuild=function(contrast){this.setSpec(this.blockSpec);if(contrast){this.inputs().forEach(input=>{if(input instanceof ReporterBlockMorph){input.setColor(input.color.lighter(contrast));input.setSpec(input.blockSpec)}})}};BlockMorph.prototype.abstractBlockSpec=function(){return this.parseSpec(this.blockSpec).map(str=>str.length>1&&str[0]==="%"?"_":str).join(" ")};BlockMorph.prototype.userMenu=function(){var menu=new MenuMorph(this),world=this.world(),myself=this,hasLine=false,proc=this.activeProcess(),top=this.topBlock(),vNames=proc&&proc.context&&proc.context.outerContext?proc.context.outerContext.variables.names():[],slot,mult,alternatives,field,rcvr;function addOption(label,toggle,test,onHint,offHint){menu.addItem([test?new SymbolMorph("checkedBox",MorphicPreferences.menuFontSize*.75):new SymbolMorph("rectangle",MorphicPreferences.menuFontSize*.75),localize(label)],toggle,test?onHint:offHint)}function renameVar(){var blck=myself.fullCopy();blck.addShadow();new DialogBoxMorph(myself,myself.userSetSpec,myself).prompt("Variable name",myself.blockSpec,world,blck.doWithAlpha(1,()=>blck.fullImage()),InputSlotMorph.prototype.getVarNamesDict.call(myself))}menu.addItem("help...","showHelp");if(this.isTemplate){if(this.parent instanceof SyntaxElementMorph){if(this.selector==="reportGetVar"){menu.addLine();menu.addItem("rename...",()=>this.refactorThisVar(true),"rename only\nthis reporter");menu.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable");if(this.parent.parent instanceof MultiArgMorph&&this.parentThatIsA(ScriptsMorph)){slot=this.parent;mult=slot.parent;menu.addLine();if(!mult.maxInputs||mult.inputs().length<mult.maxInputs){if(!mult.is3ArgRingInHOF()||mult.inputs().length<3){menu.addItem("insert a variable",()=>mult.insertNewInputBefore(slot,localize("variable")))}}if(mult.inputs().length>mult.minInputs){menu.addItem("delete variable",()=>mult.deleteSlot(slot))}}}}else{if(this.selector==="reportGetVar"){rcvr=this.scriptTarget();if(this.isInheritedVariable(false)){addOption("inherited",()=>rcvr.toggleInheritedVariable(this.blockSpec),true,"uncheck to\ndisinherit",null)}else{if(this.isInheritedVariable(true)){addOption("inherited",()=>rcvr.toggleInheritedVariable(this.blockSpec),false,null,localize("check to inherit\nfrom")+" "+rcvr.exemplar.name)}addOption("transient","toggleTransientVariable",this.isTransientVariable(),"uncheck to save contents\nin the project","check to prevent contents\nfrom being saved");menu.addLine();menu.addItem("rename...",()=>this.refactorThisVar(true),"rename only\nthis reporter");menu.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable")}}if(StageMorph.prototype.enableInheritance){rcvr=this.scriptTarget();field={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",getCostumeIdx:"costume #",getVolume:"volume",getPan:"balance",reportShown:"shown?",getPenDown:"pen down?"}[this.selector];if(field&&rcvr&&rcvr.exemplar){menu.addLine();addOption("inherited",()=>rcvr.toggleInheritanceForAttribute(field),rcvr.inheritsAttribute(field),"uncheck to\ndisinherit",localize("check to inherit\nfrom")+" "+rcvr.exemplar.name)}}if(StageMorph.prototype.enableCodeMapping){menu.addLine();menu.addItem("header mapping...","mapToHeader");menu.addItem("code mapping...","mapToCode")}}return menu}menu.addLine();if(this.selector==="reportGetVar"){menu.addItem("rename...",renameVar,"rename only\nthis reporter")}else if(SpriteMorph.prototype.blockAlternatives[this.selector]){menu.addItem("relabel...",()=>this.relabel(SpriteMorph.prototype.blockAlternatives[this.selector]))}else if(this.isCustomBlock&&this.alternatives){alternatives=this.alternatives();if(alternatives.length>0){menu.addItem("relabel...",()=>this.relabel(alternatives))}}if(contains(["reportMap","reportKeep","reportFindFirst","reportCombine"],this.selector)){alternatives={reportMap:"reportAtomicMap",reportKeep:"reportAtomicKeep",reportFindFirst:"reportAtomicFindFirst",reportCombine:"reportAtomicCombine"};menu.addItem("compile",()=>this.setSelector(alternatives[this.selector]),"experimental!\nmake this reporter fast and uninterruptable\n"+"CAUTION: Errors in the ring\ncan break your Snap! session!")}else if(contains(["reportAtomicMap","reportAtomicKeep","reportAtomicFindFirst","reportAtomicCombine"],this.selector)){alternatives={reportAtomicMap:"reportMap",reportAtomicKeep:"reportKeep",reportAtomicFindFirst:"reportFindFirst",reportAtomicCombine:"reportCombine"};menu.addItem("uncompile",()=>this.setSelector(alternatives[this.selector]))}else if(contains(["reportPenTrailsAsCostume","reportPentrailsAsSVG"],this.selector)){alternatives={reportPenTrailsAsCostume:"reportPentrailsAsSVG",reportPentrailsAsSVG:"reportPenTrailsAsCostume"};menu.addItem(localize(SpriteMorph.prototype.blocks[alternatives[this.selector]].spec),()=>{this.setSelector(alternatives[this.selector]);this.changed()})}menu.addItem("duplicate",()=>{var dup=this.fullCopy(),ide=this.parentThatIsA(IDE_Morph),blockEditor=this.parentThatIsA(BlockEditorMorph);dup.pickUp(world);if(!ide&&blockEditor){ide=blockEditor.target.parentThatIsA(IDE_Morph)}if(ide){world.hand.grabOrigin={origin:ide.palette,position:ide.palette.center()}}},"make a copy\nand pick it up");if(this instanceof CommandBlockMorph&&this.nextBlock()){menu.addItem((proc?this.fullCopy():this).thumbnail(.5,60),()=>{var cpy=this.fullCopy(),nb=cpy.nextBlock(),ide=this.parentThatIsA(IDE_Morph),blockEditor=this.parentThatIsA(BlockEditorMorph);if(nb){nb.destroy()}cpy.pickUp(world);if(!ide&&blockEditor){ide=blockEditor.target.parentThatIsA(IDE_Morph)}if(ide){world.hand.grabOrigin={origin:ide.palette,position:ide.palette.center()}}},"only duplicate this block");menu.addItem("extract","userExtractJustThis","only grab this block")}menu.addItem("delete","userDestroy");if(isNil(this.comment)){menu.addItem("add comment",()=>{var comment=new CommentMorph;this.comment=comment;comment.block=this;comment.layoutChanged();var scripts=this.parentThatIsA(ScriptsMorph),ide=this.parentThatIsA(IDE_Morph),blockEditor=this.parentThatIsA(BlockEditorMorph);if(!ide&&blockEditor){ide=blockEditor.target.parentThatIsA(IDE_Morph)}if(ide){world.hand.grabOrigin={origin:ide.palette,position:ide.palette.center()}}scripts.clearDropInfo();scripts.lastDropTarget={element:this};scripts.lastDroppedBlock=comment;scripts.recordDrop(world.hand.grabOrigin)})}menu.addLine();menu.addItem("script pic...",()=>{var ide=this.parentThatIsA(IDE_Morph)||this.parentThatIsA(BlockEditorMorph).target.parentThatIsA(IDE_Morph),xml=top instanceof PrototypeHatBlockMorph?ide.blocksLibraryXML([top.definition].concat(top.definition.collectDependencies([],[],top.scriptTarget())),null,true):top.toXMLString();ide.saveFileAs(embedMetadataPNG(top.scriptPic(),xml),"image/png",(ide.getProjectName()||localize("untitled"))+" "+localize("script pic"))},"save a picture\nof this script");if(top instanceof ReporterBlockMorph||!(top instanceof PrototypeHatBlockMorph)&&top.allChildren().some(any=>any.selector==="doReport")){menu.addItem("result pic...",()=>top.exportResultPic(),"save a picture of both\nthis script and its result")}if(top instanceof PrototypeHatBlockMorph){menu.addItem("export...",()=>top.exportBlockDefinition(),"including dependencies")}else{menu.addItem("export script",()=>top.exportScript(),"download this script\nas an XML file")}if(proc){if(vNames.length){menu.addLine();vNames.forEach(vn=>menu.addItem(vn+"...",()=>proc.doShowVar(vn)))}proc.homeContext.variables.names().forEach(vn=>{if(!contains(vNames,vn)){menu.addItem(vn+"...",()=>proc.doShowVar(vn))}});return menu}if(this.parent.parentThatIsA(RingMorph)){menu.addLine();menu.addItem("unringify","unringify");if(this instanceof ReporterBlockMorph||!(top instanceof HatBlockMorph)){menu.addItem("ringify","ringify")}return menu}if(contains(["doBroadcast","doBroadcastAndWait","receiveMessage","receiveOnClone","receiveGo"],this.selector)){hasLine=true;menu.addLine();menu.addItem(this.selector.indexOf("receive")===0?"senders...":"receivers...","showMessageUsers")}if(this.parent instanceof ReporterSlotMorph||this.parent instanceof CommandSlotMorph||this instanceof HatBlockMorph||this instanceof CommandBlockMorph&&top instanceof HatBlockMorph){return menu}if(!hasLine){menu.addLine()}menu.addItem("ringify","ringify");if(StageMorph.prototype.enableCodeMapping){menu.addLine();menu.addItem("header mapping...","mapToHeader");menu.addItem("code mapping...","mapToCode")}return menu};BlockMorph.prototype.showMessageUsers=function(){var ide=this.parentThatIsA(IDE_Morph)||this.parentThatIsA(BlockEditorMorph).target.parentThatIsA(IDE_Morph),corral=ide.corral,isSender=this.selector.indexOf("doBroadcast")===0,isReceiver=this.selector.indexOf("receive")===0,getter=isReceiver?"allSendersOf":"allHatBlocksFor",inputs=this.inputs(),message,receiverSlot,receiverName,knownSenders;if(this.selector==="receiveGo"){message="__shout__go__"}else if(this.selector==="receiveOnClone"){message="__clone__init__"}else if(inputs[0]instanceof InputSlotMorph){message=inputs[0].evaluate();if(isSender&&message instanceof Array){message=message[0]}}if(isSender){receiverSlot=inputs[1].inputs()[0];if(receiverSlot instanceof InputSlotMorph){receiverName=receiverSlot.evaluate();if(receiverName instanceof Array){receiverName=null}}}else if(isReceiver){receiverName=this.scriptTarget().name}if(message!==""){if(isReceiver){knownSenders=ide.stage.globalBlocksSending(message,receiverName)}corral.frame.contents.children.concat(corral.stageIcon).forEach(icon=>{if(icon.object&&icon.object[getter](message,receiverName,knownSenders).length){icon.flash()}})}};BlockMorph.prototype.isSending=function(message,receiverName,known=[]){if(typeof message==="number"){message=message.toString()}return this.allChildren().some(morph=>{var inputs,event,receiverSlot,eventReceiver;if(morph.isCustomBlock&&morph.isGlobal&&contains(known,morph.definition)){return true}if(morph.selector&&morph.selector.indexOf("doBroadcast")===0){inputs=morph.inputs();event=inputs[0].evaluate();if(event instanceof Array){event=event[0]}receiverSlot=inputs[1].inputs()[0];if(receiverSlot instanceof InputSlotMorph){eventReceiver=receiverSlot.evaluate();if(eventReceiver instanceof Array){eventReceiver=null}}return(!eventReceiver||receiverName===eventReceiver)&&(event===message||message instanceof Array&&message[0]==="any message"&&event!=="__shout__go__")}return false})};BlockMorph.prototype.developersMenu=function(){var menu=BlockMorph.uber.developersMenu.call(this);menu.addLine();menu.addItem("delete block","deleteBlock");menu.addItem("spec...",()=>new DialogBoxMorph(this,this.userSetSpec,this).prompt(menu.title+"\nspec",this.blockSpec,this.world()));return menu};BlockMorph.prototype.isChangeableTo=function(type){var typ=this.type();if(typ===type){return true}if(typ==="command"||type==="command"){return this.isUnattached()}return true};BlockMorph.prototype.type=function(){return this instanceof CommandBlockMorph?"command":this.isPredicate?"predicate":"reporter"};BlockMorph.prototype.isUnattached=function(){return(this.nextBlock&&!this.nextBlock()||!this.nextBlock)&&!(this.parent instanceof SyntaxElementMorph)&&!(this.parent instanceof ScriptsMorph)};BlockMorph.prototype.isInheritedVariable=function(shadowedOnly){if(this.isTemplate&&this.selector==="reportGetVar"&&this.parent instanceof FrameMorph){return contains(this.scriptTarget().inheritedVariableNames(shadowedOnly),this.blockSpec)}return false};BlockMorph.prototype.isTransientVariable=function(){var varFrame=this.scriptTarget().variables.silentFind(this.blockSpec);return varFrame?varFrame.vars[this.blockSpec].isTransient:false};BlockMorph.prototype.toggleTransientVariable=function(){var varFrame=this.scriptTarget().variables.silentFind(this.blockSpec);if(!varFrame){return}varFrame.vars[this.blockSpec].isTransient=!varFrame.vars[this.blockSpec].isTransient};BlockMorph.prototype.deleteBlock=function(){var scripts=this.parentThatIsA(ScriptsMorph),nb=this.nextBlock?this.nextBlock():null,tobefixed,isindef;if(scripts){if(nb){scripts.add(nb)}this.inputs().forEach(inp=>{if(inp instanceof BlockMorph){scripts.add(inp)}})}if(this instanceof ReporterBlockMorph&&(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)){this.parent.revertToDefaultInput(this)}else{if(this.parent&&this.parent.fixLayout){tobefixed=this.parentThatIsA(ArgMorph)}else{isindef=true}}this.destroy();if(isindef){this.isCorpse=true}if(tobefixed){tobefixed.fixLayout()}};BlockMorph.prototype.ringify=function(){var ring,top,center,target=this.selectForEdit();if(target!==this){return this.ringify.call(target)}ring=new RingMorph;top=this.topBlock();center=top.fullBounds().center();if(this.parent===null){return null}top.fullChanged();if(this.parent instanceof SyntaxElementMorph){if(this instanceof ReporterBlockMorph){this.parent.replaceInput(this,ring,true);ring.embed(this,null,true)}else if(top){if(top instanceof HatBlockMorph){return}top.parent.add(ring);ring.embed(top);ring.setCenter(center)}}else{this.parent.add(ring);ring.embed(this);ring.setCenter(center)}this.fixBlockColor(null,true);top.fullChanged();this.scriptTarget().parentThatIsA(IDE_Morph).recordUnsavedChanges()};BlockMorph.prototype.unringify=function(){var ring,top,center,scripts,block,target=this.selectForEdit();if(target!==this){return this.unringify.call(target)}ring=this.parent.parentThatIsA(RingMorph);top=this.topBlock();scripts=this.parentThatIsA(ScriptsMorph);if(ring===null){return null}block=ring.contents();center=ring.center();top.fullChanged();if(ring.parent instanceof SyntaxElementMorph){if(block instanceof ReporterBlockMorph){ring.parent.replaceInput(ring,block)}else if(scripts){scripts.add(block);block.setFullCenter(center);block.moveBy(20);ring.parent.revertToDefaultInput(ring)}}else{ring.parent.add(block);block.setFullCenter(center);ring.destroy()}this.fixBlockColor(null,true);top.fullChanged();this.scriptTarget().parentThatIsA(IDE_Morph).recordUnsavedChanges()};BlockMorph.prototype.relabel=function(alternativeSelectors){var menu,oldInputs,target=this.selectForEdit();if(target!==this){return this.relabel.call(target,alternativeSelectors)}menu=new MenuMorph(this);oldInputs=this.inputs();alternativeSelectors.forEach(alternative=>{var block,selector,offset;if(alternative instanceof Array){selector=alternative[0];offset=-alternative[1]}else{selector=alternative;offset=0}block=SpriteMorph.prototype.blockForSelector(selector,true);block.restoreInputs(oldInputs,offset);block.fixBlockColor(null,true);block.addShadow(new Point(3,3));menu.addItem(block.doWithAlpha(1,()=>block.fullImage()),()=>{this.setSelector(selector,-offset);this.scriptTarget().parentThatIsA(IDE_Morph).recordUnsavedChanges()})});menu.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))};BlockMorph.prototype.setSelector=function(aSelector,inputOffset=0){var oldInputs=this.inputs(),scripts=this.parentThatIsA(ScriptsMorph),surplus,info,slots,i;info=SpriteMorph.prototype.blocks[aSelector];this.setCategory(info.category);this.selector=aSelector;this.setSpec(localize(info.spec));this.defaults=info.defaults||[];slots=this.inputs();if(slots[0]instanceof MultiArgMorph){slots[0].setContents(this.defaults);slots[0].defaults=this.defaults}else{for(i=0;i<this.defaults.length;i+=1){if(this.defaults[i]!==null&&slots[i].setContents){slots[i].setContents(this.defaults[i])}}}surplus=this.restoreInputs(oldInputs,-inputOffset);this.fixLabelColor();if(scripts&&surplus.length){surplus.forEach(blk=>{blk.moveBy(10);scripts.add(blk)})}};BlockMorph.prototype.restoreInputs=function(oldInputs,offset=0){var old,nb,i,src,trg,element=this,inputs=this.inputs(),leftOver=[];for(i=0;i<offset;i+=1){old=oldInputs[i];if(old instanceof ReporterBlockMorph){leftOver.push(old)}else if(old instanceof CommandSlotMorph){nb=old.nestedBlock();if(nb){leftOver.push(nb)}}}src=oldInputs[0];trg=inputs[0];if(oldInputs.length===1&&inputs.length===1&&src instanceof MultiArgMorph&&trg instanceof MultiArgMorph&&src.slotSpec===trg.slotSpec&&src.infix!==trg.infix){element=trg;oldInputs=src.inputs();while(element.inputs().length<oldInputs.length){element.addInput()}inputs=element.inputs()}else if(oldInputs.length&&inputs.length===1&&trg instanceof MultiArgMorph&&!(src instanceof MultiArgMorph)&&!(src instanceof ArgLabelMorph)){element=trg;inputs=element.inputs()}else if(oldInputs.length===1&&inputs.length&&src instanceof MultiArgMorph&&!(trg instanceof MultiArgMorph)){oldInputs=src.inputs()}inputs.forEach(inp=>{old=oldInputs[offset];if(old instanceof ArgLabelMorph){old=old.argMorph()}if(old instanceof RingMorph){if(old.contents()){element.replaceInput(inp,old.fullCopy())}}else if(old instanceof ReporterBlockMorph){if(inp instanceof TemplateSlotMorph||inp.isStatic){leftOver.push(old)}else{element.replaceInput(inp,old.fullCopy())}}else if(old&&inp instanceof InputSlotMorph){if(old.contents){inp.setContents(old.contents().text);if(old.constant){inp.constant=old.constant}}}else if(old instanceof CSlotMorph&&inp instanceof CSlotMorph){nb=old.nestedBlock();if(nb){inp.nestedBlock(nb.fullCopy())}}else if(old instanceof MultiArgMorph&&inp instanceof MultiArgMorph&&old.slotSpec===inp.slotSpec&&old.infix===inp.infix){element.replaceInput(inp,old.fullCopy())}offset+=1});for(offset;offset<oldInputs.length;offset+=1){old=oldInputs[offset];if(old instanceof ReporterBlockMorph){leftOver.push(old)}else if(old instanceof CommandSlotMorph){nb=old.nestedBlock();if(nb){leftOver.push(nb)}}}element.cachedInputs=null;this.cachedInputs=null;return leftOver};BlockMorph.prototype.showHelp=function(){var myself=this,ide=this.parentThatIsA(IDE_Morph),pic=new Image,dlg,help,def,comment,block,spec,ctx;if(this.isCustomBlock){if(this.isGlobal){spec=this.definition.helpSpec()}else{spec=this.scriptTarget().getMethod(this.blockSpec).helpSpec()}}else{spec=this.selector}if(!ide){dlg=this.parentThatIsA(DialogBoxMorph);if(dlg&&isSnapObject(dlg.target)){ide=dlg.target.parentThatIsA(IDE_Morph)}}pic.onload=function(){help=newCanvas(new Point(pic.width,pic.height),true);ctx=help.getContext("2d");ctx.drawImage(pic,0,0);(new DialogBoxMorph).inform("Help",null,myself.world(),help)};if(this.isCustomBlock){def=this.isGlobal?this.definition:this.scriptTarget().getMethod(this.blockSpec);comment=def.comment;if(comment){block=def.blockInstance();block.refreshDefaults(def);comment=comment.fullCopy();comment.contents.parse();help="";comment.contents.lines.forEach(line=>help=help+"\n"+line);(new DialogBoxMorph).inform("Help",help.substr(1),myself.world(),block.doWithAlpha(1,()=>{block.addShadow();return block.fullImage()}));return}}pic.src=ide.resourceURL("help",spec+".png")};BlockMorph.prototype.exportResultPic=function(){var top=this.topBlock(),receiver=top.scriptTarget(),stage;if(top!==this){return}if(receiver){stage=receiver.parentThatIsA(StageMorph);if(stage){stage.threads.stopProcess(top);stage.threads.startProcess(top,receiver,false,true)}}};BlockMorph.prototype.exportScript=function(){var ide=this.parentThatIsA(IDE_Morph),blockEditor=this.parentThatIsA(BlockEditorMorph),xml;if(!ide&&blockEditor){ide=blockEditor.target.parentThatIsA(IDE_Morph)}if(!ide){return}xml=this.toXMLString();if(xml){ide.saveXMLAs(xml,this.selector+" script",false)}};BlockMorph.prototype.toXMLString=function(receiver){var ide=this.parentThatIsA(IDE_Morph),blockEditor=this.parentThatIsA(BlockEditorMorph),isReporter=this instanceof ReporterBlockMorph,dependencies;if(!ide&&blockEditor){ide=blockEditor.target.parentThatIsA(IDE_Morph)}if(!ide){return}dependencies=this.dependencies(false,receiver);return'<script app="'+ide.serializer.app+'" version="'+ide.serializer.version+'">'+(dependencies.length?ide.blocksLibraryXML(dependencies):"")+(isReporter?"<script>":"")+ide.serializer.serialize(this)+(isReporter?"<\/script>":"")+"<\/script>"};BlockMorph.prototype.dependencies=function(onlyGlobal,receiver){var dependencies=[],rcvr=onlyGlobal?null:receiver||this.scriptTarget();this.forAllChildren(morph=>{var def;if(morph.isCustomBlock){if(!onlyGlobal||onlyGlobal&&morph.isGlobal){def=morph.isGlobal?morph.definition:rcvr.getMethod(morph.semanticSpec);[def].concat(def.collectDependencies([],[],rcvr)).forEach(fun=>{if(!contains(dependencies,fun)){dependencies.push(fun)}})}}});return dependencies};BlockMorph.prototype.components=function(parameterNames=[]){if(this instanceof ReporterBlockMorph){return this.syntaxTree(parameterNames)}var seq=new List(this.blockSequence()).map((block,i)=>block.syntaxTree(i<1?parameterNames:[]));return seq.length()===1?seq.at(1):seq};BlockMorph.prototype.syntaxTree=function(parameterNames){var expr=this.fullCopy(),nb=expr.nextBlock?expr.nextBlock():null,inputs,parts;if(nb){nb.destroy()}expr.fixBlockColor(null,true);inputs=expr.inputs();parts=new List([expr.reify()]);inputs.forEach(inp=>{var val;if(inp instanceof BlockMorph){if(inp instanceof RingMorph&&inp.isEmptySlot()){parts.add();return}parts.add(inp.components());expr.revertToEmptyInput(inp)}else if(inp.isEmptySlot()){parts.add()}else if(inp instanceof MultiArgMorph){if(!inp.inputs().length){parts.add()}inp.inputs().forEach((slot,i)=>{var entry;if(slot instanceof BlockMorph){if(slot instanceof RingMorph&&slot.isEmptySlot()){parts.add();return}parts.add(slot.components())}else if(slot.isEmptySlot()){parts.add()}else{entry=slot.evaluate();parts.add(entry instanceof BlockMorph?entry.components():entry)}inp.revertToEmptyInput(slot)})}else if(inp instanceof ArgLabelMorph){parts.add(inp.argMorph().components());expr.revertToEmptyInput(inp).collapseAll()}else{val=inp.evaluate();if(val instanceof Array){val="["+val+"]"}if(inp instanceof ColorSlotMorph){val=val.toString()}parts.add(val instanceof BlockMorph?val.components():val);expr.revertToEmptyInput(inp,true)}});parts.at(1).updateEmptySlots();if(expr.selector==="reportGetVar"){parts.add(expr.blockSpec);expr.setSpec(" ")}parameterNames.forEach(name=>parts.add(name));return parts};BlockMorph.prototype.equalTo=function(other){return this.constructor.name===other.constructor.name&&this.selector===other.selector&&this.blockSpec===other.blockSpec};BlockMorph.prototype.copyWithInputs=function(inputs){var cpy=this.fullCopy(),slots=cpy.inputs(),dta=inputs.itemsArray().map(inp=>inp instanceof Context?inp.expression:inp),count=0,dflt;function isOption(data){return isString(data)&&data.length>2&&data[0]==="["&&data[data.length-1]==="]"}if(dta.length===0){return cpy.reify()}if(cpy.selector==="reportGetVar"&&(dta.length===1||cpy.blockSpec===" "&&dta.length>1)){cpy.setSpec(dta[0]);return cpy.reify(dta.slice(1))}slots.forEach(slt=>{if(slt instanceof BlockMorph){dflt=cpy.revertToEmptyInput(slt);if(dflt instanceof MultiArgMorph){dflt.collapseAll()}}else if(slt instanceof MultiArgMorph){slt.inputs().forEach(entry=>{if(entry instanceof BlockMorph){slt.revertToEmptyInput(entry)}})}});slots=cpy.inputs();slots.forEach(slot=>{var inp,i,cnt;if(slot instanceof MultiArgMorph&&dta[count]instanceof List){inp=dta[count];if(inp.length()===0){nop()}else{slot.collapseAll();for(i=1;i<=inp.at(1);i+=1){cnt=inp.at(i+1);if(cnt instanceof List){cnt=Process.prototype.assemble(cnt)}if(cnt instanceof Context){slot.replaceInput(slot.addInput(),cnt.expression.fullCopy())}else{slot.addInput(cnt)}}}count+=1}else if(slot instanceof MultiArgMorph&&slot.inputs().length){slot.inputs().forEach(entry=>{inp=dta[count];if(inp instanceof BlockMorph){if(inp instanceof CommandBlockMorph&&entry.nestedBlock){entry.nestedBlock(inp)}else if(inp instanceof ReporterBlockMorph&&(!entry.isStatic||entry instanceof RingMorph)){slot.replaceInput(entry,inp)}}else{if(inp instanceof List&&inp.length()===0){nop()}else if(entry instanceof InputSlotMorph||entry instanceof TemplateSlotMorph||entry instanceof BooleanSlotMorph){entry.setContents(inp)}}count+=1})}else{inp=dta[count];if(inp===undefined){return}if(inp instanceof BlockMorph){if(inp instanceof CommandBlockMorph&&slot.nestedBlock){slot.nestedBlock(inp)}else if(inp instanceof ReporterBlockMorph&&(!slot.isStatic||slot instanceof RingMorph)){cpy.replaceInput(slot,inp)}else if(inp instanceof ReporterBlockMorph&&slot.nestedBlock){slot.nestedBlock(inp)}}else{if(inp instanceof List&&inp.length()===0){nop()}else if(slot instanceof ColorSlotMorph){slot.setColor(Color.fromString(inp))}else if(slot instanceof InputSlotMorph){slot.setContents(isOption(inp)?[inp.slice(1,-1)]:inp)}else if(slot instanceof TemplateSlotMorph||slot instanceof BooleanSlotMorph){slot.setContents(inp)}}count+=1}});return cpy.reify(dta.slice(count))};BlockMorph.prototype.copyWithNext=function(next,parameterNames){var expr=this.fullCopy(),top;if(this instanceof ReporterBlockMorph){return expr.reify()}top=next.fullCopy().topBlock();if(top instanceof CommandBlockMorph){expr.bottomBlock().nextBlock(top)}return expr.reify(parameterNames)};BlockMorph.prototype.reify=function(inputNames){var context=new Context;context.expression=this;context.inputs=inputNames||[];context.emptySlots=this.markEmptySlots();return context};BlockMorph.prototype.markEmptySlots=function(){var count=0;this.allInputs().forEach(input=>delete input.bindingID);this.allEmptySlots().forEach(slot=>{count+=1;if(slot instanceof MultiArgMorph){slot.bindingID=Symbol.for("arguments")}else{slot.bindingID=count}});return count};BlockMorph.prototype.mapToHeader=function(){var key=this.selector.substr(0,5)==="reify"?"reify":this.selector,block=this.codeDefinitionHeader(),help,pic;block.addShadow(new Point(3,3));pic=block.doWithAlpha(1,()=>block.fullImage());if(this.isCustomBlock){help="Enter code that corresponds to the block's definition. "+"Use the formal parameter\nnames as shown and <body> to "+"reference the definition body's generated text code."}else{help="Enter code that corresponds to the block's definition. "+"Choose your own\nformal parameter names (ignoring the ones "+"shown)."}new DialogBoxMorph(this,code=>{if(key==="evaluateCustomBlock"){this.definition.codeHeader=code}else{StageMorph.prototype.codeHeaders[key]=code}},this).promptCode("Header mapping",key==="evaluateCustomBlock"?this.definition.codeHeader||"":StageMorph.prototype.codeHeaders[key]||"",this.world(),pic,help)};BlockMorph.prototype.mapToCode=function(){var key=this.selector.substr(0,5)==="reify"?"reify":this.selector,block=this.codeMappingHeader(),pic;block.addShadow(new Point(3,3));pic=block.doWithAlpha(1,()=>block.fullImage());new DialogBoxMorph(this,code=>{if(key==="evaluateCustomBlock"){this.definition.codeMapping=code}else{StageMorph.prototype.codeMappings[key]=code}},this).promptCode("Code mapping",key==="evaluateCustomBlock"?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[key]||"",this.world(),pic,"Enter code that corresponds to the block's operation "+"(usually a single\nfunction invocation). Use <#n> to "+"reference actual arguments as shown.")};BlockMorph.prototype.mapHeader=function(aString,key){var sel=key||this.selector.substr(0,5)==="reify"?"reify":this.selector;if(aString){if(this.isCustomBlock){this.definition.codeHeader=aString}else{StageMorph.prototype.codeHeaders[sel]=aString}}};BlockMorph.prototype.mapCode=function(aString,key){var sel=key||this.selector.substr(0,5)==="reify"?"reify":this.selector;if(aString){if(this.isCustomBlock){this.definition.codeMapping=aString}else{StageMorph.prototype.codeMappings[sel]=aString}}};BlockMorph.prototype.mappedCode=function(definitions){var key=this.selector.substr(0,5)==="reify"?"reify":this.selector,code,codeLines,count=1,header,headers,headerLines,body,bodyLines,defKey=this.isCustomBlock?this.definition.spec:key,defs=definitions||{},parts=[];code=key==="reportGetVar"?this.blockSpec:this.isCustomBlock?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[key]||"";if(key!=="reportGetVar"&&!defs.hasOwnProperty(defKey)){defs[defKey]=null;if(this.isCustomBlock){header=this.definition.codeHeader||"";if(header.indexOf("<body")!==-1){body="";if(this.definition.body){body=this.definition.body.expression.mappedCode(defs)}bodyLines=body.split("\n");headerLines=header.split("\n");headerLines.forEach((headerLine,idx)=>{var prefix="",indent;if(headerLine.trimLeft().indexOf("<body")===0){indent=headerLine.indexOf("<body");prefix=headerLine.slice(0,indent)}headerLines[idx]=headerLine.replace(new RegExp("<body>"),bodyLines.join("\n"+prefix));headerLines[idx]=headerLines[idx].replace(new RegExp("<body>","g"),bodyLines.join("\n"))});header=headerLines.join("\n")}defs[defKey]=header}else{defs[defKey]=StageMorph.prototype.codeHeaders[defKey]}}codeLines=code.split("\n");this.inputs().forEach(input=>parts.push(input.mappedCode(defs).toString()));parts.forEach(part=>{var partLines=part.split("\n"),placeHolder="<#"+count+">",rx=new RegExp(placeHolder,"g");codeLines.forEach((codeLine,idx)=>{var prefix="",indent;if(codeLine.trimLeft().indexOf(placeHolder)===0){indent=codeLine.indexOf(placeHolder);prefix=codeLine.slice(0,indent)}codeLines[idx]=codeLine.replace(new RegExp(placeHolder),partLines.join("\n"+prefix));codeLines[idx]=codeLines[idx].replace(rx,partLines.join("\n"))});count+=1});code=codeLines.join("\n");if(this.nextBlock&&this.nextBlock()){code+="\n"+this.nextBlock().mappedCode(defs)}if(!definitions){headers=[];Object.keys(defs).forEach(each=>{if(defs[each]){headers.push(defs[each])}});if(headers.length){return headers.join("\n\n")+"\n\n"+code}}return code};BlockMorph.prototype.codeDefinitionHeader=function(){var block=this.isCustomBlock?new PrototypeHatBlockMorph(this.definition):SpriteMorph.prototype.blockForSelector(this.selector),hat=new HatBlockMorph,count=1;if(this.isCustomBlock){return block}block.inputs().forEach(input=>{var part=new TemplateSlotMorph("#"+count);block.replaceInput(input,part);count+=1});block.isPrototype=true;hat.setCategory("control");hat.setSpec("%s");hat.replaceInput(hat.inputs()[0],block);if(this.category==="control"){hat.alternateBlockColor()}return hat};BlockMorph.prototype.codeMappingHeader=function(){var block=this.isCustomBlock?this.definition.blockInstance():SpriteMorph.prototype.blockForSelector(this.selector),hat=new HatBlockMorph,count=1;block.inputs().forEach(input=>{var part=new TemplateSlotMorph("<#"+count+">");block.replaceInput(input,part);count+=1});block.isPrototype=true;hat.setCategory("control");hat.setSpec("%s");hat.replaceInput(hat.inputs()[0],block);if(this.category==="control"){hat.alternateBlockColor()}return hat};BlockMorph.prototype.refactorThisVar=function(justTheTemplate){var receiver=this.scriptTarget(),oldName=this.instantiationSpec||this.blockSpec,cpy=this.fullCopy();cpy.addShadow();new DialogBoxMorph(this,renameVarTo,this).prompt("Variable name",oldName,this.world(),cpy.doWithAlpha(1,()=>cpy.fullImage()),InputSlotMorph.prototype.getVarNamesDict.call(this));function renameVarTo(newName){var block;if(this.parent instanceof SyntaxElementMorph){if(this.parent instanceof BlockInputFragmentMorph){this.doRefactorBlockParameter(oldName,newName,justTheTemplate)}else if(this.parent instanceof TemplateSlotMorph){block=this.parent.parentThatIsA(BlockMorph);if(block instanceof RingMorph){this.doRefactorRingParameter(oldName,newName,justTheTemplate)}else if(block.selector==="doDeclareVariables"){this.doRefactorScriptVar(oldName,newName,justTheTemplate)}else{}}}else if(receiver.hasSpriteVariable(oldName)){this.doRefactorSpriteVar(oldName,newName,justTheTemplate)}else{this.doRefactorGlobalVar(oldName,newName,justTheTemplate)}}};BlockMorph.prototype.varExistsError=function(ide,where){ide.inform("Variable exists","A variable with this name already exists "+(where||"in this context")+".")};BlockMorph.prototype.doRefactorBlockParameter=function(oldName,newName,justTheTemplate){var fragMorph=this.parentThatIsA(BlockInputFragmentMorph),fragment=fragMorph.fragment.copy(),definer=fragMorph.parent,editor=this.parentThatIsA(BlockEditorMorph),scripts=editor.body.contents;if(definer.anyChild(any=>any.blockSpec===newName)){this.varExistsError(editor.target.parentThatIsA(IDE_Morph));return}fragment.labelString=newName;fragMorph.updateBlockLabel(fragment);if(justTheTemplate){return}scripts.children.forEach(script=>script.refactorVarInStack(oldName,newName))};BlockMorph.prototype.doRefactorRingParameter=function(oldName,newName,justTheTemplate){var ring=this.parentThatIsA(RingMorph),script=ring.contents(),tb=this.topBlock();if(contains(ring.inputNames(),newName)){this.varExistsError(this.parentThatIsA(IDE_Morph));return}tb.fullChanged();this.setSpec(newName);if(justTheTemplate){tb.fullChanged();return}if(script){script.refactorVarInStack(oldName,newName)}tb.fullChanged()};BlockMorph.prototype.doRefactorScriptVar=function(oldName,newName,justTheTemplate){var definer=this.parentThatIsA(CommandBlockMorph),receiver,ide;if(definer.definesScriptVariable(newName)){receiver=this.scriptTarget();ide=receiver.parentThatIsA(IDE_Morph);this.varExistsError(ide);return}this.userSetSpec(newName);if(justTheTemplate){return}definer.refactorVarInStack(oldName,newName,true)};BlockMorph.prototype.doRefactorSpriteVar=function(oldName,newName,justTheTemplate){var receiver=this.scriptTarget(),ide=receiver.parentThatIsA(IDE_Morph),oldWatcher=receiver.findVariableWatcher(oldName),oldValue,newWatcher;if(receiver.hasSpriteVariable(newName)){this.varExistsError(ide);return}else if(!isNil(ide.globalVariables.vars[newName])){this.varExistsError(ide,"as a global variable");return}else{oldValue=receiver.variables.getVar(oldName);receiver.deleteVariable(oldName);receiver.addVariable(newName,false);receiver.variables.setVar(newName,oldValue);if(oldWatcher&&oldWatcher.isVisible){newWatcher=receiver.toggleVariableWatcher(newName,false);newWatcher.setPosition(oldWatcher.position())}if(!justTheTemplate){receiver.refactorVariableInstances(oldName,newName,false);receiver.customBlocks.forEach(eachBlock=>eachBlock.body.expression.refactorVarInStack(oldName,newName))}}ide.flushBlocksCache("variables");ide.refreshPalette()};BlockMorph.prototype.doRefactorGlobalVar=function(oldName,newName,justTheTemplate){var receiver=this.scriptTarget(),ide=receiver.parentThatIsA(IDE_Morph),stage=ide?ide.stage:null,oldWatcher=receiver.findVariableWatcher(oldName),oldValue,newWatcher;if(!isNil(ide.globalVariables.vars[newName])){this.varExistsError(ide);return}else if(detect(stage.children,any=>any instanceof SpriteMorph&&any.hasSpriteVariable(newName))){this.varExistsError(ide,"as a sprite local variable");return}else{oldValue=ide.globalVariables.getVar(oldName);stage.deleteVariable(oldName);stage.addVariable(newName,true);ide.globalVariables.setVar(newName,oldValue);if(oldWatcher&&oldWatcher.isVisible){newWatcher=receiver.toggleVariableWatcher(newName,true);newWatcher.setPosition(oldWatcher.position())}if(!justTheTemplate){stage.refactorVariableInstances(oldName,newName,true);stage.globalBlocks.forEach(eachBlock=>{if(eachBlock.body){eachBlock.body.expression.refactorVarInStack(oldName,newName)}});stage.forAllChildren(child=>{if(child instanceof SpriteMorph){child.refactorVariableInstances(oldName,newName,true);child.customBlocks.forEach(eachBlock=>eachBlock.body.expression.refactorVarInStack(oldName,newName))}})}}ide.flushBlocksCache("variables");ide.refreshPalette()};BlockMorph.prototype.thumbnail=function(scale,clipWidth){var nb=this.nextBlock(),fadeout=12,ext,trgt,ctx,gradient;if(nb){nb.isVisible=false}ext=this.fullBounds().extent();trgt=newCanvas(new Point(clipWidth?Math.min(ext.x*scale,clipWidth):ext.x*scale,ext.y*scale));ctx=trgt.getContext("2d");ctx.scale(scale,scale);ctx.drawImage(this.fullImage(),0,0);if(clipWidth&&ext.x*scale>clipWidth){gradient=ctx.createLinearGradient(trgt.width/scale-fadeout,0,trgt.width/scale,0);gradient.addColorStop(0,"transparent");gradient.addColorStop(1,"black");ctx.globalCompositeOperation="destination-out";ctx.fillStyle=gradient;ctx.fillRect(trgt.width/scale-fadeout,0,trgt.width/scale,trgt.height/scale)}if(nb){nb.isVisible=true}return trgt};BlockMorph.prototype.scriptPic=function(){var scr=this.fullImage(),fb=this.stackFullBounds(),pic=newCanvas(fb.extent()),ctx=pic.getContext("2d");this.allComments().forEach(comment=>ctx.drawImage(comment.fullImage(),comment.fullBounds().left()-fb.left(),comment.top()-fb.top()));ctx.drawImage(scr,0,0);return pic};BlockMorph.prototype.fullImage=function(){var src,solid,pic,ctx;if(this.alpha===1){return BlockMorph.uber.fullImage.call(this)}this.forAllChildren(m=>{if(m instanceof BlockMorph){m.mouseLeaveBounds()}});src=BlockMorph.uber.fullImage.call(this);solid=this.doWithAlpha(1,()=>BlockMorph.uber.fullImage.call(this));pic=newCanvas(this.fullBounds().extent());ctx=pic.getContext("2d");ctx.fillStyle=ScriptsMorph.prototype.getRenderColor().toString();ctx.fillRect(0,0,pic.width,pic.height);ctx.globalCompositeOperation="destination-in";ctx.drawImage(solid,0,0);ctx.globalCompositeOperation="source-over";ctx.drawImage(src,0,0);return pic};BlockMorph.prototype.clearAlpha=function(){this.forAllChildren(m=>{if(m instanceof BlockMorph){delete m.alpha}})};BlockMorph.prototype.render=function(ctx){this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();if(MorphicPreferences.isFlat){ctx.fillStyle=this.cachedClrDark;ctx.beginPath();this.outlinePath(ctx,0);ctx.closePath();ctx.fill();ctx.fillStyle=this.cachedClr;ctx.beginPath();this.outlinePath(ctx,this.flatEdge);ctx.closePath();ctx.fill()}else{ctx.fillStyle=this.cachedClr;ctx.beginPath();this.outlinePath(ctx,0);ctx.closePath();ctx.fill();this.drawEdges(ctx)}if(this.hasLocationPin()){this.drawMethodIcon(ctx)}};BlockMorph.prototype.drawMethodIcon=function(ctx){var ext=this.methodIconExtent(),w=ext.x,h=ext.y,r=w/2,x=this.edge+this.labelPadding,y=this.edge,isNormal=this.color===SpriteMorph.prototype.blockColorFor(this.category);if(this.isPredicate){x=this.rounding}if(this instanceof CommandBlockMorph){y+=this.corner}ctx.fillStyle=isNormal?this.cachedClrBright:this.cachedClrDark;ctx.beginPath();ctx.arc(x+r,y+r,r,radians(-210),radians(30),false);ctx.lineTo(x+r,y+h);ctx.closePath();ctx.fill();ctx.fillStyle=this.cachedClr;ctx.beginPath();ctx.arc(x+r,y+r,r*.4,radians(0),radians(360),false);ctx.closePath();ctx.fill()};BlockMorph.prototype.cSlots=function(){var result=[];this.parts().forEach(part=>{if(part instanceof CSlotMorph){result.push(part)}else if(part instanceof MultiArgMorph){part.parts().forEach(slot=>{if(slot instanceof CSlotMorph){result.push(slot)}})}});return result};BlockMorph.prototype.hasLocationPin=function(){return this.isCustomBlock&&!this.isGlobal||this.isLocalVarTemplate};BlockMorph.prototype.addHighlight=function(oldHighlight){var isHidden=!this.isVisible,highlight;if(isHidden){this.show()}if(SyntaxElementMorph.prototype.alpha<1){this.clearAlpha()}highlight=this.highlight(oldHighlight?oldHighlight.color:this.activeHighlight,this.activeBlur,this.activeBorder);this.addBack(highlight);this.fullChanged();if(isHidden){this.hide()}return highlight};BlockMorph.prototype.addErrorHighlight=function(){var isHidden=!this.isVisible,highlight;if(isHidden){this.show()}this.removeHighlight();highlight=this.highlight(this.errorHighlight,this.activeBlur,this.activeBorder);this.addBack(highlight);this.fullChanged();if(isHidden){this.hide()}return highlight};BlockMorph.prototype.removeHighlight=function(){var highlight=this.getHighlight();if(highlight!==null){this.fullChanged();this.removeChild(highlight)}return highlight};BlockMorph.prototype.toggleHighlight=function(){if(this.getHighlight()){this.removeHighlight()}else{this.addHighlight()}};BlockMorph.prototype.highlight=function(color,blur,border){var highlight=new BlockHighlightMorph,fb=this.fullBounds(),edge=useBlurredShadows&&!MorphicPreferences.isFlat?blur:border;highlight.bounds.setExtent(fb.extent().add(edge*2));highlight.holes=[highlight.bounds];highlight.color=color;highlight.cachedImage=useBlurredShadows&&!MorphicPreferences.isFlat?this.highlightImageBlurred(color,blur):this.highlightImage(color,border);highlight.setPosition(fb.origin.subtract(new Point(edge,edge)));return highlight};BlockMorph.prototype.highlightImage=function(color,border){var fb,img,hi,ctx,out;fb=this.fullBounds().extent();this.doWithAlpha(1,()=>img=this.fullImage());hi=newCanvas(fb.add(border*2));ctx=hi.getContext("2d");ctx.drawImage(img,0,0);ctx.drawImage(img,border,0);ctx.drawImage(img,border*2,0);ctx.drawImage(img,border*2,border);ctx.drawImage(img,border*2,border*2);ctx.drawImage(img,border,border*2);ctx.drawImage(img,0,border*2);ctx.drawImage(img,0,border);ctx.globalCompositeOperation="destination-out";ctx.drawImage(img,border,border);out=newCanvas(fb.add(border*2));ctx=out.getContext("2d");ctx.drawImage(hi,0,0);ctx.globalCompositeOperation="source-atop";ctx.fillStyle=color.toString();ctx.fillRect(0,0,out.width,out.height);return out};BlockMorph.prototype.highlightImageBlurred=function(color,blur){var fb,img,hi,ctx;fb=this.fullBounds().extent();this.doWithAlpha(1,()=>img=this.fullImage());hi=newCanvas(fb.add(blur*2));ctx=hi.getContext("2d");ctx.shadowBlur=blur;ctx.shadowColor=color.toString();ctx.drawImage(img,blur,blur);ctx.shadowBlur=0;ctx.globalCompositeOperation="destination-out";ctx.drawImage(img,blur,blur);return hi};BlockMorph.prototype.getHighlight=function(){var highlights;highlights=this.children.slice(0).reverse().filter(child=>child instanceof BlockHighlightMorph);if(highlights.length!==0){return highlights[0]}return null};BlockMorph.prototype.outline=function(color,border){var highlight=new BlockHighlightMorph,fb=this.fullBounds(),edge=border;highlight.bounds.setExtent(fb.extent().add(edge*2));highlight.color=color;highlight.cachedImage=this.highlightImage(color,border);highlight.setPosition(fb.origin.subtract(new Point(edge,edge)));return highlight};BlockMorph.prototype.fixBlockColor=function(nearestBlock,isForced){var nearest=nearestBlock,clr,cslot;if(!this.zebraContrast&&!isForced){return}if(!this.zebraContrast&&isForced){return this.forceNormalColoring(true)}if(!nearest){if(this.parent){if(this.isPrototype){nearest=null}else if(this instanceof ReporterBlockMorph){nearest=this.parent.parentThatIsA(BlockMorph)}else{cslot=this.parentThatIsA(CommandSlotMorph,ReporterSlotMorph);if(cslot){nearest=cslot.parentThatIsA(BlockMorph)}}}}if(!nearest){clr=SpriteMorph.prototype.blockColorFor(this.category);if(!this.color.eq(clr)){this.alternateBlockColor()}}else if(nearest.category===this.category){if(nearest.color.eq(this.color)){this.alternateBlockColor()}}else if(this.category&&!this.color.eq(SpriteMorph.prototype.blockColorFor(this.category))){this.alternateBlockColor()}if(isForced){this.fixChildrensBlockColor(true)}};BlockMorph.prototype.forceNormalColoring=function(){var clr=SpriteMorph.prototype.blockColorFor(this.category);this.setColor(clr);this.setLabelColor(WHITE,clr.darker(this.labelContrast),MorphicPreferences.isFlat?ZERO:this.embossing);this.fixChildrensBlockColor(true)};BlockMorph.prototype.alternateBlockColor=function(){var clr=SpriteMorph.prototype.blockColorFor(this.category);if(this.color.eq(clr)){this.setColor(this.zebraContrast<0?clr.darker(Math.abs(this.zebraContrast)):clr.lighter(this.zebraContrast),this.hasLabels())}else{this.setColor(clr,this.hasLabels())}this.fixLabelColor();this.fixChildrensBlockColor(true)};BlockMorph.prototype.ghost=function(){this.setColor(SpriteMorph.prototype.blockColorFor(this.category).lighter(35))};BlockMorph.prototype.fixLabelColor=function(){if(this.zebraContrast>0&&this.category){var clr=SpriteMorph.prototype.blockColorFor(this.category);if(this.color.eq(clr)){this.setLabelColor(WHITE,clr.darker(this.labelContrast),MorphicPreferences.isFlat?null:this.embossing)}else{this.setLabelColor(BLACK,clr.lighter(this.zebraContrast).lighter(this.labelContrast*2),MorphicPreferences.isFlat?null:this.embossing.neg())}}};BlockMorph.prototype.fixChildrensBlockColor=function(isForced){this.children.forEach(morph=>{if(morph instanceof CommandBlockMorph){morph.fixBlockColor(null,isForced)}else if(morph instanceof SyntaxElementMorph){morph.fixBlockColor(this,isForced);if(morph instanceof BooleanSlotMorph){morph.fixLayout()}}})};BlockMorph.prototype.setCategory=function(aString){this.category=aString;this.fixBlockColor()};BlockMorph.prototype.hasLabels=function(){return this.children.some(any=>any instanceof StringMorph)};BlockMorph.prototype.fullCopy=function(){var ans=BlockMorph.uber.fullCopy.call(this);ans.removeHighlight();ans.isDraggable=true;if(this.instantiationSpec){ans.setSpec(this.instantiationSpec)}ans.allChildren().filter(block=>{if(block instanceof SyntaxElementMorph){block.cachedInputs=null;if(block.isCustomBlock){block.initializeVariables()}}return!isNil(block.comment)}).forEach(block=>{var cmnt=block.comment.fullCopy();block.comment=cmnt;cmnt.block=block});ans.cachedInputs=null;return ans};BlockMorph.prototype.reactToTemplateCopy=function(){if(this.isLocalVarTemplate){this.isLocalVarTemplate=null;this.fixLayout()}this.forceNormalColoring()};BlockMorph.prototype.hasBlockVars=function(){return this.anyChild(any=>any.isCustomBlock&&any.isGlobal&&any.definition.variableNames.length)};BlockMorph.prototype.pickUp=function(wrrld){var world=wrrld||this.world();this.setPosition(world.hand.position().subtract(this.rounding));world.hand.grab(this)};BlockMorph.prototype.mouseClickLeft=function(){var top=this.topBlock(),receiver=top.scriptTarget(),shiftClicked=this.world().currentKey===16,stage;if(shiftClicked&&!this.isTemplate){return this.selectForEdit().focus()}if(top instanceof PrototypeHatBlockMorph){return}if(receiver){stage=receiver.parentThatIsA(StageMorph);if(stage){stage.threads.toggleProcess(top,receiver)}}};BlockMorph.prototype.focus=function(){var scripts=this.parentThatIsA(ScriptsMorph),world=this.world(),focus;if(!scripts||!ScriptsMorph.prototype.enableKeyboard){return}if(scripts.focus){scripts.focus.stopEditing()}world.stopEditing();focus=new ScriptFocusMorph(scripts,this);scripts.focus=focus;focus.getFocus(world);if(this instanceof HatBlockMorph){focus.nextCommand()}};BlockMorph.prototype.activeProcess=function(){var top=this.topBlock(),receiver=top.scriptTarget(),stage;if(top instanceof PrototypeHatBlockMorph){return null}if(receiver){stage=receiver.parentThatIsA(StageMorph);if(stage){return stage.threads.findProcess(top,receiver)}}return null};BlockMorph.prototype.mouseEnterBounds=function(dragged){if(!dragged&&this.alpha<1){this.alpha=Math.min(this.alpha+.2,1);this.rerender()}};BlockMorph.prototype.mouseLeaveBounds=function(dragged){if(SyntaxElementMorph.prototype.alpha<1){delete this.alpha;this.rerender()}};BlockMorph.prototype.rootForGrab=function(){return this};BlockMorph.prototype.wantsDropOf=function(aMorph){return(aMorph instanceof ArgMorph||aMorph instanceof StringMorph||aMorph instanceof TextMorph)&&!this.isTemplate};BlockMorph.prototype.reactToDropOf=function(droppedMorph){droppedMorph.isDraggable=false;droppedMorph.fixLayout();this.fixLayout();this.buildSpec()};BlockMorph.prototype.situation=function(){if(!(this.parent instanceof TemplateSlotMorph)){var scripts=this.parentThatIsA(ScriptsMorph);if(scripts){return{origin:scripts,position:this.position().subtract(scripts.position())}}}return BlockMorph.uber.situation.call(this)};BlockMorph.prototype.prepareToBeGrabbed=function(hand){var wrld=hand?hand.world:this.world();this.allInputs().forEach(input=>delete input.bindingID);this.allComments().forEach(comment=>comment.startFollowing(this,wrld))};BlockMorph.prototype.justDropped=function(){delete this.alpha;this.allComments().forEach(comment=>comment.stopFollowing())};BlockMorph.prototype.allComments=function(){return this.allChildren().filter(block=>!isNil(block.comment)).map(block=>block.comment)};BlockMorph.prototype.destroy=function(justThis){if(justThis){if(!isNil(this.comment)){this.comment.destroy()}}else{this.allComments().forEach(comment=>comment.destroy())}BlockMorph.uber.destroy.call(this)};BlockMorph.prototype.stackHeight=function(){var fb=this.fullBounds(),commentsBottom=Math.max(this.allComments().map(comment=>comment.bottom()))||this.bottom();return Math.max(fb.bottom(),commentsBottom)-fb.top()};BlockMorph.prototype.stackFullBounds=function(){var fb=this.fullBounds();this.allComments().forEach(comment=>fb.mergeWith(comment.bounds));return fb};BlockMorph.prototype.stackWidth=function(){var fb=this.fullBounds(),commentsRight=Math.max(this.allComments().map(comment=>comment.right()))||this.right();return Math.max(fb.right(),commentsRight)-fb.left()};BlockMorph.prototype.snap=function(){var top=this.topBlock(),receiver,stage,ide;top.allComments().forEach(comment=>comment.align(top));if(this.getHighlight()&&this!==top){this.removeHighlight()}if(top.getHighlight()){top.addHighlight(top.removeHighlight())}if(this.selector==="receiveCondition"){receiver=top.scriptTarget();if(receiver){stage=receiver.parentThatIsA(StageMorph);if(stage){stage.enableCustomHatBlocks=true;stage.threads.pauseCustomHatBlocks=false;ide=stage.parentThatIsA(IDE_Morph);if(ide){ide.controlBar.stopButton.refresh()}}}}};CommandBlockMorph.prototype=new BlockMorph;CommandBlockMorph.prototype.constructor=CommandBlockMorph;CommandBlockMorph.uber=BlockMorph.prototype;function CommandBlockMorph(){this.init()}CommandBlockMorph.prototype.init=function(){CommandBlockMorph.uber.init.call(this);this.bounds.setExtent(new Point(60,24).multiplyBy(this.scale));this.fixLayout();this.rerender();this.partOfCustomCommand=false;this.exitTag=null};CommandBlockMorph.prototype.blockSequence=function(){var sequence=[this],nb=this.nextBlock();while(nb){sequence.push(nb);nb=nb.nextBlock()}return sequence};CommandBlockMorph.prototype.bottomBlock=function(){if(this.nextBlock()){return this.nextBlock().bottomBlock()}return this};CommandBlockMorph.prototype.nextBlock=function(block){if(block){var nb=this.nextBlock(),affected=this.parentThatIsA(CommandSlotMorph,ReporterSlotMorph);this.add(block);if(nb){block.bottomBlock().nextBlock(nb)}block.setPosition(new Point(this.left(),this.bottom()-this.corner));if(affected){affected.fixLayout()}}else{return detect(this.children,child=>child instanceof CommandBlockMorph&&!child.isPrototype)}};CommandBlockMorph.prototype.topAttachPoint=function(){return new Point(this.dentCenter(),this.top())};CommandBlockMorph.prototype.bottomAttachPoint=function(){return new Point(this.dentCenter(),this.bottom())};CommandBlockMorph.prototype.wrapAttachPoint=function(){var cslot=detect(this.inputs(),each=>each instanceof CSlotMorph);if(cslot&&!cslot.nestedBlock()){return new Point(cslot.left()+cslot.inset*2+cslot.corner,cslot.top()+cslot.corner*2)}return null};CommandBlockMorph.prototype.dentLeft=function(){return this.left()+this.corner+this.inset};CommandBlockMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+this.dent*.5};CommandBlockMorph.prototype.attachTargets=function(){var answer=[],tp;if(!(this instanceof HatBlockMorph)){tp=this.topAttachPoint();if(!(this.parent instanceof SyntaxElementMorph)){answer.push({point:tp,element:this,loc:"top",type:"block"})}if(ScriptsMorph.prototype.enableNestedAutoWrapping||!this.parentThatIsA(CommandSlotMorph)){answer.push({point:tp,element:this,loc:"wrap",type:"block"})}}if(!this.isStop()){answer.push({point:this.bottomAttachPoint(),element:this,loc:"bottom",type:"block"})}return answer};CommandBlockMorph.prototype.allAttachTargets=function(newParent){var target=newParent||this.parent,answer=[],topBlocks;if(this instanceof HatBlockMorph&&newParent.rejectsHats){return answer}topBlocks=target.children.filter(child=>child!==this&&child instanceof SyntaxElementMorph&&!child.isTemplate);topBlocks.forEach(block=>block.forAllChildren(child=>{if(child.attachTargets){child.attachTargets().forEach(at=>answer.push(at))}}));return answer};CommandBlockMorph.prototype.closestAttachTarget=function(newParent){var target=newParent||this.parent,bottomBlock=this.bottomBlock(),answer=null,thresh=Math.max(this.corner*2+this.dent,this.minSnapDistance),dist,ref=[],minDist=1e3,wrap;if(!(this instanceof HatBlockMorph)){ref.push({point:this.topAttachPoint(),loc:"top"});wrap=this.wrapAttachPoint();if(wrap){ref.push({point:wrap,loc:"wrap"})}}if(!bottomBlock.isStop()){ref.push({point:bottomBlock.bottomAttachPoint(),loc:"bottom"})}this.allAttachTargets(target).forEach(eachTarget=>ref.forEach(eachRef=>{if(eachRef.loc==="wrap"&&eachTarget.loc==="wrap"||eachRef.loc!==eachTarget.loc&&eachRef.loc!=="wrap"&&eachTarget.loc!=="wrap"){dist=eachRef.point.distanceTo(eachTarget.point);if(dist<thresh&&dist<minDist){minDist=dist;answer=eachTarget}}}));return answer};CommandBlockMorph.prototype.snap=function(hand){var target=this.closestAttachTarget(),scripts=this.parentThatIsA(ScriptsMorph),before,next,offsetY,cslot,affected;scripts.clearDropInfo();scripts.lastDroppedBlock=this;if(target===null){this.fixBlockColor();CommandBlockMorph.uber.snap.call(this);if(hand){scripts.recordDrop(hand.grabOrigin)}return}scripts.lastDropTarget=target;if(target.loc==="bottom"){if(target.type==="slot"){this.removeHighlight();scripts.lastNextBlock=target.element.nestedBlock();target.element.nestedBlock(this)}else{scripts.lastNextBlock=target.element.nextBlock();target.element.nextBlock(this)}if(this.isStop()){next=this.nextBlock();if(next){scripts.add(next);next.moveBy(this.extent().floorDivideBy(2));affected=this.parentThatIsA(CommandSlotMorph,ReporterSlotMorph);if(affected){affected.fixLayout()}}}}else if(target.loc==="top"){target.element.removeHighlight();offsetY=this.bottomBlock().bottom()-this.bottom();this.setBottom(target.element.top()+this.corner-offsetY);this.setLeft(target.element.left());this.bottomBlock().nextBlock(target.element)}else if(target.loc==="wrap"){cslot=detect(this.inputs(),each=>each instanceof CSlotMorph);before=target.element.parent;scripts.lastWrapParent=before;this.moveBy(target.point.subtract(cslot.slotAttachPoint()));cslot.nestedBlock(target.element);if(before instanceof CommandBlockMorph){before.nextBlock(this)}else if(before instanceof CommandSlotMorph){before.nestedBlock(this)}else if(before instanceof RingReporterSlotMorph){before.add(this);before.fixLayout()}target.element.blockSequence().forEach(cmd=>cmd.fixBlockColor())}this.fixBlockColor();CommandBlockMorph.uber.snap.call(this);if(hand){scripts.recordDrop(hand.grabOrigin)}if(this.snapSound){this.snapSound.play()}};CommandBlockMorph.prototype.prepareToBeGrabbed=function(handMorph){if(handMorph&&handMorph.world.currentKey===16&&this.nextBlock()){this.extract();handMorph.grabOrigin.action="extract";return}var oldPos=this.position();if(this.parent instanceof RingReporterSlotMorph){this.parent.revertToDefaultInput(this);this.setPosition(oldPos)}CommandBlockMorph.uber.prepareToBeGrabbed.call(this,handMorph)};CommandBlockMorph.prototype.isStop=function(){var choice;if(this.selector==="doStopThis"){choice=this.inputs()[0].evaluate();return choice instanceof Array&&choice[0].length<12}return["doForever","doReport","removeClone","doSwitchToScene"].indexOf(this.selector)>-1};CommandBlockMorph.prototype.userDestroy=function(){var target=this.selectForEdit();if(target!==this){return this.userDestroy.call(target)}if(this.nextBlock()){this.userDestroyJustThis();return}var scripts=this.parentThatIsA(ScriptsMorph),ide=this.parentThatIsA(IDE_Morph),parent=this.parentThatIsA(SyntaxElementMorph),cslot=this.parentThatIsA(CSlotMorph);if(scripts){scripts.clearDropInfo();scripts.lastDroppedBlock=this;scripts.recordDrop(this.situation());scripts.dropRecord.action="delete"}this.prepareToBeGrabbed();if(ide){ide.removeBlock(this)}else{this.destroy()}if(cslot){cslot.fixLayout()}if(parent){parent.reactToGrabOf(this)}};CommandBlockMorph.prototype.userDestroyJustThis=function(){var scripts=this.parentThatIsA(ScriptsMorph),nb=this.nextBlock();if(scripts){scripts.clearDropInfo();scripts.lastDroppedBlock=this;scripts.recordDrop(this.situation());scripts.dropRecord.lastNextBlock=nb;scripts.dropRecord.action="delete"}this.extract()};CommandBlockMorph.prototype.userExtractJustThis=function(){var situation=this.situation();situation.action="extract";this.extract();this.pickUp(situation.origin.world());this.parent.grabOrigin=situation};CommandBlockMorph.prototype.extract=function(){var scripts=this.parentThatIsA(ScriptsMorph),ide=this.parentThatIsA(IDE_Morph),cs=this.parentThatIsA(CommandSlotMorph,RingReporterSlotMorph),pb,nb=this.nextBlock(),above,parent=this.parentThatIsA(SyntaxElementMorph),cslot=this.parentThatIsA(CSlotMorph,RingReporterSlotMorph);this.topBlock().fullChanged();if(this.parent){pb=this.parent.parentThatIsA(CommandBlockMorph)}if(pb&&pb.nextBlock()===this){above=pb}else if(cs&&cs.nestedBlock()===this){above=cs;this.prepareToBeGrabbed()}if(ide){ide.removeBlock(this,true)}else{this.destroy(true)}if(nb){if(above instanceof CommandSlotMorph||above instanceof RingReporterSlotMorph){above.nestedBlock(nb)}else if(above instanceof CommandBlockMorph){above.nextBlock(nb)}else{scripts.add(nb)}}else if(cslot){cslot.fixLayout()}if(parent){parent.reactToGrabOf(this)}};CommandBlockMorph.prototype.outlinePath=function(ctx,inset){var indent=this.corner*2+this.inset,bottom=this.height()-this.corner,bottomCorner=this.height()-this.corner*2,radius=Math.max(this.corner-inset,0),pos=this.position();ctx.arc(this.corner,this.corner,radius,radians(-180),radians(-90),false);ctx.lineTo(this.corner+this.inset,inset);ctx.lineTo(indent,this.corner+inset);ctx.lineTo(indent+this.dent,this.corner+inset);ctx.lineTo(this.corner*3+this.inset+this.dent,inset);ctx.lineTo(this.width()-this.corner,inset);ctx.arc(this.width()-this.corner,this.corner,radius,radians(-90),radians(-0),false);this.cSlots().forEach(slot=>{slot.outlinePath(ctx,inset,slot.position().subtract(pos))});ctx.arc(this.width()-this.corner,bottomCorner,radius,radians(0),radians(90),false);if(!this.isStop()){ctx.lineTo(this.width()-this.corner,bottom-inset);ctx.lineTo(this.corner*3+this.inset+this.dent,bottom-inset);ctx.lineTo(indent+this.dent,bottom+this.corner-inset);ctx.lineTo(indent,bottom+this.corner-inset);ctx.lineTo(this.corner+this.inset,bottom-inset)}ctx.arc(this.corner,bottomCorner,radius,radians(90),radians(180),false)};CommandBlockMorph.prototype.drawEdges=function(ctx){this.drawTopDentEdge(ctx,0,0);this.drawBottomDentEdge(ctx,0,this.height()-this.corner);this.drawLeftEdge(ctx);this.drawRightEdge(ctx);this.drawTopLeftEdge(ctx);this.drawBottomRightEdge(ctx)};CommandBlockMorph.prototype.drawTopDentEdge=function(ctx,x,y){var shift=this.edge*.5,indent=x+this.corner*2+this.inset,upperGradient,lowerGradient,leftGradient,lgx;ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";upperGradient=ctx.createLinearGradient(0,y,0,y+this.edge);upperGradient.addColorStop(0,this.cachedClrBright);upperGradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=upperGradient;ctx.beginPath();ctx.moveTo(this.corner,y+shift);ctx.lineTo(x+this.corner+this.inset,y+shift);ctx.stroke();ctx.strokeStyle=upperGradient;ctx.beginPath();ctx.moveTo(x+this.corner*3+this.inset+this.dent+shift,y+shift);ctx.lineTo(this.width()-this.corner,y+shift);ctx.stroke();lgx=x+this.corner+this.inset;leftGradient=ctx.createLinearGradient(lgx-this.edge,y+this.edge,lgx,y);leftGradient.addColorStop(0,this.cachedClr);leftGradient.addColorStop(1,this.cachedClrBright);ctx.strokeStyle=leftGradient;ctx.beginPath();ctx.moveTo(x+this.corner+this.inset,y+shift);ctx.lineTo(indent,y+this.corner+shift);ctx.stroke();lowerGradient=ctx.createLinearGradient(0,y+this.corner,0,y+this.corner+this.edge);lowerGradient.addColorStop(0,this.cachedClrBright);lowerGradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=lowerGradient;ctx.beginPath();ctx.moveTo(indent,y+this.corner+shift);ctx.lineTo(indent+this.dent,y+this.corner+shift);ctx.stroke()};CommandBlockMorph.prototype.drawBottomDentEdge=function(ctx,x,y){var shift=this.edge*.5,indent=x+this.corner*2+this.inset,upperGradient,lowerGradient,rightGradient;ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";upperGradient=ctx.createLinearGradient(0,y-this.edge,0,y);upperGradient.addColorStop(0,this.cachedClr);upperGradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=upperGradient;ctx.beginPath();ctx.moveTo(this.corner,y-shift);if(this.isStop()){ctx.lineTo(this.width()-this.corner,y-shift)}else{ctx.lineTo(x+this.corner+this.inset-shift,y-shift)}ctx.stroke();if(this.isStop()){return null}lowerGradient=ctx.createLinearGradient(0,y+this.corner-this.edge,0,y+this.corner);lowerGradient.addColorStop(0,this.cachedClr);lowerGradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=lowerGradient;ctx.beginPath();ctx.moveTo(indent+shift,y+this.corner-shift);ctx.lineTo(indent+this.dent,y+this.corner-shift);ctx.stroke();rightGradient=ctx.createLinearGradient(x+indent+this.dent-this.edge,y+this.corner-this.edge,x+indent+this.dent,y+this.corner);rightGradient.addColorStop(0,this.cachedClr);rightGradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=rightGradient;ctx.beginPath();ctx.moveTo(x+indent+this.dent,y+this.corner-shift);ctx.lineTo(x+this.corner*3+this.inset+this.dent,y-shift);ctx.stroke();ctx.strokeStyle=upperGradient;ctx.beginPath();ctx.moveTo(x+this.corner*3+this.inset+this.dent,y-shift);ctx.lineTo(this.width()-this.corner,y-shift);ctx.stroke()};CommandBlockMorph.prototype.drawFlatBottomDentEdge=function(ctx){if(!this.isStop()){ctx.fillStyle=this.color.darker(this.contrast/2).toString();ctx.beginPath();this.drawDent(ctx,0,this.height()-this.corner);ctx.closePath();ctx.fill()}};CommandBlockMorph.prototype.drawLeftEdge=function(ctx){var shift=this.edge*.5,gradient=ctx.createLinearGradient(0,0,this.edge,0);gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,this.corner);ctx.lineTo(shift,this.height()-this.corner*2-shift);ctx.stroke()};CommandBlockMorph.prototype.drawRightEdge=function(ctx){var shift=this.edge*.5,cslots=this.cSlots(),top=this.top(),x=this.width(),y,gradient;gradient=ctx.createLinearGradient(x-this.edge,0,x,0);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=gradient;if(cslots.length){ctx.beginPath();ctx.moveTo(x-shift,this.corner+shift);cslots.forEach(slot=>{y=slot.top()-top;ctx.lineTo(x-shift,y);ctx.stroke();ctx.beginPath();ctx.moveTo(x-shift,y+slot.height())})}else{ctx.beginPath();ctx.moveTo(x-shift,this.corner+shift)}ctx.lineTo(x-shift,this.height()-this.corner*2);ctx.stroke()};CommandBlockMorph.prototype.drawTopLeftEdge=function(ctx){var shift=this.edge*.5,gradient;gradient=ctx.createRadialGradient(this.corner,this.corner,this.corner,this.corner,this.corner,this.corner-this.edge);gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(this.corner,this.corner,this.corner-shift,radians(-180),radians(-90),false);ctx.stroke()};CommandBlockMorph.prototype.drawBottomRightEdge=function(ctx){var shift=this.edge*.5,x=this.width()-this.corner,y=this.height()-this.corner*2,gradient;gradient=ctx.createRadialGradient(x,y,this.corner,x,y,this.corner-this.edge);gradient.addColorStop(0,this.cachedClrDark);gradient.addColorStop(1,this.cachedClr);ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(x,y,this.corner-shift,radians(90),radians(0),true);ctx.stroke()};HatBlockMorph.prototype=new CommandBlockMorph;HatBlockMorph.prototype.constructor=HatBlockMorph;HatBlockMorph.uber=CommandBlockMorph.prototype;function HatBlockMorph(){this.init()}HatBlockMorph.prototype.init=function(){HatBlockMorph.uber.init.call(this);this.bounds.setExtent(new Point(120,36).multiplyBy(this.scale));this.fixLayout();this.rerender()};HatBlockMorph.prototype.blockSequence=function(){var result=HatBlockMorph.uber.blockSequence.call(this);result.shift();return result};HatBlockMorph.prototype.reify=function(){var nb=this.nextBlock();if(!nb){return new Context}return nb.reify()};HatBlockMorph.prototype.outlinePath=function(ctx,inset){var indent=this.corner*2+this.inset,bottom=this.height()-this.corner,bottomCorner=this.height()-this.corner*2,radius=Math.max(this.corner-inset,0),s=this.hatWidth,h=this.hatHeight,r=(4*h*h+s*s)/(8*h),a=degrees(4*Math.atan(2*h/s)),sa=a/2,sp=Math.min(s*1.7,this.width()-this.corner);ctx.moveTo(inset,h+this.corner);ctx.arc(s/2,r,r,radians(-sa-90),radians(-90),false);ctx.bezierCurveTo(s,0,s,h,sp,h);ctx.arc(this.width()-this.corner,h+this.corner,radius,radians(-90),radians(-0),false);ctx.arc(this.width()-this.corner,bottomCorner,radius,radians(0),radians(90),false);if(!this.isStop()){ctx.lineTo(this.width()-this.corner,bottom-inset);ctx.lineTo(this.corner*3+this.inset+this.dent,bottom-inset);ctx.lineTo(indent+this.dent,bottom+this.corner-inset);ctx.lineTo(indent,bottom+this.corner-inset);ctx.lineTo(this.corner+this.inset,bottom-inset)}ctx.arc(this.corner,bottomCorner,radius,radians(90),radians(180),false)};HatBlockMorph.prototype.drawLeftEdge=function(ctx){var shift=this.edge*.5,gradient=ctx.createLinearGradient(0,0,this.edge,0);gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,this.hatHeight+shift);ctx.lineTo(shift,this.height()-this.corner*2-shift);ctx.stroke()};HatBlockMorph.prototype.drawRightEdge=function(ctx){var shift=this.edge*.5,x=this.width(),gradient;gradient=ctx.createLinearGradient(x-this.edge,0,x,0);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(x-shift,this.corner+this.hatHeight+shift);ctx.lineTo(x-shift,this.height()-this.corner*2);ctx.stroke()};HatBlockMorph.prototype.drawTopDentEdge=nop;HatBlockMorph.prototype.drawTopLeftEdge=function(ctx){var shift=this.edge*.5,s=this.hatWidth,h=this.hatHeight,r=(4*h*h+s*s)/(8*h),a=degrees(4*Math.atan(2*h/s)),sa=a/2,sp=Math.min(s*1.7,this.width()-this.corner),gradient;gradient=ctx.createRadialGradient(s/2,r,r-this.edge,s/2,r,r);gradient.addColorStop(1,this.cachedClrBright);gradient.addColorStop(0,this.cachedClr);ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(Math.round(s/2),r,r-shift,radians(-sa-90),radians(-90),false);ctx.moveTo(s/2,shift);ctx.bezierCurveTo(s,shift,s,h+shift,sp,h+shift);ctx.lineTo(this.width()-this.corner,h+shift);ctx.stroke()};ReporterBlockMorph.prototype=new BlockMorph;ReporterBlockMorph.prototype.constructor=ReporterBlockMorph;ReporterBlockMorph.uber=BlockMorph.prototype;function ReporterBlockMorph(isPredicate){this.init(isPredicate)}ReporterBlockMorph.prototype.init=function(isPredicate){ReporterBlockMorph.uber.init.call(this);this.isPredicate=isPredicate||false;this.bounds.setExtent(new Point(50,22).multiplyBy(this.scale));this.fixLayout();this.rerender();this.cachedSlotSpec=null;this.isLocalVarTemplate=null};ReporterBlockMorph.prototype.snap=function(hand){var scripts=this.parent,nb,target;this.cachedSlotSpec=null;if(!(scripts instanceof ScriptsMorph)){return null}scripts.clearDropInfo();scripts.lastDroppedBlock=this;target=scripts.closestInput(this,hand);if(target!==null){scripts.lastReplacedInput=target;scripts.lastDropTarget=target.parent;if(target instanceof MultiArgMorph){scripts.lastPreservedBlocks=target.inputs();scripts.lastReplacedInput=target.fullCopy()}else if(target instanceof CommandSlotMorph){scripts.lastReplacedInput=target;nb=target.nestedBlock();if(nb){nb=nb.fullCopy();scripts.add(nb);nb.moveBy(nb.extent());nb.fixBlockColor();scripts.lastPreservedBlocks=[nb]}}target.parent.replaceInput(target,this);if(this.snapSound){this.snapSound.play()}}this.fixBlockColor();ReporterBlockMorph.uber.snap.call(this);if(hand){scripts.recordDrop(hand.grabOrigin)}};ReporterBlockMorph.prototype.prepareToBeGrabbed=function(handMorph){var oldPos=this.position();if(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph){this.parent.revertToDefaultInput(this);this.setPosition(oldPos)}ReporterBlockMorph.uber.prepareToBeGrabbed.call(this,handMorph);handMorph.alpha=this.alpha<1?1:.85;this.cachedSlotSpec=null};ReporterBlockMorph.prototype.blockSequence=function(){return this};ReporterBlockMorph.prototype.isUnevaluated=function(){var spec=this.getSlotSpec();return spec==="%anyUE"||spec==="%boolUE"||spec==="%f"};ReporterBlockMorph.prototype.isLocked=function(){return this.isStatic||this.getSlotSpec()==="%t"};ReporterBlockMorph.prototype.getSlotSpec=function(){if(!this.cachedSlotSpec){this.cachedSlotSpec=this.determineSlotSpec()}return this.cachedSlotSpec};ReporterBlockMorph.prototype.determineSlotSpec=function(){var parts,idx;if(this.parent instanceof BlockMorph){parts=this.parent.parts().filter(part=>!(part instanceof BlockHighlightMorph));idx=parts.indexOf(this);if(idx!==-1){if(this.parent.blockSpec){return this.parseSpec(this.parent.blockSpec)[idx]}}}if(this.parent instanceof MultiArgMorph){return this.parent.slotSpec}if(this.parent instanceof TemplateSlotMorph){return this.parent.getSpec()}return""};ReporterBlockMorph.prototype.mouseClickLeft=function(pos){var label;if(this.parent instanceof BlockInputFragmentMorph){return this.parent.mouseClickLeft()}if(this.parent instanceof TemplateSlotMorph){if(this.parent.parent&&this.parent.parent.parent&&this.parent.parent.parent instanceof RingMorph){label="Input name"}else if(this.parent.parent.elementSpec==="%blockVars"){label="Block variable name"}else{label="Script variable name"}new DialogBoxMorph(this,this.userSetSpec,this).prompt(label,this.blockSpec,this.world())}else{ReporterBlockMorph.uber.mouseClickLeft.call(this,pos)}};ReporterBlockMorph.prototype.userDestroy=function(){var target=this.selectForEdit();if(target!==this){return this.userDestroy.call(target)}var scripts=this.parentThatIsA(ScriptsMorph);if(scripts){scripts.clearDropInfo();scripts.lastDroppedBlock=this;scripts.recordDrop(this.situation());scripts.dropRecord.action="delete"}this.topBlock().fullChanged();this.prepareToBeGrabbed(this.world().hand);this.destroy()};ReporterBlockMorph.prototype.outlinePath=function(ctx,inset){if(this.isPredicate){this.outlinePathDiamond(ctx,inset)}else{this.outlinePathOval(ctx,inset)}};ReporterBlockMorph.prototype.outlinePathOval=function(ctx,inset){var h=this.height(),r=Math.min(this.rounding,h/2),radius=Math.max(r-inset,0),w=this.width(),pos=this.position();ctx.arc(r,r,radius,radians(-180),radians(-90),false);ctx.arc(w-r,r,radius,radians(-90),radians(-0),false);this.cSlots().forEach(slot=>{slot.outlinePath(ctx,inset,slot.position().subtract(pos))});ctx.arc(w-r,h-r,radius,radians(0),radians(90),false);ctx.arc(r,h-r,radius,radians(90),radians(180),false);ctx.lineTo(r-radius,r)};ReporterBlockMorph.prototype.outlinePathDiamond=function(ctx,inset){var w=this.width(),h=this.height(),h2=Math.floor(h/2),r=this.rounding,right=w-r,pos=this.position(),cslots=this.cSlots();ctx.moveTo(inset,h2);ctx.lineTo(r,inset);ctx.lineTo(right-inset,inset);if(cslots.length){this.cSlots().forEach(slot=>{slot.outlinePath(ctx,inset,slot.position().subtract(pos))})}else{ctx.lineTo(w-inset,h2)}ctx.lineTo(right-inset,h-inset);ctx.lineTo(r,h-inset)};ReporterBlockMorph.prototype.drawEdges=function(ctx){if(this.isPredicate){this.drawEdgesDiamond(ctx)}else{this.drawEdgesOval(ctx)}};ReporterBlockMorph.prototype.drawEdgesOval=function(ctx){var h=this.height(),r=Math.max(Math.min(this.rounding,h/2),this.edge),w=this.width(),shift=this.edge/2,y,top=this.top(),cslots=this.cSlots(),gradient;ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";gradient=ctx.createRadialGradient(r,h-r,r-this.edge,r,h-r,r+this.edge);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(r,h-r,r-shift,radians(90),radians(180),false);ctx.stroke();gradient=ctx.createRadialGradient(w-r,r,r-this.edge,w-r,r,r+this.edge);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(w-r,r,r-shift,radians(-90),radians(0),false);ctx.stroke();gradient=ctx.createLinearGradient(0,0,0,this.edge);gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r-shift,shift);ctx.lineTo(w-r+shift,shift);ctx.stroke();gradient=ctx.createRadialGradient(r,r,r-this.edge,r,r,r);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(r,r,r-shift,radians(180),radians(270),false);ctx.stroke();gradient=ctx.createRadialGradient(w-r,h-r,r-this.edge,w-r,h-r,r);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(w-r,h-r,r-shift,radians(0),radians(90),false);ctx.stroke();gradient=ctx.createLinearGradient(0,h-this.edge,0,h);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r-shift,h-shift);ctx.lineTo(w-r+shift,h-shift);ctx.stroke();gradient=ctx.createLinearGradient(0,0,this.edge,0);gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,r);ctx.lineTo(shift,h-r);ctx.stroke();gradient=ctx.createLinearGradient(w-this.edge,0,w,0);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;if(cslots.length){ctx.beginPath();ctx.moveTo(w-shift,r+shift);cslots.forEach(slot=>{y=slot.top()-top;ctx.lineTo(w-shift,y);ctx.stroke();ctx.beginPath();ctx.moveTo(w-shift,y+slot.height())})}else{ctx.beginPath();ctx.moveTo(w-shift,r+shift)}ctx.lineTo(w-shift,h-r);ctx.stroke()};ReporterBlockMorph.prototype.drawEdgesDiamond=function(ctx){var w=this.width(),h=this.height(),h2=Math.floor(h/2),r=this.rounding,shift=this.edge/2,cslots=this.cSlots(),top=this.top(),y,gradient;ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";gradient=ctx.createLinearGradient(-r,0,r,0);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,h2);ctx.lineTo(r,h-shift);ctx.closePath();ctx.stroke();gradient=ctx.createLinearGradient(0,0,r,0);gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,h2);ctx.lineTo(r,shift);ctx.closePath();ctx.stroke();gradient=ctx.createLinearGradient(0,0,0,this.edge);gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r,shift);if(cslots.length){ctx.lineTo(w-r-shift,shift);ctx.closePath();ctx.stroke();gradient=ctx.createLinearGradient(w-r-this.edge,0,w-r,0);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(w-r-shift,this.edge+shift);cslots.forEach(slot=>{y=slot.top()-top;ctx.lineTo(w-r-shift,y);ctx.stroke();ctx.beginPath();ctx.moveTo(w-r-shift,y+slot.height())});ctx.lineTo(w-r-shift,h-shift);ctx.stroke()}else{ctx.lineTo(w-r,shift);ctx.closePath();ctx.stroke();gradient=ctx.createLinearGradient(w-r,0,w+r,0);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(w-shift,h2);ctx.lineTo(w-r,shift);ctx.closePath();ctx.stroke();gradient=ctx.createLinearGradient(w-r,0,w,0);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(w-r,h-shift);ctx.lineTo(w-shift,h2);ctx.closePath();ctx.stroke()}gradient=ctx.createLinearGradient(0,h-this.edge,0,h);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r+shift,h-shift);ctx.lineTo(w-r-shift,h-shift);ctx.closePath();ctx.stroke()};RingMorph.prototype=new ReporterBlockMorph;RingMorph.prototype.constructor=RingMorph;RingMorph.uber=ReporterBlockMorph.prototype;RingMorph.prototype.isCachingInputs=false;function RingMorph(){this.init()}RingMorph.prototype.init=function(){RingMorph.uber.init.call(this);this.category="other";this.contrast=RingMorph.prototype.contrast;this.setExtent(new Point(200,80))};RingMorph.prototype.render=function(ctx){var slot=this.inputs()[0],pos=this.position();this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();if(MorphicPreferences.isFlat){ctx.fillStyle=this.cachedClrDark;ctx.beginPath();this.outlinePath(ctx,0);slot.outlinePath(ctx,slot.position().subtract(pos));ctx.clip("evenodd");ctx.fillRect(0,0,this.width(),this.height());ctx.fillStyle=this.cachedClr;ctx.beginPath();this.outlinePath(ctx,this.flatEdge);slot.outlinePath(ctx,slot.position().subtract(pos));ctx.clip("evenodd");ctx.fillRect(0,0,this.width(),this.height())}else{ctx.fillStyle=this.cachedClr;ctx.beginPath();this.outlinePath(ctx,0);slot.outlinePath(ctx,slot.position().subtract(pos));ctx.clip("evenodd");ctx.fillRect(0,0,this.width(),this.height());this.drawEdges(ctx)}};RingMorph.prototype.rootForGrab=function(){if(this.isDraggable){return this}return BlockMorph.uber.rootForGrab.call(this)};RingMorph.prototype.embed=function(aBlock,inputNames,noVanish){var slot;this.color=SpriteMorph.prototype.blockColor.other;this.isDraggable=true;if(aBlock instanceof CommandBlockMorph){this.isStatic=false;this.setSpec("%rc %ringparms");this.selector="reifyScript";slot=this.parts()[0];slot.nestedBlock(aBlock)}else if(aBlock.isPredicate){this.isStatic=true;this.setSpec("%rp %ringparms");this.selector="reifyPredicate";slot=this.parts()[0];slot.replaceInput(slot.contents(),aBlock)}else if(aBlock instanceof BooleanSlotMorph){this.isStatic=false;this.setSpec("%rp %ringparms");this.selector="reifyPredicate";slot=this.parts()[0];slot.replaceInput(slot.contents(),aBlock)}else{this.isStatic=false;this.setSpec("%rr %ringparms");this.selector="reifyReporter";slot=this.parts()[0];slot.replaceInput(slot.contents(),aBlock,noVanish)}slot=this.parts()[1];if(inputNames){inputNames.forEach(name=>slot.addInput(name))}this.fixBlockColor(null,true)};RingMorph.prototype.vanishForSimilar=function(){var slot=this.parts()[0],block=slot.nestedBlock();if(!block){return null}if(!(this.parent instanceof SyntaxElementMorph)){return null}if(this.parent instanceof RingReporterSlotMorph||this.parent instanceof RingCommandSlotMorph){return null}if(block.selector==="reportGetVar"&&!contains(this.inputNames(),block.blockSpec)||block.selector==="reportJSFunction"||block.selector==="reportAttributeOf"||block.selector==="reportCompiled"||block.selector==="reportThisContext"||block instanceof RingMorph){this.parent.replaceInput(this,block)}};RingMorph.prototype.contents=function(){return this.parts()[0].nestedBlock()};RingMorph.prototype.inputNames=function(){return this.parts()[1].evaluate()};RingMorph.prototype.dataType=function(){switch(this.selector){case"reifyScript":return"command";case"reifyPredicate":return"predicate";default:return"reporter"}};RingMorph.prototype.isEmptySlot=function(){return this.contents()===null&&this.getSlotSpec().indexOf("Ring")>0};RingMorph.prototype.fixBlockColor=function(nearest,isForced){var slot=this.parts()[0];RingMorph.uber.fixBlockColor.call(this,nearest,isForced);slot.fixLayout()};RingMorph.prototype.userMenu=function(){var menu=new MenuMorph(this);if(this.parent instanceof MultiArgMorph&&this.parentThatIsA(ScriptsMorph)){if(!this.parent.maxInputs||this.parent.inputs().length<this.parent.maxInputs){menu.addItem("insert a slot",()=>this.parent.insertNewInputBefore(this))}if(this.isEmptySlot()&&this.parent.inputs().length>this.parent.minInputs){menu.addItem("delete slot",()=>this.parent.deleteSlot(this))}return menu}return RingMorph.uber.userMenu.call(this)};ScriptsMorph.prototype=new FrameMorph;ScriptsMorph.prototype.constructor=ScriptsMorph;ScriptsMorph.uber=FrameMorph.prototype;ScriptsMorph.prototype.cleanUpMargin=20;ScriptsMorph.prototype.cleanUpSpacing=15;ScriptsMorph.prototype.isPreferringEmptySlots=true;ScriptsMorph.prototype.enableKeyboard=true;ScriptsMorph.prototype.enableNestedAutoWrapping=true;ScriptsMorph.prototype.feedbackColor=WHITE;function ScriptsMorph(){this.init()}ScriptsMorph.prototype.init=function(){this.feedbackMorph=new BoxMorph;this.rejectsHats=false;this.lastDroppedBlock=null;this.lastReplacedInput=null;this.lastDropTarget=null;this.lastPreservedBlocks=null;this.lastNextBlock=null;this.lastWrapParent=null;this.focus=null;ScriptsMorph.uber.init.call(this);this.setColor(new Color(70,70,70));this.isAnimating=false;this.dropRecord=null;this.recordDrop()};ScriptsMorph.prototype.fullCopy=function(){var cpy=new ScriptsMorph,pos=this.position(),child;if(this.focus){this.focus.stopEditing()}this.children.forEach(morph=>{if(!morph.block){child=morph.fullCopy();cpy.add(child);child.setPosition(morph.position().subtract(pos));if(child instanceof BlockMorph){child.allComments().forEach(comment=>comment.align(child))}}});cpy.adjustBounds();return cpy};ScriptsMorph.prototype.render=function(aContext){aContext.fillStyle=this.getRenderColor().toString();aContext.fillRect(0,0,this.width(),this.height());if(this.cachedTexture){this.renderCachedTexture(aContext)}else if(this.texture){this.renderTexture(this.texture,aContext)}};ScriptsMorph.prototype.getRenderColor=function(){if(MorphicPreferences.isFlat||SyntaxElementMorph.prototype.alpha>.85){return this.color}return this.color.mixed(Math.max(SyntaxElementMorph.prototype.alpha-.15,0),SpriteMorph.prototype.paletteColor)};ScriptsMorph.prototype.renderCachedTexture=function(ctx){if(SyntaxElementMorph.prototype.alpha>.8){ScriptsMorph.uber.renderCachedTexture.call(this,ctx)}};ScriptsMorph.prototype.step=function(){var world=this.world(),hand=world.hand,block;if(this.feedbackMorph.parent){this.feedbackMorph.destroy();this.feedbackMorph.parent=null}if(this.focus&&(!world.keyboardFocus||world.keyboardFocus instanceof StageMorph)){this.focus.getFocus(world)}if(hand.children.length===0){return null}if(!this.bounds.containsPoint(hand.bounds.origin)){return null}block=hand.children[0];if(!(block instanceof BlockMorph)&&!(block instanceof CommentMorph)){return null}if(!contains(hand.morphAtPointer().allParents(),this)){return null}if(block instanceof CommentMorph){this.showCommentDropFeedback(block,hand)}else if(block instanceof ReporterBlockMorph){this.showReporterDropFeedback(block,hand)}else{this.showCommandDropFeedback(block)}};ScriptsMorph.prototype.showReporterDropFeedback=function(block,hand){var target=this.closestInput(block,hand);if(target===null){return null}this.feedbackMorph.bounds=target.fullBounds().expandBy(Math.max(block.edge*2,block.reporterDropFeedbackPadding));this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding;this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3);this.add(this.feedbackMorph);if(target instanceof MultiArgMorph){this.feedbackMorph.color=SpriteMorph.prototype.blockColor.lists.copy();this.feedbackMorph.borderColor=SpriteMorph.prototype.blockColor.lists}else{this.feedbackMorph.color=this.feedbackColor.copy();this.feedbackMorph.borderColor=this.feedbackColor}this.feedbackMorph.color.a=.5;this.feedbackMorph.rerender()};ScriptsMorph.prototype.showCommandDropFeedback=function(block){var y,target;target=block.closestAttachTarget(this);if(!target){return null}if(target.loc==="wrap"){this.showCSlotWrapFeedback(block,target.element);return}this.add(this.feedbackMorph);this.feedbackMorph.border=0;this.feedbackMorph.edge=0;this.feedbackMorph.alpha=1;this.feedbackMorph.bounds.setWidth(target.element.width());this.feedbackMorph.bounds.setHeight(Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight));this.feedbackMorph.color=this.feedbackColor;y=target.point.y;if(target.loc==="bottom"){if(target.type==="block"){if(target.element.nextBlock()){y-=SyntaxElementMorph.prototype.corner}}else if(target.type==="slot"){if(target.element.nestedBlock()){y-=SyntaxElementMorph.prototype.corner}}}this.feedbackMorph.setPosition(new Point(target.element.left(),y))};ScriptsMorph.prototype.showCommentDropFeedback=function(comment,hand){var target=this.closestBlock(comment,hand);if(!target){return null}this.feedbackMorph.bounds=target.bounds.expandBy(Math.max(BlockMorph.prototype.edge*2,BlockMorph.prototype.reporterDropFeedbackPadding));this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding;this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3);this.add(this.feedbackMorph);this.feedbackMorph.color=comment.color.copy();this.feedbackMorph.color.a=.25;this.feedbackMorph.borderColor=comment.titleBar.color;this.feedbackMorph.rerender()};ScriptsMorph.prototype.showCSlotWrapFeedback=function(srcBlock,trgBlock){var clr;this.feedbackMorph.bounds=trgBlock.fullBounds().expandBy(BlockMorph.prototype.corner);this.feedbackMorph.edge=SyntaxElementMorph.prototype.corner;this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3);this.add(this.feedbackMorph);clr=srcBlock.color.lighter(40);this.feedbackMorph.color=clr.copy();this.feedbackMorph.color.a=.1;this.feedbackMorph.borderColor=clr;this.feedbackMorph.rerender()};ScriptsMorph.prototype.closestInput=function(reporter,hand){var fb=reporter.fullBoundsNoShadow(),stacks=this.children.filter(child=>child instanceof BlockMorph&&child.fullBounds().intersects(fb)),blackList=reporter.allInputs(),handPos,target,all;all=[];stacks.forEach(stack=>all=all.concat(stack.allInputs()));if(all.length===0){return null}function touchingVariadicArrowsIfAny(inp,point){if(inp instanceof MultiArgMorph){if(point){return inp.arrows().bounds.containsPoint(point)}return inp.arrows().bounds.intersects(fb)}return true}if(this.isPreferringEmptySlots){if(hand){handPos=hand.position();target=detect(all,input=>(input instanceof InputSlotMorph||input instanceof ArgMorph&&!(input instanceof CommandSlotMorph)&&!(input instanceof MultiArgMorph)||input instanceof RingMorph&&!input.contents()||input.isEmptySlot())&&!input.isLocked()&&input.bounds.containsPoint(handPos)&&!contains(blackList,input));if(target){return target}}target=detect(all,input=>(input instanceof InputSlotMorph||input instanceof ArgMorph||input instanceof RingMorph&&!input.contents()||input.isEmptySlot())&&!input.isLocked()&&input.bounds.intersects(fb)&&!contains(blackList,input)&&touchingVariadicArrowsIfAny(input,handPos));if(target){return target}}if(hand){handPos=hand.position();target=detect(all,input=>input!==reporter&&!input.isLocked()&&input.bounds.containsPoint(handPos)&&!(input.parent instanceof PrototypeHatBlockMorph)&&!contains(blackList,input)&&touchingVariadicArrowsIfAny(input,handPos));if(target){return target}}return detect(all,input=>input!==reporter&&!input.isLocked()&&input.fullBounds().intersects(fb)&&!(input.parent instanceof PrototypeHatBlockMorph)&&!contains(blackList,input)&&touchingVariadicArrowsIfAny(input))};ScriptsMorph.prototype.closestBlock=function(comment,hand){var fb=comment.bounds,stacks=this.children.filter(child=>child instanceof BlockMorph&&child.fullBounds().intersects(fb)),handPos,target,all;all=[];stacks.forEach(stack=>{all=all.concat(stack.allChildren().slice(0).reverse().filter(child=>child instanceof BlockMorph&&!child.isTemplate))});if(all.length===0){return null}if(hand){handPos=hand.position();target=detect(all,block=>!block.comment&&!block.isPrototype&&block.bounds.containsPoint(handPos));if(target){return target}}return detect(all,block=>!block.comment&&!block.isPrototype&&block.bounds.intersects(fb))};ScriptsMorph.prototype.userMenu=function(){var menu=new MenuMorph(this),ide=this.parentThatIsA(IDE_Morph),shiftClicked=this.world().currentKey===16,blockEditor,obj=this.scriptTarget(),hasUndropQueue,stage=obj.parentThatIsA(StageMorph);function addOption(label,toggle,test,onHint,offHint){menu.addItem([test?new SymbolMorph("checkedBox",MorphicPreferences.menuFontSize*.75):new SymbolMorph("rectangle",MorphicPreferences.menuFontSize*.75),localize(label)],toggle,test?onHint:offHint)}if(!ide){blockEditor=this.parentThatIsA(BlockEditorMorph);if(blockEditor){ide=blockEditor.target.parentThatIsA(IDE_Morph)}}if(this.dropRecord){if(this.dropRecord.lastRecord){hasUndropQueue=true;menu.addPair([new SymbolMorph("turnBack",MorphicPreferences.menuFontSize),localize("undrop")],"undrop","^Z","undo the last\nblock drop\nin this pane")}if(this.dropRecord.nextRecord){hasUndropQueue=true;menu.addPair([new SymbolMorph("turnForward",MorphicPreferences.menuFontSize),localize("redrop")],"redrop","^Y","redo the last undone\nblock drop\nin this pane")}if(hasUndropQueue){if(shiftClicked){menu.addItem("clear undrop queue",()=>{this.dropRecord=null;this.clearDropInfo();this.recordDrop()},"forget recorded block drops\non this pane",new Color(100,0,0))}menu.addLine()}}menu.addItem("clean up","cleanUp","arrange scripts\nvertically");menu.addItem("add comment","addComment");menu.addItem("scripts pic...","exportScriptsPicture","save a picture\nof all scripts");if(ide){menu.addLine();if(!blockEditor&&obj.exemplar){addOption("inherited",()=>obj.toggleInheritanceForAttribute("scripts"),obj.inheritsAttribute("scripts"),"uncheck to\ndisinherit",localize("check to inherit\nfrom")+" "+obj.exemplar.name)}menu.addItem("make a block...",()=>new BlockDialogMorph(null,definition=>{if(definition.spec!==""){if(definition.isGlobal){stage.globalBlocks.push(definition)}else{obj.customBlocks.push(definition)}ide.flushPaletteCache();ide.refreshPalette();new BlockEditorMorph(definition,obj).popUp()}},this).prompt("Make a block",null,this.world()))}return menu};ScriptsMorph.prototype.cleanUp=function(){var target=this.selectForEdit(),origin=target.topLeft(),y=target.cleanUpMargin;target.children.sort((a,b)=>a instanceof PrototypeHatBlockMorph?0:a.top()-b.top()).forEach(child=>{if(child instanceof CommentMorph&&child.block){return}child.setPosition(origin.add(new Point(target.cleanUpMargin,y)));if(child instanceof BlockMorph){child.allComments().forEach(comment=>comment.align(child,true))}y+=child.stackHeight()+target.cleanUpSpacing});if(target.parent){target.setPosition(target.parent.topLeft())}target.adjustBounds()};ScriptsMorph.prototype.exportScriptsPicture=function(){var pic=this.scriptsPicture(),ide=this.world().children[0],xml=this.scriptsXML();if(pic){if(xml){ide.saveFileAs(embedMetadataPNG(pic,xml),"image/png",(ide.getProjectName()||localize("untitled"))+" "+localize("script pic"))}else{ide.saveCanvasAs(pic,(ide.getProjectName()||localize("untitled"))+" "+localize("script pic"))}}};ScriptsMorph.prototype.scriptsPicture=function(){var boundingBox,pic,ctx;if(this.children.length===0){return}boundingBox=this.children[0].fullBounds();this.children.forEach(child=>{if(child.isVisible){boundingBox=boundingBox.merge(child.fullBounds())}});pic=newCanvas(boundingBox.extent());ctx=pic.getContext("2d");this.children.forEach(child=>{var pos=child.fullBounds().origin;if(child.isVisible){ctx.drawImage(child.fullImage(),pos.x-boundingBox.origin.x,pos.y-boundingBox.origin.y)}});return pic};ScriptsMorph.prototype.scriptsXML=function(){var blockEditor=this.parentThatIsA(BlockEditorMorph),ide=this.world().children[0],scripts=this.children.filter(m=>m instanceof BlockMorph),target;if(blockEditor){return ide.blocksLibraryXML([blockEditor.definition].concat(blockEditor.definition.collectDependencies([],[],blockEditor.target)),null,true)}if(scripts.length===1){return scripts[0].toXMLString()}target=this.scriptTarget();if(isSnapObject(target)){return target.toXMLString()}return null};ScriptsMorph.prototype.addComment=function(){var ide=this.parentThatIsA(IDE_Morph),blockEditor=this.parentThatIsA(BlockEditorMorph),world=this.world();(new CommentMorph).pickUp(world);if(!ide&&blockEditor){ide=blockEditor.target.parentThatIsA(IDE_Morph)}if(ide){world.hand.grabOrigin={origin:ide.palette,position:ide.palette.center()}}};ScriptsMorph.prototype.undrop=function(){if(this.isAnimating){return}if(!this.dropRecord||!this.dropRecord.lastRecord){return}if(!this.dropRecord.situation){this.dropRecord.situation=this.dropRecord.lastDroppedBlock.situation()}this.isAnimating=true;this.dropRecord.lastDroppedBlock.slideBackTo(this.dropRecord.lastOrigin,null,this.recoverLastDrop(),()=>{this.updateToolbar();this.isAnimating=false});this.dropRecord=this.dropRecord.lastRecord};ScriptsMorph.prototype.redrop=function(){if(this.isAnimating){return}if(!this.dropRecord||!this.dropRecord.nextRecord){return}this.dropRecord=this.dropRecord.nextRecord;if(this.dropRecord.action==="delete"){this.recoverLastDrop(true);this.dropRecord.lastDroppedBlock.destroy();this.updateToolbar()}else{this.isAnimating=true;if(this.dropRecord.action==="extract"){this.dropRecord.lastDroppedBlock.extract()}this.dropRecord.lastDroppedBlock.slideBackTo(this.dropRecord.situation,null,this.recoverLastDrop(true),()=>{this.updateToolbar();this.isAnimating=false})}};ScriptsMorph.prototype.recoverLastDrop=function(forRedrop){var rec=this.dropRecord,dropped,onBeforeDrop,parent;if(!rec||!rec.lastDroppedBlock){throw new Error("nothing to undrop")}dropped=rec.lastDroppedBlock;parent=dropped.parent;if(dropped instanceof CommandBlockMorph){if(rec.lastNextBlock){if(rec.action==="delete"){if(forRedrop){this.add(rec.lastNextBlock)}}else{this.add(rec.lastNextBlock)}}if(rec.lastDropTarget){if(rec.lastDropTarget.loc==="bottom"){if(rec.lastDropTarget.type==="slot"){if(rec.lastNextBlock){rec.lastDropTarget.element.nestedBlock(rec.lastNextBlock)}}else{if(rec.lastNextBlock){rec.lastDropTarget.element.nextBlock(rec.lastNextBlock)}}}else if(rec.lastDropTarget.loc==="top"){this.add(rec.lastDropTarget.element)}else if(rec.lastDropTarget.loc==="wrap"){var cslot=detect(rec.lastDroppedBlock.inputs(),each=>each instanceof CSlotMorph);if(rec.lastWrapParent instanceof CommandBlockMorph){if(forRedrop){onBeforeDrop=()=>cslot.nestedBlock(rec.lastDropTarget.element)}else{rec.lastWrapParent.nextBlock(rec.lastDropTarget.element)}}else if(rec.lastWrapParent instanceof CommandSlotMorph){if(forRedrop){onBeforeDrop=()=>cslot.nestedBlock(rec.lastDropTarget.element)}else{rec.lastWrapParent.nestedBlock(rec.lastDropTarget.element)}}else{this.add(rec.lastDropTarget.element)}rec.lastDropTarget.element.blockSequence().forEach(cmd=>cmd.fixBlockColor());cslot.fixLayout()}}}else if(dropped instanceof ReporterBlockMorph){if(rec.lastDropTarget){if(forRedrop){rec.lastDropTarget.replaceInput(rec.lastReplacedInput,rec.lastDroppedBlock)}else{rec.lastDropTarget.replaceInput(rec.lastDroppedBlock,rec.lastReplacedInput)}rec.lastDropTarget.fixBlockColor(null,true);if(rec.lastPreservedBlocks){rec.lastPreservedBlocks.forEach(morph=>morph.destroy())}}}else if(dropped instanceof CommentMorph){if(forRedrop&&rec.lastDropTarget){onBeforeDrop=()=>{rec.lastDropTarget.element.comment=dropped;dropped.block=rec.lastDropTarget.element;dropped.align()}}}else{throw new Error("unsupported action for "+dropped)}this.clearDropInfo();dropped.prepareToBeGrabbed(this.world().hand);if(dropped instanceof CommentMorph){dropped.removeShadow()}this.add(dropped);parent.reactToGrabOf(dropped);if(dropped instanceof ReporterBlockMorph&&parent instanceof BlockMorph){parent.changed()}if(rec.action==="delete"){if(forRedrop&&rec.lastNextBlock){if(parent instanceof CommandBlockMorph){parent.nextBlock(rec.lastNextBlock)}else if(parent instanceof CommandSlotMorph){parent.nestedBlock(rec.lastNextBlock)}}if(!forRedrop){dropped.moveBy(new Point(-100,-20))}}return onBeforeDrop};ScriptsMorph.prototype.clearDropInfo=function(){this.lastDroppedBlock=null;this.lastReplacedInput=null;this.lastDropTarget=null;this.lastPreservedBlocks=null;this.lastNextBlock=null;this.lastWrapParent=null};ScriptsMorph.prototype.recordDrop=function(lastGrabOrigin){var ide,blockEditor,record={lastDroppedBlock:this.lastDroppedBlock,lastReplacedInput:this.lastReplacedInput,lastDropTarget:this.lastDropTarget,lastPreservedBlocks:this.lastPreservedBlocks,lastNextBlock:this.lastNextBlock,lastWrapParent:this.lastWrapParent,lastOrigin:lastGrabOrigin,action:lastGrabOrigin?lastGrabOrigin.action||null:null,situation:null,lastRecord:this.dropRecord,nextRecord:null};if(this.dropRecord){this.dropRecord.nextRecord=record}this.dropRecord=record;this.updateToolbar();ide=this.parentThatIsA(IDE_Morph);if(!ide){blockEditor=this.parentThatIsA(BlockEditorMorph);if(blockEditor){ide=blockEditor.target.parentThatIsA(IDE_Morph)}}if(ide){ide.recordUnsavedChanges()}};ScriptsMorph.prototype.addToolbar=function(){var toolBar=new AlignmentMorph,shade=new Color(140,140,140);toolBar.respectHiddens=true;toolBar.undoButton=new PushButtonMorph(this,"undrop",new SymbolMorph("turnBack",12));toolBar.undoButton.alpha=.2;toolBar.undoButton.padding=4;toolBar.undoButton.labelShadowColor=shade;toolBar.undoButton.edge=0;toolBar.undoButton.fixLayout();toolBar.add(toolBar.undoButton);toolBar.redoButton=new PushButtonMorph(this,"redrop",new SymbolMorph("turnForward",12));toolBar.redoButton.alpha=.2;toolBar.redoButton.padding=4;toolBar.redoButton.labelShadowColor=shade;toolBar.redoButton.edge=0;toolBar.redoButton.fixLayout();toolBar.add(toolBar.redoButton);toolBar.keyboardButton=new ToggleButtonMorph(null,this,"toggleKeyboardEntry",[new SymbolMorph("keyboard",12),new SymbolMorph("keyboardFilled",12)],()=>!isNil(this.focus));toolBar.keyboardButton.alpha=.2;toolBar.keyboardButton.padding=4;toolBar.keyboardButton.edge=0;toolBar.keyboardButton.hint="use the keyboard\nto enter blocks";toolBar.keyboardButton.labelShadowColor=shade;toolBar.keyboardButton.fixLayout();toolBar.add(toolBar.keyboardButton);return toolBar};ScriptsMorph.prototype.updateToolbar=function(){var sf=this.parentThatIsA(ScrollFrameMorph);if(!sf){return}if(!sf.toolBar){sf.toolBar=this.addToolbar();sf.add(sf.toolBar)}if(this.enableKeyboard){sf.toolBar.keyboardButton.show();sf.toolBar.keyboardButton.refresh()}else{sf.toolBar.keyboardButton.hide()}if(this.dropRecord){if(this.dropRecord.lastRecord){if(!sf.toolBar.undoButton.isVisible){sf.toolBar.undoButton.show()}}else{if(sf.toolBar.undoButton.isVisible){sf.toolBar.undoButton.hide()}}if(this.dropRecord.nextRecord){if(!sf.toolBar.redoButton.isVisible){sf.toolBar.redoButton.show();sf.toolBar.undoButton.mouseLeave()}}else{if(sf.toolBar.redoButton.isVisible){sf.toolBar.redoButton.hide()}}}if(detect(sf.toolBar.children,each=>each.isVisible)){sf.toolBar.fixLayout();sf.adjustToolBar()}};ScriptsMorph.prototype.sortedElements=function(){var scripts=this.children.filter(each=>each instanceof CommentMorph?!each.block:true);scripts.sort((a,b)=>a instanceof PrototypeHatBlockMorph?0:a.top()-b.top());return scripts};ScriptsMorph.prototype.fixMultiArgs=function(){this.forAllChildren(morph=>{if(morph instanceof MultiArgMorph){morph.fixLayout()}})};ScriptsMorph.prototype.wantsDropOf=function(aMorph){if(aMorph instanceof HatBlockMorph){return!this.rejectsHats}return aMorph instanceof SyntaxElementMorph||aMorph instanceof CommentMorph};ScriptsMorph.prototype.reactToDropOf=function(droppedMorph,hand){if(droppedMorph instanceof BlockMorph||droppedMorph instanceof CommentMorph){droppedMorph.snap(hand)}this.adjustBounds()};ScriptsMorph.prototype.mouseClickLeft=function(pos){var shiftClicked=this.world().currentKey===16;if(shiftClicked){return this.edit(pos)}if(this.focus){this.focus.stopEditing()}};ScriptsMorph.prototype.selectForEdit=function(){var ide=this.parentThatIsA(IDE_Morph),rcvr=ide?ide.currentSprite:null;if(rcvr&&rcvr.inheritsAttribute("scripts")){this.feedbackMorph.destroy();rcvr.shadowAttribute("scripts");return rcvr.scripts}return this};ScriptsMorph.prototype.droppedImage=function(aCanvas,name,embeddedData){var ide=this.parentThatIsA(IDE_Morph),blockEditor=this.parentThatIsA(BlockEditorMorph);if(!ide&&blockEditor){ide=blockEditor.target.parentThatIsA(IDE_Morph)}if(!ide){return}ide.droppedImage(aCanvas,name,embeddedData,"scripts")};ScriptsMorph.prototype.edit=function(pos){var target,world=this.world();if(this.focus){this.focus.stopEditing()}world.stopEditing();if(!ScriptsMorph.prototype.enableKeyboard){return}target=this.selectForEdit();target.focus=new ScriptFocusMorph(target,target,pos);target.focus.getFocus(world)};ScriptsMorph.prototype.toggleKeyboardEntry=function(){var target,sorted,world=this.world();if(this.focus){this.focus.stopEditing();return}world.stopEditing();if(!ScriptsMorph.prototype.enableKeyboard){return}target=this.selectForEdit();target.focus=new ScriptFocusMorph(target,target,target.position());target.focus.getFocus(world);sorted=target.focus.sortedScripts();if(sorted.length){target.focus.element=sorted[0];if(target.focus.element instanceof HatBlockMorph){target.focus.nextCommand()}}else{target.focus.moveBy(new Point(50,50))}target.focus.fixLayout()};ScriptsMorph.prototype.scriptTarget=function(){var editor=this.parentThatIsA(IDE_Morph);if(editor){return editor.currentSprite}editor=this.parentThatIsA(BlockEditorMorph);if(editor){return editor.target}throw new Error("script target cannot be found for orphaned scripts")};ArgMorph.prototype=new SyntaxElementMorph;ArgMorph.prototype.constructor=ArgMorph;ArgMorph.uber=SyntaxElementMorph.prototype;function ArgMorph(type){this.init(type)}ArgMorph.prototype.init=function(type){this.type=type||null;this.icon=null;ArgMorph.uber.init.call(this);this.color=new Color(0,17,173);this.createIcon();if(type==="list"){this.alpha=1}};ArgMorph.prototype.executeOnSliderEdit=false;ArgMorph.prototype.reactToSliderEdit=function(){var block,top,receiver,stage;if(!this.executeOnSliderEdit){return}block=this.parentThatIsA(BlockMorph);if(block){top=block.topBlock();receiver=top.scriptTarget();if(top instanceof PrototypeHatBlockMorph){return}if(receiver){stage=receiver.parentThatIsA(StageMorph);if(stage&&(stage.isThreadSafe||Process.prototype.enableSingleStepping)){stage.threads.startProcess(top,receiver,stage.isThreadSafe)}else{top.mouseClickLeft()}}}};ArgMorph.prototype.justDropped=function(){if(!(this instanceof CommandSlotMorph)){this.fixLayout();this.rerender()}};ArgMorph.prototype.getSpec=function(){return this.type==="list"?"%l":"%s"};ArgMorph.prototype.userMenu=function(){var sm=this.slotMenu(),menu;if(!sm&&!(this.parent instanceof MultiArgMorph)){return this.parent.userMenu()}menu=sm||new MenuMorph(this);if(this.parent instanceof MultiArgMorph&&this.parentThatIsA(ScriptsMorph)&&!(this.parent.slotSpec instanceof Array)){if(!this.parent.maxInputs||this.parent.inputs().length<this.parent.maxInputs){menu.addItem("insert a slot",()=>this.parent.insertNewInputBefore(this))}if(this.parent.inputs().length>this.parent.minInputs){menu.addItem("delete slot",()=>this.parent.deleteSlot(this))}}return menu};ArgMorph.prototype.slotMenu=function(){return null};ArgMorph.prototype.createIcon=function(){switch(this.type){case"list":this.icon=this.labelPart("%list");this.add(this.icon);break;case"object":this.icon=this.labelPart("%turtle");this.add(this.icon);break;default:nop()}};ArgMorph.prototype.fixLayout=function(){if(this.icon){this.icon.setPosition(this.position());this.bounds.setExtent(this.icon.extent())}else{ArgMorph.uber.fixLayout.call(this)}};ArgMorph.prototype.render=function(ctx){var block;if(this.icon){block=this.parentThatIsA(BlockMorph);if(block){this.icon.shadowColor=block.color.darker(this.labelContrast)}switch(this.type){case"list":this.color=new Color(255,140,0);break;default:return}}ArgMorph.uber.render.call(this,ctx)};ArgMorph.prototype.isEmptySlot=function(){return this.type!==null};CommandSlotMorph.prototype=new ArgMorph;CommandSlotMorph.prototype.constructor=CommandSlotMorph;CommandSlotMorph.uber=ArgMorph.prototype;function CommandSlotMorph(){this.init()}CommandSlotMorph.prototype.init=function(){CommandSlotMorph.uber.init.call(this);this.color=new Color(0,17,173);this.setExtent(new Point(230,this.corner*4+this.cSlotPadding))};CommandSlotMorph.prototype.getSpec=function(){return"%cmd"};CommandSlotMorph.prototype.topBlock=function(){if(this.parent.topBlock){return this.parent.topBlock()}return this.nestedBlock()};CommandSlotMorph.prototype.nestedBlock=function(block){if(block){var nb=this.nestedBlock();this.add(block);if(nb){block.bottomBlock().nextBlock(nb)}this.fixLayout()}else{return detect(this.children,child=>child instanceof CommandBlockMorph)}};CommandSlotMorph.prototype.slotAttachPoint=function(){return new Point(this.dentCenter(),this.top()+this.corner*2)};CommandSlotMorph.prototype.dentLeft=function(){return this.left()+this.corner+this.inset*2};CommandSlotMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+this.dent*.5};CommandSlotMorph.prototype.attachTargets=function(){var answer=[];answer.push({point:this.slotAttachPoint(),element:this,loc:"bottom",type:"slot"});return answer};CommandSlotMorph.prototype.fixLayout=function(){var nb=this.nestedBlock();if(this.parent){if(!this.color.eq(this.parent.color)){this.setColor(this.parent.color)}}if(nb){nb.setPosition(new Point(this.left()+this.edge+this.rfBorder,this.top()+this.edge+this.rfBorder));this.bounds.setWidth(nb.fullBounds().width()+(this.edge+this.rfBorder)*2);this.bounds.setHeight(nb.fullBounds().height()+this.edge+this.rfBorder*2-(this.corner-this.edge))}else{this.bounds.setHeight(this.corner*4);this.bounds.setWidth(this.corner*4+this.inset+this.dent)}if(this.parent&&this.parent.fixLayout){this.parent.fixLayout()}};CommandSlotMorph.prototype.evaluate=function(){return this.nestedBlock()};CommandSlotMorph.prototype.isEmptySlot=function(){return!this.isStatic&&this.nestedBlock()===null};CommandSlotMorph.prototype.attach=function(){var choices=this.overlappedMorphs(),menu=new MenuMorph(this,"choose new parent:");choices.forEach(each=>menu.addItem(each.toString().slice(0,50),()=>{each.add(this);this.isDraggable=false;if(each.fixLayout){each.fixLayout()}}));if(choices.length>0){menu.popUpAtHand(this.world())}};CommandSlotMorph.prototype.render=function(ctx){this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();ctx.fillStyle=this.cachedClr;ctx.fillRect(0,0,this.width(),this.height());ctx.fillStyle=this.rfColor.toString();this.drawFlat(ctx);if(MorphicPreferences.isFlat){return}this.drawEdges(ctx)};CommandSlotMorph.prototype.drawFlat=function(ctx){var isFilled=this.nestedBlock()!==null,ins=isFilled?this.inset:this.inset/2,dent=isFilled?this.dent:this.dent/2,indent=this.corner*2+ins,edge=this.edge,rf=isFilled?this.rfBorder:0,y=this.height()-this.corner-edge;ctx.beginPath();ctx.arc(this.corner+edge,this.corner+edge,this.corner,radians(-180),radians(-90),false);ctx.lineTo(this.corner+ins+edge+rf*2,edge);ctx.lineTo(indent+edge+rf*2,this.corner+edge);ctx.lineTo(indent+edge+rf*2+(dent-rf*2),this.corner+edge);ctx.lineTo(indent+edge+rf*2+(dent-rf*2)+this.corner,edge);ctx.lineTo(this.width()-this.corner-edge,edge);ctx.arc(this.width()-this.corner-edge,this.corner+edge,this.corner,radians(-90),radians(-0),false);ctx.arc(this.width()-this.corner-edge,y,this.corner,radians(0),radians(90),false);ctx.arc(this.corner+edge,y,this.corner,radians(90),radians(180),false);ctx.closePath();ctx.fill()};CommandSlotMorph.prototype.drawEdges=function(ctx){var isFilled=this.nestedBlock()!==null,ins=isFilled?this.inset:this.inset/2,dent=isFilled?this.dent:this.dent/2,indent=this.corner*2+ins,edge=this.edge,rf=isFilled?this.rfBorder:0,shift=this.edge*.5,gradient,upperGradient,lowerGradient,rightGradient;ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";gradient=ctx.createLinearGradient(0,this.height(),0,this.height()-this.edge);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(this.corner+edge,this.height()-shift);ctx.lineTo(this.width()-this.corner-edge,this.height()-shift);ctx.stroke();gradient=ctx.createRadialGradient(this.width()-(this.corner+edge),this.height()-(this.corner+edge),this.corner,this.width()-(this.corner+edge),this.height()-(this.corner+edge),this.corner+edge);gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(this.width()-(this.corner+edge),this.height()-(this.corner+edge),this.corner+shift,radians(0),radians(90),false);ctx.stroke();gradient=ctx.createLinearGradient(this.width(),0,this.width()-this.edge,0);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(this.width()-shift,this.height()-this.corner-this.edge);ctx.lineTo(this.width()-shift,edge+this.corner);ctx.stroke();if(useBlurredShadows){ctx.shadowOffsetY=shift;ctx.shadowBlur=this.edge;ctx.shadowColor=this.rfColor.darker(80).toString()}gradient=ctx.createLinearGradient(0,0,edge,0);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,edge+this.corner);ctx.lineTo(shift,this.height()-edge-this.corner);ctx.stroke();gradient=ctx.createRadialGradient(this.corner+edge,this.corner+edge,this.corner,this.corner+edge,this.corner+edge,this.corner+edge);gradient.addColorStop(0,this.cachedClrDark);gradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(this.corner+edge,this.corner+edge,this.corner+shift,radians(-180),radians(-90),false);ctx.stroke();upperGradient=ctx.createLinearGradient(0,0,0,this.edge);upperGradient.addColorStop(0,this.cachedClr);upperGradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=upperGradient;ctx.beginPath();ctx.moveTo(this.corner+edge,shift);ctx.lineTo(this.corner+ins+edge+rf*2-shift,shift);ctx.stroke();lowerGradient=ctx.createLinearGradient(0,this.corner,0,this.corner+edge);lowerGradient.addColorStop(0,this.cachedClr);lowerGradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=lowerGradient;ctx.beginPath();ctx.moveTo(indent+edge+rf*2+shift,this.corner+shift);ctx.lineTo(indent+edge+rf*2+(dent-rf*2),this.corner+shift);ctx.stroke();rightGradient=ctx.createLinearGradient(indent+edge+rf*2+(dent-rf*2)-shift,this.corner,indent+edge+rf*2+(dent-rf*2)+shift*.7,this.corner+shift+shift*.7);rightGradient.addColorStop(0,this.cachedClr);rightGradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=rightGradient;ctx.beginPath();ctx.moveTo(indent+edge+rf*2+(dent-rf*2),this.corner+shift);ctx.lineTo(indent+edge+rf*2+(dent-rf*2)+this.corner,shift);ctx.stroke();ctx.strokeStyle=upperGradient;ctx.beginPath();ctx.moveTo(indent+edge+rf*2+(dent-rf*2)+this.corner,shift);ctx.lineTo(this.width()-this.corner-edge,shift);ctx.stroke()};RingCommandSlotMorph.prototype=new CommandSlotMorph;RingCommandSlotMorph.prototype.constructor=RingCommandSlotMorph;RingCommandSlotMorph.uber=CommandSlotMorph.prototype;RingCommandSlotMorph.prototype.rfBorder=0;RingCommandSlotMorph.prototype.edge=RingMorph.prototype.edge;function RingCommandSlotMorph(){this.init()}RingCommandSlotMorph.prototype.init=function(){RingCommandSlotMorph.uber.init.call(this);this.color=new Color(0,17,173);this.contrast=RingMorph.prototype.contrast};RingCommandSlotMorph.prototype.getSpec=function(){return"%rc"};RingCommandSlotMorph.prototype.render=function(ctx){if(MorphicPreferences.isFlat){return}this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();ctx.fillStyle=this.cachedClr;this.drawEdges(ctx)};RingCommandSlotMorph.prototype.outlinePath=function(ctx,offset){var ox=offset.x,oy=offset.y,isFilled=this.nestedBlock()!==null,ins=isFilled?this.inset:this.inset/2,dent=isFilled?this.dent:this.dent/2,indent=this.corner*2+ins,edge=this.edge,w=this.width(),h=this.height(),rf=isFilled?this.rfBorder:0,y=h-this.corner-edge;ctx.arc(this.corner+edge+ox,this.corner+edge+oy,this.corner,radians(-180),radians(-90),false);ctx.lineTo(this.corner+ins+edge+rf*2+ox,edge+oy);ctx.lineTo(indent+edge+rf*2+ox,this.corner+edge+oy);ctx.lineTo(indent+edge+rf*2+(dent-rf*2)+ox,this.corner+edge+oy);ctx.lineTo(indent+edge+rf*2+(dent-rf*2)+this.corner+ox,edge+oy);ctx.lineTo(this.width()-this.corner-edge+ox,edge+oy);ctx.arc(w-this.corner-edge+ox,this.corner+edge+oy,this.corner,radians(-90),radians(-0),false);ctx.arc(this.width()-this.corner-edge+ox,y+oy,this.corner,radians(0),radians(90),false);ctx.arc(this.corner+edge+ox,y+oy,this.corner,radians(90),radians(180),false);ctx.lineTo(this.corner+edge+ox-this.corner,this.corner+edge+oy)};CSlotMorph.prototype=new CommandSlotMorph;CSlotMorph.prototype.constructor=CSlotMorph;CSlotMorph.uber=CommandSlotMorph.prototype;function CSlotMorph(){this.init()}CSlotMorph.prototype.init=function(){CommandSlotMorph.uber.init.call(this);this.isLambda=false;this.isLoop=false;this.color=new Color(0,17,173);this.setExtent(new Point(230,this.corner*4+this.cSlotPadding))};CSlotMorph.prototype.getSpec=function(){return this.isLoop?"%loop":"%c"};CSlotMorph.prototype.mappedCode=function(definitions){var code=StageMorph.prototype.codeMappings.reify||"<#1>",codeLines=code.split("\n"),nested=this.nestedBlock(),part=nested?nested.mappedCode(definitions):"",partLines=part.toString().split("\n"),rx=new RegExp("<#1>","g");codeLines.forEach((codeLine,idx)=>{var prefix="",indent;if(codeLine.trimLeft().indexOf("<#1>")===0){indent=codeLine.indexOf("<#1>");prefix=codeLine.slice(0,indent)}codeLines[idx]=codeLine.replace(new RegExp("<#1>"),partLines.join("\n"+prefix));codeLines[idx]=codeLines[idx].replace(rx,partLines.join("\n"))});return codeLines.join("\n")};CSlotMorph.prototype.fixLayout=function(){var nb=this.nestedBlock();if(nb){nb.setPosition(new Point(this.left()+this.inset,this.top()+this.corner));this.bounds.setHeight(nb.fullBounds().height()+this.corner);this.bounds.setWidth(nb.fullBounds().width()+this.cSlotPadding*2)}else{this.bounds.setHeight(this.corner*4+this.cSlotPadding);this.bounds.setWidth(this.corner*4+this.inset*2+this.dent+this.cSlotPadding*2)}if(this.parent&&this.parent.fixLayout){this.parent.fixLayout()}};CSlotMorph.prototype.fixLoopLayout=function(){var loop;if(this.isLoop){loop=this.loop();if(loop){loop.setRight(this.right()-this.corner);loop.setBottom(this.bottom()+this.cSlotPadding+this.edge)}}};CSlotMorph.prototype.loop=function(){if(this.isLoop){return detect(this.children,child=>child instanceof SymbolMorph)}return null};CSlotMorph.prototype.fixHolesLayout=function(){this.holes=[new Rectangle(this.inset,this.corner,this.width(),this.height()-this.corner)]};CSlotMorph.prototype.isLocked=function(){return this.isStatic||this.parent instanceof MultiArgMorph};CSlotMorph.prototype.render=function(ctx){if(MorphicPreferences.isFlat){return}this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();ctx.fillStyle=this.cachedClr;this.drawTopRightEdge(ctx);this.drawTopEdge(ctx,this.inset,this.corner);this.drawTopLeftEdge(ctx);this.drawBottomEdge(ctx);this.drawRightEdge(ctx)};CSlotMorph.prototype.outlinePath=function(ctx,inset,offset){var ox=offset.x,oy=offset.y,radius=Math.max(this.corner-inset,0);ctx.lineTo(this.width()+ox-inset,oy);ctx.arc(this.width()-this.corner+ox,oy,radius,radians(90),radians(0),true);ctx.lineTo(this.width()-this.corner+ox,this.corner+oy-inset);ctx.lineTo(this.inset*2+this.corner*3+this.dent+ox,this.corner+oy-inset);ctx.lineTo(this.inset*2+this.corner*2+this.dent+ox,this.corner*2+oy-inset);ctx.lineTo(this.inset*2+this.corner*2+ox,this.corner*2+oy-inset);ctx.lineTo(this.inset*2+this.corner+ox,this.corner+oy-inset);ctx.lineTo(this.inset+this.corner+ox,this.corner+oy-inset);ctx.arc(this.inset+this.corner+ox,this.corner*2+oy,this.corner+inset,radians(270),radians(180),true);ctx.lineTo(this.inset+ox-inset,this.height()-this.corner*2+oy);ctx.arc(this.inset+this.corner+ox,this.height()-this.corner*2+oy,this.corner+inset,radians(180),radians(90),true);ctx.lineTo(this.width()-this.corner+ox,this.height()-this.corner+oy+inset);ctx.arc(this.width()-this.corner+ox,this.height()+oy,radius,radians(-90),radians(-0),false)};CSlotMorph.prototype.drawTopRightEdge=function(ctx){var shift=this.edge*.5,x=this.width()-this.corner,y=0,gradient;gradient=ctx.createRadialGradient(x,y,this.corner,x,y,this.corner-this.edge);gradient.addColorStop(0,this.cachedClrDark);gradient.addColorStop(1,this.cachedClr);ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(x,y,this.corner-shift,radians(90),radians(0),true);ctx.stroke()};CSlotMorph.prototype.drawTopEdge=function(ctx,x,y){var shift=this.edge*.5,indent=x+this.corner*2+this.inset,upperGradient,lowerGradient,rightGradient;ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";upperGradient=ctx.createLinearGradient(0,y-this.edge,0,y);upperGradient.addColorStop(0,this.cachedClr);upperGradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=upperGradient;ctx.beginPath();ctx.moveTo(x+this.corner,y-shift);ctx.lineTo(x+this.corner+this.inset-shift,y-shift);ctx.stroke();lowerGradient=ctx.createLinearGradient(0,y+this.corner-this.edge,0,y+this.corner);lowerGradient.addColorStop(0,this.cachedClr);lowerGradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=lowerGradient;ctx.beginPath();ctx.moveTo(indent+shift,y+this.corner-shift);ctx.lineTo(indent+this.dent,y+this.corner-shift);ctx.stroke();rightGradient=ctx.createLinearGradient(x+this.inset+this.corner*2+this.dent-shift,y+this.corner-shift-shift,x+this.inset+this.corner*2+this.dent+shift*.7,y+this.corner-shift+shift*.7);rightGradient.addColorStop(0,this.cachedClr);rightGradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=rightGradient;ctx.beginPath();ctx.moveTo(x+this.inset+this.corner*2+this.dent,y+this.corner-shift);ctx.lineTo(x+this.corner*3+this.inset+this.dent,y-shift);ctx.stroke();ctx.strokeStyle=upperGradient;ctx.beginPath();ctx.moveTo(x+this.corner*3+this.inset+this.dent,y-shift);ctx.lineTo(this.width()-this.corner,y-shift);ctx.stroke()};CSlotMorph.prototype.drawTopLeftEdge=function(ctx){var shift=this.edge*.5,gradient;gradient=ctx.createRadialGradient(this.corner+this.inset,this.corner*2,this.corner,this.corner+this.inset,this.corner*2,this.corner+this.edge);gradient.addColorStop(0,this.cachedClrDark);gradient.addColorStop(1,this.cachedClr);ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(this.corner+this.inset,this.corner*2,this.corner+shift,radians(-180),radians(-90),false);ctx.stroke()};CSlotMorph.prototype.drawRightEdge=function(ctx){var shift=this.edge*.5,x=this.inset,gradient;gradient=ctx.createLinearGradient(x-this.edge,0,x,0);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(x-shift,this.corner*2);ctx.lineTo(x-shift,this.height()-this.corner*2);ctx.stroke()};CSlotMorph.prototype.drawBottomEdge=function(ctx){var shift=this.edge*.5,gradient,upperGradient;ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";upperGradient=ctx.createRadialGradient(this.corner+this.inset,this.height()-this.corner*2,this.corner,this.corner+this.inset,this.height()-this.corner*2,this.corner+this.edge);upperGradient.addColorStop(0,this.cachedClrBright);upperGradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=upperGradient;ctx.beginPath();ctx.arc(this.corner+this.inset,this.height()-this.corner*2,this.corner+shift,radians(180),radians(90),true);ctx.stroke();gradient=ctx.createLinearGradient(0,this.height()-this.corner,0,this.height()-this.corner+this.edge);gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(this.inset+this.corner,this.height()-this.corner+shift);ctx.lineTo(this.width()-this.corner,this.height()-this.corner+shift);ctx.stroke()};InputSlotMorph.prototype=new ArgMorph;InputSlotMorph.prototype.constructor=InputSlotMorph;InputSlotMorph.uber=ArgMorph.prototype;function InputSlotMorph(text,isNumeric,choiceDict,isReadOnly){this.init(text,isNumeric,choiceDict,isReadOnly)}InputSlotMorph.prototype.init=function(text,isNumeric,choiceDict,isReadOnly){var contents=new InputSlotStringMorph(""),arrow=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1),BLACK,true);contents.fontSize=this.fontSize;contents.isShowingBlanks=true;this.selectedBlock=null;this.symbol=null;this.isUnevaluated=false;this.choices=choiceDict||null;this.oldContentsExtent=contents.extent();this.isNumeric=isNumeric||false;this.isReadOnly=isReadOnly||false;this.minWidth=0;this.constant=null;this.onSetContents=null;InputSlotMorph.uber.init.call(this,null,true);this.color=WHITE;this.add(contents);this.add(arrow);contents.isEditable=true;contents.isDraggable=false;contents.enableSelecting();this.setContents(text)};InputSlotMorph.prototype.getSpec=function(){if(this.isNumeric){return"%n"}return"%s"};InputSlotMorph.prototype.contents=function(){return detect(this.children,child=>child instanceof StringMorph)};InputSlotMorph.prototype.arrow=function(){return detect(this.children,child=>child instanceof ArrowMorph)};InputSlotMorph.prototype.setContents=function(data){var cnts=this.contents(),dta=data,isConstant=dta instanceof Array;if(this.selectedBlock){this.selectedBlock=null}if(this.symbol){this.symbol.destroy();this.symbol=null}if(isConstant){if(dta[0]==="__shout__go__"){this.symbol=this.labelPart("%greenflag");this.add(this.symbol);dta=""}else{dta=localize(dta[0]);cnts.isItalic=!this.isReadOnly}}else if(dta instanceof BlockMorph){this.selectedBlock=dta;dta=""}else{cnts.isItalic=false;if(!isNil(this.choices)&&this.choices[dta]instanceof Array){return this.setContents(this.choices[dta])}}cnts.text=dta;if(isNil(dta)){cnts.text=""}else if(dta.toString){cnts.text=dta.toString()}if(this.isReadOnly&&!MorphicPreferences.isFlat){cnts.shadowOffset=new Point(1,1)}cnts.fixLayout();this.constant=isConstant?data:null;if(this.isReadOnly&&this.parent instanceof BlockMorph){this.parent.fixLabelColor()}if(this.onSetContents){this[this.onSetContents](data)}};InputSlotMorph.prototype.userSetContents=function(aStringOrFloat){var block=this.parentThatIsA(BlockMorph),ide=this.parentThatIsA(IDE_Morph);this.selectForEdit().setContents(aStringOrFloat);if(ide&&!block.isTemplate){ide.recordUnsavedChanges()}};InputSlotMorph.prototype.dropDownMenu=function(enableKeyboard){var menu=this.menuFromDict(this.choices,null,enableKeyboard);if(!menu){return}if(menu.items.length>0){if(enableKeyboard){menu.popup(this.world(),this.bottomLeft());menu.getFocus()}else{menu.popUpAtHand(this.world())}}};InputSlotMorph.prototype.menuFromDict=function(choices,noEmptyOption,enableKeyboard){var key,dial,flag,myself=this,selector,block=this.parentThatIsA(BlockMorph),ide=this.parentThatIsA(IDE_Morph),menu=new MenuMorph(this.userSetContents,null,this,this.fontSize);function update(num){myself.setContents(num);myself.reactToSliderEdit();if(ide&&!block.isTemplate){ide.recordUnsavedChanges()}}function getImg(block){return()=>block.fullImage()}if(choices instanceof Function){if(!Process.prototype.enableJS){menu.addItem("JavaScript extensions for Snap!\nare turned off");return menu}choices=choices.call(this)}else if(isString(choices)){if(choices.indexOf("ext_")===0){selector=choices.slice(4);choices=SnapExtensions.menus.get(selector);if(choices){choices=choices.call(this)}else{menu.addItem('cannot find extension menu "'+selector+'"');return menu}}else{choices=this[choices]()}if(!choices){return}}if(!noEmptyOption){menu.addItem(" ",null)}for(key in choices){if(Object.prototype.hasOwnProperty.call(choices,key)){if(key[0]==="~"){menu.addLine()}else if(key.indexOf("§_def")===0){menu.addItem(this.doWithAlpha(1,getImg(choices[key])),choices[key])}else if(key.indexOf("§_dir")===0){dial=new DialMorph;dial.rootForGrab=function(){return this};dial.target=this;dial.action=update;dial.fillColor=this.parent.color;dial.setRadius(this.fontSize*3);dial.setValue(+this.evaluate(),false,true);menu.addLine();menu.items.push(dial);menu.addLine()}else if(key.indexOf("§_")===0){if(this.world().currentKey===16){menu.addItem(key.slice(2),choices[key],null,null,null,true,null,null,!(choices[key]instanceof Array)&&typeof choices[key]!=="function")}}else if(key==="__shout__go__"){flag=new SymbolMorph("flag");flag.size=this.fontSize*1.5;flag.setColor(new Color(0,200,0));flag.fixLayout();menu.addItem(flag,["__shout__go__"])}else if(choices[key]instanceof Object&&!(choices[key]instanceof Array)&&typeof choices[key]!=="function"){menu.addMenu(key,this.menuFromDict(choices[key],true),null,true)}else if(choices[key]instanceof Array&&choices[key][0]instanceof Object&&typeof choices[key][0]!=="function"){menu.addMenu(key,this.menuFromDict(choices[key][0],true),null,false)}else{menu.addItem(key,choices[key],null,null,null,null,null,null,!(choices[key]instanceof Array)&&typeof choices[key]!=="function"&&typeof choices[key]!=="number")}}}return menu};InputSlotMorph.prototype.keysMenu=function(){return{"any key":["any key"],"up arrow":["up arrow"],"down arrow":["down arrow"],"right arrow":["right arrow"],"left arrow":["left arrow"],enter:["enter"],space:["space"],"+":["+"],"-":["-"],a:["a"],b:["b"],c:["c"],d:["d"],e:["e"],f:["f"],g:["g"],h:["h"],i:["i"],j:["j"],k:["k"],l:["l"],m:["m"],n:["n"],o:["o"],p:["p"],q:["q"],r:["r"],s:["s"],t:["t"],u:["u"],v:["v"],w:["w"],x:["x"],y:["y"],z:["z"],0:["0"],1:["1"],2:["2"],3:["3"],4:["4"],5:["5"],6:["6"],7:["7"],8:["8"],9:["9"]}};InputSlotMorph.prototype.messagesMenu=function(searching){if(searching){return{}}var dict={},rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),allNames=[];stage.children.concat(stage).forEach(morph=>{if(isSnapObject(morph)){allNames=allNames.concat(morph.allMessageNames())}});allNames.sort().forEach(name=>dict[name]=name);dict.__shout__go__=["__shout__go__"];if(allNames.length>0){dict["~"]=null}dict["new..."]=()=>new DialogBoxMorph(this,this.setContents,this).prompt("Message name",null,this.world());return dict};InputSlotMorph.prototype.messagesReceivedMenu=function(searching){var dict={__shout__go__:["__shout__go__"],"any message":["any message"]},rcvr,stage,allNames;if(searching){return dict}rcvr=this.parentThatIsA(BlockMorph).scriptTarget();stage=rcvr.parentThatIsA(StageMorph);allNames=[];stage.children.concat(stage).forEach(morph=>{if(isSnapObject(morph)){allNames=allNames.concat(morph.allMessageNames())}});allNames.sort().forEach(name=>{if(name!=="__shout__go__"){dict[name]=name}});dict["~"]=null;dict["new..."]=()=>new DialogBoxMorph(this,this.setContents,this).prompt("Message name",null,this.world());return dict};InputSlotMorph.prototype.eventsMenu=function(searching){if(searching){return{}}return{__shout__go__:["__shout__go__"]}};InputSlotMorph.prototype.primitivesMenu=function(){var dict={},allNames=Array.from(SnapExtensions.primitives.keys());allNames.sort().forEach(name=>dict[name]=name);return dict};InputSlotMorph.prototype.collidablesMenu=function(searching){var dict={"mouse-pointer":["mouse-pointer"],edge:["edge"],"pen trails":["pen trails"]},rcvr,stage,allNames;if(searching){return dict}rcvr=this.parentThatIsA(BlockMorph).scriptTarget();stage=rcvr.parentThatIsA(StageMorph);allNames=[];stage.children.forEach(morph=>{if(morph instanceof SpriteMorph&&!morph.isTemporary){if(morph.name!==rcvr.name){allNames=allNames.concat(morph.name)}}});if(allNames.length>0){dict["~"]=null;allNames.forEach(name=>dict[name]=name)}return dict};InputSlotMorph.prototype.locationMenu=function(searching){var dict={"mouse-pointer":["mouse-pointer"],myself:["myself"]},rcvr,stage,allNames=[];if(searching){return dict}rcvr=this.parentThatIsA(BlockMorph).scriptTarget();stage=rcvr.parentThatIsA(StageMorph);allNames=[];stage.children.forEach(morph=>{if(morph instanceof SpriteMorph&&!morph.isTemporary){if(morph.name!==rcvr.name){allNames=allNames.concat(morph.name)}}});if(allNames.length>0){dict["~"]=null;allNames.forEach(name=>dict[name]=name)}return dict};InputSlotMorph.prototype.distancesMenu=function(searching){if(searching){return{"mouse-pointer":["mouse-pointer"],center:["center"]}}var block=this.parentThatIsA(BlockMorph),dict={},rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),allNames=[];if(block&&block.selector!=="reportRelationTo"){dict["random position"]=["random position"]}dict["mouse-pointer"]=["mouse-pointer"];dict.center=["center"];stage.children.forEach(morph=>{if(morph instanceof SpriteMorph&&!morph.isTemporary){if(morph.name!==rcvr.name){allNames=allNames.concat(morph.name)}}});if(allNames.length>0){dict["~"]=null;allNames.forEach(name=>dict[name]=name)}return dict};InputSlotMorph.prototype.clonablesMenu=function(searching){if(searching){return{}}var dict={},rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),allNames=[];if(rcvr instanceof SpriteMorph){dict.myself=["myself"]}stage.children.forEach(morph=>{if(morph instanceof SpriteMorph&&!morph.isTemporary){allNames=allNames.concat(morph.name)}});if(allNames.length>0){dict["~"]=null;allNames.forEach(name=>dict[name]=name)}return dict};InputSlotMorph.prototype.objectsMenuWithSelf=function(searching){if(searching){return{}}return this.objectsMenu(false,true)};InputSlotMorph.prototype.objectsMenu=function(searching,includeMyself){if(searching){return{}}var rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),dict={},allNames=[];if(includeMyself){dict.myself=["myself"]}dict[stage.name]=stage.name;stage.children.forEach(morph=>{if(morph instanceof SpriteMorph&&!morph.isTemporary){allNames.push(morph.name)}});if(allNames.length>0){dict["~"]=null;allNames.forEach(name=>dict[name]=name)}return dict};InputSlotMorph.prototype.receiversMenu=function(searching){var rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),dict={all:["all"]};if(searching){return dict}dict["~"]=null;dict[stage.name]=stage.name;stage.children.forEach(morph=>{if(morph instanceof SpriteMorph&&!morph.isTemporary){dict[morph.name]=morph.name}});return dict};InputSlotMorph.prototype.typesMenu=function(){var dict={number:["number"],text:["text"],Boolean:["Boolean"],list:["list"]};if(SpriteMorph.prototype.enableFirstClass){dict.sprite=["sprite"]}dict.costume=["costume"];dict.sound=["sound"];dict.command=["command"];dict.reporter=["reporter"];dict.predicate=["predicate"];return dict};InputSlotMorph.prototype.gettablesMenu=function(){var dict={},nest=SpriteMorph.prototype.enableNesting,oop=StageMorph.prototype.enableInheritance;dict.neighbors=["neighbors"];dict.self=["self"];dict["other sprites"]=["other sprites"];dict.clones=["clones"];dict["other clones"]=["other clones"];if(nest){dict.parts=["parts"];dict.anchor=["anchor"]}dict.stage=["stage"];if(oop){dict.children=["children"];dict.parent=["parent"];dict["temporary?"]=["temporary?"]}dict.name=["name"];dict.scripts=["scripts"];dict.costume=["costume"];dict.costumes=["costumes"];dict.sounds=["sounds"];dict.blocks=["blocks"];dict.categories=["categories"];dict["dangling?"]=["dangling?"];dict["draggable?"]=["draggable?"];dict.width=["width"];dict.height=["height"];dict.left=["left"];dict.right=["right"];dict.top=["top"];dict.bottom=["bottom"];dict["rotation style"]=["rotation style"];dict["rotation x"]=["rotation x"];dict["rotation y"]=["rotation y"];dict["center x"]=["center x"];dict["center y"]=["center y"];return dict};InputSlotMorph.prototype.attributesMenu=function(searching){var dict={position:["position"],"x position":["x position"],"y position":["y position"],direction:["direction"],"costume #":["costume #"],"costume name":["costume name"],size:["size"],width:["width"],height:["height"],left:["left"],right:["right"],top:["top"],bottom:["bottom"],volume:["volume"],balance:["balance"]},block,objName,rcvr,stage,obj,varNames;if(searching){return dict}block=this.parentThatIsA(BlockMorph);objName=block.inputs()[1].evaluate();rcvr=block.scriptTarget();stage=rcvr.parentThatIsA(StageMorph);varNames=[];if(objName===stage.name){obj=stage}else{obj=detect(stage.children,morph=>morph.name===objName)}if(obj instanceof StageMorph){dict={"costume #":["costume #"],"costume name":["costume name"],volume:["volume"],balance:["balance"],width:["width"],height:["height"],left:["left"],right:["right"],top:["top"],bottom:["bottom"]}}dict["~"]=null;dict.variables=["variables"];if(obj){varNames=obj.variables.names();if(varNames.length>0){varNames.forEach(name=>dict[name]=name)}obj.allBlocks(true).forEach((def,i)=>dict["§_def"+i]=def.blockInstance(true))}return dict};InputSlotMorph.prototype.costumesMenu=function(searching){if(searching){return{}}var block=this.parentThatIsA(BlockMorph),rcvr=block.scriptTarget(),dict,allNames=[];if(rcvr instanceof SpriteMorph){dict={Turtle:["Turtle"]}}else{dict={Empty:["Empty"]}}if(block.selector!=="doSwitchToCostume"){dict.current=["current"]}rcvr.costumes.asArray().forEach(costume=>allNames=allNames.concat(costume.name));if(allNames.length>0){dict["~"]=null;allNames.forEach(name=>dict[name]=name)}return dict};InputSlotMorph.prototype.soundsMenu=function(searching){if(searching){return{}}var rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),allNames=[],dict={};rcvr.sounds.asArray().forEach(sound=>allNames=allNames.concat(sound.name));if(allNames.length>0){allNames.sort().forEach(name=>dict[name]=name)}return dict};InputSlotMorph.prototype.shadowedVariablesMenu=function(searching){if(searching){return{}}var block=this.parentThatIsA(BlockMorph),vars,attribs,rcvr,dict={};if(!block){return dict}rcvr=block.scriptTarget();if(this.parentThatIsA(RingMorph)||this.topBlock().selector==="receiveOnClone"){vars=rcvr.variables.names();vars.forEach(name=>dict[name]=name);attribs=rcvr.attributes;attribs.forEach(name=>dict[name]=[name])}else if(rcvr&&rcvr.exemplar){vars=rcvr.inheritedVariableNames(true);vars.forEach(name=>dict[name]=name);attribs=rcvr.shadowedAttributes();attribs.forEach(name=>dict[name]=[name])}return dict};InputSlotMorph.prototype.pianoKeyboardMenu=function(searching){if(searching){return{}}var menu,block,instrument;block=this.parentThatIsA(BlockMorph);if(block){instrument=block.scriptTarget().instrument}menu=new PianoMenuMorph(this.setContents,this,this.fontSize,instrument);menu.popup(this.world(),new Point(this.right()-menu.width()/2,this.bottom()));menu.selectKey(+this.evaluate())};InputSlotMorph.prototype.directionDialMenu=function(searching){if(searching){return{}}return{"§_dir":null}};InputSlotMorph.prototype.audioMenu=function(searching){var dict={volume:["volume"],note:["note"],frequency:["frequency"],samples:["samples"],"sample rate":["sample rate"],spectrum:["spectrum"],resolution:["resolution"]};if(searching){return dict}if(this.world().currentKey===16){dict["~"]=null;dict.modifier=["modifier"];dict.output=["output"]}return dict};InputSlotMorph.prototype.scenesMenu=function(searching){var dict={},scenes;if(!searching){scenes=this.parentThatIsA(IDE_Morph).scenes;if(scenes.length()>1){scenes.itemsArray().forEach(scn=>{if(scn.name){dict[scn.name]=scn.name}})}}dict["~"]=null;dict.next=["next"];dict.previous=["previous"];dict.random=["random"];return dict};InputSlotMorph.prototype.setChoices=function(dict,readonly){var cnts=this.contents();this.choices=dict;this.isReadOnly=readonly||false;if(this.parent instanceof BlockMorph){this.parent.fixLabelColor();if(!readonly){cnts.shadowOffset=ZERO;cnts.shadowColor=null;cnts.setColor(BLACK)}}this.fixLayout()};InputSlotMorph.prototype.fixLayout=function(){var width,height,arrowWidth,contents=this.contents(),arrow=this.arrow(),tp=this.topBlock();contents.isNumeric=this.isNumeric;contents.isEditable=!this.isReadOnly;if(this.isReadOnly){contents.disableSelecting();contents.color=WHITE}else{contents.enableSelecting();contents.color=BLACK}if(this.choices){arrow.setSize(this.fontSize);arrow.show()}else{arrow.hide()}arrowWidth=arrow.isVisible?arrow.width():0;if(this.selectedBlock){height=this.selectedBlock.height()+this.edge*2;width=this.selectedBlock.width()+arrowWidth+this.edge*2+this.typeInPadding*2}else if(this.symbol){this.symbol.fixLayout();this.symbol.setPosition(this.position().add(this.edge*2));height=this.symbol.height()+this.edge*4;width=this.symbol.width()+arrowWidth+this.edge*4+this.typeInPadding*2}else{height=contents.height()+this.edge*2;if(this.isNumeric){width=contents.width()+Math.floor(arrowWidth*.5)+height+this.typeInPadding*2}else{width=Math.max(contents.width()+arrowWidth+this.edge*2+this.typeInPadding*2,contents.rawHeight?contents.rawHeight()+arrowWidth:fontHeight(contents.fontSize)/1.3+arrowWidth,this.minWidth)}}this.bounds.setExtent(new Point(width,height));if(this.isNumeric){contents.setPosition(new Point(Math.floor(height/2),this.edge).add(new Point(this.typeInPadding,0)).add(this.position()))}else{contents.setPosition(new Point(this.edge,this.edge).add(new Point(this.typeInPadding,0)).add(this.position()))}if(arrow.isVisible){arrow.setPosition(new Point(this.right()-arrowWidth-this.edge,contents.top()))}if(this.parent&&this.parent.fixLayout){tp.fullChanged();this.parent.fixLayout();tp.fullChanged()}};InputSlotMorph.prototype.mouseDownLeft=function(pos){if(this.isReadOnly||this.symbol||this.arrow().bounds.containsPoint(pos)){this.escalateEvent("mouseDownLeft",pos)}else{this.selectForEdit().contents().edit()}};InputSlotMorph.prototype.mouseClickLeft=function(pos){if(this.arrow().bounds.containsPoint(pos)){this.dropDownMenu()}else if(this.isReadOnly||this.symbol){this.dropDownMenu()}else{this.contents().edit()}};InputSlotMorph.prototype.reactToKeystroke=function(){var cnts;if(this.constant){cnts=this.contents();this.constant=null;cnts.isItalic=false;cnts.rerender()}};InputSlotMorph.prototype.reactToEdit=function(){var block=this.parentThatIsA(BlockMorph),ide=this.parentThatIsA(IDE_Morph);this.contents().clearSelection();if(ide&&!block.isTemplate){ide.recordUnsavedChanges()}};InputSlotMorph.prototype.freshTextEdit=function(aStringOrTextMorph){this.onNextStep=()=>aStringOrTextMorph.selectAll()};InputSlotMorph.prototype.slotMenu=function(){var menu;if(StageMorph.prototype.enableCodeMapping){menu=new MenuMorph(this);if(this.isNumeric){menu.addItem("code number mapping...","mapNumberToCode")}else{menu.addItem("code string mapping...","mapStringToCode")}return menu}return null};InputSlotMorph.prototype.updateEventUpvar=function(data){var trg=this.parent.inputs()[1];if(data instanceof Array&&data[0].indexOf("any")===0){trg.show()}else{trg.removeInput();trg.hide()}this.parent.fixLayout()};InputSlotMorph.prototype.mapStringToCode=function(){new DialogBoxMorph(this,code=>StageMorph.prototype.codeMappings.string=code,this).promptCode("Code mapping - String <#1>",StageMorph.prototype.codeMappings.string||"",this.world())};InputSlotMorph.prototype.mapNumberToCode=function(){new DialogBoxMorph(this,code=>StageMorph.prototype.codeMappings.number=code,this).promptCode("Code mapping - Number <#1>",StageMorph.prototype.codeMappings.number||"",this.world())};InputSlotMorph.prototype.mappedCode=function(){var block=this.parentThatIsA(BlockMorph),val=this.evaluate(),code;if(this.isNumeric){code=StageMorph.prototype.codeMappings.number||"<#1>";return code.replace(/<#1>/g,val)}if(!isNaN(parseFloat(val))){return val}if(!isString(val)){return val}if(block&&contains(["doSetVar","doChangeVar","doShowVar","doHideVar"],block.selector)){return val}code=StageMorph.prototype.codeMappings.string||"<#1>";return code.replace(/<#1>/g,val)};InputSlotMorph.prototype.evaluate=function(){var num,contents;if(this.selectedBlock){return this.selectedBlock}if(this.symbol){if(this.symbol.name==="flag"){return["__shout__go__"]}return""}if(this.constant){return this.constant}contents=this.contents();if(this.isNumeric){num=parseFloat(contents.text||"0");if(!isNaN(num)){return num}}return contents.text};InputSlotMorph.prototype.isEmptySlot=function(){return this.contents().text===""&&!this.selectedBlock&&!this.symbol};InputSlotMorph.prototype.flash=function(){if(!this.cachedNormalColor){this.cachedNormalColor=this.color;this.color=this.activeHighlight;this.rerender()}};InputSlotMorph.prototype.unflash=function(){if(this.cachedNormalColor){var clr=this.cachedNormalColor;this.cachedNormalColor=null;this.color=clr;this.rerender()}};InputSlotMorph.prototype.render=function(ctx){var borderColor,r;if(this.cachedNormalColor){borderColor=this.color}else if(this.parent){borderColor=this.parent.color}else{borderColor=new Color(120,120,120)}ctx.fillStyle=this.color.toString();if(this.isReadOnly&&!this.cachedNormalColor){ctx.fillStyle=borderColor.darker().toString()}this.cachedClr=borderColor.toString();this.cachedClrBright=borderColor.lighter(this.contrast).toString();this.cachedClrDark=borderColor.darker(this.contrast).toString();if(!this.isNumeric){ctx.fillRect(this.edge,this.edge,this.width()-this.edge*2,this.height()-this.edge*2);if(!MorphicPreferences.isFlat){this.drawRectBorder(ctx)}}else{r=Math.max((this.height()-this.edge*2)/2,0);ctx.beginPath();ctx.arc(r+this.edge,r+this.edge,r,radians(90),radians(-90),false);ctx.arc(this.width()-r-this.edge,r+this.edge,r,radians(-90),radians(90),false);ctx.closePath();ctx.fill();if(!MorphicPreferences.isFlat){this.drawRoundBorder(ctx)}}if(this.selectedBlock){ctx.drawImage(this.doWithAlpha(1,()=>this.selectedBlock.fullImage()),this.edge+this.typeInPadding,this.edge)}};InputSlotMorph.prototype.drawRectBorder=function(ctx){var shift=this.edge*.5,gradient;ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";if(useBlurredShadows){ctx.shadowOffsetY=shift;ctx.shadowBlur=this.edge;ctx.shadowColor=this.color.darker(80).toString()}gradient=ctx.createLinearGradient(0,0,0,this.edge);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(this.edge,shift);ctx.lineTo(this.width()-this.edge-shift,shift);ctx.stroke();ctx.shadowOffsetY=0;gradient=ctx.createLinearGradient(0,0,this.edge,0);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,this.edge);ctx.lineTo(shift,this.height()-this.edge-shift);ctx.stroke();ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.shadowBlur=0;gradient=ctx.createLinearGradient(0,this.height()-this.edge,0,this.height());gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(this.edge,this.height()-shift);ctx.lineTo(this.width()-this.edge,this.height()-shift);ctx.stroke();gradient=ctx.createLinearGradient(this.width()-this.edge,0,this.width(),0);gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(this.width()-shift,this.edge);ctx.lineTo(this.width()-shift,this.height()-this.edge);ctx.stroke()};InputSlotMorph.prototype.drawRoundBorder=function(ctx){var shift=this.edge*.5,r=Math.max((this.height()-this.edge*2)/2,0),start,end,gradient;ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";start=r+this.edge;end=this.width()-r-this.edge;if(end>start){if(useBlurredShadows){ctx.shadowOffsetX=shift;ctx.shadowOffsetY=shift;ctx.shadowBlur=this.edge;ctx.shadowColor=this.color.darker(80).toString()}gradient=ctx.createLinearGradient(0,0,0,this.edge);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(start,shift);ctx.lineTo(end,shift);ctx.stroke();ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.shadowBlur=0}gradient=ctx.createLinearGradient(0,this.height()-this.edge,0,this.height());gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r+this.edge,this.height()-shift);ctx.lineTo(this.width()-r-this.edge,this.height()-shift);ctx.stroke();r=Math.max(this.height()/2,this.edge);if(useBlurredShadows){ctx.shadowOffsetX=shift;ctx.shadowOffsetY=shift;ctx.shadowBlur=this.edge;ctx.shadowColor=this.color.darker(80).toString()}gradient=ctx.createRadialGradient(r,r,r-this.edge,r,r,r);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(r,r,r-shift,radians(180),radians(270),false);ctx.stroke();ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.shadowBlur=0;gradient=ctx.createRadialGradient(this.width()-r,r,r-this.edge,this.width()-r,r,r);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(this.width()-r,r,r-shift,radians(0),radians(90),false);ctx.stroke()};InputSlotStringMorph.prototype=new StringMorph;InputSlotStringMorph.prototype.constructor=InputSlotStringMorph;InputSlotStringMorph.uber=StringMorph.prototype;function InputSlotStringMorph(text,fontSize,fontStyle,bold,italic,isNumeric,shadowOffset,shadowColor,color,fontName){this.init(text,fontSize,fontStyle,bold,italic,isNumeric,shadowOffset,shadowColor,color,fontName)}InputSlotStringMorph.prototype.getRenderColor=function(){if(MorphicPreferences.isFlat){if(this.isEditable){return this.color}return this.parent.alpha>.5?this.color:BLACK}return this.parent.alpha>.25?this.color:WHITE};InputSlotStringMorph.prototype.getShadowRenderColor=function(){return this.parent.alpha>.25?this.shadowColor:CLEAR};InputSlotTextMorph.prototype=new TextMorph;InputSlotTextMorph.prototype.constructor=InputSlotTextMorph;InputSlotTextMorph.uber=StringMorph.prototype;function InputSlotTextMorph(text,fontSize,fontStyle,bold,italic,alignment,width,fontName,shadowOffset,shadowColor){this.init(text,fontSize,fontStyle,bold,italic,alignment,width,fontName,shadowOffset,shadowColor)}InputSlotTextMorph.prototype.getRenderColor=InputSlotStringMorph.prototype.getRenderColor;InputSlotTextMorph.prototype.getShadowRenderColor=InputSlotStringMorph.prototype.getShadowRenderColor;TemplateSlotMorph.prototype=new ArgMorph;TemplateSlotMorph.prototype.constructor=TemplateSlotMorph;TemplateSlotMorph.uber=ArgMorph.prototype;function TemplateSlotMorph(name){this.init(name)}TemplateSlotMorph.prototype.init=function(name){var template=new ReporterBlockMorph;this.labelString=name||"";template.isDraggable=false;template.isTemplate=true;if(modules.objects!==undefined){template.color=SpriteMorph.prototype.blockColor.variables;template.category="variables"}else{template.color=new Color(243,118,29);template.category=null}template.setSpec(this.labelString);template.selector="reportGetVar";TemplateSlotMorph.uber.init.call(this);this.add(template);this.fixLayout();this.isDraggable=false;this.isStatic=true};TemplateSlotMorph.prototype.getSpec=function(){return"%t"};TemplateSlotMorph.prototype.template=function(){return this.children[0]};TemplateSlotMorph.prototype.contents=function(){return this.template().blockSpec};TemplateSlotMorph.prototype.setContents=function(aString){var tmp=this.template();tmp.setSpec(aString instanceof Array?localize(aString[0]):aString);tmp.fixBlockColor();tmp.fixLabelColor()};TemplateSlotMorph.prototype.evaluate=function(){return this.contents()};TemplateSlotMorph.prototype.fixLayout=function(){var template=this.template();this.bounds.setExtent(template.extent().add(this.edge*2+2));template.setPosition(this.position().add(this.edge+1));if(this.parent){if(this.parent.fixLayout){this.parent.fixLayout()}}};TemplateSlotMorph.prototype.wantsDropOf=function(aMorph){return aMorph.selector==="reportGetVar"};TemplateSlotMorph.prototype.reactToDropOf=function(droppedMorph){if(droppedMorph.selector==="reportGetVar"){droppedMorph.destroy()}};TemplateSlotMorph.prototype.render=function(ctx){if(this.parent instanceof Morph){this.color=this.parent.color.copy()}BlockMorph.prototype.render.call(this,ctx)};TemplateSlotMorph.prototype.outlinePath=ReporterBlockMorph.prototype.outlinePathOval;TemplateSlotMorph.prototype.outlinePath=ReporterBlockMorph.prototype.outlinePathOval;TemplateSlotMorph.prototype.drawEdges=ReporterBlockMorph.prototype.drawEdgesOval;TemplateSlotMorph.prototype.hasLocationPin=function(){return false};TemplateSlotMorph.prototype.cSlots=function(){return[]};TemplateSlotMorph.prototype.flash=function(){this.template().flash()};TemplateSlotMorph.prototype.unflash=function(){this.template().unflash()};BooleanSlotMorph.prototype=new ArgMorph;BooleanSlotMorph.prototype.constructor=BooleanSlotMorph;BooleanSlotMorph.uber=ArgMorph.prototype;BooleanSlotMorph.prototype.isTernary=false;function BooleanSlotMorph(initialValue){this.init(initialValue)}BooleanSlotMorph.prototype.init=function(initialValue){this.value=typeof initialValue==="boolean"?initialValue:null;this.isUnevaluated=false;this.progress=0;BooleanSlotMorph.uber.init.call(this);this.alpha=1;this.fixLayout()};BooleanSlotMorph.prototype.getSpec=function(){return this.isUnevaluated?"%boolUE":"%b"};BooleanSlotMorph.prototype.evaluate=function(){return this.value};BooleanSlotMorph.prototype.isEmptySlot=function(){return this.value===null};BooleanSlotMorph.prototype.isBinary=function(){return!this.isTernary&&isNil(this.parentThatIsA(RingMorph))&&!isNil(this.parentThatIsA(ScriptsMorph))};BooleanSlotMorph.prototype.setContents=function(boolOrNull){this.value=typeof boolOrNull==="boolean"?boolOrNull:null;this.rerender()};BooleanSlotMorph.prototype.toggleValue=function(){var target=this.selectForEdit(),block=this.parentThatIsA(BlockMorph),ide;if(target!==this){return this.toggleValue.call(target)}ide=this.parentThatIsA(IDE_Morph);this.value=this.nextValue();if(ide){if(!block.isTemplate){ide.recordUnsavedChanges()}if(!ide.isAnimating){this.rerender();return}}this.progress=3;this.rerender();this.nextSteps([()=>{this.progress=2;this.rerender()},()=>{this.progress=1;this.rerender()},()=>{this.progress=0;this.rerender()}])};BooleanSlotMorph.prototype.nextValue=function(){if(this.isStatic||this.isBinary()){return!this.value}switch(this.value){case true:return false;case false:return null;default:return true}};BooleanSlotMorph.prototype.mouseClickLeft=function(){this.toggleValue();if(isNil(this.value)){return}this.reactToSliderEdit()};BooleanSlotMorph.prototype.mouseEnter=function(){if(this.isStatic){return}if(this.nextValue()===null){this.progress=-1}else{this.progress=1}this.rerender()};BooleanSlotMorph.prototype.mouseLeave=function(){if(this.isStatic){return}this.progress=0;this.rerender()};BooleanSlotMorph.prototype.slotMenu=function(){var menu;if(StageMorph.prototype.enableCodeMapping){menu=new MenuMorph(this);if(this.evaluate()===true){menu.addItem("code true mapping...","mapTrueToCode")}else{menu.addItem("code false mapping...","mapFalseToCode")}return menu}return null};BooleanSlotMorph.prototype.mapTrueToCode=function(){new DialogBoxMorph(this,code=>StageMorph.prototype.codeMappings["true"]=code,this).promptCode("Code mapping - true",StageMorph.prototype.codeMappings["true"]||"true",this.world())};BooleanSlotMorph.prototype.mapFalseToCode=function(){new DialogBoxMorph(this,code=>StageMorph.prototype.codeMappings["false"]=code,this).promptCode("Code mapping - false",StageMorph.prototype.codeMappings["false"]||"false",this.world())};BooleanSlotMorph.prototype.mappedCode=function(){if(this.evaluate()===true){return StageMorph.prototype.codeMappings.boolTrue||"true"}return StageMorph.prototype.codeMappings.boolFalse||"false"};BooleanSlotMorph.prototype.fixLayout=function(){var text,h;if(this.isStatic){text=this.textLabelExtent();h=text.y+this.edge*3;this.bounds.setWidth(text.x+h*1.5+this.edge*2);this.bounds.setHeight(h)}else{this.bounds.setWidth((this.fontSize+this.edge*2)*2);this.bounds.setHeight(this.fontSize+this.edge*2)}};BooleanSlotMorph.prototype.render=function(ctx){if(!this.cachedNormalColor){this.color=this.parent?this.parent.color:new Color(200,200,200)}this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.drawDiamond(ctx,this.progress);this.drawLabel(ctx);this.drawKnob(ctx,this.progress)};BooleanSlotMorph.prototype.drawDiamond=function(ctx,progress){var w=this.width(),h=this.height(),r=h/2,w2=w/2,shift=this.edge/2,gradient;if(this.cachedNormalColor){ctx.fillStyle=this.color.toString()}else if(progress<0){ctx.fillStyle=this.color.darker(25).toString()}else{switch(this.value){case true:ctx.fillStyle="rgb(0, 200, 0)";break;case false:ctx.fillStyle="rgb(200, 0, 0)";break;default:ctx.fillStyle=this.color.darker(25).toString()}}if(progress>0&&!this.isEmptySlot()){ctx.fillStyle="rgb(0, 200, 0)";ctx.beginPath();ctx.moveTo(0,r);ctx.lineTo(r,0);ctx.lineTo(w2,0);ctx.lineTo(w2,h);ctx.lineTo(r,h);ctx.closePath();ctx.fill();ctx.fillStyle="rgb(200, 0, 0)";ctx.beginPath();ctx.moveTo(w2,0);ctx.lineTo(w-r,0);ctx.lineTo(w,r);ctx.lineTo(w-r,h);ctx.lineTo(w2,h);ctx.closePath();ctx.fill()}else{ctx.beginPath();ctx.moveTo(0,r);ctx.lineTo(r,0);ctx.lineTo(w-r,0);ctx.lineTo(w,r);ctx.lineTo(w-r,h);ctx.lineTo(r,h);ctx.closePath();ctx.fill()}if(MorphicPreferences.isFlat){return}ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";if(useBlurredShadows){ctx.shadowOffsetX=shift;ctx.shadowBlur=shift;ctx.shadowColor="black"}gradient=ctx.createLinearGradient(0,r,this.edge*.6,r+this.edge*.6);gradient.addColorStop(1,this.cachedClrDark);gradient.addColorStop(0,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,r);ctx.lineTo(r,shift);ctx.closePath();ctx.stroke();if(useBlurredShadows){ctx.shadowOffsetX=0;ctx.shadowOffsetY=shift;ctx.shadowBlur=this.edge}gradient=ctx.createLinearGradient(0,0,0,this.edge);gradient.addColorStop(1,this.cachedClrDark);gradient.addColorStop(0,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r,shift);ctx.lineTo(w-r,shift);ctx.closePath();ctx.stroke();ctx.shadowOffsetY=0;ctx.shadowBlur=0;gradient=ctx.createLinearGradient(w-r-this.edge*.6,h-this.edge*.6,w-r,h);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(w-r,h-shift);ctx.lineTo(w-shift,r);ctx.closePath();ctx.stroke();gradient=ctx.createLinearGradient(0,h-this.edge,0,h);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r,h-shift);ctx.lineTo(w-r-shift,h-shift);ctx.closePath();ctx.stroke()};BooleanSlotMorph.prototype.drawLabel=function(ctx){var w=this.width(),r=this.height()/2-this.edge,r2=r/2,shift=this.edge/2,text,x,y=this.height()/2;if(this.isEmptySlot()||this.progress<0){return}if(this.isStatic){text=this.textLabelExtent();y=this.height()-(this.height()-text.y)/2;if(this.value){x=this.height()/2}else{x=this.width()-this.height()/2-text.x}ctx.save();if(!MorphicPreferences.isFlat&&useBlurredShadows){ctx.shadowOffsetX=-shift;ctx.shadowOffsetY=-shift;ctx.shadowBlur=shift;ctx.shadowColor=this.value?"rgb(0, 100, 0)":"rgb(100, 0, 0)"}ctx.font=new StringMorph(null,this.fontSize,null,true).font();ctx.textAlign="left";ctx.textBaseline="bottom";ctx.fillStyle="rgb(255, 255, 255";ctx.fillText(localize(this.value?"true":"false"),x,y);ctx.restore();return}x=r+this.edge*2+shift;if(!MorphicPreferences.isFlat&&useBlurredShadows){ctx.shadowOffsetX=-shift;ctx.shadowOffsetY=-shift;ctx.shadowBlur=shift;ctx.shadowColor="rgb(0, 100, 0)"}ctx.strokeStyle="white";ctx.lineWidth=this.edge+shift;ctx.lineCap="round";ctx.lineJoin="miter";ctx.beginPath();ctx.moveTo(x-r2,y);ctx.lineTo(x,y+r2);ctx.lineTo(x+r2,r2+this.edge);ctx.stroke();x=w-y-this.edge*2;if(!MorphicPreferences.isFlat&&useBlurredShadows){ctx.shadowOffsetX=-shift;ctx.shadowOffsetY=-shift;ctx.shadowBlur=shift;ctx.shadowColor="rgb(100, 0, 0)"}ctx.strokeStyle="white";ctx.lineWidth=this.edge;ctx.lineCap="butt";ctx.beginPath();ctx.moveTo(x-r2,y-r2);ctx.lineTo(x+r2,y+r2);ctx.moveTo(x-r2,y+r2);ctx.lineTo(x+r2,y-r2);ctx.stroke()};BooleanSlotMorph.prototype.drawKnob=function(ctx,progress){var w=this.width(),r=this.height()/2,shift=this.edge/2,slideStep=(this.width()-this.height())/4*Math.max(0,progress||0),gradient,x,y=r,outline=PushButtonMorph.prototype.outline/2,outlineColor=PushButtonMorph.prototype.outlineColor,color=PushButtonMorph.prototype.color,contrast=PushButtonMorph.prototype.contrast,topColor=color.lighter(contrast),bottomColor=color.darker(contrast);switch(this.value){case false:x=r+slideStep;if(!MorphicPreferences.isFlat&&useBlurredShadows){ctx.shadowOffsetX=shift;ctx.shadowOffsetY=0;ctx.shadowBlur=shift;ctx.shadowColor="black"}if(progress<0){ctx.globalAlpha=.6}break;case true:x=w-r-slideStep;if(!MorphicPreferences.isFlat){ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.shadowBlur=0}break;default:if(!progress){return}x=r;if(!MorphicPreferences.isFlat&&useBlurredShadows){ctx.shadowOffsetX=shift;ctx.shadowOffsetY=0;ctx.shadowBlur=shift;ctx.shadowColor="black"}ctx.globalAlpha=.6}ctx.fillStyle=color.toString();ctx.beginPath();ctx.arc(x,y,r,radians(0),radians(360));ctx.closePath();ctx.fill();if(MorphicPreferences.isFlat){ctx.globalAlpha=1;return}ctx.shadowOffsetX=0;ctx.shadowBlur=0;ctx.shadowColor="black";ctx.lineWidth=outline;ctx.strokeStyle=outlineColor.toString();ctx.beginPath();ctx.arc(x,y,r-outline/2,radians(0),radians(360));ctx.stroke();if(r<outline+this.edge){return}gradient=ctx.createRadialGradient(x,y,r-outline-this.edge,x,y,r-outline);gradient.addColorStop(1,topColor.toString());gradient.addColorStop(0,color.toString());ctx.strokeStyle=gradient;ctx.lineCap="round";ctx.lineWidth=this.edge;ctx.beginPath();ctx.arc(x,y,r-outline-this.edge/2,radians(180),radians(270),false);ctx.stroke();gradient=ctx.createRadialGradient(x,y,r-outline-this.edge,x,y,r-outline);gradient.addColorStop(1,bottomColor.toString());gradient.addColorStop(0,color.toString());ctx.strokeStyle=gradient;ctx.lineCap="round";ctx.lineWidth=this.edge;ctx.beginPath();ctx.arc(x,y,r-outline-this.edge/2,radians(0),radians(90),false);ctx.stroke();ctx.globalAlpha=1};BooleanSlotMorph.prototype.textLabelExtent=function(){var t,f;t=new StringMorph(localize("true"),this.fontSize,null,true);f=new StringMorph(localize("false"),this.fontSize,null,true);return new Point(Math.max(t.width(),f.width()),t.height())};ArrowMorph.prototype=new Morph;ArrowMorph.prototype.constructor=ArrowMorph;ArrowMorph.uber=Morph.prototype;function ArrowMorph(direction,size,padding,color,isBlockLabel){this.init(direction,size,padding,color,isBlockLabel)}ArrowMorph.prototype.init=function(direction,size,padding,color,isLbl){this.direction=direction||"down";this.size=size||(size===0?0:50);this.padding=padding||0;this.isBlockLabel=isLbl||false;ArrowMorph.uber.init.call(this);this.color=color||BLACK;this.bounds.setWidth(this.size);this.bounds.setHeight(this.size);this.rerender()};ArrowMorph.prototype.setSize=function(size){var min=Math.max(size,1);this.size=size;this.changed();this.bounds.setWidth(min);this.bounds.setHeight(min);this.rerender()};ArrowMorph.prototype.render=function(ctx){var pad=this.padding,h=this.height(),h2=Math.floor(h/2),w=this.width(),w2=Math.floor(w/2);ctx.fillStyle=this.getRenderColor().toString();ctx.beginPath();if(this.direction==="down"){ctx.moveTo(pad,h2);ctx.lineTo(w-pad,h2);ctx.lineTo(w2,h-pad)}else if(this.direction==="up"){ctx.moveTo(pad,h2);ctx.lineTo(w-pad,h2);ctx.lineTo(w2,pad)}else if(this.direction==="left"){ctx.moveTo(pad,h2);ctx.lineTo(w2,pad);ctx.lineTo(w2,h-pad)}else{ctx.moveTo(w2,pad);ctx.lineTo(w-pad,h2);ctx.lineTo(w2,h-pad)}ctx.closePath();ctx.fill()};ArrowMorph.prototype.getRenderColor=function(){if(this.isBlockLabel){if(MorphicPreferences.isFlat){return this.color}return SyntaxElementMorph.prototype.alpha>.5?this.color:WHITE}return this.color};TextSlotMorph.prototype=new InputSlotMorph;TextSlotMorph.prototype.constructor=TextSlotMorph;TextSlotMorph.uber=InputSlotMorph.prototype;function TextSlotMorph(text,isNumeric,choiceDict,isReadOnly){this.init(text,isNumeric,choiceDict,isReadOnly)}TextSlotMorph.prototype.init=function(text,isNumeric,choiceDict,isReadOnly){var contents=new InputSlotTextMorph(""),arrow=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1),BLACK,true);contents.fontSize=this.fontSize;contents.fixLayout();this.isUnevaluated=false;this.choices=choiceDict||null;this.oldContentsExtent=contents.extent();this.isNumeric=isNumeric||false;this.isReadOnly=isReadOnly||false;this.minWidth=0;this.constant=null;InputSlotMorph.uber.init.call(this,null,null,null,null,true);this.color=WHITE;this.add(contents);this.add(arrow);contents.isEditable=true;contents.isDraggable=false;contents.enableSelecting();this.setContents(text)};TextSlotMorph.prototype.getSpec=function(){if(this.isNumeric){return"%mlt"}return"%mlt"};TextSlotMorph.prototype.contents=function(){return detect(this.children,child=>child instanceof TextMorph)};TextSlotMorph.prototype.layoutChanged=function(){this.fixLayout()};ColorSlotMorph.prototype=new ArgMorph;ColorSlotMorph.prototype.constructor=ColorSlotMorph;ColorSlotMorph.uber=ArgMorph.prototype;function ColorSlotMorph(clr){this.init(clr)}ColorSlotMorph.prototype.init=function(clr){ColorSlotMorph.uber.init.call(this);this.alpha=1;this.setColor(clr||new Color(145,26,68))};ColorSlotMorph.prototype.getSpec=function(){return"%clr"};ColorSlotMorph.prototype.getUserColor=function(){var myself=this,world=this.world(),hand=world.hand,posInDocument=getDocumentPositionOf(world.worldCanvas),mouseMoveBak=hand.processMouseMove,mouseDownBak=hand.processMouseDown,mouseUpBak=hand.processMouseUp,pal=new ColorPaletteMorph(null,new Point(this.fontSize*16,this.fontSize*10));world.add(pal);pal.setPosition(this.bottomLeft().add(new Point(0,this.edge)));hand.processMouseMove=function(event){var clr=world.getGlobalPixelColor(hand.position());hand.setPosition(new Point(event.pageX-posInDocument.x,event.pageY-posInDocument.y));if(!clr.a){return}myself.setColor(clr)};hand.processMouseDown=nop;hand.processMouseUp=function(){pal.destroy();hand.processMouseMove=mouseMoveBak;hand.processMouseDown=mouseDownBak;hand.processMouseUp=mouseUpBak}};ColorSlotMorph.prototype.mouseClickLeft=function(){this.selectForEdit().getUserColor()};ColorSlotMorph.prototype.evaluate=function(){return this.color};ColorSlotMorph.prototype.fixLayout=function(){var side=this.fontSize+this.edge*2+this.typeInPadding*2;this.bounds.setWidth(side);this.bounds.setHeight(side)};ColorSlotMorph.prototype.render=function(ctx){var borderColor;if(this.parent){borderColor=this.parent.color}else{borderColor=new Color(120,120,120)}ctx.fillStyle=this.color.toString();this.cachedClr=borderColor.toString();this.cachedClrBright=borderColor.lighter(this.contrast).toString();this.cachedClrDark=borderColor.darker(this.contrast).toString();ctx.fillRect(this.edge,this.edge,this.width()-this.edge*2,this.height()-this.edge*2);if(!MorphicPreferences.isFlat){this.drawRectBorder(ctx)}};ColorSlotMorph.prototype.drawRectBorder=InputSlotMorph.prototype.drawRectBorder;BlockHighlightMorph.prototype=new Morph;BlockHighlightMorph.prototype.constructor=BlockHighlightMorph;BlockHighlightMorph.uber=Morph.prototype;function BlockHighlightMorph(){this.threadCount=0;this.init()}BlockHighlightMorph.prototype.init=function(){BlockHighlightMorph.uber.init.call(this);this.isCachingImage=true};BlockHighlightMorph.prototype.readout=function(){return this.children.length?this.children[0]:null};BlockHighlightMorph.prototype.updateReadout=function(){var readout=this.readout(),inset=useBlurredShadows&&!MorphicPreferences.isFlat?SyntaxElementMorph.prototype.activeBlur*.4:SyntaxElementMorph.prototype.activeBorder*-2;if(this.threadCount<2){if(readout){readout.destroy()}return}if(readout){readout.changed();readout.contents=this.threadCount.toString();readout.fixLayout();readout.rerender()}else{readout=new SpeechBubbleMorph(this.threadCount.toString(),this.color,null,null,this.color.darker(),null,1,true);this.add(readout)}readout.setPosition(this.position().add(inset))};MultiArgMorph.prototype=new ArgMorph;MultiArgMorph.prototype.constructor=MultiArgMorph;MultiArgMorph.uber=ArgMorph.prototype;function MultiArgMorph(slotSpec,labelTxt,min,eSpec,arrowColor,labelColor,shadowColor,shadowOffset,isTransparent,infix,collapse){this.init(slotSpec,labelTxt,min,eSpec,arrowColor,labelColor,shadowColor,shadowOffset,isTransparent,infix,collapse)}MultiArgMorph.prototype.init=function(slotSpec,labelTxt,min,eSpec,arrowColor,labelColor,shadowColor,shadowOffset,isTransparent,infix,collapse){var label,arrows=new FrameMorph,leftArrow,rightArrow,i;this.slotSpec=slotSpec||"%s";this.labelText=labelTxt instanceof Array?labelTxt.map(each=>localize(each||"")):localize(labelTxt||"");this.infix=infix||"";this.collapse=collapse||"";this.minInputs=min||0;this.maxInputs=null;this.elementSpec=eSpec||null;this.labelColor=labelColor||null;this.shadowColor=shadowColor||null;this.shadowOffset=shadowOffset||null;this.canBeEmpty=true;MultiArgMorph.uber.init.call(this);this.alpha=isTransparent===false?1:0;arrows.alpha=isTransparent===false?1:0;if(this.labelText||this.slotSpec==="%cs"){label=this.labelPart(this.labelText instanceof Array?this.labelText[0]:this.labelText);this.add(label);label.hide()}leftArrow=new ArrowMorph("left",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),arrowColor,true);rightArrow=new ArrowMorph("right",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),arrowColor,true);arrows.add(leftArrow);arrows.add(rightArrow);arrows.rerender();arrows.acceptsDrops=false;this.add(arrows);for(i=0;i<this.minInputs;i+=1){this.addInput()}};MultiArgMorph.prototype.label=function(){return this.labelText?this.children[0]:null};MultiArgMorph.prototype.allLabels=function(){return this.children.filter(m=>m instanceof BlockLabelMorph)};MultiArgMorph.prototype.arrows=function(){return this.children[this.children.length-1]};MultiArgMorph.prototype.getSpec=function(){return"%mult"+this.slotSpec};MultiArgMorph.prototype.setContents=function(anArray){var inputs=this.inputs(),i;if(!(anArray instanceof Array)&&this.slotSpec==="%rcv"){anArray=[anArray]}for(i=0;i<anArray.length;i+=1){if(anArray[i]!==null&&inputs[i]){inputs[i].setContents(anArray[i])}}};MultiArgMorph.prototype.hide=function(){this.isVisible=false;this.changed()};MultiArgMorph.prototype.show=function(){this.isVisible=true;this.changed()};MultiArgMorph.prototype.setLabelColor=function(textColor,shadowColor,shadowOffset){this.textColor=textColor;this.shadowColor=shadowColor;this.shadowOffset=shadowOffset;MultiArgMorph.uber.setLabelColor.call(this,textColor,shadowColor,shadowOffset)};MultiArgMorph.prototype.fixLayout=function(){var labels,shadowColor,shadowOffset;if(this.slotSpec==="%t"){this.isStatic=true}if(this.parent){labels=this.allLabels();this.color=this.parent.color;this.arrows().color=this.color;if(labels.length){shadowColor=this.shadowColor||this.parent.color.darker(this.labelContrast);labels.forEach(label=>{shadowOffset=this.shadowOffset||(label?label.shadowOffset:null);if(!label.shadowColor.eq(shadowColor)){label.shadowColor=shadowColor;label.shadowOffset=shadowOffset;label.fixLayout();label.rerender()}})}}this.fixArrowsLayout();MultiArgMorph.uber.fixLayout.call(this);if(this.parent){this.parent.fixLayout()}};MultiArgMorph.prototype.fixArrowsLayout=function(){var label=this.label(),arrows=this.arrows(),leftArrow=arrows.children[0],rightArrow=arrows.children[1],inpCount=this.inputs().length,dim=new Point(rightArrow.width()/2,rightArrow.height());leftArrow.show();rightArrow.show();if(inpCount<this.minInputs+1){if(label){label.hide()}leftArrow.hide();rightArrow.setPosition(arrows.position().subtract(new Point(dim.x,0)));arrows.setExtent(dim)}else if(this.is3ArgRingInHOF()&&inpCount>2){rightArrow.hide();arrows.setExtent(dim)}else{if(label){label.show()}leftArrow.show();rightArrow.show();rightArrow.setPosition(leftArrow.topCenter());arrows.bounds.corner=rightArrow.bottomRight().copy();if(!isNil(this.maxInputs)&&inpCount>this.maxInputs-1){rightArrow.hide();arrows.setExtent(dim)}}arrows.rerender()};MultiArgMorph.prototype.fixHolesLayout=function(){var pos;this.holes=[];if(this.slotSpec==="%cs"){pos=this.position();this.inputs().forEach(slot=>{if(slot instanceof CSlotMorph){slot.fixHolesLayout();this.holes.push(slot.holes[0].translateBy(slot.position().subtract(pos)))}})}};MultiArgMorph.prototype.refresh=function(){this.inputs().forEach(input=>{input.fixLayout();input.rerender()})};MultiArgMorph.prototype.deleteSlot=function(anInput){var len=this.inputs().length,idx=this.children.indexOf(anInput);if(len<=this.minInputs){return}if(this.infix!==""){if(idx===this.children.length-2){this.removeChild(this.children[idx-1])}else{this.removeChild(this.children[idx+1])}}this.removeChild(anInput);this.fixLayout()};MultiArgMorph.prototype.insertNewInputBefore=function(anInput,contents){var idx=this.children.indexOf(anInput),newPart=this.labelPart(this.slotSpec),infix;if(this.maxInputs&&this.inputs().length>=this.maxInputs){return}if(contents){newPart.setContents(contents)}newPart.parent=this;if(this.infix!==""){infix=this.labelPart(this.infix);infix.parent=this;this.children.splice(idx,0,newPart,infix)}else{this.children.splice(idx,0,newPart)}newPart.fixLayout();if(this.parent instanceof BlockMorph){this.parent.fixLabelColor()}this.fixLayout();return newPart};MultiArgMorph.prototype.addInput=function(contents){var newPart=this.labelPart(this.slotSpecFor(this.inputs().length)),i,name,idx;this.addInfix();idx=this.children.length-1;if(contents){newPart.setContents(contents)}else if(this.elementSpec==="%scriptVars"||this.elementSpec==="%blockVars"){name="";i=idx;if(this.elementSpec==="%scriptVars"){i+=1}while(i>0){name=String.fromCharCode(97+(i-1)%26)+name;i=Math.floor((i-1)/26)}newPart.setContents(name)}else if(contains(["%parms","%ringparms"],this.elementSpec)){if(this.is3ArgRingInHOF()&&idx<4){newPart.setContents([localize("value"),localize("index"),localize("list")][idx-1])}else{newPart.setContents("#"+idx)}}else if(this.elementSpec==="%message"){newPart.setContents(localize("data"))}else if(this.elementSpec==="%keyName"){newPart.setContents(localize("key"))}newPart.parent=this;this.children.splice(idx,0,newPart);newPart.fixLayout();if(this.parent instanceof BlockMorph){this.parent.fixLabelColor()}this.fixLayout();return newPart};MultiArgMorph.prototype.addInfix=function(){var infix,label=this.infix?this.infix:this.labelText instanceof Array?this.labelText[this.inputs().length]:"";if(label===""||!this.inputs().length){return}infix=this.labelPart(label);infix.parent=this;this.children.splice(this.children.length-1,0,infix)};MultiArgMorph.prototype.removeInput=function(){var len=this.inputs().length,oldPart,scripts;if(len>0){oldPart=this.inputs()[len-1];this.removeChild(oldPart);if(oldPart instanceof BlockMorph&&!(oldPart instanceof RingMorph&&!oldPart.contents())){scripts=this.parentThatIsA(ScriptsMorph);if(scripts){scripts.add(oldPart)}}}if(this.infix!==""||this.labelText instanceof Array&&this.inputs().length){if(this.children.length>1){this.removeChild(this.children[this.children.length-2])}}this.fixLayout()};MultiArgMorph.prototype.collapseAll=function(){var len=this.inputs().length,i;for(i=0;i<len;i+=1){this.removeInput()}};MultiArgMorph.prototype.isVertical=function(){return contains(["%repRing","%predRing","%cmdRing"],this.slotSpec)};MultiArgMorph.prototype.is3ArgRingInHOF=function(){var ring=this.parent,block;if(ring){block=ring.parent;if(block instanceof ReporterBlockMorph){return block.inputs()[0]===ring&&contains(["reportMap","reportAtomicMap","reportKeep","reportAtomicKeep","reportFindFirst","reportAtomicFindFirst"],block.selector)}}return false};MultiArgMorph.prototype.slotSpecFor=function(index){return this.slotSpec instanceof Array?this.slotSpec[index]:this.slotSpec};MultiArgMorph.prototype.mouseClickLeft=function(pos){var ide=this.parentThatIsA(IDE_Morph);if(!this.parentThatIsA(ScriptsMorph)){this.escalateEvent("mouseClickLeft",pos);return}var target=this.selectForEdit(),arrows=target.arrows(),leftArrow=arrows.children[0],rightArrow=arrows.children[1],repetition=target.world().currentKey===16?3:1,i;if(rightArrow.bounds.containsPoint(pos)){for(i=0;i<repetition;i+=1){if(rightArrow.isVisible){target.addInput()}}if(ide){ide.recordUnsavedChanges()}}else if(leftArrow.bounds.expandBy(this.fontSize/3).containsPoint(pos)){for(i=0;i<repetition;i+=1){if(leftArrow.isVisible){target.removeInput()}}if(ide){ide.recordUnsavedChanges()}}else{target.escalateEvent("mouseClickLeft",pos)}};MultiArgMorph.prototype.userMenu=function(){var menu=new MenuMorph(this),block=this.parentThatIsA(BlockMorph),key="";if(!StageMorph.prototype.enableCodeMapping){return this.parent.userMenu()}if(block){if(block instanceof RingMorph){key="parms_"}else if(block.selector==="doDeclareVariables"){key="tempvars_"}}menu.addItem("code list mapping...",()=>this.mapCodeList(key));menu.addItem("code item mapping...",()=>this.mapCodeItem(key));menu.addItem("code delimiter mapping...",()=>this.mapCodeDelimiter(key));return menu};MultiArgMorph.prototype.mapCodeDelimiter=function(key){this.mapToCode(key+"delim","list item delimiter")};MultiArgMorph.prototype.mapCodeList=function(key){this.mapToCode(key+"list","list contents <#1>")};MultiArgMorph.prototype.mapCodeItem=function(key){this.mapToCode(key+"item","list item <#1>")};MultiArgMorph.prototype.mapToCode=function(key,label){new DialogBoxMorph(this,code=>StageMorph.prototype.codeMappings[key]=code,this).promptCode("Code mapping - "+label,StageMorph.prototype.codeMappings[key]||"",this.world())};MultiArgMorph.prototype.mappedCode=function(definitions){var block=this.parentThatIsA(BlockMorph),key="",code,items="",itemCode,delim,count=0,parts=[];if(block){if(block instanceof RingMorph){key="parms_"}else if(block.selector==="doDeclareVariables"){key="tempvars_"}}code=StageMorph.prototype.codeMappings[key+"list"]||"<#1>";itemCode=StageMorph.prototype.codeMappings[key+"item"]||"<#1>";delim=StageMorph.prototype.codeMappings[key+"delim"]||" ";this.inputs().forEach(input=>parts.push(itemCode.replace(/<#1>/g,input.mappedCode(definitions))));parts.forEach(part=>{if(count){items+=delim}items+=part;count+=1});code=code.replace(/<#1>/g,items);return code};MultiArgMorph.prototype.evaluate=function(){var result=[];this.inputs().forEach(slot=>result.push(slot.evaluate()));return result};MultiArgMorph.prototype.isEmptySlot=function(){return this.canBeEmpty?this.inputs().length===0:false};ArgLabelMorph.prototype=new ArgMorph;ArgLabelMorph.prototype.constructor=ArgLabelMorph;ArgLabelMorph.uber=ArgMorph.prototype;function ArgLabelMorph(argMorph,labelTxt){this.init(argMorph,labelTxt)}ArgLabelMorph.prototype.init=function(argMorph,labelTxt){var label;this.labelText=localize(labelTxt||"input list:");ArgLabelMorph.uber.init.call(this);this.isStatic=true;this.alpha=0;label=this.labelPart(this.labelText);this.add(label);this.add(argMorph)};ArgLabelMorph.prototype.label=function(){return this.children[0]};ArgLabelMorph.prototype.argMorph=function(){return this.children[1]};ArgLabelMorph.prototype.fixLayout=function(){var label=this.label(),shadowColor,shadowOffset;if(this.parent){this.color=this.parent.color;shadowOffset=label.shadowOffset||ZERO;if(shadowOffset.x<0){shadowColor=this.parent.color.darker(this.labelContrast)}else{shadowColor=this.parent.color.lighter(this.labelContrast)}if(this.labelText!==""){if(!label.shadowColor.eq(shadowColor)){label.shadowColor=shadowColor;label.shadowOffset=shadowOffset;label.rerender()}}}ArgLabelMorph.uber.fixLayout.call(this);if(this.parent){this.parent.fixLayout()}};ArgLabelMorph.prototype.refresh=function(){this.inputs().forEach(input=>{input.fixLayout();input.rerender()})};ArgLabelMorph.prototype.setLabelColor=function(textColor,shadowColor,shadowOffset){if(this.labelText!==""){var label=this.label();label.color=textColor;label.shadowColor=shadowColor;label.shadowOffset=shadowOffset;label.rerender()}};ArgLabelMorph.prototype.reactToGrabOf=function(){if(this.parent instanceof SyntaxElementMorph){this.parent.revertToDefaultInput(this)}};ArgLabelMorph.prototype.evaluate=function(){return this.argMorph().evaluate()};ArgLabelMorph.prototype.isEmptySlot=function(){return false};FunctionSlotMorph.prototype=new ArgMorph;FunctionSlotMorph.prototype.constructor=FunctionSlotMorph;FunctionSlotMorph.uber=ArgMorph.prototype;function FunctionSlotMorph(isPredicate){this.init(isPredicate)}FunctionSlotMorph.prototype.init=function(isPredicate){FunctionSlotMorph.uber.init.call(this);this.isPredicate=isPredicate||false;this.color=this.rfColor};FunctionSlotMorph.prototype.getSpec=function(){return"%f"};FunctionSlotMorph.prototype.render=function(ctx){var borderColor;if(this.parent){borderColor=this.parent.color}else{borderColor=new Color(120,120,120)}this.cachedClr=borderColor.toString();this.cachedClrBright=borderColor.lighter(this.contrast).toString();this.cachedClrDark=borderColor.darker(this.contrast).toString();if(this.isPredicate){this.drawDiamond(ctx)}else{this.drawRounded(ctx)}};FunctionSlotMorph.prototype.drawRounded=function(ctx){var h=this.height(),r=Math.min(this.rounding,h/2),w=this.width(),shift=this.edge/2,gradient;ctx.fillStyle=this.color.toString();ctx.beginPath();ctx.arc(r,r,r,radians(-180),radians(-90),false);ctx.arc(w-r,r,r,radians(-90),radians(-0),false);ctx.arc(w-r,h-r,r,radians(0),radians(90),false);ctx.arc(r,h-r,r,radians(90),radians(180),false);ctx.closePath();ctx.fill();if(MorphicPreferences.isFlat){return}ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=this.cachedClr;ctx.beginPath();ctx.arc(r,h-r,r-shift,radians(90),radians(180),false);ctx.stroke();ctx.strokeStyle=this.cachedClr;ctx.beginPath();ctx.arc(w-r,r,r-shift,radians(-90),radians(0),false);ctx.stroke();if(useBlurredShadows){ctx.shadowOffsetX=shift;ctx.shadowOffsetY=shift;ctx.shadowBlur=this.edge;ctx.shadowColor=this.color.darker(80).toString()}gradient=ctx.createLinearGradient(0,0,0,this.edge);gradient.addColorStop(1,this.cachedClrDark);gradient.addColorStop(0,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r-shift,shift);ctx.lineTo(w-r+shift,shift);ctx.stroke();gradient=ctx.createRadialGradient(r,r,r-this.edge,r,r,r);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(r,r,r-shift,radians(180),radians(270),false);ctx.stroke();gradient=ctx.createLinearGradient(0,0,this.edge,0);gradient.addColorStop(1,this.cachedClrDark);gradient.addColorStop(0,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,r);ctx.lineTo(shift,h-r);ctx.stroke();ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.shadowBlur=0;gradient=ctx.createRadialGradient(w-r,h-r,r-this.edge,w-r,h-r,r);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(w-r,h-r,r-shift,radians(0),radians(90),false);ctx.stroke();gradient=ctx.createLinearGradient(0,h-this.edge,0,h);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r-shift,h-shift);ctx.lineTo(w-r+shift,h-shift);ctx.stroke();gradient=ctx.createLinearGradient(w-this.edge,0,w,0);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(w-shift,r+shift);ctx.lineTo(w-shift,h-r);ctx.stroke()};FunctionSlotMorph.prototype.drawDiamond=function(ctx){var w=this.width(),h=this.height(),h2=Math.floor(h/2),r=Math.min(this.rounding,h2),shift=this.edge/2,gradient;ctx.fillStyle=this.color.toString();ctx.beginPath();ctx.moveTo(0,h2);ctx.lineTo(r,0);ctx.lineTo(w-r,0);ctx.lineTo(w,h2);ctx.lineTo(w-r,h);ctx.lineTo(r,h);ctx.closePath();ctx.fill();if(MorphicPreferences.isFlat){return}ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=this.cachedClr;ctx.beginPath();ctx.moveTo(shift,h2);ctx.lineTo(r,h-shift);ctx.stroke();ctx.strokeStyle=this.cachedClr;ctx.beginPath();ctx.moveTo(w-shift,h2);ctx.lineTo(w-r,shift);ctx.stroke();if(useBlurredShadows){ctx.shadowOffsetX=shift;ctx.shadowOffsetY=shift;ctx.shadowBlur=this.edge;ctx.shadowColor=this.color.darker(80).toString()}gradient=ctx.createLinearGradient(0,0,r,0);gradient.addColorStop(1,this.cachedClrDark);gradient.addColorStop(0,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,h2);ctx.lineTo(r,shift);ctx.stroke();gradient=ctx.createLinearGradient(0,0,0,this.edge);gradient.addColorStop(1,this.cachedClrDark);gradient.addColorStop(0,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r,shift);ctx.lineTo(w-r,shift);ctx.stroke();ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.shadowBlur=0;gradient=ctx.createLinearGradient(w-r,0,w,0);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(w-r,h-shift);ctx.lineTo(w-shift,h2);ctx.stroke();gradient=ctx.createLinearGradient(0,h-this.edge,0,h);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r+shift,h-shift);ctx.lineTo(w-r-shift,h-shift);ctx.stroke()};ReporterSlotMorph.prototype=new FunctionSlotMorph;ReporterSlotMorph.prototype.constructor=ReporterSlotMorph;ReporterSlotMorph.uber=FunctionSlotMorph.prototype;function ReporterSlotMorph(isPredicate){this.init(isPredicate)}ReporterSlotMorph.prototype.init=function(isPredicate){ReporterSlotMorph.uber.init.call(this,isPredicate,true);this.add(this.emptySlot());this.fixLayout()};ReporterSlotMorph.prototype.emptySlot=function(){var empty=new ArgMorph,shrink=this.rfBorder*2+this.edge*2;empty.color=this.rfColor;empty.alpha=0;empty.bounds.setExtent(new Point((this.fontSize+this.edge*2)*2-shrink,this.fontSize+this.edge*2-shrink));return empty};ReporterSlotMorph.prototype.getSpec=function(){return"%r"};ReporterSlotMorph.prototype.contents=function(){return this.children[0]};ReporterSlotMorph.prototype.nestedBlock=function(){var contents=this.contents();return contents instanceof ReporterBlockMorph?contents:null};ReporterSlotMorph.prototype.evaluate=function(){return this.nestedBlock()};ReporterSlotMorph.prototype.isEmptySlot=function(){return this.nestedBlock()===null};ReporterSlotMorph.prototype.fixLayout=function(){var contents=this.contents();if(!contents){contents=this.emptySlot();this.add(contents)}this.bounds.setExtent(contents.extent().add(this.edge*2+this.rfBorder*2));contents.setCenter(this.center());if(this.parent){if(this.parent.fixLayout){this.parent.fixLayout()}}};RingReporterSlotMorph.prototype=new ReporterSlotMorph;RingReporterSlotMorph.prototype.constructor=RingReporterSlotMorph;RingReporterSlotMorph.uber=ReporterSlotMorph.prototype;RingReporterSlotMorph.prototype.rfBorder=RingCommandSlotMorph.prototype.rfBorder;RingReporterSlotMorph.prototype.edge=RingCommandSlotMorph.prototype.edge;RingReporterSlotMorph.prototype.enableCommandDrops=true;function RingReporterSlotMorph(isPredicate){this.init(isPredicate)}RingReporterSlotMorph.prototype.init=function(isPredicate){RingReporterSlotMorph.uber.init.call(this,isPredicate,true);this.contrast=RingMorph.prototype.contrast};RingReporterSlotMorph.prototype.getSpec=function(){return"%rr"};RingReporterSlotMorph.prototype.replaceInput=function(source,target,noVanish){RingReporterSlotMorph.uber.replaceInput.call(this,source,target);if(this.parent instanceof RingMorph&&!noVanish){this.parent.vanishForSimilar()}};RingReporterSlotMorph.prototype.slotAttachPoint=CommandSlotMorph.prototype.slotAttachPoint;RingReporterSlotMorph.prototype.dentLeft=CommandSlotMorph.prototype.dentLeft;RingReporterSlotMorph.prototype.dentCenter=CommandSlotMorph.prototype.dentCenter;RingReporterSlotMorph.prototype.attachTargets=function(){if(!RingReporterSlotMorph.prototype.enableCommandDrops||this.contents()instanceof ReporterBlockMorph){return[]}return CommandSlotMorph.prototype.attachTargets.call(this)};RingReporterSlotMorph.prototype.nestedBlock=function(block){if(block){var nb=this.nestedBlock();this.replaceInput(this.children[0],block);if(nb){block.bottomBlock().nextBlock(nb)}this.fixLayout()}else{return detect(this.children,child=>child instanceof BlockMorph)}};RingReporterSlotMorph.prototype.fixLayout=function(){if(this.contents()instanceof CommandBlockMorph){CommandSlotMorph.prototype.fixLayout.call(this)}else{RingReporterSlotMorph.uber.fixLayout.call(this)}};RingReporterSlotMorph.prototype.render=function(ctx){if(MorphicPreferences.isFlat){return}this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();ctx.fillStyle=this.cachedClr;if(this.isPredicate){this.drawEdgesDiamond(ctx)}else{this.drawEdgesOval(ctx)}};RingReporterSlotMorph.prototype.outlinePath=function(ctx,offset){if(this.isPredicate){this.outlinePathDiamond(ctx,offset)}else{this.outlinePathOval(ctx,offset)}};RingReporterSlotMorph.prototype.outlinePathOval=function(ctx,offset){var ox=offset.x,oy=offset.y,w=this.width(),h=this.height(),r=Math.min(this.rounding,h/2);ctx.arc(r+this.edge+ox,r+this.edge+oy,r,radians(-180),radians(-90),false);ctx.arc(w-r-this.edge+ox,r+this.edge+oy,r,radians(-90),radians(-0),false);ctx.arc(w-r-this.edge+ox,h-r-this.edge+oy,r,radians(0),radians(90),false);ctx.arc(r+this.edge+ox,h-r-this.edge+oy,r,radians(90),radians(180),false);ctx.lineTo(this.edge+ox,r+this.edge+oy)};RingReporterSlotMorph.prototype.drawEdgesOval=function(ctx){var h=this.height(),r=Math.min(this.rounding,h/2),w=this.width(),shift=this.edge/2,gradient;ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=this.cachedClr;ctx.beginPath();ctx.arc(r,h-r,r-shift,radians(90),radians(180),false);ctx.stroke();ctx.strokeStyle=this.cachedClr;ctx.beginPath();ctx.arc(w-r,r,r-shift,radians(-90),radians(0),false);ctx.stroke();if(useBlurredShadows){ctx.shadowOffsetX=shift;ctx.shadowOffsetY=shift;ctx.shadowBlur=this.edge;ctx.shadowColor=this.color.darker(80).toString()}gradient=ctx.createLinearGradient(0,0,0,this.edge);gradient.addColorStop(1,this.cachedClrDark);gradient.addColorStop(0,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r-shift,shift);ctx.lineTo(w-r+shift,shift);ctx.stroke();gradient=ctx.createRadialGradient(r,r,r-this.edge,r,r,r);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(r,r,r-shift,radians(180),radians(270),false);ctx.stroke();gradient=ctx.createLinearGradient(0,0,this.edge,0);gradient.addColorStop(1,this.cachedClrDark);gradient.addColorStop(0,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,r);ctx.lineTo(shift,h-r);ctx.stroke();ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.shadowBlur=0;gradient=ctx.createRadialGradient(w-r,h-r,r-this.edge,w-r,h-r,r);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.arc(w-r,h-r,r-shift,radians(0),radians(90),false);ctx.stroke();gradient=ctx.createLinearGradient(0,h-this.edge,0,h);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r-shift,h-shift);ctx.lineTo(w-r+shift,h-shift);ctx.stroke();gradient=ctx.createLinearGradient(w-this.edge,0,w,0);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(w-shift,r+shift);ctx.lineTo(w-shift,h-r);ctx.stroke()};RingReporterSlotMorph.prototype.outlinePathDiamond=function(ctx,offset){var ox=offset.x,oy=offset.y,w=this.width(),h=this.height(),h2=Math.floor(h/2),r=Math.min(this.rounding,h2);ctx.moveTo(ox+this.edge,h2+oy);ctx.lineTo(r+this.edge+ox,this.edge+oy);ctx.lineTo(w-r-this.edge+ox,this.edge+oy);ctx.lineTo(w-this.edge+ox,h2+oy);ctx.lineTo(w-r-this.edge+ox,h-this.edge+oy);ctx.lineTo(r+this.edge+ox,h-this.edge+oy);ctx.lineTo(ox+this.edge,h2+oy)};RingReporterSlotMorph.prototype.drawEdgesDiamond=function(ctx){var w=this.width(),h=this.height(),h2=Math.floor(h/2),r=Math.min(this.rounding,h2),shift=this.edge/2,gradient;ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";ctx.strokeStyle=this.cachedClr;ctx.beginPath();ctx.moveTo(shift,h2);ctx.lineTo(r,h-shift);ctx.stroke();ctx.strokeStyle=this.cachedClr;ctx.beginPath();ctx.moveTo(w-shift,h2);ctx.lineTo(w-r,shift);ctx.stroke();if(useBlurredShadows){ctx.shadowOffsetX=shift;ctx.shadowOffsetY=shift;ctx.shadowBlur=this.edge;ctx.shadowColor=this.color.darker(80).toString()}gradient=ctx.createLinearGradient(0,0,r,0);gradient.addColorStop(1,this.cachedClrDark);gradient.addColorStop(0,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,h2);ctx.lineTo(r,shift);ctx.stroke();gradient=ctx.createLinearGradient(0,0,0,this.edge);gradient.addColorStop(1,this.cachedClrDark);gradient.addColorStop(0,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r,shift);ctx.lineTo(w-r,shift);ctx.stroke();ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.shadowBlur=0;gradient=ctx.createLinearGradient(w-r,0,w,0);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(w-r,h-shift);ctx.lineTo(w-shift,h2);ctx.stroke();gradient=ctx.createLinearGradient(0,h-this.edge,0,h);gradient.addColorStop(1,this.cachedClr);gradient.addColorStop(0,this.cachedClrBright);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(r+shift,h-shift);ctx.lineTo(w-r-shift,h-shift);ctx.stroke()};CommentMorph.prototype=new BoxMorph;CommentMorph.prototype.constructor=CommentMorph;CommentMorph.uber=BoxMorph.prototype;CommentMorph.prototype.refreshScale=function(){CommentMorph.prototype.fontSize=SyntaxElementMorph.prototype.fontSize;CommentMorph.prototype.padding=5*SyntaxElementMorph.prototype.scale;CommentMorph.prototype.rounding=8*SyntaxElementMorph.prototype.scale};CommentMorph.prototype.refreshScale();function CommentMorph(contents){this.init(contents)}CommentMorph.prototype.init=function(contents){var scale=SyntaxElementMorph.prototype.scale;this.block=null;this.stickyOffset=null;this.isCollapsed=false;this.titleBar=new BoxMorph(this.rounding,scale,new Color(255,255,180));this.titleBar.color=new Color(255,255,180);this.titleBar.setHeight(fontHeight(this.fontSize)+this.padding);this.title=null;this.arrow=new ArrowMorph("down",this.fontSize);this.arrow.mouseClickLeft=()=>this.toggleExpand();this.contents=new TextMorph(contents||localize("add comment here..."),this.fontSize);this.contents.isEditable=true;this.contents.enableSelecting();this.contents.maxWidth=90*scale;this.contents.fixLayout();this.handle=new HandleMorph(this.contents,80,this.fontSize*2,-2,-2);this.handle.setExtent(new Point(11*scale,11*scale));this.anchor=null;CommentMorph.uber.init.call(this,this.rounding,scale,new Color(255,255,180));this.color=new Color(255,255,220);this.isDraggable=true;this.add(this.titleBar);this.add(this.arrow);this.add(this.contents);this.add(this.handle);this.fixLayout()};CommentMorph.prototype.fullCopy=function(){var cpy=new CommentMorph(this.contents.text);cpy.isCollapsed=this.isCollapsed;cpy.setTextWidth(this.textWidth());if(this.selectionID){cpy.selectionID=true}return cpy};CommentMorph.prototype.setTextWidth=function(pixels){this.contents.maxWidth=pixels;this.contents.fixLayout();this.fixLayout()};CommentMorph.prototype.textWidth=function(){return this.contents.maxWidth};CommentMorph.prototype.text=function(){return this.contents.text};CommentMorph.prototype.toggleExpand=function(){this.isCollapsed=!this.isCollapsed;this.fixLayout();this.align();if(!this.isCollapsed){this.comeToFront()}};CommentMorph.prototype.comeToFront=function(){if(this.parent){this.parent.add(this);this.changed()}};CommentMorph.prototype.mouseClickLeft=function(){this.comeToFront()};CommentMorph.prototype.layoutChanged=function(){var ide=this.parentThatIsA(IDE_Morph);this.fixLayout();this.align();this.comeToFront();if(ide){ide.recordUnsavedChanges()}};CommentMorph.prototype.fixLayout=function(){var label,tw=this.contents.width()+2*this.padding;if(this.title){this.title.destroy();this.title=null}if(this.isCollapsed){this.contents.hide();this.title=new FrameMorph;this.title.alpha=0;this.title.acceptsDrops=false;label=new StringMorph(this.contents.text,this.fontSize,null,true);label.rootForGrab=()=>this;this.title.add(label);this.title.setHeight(label.height());this.title.setWidth(tw-this.arrow.width()-this.padding*2-this.rounding);this.add(this.title)}else{this.contents.show()}this.titleBar.setWidth(tw);this.contents.setLeft(this.titleBar.left()+this.padding);this.contents.setTop(this.titleBar.bottom()+this.padding);this.arrow.direction=this.isCollapsed?"right":"down";this.arrow.rerender();this.arrow.setCenter(this.titleBar.center());this.arrow.setLeft(this.titleBar.left()+this.padding);if(this.title){this.title.setPosition(this.arrow.topRight().add(new Point(this.padding,0)))}this.changed();this.bounds.setHeight(this.titleBar.height()+(this.isCollapsed?0:this.padding+this.contents.height()+this.padding));this.bounds.setWidth(this.titleBar.width());this.rerender();this.handle.fixLayout()};CommentMorph.prototype.userMenu=function(){var menu=new MenuMorph(this);menu.addItem("duplicate",()=>{var dup=this.fullCopy(),ide=this.parentThatIsA(IDE_Morph),blockEditor=this.parentThatIsA(BlockEditorMorph),world=this.world();dup.pickUp(world);if(!ide&&blockEditor){ide=blockEditor.target.parentThatIsA(IDE_Morph)}if(ide){world.hand.grabOrigin={origin:ide.palette,position:ide.palette.center()}}},"make a copy\nand pick it up");menu.addItem("delete","userDestroy");menu.addItem("comment pic...",()=>{var ide=this.parentThatIsA(IDE_Morph)||this.parentThatIsA(BlockEditorMorph).target.parentThatIsA(IDE_Morph);ide.saveCanvasAs(this.fullImage(),(ide.projectName||localize("untitled"))+" "+localize("comment pic"))},"save a picture\nof this comment");return menu};CommentMorph.prototype.userDestroy=function(){this.selectForEdit().destroy()};CommentMorph.prototype.hide=function(){this.isVisible=false;this.changed()};CommentMorph.prototype.show=function(){this.isVisible=true;this.changed()};CommentMorph.prototype.prepareToBeGrabbed=function(hand){if(this.block){this.block.comment=null;this.block=null}if(this.anchor){this.anchor.destroy();this.anchor=null}};CommentMorph.prototype.selectForEdit=SyntaxElementMorph.prototype.selectForEdit;CommentMorph.prototype.snap=function(hand){var scripts=this.parent,target;if(!(scripts instanceof ScriptsMorph)){return null}scripts.clearDropInfo();target=scripts.closestBlock(this,hand);if(target!==null){target.comment=this;this.block=target;if(this.snapSound){this.snapSound.play()}scripts.lastDropTarget={element:target}}this.align();scripts.lastDroppedBlock=this;if(hand){scripts.recordDrop(hand.grabOrigin)}};CommentMorph.prototype.align=function(topBlock,ignoreLayer){if(this.block){var top=topBlock||this.block.topBlock(),affectedBlocks,tp,bottom,rightMost,scripts=top.parentThatIsA(ScriptsMorph);this.setTop(this.block.top()+this.block.corner);tp=this.top();bottom=this.bottom();affectedBlocks=top.allChildren().filter(child=>child instanceof BlockMorph&&child.bottom()>tp&&child.top()<bottom);rightMost=Math.max.apply(null,affectedBlocks.map(block=>block.right()));this.setLeft(rightMost+5);if(!ignoreLayer&&scripts){scripts.addBack(this)}if(!this.anchor){this.anchor=new Morph;this.anchor.color=this.titleBar.color}this.anchor.setPosition(new Point(this.block.right(),this.top()+this.edge));this.anchor.bounds.corner=new Point(this.left(),this.top()+this.edge+1);this.anchor.rerender();this.addBack(this.anchor)}};CommentMorph.prototype.startFollowing=function(topBlock,world){this.align(topBlock);world.add(this);this.addShadow();this.stickyOffset=this.position().subtract(this.block.position());this.step=()=>{if(!this.block){this.stopFollowing();return}this.setPosition(this.block.position().add(this.stickyOffset))}};CommentMorph.prototype.stopFollowing=function(){this.removeShadow();delete this.step};CommentMorph.prototype.destroy=function(){if(this.block){this.block.comment=null}CommentMorph.uber.destroy.call(this)};CommentMorph.prototype.stackHeight=function(){return this.height()};ScriptFocusMorph.prototype=new BoxMorph;ScriptFocusMorph.prototype.constructor=ScriptFocusMorph;ScriptFocusMorph.uber=BoxMorph.prototype;function ScriptFocusMorph(editor,initialElement,position){this.init(editor,initialElement,position)}ScriptFocusMorph.prototype.init=function(editor,initialElement,position){this.editor=editor;this.element=initialElement;this.atEnd=false;ScriptFocusMorph.uber.init.call(this);if(this.element instanceof ScriptsMorph){this.setPosition(position)}};ScriptFocusMorph.prototype.getFocus=function(world){if(!world){world=this.world()}if(world&&world.keyboardFocus!==this){world.stopEditing()}world.keyboardFocus=this;this.fixLayout();this.editor.updateToolbar()};ScriptFocusMorph.prototype.fixLayout=function(){this.changed();if(this.element instanceof CommandBlockMorph||this.element instanceof CommandSlotMorph||this.element instanceof ScriptsMorph){this.manifestStatement()}else{this.manifestExpression()}this.editor.add(this);this.scrollIntoView();this.changed()};ScriptFocusMorph.prototype.manifestStatement=function(){var newScript=this.element instanceof ScriptsMorph,y=this.element.top();this.border=0;this.edge=0;this.alpha=1;this.color=this.editor.feedbackColor;this.bounds.setExtent(new Point(newScript?SyntaxElementMorph.prototype.hatWidth:this.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight)));if(this.element instanceof CommandSlotMorph){y+=SyntaxElementMorph.prototype.corner}else if(this.atEnd){y=this.element.bottom()}if(!newScript){this.setPosition(new Point(this.element.left(),y))}this.fps=2;this.show();this.step=function(){this.toggleVisibility()}};ScriptFocusMorph.prototype.manifestExpression=function(){this.edge=SyntaxElementMorph.prototype.rounding;this.border=Math.max(SyntaxElementMorph.prototype.edge,3);this.color=this.editor.feedbackColor.copy();this.color.a=.5;this.borderColor=this.editor.feedbackColor;this.bounds=this.element.fullBounds().expandBy(Math.max(SyntaxElementMorph.prototype.edge*2,SyntaxElementMorph.prototype.reporterDropFeedbackPadding));this.rerender();delete this.fps;delete this.step;this.show()};ScriptFocusMorph.prototype.trigger=function(){var current=this.element;if(current instanceof MultiArgMorph){if(current.arrows().children[1].isVisible){current.addInput();this.fixLayout()}return}if(current.parent instanceof TemplateSlotMorph){current.mouseClickLeft();return}if(current instanceof BooleanSlotMorph){current.toggleValue();return}if(current instanceof InputSlotMorph){if(!current.isReadOnly){delete this.fps;delete this.step;this.hide();this.world().onNextStep=()=>{current.contents().edit();current.contents().selectAll()}}else if(current.choices){current.dropDownMenu(true);delete this.fps;delete this.step;this.hide()}}};ScriptFocusMorph.prototype.menu=function(){var current=this.element;if(current instanceof InputSlotMorph&&current.choices){current.dropDownMenu(true);delete this.fps;delete this.step;this.hide()}else{this.insertVariableGetter()}};ScriptFocusMorph.prototype.deleteLastElement=function(){var current=this.element;if(current.parent instanceof ScriptsMorph){if(this.atEnd||current instanceof ReporterBlockMorph){current.destroy();this.element=this.editor;this.atEnd=false}}else if(current instanceof MultiArgMorph){if(current.arrows().children[0].isVisible){current.removeInput()}}else if(current instanceof BooleanSlotMorph){if(!current.isStatic){current.setContents(null)}}else if(current instanceof ReporterBlockMorph){if(!current.isTemplate){this.lastElement();current.prepareToBeGrabbed();current.destroy()}}else if(current instanceof CommandBlockMorph){if(this.atEnd){this.element=current.parent;current.userDestroy()}else{if(current.parent instanceof CommandBlockMorph){current.parent.userDestroy()}}}this.editor.adjustBounds();this.fixLayout()};ScriptFocusMorph.prototype.insertBlock=function(block){this.world().add(block);block.glideTo(this.position(),null,null,()=>this.fillInBlock(block))};ScriptFocusMorph.prototype.fillInBlock=function(block){var pb,stage,ide,rcvr;block.isTemplate=false;block.isDraggable=true;if(block.snapSound){block.snapSound.play()}if(this.element instanceof ScriptsMorph){this.editor.add(block);this.element=block;if(block instanceof CommandBlockMorph){block.setLeft(this.left());if(block.isStop()){block.setTop(this.top())}else{block.setBottom(this.top());this.atEnd=true}}else{block.setCenter(this.center());block.setLeft(this.left())}}else if(this.element instanceof CommandBlockMorph){if(this.atEnd){this.element.nextBlock(block);this.element=block;this.fixLayout()}else{pb=this.element.parent;if(pb instanceof ScriptsMorph){block.setLeft(this.element.left());block.setBottom(this.element.top()+this.element.corner);this.editor.add(block);block.nextBlock(this.element);this.fixLayout()}else if(pb instanceof CommandSlotMorph){pb.nestedBlock(block)}else if(pb instanceof RingReporterSlotMorph){block.nextBlock(pb.nestedBlock());pb.add(block);pb.fixLayout()}else if(pb instanceof CommandBlockMorph){pb.nextBlock(block)}}}else if(this.element instanceof CommandSlotMorph){this.element.nestedBlock(block);this.element=block;this.atEnd=true}else{pb=this.element.parent;if(pb instanceof ScriptsMorph){this.editor.add(block);block.setPosition(this.element.position());this.element.destroy()}else{pb.replaceInput(this.element,block)}this.element=block}block.fixBlockColor();this.editor.adjustBounds();this.fixLayout();if(block.selector==="receiveCondition"){rcvr=this.editor.scriptTarget();if(rcvr){stage=rcvr.parentThatIsA(StageMorph);if(stage){stage.enableCustomHatBlocks=true;stage.threads.pauseCustomHatBlocks=false;ide=stage.parentThatIsA(IDE_Morph);if(ide){ide.controlBar.stopButton.refresh()}}}}if(block.inputs&&block.inputs().length){this.element=block;this.atEnd=false;this.nextElement()}};ScriptFocusMorph.prototype.insertVariableGetter=function(){var types=this.blockTypes(),vars,menu=new MenuMorph;if(!types||!contains(types,"reporter")){return}vars=InputSlotMorph.prototype.getVarNamesDict.call(this.element);Object.keys(vars).forEach(vName=>{var block=SpriteMorph.prototype.variableBlock(vName);block.addShadow(new Point(3,3));menu.addItem(block,()=>{block.removeShadow();this.insertBlock(block)})});if(menu.items.length>0){menu.popup(this.world(),this.element.bottomLeft());menu.getFocus()}};ScriptFocusMorph.prototype.stopEditing=function(){this.editor.focus=null;this.editor.updateToolbar();this.world().keyboardFocus=null;this.destroy()};ScriptFocusMorph.prototype.lastElement=function(){var items=this.items(),idx;if(!items.length){this.shiftScript(new Point(-50,0));return}if(this.atEnd){this.element=items[items.length-1];this.atEnd=false}else{idx=items.indexOf(this.element)-1;if(idx<0){idx=items.length-1}this.element=items[idx]}if(this.element instanceof CommandSlotMorph&&this.element.nestedBlock()){this.lastElement()}else if(this.element instanceof HatBlockMorph){if(items.length>1){this.lastElement()}else{this.atEnd=true}}this.fixLayout()};ScriptFocusMorph.prototype.nextElement=function(){var items=this.items(),idx,nb;if(!items.length){this.shiftScript(new Point(50,0));return}idx=items.indexOf(this.element)+1;if(idx>=items.length){idx=0}this.atEnd=false;this.element=items[idx];if(this.element instanceof CommandSlotMorph){nb=this.element.nestedBlock();if(nb){this.element=nb}}else if(this.element instanceof HatBlockMorph){if(items.length===1){this.atEnd=true}else{this.nextElement()}}this.fixLayout()};ScriptFocusMorph.prototype.lastCommand=function(){var cm=this.element.parentThatIsA(CommandBlockMorph),pb;if(!cm){if(this.element instanceof ScriptsMorph){this.shiftScript(new Point(0,-50))}return}if(this.element instanceof CommandBlockMorph){if(this.atEnd){this.atEnd=false}else{pb=cm.parent.parentThatIsA(CommandBlockMorph);if(pb){this.element=pb}else{pb=cm.topBlock().bottomBlock();if(pb){this.element=pb;this.atEnd=true}}}}else{this.element=cm;this.atEnd=false}if(this.element instanceof HatBlockMorph&&!this.atEnd){this.lastCommand()}this.fixLayout()};ScriptFocusMorph.prototype.nextCommand=function(){var cm=this.element,tb,nb,cs;if(cm instanceof ScriptsMorph){this.shiftScript(new Point(0,50));return}while(!(cm instanceof CommandBlockMorph)){cm=cm.parent;if(cm instanceof ScriptsMorph){return}}if(this.atEnd){cs=cm.parentThatIsA(CommandSlotMorph);if(cs){this.element=cs.parentThatIsA(CommandBlockMorph);this.atEnd=false;this.nextCommand()}else{tb=cm.topBlock().parentThatIsA(CommandBlockMorph);if(tb){this.element=tb;this.atEnd=false;if(this.element instanceof HatBlockMorph){this.nextCommand()}}}}else{nb=cm.nextBlock();if(nb){this.element=nb}else{this.element=cm;this.atEnd=true}}this.fixLayout()};ScriptFocusMorph.prototype.nextScript=function(){var scripts=this.sortedScripts(),idx;if(scripts.length<1){return}if(this.element instanceof ScriptsMorph){this.element=scripts[0]}idx=scripts.indexOf(this.element.topBlock())+1;if(idx>=scripts.length){idx=0}this.element=scripts[idx];this.element.scrollIntoView();this.atEnd=false;if(this.element instanceof HatBlockMorph){return this.nextElement()}this.fixLayout()};ScriptFocusMorph.prototype.lastScript=function(){var scripts=this.sortedScripts(),idx;if(scripts.length<1){return}if(this.element instanceof ScriptsMorph){this.element=scripts[0]}idx=scripts.indexOf(this.element.topBlock())-1;if(idx<0){idx=scripts.length-1}this.element=scripts[idx];this.element.scrollIntoView();this.atEnd=false;if(this.element instanceof HatBlockMorph){return this.nextElement()}this.fixLayout()};ScriptFocusMorph.prototype.shiftScript=function(deltaPoint){var tb;if(this.element instanceof ScriptsMorph){this.moveBy(deltaPoint)}else{tb=this.element.topBlock();if(tb&&!(tb instanceof PrototypeHatBlockMorph)){tb.moveBy(deltaPoint)}}this.editor.adjustBounds();this.fixLayout()};ScriptFocusMorph.prototype.newScript=function(){var pos=this.position();if(!(this.element instanceof ScriptsMorph)){pos=this.element.topBlock().fullBounds().bottomLeft().add(new Point(0,50))}this.setPosition(pos);this.element=this.editor;this.editor.adjustBounds();this.fixLayout()};ScriptFocusMorph.prototype.runScript=function(){if(this.element instanceof ScriptsMorph){return}this.element.topBlock().mouseClickLeft()};ScriptFocusMorph.prototype.items=function(){if(this.element instanceof ScriptsMorph){return[]}var script=this.element.topBlock();return script.allChildren().filter(each=>each instanceof SyntaxElementMorph&&!(each instanceof TemplateSlotMorph)&&(!each.isStatic||each.choices||each instanceof BooleanSlotMorph||each instanceof RingMorph||each instanceof MultiArgMorph||each instanceof CommandSlotMorph))};ScriptFocusMorph.prototype.sortedScripts=function(){var scripts=this.editor.children.filter(each=>each instanceof BlockMorph);scripts.sort((a,b)=>a instanceof PrototypeHatBlockMorph?0:a.top()-b.top());return scripts};ScriptFocusMorph.prototype.undrop=function(){this.editor.undrop()};ScriptFocusMorph.prototype.redrop=function(){this.editor.redrop()};ScriptFocusMorph.prototype.blockTypes=function(){if(this.element.isTemplate){return null}if(this.element instanceof ScriptsMorph){return["hat","command","reporter","predicate","ring"]}if(this.element instanceof HatBlockMorph||this.element instanceof CommandSlotMorph){return["command"]}if(this.element instanceof CommandBlockMorph){if(this.atEnd&&this.element.isStop()){return null}if(this.element.parent instanceof ScriptsMorph){return["hat","command"]}return["command"]}if(this.element instanceof ReporterBlockMorph){if(this.element.getSlotSpec()==="%n"){return["reporter"]}return["reporter","predicate","ring"]}if(this.element.getSpec()==="%n"){return["reporter"]}if(this.element.isStatic){return null}return["reporter","predicate","ring"]};ScriptFocusMorph.prototype.processKeyDown=function(event){this.processKeyEvent(event,this.reactToKeyEvent)};ScriptFocusMorph.prototype.processKeyUp=function(event){nop(event)};ScriptFocusMorph.prototype.processKeyPress=function(event){nop(event)};ScriptFocusMorph.prototype.processKeyEvent=function(event,action){var keyName,ctrl,shift;this.world().hand.destroyTemporaries();switch(event.keyCode){case 8:keyName="backspace";break;case 9:keyName="tab";break;case 13:keyName="enter";break;case 16:case 17:case 18:return;case 27:keyName="esc";break;case 32:keyName="space";break;case 37:keyName="left arrow";break;case 39:keyName="right arrow";break;case 38:keyName="up arrow";break;case 40:keyName="down arrow";break;default:keyName=String.fromCharCode(event.keyCode||event.charCode)}ctrl=event.ctrlKey||event.metaKey?"ctrl ":"";shift=event.shiftKey?"shift ":"";keyName=ctrl+shift+keyName;action.call(this,keyName)};ScriptFocusMorph.prototype.reactToKeyEvent=function(key){var evt=key.toLowerCase(),shift=50,types,vNames;switch(evt){case"esc":return this.stopEditing();case"enter":return this.trigger();case"shift enter":return this.newScript();case"ctrl shift enter":return this.runScript();case"space":return this.menu();case"left arrow":return this.lastElement();case"shift left arrow":return this.shiftScript(new Point(-shift,0));case"right arrow":return this.nextElement();case"shift right arrow":return this.shiftScript(new Point(shift,0));case"up arrow":return this.lastCommand();case"shift up arrow":return this.shiftScript(new Point(0,-shift));case"down arrow":return this.nextCommand();case"shift down arrow":return this.shiftScript(new Point(0,shift));case"tab":return this.nextScript();case"shift tab":return this.lastScript();case"backspace":return this.deleteLastElement();case"ctrl z":return this.undrop();case"ctrl y":case"ctrl shift z":return this.redrop();case"ctrl [":return;default:types=this.blockTypes();if(!(this.element instanceof ScriptsMorph)&&types&&contains(types,"reporter")){vNames=Object.keys(this.element.getVarNamesDict())}if(types){delete this.fps;delete this.step;this.show();this.editor.scriptTarget().searchBlocks(key,types,vNames,this)}}};</script>
        <script>modules.threads="2022-August-03";var ThreadManager;var Process;var Context;var Variable;var VariableFrame;var JSCompiler;const NONNUMBERS=[true,false,""];(function(){for(var i=9;i<=13;i+=1){NONNUMBERS.push(String.fromCharCode(i))}NONNUMBERS.push(String.fromCharCode(160))})();function snapEquals(a,b){if(isNil(a)||isNil(b)){return a===b}if(a.equalTo||b.equalTo){if(a.constructor.name===b.constructor.name){return a.equalTo(b)}return false}var x=+a,y=+b;if(isNaN(x)||isNaN(y)||[a,b].some(any=>contains(NONNUMBERS,any)||isString(any)&&any.indexOf(" ")>-1)){x=a;y=b}if(isString(x)&&isString(y)){return x.toLowerCase()===y.toLowerCase()}return x===y}function invoke(action,contextArgs,receiver,timeout,timeoutErrorMsg,suppressErrors,callerProcess,returnContext){var proc=new Process,deadline=timeout?Date.now()+timeout:null;if(action instanceof Context){if(receiver){action=proc.reportContextFor(receiver)}proc.initializeFor(action,contextArgs||new List)}else if(action instanceof BlockMorph){proc.topBlock=action;if(receiver){proc.homeContext=new Context;proc.homeContext.receiver=receiver;if(receiver.variables){proc.homeContext.variables.parentFrame=receiver.variables}}else{throw new Error("expecting a receiver but getting "+receiver)}proc.context=new Context(null,action.blockSequence(),proc.homeContext)}else if(action.evaluate){return action.evaluate()}else if(action instanceof Function){return action.apply(receiver,contextArgs.itemsArray().concat(callerProcess))}else{throw new Error("expecting a block or ring but getting "+action)}if(suppressErrors){proc.isCatchingErrors=false}while(proc.isRunning()){if(deadline&&Date.now()>deadline){throw new Error(localize(timeoutErrorMsg||"a synchronous Snap! script has timed out"))}proc.runStep(deadline)}return returnContext?proc.homeContext:proc.homeContext.inputs[0]}function ThreadManager(){this.processes=[];this.wantsToPause=false}ThreadManager.prototype.pauseCustomHatBlocks=false;ThreadManager.prototype.disableClickToRun=false;ThreadManager.prototype.toggleProcess=function(block,receiver){if(this.disableClickToRun){return}var active=this.findProcess(block,receiver);if(active){active.stop()}else{return this.startProcess(block,receiver,null,null,null,true,null,null,this.clickFrameFor(block))}};ThreadManager.prototype.startProcess=function(block,receiver,isThreadSafe,exportResult,callback,isClicked,rightAway,atomic,variables){var top=block.topBlock(),active=this.findProcess(top,receiver),glow,newProc;if(active){if(isThreadSafe){return active}active.stop();active.canBroadcast=true;this.removeTerminatedProcesses()}newProc=new Process(top,receiver,callback,isClicked);newProc.exportResult=exportResult;newProc.isClicked=isClicked||false;newProc.isAtomic=atomic||false;if(variables instanceof VariableFrame){Object.keys(variables.vars).forEach(vName=>newProc.context.outerContext.variables.vars[vName]=variables.vars[vName])}glow=top.getHighlight();if(glow){glow.threadCount=this.processesForBlock(top).length+1;glow.updateReadout()}else{top.addHighlight()}this.processes.push(newProc);if(rightAway){newProc.runStep()}return newProc};ThreadManager.prototype.stopAll=function(excpt){this.processes.forEach(proc=>{if(proc!==excpt){proc.stop()}})};ThreadManager.prototype.stopAllForReceiver=function(rcvr,excpt){this.processes.forEach(proc=>{if(proc.homeContext.receiver===rcvr&&proc!==excpt){proc.stop();if(rcvr.isTemporary){proc.isDead=true}}})};ThreadManager.prototype.stopAllForBlock=function(aTopBlock){this.processesForBlock(aTopBlock,true).forEach(proc=>proc.stop())};ThreadManager.prototype.stopProcess=function(block,receiver){var active=this.findProcess(block,receiver);if(active){active.stop()}};ThreadManager.prototype.pauseAll=function(stage){this.processes.forEach(proc=>proc.pause());if(stage){stage.pauseAllActiveSounds()}};ThreadManager.prototype.isPaused=function(){return detect(this.processes,proc=>proc.isPaused)!==null};ThreadManager.prototype.resumeAll=function(stage){this.processes.forEach(proc=>proc.resume());if(stage){stage.resumeAllActiveSounds()}};ThreadManager.prototype.step=function(){var isInterrupted;if(Process.prototype.enableSingleStepping){this.processes.forEach(proc=>{if(proc.isInterrupted){proc.runStep();isInterrupted=true}else{proc.lastYield=Date.now()}});this.wantsToPause=Process.prototype.flashTime>.5;if(isInterrupted){if(this.wantsToPause){this.pauseAll()}return}}this.processes.forEach(proc=>{if(!proc.homeContext.receiver.isPickedUp()&&!proc.isDead){proc.runStep()}});this.removeTerminatedProcesses()};ThreadManager.prototype.removeTerminatedProcesses=function(){var remaining=[],count;this.processes.forEach(proc=>{var result,glow;if(!proc.isRunning()&&!proc.errorFlag||proc.isDead){if(proc.topBlock instanceof BlockMorph){proc.unflash();count=this.processesForBlock(proc.topBlock).length;if(count){glow=proc.topBlock.getHighlight()||proc.topBlock.addHighlight();glow.threadCount=count;glow.updateReadout()}else{proc.topBlock.removeHighlight()}}if(proc.prompter){proc.prompter.destroy();if(proc.homeContext.receiver.stopTalking){proc.homeContext.receiver.stopTalking()}}if(proc.topBlock instanceof ReporterBlockMorph||proc.isShowingResult||proc.exportResult){result=proc.homeContext.inputs[0];if(proc.onComplete instanceof Function){proc.onComplete(result)}else{if(result instanceof List){proc.topBlock.showBubble(result.isTable()?new TableFrameMorph(new TableMorph(result,10)):new ListWatcherMorph(result),proc.exportResult,proc.receiver)}else{proc.topBlock.showBubble(result,proc.exportResult,proc.receiver)}}}else if(proc.onComplete instanceof Function){proc.onComplete()}}else{remaining.push(proc)}});this.processes=remaining};ThreadManager.prototype.findProcess=function(block,receiver){var top=block.topBlock();return detect(this.processes,each=>each.topBlock===top&&each.receiver===receiver)};ThreadManager.prototype.processesForBlock=function(block,only){var top=only?block:block.topBlock();return this.processes.filter(each=>each.topBlock===top&&each.isRunning()&&!each.isDead)};ThreadManager.prototype.doWhen=function(block,receiver,stopIt){if(this.pauseCustomHatBlocks){return}if(!block||this.findProcess(block,receiver)){return}var pred=block.inputs()[0],world,test;if(block.removeHighlight()){world=block.world();if(world){world.hand.destroyTemporaries()}}if(stopIt){return}try{test=invoke(pred,null,receiver,50,"the predicate takes\ntoo long for a\ncustom hat block",true,null,true)}catch(error){block.addErrorHighlight();block.showBubble(error.name+"\n"+error.message)}if(test===true||test&&test.inputs&&test.inputs[0]===true){this.startProcess(block,receiver,null,null,null,null,true,null,test.variables)}};ThreadManager.prototype.toggleSingleStepping=function(){Process.prototype.enableSingleStepping=!Process.prototype.enableSingleStepping;if(!Process.prototype.enableSingleStepping){this.processes.forEach(proc=>{if(!proc.isPaused){proc.unflash()}})}};ThreadManager.prototype.clickFrameFor=function(block){var name,frame;if(block instanceof HatBlockMorph){if(block.selector==="receiveKey"||block.selector==="receiveMessage"){name=block.inputs()[1].evaluate()[0];if(name){frame=new VariableFrame;frame.addVar(name,"");return frame}}}return null};Process.prototype={};Process.prototype.constructor=Process;Process.prototype.timeout=500;Process.prototype.isCatchingErrors=true;Process.prototype.enableHyperOps=true;Process.prototype.enableLiveCoding=false;Process.prototype.enableSingleStepping=false;Process.prototype.enableCompiling=false;Process.prototype.flashTime=0;Process.prototype.enableJS=true;function Process(topBlock,receiver,onComplete,yieldFirst){this.topBlock=topBlock||null;this.receiver=receiver;this.instrument=receiver?receiver.instrument:null;this.readyToYield=false;this.readyToTerminate=false;this.isDead=false;this.isClicked=false;this.isShowingResult=false;this.errorFlag=false;this.context=null;this.homeContext=new Context(null,null,null,receiver);this.lastYield=Date.now();this.isFirstStep=true;this.isAtomic=false;this.prompter=null;this.httpRequest=null;this.isPaused=false;this.pauseOffset=null;this.currentTime=Date.now();this.frameCount=0;this.stepFrameCount=0;this.yieldCount=0;this.exportResult=false;this.onComplete=onComplete||null;this.procedureCount=0;this.flashingContext=null;this.isInterrupted=false;this.canBroadcast=true;if(topBlock){this.homeContext.variables.parentFrame=this.homeContext.receiver.variables;this.context=new Context(null,topBlock.blockSequence(),this.homeContext);if(yieldFirst){this.pushContext("doYield")}}}Process.prototype.isRunning=function(){return!this.readyToTerminate&&(this.context||this.isPaused)};Process.prototype.runStep=function(deadline){if(this.isPaused){return this.pauseStep()}this.readyToYield=false;this.isInterrupted=false;while(!this.readyToYield&&!this.isInterrupted&&this.context&&this.currentTime-this.lastYield<this.timeout){if(this.isPaused){return this.pauseStep()}if(deadline&&this.currentTime>deadline){if(this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp){this.homeContext.receiver.endWarp()}return}this.evaluateContext()}this.stepFrameCount=0;this.yieldCount+=1;this.lastYield=Date.now();this.isFirstStep=false;if(this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp){this.homeContext.receiver.endWarp();this.homeContext.receiver.startWarp()}if(this.readyToTerminate){while(this.context){this.popContext()}if(this.homeContext.receiver){if(this.homeContext.receiver.endWarp){this.homeContext.receiver.endWarp()}}}};Process.prototype.stop=function(){this.readyToYield=true;this.readyToTerminate=true;this.errorFlag=false;if(this.context){this.context.stopMusic()}this.canBroadcast=false};Process.prototype.pause=function(){if(this.readyToTerminate){return}this.isPaused=true;this.flashPausedContext();if(this.context&&this.context.startTime){this.pauseOffset=Date.now()-this.context.startTime}};Process.prototype.resume=function(){if(!this.enableSingleStepping){this.unflash()}this.isPaused=false;this.pauseOffset=null};Process.prototype.pauseStep=function(){this.lastYield=Date.now();if(this.context&&this.context.startTime){this.context.startTime=this.lastYield-this.pauseOffset}};Process.prototype.evaluateContext=function(){var exp=this.context.expression;this.frameCount+=1;this.stepFrameCount+=1;if(this.stepFrameCount>100){this.currentTime=Date.now();this.stepFrameCount=0}if(this.context.tag==="exit"){this.expectReport()}if(exp instanceof Array){return this.evaluateSequence(exp)}if(exp instanceof MultiArgMorph){return this.evaluateMultiSlot(exp,exp.inputs().length)}if(exp instanceof ArgLabelMorph){return this.evaluateArgLabel(exp)}if(exp instanceof ArgMorph||exp.bindingID){return this.evaluateInput(exp)}if(exp instanceof BlockMorph){return this.evaluateBlock(exp,exp.inputs().length)}if(isString(exp)){return this[exp].apply(this,this.context.inputs)}if(exp instanceof Variable){this.returnValueToParentContext(exp.value)}this.popContext()};Process.prototype.evaluateBlock=function(block,argCount){var rcvr,inputs,selector=block.selector;if(selector==="reportOr"||selector==="reportAnd"||selector==="reportIfElse"||selector==="doReport"){if(this.isCatchingErrors){try{return this[selector](block)}catch(error){this.handleError(error,block)}}else{return this[selector](block)}}rcvr=this.context.receiver||this.receiver;inputs=this.context.inputs;if(argCount>inputs.length){this.evaluateNextInputSet(block)}else{if(this.flashContext()){return}if(this[selector]){rcvr=this}if(this.isCatchingErrors){try{this.returnValueToParentContext(rcvr[selector].apply(rcvr,inputs));this.popContext()}catch(error){this.handleError(error,block)}}else{this.returnValueToParentContext(rcvr[selector].apply(rcvr,inputs));this.popContext()}}};Process.prototype.doApplyExtension=function(prim,args){this.reportApplyExtension(prim,args)};Process.prototype.reportApplyExtension=function(prim,args){var ext=SnapExtensions.primitives.get(prim);if(isNil(ext)){throw new Error(localize("missing / unspecified extension")+": "+prim)}return ext.apply(this.blockReceiver(),args.itemsArray().concat([this]))};Process.prototype.reportOr=function(block){var inputs=this.context.inputs;if(inputs.length<1){this.evaluateNextInput(block)}else if(inputs.length===1){if(inputs[0]===true){if(this.flashContext()){return}this.returnValueToParentContext(true);this.popContext()}else{this.evaluateNextInput(block)}}else{if(this.flashContext()){return}this.returnValueToParentContext(this.hyperDyadic(this.reportBasicOr,inputs[0],inputs[1]));this.popContext()}};Process.prototype.reportBasicOr=function(a,b){return a||b};Process.prototype.reportAnd=function(block){var inputs=this.context.inputs;if(inputs.length<1){this.evaluateNextInput(block)}else if(inputs.length===1){if(!inputs[0]){if(this.flashContext()){return}this.returnValueToParentContext(false);this.popContext()}else{this.evaluateNextInput(block)}}else{if(this.flashContext()){return}this.returnValueToParentContext(this.hyperDyadic(this.reportBasicAnd,inputs[0],inputs[1]));this.popContext()}};Process.prototype.reportBasicAnd=function(a,b){return a&&b};Process.prototype.doReport=function(block){var outer=this.context.outerContext;if(this.flashContext()){return}if(this.isClicked&&block.topBlock()===this.topBlock){this.isShowingResult=true}if(block.partOfCustomCommand){this.doStopCustomBlock();this.popContext()}else{while(this.context&&this.context.tag!=="exit"){if(this.context.expression==="doStopWarping"){this.doStopWarping()}else{this.popContext()}}if(this.context){if(this.context.expression==="expectReport"){this.popContext()}else{this.context.tag=null}}}this.pushContext(block.inputs()[0],outer);this.context.isCustomCommand=block.partOfCustomCommand};Process.prototype.evaluateMultiSlot=function(multiSlot,argCount){var inputs=this.context.inputs,ans;if(multiSlot.bindingID){if(this.isCatchingErrors){try{ans=this.context.variables.getVar(multiSlot.bindingID)}catch(error){this.handleError(error,multiSlot)}}else{ans=this.context.variables.getVar(multiSlot.bindingID)}this.returnValueToParentContext(ans);this.popContext()}else{if(argCount>inputs.length){this.evaluateNextInputSet(multiSlot)}else{this.returnValueToParentContext(new List(inputs));this.popContext()}}};Process.prototype.evaluateArgLabel=function(argLabel){var inputs=this.context.inputs;if(inputs.length<1){this.evaluateNextInput(argLabel)}else{this.returnValueToParentContext(inputs[0]);this.popContext()}};Process.prototype.evaluateInput=function(input){var ans;if(this.flashContext()){return}if(input.bindingID){if(this.isCatchingErrors){try{ans=this.context.variables.getVar(input.bindingID)}catch(error){this.handleError(error,input)}}else{ans=this.context.variables.getVar(input.bindingID)}}else{ans=input.evaluate();if(ans){if(input.constructor===CommandSlotMorph||input.constructor===ReporterSlotMorph||input instanceof CSlotMorph&&(!input.isStatic||input.isLambda)){ans=this.reify(ans,new List)}}}this.returnValueToParentContext(ans);this.popContext()};Process.prototype.evaluateSequence=function(arr){var pc=this.context.pc,outer=this.context.outerContext,isCustomBlock=this.context.isCustomBlock;if(pc===arr.length-1){this.context=new Context(this.context.parentContext,arr[pc],this.context.outerContext,this.context.receiver);this.context.isCustomBlock=isCustomBlock}else{if(pc>=arr.length){this.popContext()}else{this.context.pc+=1;this.pushContext(arr[pc],outer)}}};Process.prototype.evaluateNextInput=function(element){var nxt=this.context.inputs.length,args=element.inputs(),exp=args[nxt],sel=this.context.expression.selector,outer=this.context.outerContext;if(exp.isUnevaluated){if(exp.isUnevaluated===true||exp.isUnevaluated()){if(sel==="reify"||sel==="reportScript"){this.context.addInput(exp)}else{this.context.addInput(this.reify(exp,new List))}}else{this.pushContext(exp,outer)}}else{this.pushContext(exp,outer)}};Process.prototype.evaluateNextInputSet=function(element){var args=element.inputs(),sel=this.context.expression.selector,outer=this.context.outerContext,exp,ans;while(args.length>this.context.inputs.length){exp=args[this.context.inputs.length];if(exp.isUnevaluated){if(exp.isUnevaluated===true||exp.isUnevaluated()){if(sel==="reify"||sel==="reportScript"){this.context.addInput(exp)}else{this.context.addInput(this.reify(exp,new List))}}else{this.pushContext(exp,outer);break}}else{if(exp instanceof MultiArgMorph||exp instanceof ArgLabelMorph||exp instanceof BlockMorph){this.pushContext(exp,outer);break}else{if(this.flashContext()){return}if(exp.bindingID){if(this.isCatchingErrors){try{ans=this.context.variables.getVar(exp.bindingID)}catch(error){this.handleError(error,exp)}}else{ans=this.context.variables.getVar(exp.bindingID)}}else{ans=exp.evaluate();if(ans){if(exp.constructor===CommandSlotMorph||exp.constructor===ReporterSlotMorph||exp instanceof CSlotMorph&&(!exp.isStatic||exp.isLambda)){ans=this.reify(ans,new List)}}}this.context.addInput(ans)}}}};Process.prototype.doYield=function(){this.popContext();if(!this.isAtomic){this.readyToYield=true}};Process.prototype.expectReport=function(){this.handleError(new Error("reporter didn't report"))};Process.prototype.throwError=function(error,element){var m=element,ide=this.homeContext.receiver.parentThatIsA(IDE_Morph);this.stop();this.errorFlag=true;this.topBlock.addErrorHighlight();if(ide.isAppMode){ide.showMessage(localize(error.name)+"\n"+error.message)}else{if(isNil(m)||isNil(m.world())){m=this.topBlock}m.showBubble(this.errorBubble(error,element),this.exportResult,this.receiver)}};Process.prototype.tryCatch=function(action,exception,errVarName){var next=this.context.continuation();this.handleError=function(error){this.resetErrorHandling();if(exception.expression instanceof CommandBlockMorph){exception.expression=exception.expression.blockSequence()}exception.pc=0;exception.outerContext.variables.addVar(errVarName);exception.outerContext.variables.setVar(errVarName,error.message);this.context=exception;this.evaluate(next,new List,true)};this.evaluate(action,new List,true)};Process.prototype.resetErrorHandling=function(){this.handleError=this.throwError};Process.prototype.resetErrorHandling();Process.prototype.errorObsolete=function(){throw new Error("a custom block definition is missing")};Process.prototype.errorBubble=function(error,element){var errorMorph=new AlignmentMorph("column",5),errorIsNested=!!element&&isNil(element.world()),errorPrefix=errorIsNested?`${localize("Inside a custom block")}\n`:"",errorMessage=new TextMorph(`${errorPrefix}${localize(error.name)}\n${localize(error.message)}`,SyntaxElementMorph.prototype.fontSize),blockToShow=element;errorMorph.add(errorMessage);if(errorIsNested&&error.cause!=="user"){if(blockToShow.selector==="reportGetVar"){blockToShow=blockToShow.parent||blockToShow}errorMorph.children[0].text+=`\n${localize("The question came up at")}`;errorMorph.children[0].fixLayout();errorMorph.add(blockToShow.fullCopy())}errorMorph.fixLayout();return errorMorph};Process.prototype.reify=function(topBlock,parameterNames,isCustomBlock){var context=new Context(null,null,this.context?this.context.outerContext:null),i=0;if(topBlock){context.expression=this.enableLiveCoding||this.enableSingleStepping?topBlock:topBlock.fullCopy();context.expression.show();if(!isCustomBlock&&!parameterNames.length()){context.expression.allEmptySlots().forEach(slot=>{i+=1;if(slot instanceof MultiArgMorph){slot.bindingID=Symbol.for("arguments")}else{slot.bindingID=i}});context.emptySlots=i}}else{context.expression=this.enableLiveCoding||this.enableSingleStepping?[this.context.expression]:[this.context.expression.fullCopy()]}context.inputs=parameterNames.itemsArray();context.receiver=this.context?this.context.receiver:this.receiver;context.origin=context.receiver;return context};Process.prototype.reportScript=function(parameterNames,topBlock){return this.reify(topBlock,parameterNames)};Process.prototype.reifyScript=function(topBlock,parameterNames){return this.reify(topBlock,parameterNames)};Process.prototype.reifyReporter=function(topBlock,parameterNames){return this.reify(topBlock,parameterNames)};Process.prototype.reifyPredicate=function(topBlock,parameterNames){return this.reify(topBlock,parameterNames)};Process.prototype.reportJSFunction=function(parmNames,body){if(!this.enableJS){throw new Error("JavaScript extensions for Snap!\nare turned off")}return Function.apply(null,parmNames.itemsArray().concat([body]))};Process.prototype.doRun=function(context,args){return this.evaluate(context,args,true)};Process.prototype.evaluate=function(context,args,isCommand){if(!context){return this.returnValueToParentContext(null)}if(context instanceof Function){return context.apply(this.blockReceiver(),args.itemsArray().concat([this]))}if(context.isContinuation){return this.runContinuation(context,args)}if(!(context instanceof Context)){throw new Error("expecting a ring but getting "+context)}var outer=new Context(null,null,context.outerContext),caller=this.context.parentContext,exit,runnable,expr,parms=args.itemsArray(),i,value;if(!outer.receiver){outer.receiver=context.receiver}runnable=new Context(this.context.parentContext,context.expression,outer,context.receiver);runnable.isCustomCommand=isCommand;this.context.parentContext=runnable;if(context.expression instanceof ReporterBlockMorph){this.readyToYield=this.currentTime-this.lastYield>this.timeout}outer.variables.addVar(Symbol.for("arguments"),args);outer.variables.addVar(Symbol.for("self"),context);if(parms.length>0){for(i=0;i<context.inputs.length;i+=1){value=0;if(!isNil(parms[i])){value=parms[i]}outer.variables.addVar(context.inputs[i],value)}if(context.inputs.length===0){if(parms.length===1){if(!context.emptySlots){expr=context.expression;if(expr instanceof Array&&expr.length===1&&expr[0].selector&&expr[0].selector==="reifyReporter"&&!expr[0].contents()){runnable.expression=new Variable(parms[0])}}else{for(i=1;i<=context.emptySlots;i+=1){outer.variables.addVar(i,parms[0])}}}else if(parms.length===context.emptySlots){for(i=1;i<=parms.length;i+=1){outer.variables.addVar(i,parms[i-1])}}else if(context.emptySlots!==1){throw new Error(localize("expecting")+" "+context.emptySlots+" "+localize("input(s), but getting")+" "+parms.length)}}}if(runnable.expression instanceof CommandBlockMorph){runnable.expression=runnable.expression.blockSequence();if(!isCommand){if(caller){caller.tag="exit"}else{exit=new Context(runnable.parentContext,"expectReport",outer,outer.receiver);exit.tag="exit";runnable.parentContext=exit}}}};Process.prototype.fork=function(context,args){if(this.readyToTerminate){return}var proc=new Process,stage=this.homeContext.receiver.parentThatIsA(StageMorph);proc.instrument=this.instrument;proc.receiver=this.receiver;proc.initializeFor(context,args);stage.threads.processes.push(proc)};Process.prototype.initializeFor=function(context,args){if(context.isContinuation){throw new Error("continuations cannot be forked")}if(!(context instanceof Context)){throw new Error(localize("expecting a")+" "+localize("ring")+" "+localize("but getting a")+" "+localize(this.reportTypeOf(context)))}var outer=new Context(null,null,context.outerContext),runnable=new Context(null,context.expression,outer),parms=args.itemsArray(),i,value;this.context=context.receiver;outer.variables.addVar(Symbol.for("arguments"),args);if(parms.length>0){for(i=0;i<context.inputs.length;i+=1){value=0;if(!isNil(parms[i])){value=parms[i]}outer.variables.addVar(context.inputs[i],value)}if(context.inputs.length===0){if(parms.length===1){for(i=1;i<=context.emptySlots;i+=1){outer.variables.addVar(i,parms[0])}}else if(parms.length===context.emptySlots){for(i=1;i<=parms.length;i+=1){outer.variables.addVar(i,parms[i-1])}}else if(context.emptySlots!==1){throw new Error(localize("expecting")+" "+context.emptySlots+" "+localize("input(s), but getting")+" "+parms.length)}}}if(runnable.expression instanceof CommandBlockMorph){runnable.expression=runnable.expression.blockSequence()}this.homeContext=new Context;this.homeContext.receiver=context.outerContext.receiver;this.topBlock=context.expression;this.context=runnable};Process.prototype.reportThisContext=function(){var sym=Symbol.for("self"),frame=this.context.variables.silentFind(sym),ctx;if(frame){return frame.vars[sym].value}ctx=this.topBlock.reify();ctx.outerContext=this.context.outerContext;if(ctx.outerContext){ctx.variables.parentFrame=ctx.outerContext.variables}return ctx};Process.prototype.doStopBlock=function(){var target=this.context.expression.exitTag;if(isNil(target)){return this.doStopCustomBlock()}while(this.context&&(isNil(this.context.tag)||this.context.tag>target)){if(this.context.expression==="doStopWarping"){this.doStopWarping()}else{this.popContext()}}this.pushContext()};Process.prototype.doStopCustomBlock=function(){while(this.context&&!this.context.isCustomBlock){if(this.context.expression==="doStopWarping"){this.doStopWarping()}else{this.popContext()}}};Process.prototype.doCallCC=function(aContext,isReporter){this.evaluate(aContext,new List([this.context.continuation(isReporter)]),!isReporter)};Process.prototype.reportCallCC=function(aContext){this.doCallCC(aContext,true)};Process.prototype.runContinuation=function(aContext,args){var parms=args.itemsArray();if(aContext.expression==="expectReport"&&parms.length){this.stop();this.homeContext.inputs[0]=parms[0];return}this.context.parentContext=aContext.copyForContinuationCall();if(parms.length===1){this.context.parentContext.outerContext.variables.addVar(1,parms[0])}};Process.prototype.evaluateCustomBlock=function(){var caller=this.context.parentContext,block=this.context.expression,method=block.isGlobal?block.definition:this.blockReceiver().getMethod(block.semanticSpec),context=method.body,declarations=method.declarations,args=new List(this.context.inputs),parms=args.itemsArray(),runnable,exit,i,value,outer,self;if(!context){return null}this.procedureCount+=1;outer=new Context;outer.receiver=this.context.receiver;outer.variables.parentFrame=block.variables;if(method.variableNames.length){block.variables.parentFrame=outer.receiver?outer.receiver.variables:null}else{outer.variables.parentFrame=outer.receiver?outer.receiver.variables:null}runnable=new Context(this.context.parentContext,context.expression,outer,outer.receiver);runnable.isCustomBlock=true;this.context.parentContext=runnable;self=copy(context);self.outerContext=outer;if(parms.length>0){for(i=0;i<context.inputs.length;i+=1){value=0;if(!isNil(parms[i])){value=parms[i]}outer.variables.addVar(context.inputs[i],value);if(declarations.get(context.inputs[i])[0]==="%upvar"){this.context.outerContext.variables.vars[value]=outer.variables.vars[context.inputs[i]]}}}if(method.type!=="command"){if(caller){caller.tag="exit"}else{exit=new Context(runnable.parentContext,"expectReport",outer,outer.receiver);exit.tag="exit";runnable.parentContext=exit}this.readyToYield=this.currentTime-this.lastYield>this.timeout}else{runnable.expression.tagExitBlocks(this.procedureCount,true);if(caller&&!caller.tag){caller.tag=this.procedureCount}if(!this.isAtomic&&method.isDirectlyRecursive()){this.readyToYield=true}}outer.variables.addVar(Symbol.for("self"),self);runnable.expression=runnable.expression.blockSequence()};Process.prototype.doDeclareVariables=function(varNames){var varFrame=this.context.outerContext.variables;varNames.itemsArray().forEach(name=>varFrame.addVar(name))};Process.prototype.doSetVar=function(varName,value){var varFrame=this.context.variables,name=varName;if(name instanceof Context){if(name.expression.selector==="reportGetVar"){name.variables.setVar(name.expression.blockSpec,value,this.blockReceiver());return}this.doSet(name,value);return}if(name instanceof Array){this.doSet(name,value);return}varFrame.setVar(name,value,this.blockReceiver())};Process.prototype.doChangeVar=function(varName,value){var varFrame=this.context.variables,name=varName;this.assertType(value,"number");if(name instanceof Context){if(name.expression.selector==="reportGetVar"){name.variables.changeVar(name.expression.blockSpec,value,this.blockReceiver());return}}varFrame.changeVar(name,value,this.blockReceiver())};Process.prototype.reportGetVar=function(){return this.context.variables.getVar(this.context.expression.blockSpec)};Process.prototype.doShowVar=function(varName,context){var varFrame=(context||(this.context||this.homeContext)).variables,stage,watcher,target,label,others,isGlobal,name=varName;if(name instanceof Context){if(name.expression.selector==="reportGetVar"){name=name.expression.blockSpec}else{this.blockReceiver().changeBlockVisibility(name.expression,false);return}}if(this.homeContext.receiver){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){target=varFrame.silentFind(name);if(!target){return}watcher=detect(stage.children,morph=>morph instanceof WatcherMorph&&morph.target===target&&morph.getter===name);if(watcher!==null){watcher.show();watcher.fixLayout();return}isGlobal=contains(this.homeContext.receiver.globalVariables().names(),varName);if(isGlobal||target.owner){label=name}else{label=name+" "+localize("(temporary)")}watcher=new WatcherMorph(label,SpriteMorph.prototype.blockColor.variables,target,name);watcher.setPosition(stage.position().add(10));others=stage.watchers(watcher.left());if(others.length>0){watcher.setTop(others[others.length-1].bottom())}stage.add(watcher);watcher.fixLayout();watcher.rerender()}}};Process.prototype.doHideVar=function(varName,context){var varFrame=(context||this.context).variables,stage,watcher,target,name=varName;if(name instanceof Context){if(name.expression.selector==="reportGetVar"){name=name.expression.blockSpec}else{this.blockReceiver().changeBlockVisibility(name.expression,true);return}}if(!name){this.doRemoveTemporaries();return}if(this.homeContext.receiver){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){target=varFrame.find(name);watcher=detect(stage.children,morph=>morph instanceof WatcherMorph&&morph.target===target&&morph.getter===name);if(watcher!==null){if(watcher.isTemporary()){watcher.destroy()}else{watcher.hide()}}}}};Process.prototype.doRemoveTemporaries=function(){var stage;if(this.homeContext.receiver){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){stage.watchers().forEach(watcher=>{if(watcher.isTemporary()){watcher.destroy()}})}}};Process.prototype.doDeleteAttr=function(attrName){var name=attrName,rcvr=this.blockReceiver();if(name instanceof Context){if(name.expression.selector==="reportGetVar"){name=name.expression.blockSpec}else{name={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",size:"size"}[name.expression.selector];if(!isNil(name)){rcvr.inheritAttribute(name)}return}}if(name instanceof Array){return rcvr.inheritAttribute(this.inputOption(name))}if(contains(rcvr.inheritedVariableNames(true),name)){rcvr.deleteVariable(name)}};Process.prototype.doTellTo=function(sprite,context,args){this.doRun(this.reportAttributeOf(context,sprite),args)};Process.prototype.reportAskFor=function(sprite,context,args){this.evaluate(this.reportAttributeOf(context,sprite),args)};Process.prototype.reportNewList=function(elements){return elements};Process.prototype.reportCONS=function(car,cdr){this.assertType(cdr,"list");return(new List).cons(car,cdr)};Process.prototype.reportCDR=function(list){this.assertType(list,"list");return list.cdr()};Process.prototype.doAddToList=function(element,list){this.assertType(list,"list");if(list.type){this.assertType(element,list.type);list=this.shadowListAttribute(list)}list.add(element)};Process.prototype.doDeleteFromList=function(index,list){var idx=index;this.assertType(list,"list");if(list.type){list=this.shadowListAttribute(list)}if(this.inputOption(index)==="all"){return list.clear()}if(index===""){return null}if(this.inputOption(index)==="last"){idx=list.length()}else if(isNaN(+this.inputOption(index))){return null}list.remove(idx)};Process.prototype.doInsertInList=function(element,index,list){var idx=index;this.assertType(list,"list");if(list.type){this.assertType(element,list.type);list=this.shadowListAttribute(list)}if(index===""){return null}if(this.inputOption(index)==="any"){idx=this.reportBasicRandom(1,list.length()+1)}if(this.inputOption(index)==="last"){idx=list.length()+1}list.add(element,idx)};Process.prototype.doReplaceInList=function(index,list,element){var idx=index;this.assertType(list,"list");if(list.type){this.assertType(element,list.type);list=this.shadowListAttribute(list)}if(index===""){return null}if(this.inputOption(index)==="any"){idx=this.reportBasicRandom(1,list.length())}if(this.inputOption(index)==="last"){idx=list.length()}list.put(element,idx)};Process.prototype.shadowListAttribute=function(list){var rcvr;if(list.type==="costume"||list.type==="sound"){rcvr=this.blockReceiver();if(list===rcvr.costumes){rcvr.shadowAttribute("costumes");list=rcvr.costumes}else if(list===rcvr.sounds){rcvr.shadowAttribute("sounds");list=rcvr.sounds}}return list};Process.prototype.reportListItem=function(index,list){this.assertType(list,"list");if(index===""){return""}if(this.inputOption(index)==="any"){return list.at(this.reportBasicRandom(1,list.length()))}if(this.inputOption(index)==="last"){return list.at(list.length())}if(index instanceof List&&this.enableHyperOps){return list.query(index)}return list.at(index)};Process.prototype.reportTranspose=function(list){this.assertType(list,"list");return list.transpose()};Process.prototype.reportCrossproduct=function(lists){this.assertType(lists,"list");if(lists.isEmpty()){return lists}this.assertType(lists.at(1),"list");return lists.crossproduct()};Process.prototype.reportReshape=function(list,shape){this.assertType(shape,"list");list=list instanceof List?list:new List([list]);return list.reshape(shape)};Process.prototype.reportSlice=function(list,indices){this.assertType(list,"list");this.assertType(indices,"list");return list.slice(indices)};Process.prototype.reportListAttribute=function(choice,list){var option=this.inputOption(choice);switch(option){case"length":this.assertType(list,"list");return list.length();case"size":this.assertType(list,"list");return list.size();case"rank":return list instanceof List?list.rank():0;case"dimensions":return list instanceof List?list.shape():new List;case"flatten":return list instanceof List?list.ravel():new List([list]);case"columns":this.assertType(list,"list");return list.columns();case"transpose":this.assertType(list,"list");return list.transpose();case"reverse":this.assertType(list,"list");return list.reversed();case"lines":this.assertType(list,"list");if(list.canBeTXT()){return list.asTXT()}throw new Error(localize("unable to convert to")+" "+localize("lines"));case"csv":this.assertType(list,"list");if(list.canBeCSV()){return list.asCSV()}throw new Error(localize("unable to convert to")+" "+localize("CSV"));case"json":this.assertType(list,"list");if(list.canBeJSON()){return list.asJSON()}throw new Error(localize("unable to convert to")+" "+localize("JSON"));default:return 0}};Process.prototype.reportListLength=function(list){this.assertType(list,"list");return list.length()};Process.prototype.reportListIndex=function(element,list){this.assertType(list,"list");return list.indexOf(element)};Process.prototype.reportListContainsItem=function(list,element){this.assertType(list,"list");return list.contains(element)};Process.prototype.reportListIsEmpty=function(list){this.assertType(list,"list");return list.isEmpty()};Process.prototype.doShowTable=function(list){this.assertType(list,"list");new TableDialogMorph(list).popUp(this.blockReceiver().world())};Process.prototype.reportNumbers=function(start,end){if(this.enableHyperOps){return this.hyperDyadic((strt,stp)=>this.reportBasicNumbers(strt,stp),start,end)}return this.reportLinkedNumbers(start,end)};Process.prototype.reportBasicNumbers=function(start,end){var result,len,i,s=+start,e=+end,n=s;this.assertType(s,"number");this.assertType(e,"number");if(e>s){len=Math.floor(e-s);result=new Array(len);for(i=0;i<=len;i+=1){result[i]=n;n+=1}}else{len=Math.floor(s-e);result=new Array(len);for(i=0;i<=len;i+=1){result[i]=n;n-=1}}return new List(result)};Process.prototype.reportListCombination=function(choice,lists){var option=this.inputOption(choice);switch(option){case"append":return this.reportConcatenatedLists(lists);case"cross product":return this.reportCrossproduct(lists);default:return 0}};Process.prototype.reportConcatenatedLists=function(lists){var first,result,rows,row,rowIdx,cols,col;this.assertType(lists,"list");if(lists.isEmpty()){return lists}first=lists.at(1);this.assertType(first,"list");if(first.isLinked){return this.concatenateLinkedLists(lists)}result=[];rows=lists.length();for(rowIdx=1;rowIdx<=rows;rowIdx+=1){row=lists.at(rowIdx);this.assertType(row,"list");cols=row.length();for(col=1;col<=cols;col+=1){result.push(row.at(col))}}return new List(result)};Process.prototype.concatenateLinkedLists=function(lists){var first;if(lists.isEmpty()){return lists}first=lists.at(1);this.assertType(first,"list");if(lists.length()===1){return first}if(first.isEmpty()){return this.concatenateLinkedLists(lists.cdr())}return lists.cons(first.at(1),this.concatenateLinkedLists(lists.cons(first.cdr(),lists.cdr())))};Process.prototype.reportLinkedNumbers=function(start,end){var dta;if(this.context.accumulator===null){this.assertType(start,"number");this.assertType(end,"number");this.context.accumulator={target:new List,end:null,idx:+start,step:+end>+start?+1:-1};this.context.accumulator.target.isLinked=true;this.context.accumulator.end=this.context.accumulator.target}dta=this.context.accumulator;if(dta.step===1?dta.idx>+end:dta.idx<+end){dta.end.rest=new List;this.returnValueToParentContext(dta.target.cdr());return}dta.end.rest=dta.target.cons(dta.idx);dta.end=dta.end.rest;dta.idx+=dta.step;this.pushContext()};Process.prototype.doIf=function(){var args=this.context.inputs,outer=this.context.outerContext,isCustomBlock=this.context.isCustomBlock;this.popContext();if(args[0]){if(args[1]){this.pushContext(args[1].blockSequence(),outer);this.context.isCustomBlock=isCustomBlock}}this.pushContext()};Process.prototype.doIfElse=function(){var args=this.context.inputs,outer=this.context.outerContext,isCustomBlock=this.context.isCustomBlock;this.popContext();if(args[0]){if(args[1]){this.pushContext(args[1].blockSequence(),outer)}}else{if(args[2]){this.pushContext(args[2].blockSequence(),outer)}else{this.pushContext("doYield")}}if(this.context){this.context.isCustomBlock=isCustomBlock}this.pushContext()};Process.prototype.reportIfElse=function(block){var inputs=this.context.inputs,accumulator,condition,expression,trueIsBlock,falseIsBlock;if(inputs.length<1){this.evaluateNextInput(block);return}if(inputs[0]instanceof List&&this.enableHyperOps){if(this.context.accumulator===null){trueIsBlock=block.inputs()[1]instanceof BlockMorph;falseIsBlock=block.inputs()[2]instanceof BlockMorph;this.context.accumulator={results:[],trueIsLiteral:!trueIsBlock,trueCase:trueIsBlock?null:block.inputs()[1].evaluate(),falseIsLiteral:!falseIsBlock,falseCase:falseIsBlock?null:block.inputs()[2].evaluate()};if(!trueIsBlock&&!falseIsBlock){this.returnValueToParentContext(inputs[0].deepMap(leaf=>leaf?this.context.accumulator.trueCase:this.context.accumulator.falseCase));this.popContext();return}}else if(inputs.length>1){this.context.accumulator.results.push(inputs.pop())}accumulator=this.context.accumulator;if(accumulator.results.length===inputs[0].length()){this.returnValueToParentContext(new List(accumulator.results));this.popContext();return}condition=inputs[0].at(accumulator.results.length+1);if(!(condition instanceof List)){if(condition&&accumulator.trueIsLiteral){accumulator.results.push(accumulator.trueCase);return}if(!condition&&accumulator.falseIsLiteral){accumulator.results.push(accumulator.falseCase);return}}this.pushContext(block);this.context.addInput(condition);this.context.accumulator=copy(accumulator);this.context.accumulator.results=[];return}if(inputs.length>1){if(this.flashContext()){return}this.returnValueToParentContext(inputs.pop());this.popContext();return}if(inputs[0]){expression=block.inputs()[1]}else{expression=block.inputs()[2]}this.pushContext(expression)};Process.prototype.doStop=function(){this.stop()};Process.prototype.doStopAll=function(){var ide;if(this.homeContext.receiver){ide=this.homeContext.receiver.parentThatIsA(IDE_Morph);ide.scene.stop()}};Process.prototype.doStopAllScenes=function(){var ide;if(this.homeContext.receiver){ide=this.homeContext.receiver.parentThatIsA(IDE_Morph);ide.scenes.map(scn=>scn.stop(true))}};Process.prototype.doStopThis=function(choice){switch(this.inputOption(choice)){case"all":this.doStopAll();break;case"all scenes":this.doStopAllScenes();break;case"this script":this.doStop();break;case"this block":this.doStopBlock();break;default:this.doStopOthers(choice)}};Process.prototype.doStopOthers=function(choice){var stage;if(this.homeContext.receiver){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){switch(this.inputOption(choice)){case"all but this script":stage.threads.stopAll(this);break;case"other scripts in sprite":stage.threads.stopAllForReceiver(this.context.outerContext.receiver,this);break;default:nop()}}}};Process.prototype.doWarp=function(body){var outer=this.context.outerContext,isCustomBlock=this.context.isCustomBlock,stage;this.popContext();if(body){if(this.homeContext.receiver){if(this.homeContext.receiver.startWarp){this.homeContext.receiver.startWarp()}stage=this.homeContext.receiver.parentThatIsA(StageMorph)}this.pushContext("popContext");if(this.context){this.context.isCustomBlock=isCustomBlock}if(!this.isAtomic){this.pushContext("doStopWarping")}this.pushContext(body.blockSequence(),outer);this.isAtomic=true}this.pushContext()};Process.prototype.doStopWarping=function(){var stage;this.popContext();this.isAtomic=false;if(this.homeContext.receiver){if(this.homeContext.receiver.endWarp){this.homeContext.receiver.endWarp()}stage=this.homeContext.receiver.parentThatIsA(StageMorph)}};Process.prototype.reportIsFastTracking=function(){var ide;if(this.homeContext.receiver){ide=this.homeContext.receiver.parentThatIsA(IDE_Morph);if(ide){return ide.stage.isFastTracked}}return false};Process.prototype.doSetGlobalFlag=function(name,bool){var stage=this.homeContext.receiver.parentThatIsA(StageMorph);name=this.inputOption(name);this.assertType(bool,"Boolean");switch(name){case"turbo mode":this.doSetFastTracking(bool);break;case"flat line ends":SpriteMorph.prototype.useFlatLineEnds=bool;break;case"log pen vectors":StageMorph.prototype.enablePenLogging=bool;break;case"video capture":if(bool){this.startVideo(stage)}else{stage.stopProjection()}break;case"mirror video":stage.mirrorVideo=bool;break}};Process.prototype.reportGlobalFlag=function(name){var stage=this.homeContext.receiver.parentThatIsA(StageMorph);name=this.inputOption(name);switch(name){case"turbo mode":return this.reportIsFastTracking();case"flat line ends":return SpriteMorph.prototype.useFlatLineEnds;case"log pen vectors":return StageMorph.prototype.enablePenLogging;case"video capture":return!isNil(stage.projectionSource)&&stage.projectionLayer().getContext("2d").getImageData(0,0,1,1).data[3]>0;case"mirror video":return stage.mirrorVideo;default:return""}};Process.prototype.doSetFastTracking=function(bool){var ide;if(!this.reportIsA(bool,"Boolean")){return}if(this.homeContext.receiver){ide=this.homeContext.receiver.parentThatIsA(IDE_Morph);if(ide){if(bool){ide.startFastTracking()}else{ide.stopFastTracking()}}}};Process.prototype.doPauseAll=function(){var stage,ide;if(this.homeContext.receiver){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){stage.threads.pauseAll(stage)}ide=stage.parentThatIsA(IDE_Morph);if(ide){ide.controlBar.pauseButton.refresh()}}};Process.prototype.doForever=function(body){this.context.inputs=[];this.pushContext("doYield");if(body){this.pushContext(body.blockSequence())}this.pushContext()};Process.prototype.doRepeat=function(counter,body){var block=this.context.expression,outer=this.context.outerContext,isCustomBlock=this.context.isCustomBlock;if(isNaN(counter)||counter<1){return null}this.popContext();this.pushContext(block,outer);this.context.isCustomBlock=isCustomBlock;this.context.addInput(counter-1);this.pushContext("doYield");if(body){this.pushContext(body.blockSequence())}this.pushContext()};Process.prototype.doUntil=function(goalCondition,body){if(goalCondition){this.popContext();this.pushContext("doYield");return null}this.context.inputs=[];this.pushContext("doYield");if(body){this.pushContext(body.blockSequence())}this.pushContext()};Process.prototype.doWaitUntil=function(goalCondition){if(goalCondition){this.popContext();this.pushContext("doYield");return null}this.context.inputs=[];this.pushContext("doYield");this.pushContext()};Process.prototype.doForEach=function(upvar,list,script){var next;if(this.context.accumulator===null){this.assertType(list,"list");this.context.accumulator={source:list,remaining:list.length(),idx:0}}if(this.context.accumulator.remaining===0){return}this.context.accumulator.remaining-=1;if(this.context.accumulator.source.isLinked){next=this.context.accumulator.source.at(1);this.context.accumulator.source=this.context.accumulator.source.cdr()}else{this.context.accumulator.idx+=1;next=this.context.accumulator.source.at(this.context.accumulator.idx)}this.pushContext("doYield");this.pushContext();this.context.outerContext.variables.addVar(upvar);this.context.outerContext.variables.setVar(upvar,next);this.evaluate(script,new List,true)};Process.prototype.doFor=function(upvar,start,end,script){var vars=this.context.outerContext.variables,dta=this.context.accumulator;if(dta===null){this.assertType(start,"number");this.assertType(end,"number");dta=this.context.accumulator={test:+start<+end?()=>vars.getVar(upvar)>+end:()=>vars.getVar(upvar)<+end,step:+start<+end?1:-1,parms:new List};vars.addVar(upvar);vars.setVar(upvar,Math.floor(+start))}else{vars.changeVar(upvar,dta.step)}if(dta.test()){return}this.pushContext("doYield");this.pushContext();this.evaluate(script,dta.parms,true)};Process.prototype.reportMap=function(reporter,list){var next,index,parms;if(list.isLinked){if(this.context.accumulator===null){this.assertType(list,"list");this.context.accumulator={source:list,idx:1,target:new List,end:null,remaining:list.length()};this.context.accumulator.target.isLinked=true;this.context.accumulator.end=this.context.accumulator.target}else if(this.context.inputs.length>2){this.context.accumulator.end.rest=list.cons(this.context.inputs.pop());this.context.accumulator.end=this.context.accumulator.end.rest;this.context.accumulator.idx+=1;this.context.accumulator.remaining-=1}if(this.context.accumulator.remaining===0){this.context.accumulator.end.rest=list.cons(this.context.inputs[2]).cdr();this.returnValueToParentContext(this.context.accumulator.target.cdr());return}index=this.context.accumulator.idx;next=this.context.accumulator.source.at(1);this.context.accumulator.source=this.context.accumulator.source.cdr()}else{if(this.context.accumulator===null){this.assertType(list,"list");this.context.accumulator=[]}else if(this.context.inputs.length>2){this.context.accumulator.push(this.context.inputs.pop())}if(this.context.accumulator.length===list.length()){this.returnValueToParentContext(new List(this.context.accumulator));return}index=this.context.accumulator.length+1;next=list.at(index)}this.pushContext();parms=[next];if(reporter.inputs.length>1){parms.push(index)}if(reporter.inputs.length>2){parms.push(list)}this.evaluate(reporter,new List(parms))};Process.prototype.reportKeep=function(predicate,list){var next,index,parms;if(list.isLinked){if(this.context.accumulator===null){this.assertType(list,"list");this.context.accumulator={source:list,idx:1,target:new List,end:null,remaining:list.length()};this.context.accumulator.target.isLinked=true;this.context.accumulator.end=this.context.accumulator.target}else if(this.context.inputs.length>2){if(this.context.inputs.pop()===true){this.context.accumulator.end.rest=list.cons(this.context.accumulator.source.at(1));this.context.accumulator.end=this.context.accumulator.end.rest}this.context.accumulator.remaining-=1;this.context.accumulator.idx+=1;this.context.accumulator.source=this.context.accumulator.source.cdr()}if(this.context.accumulator.remaining===0){this.context.accumulator.end.rest=new List;this.returnValueToParentContext(this.context.accumulator.target.cdr());return}index=this.context.accumulator.idx;next=this.context.accumulator.source.at(1)}else{if(this.context.accumulator===null){this.assertType(list,"list");this.context.accumulator={idx:0,target:[]}}else if(this.context.inputs.length>2){if(this.context.inputs.pop()===true){this.context.accumulator.target.push(list.at(this.context.accumulator.idx))}}if(this.context.accumulator.idx===list.length()){this.returnValueToParentContext(new List(this.context.accumulator.target));return}this.context.accumulator.idx+=1;index=this.context.accumulator.idx;next=list.at(index)}this.pushContext();parms=[next];if(predicate.inputs.length>1){parms.push(index)}if(predicate.inputs.length>2){parms.push(list)}this.evaluate(predicate,new List(parms))};Process.prototype.reportFindFirst=function(predicate,list){var next,index,parms;if(list.isLinked){if(this.context.accumulator===null){this.assertType(list,"list");this.context.accumulator={source:list,idx:1,remaining:list.length()}}else if(this.context.inputs.length>2){if(this.context.inputs.pop()===true){this.returnValueToParentContext(this.context.accumulator.source.at(1));return}this.context.accumulator.remaining-=1;this.context.accumulator.idx+=1;this.context.accumulator.source=this.context.accumulator.source.cdr()}if(this.context.accumulator.remaining===0){this.returnValueToParentContext("");return}index=this.context.accumulator.idx;next=this.context.accumulator.source.at(1)}else{if(this.context.accumulator===null){this.assertType(list,"list");this.context.accumulator={idx:0,current:null}}else if(this.context.inputs.length>2){if(this.context.inputs.pop()===true){this.returnValueToParentContext(this.context.accumulator.current);return}}if(this.context.accumulator.idx===list.length()){this.returnValueToParentContext("");return}this.context.accumulator.idx+=1;index=this.context.accumulator.idx;next=list.at(index);this.context.accumulator.current=next}this.pushContext();parms=[next];if(predicate.inputs.length>1){parms.push(index)}if(predicate.inputs.length>2){parms.push(list)}this.evaluate(predicate,new List(parms))};Process.prototype.reportCombine=function(list,reporter){var next,current,index,parms;this.assertType(list,"list");if(list.isLinked){if(this.context.accumulator===null){if(this.canRunOptimizedForCombine(reporter)){return this.reportListAggregation(list,reporter.expression.selector)}if(list.length()<2){this.returnValueToParentContext(list.length()?list.at(1):0);return}this.context.accumulator={source:list.cdr(),idx:1,target:list.at(1),remaining:list.length()-1}}else if(this.context.inputs.length>2){this.context.accumulator.target=this.context.inputs.pop();this.context.accumulator.remaining-=1;this.context.accumulator.idx+=1;this.context.accumulator.source=this.context.accumulator.source.cdr()}if(this.context.accumulator.remaining===0){this.returnValueToParentContext(this.context.accumulator.target);return}next=this.context.accumulator.source.at(1)}else{if(this.context.accumulator===null){if(this.canRunOptimizedForCombine(reporter)){return this.reportListAggregation(list,reporter.expression.selector)}if(list.length()<2){this.returnValueToParentContext(list.length()?list.at(1):0);return}this.context.accumulator={idx:1,target:list.at(1)}}else if(this.context.inputs.length>2){this.context.accumulator.target=this.context.inputs.pop()}if(this.context.accumulator.idx===list.length()){this.returnValueToParentContext(this.context.accumulator.target);return}this.context.accumulator.idx+=1;next=list.at(this.context.accumulator.idx)}index=this.context.accumulator.idx;current=this.context.accumulator.target;this.pushContext();parms=[current,next];if(reporter.inputs.length>2){parms.push(index)}if(reporter.inputs.length>3){parms.push(list)}this.evaluate(reporter,new List(parms))};Process.prototype.reportListAggregation=function(list,selector){var len=list.length(),result,i,op;op={reportVariadicSum:"reportSum",reportVariadicProduct:"reportProduct",reportVariadicMin:"reportMin",reportVariadicMax:"reportMax"}[selector]||selector;if(len===0){switch(op){case"reportProduct":return 1;case"reportMin":return Infinity;case"reportMax":return-Infinity;default:return 0}}result=list.at(1);if(len>1){for(i=2;i<=len;i+=1){result=this[op](result,list.at(i))}}return result};Process.prototype.canRunOptimizedForCombine=function(aContext){var op=aContext.expression.selector,slots,eligible;if(!op){return false}eligible=["reportVariadicSum","reportVariadicProduct","reportVariadicMin","reportVariadicMax"];if(!contains(eligible,op)){return false}slots=aContext.expression.inputs()[0].inputs();if(slots.length!==2){return false}if(aContext.inputs.length===0){return slots.every(each=>each.bindingID)}if(aContext.inputs.length!==2){return false}return slots.every(each=>each.selector==="reportGetVar"&&contains(aContext.inputs,each.blockSpec))};Process.prototype.doWait=function(secs){if(!this.context.startTime){this.context.startTime=Date.now()}if(Date.now()-this.context.startTime>=secs*1e3){if(!this.isAtomic&&secs===0){this.readyToYield=true}return null}this.pushContext("doYield");this.pushContext()};Process.prototype.doGlide=function(secs,endX,endY){if(!this.context.startTime){this.context.startTime=Date.now();this.context.startValue=new Point(this.blockReceiver().xPosition(),this.blockReceiver().yPosition())}if(Date.now()-this.context.startTime>=secs*1e3){this.blockReceiver().gotoXY(endX,endY);return null}this.blockReceiver().glide(secs*1e3,endX,endY,Date.now()-this.context.startTime,this.context.startValue);this.pushContext("doYield");this.pushContext()};Process.prototype.doSayFor=function(data,secs){if(!this.context.startTime){this.context.startTime=Date.now();this.blockReceiver().bubble(data)}if(Date.now()-this.context.startTime>=secs*1e3){this.blockReceiver().stopTalking();return null}this.pushContext("doYield");this.pushContext()};Process.prototype.doThinkFor=function(data,secs){if(!this.context.startTime){this.context.startTime=Date.now();this.blockReceiver().doThink(data)}if(Date.now()-this.context.startTime>=secs*1e3){this.blockReceiver().stopTalking();return null}this.pushContext("doYield");this.pushContext()};Process.prototype.blockReceiver=function(){return this.context?this.context.receiver||this.homeContext.receiver:this.homeContext.receiver||this.receiver};Process.prototype.playSound=function(name){if(name instanceof List){return this.doPlaySoundAtRate(name,44100)}return this.blockReceiver().doPlaySound(name)};Process.prototype.doPlaySoundUntilDone=function(name){if(this.context.activeAudio===null){this.context.activeAudio=this.playSound(name)}if(name===null||this.context.activeAudio.ended||this.context.activeAudio.terminated){return null}this.pushContext("doYield");this.pushContext()};Process.prototype.doStopAllSounds=function(){var stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){stage.threads.processes.forEach(thread=>{if(thread.context){thread.context.stopMusic();if(thread.context.activeAudio){thread.popContext()}}});stage.stopAllActiveSounds()}};Process.prototype.doPlaySoundAtRate=function(name,rate){var sound,samples,ctx,gain,pan,source,rcvr;if(!(name instanceof List)){sound=name instanceof Sound?name:typeof name==="number"?this.blockReceiver().sounds.at(name):detect(this.blockReceiver().sounds.asArray(),s=>s.name===name.toString());if(!sound.audioBuffer){this.decodeSound(sound);return}samples=this.reportGetSoundAttribute("samples",sound)}else{samples=name}rcvr=this.blockReceiver();ctx=rcvr.audioContext();gain=rcvr.getGainNode();pan=rcvr.getPannerNode();source=this.encodeSound(samples,rate);rcvr.setVolume(rcvr.volume);source.connect(gain);if(pan){gain.connect(pan);pan.connect(ctx.destination);rcvr.setPan(rcvr.pan)}else{gain.connect(ctx.destination)}source.pause=source.stop;source.ended=false;source.onended=()=>source.ended=true;source.start();rcvr.parentThatIsA(StageMorph).activeSounds.push(source);return source};Process.prototype.reportGetSoundAttribute=function(choice,soundName){var sound=soundName instanceof Sound?soundName:typeof soundName==="number"?this.blockReceiver().sounds.at(soundName):soundName instanceof List?this.encodeSound(soundName):detect(this.blockReceiver().sounds.asArray(),s=>s.name===soundName.toString()),option=this.inputOption(choice);if(option==="name"){return sound.name}if(!sound.audioBuffer){this.decodeSound(sound);return}switch(option){case"samples":if(!sound.cachedSamples){sound.cachedSamples=function(sound,untype){var buf=sound.audioBuffer,result,i;if(buf.numberOfChannels>1){result=new List;for(i=0;i<buf.numberOfChannels;i+=1){result.add(new List(untype(buf.getChannelData(i))))}return result}return new List(untype(buf.getChannelData(0)))}(sound,this.untype)}return sound.cachedSamples;case"sample rate":return sound.audioBuffer.sampleRate;case"duration":return sound.audioBuffer.duration;case"length":return sound.audioBuffer.length;case"number of channels":return sound.audioBuffer.numberOfChannels;default:return 0}};Process.prototype.decodeSound=function(sound,callback){var base64,binaryString,len,bytes,i,arrayBuffer,audioCtx;if(sound.audioBuffer){return(callback||nop)(sound)}if(!sound.isDecoding){base64=sound.audio.src.split(",")[1];binaryString=window.atob(base64);len=binaryString.length;bytes=new Uint8Array(len);for(i=0;i<len;i+=1){bytes[i]=binaryString.charCodeAt(i)}arrayBuffer=bytes.buffer;audioCtx=Note.prototype.getAudioContext();sound.isDecoding=true;audioCtx.decodeAudioData(arrayBuffer,buffer=>{sound.audioBuffer=buffer;sound.isDecoding=false},err=>{sound.isDecoding=false;this.handleError(err)})}this.pushContext("doYield");this.pushContext()};Process.prototype.encodeSound=function(samples,rate){var rcvr=this.blockReceiver(),ctx=rcvr.audioContext(),channels=samples.at(1)instanceof List?samples.length():1,frameCount=channels===1?samples.length():samples.at(1).length(),arrayBuffer=ctx.createBuffer(channels,frameCount,+rate||44100),i,source;if(!arrayBuffer.copyToChannel){arrayBuffer.copyToChannel=function(src,channel){var buffer=this.getChannelData(channel);for(i=0;i<src.length;i+=1){buffer[i]=src[i]}}}if(channels===1){arrayBuffer.copyToChannel(Float32Array.from(samples.itemsArray()),0,0)}else{for(i=0;i<channels;i+=1){arrayBuffer.copyToChannel(Float32Array.from(samples.at(i+1).itemsArray()),i,0)}}source=ctx.createBufferSource();source.buffer=arrayBuffer;source.audioBuffer=source.buffer;return source};Process.prototype.reportNewSoundFromSamples=function(samples,rate){var audio,blob,reader;if(isNil(this.context.accumulator)){this.assertType(samples,"list");this.context.accumulator={audio:null};audio=new Audio;blob=new Blob([this.audioBufferToWav(this.encodeSound(samples,rate||44100).audioBuffer)],{type:"audio/wav"});reader=new FileReader;reader.onload=()=>{audio.src=reader.result;this.context.accumulator.audio=audio};reader.readAsDataURL(blob)}if(this.context.accumulator.audio){return new Sound(this.context.accumulator.audio,this.blockReceiver().newSoundName(localize("sound")))}this.pushContext("doYield");this.pushContext()};Process.prototype.audioBufferToWav=function(buffer,opt){var numChannels=buffer.numberOfChannels,sampleRate=buffer.sampleRate,format=(opt||{}).float32?3:1,bitDepth=format===3?32:16,result;function interleave(inputL,inputR){var length=inputL.length+inputR.length,result=new Float32Array(length),index=0,inputIndex=0;while(index<length){result[index++]=inputL[inputIndex];result[index++]=inputR[inputIndex];inputIndex+=1}return result}if(numChannels===2){result=interleave(buffer.getChannelData(0),buffer.getChannelData(1))}else{result=buffer.getChannelData(0)}return this.encodeWAV(result,format,sampleRate,numChannels,bitDepth)};Process.prototype.encodeWAV=function(samples,format,sampleRate,numChannels,bitDepth){var bytesPerSample=bitDepth/8,blockAlign=numChannels*bytesPerSample,buffer=new ArrayBuffer(44+samples.length*bytesPerSample),view=new DataView(buffer);function writeFloat32(output,offset,input){for(var i=0;i<input.length;i+=1,offset+=4){output.setFloat32(offset,input[i],true)}}function floatTo16BitPCM(output,offset,input){var i,s;for(i=0;i<input.length;i+=1,offset+=2){s=Math.max(-1,Math.min(1,input[i]));output.setInt16(offset,s<0?s*32768:s*32767,true)}}function writeString(view,offset,string){for(var i=0;i<string.length;i+=1){view.setUint8(offset+i,string.charCodeAt(i))}}writeString(view,0,"RIFF");view.setUint32(4,36+samples.length*bytesPerSample,true);writeString(view,8,"WAVE");writeString(view,12,"fmt ");view.setUint32(16,16,true);view.setUint16(20,format,true);view.setUint16(22,numChannels,true);view.setUint32(24,sampleRate,true);view.setUint32(28,sampleRate*blockAlign,true);view.setUint16(32,blockAlign,true);view.setUint16(34,bitDepth,true);writeString(view,36,"data");view.setUint32(40,samples.length*bytesPerSample,true);if(format===1){floatTo16BitPCM(view,44,samples)}else{writeFloat32(view,44,samples)}return buffer};Process.prototype.reportAudio=function(choice){var stage=this.blockReceiver().parentThatIsA(StageMorph),selection=this.inputOption(choice);if(selection==="resolution"){return stage.microphone.binSize()}if(selection==="modifier"){return stage.microphone.modifier}if(stage.microphone.isOn()){switch(selection){case"volume":return stage.microphone.volume*100;case"frequency":return stage.microphone.pitch;case"note":return stage.microphone.note;case"samples":return new List(this.untype(stage.microphone.signals));case"sample rate":return stage.microphone.audioContext.sampleRate;case"output":return new List(this.untype(stage.microphone.output));case"spectrum":return new List(this.untype(stage.microphone.frequencies));default:return null}}this.pushContext("doYield");this.pushContext()};Process.prototype.untype=function(typedArray){var len=typedArray.length,arr=new Array(len),i;for(i=0;i<len;i+=1){arr[i]=typedArray[i]}return arr};Process.prototype.setMicrophoneModifier=function(modifier){var stage=this.blockReceiver().parentThatIsA(StageMorph),invalid=["sprite","stage","list","costume","sound","number","text","Boolean"];if(!modifier||contains(invalid,this.reportTypeOf(modifier))){stage.microphone.modifier=null;stage.microphone.stop();return}stage.microphone.modifier=modifier;stage.microphone.compiledModifier=this.reportCompiled(modifier,1);stage.microphone.compilerProcess=this};Process.prototype.doAsk=function(data){var stage=this.homeContext.receiver.parentThatIsA(StageMorph),rcvr=this.blockReceiver(),isStage=rcvr instanceof StageMorph,isHiddenSprite=rcvr instanceof SpriteMorph&&!rcvr.isVisible,activePrompter,leftSpace,rightSpace;stage.keysPressed={};if(!data){stage.threads.processes.filter(proc=>proc.prompter&&!proc.prompter.isDone||proc?.context?.expression?.selector==="doAsk"&&proc!==this).forEach(proc=>proc.stop());stage.lastAnswer="";return}if(!this.prompter){activePrompter=detect(stage.children,morph=>morph instanceof StagePrompterMorph||morph instanceof StagePickerMorph);if(!activePrompter){if(data instanceof List){if(!isStage){rcvr.stopTalking()}this.prompter=new StagePickerMorph(data);this.prompter.createItems(stage.scale);leftSpace=rcvr.left()-stage.left();rightSpace=stage.right()-rcvr.right();if(isStage){this.prompter.popup(stage,stage.center().subtract(this.prompter.extent().floorDivideBy(2)))}else{this.prompter.popup(stage,rightSpace>this.prompter.width()||rightSpace>=leftSpace?rcvr.topRight():rcvr.topLeft().subtract(new Point(this.prompter.width(),0)))}}else{if(!isStage&&!isHiddenSprite){rcvr.bubble(data,false,true)}this.prompter=new StagePrompterMorph(isStage||isHiddenSprite?data:null);if(stage.scale<1){this.prompter.setWidth(stage.width()-10)}else{this.prompter.setWidth(stage.dimensions.x-20)}this.prompter.fixLayout();this.prompter.setCenter(stage.center());this.prompter.setBottom(stage.bottom()-this.prompter.border);stage.add(this.prompter);this.prompter.inputField.edit();stage.changed()}}}else{if(this.prompter.isDone){stage.lastAnswer=this.prompter.answer;this.prompter.destroy();this.prompter=null;if(!isStage){rcvr.stopTalking()}return null}}this.pushContext("doYield");this.pushContext()};Process.prototype.reportLastAnswer=function(){return this.homeContext.receiver.parentThatIsA(StageMorph).lastAnswer};Process.prototype.reportURL=function(url){var response;url=decodeURI(url);this.checkURLAllowed(url);if(!this.httpRequest){if(url.indexOf("//")<0||url.indexOf("//")>8){if(location.protocol==="file:"){url="https://"+url}else{url=location.protocol+"//"+url}}this.httpRequest=new XMLHttpRequest;this.httpRequest.open("GET",url,true);this.httpRequest.send(null);if(this.context.isCustomCommand){this.httpRequest=null;return null}}else if(this.httpRequest.readyState===4){response=this.httpRequest.responseText;this.httpRequest=null;return response}this.pushContext("doYield");this.pushContext()};Process.prototype.checkURLAllowed=function(url){if(["users","logout","projects","collections"].some(pathPart=>{return Object.values(Cloud.prototype.knownDomains).filter(each=>each.includes("snap")).some(domain=>url.match(new RegExp(`${new URL(domain).host}.*${pathPart}`,"i")))})){throw new Error("Request blocked")}};Process.prototype.doBroadcast=function(message,options){var stage=this.homeContext.receiver.parentThatIsA(StageMorph),target=this.inputOption(options.at(1)||["all"]),payload=options.at(2),thisObj,msg=this.inputOption(message),rcvrs,procs=[];if(!this.canBroadcast){return[]}if(msg==="__shout__go__"&&target==="all"){stage.removeAllClones()}thisObj=this.blockReceiver();if(target==="all"){rcvrs=stage.children.concat(stage)}else if(isSnapObject(target)){rcvrs=[target]}else if(isString(target)){if(target===stage.name){rcvrs=[stage]}else{rcvrs=[this.getOtherObject(target,thisObj,stage)]}}else if(target instanceof List){rcvrs=target.itemsArray().map(each=>this.getOtherObject(each,thisObj,stage))}else{return}if(msg!==""){stage.lastMessage=message;rcvrs.forEach(morph=>{if(isSnapObject(morph)){morph.allHatBlocksFor(msg).forEach(block=>{var choice,varName,varFrame;if(block.selector==="receiveMessage"){varName=block.inputs()[1].evaluate()[0];if(varName){varFrame=new VariableFrame;choice=block.inputs()[0].evaluate();if(choice instanceof Array&&choice[0].indexOf("any")===0){varFrame.addVar(varName,payload!==""?new List([message,payload]):message)}else{varFrame.addVar(varName,payload)}}procs.push(stage.threads.startProcess(block,morph,stage.isThreadSafe,null,null,null,null,null,varFrame))}else{procs.push(stage.threads.startProcess(block,morph,stage.isThreadSafe))}})}});(stage.messageCallbacks[""]||[]).forEach(callback=>callback(msg));(stage.messageCallbacks[msg]||[]).forEach(callback=>callback())}return procs};Process.prototype.doBroadcastAndWait=function(message,target){if(!this.context.activeSends){this.context.activeSends=this.doBroadcast(message,target);if(this.isRunning()){this.context.activeSends.forEach(proc=>proc.runStep())}}this.context.activeSends=this.context.activeSends.filter(proc=>proc.isRunning());if(this.context.activeSends.length===0){return null}this.pushContext("doYield");this.pushContext()};Process.prototype.getLastMessage=function(){var stage;if(this.homeContext.receiver){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){return stage.getLastMessage()}}return""};Process.prototype.reportIsA=function(thing,typeString){return this.reportTypeOf(thing)===this.inputOption(typeString)};Process.prototype.assertType=function(thing,typeString){var thingType=this.reportTypeOf(thing);if(thingType===typeString){return true}if(typeString instanceof Array&&contains(typeString,thingType)){return true}throw new Error(localize("expecting a")+" "+(typeString instanceof Array?typeString.reduce((a,b)=>localize(a)+" / "+localize(b)):localize(typeString))+" "+localize("but getting a")+" "+localize(thingType))};Process.prototype.assertAlive=function(thing){if(thing&&thing.isCorpse){throw new Error("cannot operate on a deleted sprite")}};Process.prototype.reportTypeOf=function(thing){var exp;if(thing===null||thing===undefined){return"nothing"}if(thing===true||thing===false){return"Boolean"}if(thing instanceof List){return"list"}if(parseFloat(thing)===+thing){return"number"}if(isString(thing)){return"text"}if(thing instanceof SpriteMorph){return"sprite"}if(thing instanceof StageMorph){return"stage"}if(thing instanceof Costume){return"costume"}if(thing instanceof Sound){return"sound"}if(thing instanceof Context){if(thing.expression instanceof RingMorph){return thing.expression.dataType()}if(thing.expression instanceof ReporterBlockMorph){if(thing.expression.isPredicate){return"predicate"}return"reporter"}if(thing.expression instanceof Array){exp=thing.expression[thing.pc||0];if(exp.isPredicate){return"predicate"}if(exp instanceof RingMorph){return exp.dataType()}if(exp instanceof ReporterBlockMorph){return"reporter"}if(exp instanceof CommandBlockMorph){return"command"}return"reporter"}if(thing.expression instanceof CommandBlockMorph){return"command"}return"reporter"}return"undefined"};Process.prototype.hyperDyadic=function(baseOp,a,b){var len,i,result;if(this.enableHyperOps){if(this.isMatrix(a)){if(this.isMatrix(b)){a=a.itemsArray();b=b.itemsArray();len=Math.min(a.length,b.length);result=new Array(len);for(i=0;i<len;i+=1){result[i]=this.hyperDyadic(baseOp,a[i],b[i])}return new List(result)}return a.map(each=>this.hyperDyadic(baseOp,each,b))}if(this.isMatrix(b)){return b.map(each=>this.hyperDyadic(baseOp,a,each))}return this.hyperZip(baseOp,a,b)}return baseOp(a,b)};Process.prototype.hyperZip=function(baseOp,a,b){var len,i,result;if(a instanceof List){if(b instanceof List){a=a.itemsArray();b=b.itemsArray();len=Math.min(a.length,b.length);result=new Array(len);for(i=0;i<len;i+=1){result[i]=this.hyperZip(baseOp,a[i],b[i])}return new List(result)}return a.map(each=>this.hyperZip(baseOp,each,b))}if(b instanceof List){return b.map(each=>this.hyperZip(baseOp,a,each))}return baseOp(a,b)};Process.prototype.isMatrix=function(data){return data instanceof List&&data.at(1)instanceof List};Process.prototype.reportVariadicSum=function(numbers){this.assertType(numbers,"list");return this.reportListAggregation(numbers,"reportSum")};Process.prototype.reportSum=function(a,b){return this.hyperDyadic(this.reportBasicSum,a,b)};Process.prototype.reportBasicSum=function(a,b){return+a+ +b};Process.prototype.reportDifference=function(a,b){return this.hyperDyadic(this.reportBasicDifference,a,b)};Process.prototype.reportBasicDifference=function(a,b){return+a-+b};Process.prototype.reportVariadicProduct=function(numbers){this.assertType(numbers,"list");return this.reportListAggregation(numbers,"reportProduct")};Process.prototype.reportProduct=function(a,b){return this.hyperDyadic(this.reportBasicProduct,a,b)};Process.prototype.reportBasicProduct=function(a,b){return+a*+b};Process.prototype.reportQuotient=function(a,b){return this.hyperDyadic(this.reportBasicQuotient,a,b)};Process.prototype.reportBasicQuotient=function(a,b){return+a/+b};Process.prototype.reportPower=function(a,b){return this.hyperDyadic(this.reportBasicPower,a,b)};Process.prototype.reportBasicPower=function(a,b){return Math.pow(+a,+b)};Process.prototype.reportRandom=function(a,b){return this.hyperDyadic(this.reportBasicRandom,a,b)};Process.prototype.reportBasicRandom=function(min,max){var floor=Math.min(+min,+max),ceil=Math.max(+min,+max);if(floor%1!==0||ceil%1!==0){return Math.random()*(ceil-floor)+floor}return Math.floor(Math.random()*(ceil-floor+1))+floor};Process.prototype.reportModulus=function(a,b){return this.hyperDyadic(this.reportBasicModulus,a,b)};Process.prototype.reportBasicModulus=function(a,b){var x=+a,y=+b;return(x%y+y)%y};Process.prototype.reportAtan2=function(a,b){return this.hyperDyadic(this.reportBasicAtan2,a,b)};Process.prototype.reportBasicAtan2=function(a,b){return degrees(Math.atan2(+a,+b))};Process.prototype.reportVariadicMin=function(numbers){this.assertType(numbers,"list");return this.reportListAggregation(numbers,"reportMin")};Process.prototype.reportMin=function(a,b){return this.hyperDyadic(this.reportBasicMin,a,b)};Process.prototype.reportBasicMin=function(a,b){var x=+a,y=+b;if(isNaN(x)||isNaN(y)){x=a;y=b}return x<y?x:y};Process.prototype.reportVariadicMax=function(numbers){this.assertType(numbers,"list");return this.reportListAggregation(numbers,"reportMax")};Process.prototype.reportMax=function(a,b){return this.hyperDyadic(this.reportBasicMax,a,b)};Process.prototype.reportBasicMax=function(a,b){var x=+a,y=+b;if(isNaN(x)||isNaN(y)){x=a;y=b}return x>y?x:y};Process.prototype.reportLessThan=function(a,b){return this.hyperDyadic(this.reportBasicLessThan,a,b)};Process.prototype.reportLessThanOrEquals=function(a,b){return this.hyperDyadic((a,b)=>!this.reportBasicGreaterThan(a,b),a,b)};Process.prototype.reportBasicLessThan=function(a,b){var x=+a,y=+b;if(isNaN(x)||isNaN(y)){x=a;y=b}return x<y};Process.prototype.reportGreaterThan=function(a,b){return this.hyperDyadic(this.reportBasicGreaterThan,a,b)};Process.prototype.reportGreaterThanOrEquals=function(a,b){return this.hyperDyadic((a,b)=>!this.reportBasicLessThan(a,b),a,b)};Process.prototype.reportBasicGreaterThan=function(a,b){var x=+a,y=+b;if(isNaN(x)||isNaN(y)){x=a;y=b}return x>y};Process.prototype.reportEquals=function(a,b){return snapEquals(a,b)};Process.prototype.reportNotEquals=function(a,b){return!snapEquals(a,b)};Process.prototype.reportNot=function(bool){if(this.enableHyperOps){if(bool instanceof List){return bool.map(each=>this.reportNot(each))}}return!bool};Process.prototype.reportIsIdentical=function(a,b){var tag="idTag";if(isString(a)&&isString(b)){return a===b}if(this.isImmutable(a)||this.isImmutable(b)){return snapEquals(a,b)}function clear(){if(Object.prototype.hasOwnProperty.call(a,tag)){delete a[tag]}if(Object.prototype.hasOwnProperty.call(b,tag)){delete b[tag]}}clear();a[tag]=Date.now();if(b[tag]===a[tag]){clear();return true}clear();return false};Process.prototype.isImmutable=function(obj){var type=this.reportTypeOf(obj);return type==="nothing"||type==="Boolean"||type==="text"||type==="number"||type==="undefined"};Process.prototype.reportBoolean=function(bool){return bool};Process.prototype.reportRound=function(n){if(this.enableHyperOps){if(n instanceof List){return n.map(each=>this.reportRound(each))}}return Math.round(+n)};Process.prototype.reportMonadic=function(fname,n){if(this.enableHyperOps){if(n instanceof List){return n.map(each=>this.reportMonadic(fname,each))}}var x=+n,result=0;switch(this.inputOption(fname)){case"abs":result=Math.abs(x);break;case"neg":result=n*-1;break;case"sign":result=Math.sign(x);break;case"ceiling":result=Math.ceil(x);break;case"floor":result=Math.floor(x);break;case"sqrt":result=Math.sqrt(x);break;case"sin":result=Math.sin(radians(x));break;case"cos":result=Math.cos(radians(x));break;case"tan":result=Math.tan(radians(x));break;case"asin":result=degrees(Math.asin(x));break;case"acos":result=degrees(Math.acos(x));break;case"atan":result=degrees(Math.atan(x));break;case"ln":result=Math.log(x);break;case"log":result=Math.log10(x);break;case"lg":result=Math.log2(x);break;case"e^":result=Math.exp(x);break;case"10^":result=Math.pow(10,x);break;case"2^":result=Math.pow(2,x);break;case"id":return n;default:nop()}return result};Process.prototype.reportTextFunction=function(fname,string){var x=(isNil(string)?"":string).toString(),result="";switch(this.inputOption(fname)){case"encode URI":result=encodeURI(x);break;case"decode URI":result=decodeURI(x);break;case"encode URI component":result=encodeURIComponent(x);break;case"decode URI component":result=decodeURIComponent(x);break;case"XML escape":result=(new XML_Element).escape(x);break;case"XML unescape":result=(new XML_Element).unescape(x);break;case"hex sha512 hash":result=hex_sha512(x);break;default:nop()}return result};Process.prototype.reportJoin=function(a,b){var x=(isNil(a)?"":a).toString(),y=(isNil(b)?"":b).toString();return x.concat(y)};Process.prototype.reportJoinWords=function(aList){if(aList instanceof List){if(this.isAST(aList)){return this.assemble(aList)}return aList.asText()}return(aList||"").toString()};Process.prototype.isAST=function(aList){var first=aList.at(1);if(first instanceof Context){return true}if(first instanceof List){return first.at(1)instanceof Context}return false};Process.prototype.reportLetter=function(idx,string){return this.hyperDyadic((ix,str)=>this.reportBasicLetter(ix,str),idx,string)};Process.prototype.reportBasicLetter=function(idx,string){var str,i;str=isNil(string)?"":string.toString();if(this.inputOption(idx)==="any"){idx=this.reportBasicRandom(1,str.length)}if(this.inputOption(idx)==="last"){idx=str.length}i=+(idx||0);return str[i-1]||""};Process.prototype.reportStringSize=function(data){if(this.enableHyperOps){if(data instanceof List){return data.map(each=>this.reportStringSize(each))}}if(data instanceof List){return data.length()}return isNil(data)?0:Array.from(data.toString()).length};Process.prototype.reportUnicode=function(string){var str,unicodeList;if(this.enableHyperOps){if(string instanceof List){return string.map(each=>this.reportUnicode(each))}str=isNil(string)?"\0":string.toString();unicodeList=Array.from(str);if(unicodeList.length>1){return this.reportUnicode(new List(unicodeList))}}else{str=isNil(string)?"\0":string.toString()}if(str.codePointAt){return str.codePointAt(0)||0}return str.charCodeAt(0)||0};Process.prototype.reportUnicodeAsLetter=function(num){if(this.enableHyperOps){if(num instanceof List){return num.map(each=>this.reportUnicodeAsLetter(each))}}var code=+(num||0);if(String.fromCodePoint){return String.fromCodePoint(code)}return String.fromCharCode(code)};Process.prototype.reportTextSplit=function(string,delimiter){if(this.inputOption(delimiter)==="blocks"){this.assertType(string,["command","reporter","predicate"]);return string.components()}return this.hyperDyadic((str,delim)=>this.reportBasicTextSplit(str,delim),string,delimiter)};Process.prototype.reportBasicTextSplit=function(string,delimiter){var types=["text","number"],strType=this.reportTypeOf(string),delType=this.reportTypeOf(this.inputOption(delimiter)),str,del;if(!contains(types,strType)){throw new Error(localize("expecting a")+" "+localize("text")+" "+localize("but getting a")+" "+localize(strType))}if(!contains(types,delType)){throw new Error(localize("expecting a")+" "+localize("text")+" "+localize("but getting a")+" "+localize(delType))}str=isNil(string)?"":string.toString();switch(this.inputOption(delimiter)){case"line":del=/\r\n|[\n\v\f\r\x85\u2028\u2029]/;break;case"tab":del="\t";break;case"cr":del="\r";break;case"word":case"whitespace":str=str.trim();del=/\s+/;break;case"":case"letter":return new List(Array.from(str));case"csv":return this.parseCSV(string);case"json":return this.parseJSON(string);default:del=delimiter.toString()}return new List(str.split(del))};Process.prototype.parseCSV=function(text){return this.rawParseCSV(text,this.guessDelimiterCSV(text))};Process.prototype.guessDelimiterCSV=function(text){var delims=[",",";","|","\t"],len=delims.length,firstLine=text.split("\n")[0],i;for(i=0;i<len;i+=1){if(this.rawParseCSV(firstLine,delims[i]).length()>1){return delims[i]}}return delims[0]};Process.prototype.rawParseCSV=function(text,delim){var prev="",fields=[""],records=[fields],col=0,r=0,esc=true,len=text.length,idx,char;delim=delim||",";for(idx=0;idx<len;idx+=1){char=text[idx];if(char==='"'){if(esc&&char===prev){fields[col]+=char}esc=!esc}else if(char===delim&&esc){char="";col+=1;fields[col]=char}else if(char==="\r"&&esc){r+=1;records[r]=[""];fields=records[r];col=0}else if(char==="\n"&&esc){if(prev!=="\r"){r+=1;records[r]=[""];fields=records[r];col=0}}else{fields[col]+=char}prev=char}if(records[records.length-1].length===1&&records[records.length-1][0]===""){records.pop()}records=new List(records.map(row=>new List(row)));if(records.length()===1){return records.at(1)}return records};Process.prototype.parseJSON=function(string){function listify(jsonObject){if(jsonObject instanceof Array){return new List(jsonObject.map(function(eachElement){return listify(eachElement)}))}else if(jsonObject instanceof Object){return new List(Object.keys(jsonObject).map(function(eachKey){return new List([eachKey,listify(jsonObject[eachKey])])}))}else{return jsonObject}}return listify(JSON.parse(string))};Process.prototype.assemble=function(blocks){var first;if(!(blocks instanceof List)){return blocks}first=blocks.at(1);if(first instanceof Context){return first.copyWithInputs(blocks.cdr().map(each=>this.assemble(each)))}if(blocks.isEmpty()){return blocks}if(this.reportIsA(blocks.at(1),"number")){return blocks.map(each=>this.assemble(each))}return blocks.map(each=>this.assemble(each)).itemsArray().reduce((a,b)=>a.copyWithNext(b))};Process.prototype.alert=function(data){var world;if(this.homeContext.receiver){world=this.homeContext.receiver.world();if(world.isDevMode){alert("Snap! "+data.itemsArray())}}};Process.prototype.log=function(data){var world;if(this.homeContext.receiver){world=this.homeContext.receiver.world();if(world.isDevMode){console.log("Snap! "+data.itemsArray())}}};Process.prototype.getOtherObject=function(name,thisObj,stageObj){if(isSnapObject(name)){return name}if(this.inputOption(name)==="myself"){return thisObj}var stage=isNil(stageObj)?thisObj.parentThatIsA(StageMorph):stageObj,thatObj=null;if(stage){thatObj=detect(stage.children,morph=>morph.name===name);if(!thatObj){thatObj=detect(stage.world().hand.children,morph=>morph instanceof SpriteMorph&&morph.name===name)}}return thatObj};Process.prototype.getObjectsNamed=function(name,thisObj,stageObj){var stage=isNil(stageObj)?thisObj.parentThatIsA(StageMorph):stageObj,those=[];function check(obj){return obj instanceof SpriteMorph&&obj.isTemporary?obj.cloneOriginName===name:obj.name===name}if(stage){those=stage.children.filter(check);if(!those.length){those=stage.world().hand.children.filter(check)}}return those};Process.prototype.setHeading=function(direction){var thisObj=this.blockReceiver();if(thisObj){if(this.inputOption(direction)==="random"){direction=this.reportBasicRandom(1,36e3)/100}thisObj.setHeading(direction)}};Process.prototype.doFaceTowards=function(name){var thisObj=this.blockReceiver(),thatObj;if(thisObj){if(this.inputOption(name)==="center"){thisObj.faceToXY(0,0)}else if(this.inputOption(name)==="mouse-pointer"){thisObj.faceToXY(this.reportMouseX(),this.reportMouseY())}else if(this.inputOption(name)==="random position"){thisObj.setHeading(this.reportBasicRandom(1,36e3)/100)}else{if(name instanceof List){thisObj.faceToXY(name.at(1),name.at(2));return}thatObj=this.getOtherObject(name,this.homeContext.receiver);if(thatObj){thisObj.faceToXY(thatObj.xPosition(),thatObj.yPosition())}}}};Process.prototype.doGotoObject=function(name){var thisObj=this.blockReceiver(),thatObj,stage;if(thisObj){if(this.inputOption(name)==="center"){thisObj.gotoXY(0,0)}else if(this.inputOption(name)==="mouse-pointer"){thisObj.gotoXY(this.reportMouseX(),this.reportMouseY())}else if(this.inputOption(name)==="random position"){stage=thisObj.parentThatIsA(StageMorph);if(stage){thisObj.setCenter(new Point(this.reportBasicRandom(stage.left(),stage.right()),this.reportBasicRandom(stage.top(),stage.bottom())))}}else{if(name instanceof List){thisObj.gotoXY(name.at(1),name.at(2));return}thatObj=this.getOtherObject(name,this.homeContext.receiver);if(thatObj){thisObj.gotoXY(thatObj.xPosition(),thatObj.yPosition())}}}};Process.prototype.goToLayer=function(name){var option=this.inputOption(name),thisObj=this.blockReceiver();if(thisObj instanceof SpriteMorph){if(option==="front"){thisObj.comeToFront()}else if(option==="back"){thisObj.goToBack()}}};Process.prototype.doSwitchToScene=function(id,transmission){var rcvr=this.blockReceiver(),idx=0,message=this.inputOption(transmission.at(1)),payload=transmission.at(2),ide,scenes,num,scene;this.assertAlive(rcvr);this.assertType(message,["text","number","Boolean","list"]);this.assertType(payload,["text","number","Boolean","list"]);if(message instanceof List){if(message.canBeJSON()){message=message.deepMap(leaf=>leaf)}else{throw new Error(localize("cannot send media,\nsprites or procedures\nto another scene"))}}if(payload instanceof List){if(payload.canBeJSON()){payload=payload.deepMap(leaf=>leaf)}else{throw new Error(localize("cannot send media,\nsprites or procedures\nto another scene"))}}if(this.readyToTerminate){return}ide=rcvr.parentThatIsA(IDE_Morph);scenes=ide.scenes;if(id instanceof Array){switch(this.inputOption(id)){case"next":idx=scenes.indexOf(ide.scene)+1;if(idx>scenes.length()){idx=1}break;case"previous":idx=scenes.indexOf(ide.scene)-1;if(idx<1){idx=scenes.length()}break;case"random":idx=this.reportBasicRandom(1,scenes.length());break}this.stop();ide.switchToScene(scenes.at(idx),null,message,payload);return}scene=detect(scenes.itemsArray(),scn=>scn.name===id);if(scene===null){num=parseFloat(id);if(isNaN(num)){return}scene=scenes.at(num)}this.stop();ide.switchToScene(scene,null,message,payload)};Process.prototype.setColorDimension=function(name,num){var options=["hue","saturation","brightness","transparency"],choice=this.inputOption(name);if(choice==="r-g-b(-a)"){this.blockReceiver().setColorRGBA(num);return}this.blockReceiver().setColorDimension(options.indexOf(choice),+num)};Process.prototype.changeColorDimension=function(name,num){var options=["hue","saturation","brightness","transparency"],choice=this.inputOption(name);if(choice==="r-g-b(-a)"){this.blockReceiver().changeColorRGBA(num);return}this.blockReceiver().changeColorDimension(options.indexOf(choice),+num)};Process.prototype.setPenColorDimension=Process.prototype.setColorDimension;Process.prototype.changePenColorDimension=Process.prototype.changeColorDimension;Process.prototype.setBackgroundColorDimension=Process.prototype.setColorDimension;Process.prototype.changeBackgroundColorDimension=Process.prototype.changeColorDimension;Process.prototype.doPasteOn=function(name){this.blitOn(name,"source-atop")};Process.prototype.doCutFrom=function(name){this.blitOn(name,"destination-out")};Process.prototype.blitOn=function(name,mask,thisObj,stage){var those;thisObj=thisObj||this.blockReceiver();stage=stage||thisObj.parentThatIsA(StageMorph);if(stage.name===name){name=stage}if(isSnapObject(name)){return thisObj.blitOn(name,mask)}if(name instanceof List){those=name.itemsArray()}else{those=this.getObjectsNamed(name,thisObj,stage)}those.forEach(each=>{if(!each.inheritsAttribute("costume #")){this.blitOn(each,mask,thisObj,stage)}})};Process.prototype.createClone=function(name){var thisObj=this.blockReceiver(),thatObj;if(!name||this.readyToTerminate){return}if(thisObj){if(this.inputOption(name)==="myself"){thisObj.createClone(!this.isFirstStep)}else{thatObj=this.getOtherObject(name,thisObj);if(thatObj){thatObj.createClone(!this.isFirstStep)}}}};Process.prototype.newClone=function(name){var thisObj=this.blockReceiver(),thatObj;if(!name){return}if(thisObj){if(this.inputOption(name)==="myself"){return thisObj.newClone(!this.isFirstStep)}thatObj=this.getOtherObject(name,thisObj);if(thatObj){return thatObj.newClone(!this.isFirstStep)}}};Process.prototype.reportTouchingObject=function(name){var thisObj=this.blockReceiver();if(thisObj){return this.objectTouchingObject(thisObj,name)}return false};Process.prototype.objectTouchingObject=function(thisObj,name){var those,stage,box,mouse;if(this.inputOption(name)==="mouse-pointer"){mouse=thisObj.world().hand.position();if(thisObj.bounds.containsPoint(mouse)&&!thisObj.isTransparentAt(mouse)){return true}}else{stage=thisObj.parentThatIsA(StageMorph);if(stage){if(this.inputOption(name)==="edge"){box=thisObj.bounds;if(!thisObj.costume&&thisObj.penBounds){box=thisObj.penBounds.translateBy(thisObj.position())}if(!stage.bounds.containsRectangle(box)){return true}}if(this.inputOption(name)==="pen trails"&&thisObj.isTouching(stage.penTrailsMorph())){return true}if(isSnapObject(name)){return name.isVisible&&thisObj.isTouching(name)}if(name instanceof List){those=name.itemsArray()}else{those=this.getObjectsNamed(name,thisObj,stage)}if(those.some(any=>any.isVisible&&thisObj.isTouching(any))){return true}}}return thisObj.parts.some(any=>this.objectTouchingObject(any,name))};Process.prototype.reportAspect=function(aspect,location){if(this.enableHyperOps){if(location instanceof List&&!this.isCoordinate(location)){return location.map(each=>this.reportAspect(aspect,each))}}var choice=this.inputOption(aspect),target=this.inputOption(location),options=["hue","saturation","brightness","transparency"],idx=options.indexOf(choice),thisObj=this.blockReceiver(),thatObj,stage=thisObj.parentThatIsA(StageMorph),world=thisObj.world(),point,clr;if(target==="myself"){if(choice==="sprites"){if(thisObj instanceof StageMorph){point=thisObj.center()}else{point=thisObj.rotationCenter()}return this.spritesAtPoint(point,stage)}else{clr=this.colorAtSprite(thisObj)}}else if(target==="mouse-pointer"){if(choice==="sprites"){return this.spritesAtPoint(world.hand.position(),stage)}else{clr=world.getGlobalPixelColor(world.hand.position())}}else if(target instanceof List){point=new Point(target.at(1)*stage.scale+stage.center().x,stage.center().y-target.at(2)*stage.scale);if(choice==="sprites"){return this.spritesAtPoint(point,stage)}else{clr=world.getGlobalPixelColor(point)}}else{if(!target){return}thatObj=this.getOtherObject(target,thisObj,stage);if(thatObj){if(choice==="sprites"){point=thatObj instanceof SpriteMorph?thatObj.rotationCenter():thatObj.center();return this.spritesAtPoint(point,stage)}else{clr=this.colorAtSprite(thatObj)}}else{return}}if(choice==="r-g-b-a"){return new List([clr.r,clr.g,clr.b,Math.round(clr.a*255)])}if(idx<0||idx>3){return}if(idx===3){return(1-clr.a)*100}return clr[SpriteMorph.prototype.penColorModel]()[idx]*100};Process.prototype.colorAtSprite=function(sprite){var point=sprite instanceof SpriteMorph?sprite.rotationCenter():sprite.center(),stage=sprite.parentThatIsA(StageMorph),child,i;if(!stage){return BLACK}for(i=stage.children.length;i>0;i-=1){child=stage.children[i-1];if(child!==sprite&&child.isVisible&&child.bounds.containsPoint(point)&&!child.isTransparentAt(point)){return child.getPixelColor(point)}}if(stage.bounds.containsPoint(point)){return stage.getPixelColor(point)}return BLACK};Process.prototype.colorBelowSprite=function(sprite){var point=sprite instanceof SpriteMorph?sprite.rotationCenter():sprite.center(),stage=sprite.parentThatIsA(StageMorph),below=stage,found=false,child,i;if(!stage){return BLACK}for(i=0;i<stage.children.length;i+=1){if(!found){child=stage.children[i];if(child===sprite){found=true}else if(child.isVisible&&child.bounds.containsPoint(point)&&!child.isTransparentAt(point)){below=child}}}if(below.bounds.containsPoint(point)){return below.getPixelColor(point)}return BLACK};Process.prototype.spritesAtPoint=function(point,stage){return new List(stage.children.filter(morph=>morph instanceof SpriteMorph&&morph.isVisible&&morph.bounds.containsPoint(point)&&!morph.isTransparentAt(point)))};Process.prototype.reportRelationTo=function(relation,name){if(this.enableHyperOps){if(name instanceof List&&!this.isCoordinate(name)){return name.map(each=>this.reportRelationTo(relation,each))}}var rel=this.inputOption(relation);if(rel==="distance"){return this.reportDistanceTo(name)}if(rel==="ray length"){return this.reportRayLengthTo(name)}if(rel==="direction"){return this.reportDirectionTo(name)}return 0};Process.prototype.isCoordinate=function(data){return data instanceof List&&data.length()===2&&this.reportTypeOf(data.at(1))==="number"&&this.reportTypeOf(data.at(2))==="number"};Process.prototype.reportDistanceTo=function(name){var thisObj=this.blockReceiver(),thatObj,stage,rc,point;if(thisObj){rc=thisObj.rotationCenter();point=rc;if(this.inputOption(name)==="mouse-pointer"){point=thisObj.world().hand.position()}else if(this.inputOption(name)==="center"){return new Point(thisObj.xPosition(),thisObj.yPosition()).distanceTo(ZERO)}else if(name instanceof List){return new Point(thisObj.xPosition(),thisObj.yPosition()).distanceTo(new Point(name.at(1),name.at(2)))}stage=thisObj.parentThatIsA(StageMorph);thatObj=this.getOtherObject(name,thisObj,stage);if(thatObj){point=thatObj.rotationCenter()}return rc.distanceTo(point)/stage.scale}return 0};Process.prototype.reportRayLengthTo=function(name){var thisObj=this.blockReceiver(),thatObj,stage,rc,targetBounds,intersections=[],dir,a,b,x,y,top,bottom,left,right,circa,hSect,vSect,point,hit,temp,width,imageData;circa=num=>Math.round(num*1e7)/1e7;hSect=yLevel=>{var theta=radians(dir);b=rc.y-yLevel;a=b*Math.tan(theta);x=rc.x+a;if(circa(x)===circa(rc.x)&&(dir===180&&rc.y<yLevel||dir===0&&rc.y>yLevel)||x>rc.x&&dir>=0&&dir<180||circa(x)<circa(rc.x)&&dir>=180&&dir<360){if(x>=left&&x<=right){intersections.push(new Point(x,yLevel))}}};vSect=xLevel=>{var theta=radians(360-dir-90);b=rc.x-xLevel;a=b*Math.tan(theta);y=rc.y+a;if(circa(y)===circa(rc.y)&&(dir===90&&rc.x<xLevel||dir===270&&rc.x>xLevel)||y>rc.y&&dir>=90&&dir<270||y<rc.y&&(dir>=270||dir<90)){if(y>=top&&y<=bottom){intersections.push(new Point(xLevel,y))}}};if(!thisObj){return-1}rc=thisObj.rotationCenter();point=rc;stage=thisObj.parentThatIsA(StageMorph);thatObj=this.getOtherObject(name,thisObj,stage);if(!(thatObj instanceof SpriteMorph)){return-1}dir=thisObj.heading;targetBounds=thatObj.bounds;top=targetBounds.top();bottom=targetBounds.bottom();left=targetBounds.left();right=targetBounds.right();if(targetBounds.containsPoint(rc)){intersections.push(rc);hSect(top);hSect(bottom);vSect(left);vSect(right);if(intersections.length<2){return-1}}else{hSect(top);hSect(bottom);vSect(left);vSect(right);if(intersections.length<2){return-1}if(dir!==90){if(Math.sign(rc.x-intersections[0].x)!==Math.sign(intersections[0].x-intersections[1].x)||Math.sign(rc.y-intersections[0].y)!==Math.sign(intersections[0].y-intersections[1].y)){temp=intersections[0];intersections[0]=intersections[1];intersections[1]=temp}}}intersections=intersections.map(point=>point.subtract(targetBounds.origin).floorDivideBy(stage.scale));width=Math.floor(targetBounds.width()/stage.scale);imageData=thatObj.getImageData();function alphaAt(imageData,width,x,y){var idx=y*width+x;return imageData[idx]&&255}function isOpaque(x,y){return alphaAt(imageData,width,x,y)>0}function scan(testFunc,x0,y0,x1,y1){var dx=Math.abs(x1-x0),sx=x0<x1?1:-1,dy=-Math.abs(y1-y0),sy=y0<y1?1:-1,err=dx+dy,e2;while(true){if(testFunc(x0,y0)){return new Point(x0*stage.scale,y0*stage.scale)}if(x0===x1&&y0===y1){return-1}e2=2*err;if(e2>dy){err+=dy;x0+=sx}if(e2<dx){err+=dx;y0+=sy}}}hit=scan(isOpaque,intersections[0].x,intersections[0].y,intersections[1].x,intersections[1].y);if(hit===-1){return hit}return rc.distanceTo(hit.add(targetBounds.origin))/stage.scale};Process.prototype.reportDirectionTo=function(name){var thisObj=this.blockReceiver(),thatObj;if(thisObj){if(this.inputOption(name)==="mouse-pointer"){return thisObj.angleToXY(this.reportMouseX(),this.reportMouseY())}if(this.inputOption(name)==="center"){return thisObj.angleToXY(0,0)}if(name instanceof List){return thisObj.angleToXY(name.at(1),name.at(2))}thatObj=this.getOtherObject(name,this.homeContext.receiver);if(thatObj){return thisObj.angleToXY(thatObj.xPosition(),thatObj.yPosition())}return thisObj.direction()}return 0};Process.prototype.reportAttributeOf=function(attribute,name){return this.hyperDyadic((att,obj)=>this.reportBasicAttributeOf(att,obj),attribute,name)};Process.prototype.reportBasicAttributeOf=function(attribute,name){var thisObj=this.blockReceiver(),thatObj,stage;if(name instanceof Context&&attribute instanceof Context){return this.reportContextFor(attribute,name)}if(thisObj){this.assertAlive(thisObj);stage=thisObj.parentThatIsA(StageMorph);if(name instanceof Context){thatObj=name}else if(stage.name===name){thatObj=stage}else{thatObj=this.getOtherObject(name,thisObj,stage)}if(isSnapObject(thatObj)){this.assertAlive(thatObj);if(attribute instanceof BlockMorph){return this.reportContextFor(this.reify(thatObj.getMethod(attribute.semanticSpec).blockInstance(),new List),thatObj)}if(attribute instanceof Context){return this.reportContextFor(attribute,thatObj)}if(isString(attribute)){return thatObj.variables.getVar(attribute)}switch(this.inputOption(attribute)){case"position":return thatObj.xPosition?new List([thatObj.xPosition(),thatObj.yPosition()]):"";case"x position":return thatObj.xPosition?thatObj.xPosition():"";case"y position":return thatObj.yPosition?thatObj.yPosition():"";case"direction":return thatObj.direction?thatObj.direction():"";case"costume #":return thatObj.getCostumeIdx();case"costume name":return thatObj.costume?thatObj.costume.name:thatObj instanceof SpriteMorph?localize("Turtle"):localize("Empty");case"size":return thatObj.getScale?thatObj.getScale():"";case"volume":return thatObj.getVolume();case"balance":return thatObj.getPan();case"width":if(thatObj instanceof StageMorph){return thatObj.dimensions.x}this.assertType(thatObj,"sprite");return thatObj.width()/stage.scale;case"height":if(thatObj instanceof StageMorph){return thatObj.dimensions.y}this.assertType(thatObj,"sprite");return thatObj.height()/stage.scale;case"left":return thatObj.xLeft();case"right":return thatObj.xRight();case"top":return thatObj.yTop();case"bottom":return thatObj.yBottom()}}if(isString(attribute)){return thatObj.outerContext.variables.getVar(attribute)}if(this.inputOption(attribute)==="variables"){return new List((thatObj instanceof Context?thatObj.outerContext:thatObj).variables.allNames())}}return""};Process.prototype.reportGet=function(query){var thisObj=this.blockReceiver(),stage,objName;function allOtherSprites(){var stage=thisObj.parentThatIsA(StageMorph),sprites=stage.children.filter(each=>each instanceof SpriteMorph&&each!==thisObj),inHand=stage.world().hand.children[0];if(inHand instanceof SpriteMorph){sprites.push(inHand)}return sprites}if(thisObj){switch(this.inputOption(query)){case"self":return thisObj;case"other sprites":return new List(allOtherSprites());case"parts":return new List((thisObj.parts||[]).map(each=>each));case"anchor":return thisObj.anchor||"";case"parent":return thisObj.exemplar||"";case"children":return new List(thisObj.specimens?thisObj.specimens():[]);case"temporary?":return thisObj.isTemporary||false;case"clones":objName=thisObj.name||thisObj.cloneOriginName;return new List(allOtherSprites().filter(each=>each.isTemporary&&each.cloneOriginName===objName));case"other clones":return thisObj.isTemporary?this.reportGet(["clones"]):new List;case"neighbors":return thisObj.neighbors();case"dangling?":return!thisObj.rotatesWithAnchor;case"draggable?":return thisObj.isDraggable;case"rotation style":return thisObj.rotationStyle||0;case"rotation x":return thisObj.xPosition();case"rotation y":return thisObj.yPosition();case"center x":return thisObj.xCenter();case"center y":return thisObj.yCenter();case"left":return thisObj.xLeft();case"right":return thisObj.xRight();case"top":return thisObj.yTop();case"bottom":return thisObj.yBottom();case"name":return thisObj.name;case"stage":return thisObj.parentThatIsA(StageMorph);case"scripts":return new List(thisObj.scripts.children.filter(each=>each instanceof BlockMorph).map(each=>each.fullCopy().reify()));case"blocks":return new List(thisObj.parentThatIsA(StageMorph).globalBlocks.concat(thisObj.allBlocks(true)).filter(def=>!def.isHelper).map(def=>def.blockInstance().reify()).concat(SpriteMorph.prototype.categories.reduce((blocks,category)=>blocks.concat(thisObj.getPrimitiveTemplates(category).filter(each=>each instanceof BlockMorph&&!(each instanceof HatBlockMorph)).map(block=>{let instance=block.fullCopy();instance.isTemplate=false;return instance.reify()})),[])));case"categories":return new List(SpriteMorph.prototype.allCategories());case"costume":return thisObj.costume;case"costumes":return thisObj.reportCostumes();case"sounds":return thisObj.sounds;case"width":if(thisObj instanceof StageMorph){return thisObj.dimensions.x}stage=thisObj.parentThatIsA(StageMorph);return stage?thisObj.width()/stage.scale:0;case"height":if(thisObj instanceof StageMorph){return thisObj.dimensions.y}stage=thisObj.parentThatIsA(StageMorph);return stage?thisObj.height()/stage.scale:0}}return""};Process.prototype.reportObject=function(name){if(this.enableHyperOps){if(name instanceof List){return name.map(each=>this.reportObject(each))}}var thisObj=this.blockReceiver(),thatObj,stage;if(thisObj){this.assertAlive(thisObj);stage=thisObj.parentThatIsA(StageMorph);if(stage.name===name){thatObj=stage}else{thatObj=this.getOtherObject(name,thisObj,stage)}if(thatObj){this.assertAlive(thatObj)}return thatObj}};Process.prototype.doSet=function(attribute,value){var name,rcvr,ide;rcvr=this.blockReceiver();this.assertAlive(rcvr);if(!(attribute instanceof Context||attribute instanceof Array)||attribute instanceof Context&&attribute.expression.selector!=="reportGet"){throw new Error(localize("unsupported attribute"))}name=attribute instanceof Context?attribute.expression.inputs()[0].evaluate():attribute;if(name instanceof Array){name=name[0]}switch(name){case"anchor":case"my anchor":this.assertType(rcvr,"sprite");if(value instanceof SpriteMorph){if(!rcvr.enableNesting||contains(rcvr.allParts(),value)){throw new Error(localize("unable to nest\n(disabled or circular?)"))}value.attachPart(rcvr)}else{rcvr.detachFromAnchor()}break;case"parent":case"my parent":this.assertType(rcvr,"sprite");value=value instanceof SpriteMorph?value:null;rcvr.setExemplar(value,true);break;case"temporary?":case"my temporary?":this.assertType(rcvr,"sprite");this.assertType(value,"Boolean");if(value){rcvr.release()}else{rcvr.perpetuate()}break;case"name":case"my name":this.assertType(rcvr,["sprite","stage"]);this.assertType(value,["text","number"]);ide=rcvr.parentThatIsA(IDE_Morph);if(ide){rcvr.setName(ide.newSpriteName(value.toString(),rcvr));ide.spriteBar.nameField.setContents(ide.currentSprite.name.toString())}break;case"dangling?":case"my dangling?":this.assertType(rcvr,"sprite");this.assertType(value,"Boolean");rcvr.rotatesWithAnchor=!value;rcvr.version=Date.now();break;case"draggable?":case"my draggable?":this.assertType(rcvr,"sprite");this.assertType(value,"Boolean");rcvr.isDraggable=value;ide=rcvr.parentThatIsA(IDE_Morph);if(ide){ide.spriteBar.children.forEach(each=>{if(each.refresh){each.refresh()}})}rcvr.version=Date.now();break;case"rotation style":case"my rotation style":this.assertType(rcvr,"sprite");this.assertType(+value,"number");if(!contains([0,1,2],+value)){return}rcvr.changed();rcvr.rotationStyle=+value;rcvr.fixLayout();rcvr.rerender();ide=rcvr.parentThatIsA(IDE_Morph);if(ide){ide.spriteBar.children.forEach(each=>{if(each.refresh){each.refresh()}})}rcvr.version=Date.now();break;case"rotation x":case"my rotation x":this.assertType(rcvr,"sprite");this.assertType(value,"number");rcvr.setRotationX(value);break;case"rotation y":case"my rotation y":this.assertType(rcvr,"sprite");this.assertType(value,"number");rcvr.setRotationY(value);break;case"microphone modifier":this.setMicrophoneModifier(value);break;default:throw new Error('"'+localize(name)+'" '+localize("is read-only"))}};Process.prototype.reportContextFor=function(context,otherObj){var result=copy(context),receiverVars,rootVars;if(otherObj instanceof Context){result.outerContext=otherObj.outerContext;result.variables.parentFrame=otherObj.outerContext.variables;result.receiver=otherObj.receiver;return result}result.receiver=otherObj;if(!result.outerContext){result.outerContext=new Context;result.variables.parentFrame=result.outerContext.variables}result.outerContext=copy(result.outerContext);result.outerContext.variables=copy(result.outerContext.variables);result.outerContext.receiver=otherObj;if(result.outerContext.variables.parentFrame){rootVars=result.outerContext.variables.parentFrame;receiverVars=copy(otherObj.variables);receiverVars.parentFrame=rootVars;result.outerContext.variables.parentFrame=receiverVars}else{result.outerContext.variables.parentFrame=otherObj.variables}return result};Process.prototype.reportMousePosition=function(){var world,pos;if(this.homeContext.receiver){world=this.homeContext.receiver.world();if(world){pos=this.homeContext.receiver.snapPoint(world.hand.position());return new List([pos.x,pos.y])}}return""};Process.prototype.reportMouseX=function(){var world;if(this.homeContext.receiver){world=this.homeContext.receiver.world();if(world){return this.homeContext.receiver.snapPoint(world.hand.position()).x}}return 0};Process.prototype.reportMouseY=function(){var world;if(this.homeContext.receiver){world=this.homeContext.receiver.world();if(world){return this.homeContext.receiver.snapPoint(world.hand.position()).y}}return 0};Process.prototype.reportMouseDown=function(){var world;if(this.homeContext.receiver){world=this.homeContext.receiver.world();if(world){return world.hand.mouseButton==="left"}}return false};Process.prototype.reportKeyPressed=function(keyString){var stage;if(this.homeContext.receiver){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){if(this.inputOption(keyString)==="any key"){return Object.keys(stage.keysPressed).length>0}if(keyString instanceof List&&this.enableHyperOps){return keyString.map(each=>stage.keysPressed[each]!==undefined)}return stage.keysPressed[keyString]!==undefined}}return false};Process.prototype.doResetTimer=function(){var stage;if(this.homeContext.receiver){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){stage.resetTimer()}}};Process.prototype.reportTimer=function(){var stage;if(this.homeContext.receiver){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){return stage.getTimer()}}return 0};Process.prototype.reportDate=function(datefn){var currDate,func,result,inputFn=this.inputOption(datefn),dateMap={year:"getFullYear",month:"getMonth",date:"getDate","day of week":"getDay",hour:"getHours",minute:"getMinutes",second:"getSeconds","time in milliseconds":"getTime"};if(!dateMap[inputFn]){return""}currDate=new Date;func=dateMap[inputFn];result=currDate[func]();if(inputFn==="month"||inputFn==="day of week"){result+=1}return result};Process.prototype.doSetVideoTransparency=function(factor){var stage;if(this.homeContext.receiver){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){stage.projectionTransparency=Math.max(0,Math.min(100,factor))}}};Process.prototype.reportVideo=function(attribute,name){var thisObj=this.blockReceiver(),stage=thisObj.parentThatIsA(StageMorph),thatObj;if(!stage.projectionSource||!stage.projectionSource.stream){if(!this.context.accumulator){this.context.accumulator=true;stage.startVideo()}this.pushContext("doYield");this.pushContext();return}if(this.enableHyperOps){if(name instanceof List){return name.map(each=>this.reportVideo(attribute,each))}}thatObj=this.getOtherObject(name,thisObj,stage);switch(this.inputOption(attribute)){case"motion":if(thatObj instanceof SpriteMorph){stage.videoMotion.getLocalMotion(thatObj);return thatObj.motionAmount}stage.videoMotion.getStageMotion();return stage.videoMotion.motionAmount;case"direction":if(thatObj instanceof SpriteMorph){stage.videoMotion.getLocalMotion(thatObj);return thatObj.motionDirection}stage.videoMotion.getStageMotion();return stage.videoMotion.motionDirection;case"snap":if(thatObj instanceof SpriteMorph){return thatObj.projectionSnap()}return stage.projectionSnap()}return-1};Process.prototype.startVideo=function(stage){if(this.reportGlobalFlag("video capture")){return}if(!stage.projectionSource||!stage.projectionSource.stream){if(!this.context.accumulator){this.context.accumulator=true;stage.startVideo()}}this.pushContext("doYield");this.pushContext()};Process.prototype.doMapCodeOrHeader=function(aContext,anOption,aString){if(this.inputOption(anOption)==="code"){return this.doMapCode(aContext,aString)}if(this.inputOption(anOption)==="header"){return this.doMapHeader(aContext,aString)}throw new Error(" '"+anOption+"'\n"+localize("is not a valid option"))};Process.prototype.doMapHeader=function(aContext,aString){if(aContext instanceof Context){if(aContext.expression instanceof SyntaxElementMorph){return aContext.expression.mapHeader(aString||"")}}};Process.prototype.doMapCode=function(aContext,aString){if(aContext instanceof Context){if(aContext.expression instanceof SyntaxElementMorph){return aContext.expression.mapCode(aString||"")}}};Process.prototype.doMapValueCode=function(type,aString){var tp=this.inputOption(type);switch(tp){case"String":StageMorph.prototype.codeMappings.string=aString||"<#1>";break;case"Number":StageMorph.prototype.codeMappings.number=aString||"<#1>";break;case"true":StageMorph.prototype.codeMappings.boolTrue=aString||"true";break;case"false":StageMorph.prototype.codeMappings.boolFalse=aString||"true";break;default:throw new Error(localize("unsupported data type")+': "'+tp+'"')}};Process.prototype.doMapListCode=function(part,kind,aString){var key1="",key2="delim";if(this.inputOption(kind)==="parameters"){key1="parms_"}else if(this.inputOption(kind)==="variables"){key1="tempvars_"}if(this.inputOption(part)==="list"){key2="list"}else if(this.inputOption(part)==="item"){key2="item"}StageMorph.prototype.codeMappings[key1+key2]=aString||""};Process.prototype.reportMappedCode=function(aContext){if(aContext instanceof Context){if(aContext.expression instanceof SyntaxElementMorph){return aContext.expression.mappedCode()}}return""};Process.prototype.doRest=function(beats){var tempo=this.reportTempo();this.doWait(60/tempo*beats)};Process.prototype.reportTempo=function(){var stage;if(this.homeContext.receiver){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){return stage.getTempo()}}return 0};Process.prototype.doChangeTempo=function(delta){var stage;if(this.homeContext.receiver){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){stage.changeTempo(delta)}}};Process.prototype.doSetTempo=function(bpm){var stage;if(this.homeContext.receiver){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(stage){stage.setTempo(bpm)}}};Process.prototype.doPlayNote=function(pitch,beats){var tempo=this.reportTempo();this.doPlayNoteForSecs(parseFloat(pitch||"0"),60/tempo*parseFloat(beats||"0"))};Process.prototype.doPlayNoteForSecs=function(pitch,secs){var rcvr=this.blockReceiver();if(!this.context.startTime){rcvr.setVolume(rcvr.getVolume());rcvr.setPan(rcvr.getPan());this.context.startTime=Date.now();this.context.activeNote=new Note(pitch);this.context.activeNote.play(this.instrument,rcvr.getGainNode(),rcvr.getPannerNode())}if(Date.now()-this.context.startTime>=secs*1e3){if(this.context.activeNote){this.context.activeNote.stop();this.context.activeNote=null}return null}this.pushContext("doYield");this.pushContext()};Process.prototype.doPlayFrequency=function(hz,secs){this.doPlayFrequencyForSecs(parseFloat(hz||"0"),parseFloat(secs||"0"))};Process.prototype.doPlayFrequencyForSecs=function(hz,secs){if(!this.context.startTime){this.context.startTime=Date.now();this.context.activeNote=new Note;this.context.activeNote.frequency=hz;this.context.activeNote.play(this.instrument)}if(Date.now()-this.context.startTime>=secs*1e3){if(this.context.activeNote){this.context.activeNote.stop();this.context.activeNote=null}return null}this.pushContext("doYield");this.pushContext()};Process.prototype.doSetInstrument=function(num){this.instrument=+num;this.receiver.instrument=+num;if(this.receiver.freqPlayer){this.receiver.freqPlayer.setInstrument(+num)}};Process.prototype.reportGetImageAttribute=function(choice,name){if(this.enableHyperOps){if(name instanceof List){return name.map(each=>this.reportGetImageAttribute(choice,each))}}var cst=this.costumeNamed(name)||new Costume,option=this.inputOption(choice);switch(option){case"name":return cst.name;case"width":return cst.width();case"height":return cst.height();case"pixels":return cst.rasterized().pixels();default:return cst}};Process.prototype.reportNewCostumeStretched=function(name,xP,yP){var cst;if(name instanceof List){return this.reportNewCostume(name,xP,yP)}cst=this.costumeNamed(name);if(!cst){return new Costume}if(!isFinite(+xP*+yP)||isNaN(+xP*+yP)){throw new Error("expecting a finite number\nbut getting Infinity or NaN")}return cst.stretched(Math.round(cst.width()*+xP/100),Math.round(cst.height()*+yP/100))};Process.prototype.costumeNamed=function(name){if(name instanceof Costume){return name}if(typeof name==="number"){return this.blockReceiver().costumes.at(name)}if(this.inputOption(name)==="current"){return this.blockReceiver().costume}return detect(this.blockReceiver().costumes.asArray(),c=>c.name===name.toString())};Process.prototype.reportNewCostume=function(pixels,width,height,name){var rcvr,stage,canvas,ctx,src,dta,i,k,px;this.assertType(pixels,"list");if(this.inputOption(width)==="current"){rcvr=this.blockReceiver();stage=rcvr.parentThatIsA(StageMorph);width=rcvr.costume?rcvr.costume.width():stage.dimensions.x}if(this.inputOption(height)==="current"){rcvr=rcvr||this.blockReceiver();stage=stage||rcvr.parentThatIsA(StageMorph);height=rcvr.costume?rcvr.costume.height():stage.dimensions.y}width=Math.abs(Math.floor(+width));height=Math.abs(Math.floor(+height));if(width<=0||height<=0){throw new Error("cannot handle zero width or height")}if(!isFinite(width*height)||isNaN(width*height)){throw new Error("expecting a finite number\nbut getting Infinity or NaN")}canvas=newCanvas(new Point(width,height),true);ctx=canvas.getContext("2d");src=pixels.itemsArray();dta=ctx.createImageData(width,height);for(i=0;i<src.length;i+=1){px=src[i]instanceof List?src[i].itemsArray():[src[i]];for(k=0;k<3;k+=1){dta.data[i*4+k]=px[k]===undefined?+px[0]:+px[k]}dta.data[i*4+3]=px[3]===undefined?255:+px[3]}ctx.putImageData(dta,0,0);return new Costume(canvas,name||(rcvr||this.blockReceiver()).newCostumeName(localize("costume")))};Process.prototype.reportPentrailsAsSVG=function(){var rcvr,stage,svg,acc,offset;if(!this.context.accumulator){stage=this.homeContext.receiver.parentThatIsA(StageMorph);if(!stage.trailsLog.length){throw new Error(localize("there are currently no\nvectorizable pen trail segments"))}svg=stage.trailsLogAsSVG();this.context.accumulator={img:new Image,rot:svg.rot,ready:false};acc=this.context.accumulator;acc.img.onload=()=>acc.ready=true;acc.img.src="data:image/svg+xml,"+svg.src;acc.img.rot=svg.rotationShift}else if(this.context.accumulator.ready){offset=ZERO;rcvr=this.blockReceiver();if(rcvr instanceof SpriteMorph){offset=new Point(rcvr.xPosition(),-rcvr.yPosition())}this.returnValueToParentContext(new SVG_Costume(this.context.accumulator.img,this.blockReceiver().newCostumeName(localize("Costume")),this.context.accumulator.rot.translateBy(offset)));return}this.pushContext()};Process.prototype.inputOption=function(dta){return dta instanceof Array?dta[0]:dta};Process.prototype.pushContext=function(expression,outerContext){this.context=new Context(this.context,expression,outerContext||(this.context?this.context.outerContext:null),this.context?this.context.receiver:this.homeContext.receiver)};Process.prototype.popContext=function(){if(this.context){this.context.stopMusic()}this.context=this.context?this.context.parentContext:null};Process.prototype.returnValueToParentContext=function(value){if(value!==undefined){var target=this.context?this.context.parentContext||this.homeContext:this.homeContext;target.addInput(value)}};Process.prototype.reportStackSize=function(){return this.context?this.context.stackSize():0};Process.prototype.reportFrameCount=function(){return this.frameCount};Process.prototype.reportYieldCount=function(){return this.yieldCount};Process.prototype.flashContext=function(){var expr=this.context.expression;if(this.enableSingleStepping&&!this.isAtomic&&expr instanceof SyntaxElementMorph&&!(expr instanceof CommandSlotMorph)&&!this.context.isFlashing&&expr.world()&&!(expr instanceof ColorSlotMorph)){this.unflash();expr.flash();this.context.isFlashing=true;this.flashingContext=this.context;if(this.flashTime>0&&this.flashTime<=.5){this.pushContext("doIdle");this.context.addInput(this.flashTime)}else{this.pushContext("doInterrupt")}return true}return false};Process.prototype.flashPausedContext=function(){var flashable=this.context?this.context.lastFlashable():null;if(flashable){this.unflash();flashable.expression.flash();flashable.isFlashing=true;this.flashingContext=flashable}};Process.prototype.doInterrupt=function(){this.popContext();if(!this.isAtomic){this.isInterrupted=true}};Process.prototype.doIdle=function(secs){if(!this.context.startTime){this.context.startTime=Date.now()}if(Date.now()-this.context.startTime<secs*1e3){this.pushContext("doInterrupt");return}this.popContext()};Process.prototype.unflash=function(){if(this.flashingContext){this.flashingContext.expression.unflash();this.flashingContext.isFlashing=false;this.flashingContext=null}};Process.prototype.reportBlockAttribute=function(attribute,block){return this.hyperDyadic((att,obj)=>this.reportBasicBlockAttribute(att,obj),attribute,block)};Process.prototype.reportBasicBlockAttribute=function(attribute,block){var choice=this.inputOption(attribute),expr,body,slots,def,info;this.assertType(block,["command","reporter","predicate"]);expr=block.expression;switch(choice){case"label":return expr?expr.abstractBlockSpec():"";case"definition":if(expr.isCustomBlock){if(expr.isGlobal){body=expr.definition.body||new Context}else{body=this.blockReceiver().getMethod(expr.semanticSpec).body||new Context}}else{body=new Context}if(body.expression&&body.expression.selector==="doReport"&&body.expression.inputs()[0]instanceof BlockMorph){return body.expression.inputs()[0].reify(body.inputs)}return body;case"category":return expr?SpriteMorph.prototype.allCategories().indexOf(expr.category)+1:0;case"custom?":return expr?!!expr.isCustomBlock:false;case"global?":return expr&&expr.isCustomBlock?!!expr.isGlobal:true;case"type":return["command","reporter","predicate"].indexOf(this.reportTypeOf(block))+1;case"scope":return expr.isCustomBlock?expr.isGlobal?1:2:0;case"slots":if(expr.isCustomBlock){slots=[];(expr.isGlobal?expr.definition:this.blockReceiver().getMethod(expr.semanticSpec)).declarations.forEach(value=>slots.push(value[0]));return new List(slots).map(spec=>this.slotType(spec))}return new List(expr.inputs().map(each=>each instanceof ReporterBlockMorph?each.getSlotSpec():each.getSpec())).map(spec=>this.slotType(spec));case"defaults":slots=new List;if(expr.isCustomBlock){def=expr.isGlobal?expr.definition:this.blockReceiver().getMethod(expr.semanticSpec);def.declarations.forEach(value=>slots.add(value[1]))}else{info=SpriteMorph.prototype.blocks[expr.selector];if(!info){return slots}slots=new List(info.defaults)}return slots;case"menus":slots=new List;if(expr.isCustomBlock){def=expr.isGlobal?expr.definition:this.blockReceiver().getMethod(expr.semanticSpec);def.declarations.forEach(value=>slots.add(isString(value[2])?def.decodeChoices(def.parseChoices(value[2])):""))}else{expr.inputs().forEach(slot=>{if(slot instanceof ReporterBlockMorph){slot=SyntaxElementMorph.prototype.labelPart(slot.getSlotSpec())}slots.add(slot instanceof InputSlotMorph?isString(slot.choices)?slot.choices:CustomBlockDefinition.prototype.decodeChoices(slot.choices):"")})}return slots;case"editables":slots=new List;if(expr.isCustomBlock){def=expr.isGlobal?expr.definition:this.blockReceiver().getMethod(expr.semanticSpec);def.declarations.forEach(value=>slots.add(!value[3]))}else{expr.inputs().forEach(slot=>{if(slot instanceof ReporterBlockMorph){slot=SyntaxElementMorph.prototype.labelPart(slot.getSlotSpec())}slots.add(slot instanceof InputSlotMorph?!slot.isReadOnly:false)})}return slots}return""};Process.prototype.slotType=function(spec){var shift=0,key=spec.toLowerCase(),num;if(spec.startsWith("%")){key=spec.slice(1).toLowerCase();if(key.startsWith("mult")){shift=100;key=key.slice(5)}}else if(spec.endsWith("...")){shift=100;key=spec.slice(0,-3).toLowerCase()}num={0:0,s:0," ":0,_:0,a:0,any:0,1:1,n:1,"#":1,num:1,number:1,2:2,b:2,"?":2,tf:2,bool:2,boolean:2,3:3,l:3,":":3,lst:3,list:3,4:4,txt:4,mlt:4,code:4,x:4,text:4,abc:4,5:5,c:5,cs:5,loop:5,ca:5,script:5,6:6,cmdring:6,cmd:6,command:6,7:7,repring:7,rep:7,reporter:7,8:8,predring:8,pred:8,predicate:8,9:9,anyue:9,unevaluated:9,10:10,boolue:10,11:11,obj:11,o:11,object:11,12:12,t:12,upvar:12,v:12,var:12}[key];if(num===undefined){return spec}return shift+num};Process.prototype.slotSpec=function(num){var prefix="",id=this.reportIsA(num,"text")?this.slotType(num):+num,spec;if(id>=100){prefix="%mult";id-=100}spec=["s","n","b","l","mlt","cs","cmdRing","repRing","predRing","anyUE","boolUE","obj","upvar"][id];if(spec===undefined){return null}if(spec==="upvar"&&id>100){return null}return prefix+"%"+spec};Process.prototype.doSetBlockAttribute=function(attribute,block,val){var choice=this.inputOption(attribute),rcvr=this.blockReceiver(),ide=rcvr.parentThatIsA(IDE_Morph),types=["command","reporter","predicate"],scopes=["global","local"],idx,oldSpec,expr,def,inData,template,oldType,type;this.assertType(block,types);expr=block.expression;if(!expr.isCustomBlock){throw new Error("expecting a custom block\nbut getting a primitive")}def=expr.isGlobal?expr.definition:rcvr.getMethod(expr.semanticSpec);oldSpec=def.blockSpec();function isInUse(){if(def.isGlobal){return ide.sprites.asArray().concat([ide.stage]).some((any,idx)=>any.usesBlockInstance(def,false,idx))||ide.stage.allBlockInstancesInData(def).some(any=>!any.isUnattached())}return rcvr.allDependentInvocationsOf(oldSpec).some(any=>!any.isUnattached())}function remove(arr,value){var idx=arr.indexOf(value);if(idx>-1){arr.splice(idx,1)}}function isMajorTypeChange(){var rep=["reporter","predicate"];return type==="command"&&rep.includes(oldType)||oldType=="command"&&rep.includes(type)}switch(choice){case"label":def.setBlockLabel(val);break;case"definition":this.assertType(val,types);def.setBlockDefinition(val);break;case"category":this.assertType(val,["number","text"]);if(this.reportTypeOf(val)==="text"){idx=SpriteMorph.prototype.allCategories().map(cat=>cat.toLowerCase()).indexOf(val.toLowerCase());val=idx+1}def.category=SpriteMorph.prototype.allCategories()[+val-1]||"other";break;case"type":this.assertType(val,["number","text"]);if(this.reportTypeOf(val)==="text"){type=val.toLowerCase()}else{type=types[val-1]||""}if(!types.includes(type)){return}if(rcvr.allBlockInstances(def).every(block=>block.isChangeableTo(type))){oldType=def.type;def.type=type}else{throw new Error("cannot change this\nfor a block that is in use")}if(isMajorTypeChange()){if(def.isGlobal){ide.stage.allContextsUsing(def).forEach(context=>context.expression=def.blockInstance())}else{ide.stage.allContextsInvoking(def.blockSpec(),rcvr).forEach(context=>context.expression=def.blockInstance())}}break;case"scope":if(isInUse()){throw new Error("cannot change this\nfor a block that is in use")}this.assertType(val,["number","text"]);if(this.reportTypeOf(val)==="text"){type=val.toLowerCase()}if(scopes.includes(type)){type=scopes.indexOf(type)+1}else{type=+val}if(type===1&&!def.isGlobal){inData=ide.stage.allContextsInvoking(def.blockSpec(),rcvr);def.isGlobal=true;remove(rcvr.customBlocks,def);ide.stage.globalBlocks.push(def)}else if(type===2&&def.isGlobal){inData=ide.stage.allContextsUsing(def);def.isGlobal=false;remove(ide.stage.globalBlocks,def);rcvr.customBlocks.push(def)}else{return}inData.forEach(context=>{context.expression=def.blockInstance();context.changed()});break;case"slots":this.assertType(val,["list","number","text"]);if(!(val instanceof List)){val=new List([val])}def.inputNames().forEach((name,idx)=>{var info=def.declarations.get(name),id=val.at(idx+1);if(id!==""){info[0]=this.slotSpec(id)||info[0];def.declarations.set(name,info)}});break;case"defaults":this.assertType(val,["list","Boolean","number","text"]);if(!(val instanceof List)){val=new List([val])}def.inputNames().forEach((name,idx)=>{var info=def.declarations.get(name),options=val.at(idx+1);this.assertType(options,["Boolean","number","text"]);info[1]=options;def.declarations.set(name,info)});break;case"menus":this.assertType(val,["list","text","number"]);if(!(val instanceof List)){val=new List([val.toString()])}def.inputNames().forEach((name,idx)=>{var info=def.declarations.get(name),options=val.at(idx+1);if(options!==""){if(!(options instanceof List)){options=new List([options])}info[2]=def.encodeChoices(options);def.declarations.set(name,info)}});break;case"editables":this.assertType(val,["list","Boolean","number"]);if(!(val instanceof List)){val=new List([val])}def.inputNames().forEach((name,idx)=>{var info=def.declarations.get(name),options=val.at(idx+1);if([true,false,0,1,"0","1"].includes(options)){options=+options;info[3]=!options;def.declarations.set(name,info)}});break;default:return}while(rcvr.doubleDefinitionsFor(def).length>0){def.spec+=" (2)"}template=rcvr.paletteBlockInstance(def);if(def.isGlobal){rcvr.allBlockInstances(def).reverse().forEach(block=>block.refresh());ide.stage.allContextsUsing(def).forEach(context=>context.changed())}else{rcvr.allDependentInvocationsOf(oldSpec).reverse().forEach(block=>block.refresh(def));ide.stage.allContextsInvoking(def.blockSpec(),rcvr).forEach(context=>context.changed())}if(template){template.refreshDefaults()}ide.flushPaletteCache();ide.categories.refreshEmpty();ide.refreshPalette();ide.recordUnsavedChanges()};Process.prototype.doDefineBlock=function(upvar,label,context){var rcvr=this.blockReceiver(),ide=rcvr.parentThatIsA(IDE_Morph),vars=this.context.outerContext.variables,type=this.reportTypeOf(context),count=1,matches,spec,def;this.assertType(label,"text");label=label.trim();if(label===""){return""}this.assertType(context,["command","reporter","predicate"]);if(context.expression instanceof BlockMorph){this.compileBlockReferences(context,upvar)}matches=ide.stage.globalBlocks.filter(def=>def.abstractBlockSpec()===label);if(matches.length>1){throw new Error("several block definitions\nalready match this label")}else if(matches.length===1){def=matches[0];this.doSetBlockAttribute("definition",def.blockInstance().reify(),context);vars.addVar(upvar);vars.setVar(upvar,def.blockInstance().reify());return}def=new CustomBlockDefinition("BYOB");def.type=type;def.category="other";def.isGlobal=true;def.setBlockDefinition(context);def.setBlockLabel(label);ide.stage.globalBlocks.push(def);spec=def.spec;while(rcvr.doubleDefinitionsFor(def).length>0){count+=1;def.spec=spec+" ("+count+")"}ide.flushPaletteCache();ide.categories.refreshEmpty();ide.refreshPalette();ide.recordUnsavedChanges();vars.addVar(upvar);vars.setVar(upvar,def.blockInstance().reify())};Process.prototype.compileBlockReferences=function(context,varName){var report,declare,assign;function block(selector){return SpriteMorph.prototype.blockForSelector(selector)}if(context.expression.allChildren().some(any=>any.selector==="reportGetVar"&&any.parentThatIsA(RingMorph))){if(context.expression instanceof ReporterBlockMorph){report=block("doReport");report.replaceInput(report.inputs()[0],context.expression.fullCopy());context.expression=report}declare=block("doDeclareVariables");declare.inputs()[0].setContents([varName]);assign=block("doSetVar");assign.inputs()[0].setContents(varName);assign.replaceInput(assign.inputs()[1],block("reportThisContext"));declare.nextBlock(assign);assign.nextBlock(context.expression.fullCopy());context.expression=declare;return}if(context.expression instanceof BlockMorph){context.expression.forAllChildren(morph=>{var ref;if(morph.selector==="reportGetVar"&&morph.blockSpec===varName){ref=block("reportThisContext");if(morph.parent instanceof SyntaxElementMorph){morph.parent.replaceInput(morph,ref)}else{context.expression=ref}}})}};Process.prototype.doDeleteBlock=function(context){var rcvr=this.blockReceiver(),ide=rcvr.parentThatIsA(IDE_Morph),stage=ide.stage,expr,def,method,idx;this.assertType(context,["command","reporter","predicate"]);expr=context.expression;if(!expr.isCustomBlock){throw new Error("expecting a custom block\nbut getting a primitive")}def=expr.isGlobal?expr.definition:rcvr.getMethod(expr.semanticSpec);rcvr.deleteAllBlockInstances(def);if(def.isGlobal){idx=stage.globalBlocks.indexOf(def);if(idx!==-1){stage.globalBlocks.splice(idx,1)}}else{idx=rcvr.customBlocks.indexOf(def);if(idx!==-1){rcvr.customBlocks.splice(idx,1)}method=rcvr.getMethod(def.blockSpec);if(method){rcvr.allDependentInvocationsOf(method.blockSpec).forEach(block=>block.refresh(method))}}ide.flushPaletteCache();ide.categories.refreshEmpty();ide.refreshPalette();ide.recordUnsavedChanges()};Process.prototype.reportCompiled=function(context,implicitParamCount){return new JSCompiler(this).compileFunction(context,implicitParamCount)};Process.prototype.capture=function(aContext){var proc=new Process(this.topBlock,this.receiver);var clos=new Context(aContext.parentContext,aContext.expression,aContext.outerContext,aContext.receiver);clos.variables=aContext.variables.fullCopy();clos.variables.root().parentFrame=proc.variables;proc.context=clos;return proc};Process.prototype.getVarNamed=function(name){var frame=this.homeContext.variables.silentFind(name)||this.context.variables.silentFind(name),value;if(frame){value=frame.vars[name].value;return value===0?0:value===false?false:value===""?"":value||0}throw new Error(localize("a variable of name '")+name+localize("'\ndoes not exist in this context"))};Process.prototype.setVarNamed=function(name,value){var frame=this.homeContext.variables.silentFind(name)||this.context.variables.silentFind(name);if(isNil(frame)){throw new Error(localize("a variable of name '")+name+localize("'\ndoes not exist in this context"))}frame.vars[name].value=value};Process.prototype.incrementVarNamed=function(name,delta){this.setVarNamed(name,this.getVarNamed(name)- -delta)};Process.prototype.reportAtomicMap=function(reporter,list){this.assertType(list,"list");var result=[],src=list.itemsArray(),len=src.length,formalParameterCount=reporter.inputs.length,parms,func,i;try{func=this.reportCompiled(reporter,1)}catch(err){console.log(err.message);func=reporter}for(i=0;i<len;i+=1){parms=[src[i]];if(formalParameterCount>1){parms.push(i+1)}if(formalParameterCount>2){parms.push(list)}result.push(invoke(func,new List(parms),null,null,null,null,this.capture(reporter)))}return new List(result)};Process.prototype.reportAtomicKeep=function(reporter,list){this.assertType(list,"list");var result=[],src=list.itemsArray(),len=src.length,formalParameterCount=reporter.inputs.length,parms,func,i;try{func=this.reportCompiled(reporter,1)}catch(err){console.log(err.message);func=reporter}for(i=0;i<len;i+=1){parms=[src[i]];if(formalParameterCount>1){parms.push(i+1)}if(formalParameterCount>2){parms.push(list)}if(invoke(func,new List(parms),null,null,null,null,this.capture(reporter))){result.push(src[i])}}return new List(result)};Process.prototype.reportAtomicFindFirst=function(reporter,list){this.assertType(list,"list");var src=list.itemsArray(),len=src.length,formalParameterCount=reporter.inputs.length,parms,func,i;try{func=this.reportCompiled(reporter,1)}catch(err){console.log(err.message);func=reporter}for(i=0;i<len;i+=1){parms=[src[i]];if(formalParameterCount>1){parms.push(i+1)}if(formalParameterCount>2){parms.push(list)}if(invoke(func,new List(parms),null,null,null,null,this.capture(reporter))){return src[i]}}return""};Process.prototype.reportAtomicCombine=function(list,reporter){var result,src,len,formalParameterCount,parms,func,i;this.assertType(list,"list");if(this.canRunOptimizedForCombine(reporter)){return this.reportListAggregation(list,reporter.expression.selector)}result="";src=list.itemsArray();len=src.length;formalParameterCount=reporter.inputs.length;if(len===0){return result}result=src[0];try{func=this.reportCompiled(reporter,2)}catch(err){console.log(err.message);func=reporter}for(i=1;i<len;i+=1){parms=[result,src[i]];if(formalParameterCount>2){parms.push(i+1)}if(formalParameterCount>3){parms.push(list)}result=invoke(func,new List(parms),null,null,null,null,this.capture(reporter))}return result};Process.prototype.reportAtomicSort=function(list,reporter){this.assertType(list,"list");var func;try{func=this.reportCompiled(reporter,2)}catch(err){console.log(err.message);func=reporter}return new List(list.itemsArray().slice().sort((a,b)=>invoke(func,new List([a,b]),null,null,null,null,this.capture(reporter))?-1:1))};Process.prototype.reportAtomicGroup=function(list,reporter){this.assertType(list,"list");var result=[],dict=new Map,groupKey,src=list.itemsArray(),len=src.length,func,i;try{func=this.reportCompiled(reporter,1)}catch(err){console.log(err.message);func=reporter}for(i=0;i<len;i+=1){groupKey=invoke(func,new List([src[i]]),null,null,null,null,this.capture(reporter));if(dict.has(groupKey)){dict.get(groupKey).push(src[i])}else{dict.set(groupKey,[src[i]])}}dict.forEach((value,key)=>result.push(new List([key,value.length,new List(value)])));return new List(result)};function Context(parentContext,expression,outerContext,receiver){this.outerContext=outerContext||null;this.parentContext=parentContext||null;this.expression=expression||null;this.receiver=receiver||null;this.origin=receiver||null;this.variables=new VariableFrame;if(this.outerContext){this.variables.parentFrame=this.outerContext.variables;this.receiver=this.outerContext.receiver}this.inputs=[];this.pc=0;this.isContinuation=false;this.startTime=null;this.activeSends=null;this.activeAudio=null;this.activeNote=null;this.isCustomBlock=false;this.isCustomCommand=null;this.emptySlots=0;this.tag=null;this.isFlashing=false;this.accumulator=null;this.version=null}Context.prototype.toString=function(){var expr=this.expression;if(expr instanceof Array){if(expr.length>0){expr="["+expr[0]+"]"}}return"Context >> "+expr+" "+this.variables};Context.prototype.changed=function(){this.version=Date.now()};Context.prototype.image=function(){var ring=this.toBlock();return ring.doWithAlpha(1,()=>ring.fullImage())};Context.prototype.toBlock=function(){var ring=new RingMorph,block,cont;if(this.expression instanceof Morph){block=this.expression.fullCopy();if(this.isContinuation){cont=detect(block.allInputs(),inp=>inp.bindingID===1);if(cont){block.revertToDefaultInput(cont,true)}}ring.embed(block,this.inputs);ring.clearAlpha();return ring}if(this.expression instanceof Array){block=this.expression[this.pc].fullCopy();if(block instanceof RingMorph&&!block.contents()){return block}ring.embed(block,this.isContinuation?[]:this.inputs);return ring}ring.color=SpriteMorph.prototype.blockColor.other;ring.setSpec("%rr %ringparms");if(!this.isContinuation){this.inputs.forEach(inp=>ring.parts()[1].addInput(inp))}return ring};Context.prototype.continuation=function(isReporter){var cont;if(this.expression instanceof Array){cont=this}else if(this.parentContext){cont=this.parentContext}else{cont=new Context(null,isReporter?"expectReport":"popContext");cont.isContinuation=true;return cont}cont=cont.copyForContinuation();cont.tag=null;cont.isContinuation=true;return cont};Context.prototype.copyForContinuation=function(){var cpy=copy(this),cur=cpy,isReporter=!(this.expression instanceof Array||isString(this.expression));if(isReporter){cur.prepareContinuationForBinding();while(cur.parentContext){cur.parentContext=copy(cur.parentContext);cur=cur.parentContext;cur.inputs=[]}}return cpy};Context.prototype.copyForContinuationCall=function(){var cpy=copy(this),cur=cpy,isReporter=!(this.expression instanceof Array||isString(this.expression));if(isReporter){this.expression=this.expression.fullCopy();this.inputs=[];while(cur.parentContext){cur.parentContext=copy(cur.parentContext);cur=cur.parentContext;cur.inputs=[]}}return cpy};Context.prototype.prepareContinuationForBinding=function(){var pos=this.inputs.length,slot;this.expression=this.expression.fullCopy();slot=this.expression.inputs()[pos];if(slot){this.inputs=[];slot.bindingID=1;this.emptySlots=1}};Context.prototype.addInput=function(input){this.inputs.push(input)};Context.prototype.stopMusic=function(){if(this.activeNote){this.activeNote.stop();this.activeNote=null}};Context.prototype.lastFlashable=function(){if(this.expression instanceof SyntaxElementMorph&&!(this.expression instanceof CommandSlotMorph)){return this}else if(this.parentContext){return this.parentContext.lastFlashable()}return null};Context.prototype.stackSize=function(){if(!this.parentContext){return 1}return 1+this.parentContext.stackSize()};Context.prototype.isInCustomBlock=function(){if(this.isCustomBlock){return true}if(this.parentContext){return this.parentContext.isInCustomBlock()}return false};Context.prototype.components=function(){var expr=this.expression;if(expr&&expr.components){expr=expr.components(this.inputs.slice())}else{expr=new Context;expr.inputs=this.inputs.slice()}return expr instanceof Context?new List([expr]):expr};Context.prototype.equalTo=function(other){var c1=this.components(),c2=other.components();if(this.emptyOrEqual(c1.cdr(),c2.cdr())){if(this.expression&&this.expression.length===1&&other.expression&&other.expression.length===1){return snapEquals(this.expression[0],other.expression[0])}return snapEquals(this.expression,other.expression)}return false};Context.prototype.emptyOrEqual=function(list1,list2){return list1.equalTo(list2)||list1.itemsArray().every(item=>!item)&&list2.itemsArray().every(item=>!item)};Context.prototype.copyWithInputs=function(inputs){return this.expression?this.expression.copyWithInputs(inputs):this};Context.prototype.copyWithNext=function(next){return this.expression.copyWithNext(next.expression,this.inputs.slice())};Context.prototype.updateEmptySlots=function(){this.emptySlots=this.expression.markEmptySlots()};function Variable(value,isTransient,isHidden){this.value=value;this.isTransient=isTransient||false;this.isHidden=isHidden||false}Variable.prototype.toString=function(){return"a "+(this.isTransient?"transient ":"")+(this.isHidden?"hidden ":"")+"Variable ["+this.value+"]"};Variable.prototype.copy=function(){return new Variable(this.value,this.isTransient,this.isHidden)};function VariableFrame(parentFrame,owner){this.vars={};this.parentFrame=parentFrame||null;this.owner=owner||null}VariableFrame.prototype.toString=function(){return"a VariableFrame {"+this.names()+"}"};VariableFrame.prototype.copy=function(){var frame=new VariableFrame(this.parentFrame);this.names().forEach(vName=>frame.addVar(vName,this.getVar(vName)));return frame};VariableFrame.prototype.fullCopy=function(){var frame;if(this.parentFrame){frame=new VariableFrame(this.parentFrame.fullCopy())}else{frame=new VariableFrame}frame.vars=copy(this.vars);return frame};VariableFrame.prototype.root=function(){if(this.parentFrame){return this.parentFrame.root()}return this};VariableFrame.prototype.find=function(name){var frame=this.silentFind(name);if(frame){return frame}throw new Error(localize("a variable of name '")+name+localize("'\ndoes not exist in this context"))};VariableFrame.prototype.silentFind=function(name){if(this.vars[name]instanceof Variable){return this}if(this.parentFrame){return this.parentFrame.silentFind(name)}return null};VariableFrame.prototype.setVar=function(name,value,sender){var frame=this.find(name);if(frame){if(sender instanceof SpriteMorph&&frame.owner instanceof SpriteMorph&&sender!==frame.owner){sender.shadowVar(name,value)}else{frame.vars[name].value=value}}};VariableFrame.prototype.changeVar=function(name,delta,sender){var frame=this.find(name),value,newValue;if(frame){value=parseFloat(frame.vars[name].value);newValue=isNaN(value)?delta:value+parseFloat(delta);if(sender instanceof SpriteMorph&&frame.owner instanceof SpriteMorph&&sender!==frame.owner){sender.shadowVar(name,newValue)}else{frame.vars[name].value=newValue}}};VariableFrame.prototype.getVar=function(name){var frame=this.silentFind(name),value;if(frame){value=frame.vars[name].value;return value===0?0:value===false?false:value===""?"":value||0}if(typeof name==="number"){return""}throw new Error(localize("a variable of name '")+name+localize("'\ndoes not exist in this context"))};VariableFrame.prototype.addVar=function(name,value){this.vars[name]=new Variable(value===0?0:value===false?false:value===""?"":value||0)};VariableFrame.prototype.deleteVar=function(name){var frame=this.find(name);if(frame){delete frame.vars[name]}};VariableFrame.prototype.names=function(includeHidden){var each,names=[];for(each in this.vars){if(Object.prototype.hasOwnProperty.call(this.vars,each)){if(!this.vars[each].isHidden||includeHidden){names.push(each)}}}return names};VariableFrame.prototype.allNamesDict=function(upTo,includeHidden){var dict={},current=this;function addKeysToDict(srcDict,trgtDict){var eachKey;for(eachKey in srcDict){if(Object.prototype.hasOwnProperty.call(srcDict,eachKey)){if(!srcDict[eachKey].isHidden||includeHidden){trgtDict[eachKey]=eachKey}}}}while(current&&current!==upTo){addKeysToDict(current.vars,dict);current=current.parentFrame}return dict};VariableFrame.prototype.allNames=function(upTo,includeHidden){var answer=[],each,dict=this.allNamesDict(upTo,includeHidden);for(each in dict){if(Object.prototype.hasOwnProperty.call(dict,each)){answer.push(each)}}return answer};function JSCompiler(aProcess,outerScope){this.process=aProcess;this.source=null;this.paramCount=0;this.params=0;this.gensymArgIndexes=new Map;this.scope=new Map;if(outerScope==null){this.scope.depth=0;this.scope.outerScope=null;return}this.scope.depth=1+outerScope.depth;this.scope.outerScope=outerScope}JSCompiler.prototype.toString=()=>"a JSCompiler";JSCompiler.prototype.gensymForVar=function(varName,argIndex){var gensym=this.getGensym(varName),oldArgIndex;if(gensym==null){gensym="_"+this.scope.depth+"_"+this.scope.size;this.scope.set(varName,gensym);this.gensymArgIndexes.set(gensym,argIndex);return gensym}oldArgIndex=this.gensymArgIndexes.get(gensym);if(oldArgIndex==null||oldArgIndex<argIndex){this.gensymArgIndexes.set(gensym,argIndex)}return gensym};JSCompiler.prototype.getGensym=function(varName){var scope=this.scope,gensym;while(null==(gensym=scope.get(varName))&&null!=(scope=scope.outerScope));return gensym};JSCompiler.prototype.functionHead=function(){var str1="var ",str2="";this.gensymArgIndexes.forEach((argIndex,gensym)=>{if(argIndex===-1){str1+=gensym+"=0,";return}str2+=","+argIndex+":"+gensym});str1+="proc=params.pop();\n";if(this.params){str1+="while("+this.params+">params.length)params.push(0);\n"}if(str2){str1+="var{"+str2.substring(1)+"}=params;\n"}return str1};JSCompiler.prototype.compileFunction=function(){return window.eval(this.compileFunctionBody.apply(this,arguments))};JSCompiler.prototype.findEmptySlot=function findEmptySlot(m){if(m.isEmptySlot!=null&&m.isEmptySlot()){return true}if(m instanceof RingMorph){return false}m=m.children;var i=m.length;while(i){if(findEmptySlot(m[--i])){return true}}return false};JSCompiler.prototype.compileFunctionBody=function(aContext,implicitParamCount){var block=aContext.expression,parameters=aContext.inputs,hasEmptySlots,code;if(block instanceof Array){throw new Error("can't compile empty ring")}this.source=aContext;if(implicitParamCount===""||isNil(implicitParamCount)){this.implicitParams=1}else{this.implicitParams=Math.floor(implicitParamCount);if(!(this.implicitParams>0&&this.implicitParams<128)){this.implicitParams=1}}hasEmptySlots=this.findEmptySlot(block);if(parameters.length){if(hasEmptySlots){throw new Error("compiling does not yet support\n"+"mixing explicit formal parameters\n"+"with empty input slots")}this.params=parameters.length;parameters.forEach(this.gensymForVar,this)}else if(hasEmptySlots){this.params=this.implicitParams}if(block instanceof CommandBlockMorph){code=this.compileSequence(block)+'return "";\n'}else{code="return "+this.compileExpression(block)+";\n"}return"(function func(...params){\n"+this.functionHead()+code+"})"};JSCompiler.prototype.compileExpression=function(block){var selector=block.selector,inputs=block.inputs(),target,args;switch(selector){case"reportOr":return this.compileInfix("||",inputs);case"reportAnd":return this.compileInfix("&&",inputs);case"reportIfElse":return"("+this.compileInput(inputs[0])+" ? "+this.compileInput(inputs[1])+" : "+this.compileInput(inputs[2])+")";case"evaluateCustomBlock":throw new Error("compiling does not yet support\n"+"custom blocks");case"doRun":case"evaluate":return"invoke("+this.compileInput(inputs[0])+","+this.compileInput(inputs[1])+",proc.blockReceiver(),null,null,null,proc,null)";case"doDeclareVariables":block="";inputs[0].inputs().forEach(x=>{block+=this.gensymForVar(x.children[0].blockSpec,-1)+"="});return block+"0";case"reportGetVar":target=this.getGensym(block=block.blockSpec);if(target==null){return'proc.getVarNamed("'+this.escape(block)+'")'}return target;case"doSetVar":if(inputs[0]instanceof ArgMorph){target=this.getGensym(inputs[0].evaluate());if(target!=null){return target+" = "+this.compileInput(inputs[1])}}return"proc.setVarNamed("+this.compileInput(inputs[0])+", "+this.compileInput(inputs[1])+")";case"doChangeVar":if(inputs[0]instanceof ArgMorph){target=this.getGensym(inputs[0].evaluate());if(target!=null){return target+" -=- "+this.compileInput(inputs[1])}}return"proc.incrementVarNamed("+this.compileInput(inputs[0])+", "+this.compileInput(inputs[1])+")";case"doReport":return"return "+this.compileInput(inputs[0]);case"doIf":return"if ("+this.compileInput(inputs[0])+") {\n"+this.compileSequence(inputs[1].evaluate())+"}";case"doIfElse":return"if ("+this.compileInput(inputs[0])+") {\n"+this.compileSequence(inputs[1].evaluate())+"} else {\n"+this.compileSequence(inputs[2].evaluate())+"}";case"doWarp":return this.compileSequence(inputs[0].evaluate());case"reportBoolean":case"reportNewList":return this.compileInput(inputs[0]);case"reportThisContext":return"func";default:target=this.process[selector]?this.process:this.source.receiver||this.process.receiver;args=this.compileInputs(inputs);if(isSnapObject(target)){return"proc.blockReceiver()."+selector+"("+args+")"}else{return"proc."+selector+"("+args+")"}}};JSCompiler.prototype.compileSequence=function(commandBlock){if(commandBlock==null)return"";commandBlock=commandBlock.blockSequence();var l=commandBlock.length,i=0,body="";while(l>i){body+=this.compileExpression(commandBlock[i++])+";\n"}return body};JSCompiler.prototype.compileInfix=function(operator,inputs){return"("+this.compileInput(inputs[0])+" "+operator+" "+this.compileInput(inputs[1])+")"};JSCompiler.prototype.compileInputs=function(array){var args="";array.forEach(inp=>{if(args){args+=", "}args+=this.compileInput(inp)});return args};JSCompiler.prototype.compileInput=function(inp){var value,type;if(inp.isEmptySlot&&inp.isEmptySlot()){if(this.implicitParams>1){if(this.paramCount<this.implicitParams){return"params["+this.paramCount+++"]"}throw new Error(localize("expecting")+" "+this.implicitParams+" "+localize("input(s), but getting")+" "+this.paramCount)}return"params[0]"}if(inp instanceof RingMorph){inp=inp.children;return new JSCompiler(this.process,this.scope).compileFunctionBody({expression:inp[0].children[0],inputs:inp[1].inputs().map(x=>x.children[0].blockSpec),receiver:this.source.receiver},"")}if(inp instanceof MultiArgMorph){return"new List(["+this.compileInputs(inp.inputs())+"])"}if(inp instanceof ArgLabelMorph){return this.compileInput(inp.argMorph())}if(inp instanceof ArgMorph){value=inp.evaluate();type=this.process.reportTypeOf(value);switch(type){case"number":case"Boolean":return""+value;case"text":return'"'+this.escape(value)+'"';case"list":return"new List(["+this.compileInputs(value)+"])";default:if(value instanceof Array){return'"'+this.escape(value[0])+'"'}throw new Error("compiling does not yet support\n"+"inputs of type\n"+type)}}if(inp instanceof BlockMorph){return this.compileExpression(inp)}throw new Error("compiling does not yet support\n"+"input slots of type\n"+inp.constructor.name)};JSCompiler.prototype.escape=string=>{string+="";var len=string.length,i=0,char,escaped="",safe_chars=" abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!#$"+"%&'()*+,-./:;<=>?@[]^_`{|}~";while(len>i){char=string.charAt(i++);if(safe_chars.indexOf(char)===-1){escaped+="\\u"+(char.charCodeAt(0)|65536).toString(16).substring(1)}else{escaped+=char}}return escaped};</script>
        <script>modules.objects="2022-August-01";var SpriteMorph;var StageMorph;var SpriteBubbleMorph;var Costume;var SVG_Costume;var CostumeEditorMorph;var Sound;var Note;var Microphone;var CellMorph;var WatcherMorph;var StagePrompterMorph;var Note;var SpriteHighlightMorph;var StagePickerMorph;var StagePickerItemMorph;function isSnapObject(thing){return thing instanceof SpriteMorph||thing instanceof StageMorph}SpriteMorph.prototype=new PenMorph;SpriteMorph.prototype.constructor=SpriteMorph;SpriteMorph.uber=PenMorph.prototype;SpriteMorph.prototype.attributes=["x position","y position","direction","size","costumes","costume #","volume","balance","sounds","shown?","pen down?","scripts"];SpriteMorph.prototype.categories=["motion","looks","sound","pen","control","sensing","operators","variables","lists","other"];SpriteMorph.prototype.blockColor={motion:new Color(74,108,212),looks:new Color(143,86,227),sound:new Color(207,74,217),pen:new Color(0,161,120),control:new Color(230,168,34),sensing:new Color(4,148,220),operators:new Color(98,194,19),variables:new Color(243,118,29),lists:new Color(217,77,17),other:new Color(150,150,150)};SpriteMorph.prototype.customCategories=new Map;SpriteMorph.prototype.allCategories=function(){return this.categories.concat(Array.from(this.customCategories.keys()).sort())};SpriteMorph.prototype.blockColorFor=function(category){return this.blockColor[category]||this.customCategories.get(category)||this.blockColor.other};SpriteMorph.prototype.paletteColor=new Color(55,55,55);SpriteMorph.prototype.paletteTextColor=new Color(230,230,230);SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30);SpriteMorph.prototype.isCachingPrimitives=true;SpriteMorph.prototype.enableNesting=true;SpriteMorph.prototype.enableFirstClass=true;SpriteMorph.prototype.showingExtensions=true;SpriteMorph.prototype.useFlatLineEnds=false;SpriteMorph.prototype.penColorModel="hsv";SpriteMorph.prototype.highlightColor=new Color(250,200,130);SpriteMorph.prototype.highlightBorder=8;SpriteMorph.prototype.bubbleColor=WHITE;SpriteMorph.prototype.bubbleFontSize=14;SpriteMorph.prototype.bubbleFontIsBold=true;SpriteMorph.prototype.bubbleCorner=10;SpriteMorph.prototype.bubbleBorder=3;SpriteMorph.prototype.bubbleBorderColor=new Color(190,190,190);SpriteMorph.prototype.bubbleMaxTextWidth=130;SpriteMorph.prototype.initBlocks=function(){SpriteMorph.prototype.blocks={forward:{only:SpriteMorph,type:"command",category:"motion",spec:"move %n steps",defaults:[10]},turn:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %clockwise %n degrees",defaults:[15]},turnLeft:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %counterclockwise %n degrees",defaults:[15]},setHeading:{only:SpriteMorph,type:"command",category:"motion",spec:"point in direction %dir",defaults:[90]},doFaceTowards:{only:SpriteMorph,type:"command",category:"motion",spec:"point towards %dst",defaults:[["mouse-pointer"]]},gotoXY:{only:SpriteMorph,type:"command",category:"motion",spec:"go to x: %n y: %n",defaults:[0,0]},doGotoObject:{only:SpriteMorph,type:"command",category:"motion",spec:"go to %dst",defaults:[["random position"]]},doGlide:{only:SpriteMorph,type:"command",category:"motion",spec:"glide %n secs to x: %n y: %n",defaults:[1,0,0]},changeXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change x by %n",defaults:[10]},setXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set x to %n",defaults:[0]},changeYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change y by %n",defaults:[10]},setYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set y to %n",defaults:[0]},bounceOffEdge:{only:SpriteMorph,type:"command",category:"motion",spec:"if on edge, bounce"},getPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"position"},xPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"x position"},yPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"y position"},direction:{only:SpriteMorph,type:"reporter",category:"motion",spec:"direction"},doSwitchToCostume:{type:"command",category:"looks",spec:"switch to costume %cst"},doWearNextCostume:{type:"command",category:"looks",spec:"next costume"},getCostumeIdx:{type:"reporter",category:"looks",spec:"costume #"},reportGetImageAttribute:{type:"reporter",category:"looks",spec:"%img of costume %cst",defaults:[["width"],["current"]]},reportNewCostume:{type:"reporter",category:"looks",spec:"new costume %l width %dim height %dim"},reportNewCostumeStretched:{type:"reporter",category:"looks",spec:"stretch %cst x: %n y: %n %",defaults:[["current"],100,50]},doSayFor:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s for %n secs",defaults:[localize("Hello!"),2]},bubble:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s",defaults:[localize("Hello!")]},doThinkFor:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s for %n secs",defaults:[localize("Hmm..."),2]},doThink:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s",defaults:[localize("Hmm...")]},changeEffect:{type:"command",category:"looks",spec:"change %eff effect by %n",defaults:[["ghost"],25]},setEffect:{type:"command",category:"looks",spec:"set %eff effect to %n",defaults:[["ghost"],0]},getEffect:{type:"reporter",category:"looks",spec:"%eff effect",defaults:[["ghost"]]},clearEffects:{type:"command",category:"looks",spec:"clear graphic effects"},changeScale:{only:SpriteMorph,type:"command",category:"looks",spec:"change size by %n",defaults:[10]},setScale:{only:SpriteMorph,type:"command",category:"looks",spec:"set size to %n %",defaults:[100]},getScale:{only:SpriteMorph,type:"reporter",category:"looks",spec:"size"},show:{type:"command",category:"looks",spec:"show"},hide:{type:"command",category:"looks",spec:"hide"},reportShown:{type:"predicate",category:"looks",spec:"shown?"},goToLayer:{only:SpriteMorph,type:"command",category:"looks",spec:"go to %layer layer",defaults:[["front"]]},goBack:{only:SpriteMorph,type:"command",category:"looks",spec:"go back %n layers",defaults:[1]},doScreenshot:{dev:true,type:"command",category:"looks",spec:"save %imgsource as costume named %s",defaults:[["pen trails"],localize("screenshot")]},reportCostumes:{dev:true,type:"reporter",category:"looks",spec:"wardrobe"},alert:{dev:true,type:"command",category:"looks",spec:"alert %mult%s"},log:{dev:true,type:"command",category:"looks",spec:"console log %mult%s"},playSound:{type:"command",category:"sound",spec:"play sound %snd"},doPlaySoundUntilDone:{type:"command",category:"sound",spec:"play sound %snd until done"},doPlaySoundAtRate:{type:"command",category:"sound",spec:"play sound %snd at %rate Hz",defaults:["",44100]},doStopAllSounds:{type:"command",category:"sound",spec:"stop all sounds"},reportGetSoundAttribute:{type:"reporter",category:"sound",spec:"%aa of sound %snd",defaults:[["duration"]]},reportNewSoundFromSamples:{type:"reporter",category:"sound",spec:"new sound %l rate %rate Hz",defaults:[null,44100]},doRest:{type:"command",category:"sound",spec:"rest for %n beats",defaults:[.2]},doPlayNote:{type:"command",category:"sound",spec:"play note %note for %n beats",defaults:[60,.5]},doPlayFrequency:{dev:true,type:"command",category:"sound",spec:"play %n Hz for %n secs",defaults:[440,2]},doSetInstrument:{type:"command",category:"sound",spec:"set instrument to %inst",defaults:[1]},doChangeTempo:{type:"command",category:"sound",spec:"change tempo by %n",defaults:[20]},doSetTempo:{type:"command",category:"sound",spec:"set tempo to %n bpm",defaults:[60]},getTempo:{type:"reporter",category:"sound",spec:"tempo"},changeVolume:{type:"command",category:"sound",spec:"change volume by %n",defaults:[10]},setVolume:{type:"command",category:"sound",spec:"set volume to %n %",defaults:[100]},getVolume:{type:"reporter",category:"sound",spec:"volume"},changePan:{type:"command",category:"sound",spec:"change balance by %n",defaults:[10]},setPan:{type:"command",category:"sound",spec:"set balance to %n",defaults:[0]},getPan:{type:"reporter",category:"sound",spec:"balance"},playFreq:{type:"command",category:"sound",spec:"play frequency %n Hz",defaults:[440]},stopFreq:{type:"command",category:"sound",spec:"stop frequency"},reportSounds:{dev:true,type:"reporter",category:"sound",spec:"jukebox"},clear:{type:"command",category:"pen",spec:"clear"},down:{only:SpriteMorph,type:"command",category:"pen",spec:"pen down"},up:{only:SpriteMorph,type:"command",category:"pen",spec:"pen up"},getPenDown:{only:SpriteMorph,type:"predicate",category:"pen",spec:"pen down?"},setColor:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen color to %clr"},setPenColorDimension:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen %clrdim to %n",defaults:[["hue"],50]},changePenColorDimension:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen %clrdim by %n",defaults:[["hue"],10]},getPenAttribute:{type:"reporter",category:"pen",spec:"pen %pen",defaults:[["hue"]]},setBackgroundColor:{only:StageMorph,type:"command",category:"pen",spec:"set background color to %clr"},setBackgroundColorDimension:{only:StageMorph,type:"command",category:"pen",spec:"set background %clrdim to %n",defaults:[["hue"],50]},changeBackgroundColorDimension:{only:StageMorph,type:"command",category:"pen",spec:"change background %clrdim by %n",defaults:[["hue"],10]},changeSize:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen size by %n",defaults:[1]},setSize:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen size to %n",defaults:[1]},doStamp:{only:SpriteMorph,type:"command",category:"pen",spec:"stamp"},floodFill:{only:SpriteMorph,type:"command",category:"pen",spec:"fill"},write:{only:SpriteMorph,type:"command",category:"pen",spec:"write %s size %n",defaults:[localize("Hello!"),12]},reportPenTrailsAsCostume:{type:"reporter",category:"pen",spec:"pen trails"},reportPentrailsAsSVG:{type:"reporter",category:"pen",spec:"pen vectors"},doPasteOn:{type:"command",category:"pen",spec:"paste on %spr"},doCutFrom:{type:"command",category:"pen",spec:"cut from %spr"},receiveGo:{type:"hat",category:"control",spec:"when %greenflag clicked"},receiveKey:{type:"hat",category:"control",spec:"when %keyHat key pressed %keyName",defaults:[["space"]]},receiveInteraction:{type:"hat",category:"control",spec:"when I am %interaction",defaults:["clicked"]},receiveMessage:{type:"hat",category:"control",spec:"when I receive %msgHat %message",defaults:[""]},receiveCondition:{type:"hat",category:"control",spec:"when %b"},getLastMessage:{dev:true,type:"reporter",category:"control",spec:"message"},doBroadcast:{type:"command",category:"control",spec:"broadcast %msg %receive"},doBroadcastAndWait:{type:"command",category:"control",spec:"broadcast %msg %receive and wait"},doWait:{type:"command",category:"control",spec:"wait %n secs",defaults:[1]},doWaitUntil:{type:"command",category:"control",spec:"wait until %b"},doForever:{type:"command",category:"control",spec:"forever %loop"},doRepeat:{type:"command",category:"control",spec:"repeat %n %loop",defaults:[10]},doUntil:{type:"command",category:"control",spec:"repeat until %b %loop"},doFor:{type:"command",category:"control",spec:"for %upvar = %n to %n %cla",defaults:["i",1,10]},doIf:{type:"command",category:"control",spec:"if %b %c"},doIfElse:{type:"command",category:"control",spec:"if %b %c else %c"},reportIfElse:{type:"reporter",category:"control",spec:"if %b then %s else %s"},doStopThis:{type:"command",category:"control",spec:"stop %stopChoices",defaults:[["all"]]},doRun:{type:"command",category:"control",spec:"run %cmdRing %inputs"},fork:{type:"command",category:"control",spec:"launch %cmdRing %inputs"},evaluate:{type:"reporter",category:"control",spec:"call %repRing %inputs"},doReport:{type:"command",category:"control",spec:"report %s"},doCallCC:{type:"command",category:"control",spec:"run %cmdRing w/continuation"},reportCallCC:{type:"reporter",category:"control",spec:"call %cmdRing w/continuation"},doWarp:{type:"command",category:"other",spec:"warp %c"},doTellTo:{type:"command",category:"control",spec:"tell %spr to %cmdRing %inputs"},reportAskFor:{type:"reporter",category:"control",spec:"ask %spr for %repRing %inputs"},receiveOnClone:{type:"hat",category:"control",spec:"when I start as a clone"},createClone:{type:"command",category:"control",spec:"create a clone of %cln",defaults:[["myself"]]},newClone:{type:"reporter",category:"control",spec:"a new clone of %cln",defaults:[["myself"]]},removeClone:{type:"command",category:"control",spec:"delete this clone"},doDefineBlock:{type:"command",category:"control",spec:"define %upvar %s %repRing",defaults:[["block"]]},doSetBlockAttribute:{type:"command",category:"control",spec:"set %byob of block %repRing to %s",defaults:[["label"]]},doDeleteBlock:{type:"command",category:"control",spec:"delete block %repRing"},reportBlockAttribute:{type:"reporter",category:"control",spec:"%block of block %repRing",defaults:[["definition"]]},reportThisContext:{type:"reporter",category:"control",spec:"this script"},doPauseAll:{type:"command",category:"control",spec:"pause all %pause"},doSwitchToScene:{type:"command",category:"control",spec:"switch to scene %scn %send",defaults:[["next"]]},reportTouchingObject:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %col ?",defaults:[["mouse-pointer"]]},reportTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %clr ?"},reportColorIsTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"color %clr is touching %clr ?"},reportAspect:{type:"reporter",category:"sensing",spec:"%asp at %loc",defaults:[["hue"],["mouse-pointer"]]},reportStackSize:{dev:true,type:"reporter",category:"sensing",spec:"stack size"},reportFrameCount:{dev:true,type:"reporter",category:"sensing",spec:"frames"},reportYieldCount:{dev:true,type:"reporter",category:"sensing",spec:"yields"},reportThreadCount:{dev:true,type:"reporter",category:"sensing",spec:"processes"},doAsk:{type:"command",category:"sensing",spec:"ask %s and wait",defaults:[localize("what's your name?")]},reportLastAnswer:{dev:true,type:"reporter",category:"sensing",spec:"answer"},getLastAnswer:{type:"reporter",category:"sensing",spec:"answer"},reportMousePosition:{type:"reporter",category:"sensing",spec:"mouse position"},reportMouseX:{type:"reporter",category:"sensing",spec:"mouse x"},reportMouseY:{type:"reporter",category:"sensing",spec:"mouse y"},reportMouseDown:{type:"predicate",category:"sensing",spec:"mouse down?"},reportKeyPressed:{type:"predicate",category:"sensing",spec:"key %key pressed?",defaults:[["space"]]},reportRelationTo:{only:SpriteMorph,type:"reporter",category:"sensing",spec:"%rel to %dst",defaults:[["distance"],["mouse-pointer"]]},doResetTimer:{type:"command",category:"sensing",spec:"reset timer"},reportTimer:{dev:true,type:"reporter",category:"sensing",spec:"timer"},getTimer:{type:"reporter",category:"sensing",spec:"timer"},reportAttributeOf:{type:"reporter",category:"sensing",spec:"%att of %spr",defaults:[["costume #"]]},reportObject:{type:"reporter",category:"sensing",spec:"object %self",defaults:[["myself"]]},reportURL:{type:"reporter",category:"sensing",spec:"url %s",defaults:["snap.berkeley.edu"]},doSetGlobalFlag:{type:"command",category:"sensing",spec:"set %setting to %b",defaults:[["video capture"]]},reportGlobalFlag:{type:"predicate",category:"sensing",spec:"is %setting on?",defaults:[["turbo mode"]]},reportDate:{type:"reporter",category:"sensing",spec:"current %dates",defaults:[["date"]]},reportGet:{type:"reporter",category:"sensing",spec:"my %get",defaults:[["neighbors"]]},reportAudio:{type:"reporter",category:"sensing",spec:"microphone %audio",defaults:[["volume"]]},reifyScript:{type:"ring",category:"other",spec:"%rc %ringparms",alias:"command ring lambda"},reifyReporter:{type:"ring",category:"other",spec:"%rr %ringparms",alias:"reporter ring lambda"},reifyPredicate:{type:"ring",category:"other",spec:"%rp %ringparms",alias:"predicate ring lambda"},reportVariadicSum:{type:"reporter",category:"operators",spec:"%sum",alias:"+"},reportDifference:{type:"reporter",category:"operators",spec:"%n − %n",alias:"-"},reportVariadicProduct:{type:"reporter",category:"operators",spec:"%product",alias:"*"},reportQuotient:{type:"reporter",category:"operators",spec:"%n / %n"},reportRound:{type:"reporter",category:"operators",spec:"round %n"},reportMonadic:{type:"reporter",category:"operators",spec:"%fun of %n",defaults:[["sqrt"],10]},reportPower:{type:"reporter",category:"operators",spec:"%n ^ %n"},reportModulus:{type:"reporter",category:"operators",spec:"%n mod %n"},reportAtan2:{type:"reporter",category:"operators",spec:"atan2 %n ÷ %n"},reportVariadicMin:{type:"reporter",category:"operators",spec:"%min",alias:"min"},reportVariadicMax:{type:"reporter",category:"operators",spec:"%max",alias:"max"},reportRandom:{type:"reporter",category:"operators",spec:"pick random %n to %n",defaults:[1,10]},reportEquals:{type:"predicate",category:"operators",spec:"%s = %s"},reportNotEquals:{type:"predicate",category:"operators",spec:"%s ≠ %s"},reportLessThan:{type:"predicate",category:"operators",spec:"%s < %s"},reportLessThanOrEquals:{type:"predicate",category:"operators",spec:"%s ≤ %s"},reportGreaterThan:{type:"predicate",category:"operators",spec:"%s > %s"},reportGreaterThanOrEquals:{type:"predicate",category:"operators",spec:"%s ≥ %s"},reportAnd:{type:"predicate",category:"operators",spec:"%b and %b"},reportOr:{type:"predicate",category:"operators",spec:"%b or %b"},reportNot:{type:"predicate",category:"operators",spec:"not %b"},reportBoolean:{type:"predicate",category:"operators",spec:"%bool",defaults:[true],alias:"true boolean"},reportFalse:{type:"predicate",category:"operators",spec:"%bool",defaults:[false],alias:"false boolean"},reportJoinWords:{type:"reporter",category:"operators",spec:"join %words",defaults:[localize("hello")+" ",localize("world")]},reportLetter:{type:"reporter",category:"operators",spec:"letter %idx of %s",defaults:[1,localize("world")]},reportStringSize:{type:"reporter",category:"operators",spec:"length of %s",defaults:[localize("world")]},reportUnicode:{type:"reporter",category:"operators",spec:"unicode of %s",defaults:["a"]},reportUnicodeAsLetter:{type:"reporter",category:"operators",spec:"unicode %n as letter",defaults:[65]},reportIsA:{type:"predicate",category:"operators",spec:"is %s a %typ ?",defaults:[5,["number"]]},reportIsIdentical:{type:"predicate",category:"operators",spec:"is %s identical to %s ?"},reportTextSplit:{type:"reporter",category:"operators",spec:"split %s by %delim",defaults:[localize("hello")+" "+localize("world")," "]},reportJSFunction:{type:"reporter",category:"operators",spec:"JavaScript function ( %mult%s ) { %code }"},reportTypeOf:{dev:true,type:"reporter",category:"operators",spec:"type of %s",defaults:[5]},reportTextFunction:{dev:true,type:"reporter",category:"operators",spec:"%txtfun of %s",defaults:[["encode URI"],"Abelson & Sussman"]},reportCompiled:{dev:true,type:"reporter",category:"operators",spec:"compile %repRing for %n args",defaults:[null,0]},doSetVar:{type:"command",category:"variables",spec:"set %var to %s",defaults:[null,0]},doChangeVar:{type:"command",category:"variables",spec:"change %var by %n",defaults:[null,1]},doShowVar:{type:"command",category:"variables",spec:"show variable %var"},doHideVar:{type:"command",category:"variables",spec:"hide variable %var"},doDeclareVariables:{type:"command",category:"other",spec:"script variables %scriptVars"},doDeleteAttr:{type:"command",category:"variables",spec:"inherit %shd"},reportNewList:{type:"reporter",category:"lists",spec:"list %exp"},reportCONS:{type:"reporter",category:"lists",spec:"%s in front of %l"},reportListItem:{type:"reporter",category:"lists",spec:"item %idx of %l",defaults:[1]},reportCDR:{type:"reporter",category:"lists",spec:"all but first of %l"},reportListLength:{dev:true,type:"reporter",category:"lists",spec:"length of %l"},reportListAttribute:{type:"reporter",category:"lists",spec:"%la of %l",defaults:[["length"]]},reportListContainsItem:{type:"predicate",category:"lists",spec:"%l contains %s",defaults:[null,localize("thing")]},reportListIsEmpty:{type:"predicate",category:"lists",spec:"is %l empty?"},reportListIndex:{type:"reporter",category:"lists",spec:"index of %s in %l",defaults:[localize("thing")]},doAddToList:{type:"command",category:"lists",spec:"add %s to %l",defaults:[localize("thing")]},doDeleteFromList:{type:"command",category:"lists",spec:"delete %ida of %l",defaults:[1]},doInsertInList:{type:"command",category:"lists",spec:"insert %s at %idx of %l",defaults:[localize("thing"),1]},doReplaceInList:{type:"command",category:"lists",spec:"replace item %idx of %l with %s",defaults:[1,null,localize("thing")]},reportNumbers:{type:"reporter",category:"lists",spec:"numbers from %n to %n",defaults:[1,10]},reportConcatenatedLists:{type:"reporter",category:"lists",spec:"append %lists"},reportCrossproduct:{type:"reporter",category:"lists",spec:"combinations %lists"},reportTranspose:{type:"reporter",category:"lists",spec:"transpose %l"},reportReshape:{type:"reporter",category:"lists",spec:"reshape %l to %nums",defaults:[null,[4,3]]},reportMap:{type:"reporter",category:"lists",spec:"map %repRing over %l"},reportAtomicMap:{dev:true,type:"reporter",category:"lists",spec:"%blitz map %repRing over %l"},reportKeep:{type:"reporter",category:"lists",spec:"keep items %predRing from %l"},reportAtomicKeep:{dev:true,type:"reporter",category:"lists",spec:"%blitz keep items %predRing from %l"},reportFindFirst:{type:"reporter",category:"lists",spec:"find first item %predRing in %l"},reportAtomicFindFirst:{dev:true,type:"reporter",category:"lists",spec:"%blitz find first item %predRing in %l"},reportCombine:{type:"reporter",category:"lists",spec:"combine %l using %repRing"},reportAtomicCombine:{dev:true,type:"reporter",category:"lists",spec:"%blitz combine %l using %repRing"},doForEach:{type:"command",category:"lists",spec:"for each %upvar in %l %cla",defaults:[localize("item")]},doShowTable:{dev:true,type:"command",category:"lists",spec:"show table %l"},doMapCodeOrHeader:{type:"command",category:"other",spec:"map %cmdRing to %codeKind %code",defaults:[null,["code"]]},doMapValueCode:{type:"command",category:"other",spec:"map %mapValue to code %code",defaults:[["String"],"<#1>"]},doMapListCode:{type:"command",category:"other",spec:"map %codeListPart of %codeListKind to code %code"},reportMappedCode:{type:"reporter",category:"other",spec:"code of %cmdRing"},doApplyExtension:{type:"command",category:"other",spec:"primitive %prim %mult%s"},reportApplyExtension:{type:"reporter",category:"other",spec:"primitive %prim %mult%s"},doSetVideoTransparency:{type:"command",category:"sensing",spec:"set video transparency to %n",defaults:[50]},reportVideo:{type:"reporter",category:"sensing",spec:"video %vid on %self",defaults:[["motion"],["myself"]]}}};SpriteMorph.prototype.initBlocks();SpriteMorph.prototype.initBlockMigrations=function(){SpriteMorph.prototype.blockMigrations={doStopAll:{selector:"doStopThis",inputs:[["all"]]},doStop:{selector:"doStopThis",inputs:[["this script"]]},doStopBlock:{selector:"doStopThis",inputs:[["this block"]]},doStopOthers:{selector:"doStopThis",inputs:[["all"]],offset:0},receiveClick:{selector:"receiveInteraction",inputs:[["clicked"]]},reportTrue:{selector:"reportBoolean",inputs:[true]},reportFalse:{selector:"reportBoolean",inputs:[false]},reportCostumes:{selector:"reportGet",inputs:[["costumes"]]},reportSounds:{selector:"reportGet",inputs:[["sounds"]]},doMapStringCode:{selector:"doMapValueCode",inputs:[["String"],"<#1>"],offset:1},reportDistanceTo:{selector:"reportRelationTo",inputs:[["distance"]],offset:1},comeToFront:{selector:"goToLayer",inputs:[["front"]]},setHue:{selector:"setPenColorDimension",inputs:[["hue"]],offset:1},setBrightness:{selector:"setPenColorDimension",inputs:[["brightness"]],offset:1},setPenHSVA:{selector:"setPenColorDimension"},changeHue:{selector:"changePenColorDimension",inputs:[["hue"]],offset:1},changeBrightness:{selector:"changePenColorDimension",inputs:[["brightness"]],offset:1},changePenHSVA:{selector:"changePenColorDimension"},setBackgroundHSVA:{selector:"setBackgroundColorDimension"},changeBackgroundHSVA:{selector:"changeBackgroundColorDimension"},reportIsFastTracking:{selector:"reportGlobalFlag",inputs:[["turbo mode"]],offset:1},doSetFastTracking:{selector:"doSetGlobalFlag",inputs:[["turbo mode"]],offset:1},reportTableRotated:{selector:"reportListAttribute",inputs:[["transpose"]],offset:1},reportTranspose:{selector:"reportListAttribute",inputs:[["transpose"]],offset:1},reportListLength:{selector:"reportListAttribute",inputs:[["length"]],offset:1},doSend:{selector:"doBroadcast",expand:1},reportSum:{selector:"reportVariadicSum",variadic:true},reportProduct:{selector:"reportVariadicProduct",variadic:true},reportMin:{selector:"reportVariadicMin",variadic:true},reportMax:{selector:"reportVariadicMax",variadic:true}}};SpriteMorph.prototype.initBlockMigrations();SpriteMorph.prototype.blockAlternatives={forward:["changeXPosition","changeYPosition"],turn:["turnLeft"],turnLeft:["turn"],doFaceTowards:["doGotoObject"],gotoXY:[["doGlide",1]],doGotoObject:["doFaceTowards"],doGlide:[["gotoXY",-1]],changeXPosition:["changeYPosition","setXPosition","setYPosition","forward"],setXPosition:["setYPosition","changeXPosition","changeYPosition"],changeYPosition:["changeXPosition","setYPosition","setXPosition","forward"],setYPosition:["setXPosition","changeYPosition","changeXPosition"],xPosition:["yPosition","getPosition"],yPosition:["xPosition","getPosition"],getPosition:["xPosition","yPosition"],doSayFor:["doThinkFor","bubble","doThink","doAsk"],doThinkFor:["doSayFor","doThink","bubble","doAsk"],bubble:["doThink","doAsk","doSayFor","doThinkFor"],doThink:["bubble","doAsk","doSayFor","doThinkFor"],show:["hide"],hide:["show"],changeEffect:["setEffect"],setEffect:["changeEffect"],changeScale:["setScale"],setScale:["changeScale"],playSound:["doPlaySoundUntilDone","doPlaySoundAtRate"],doPlaySoundUntilDone:["playSound","doPlaySoundAtRate"],doPlaySoundAtRate:["playSound","doPlaySoundUntilDone"],doPlayNote:[["doRest",-1]],doRest:[["doPlayNote",1]],doChangeTempo:["doSetTempo"],doSetTempo:["doChangeTempo"],setVolume:["changeVolume"],changeVolume:["setVolume"],setPan:["changePan"],changePan:["setPan"],getVolume:["getTempo","getPan"],getTempo:["getVolume","getPan"],getPan:["getVolume","getTempo"],clear:["down","up","doStamp"],down:["up","clear","doStamp"],up:["down","clear","doStamp"],doPasteOn:["doCutFrom"],doCutFrom:["doPasteOn"],doStamp:["clear","down","up"],setPenColorDimension:["changePenColorDimension"],changePenColorDimension:["setPenColorDimension"],setBackgroundColorDimension:["changeBackgroundColorDimension"],changeBackgroundColorDimension:["setBackgroundColorDimension"],changeSize:["setSize"],setSize:["changeSize"],doBroadcast:["doBroadcastAndWait"],doBroadcastAndWait:["doBroadcast"],doIf:["doIfElse","doUntil"],doIfElse:["doIf","doUntil"],doRepeat:["doUntil",["doForever",-1],["doFor",2],["doForEach",1]],doUntil:["doRepeat","doIf",["doForever",-1],["doFor",2],["doForEach",1]],doForever:[["doUntil",1],["doRepeat",1],["doFor",3],["doForEach",2]],doFor:[["doForever",-3],["doRepeat",-2],["doUntil",-2],["doForEach",-1]],doAsk:["bubble","doThink","doSayFor","doThinkFor"],getLastAnswer:["getTimer"],getTimer:["getLastAnswer"],reportMouseX:["reportMouseY","reportMousePosition"],reportMouseY:["reportMouseX","reportMousePosition"],reportMousePosition:["reportMouseX","reportMouseY"],reportVariadicSum:["reportDifference","reportVariadicProduct","reportQuotient","reportPower","reportModulus","reportAtan2","reportVariadicMin","reportVariadicMax"],reportDifference:["reportVariadicSum","reportVariadicProduct","reportQuotient","reportPower","reportModulus","reportAtan2","reportVariadicMin","reportVariadicMax"],reportVariadicProduct:["reportDifference","reportVariadicSum","reportQuotient","reportPower","reportModulus","reportAtan2","reportVariadicMin","reportVariadicMax"],reportQuotient:["reportDifference","reportVariadicProduct","reportVariadicSum","reportPower","reportModulus","reportAtan2","reportVariadicMin","reportVariadicMax"],reportPower:["reportDifference","reportVariadicProduct","reportVariadicSum","reportQuotient","reportModulus","reportAtan2","reportVariadicMin","reportVariadicMax"],reportModulus:["reportAtan2","reportDifference","reportVariadicProduct","reportVariadicSum","reportQuotient","reportPower","reportVariadicMin","reportVariadicMax"],reportAtan2:["reportModulus","reportDifference","reportVariadicProduct","reportVariadicSum","reportQuotient","reportPower","reportVariadicMin","reportVariadicMax"],reportVariadicMin:["reportVariadicMax","reportVariadicSum","reportDifference","reportVariadicProduct","reportQuotient","reportPower","reportModulus","reportAtan2"],reportVariadicMax:["reportVariadicMin","reportVariadicSum","reportDifference","reportVariadicProduct","reportQuotient","reportPower","reportModulus","reportAtan2"],reportLessThan:["reportLessThanOrEquals","reportEquals","reportIsIdentical","reportNotEquals","reportGreaterThan","reportGreaterThanOrEquals"],reportEquals:["reportIsIdentical","reportNotEquals","reportLessThan","reportLessThanOrEquals","reportGreaterThan","reportGreaterThanOrEquals"],reportNotEquals:["reportEquals","reportIsIdentical","reportLessThan","reportLessThanOrEquals","reportGreaterThan","reportGreaterThanOrEquals"],reportGreaterThan:["reportGreaterThanOrEquals","reportEquals","reportIsIdentical","reportNotEquals","reportLessThan","reportLessThanOrEquals"],reportLessThanOrEquals:["reportLessThan","reportEquals","reportIsIdentical","reportNotEquals","reportGreaterThan","reportGreaterThanOrEquals"],reportGreaterThanOrEquals:["reportGreaterThan","reportEquals","reportIsIdentical","reportNotEquals","reportLessThan","reportLessThanOrEquals"],reportIsIdentical:["reportEquals","reportNotEquals","reportLessThan","reportLessThanOrEquals","reportGreaterThan","reportGreaterThanOrEquals"],reportAnd:["reportOr"],reportOr:["reportAnd"],doSetVar:["doChangeVar"],doChangeVar:["doSetVar"],doShowVar:["doHideVar"],doHideVar:["doShowVar"],reportConcatenatedLists:["reportCrossproduct"],reportCrossproduct:["reportConcatenatedLists"],reportMap:["reportKeep","reportFindFirst"],reportKeep:["reportFindFirst","reportMap"],reportFindFirst:["reportKeep","reportMap"],doForEach:[["doFor",1],["doForever",-2],["doRepeat",-1],["doUntil",-1]]};function SpriteMorph(globals){this.init(globals)}SpriteMorph.prototype.init=function(globals){this.name=localize("Sprite");this.variables=new VariableFrame(globals||null,this);this.scripts=new ScriptsMorph;this.customBlocks=[];this.costumes=new List;this.costumes.type="costume";this.costume=null;this.sounds=new List;this.sounds.type="sound";this.normalExtent=new Point(60,60);this.scale=1;this.rotationStyle=1;this.instrument=null;this.version=Date.now();this.isTemporary=false;this.isCorpse=false;this.cloneOriginName="";this.volume=100;this.gainNode=null;this.pan=0;this.pannerNode=null;this.freqPlayer=null;this.cachedColorDimensions=[0,0,0];this.inheritedMethodsCache=[];this.parts=[];this.anchor=null;this.nestingScale=1;this.rotatesWithAnchor=true;this.layers=null;this.primitivesCache={};this.paletteCache={};this.categoriesCache=null;this.rotationOffset=ZERO;this.idx=0;this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0};this.exemplar=null;this.instances=[];this.cachedPropagation=false;this.inheritedAttributes=[];this.imageExtent=ZERO;this.imageOffset=ZERO;this.imageData={};this.motionAmount=0;this.motionDirection=0;this.frameNumber=0;SpriteMorph.uber.init.call(this);this.isCachingImage=true;this.isFreeForm=true;this.cachedColorDimensions=this.color[this.penColorModel]();this.isDraggable=true;this.isDown=false;this.heading=90;this.fixLayout();this.rerender()};SpriteMorph.prototype.fullCopy=function(forClone){var c=SpriteMorph.uber.fullCopy.call(this),arr=[],cb,effect;c.cachedImage=copyCanvas(this.cachedImage);c.instances=[];c.stopTalking();c.color=this.color.copy();c.gainNode=null;c.pannerNode=null;c.freqPlayer=null;c.primitivesCache={};c.paletteCache={};c.categoriesCache=null;c.imageData={};c.cachedColorDimensions=c.color[this.penColorModel]();arr=[];this.inheritedAttributes.forEach(att=>arr.push(att));c.inheritedAttributes=arr;if(forClone){c.exemplar=this;c.customBlocks=[];c.variables=new VariableFrame(null,c);c.variables.parentFrame=this.variables;c.inheritedVariableNames().forEach(name=>c.shadowVar(name,c.variables.getVar(name)));this.addSpecimen(c);this.cachedPropagation=false;["scripts","costumes","sounds"].forEach(att=>{if(!contains(c.inheritedAttributes,att)){c.inheritedAttributes.push(att)}})}else{c.variables=this.variables.copy();c.variables.owner=c;c.scripts=this.scripts.fullCopy();c.customBlocks=[];this.customBlocks.forEach(def=>{cb=def.copyAndBindTo(c);c.customBlocks.push(cb);c.allBlockInstances(def).forEach(block=>block.definition=cb)});arr=[];this.costumes.asArray().forEach(costume=>{var cst=forClone?costume:costume.copy();arr.push(cst);if(costume===this.costume){c.costume=cst}});c.costumes=new List(arr);c.costumes.type="costume";arr=[];this.sounds.asArray().forEach(sound=>{var snd=forClone?sound:sound.copy();arr.push(snd)});c.sounds=new List(arr);c.sounds.type="sound";arr=[]}c.nestingScale=1;c.rotatesWithAnchor=true;c.anchor=null;c.parts=[];this.parts.forEach(part=>{var dp=part.fullCopy(forClone);dp.nestingScale=part.nestingScale;dp.rotatesWithAnchor=part.rotatesWithAnchor;c.attachPart(dp)});c.graphicsValues={};for(effect in this.graphicsValues){if(this.graphicsValues.hasOwnProperty(effect)){c.graphicsValues[effect]=this.graphicsValues[effect]}}return c};SpriteMorph.prototype.appearIn=function(ide){if(!this.isTemporary){this.name=ide.newSpriteName(this.name);ide.corral.addSprite(this);ide.sprites.add(this)}ide.stage.add(this);this.parts.forEach(part=>part.appearIn(ide))};SpriteMorph.prototype.setName=function(string){this.name=string||this.name;this.version=Date.now()};SpriteMorph.prototype.getImage=function(){if(this.shouldRerender||!this.cachedImage){this.cachedImage=newCanvas(this.costume?this.imageExtent:this.extent(),!isNil(this.costume),this.cachedImage);this.render(this.cachedImage.getContext("2d"));this.shouldRerender=false}return this.cachedImage};SpriteMorph.prototype.fixLayout=function(){var currentCenter,facing,isFlipped,isLoadingCostume,pic,imageSide,stageScale,newX,corners=[],origin,corner,costumeExtent;currentCenter=this.center();isLoadingCostume=this.costume&&typeof this.costume.loaded==="function";stageScale=this.parent instanceof StageMorph?this.parent.scale:1;facing=this.rotationStyle?this.heading:90;if(this.rotationStyle===2){facing=90;if(this.heading>180&&this.heading<360||this.heading<0&&this.heading>-180){isFlipped=true}}if(this.costume&&!isLoadingCostume){pic=isFlipped?this.costume.flipped():this.costume;corners=pic.bounds().corners().map(point=>point.rotateBy(radians(facing-90),this.costume.center()));origin=corners[0];corner=corners[0];corners.forEach(point=>{origin=origin.min(point);corner=corner.max(point)});costumeExtent=origin.corner(corner).extent().multiplyBy(this.scale*stageScale);this.imageOffset=ZERO.rotateBy(radians(-(facing-90)),pic.center()).subtract(origin);if(this.rotationStyle===1){imageSide=Math.sqrt(Math.pow(pic.width(),2)+Math.pow(pic.height(),2))*this.scale*stageScale;this.imageExtent=new Point(imageSide,imageSide)}else{this.imageExtent=costumeExtent}this.bounds.setExtent(costumeExtent);this.setCenter(currentCenter,true);this.rotationOffset=this.imageOffset.translateBy(pic.rotationCenter).rotateBy(radians(-(facing-90)),this.imageOffset).scaleBy(this.scale*stageScale)}else{facing=isFlipped?-90:facing;newX=Math.min(Math.max(this.normalExtent.x*this.scale*stageScale,5),1e3);this.bounds.setWidth(newX);this.bounds.setHeight(newX);this.setCenter(currentCenter,true);this.rotationOffset=this.extent().divideBy(2)}};SpriteMorph.prototype.render=function(ctx){var myself=this,facing,isFlipped,isLoadingCostume,cst,pic,stageScale,handle;isLoadingCostume=this.costume&&typeof this.costume.loaded==="function";stageScale=this.parent instanceof StageMorph?this.parent.scale:1;facing=this.rotationStyle?this.heading:90;if(this.rotationStyle===2){facing=90;if(this.heading>180&&this.heading<360||this.heading<0&&this.heading>-180){isFlipped=true}}if(this.costume&&!isLoadingCostume){pic=isFlipped?this.costume.flipped():this.costume;ctx.save();ctx.scale(this.scale*stageScale,this.scale*stageScale);ctx.translate(this.imageOffset.x,this.imageOffset.y);ctx.rotate(radians(facing-90));ctx.drawImage(pic.contents,0,0);ctx.restore()}else{facing=isFlipped?-90:facing;SpriteMorph.uber.render.call(this,ctx,facing);if(isLoadingCostume){cst=this.costume;handle=setInterval(function(){myself.wearCostume(cst,true);clearInterval(handle)},100);return this.wearCostume(null,true)}}this.cachedImage=this.applyGraphicsEffects(this.cachedImage);this.version=Date.now()};SpriteMorph.prototype.rotationCenter=function(){return this.position().add(this.rotationOffset)};SpriteMorph.prototype.getImageData=function(){if(this.version!==this.imageData.version){var stage=this.parentThatIsA(StageMorph),ext=this.extent(),newExtent=new Point(Math.floor(ext.x/stage.scale),Math.floor(ext.y/stage.scale)),canvas=newCanvas(newExtent,true),canvasContext,imageData;canvasContext=canvas.getContext("2d");canvasContext.drawImage(this.getImage(),0,0,Math.floor(ext.x),Math.floor(ext.y),0,0,newExtent.x,newExtent.y);imageData=canvasContext.getImageData(0,0,newExtent.x,newExtent.y).data;this.imageData={version:this.version,pixels:new Uint32Array(imageData.buffer.slice(0))}}return this.imageData.pixels};SpriteMorph.prototype.projectionSnap=function(){var stage=this.parentThatIsA(StageMorph),center=this.center().subtract(stage.position()).divideBy(stage.scale),cst=this.costume||this.getImage(),w,h,rot,offset,snap,ctx;if(cst instanceof Costume){rot=cst.rotationCenter.copy();cst=cst.contents;w=cst.width;h=cst.height}else{w=this.width();h=this.height()}offset=new Point(Math.floor(center.x-w/2),Math.floor(center.y-h/2));snap=newCanvas(new Point(w,h),true);ctx=snap.getContext("2d");ctx.drawImage(cst,0,0);ctx.globalCompositeOperation="source-atop";ctx.drawImage(stage.projectionLayer(),-offset.x,-offset.y);return new Costume(snap,this.newCostumeName(localize("snap")),rot)};SpriteMorph.prototype.blockForSelector=function(selector,setDefaults){var migration,info,block,defaults,inputs,i;migration=this.blockMigrations[selector];info=this.blocks[migration?migration.selector:selector];if(!info){return null}block=info.type==="command"?new CommandBlockMorph:info.type==="hat"?new HatBlockMorph:info.type==="ring"?new RingMorph:new ReporterBlockMorph(info.type==="predicate");block.color=this.blockColorFor(info.category);block.category=info.category;block.selector=migration?migration.selector:selector;if(contains(["reifyReporter","reifyPredicate"],block.selector)){block.isStatic=true}block.setSpec(localize(info.spec));if(migration&&migration.expand){block.inputs()[migration.expand].addInput()}if(setDefaults&&info.defaults||migration&&migration.inputs){defaults=migration?migration.inputs:info.defaults;block.defaults=defaults;inputs=block.inputs();if(inputs[0]instanceof MultiArgMorph){inputs[0].setContents(defaults);inputs[0].defaults=defaults}else{for(i=0;i<defaults.length;i+=1){if(defaults[i]!==null){inputs[i].setContents(defaults[i]);if(inputs[i]instanceof MultiArgMorph){inputs[i].defaults=defaults[i]}}}}}return block};SpriteMorph.prototype.variableBlock=function(varName,isLocalTemplate){var block=new ReporterBlockMorph(false);block.selector="reportGetVar";block.color=this.blockColor.variables;block.category="variables";block.isLocalVarTemplate=isLocalTemplate;block.setSpec(varName);block.isDraggable=true;return block};SpriteMorph.prototype.blockTemplates=function(category="motion",all=false){var blocks=[],myself=this,varNames,inheritedVars=this.inheritedVariableNames(),wrld=this.world(),devMode=wrld&&wrld.isDevMode;function block(selector,isGhosted){if(StageMorph.prototype.hiddenPrimitives[selector]&&!all){return null}var newBlock=SpriteMorph.prototype.blockForSelector(selector,true);newBlock.isTemplate=true;if(isGhosted){newBlock.ghost()}return newBlock}function variableBlock(varName,isLocal){var newBlock=SpriteMorph.prototype.variableBlock(varName,isLocal);newBlock.isDraggable=false;newBlock.isTemplate=true;if(contains(inheritedVars,varName)){newBlock.ghost()}return newBlock}function watcherToggle(selector){if(StageMorph.prototype.hiddenPrimitives[selector]){return null}var info=SpriteMorph.prototype.blocks[selector];return new ToggleMorph("checkbox",this,function(){myself.toggleWatcher(selector,localize(info.spec),myself.blockColor[info.category])},null,function(){return myself.showingWatcher(selector)},null)}function variableWatcherToggle(varName){return new ToggleMorph("checkbox",this,function(){myself.toggleVariableWatcher(varName)},null,function(){return myself.showingVariableWatcher(varName)},null)}if(category==="motion"){blocks.push(block("forward"));blocks.push(block("turn"));blocks.push(block("turnLeft"));blocks.push("-");blocks.push(block("setHeading"));blocks.push(block("doFaceTowards"));blocks.push("-");blocks.push(block("gotoXY"));blocks.push(block("doGotoObject"));blocks.push(block("doGlide"));blocks.push("-");blocks.push(block("changeXPosition"));blocks.push(block("setXPosition"));blocks.push(block("changeYPosition"));blocks.push(block("setYPosition"));blocks.push("-");blocks.push(block("bounceOffEdge"));blocks.push("-");blocks.push(block("getPosition"));blocks.push(watcherToggle("xPosition"));blocks.push(block("xPosition",this.inheritsAttribute("x position")));blocks.push(watcherToggle("yPosition"));blocks.push(block("yPosition",this.inheritsAttribute("y position")));blocks.push(watcherToggle("direction"));blocks.push(block("direction",this.inheritsAttribute("direction")))}else if(category==="looks"){blocks.push(block("doSwitchToCostume"));blocks.push(block("doWearNextCostume"));blocks.push(watcherToggle("getCostumeIdx"));blocks.push(block("getCostumeIdx",this.inheritsAttribute("costume #")));blocks.push("-");blocks.push(block("doSayFor"));blocks.push(block("bubble"));blocks.push(block("doThinkFor"));blocks.push(block("doThink"));blocks.push("-");blocks.push(block("reportGetImageAttribute"));blocks.push(block("reportNewCostumeStretched"));blocks.push(block("reportNewCostume"));blocks.push("-");blocks.push(block("changeEffect"));blocks.push(block("setEffect"));blocks.push(block("clearEffects"));blocks.push(block("getEffect"));blocks.push("-");blocks.push(block("changeScale"));blocks.push(block("setScale"));blocks.push(watcherToggle("getScale"));blocks.push(block("getScale",this.inheritsAttribute("size")));blocks.push("-");blocks.push(block("show"));blocks.push(block("hide"));blocks.push(watcherToggle("reportShown"));blocks.push(block("reportShown",this.inheritsAttribute("shown?")));blocks.push("-");blocks.push(block("goToLayer"));blocks.push(block("goBack"));if(devMode){blocks.push("-");blocks.push(this.devModeText());blocks.push("-");blocks.push(block("log"));blocks.push(block("alert"));blocks.push("-");blocks.push(block("doScreenshot"))}}else if(category==="sound"){blocks.push(block("playSound"));blocks.push(block("doPlaySoundUntilDone"));blocks.push(block("doStopAllSounds"));blocks.push("-");blocks.push(block("doPlaySoundAtRate"));blocks.push(block("reportGetSoundAttribute"));blocks.push(block("reportNewSoundFromSamples"));blocks.push("-");blocks.push(block("doRest"));blocks.push(block("doPlayNote"));blocks.push(block("doSetInstrument"));blocks.push("-");blocks.push(block("doChangeTempo"));blocks.push(block("doSetTempo"));blocks.push(watcherToggle("getTempo"));blocks.push(block("getTempo"));blocks.push("-");blocks.push(block("changeVolume"));blocks.push(block("setVolume"));blocks.push(watcherToggle("getVolume"));blocks.push(block("getVolume",this.inheritsAttribute("volume")));blocks.push("-");blocks.push(block("changePan"));blocks.push(block("setPan"));blocks.push(watcherToggle("getPan"));blocks.push(block("getPan",this.inheritsAttribute("balance")));blocks.push("-");blocks.push(block("playFreq"));blocks.push(block("stopFreq"));if(devMode){blocks.push("-");blocks.push(this.devModeText());blocks.push("-");blocks.push(block("doPlayFrequency"))}}else if(category==="pen"){blocks.push(block("clear"));blocks.push("-");blocks.push(block("down"));blocks.push(block("up"));blocks.push(watcherToggle("getPenDown"));blocks.push(block("getPenDown",this.inheritsAttribute("pen down?")));blocks.push("-");blocks.push(block("setColor"));blocks.push(block("changePenColorDimension"));blocks.push(block("setPenColorDimension"));blocks.push(block("getPenAttribute"));blocks.push("-");blocks.push(block("changeSize"));blocks.push(block("setSize"));blocks.push("-");blocks.push(block("doStamp"));blocks.push(block("floodFill"));blocks.push(block("write"));blocks.push("-");blocks.push(block("reportPenTrailsAsCostume"));blocks.push("-");blocks.push(block("doPasteOn"));blocks.push(block("doCutFrom"))}else if(category==="control"){blocks.push(block("receiveGo"));blocks.push(block("receiveKey"));blocks.push(block("receiveInteraction"));blocks.push(block("receiveCondition"));blocks.push("-");blocks.push(block("receiveMessage"));blocks.push(block("doBroadcast"));blocks.push(block("doBroadcastAndWait"));blocks.push("-");blocks.push(block("doWarp"));blocks.push("-");blocks.push(block("doWait"));blocks.push(block("doWaitUntil"));blocks.push("-");blocks.push(block("doForever"));blocks.push(block("doRepeat"));blocks.push(block("doUntil"));blocks.push(block("doFor"));blocks.push("-");blocks.push(block("doIf"));blocks.push(block("doIfElse"));blocks.push(block("reportIfElse"));blocks.push("-");blocks.push(block("doReport"));blocks.push(block("doStopThis"));blocks.push("-");blocks.push(block("doRun"));blocks.push(block("fork"));blocks.push(block("evaluate"));blocks.push("-");blocks.push(block("doTellTo"));blocks.push(block("reportAskFor"));blocks.push("-");blocks.push(block("doCallCC"));blocks.push(block("reportCallCC"));blocks.push("-");blocks.push(block("receiveOnClone"));blocks.push(block("createClone"));blocks.push(block("newClone"));blocks.push(block("removeClone"));blocks.push("-");blocks.push(block("doPauseAll"));blocks.push(block("doSwitchToScene"));blocks.push("-");blocks.push(block("doDefineBlock"));blocks.push(block("doDeleteBlock"));blocks.push(block("doSetBlockAttribute"));blocks.push(block("reportBlockAttribute"));blocks.push(block("reportThisContext"));if(devMode){blocks.push("-");blocks.push(this.devModeText());blocks.push("-");blocks.push(watcherToggle("getLastMessage"));blocks.push(block("getLastMessage"))}}else if(category==="sensing"){blocks.push(block("reportTouchingObject"));blocks.push(block("reportTouchingColor"));blocks.push(block("reportColorIsTouchingColor"));blocks.push("-");blocks.push(block("doAsk"));blocks.push(watcherToggle("getLastAnswer"));blocks.push(block("getLastAnswer"));blocks.push("-");blocks.push(block("reportMousePosition"));blocks.push(watcherToggle("reportMouseX"));blocks.push(block("reportMouseX"));blocks.push(watcherToggle("reportMouseY"));blocks.push(block("reportMouseY"));blocks.push(block("reportMouseDown"));blocks.push("-");blocks.push(block("reportKeyPressed"));blocks.push("-");blocks.push(block("reportRelationTo"));blocks.push(block("reportAspect"));blocks.push("-");blocks.push(block("doResetTimer"));blocks.push(watcherToggle("getTimer"));blocks.push(block("getTimer"));blocks.push(block("reportDate"));blocks.push("-");blocks.push(block("reportAttributeOf"));if(SpriteMorph.prototype.enableFirstClass){blocks.push(block("reportGet"))}blocks.push(block("reportObject"));blocks.push("-");blocks.push(block("reportURL"));blocks.push(block("reportAudio"));blocks.push(block("reportVideo"));blocks.push(block("doSetVideoTransparency"));blocks.push("-");blocks.push(block("reportGlobalFlag"));blocks.push(block("doSetGlobalFlag"));if(devMode){blocks.push("-");blocks.push(this.devModeText());blocks.push("-");blocks.push(watcherToggle("reportThreadCount"));blocks.push(block("reportThreadCount"));blocks.push(block("reportStackSize"));blocks.push(block("reportFrameCount"));blocks.push(block("reportYieldCount"))}}else if(category==="operators"){blocks.push(block("reifyScript"));blocks.push(block("reifyReporter"));blocks.push(block("reifyPredicate"));blocks.push("#");blocks.push("-");blocks.push(block("reportVariadicSum"));blocks.push(block("reportDifference"));blocks.push(block("reportVariadicProduct"));blocks.push(block("reportQuotient"));blocks.push(block("reportPower"));blocks.push("-");blocks.push(block("reportModulus"));blocks.push(block("reportRound"));blocks.push(block("reportMonadic"));blocks.push(block("reportRandom"));blocks.push("-");blocks.push(block("reportLessThan"));blocks.push(block("reportEquals"));blocks.push(block("reportGreaterThan"));blocks.push("-");blocks.push(block("reportAnd"));blocks.push(block("reportOr"));blocks.push(block("reportNot"));blocks.push(block("reportBoolean"));blocks.push("-");blocks.push(block("reportJoinWords"));blocks.push(block("reportTextSplit"));blocks.push(block("reportLetter"));blocks.push(block("reportStringSize"));blocks.push("-");blocks.push(block("reportUnicode"));blocks.push(block("reportUnicodeAsLetter"));blocks.push("-");blocks.push(block("reportIsA"));blocks.push(block("reportIsIdentical"));if(Process.prototype.enableJS){blocks.push("-");blocks.push(block("reportJSFunction"));if(Process.prototype.enableCompiling){blocks.push(block("reportCompiled"))}}if(devMode){blocks.push("-");blocks.push(this.devModeText());blocks.push("-");blocks.push(block("reportTypeOf"));blocks.push(block("reportTextFunction"))}}else if(category==="variables"){blocks.push(this.makeVariableButton());if(this.deletableVariableNames().length>0){blocks.push(this.deleteVariableButton())}blocks.push("-");varNames=this.reachableGlobalVariableNames(true,all);if(varNames.length>0){varNames.forEach(name=>{blocks.push(variableWatcherToggle(name));blocks.push(variableBlock(name))});blocks.push("-")}varNames=this.allLocalVariableNames(true,all);if(varNames.length>0){varNames.forEach(name=>{blocks.push(variableWatcherToggle(name));blocks.push(variableBlock(name,true))});blocks.push("-")}blocks.push(block("doSetVar"));blocks.push(block("doChangeVar"));blocks.push(block("doShowVar"));blocks.push(block("doHideVar"));blocks.push(block("doDeclareVariables"));if(StageMorph.prototype.enableInheritance){blocks.push("-");blocks.push(block("doDeleteAttr"))}blocks.push("=");blocks.push(block("reportNewList"));blocks.push(block("reportNumbers"));blocks.push("-");blocks.push(block("reportCONS"));blocks.push(block("reportListItem"));blocks.push(block("reportCDR"));blocks.push("-");blocks.push(block("reportListAttribute"));blocks.push(block("reportListIndex"));blocks.push(block("reportListContainsItem"));blocks.push(block("reportListIsEmpty"));blocks.push("-");blocks.push(block("reportMap"));blocks.push(block("reportKeep"));blocks.push(block("reportFindFirst"));blocks.push(block("reportCombine"));blocks.push("-");blocks.push(block("doForEach"));blocks.push("-");blocks.push(block("doAddToList"));blocks.push(block("doDeleteFromList"));blocks.push(block("doInsertInList"));blocks.push(block("doReplaceInList"));blocks.push("-");blocks.push(block("reportConcatenatedLists"));blocks.push(block("reportReshape"));blocks.push(block("reportCrossproduct"));if(SpriteMorph.prototype.showingExtensions){blocks.push("=");blocks.push(block("doApplyExtension"));blocks.push(block("reportApplyExtension"))}if(StageMorph.prototype.enableCodeMapping){blocks.push("=");blocks.push(block("doMapCodeOrHeader"));blocks.push(block("doMapValueCode"));blocks.push(block("doMapListCode"));blocks.push("-");blocks.push(block("reportMappedCode"))}if(this.world().isDevMode){blocks.push("-");blocks.push(this.devModeText());blocks.push("-");blocks.push(block("doShowTable"))}}return blocks};SpriteMorph.prototype.makeVariableButton=function(){var button,myself=this;function addVar(pair){var ide;if(pair){if(myself.isVariableNameInUse(pair[0],pair[1])){myself.inform("that name is already in use")}else{ide=myself.parentThatIsA(IDE_Morph);myself.addVariable(pair[0],pair[1]);myself.toggleVariableWatcher(pair[0],pair[1]);ide.flushBlocksCache("variables");ide.refreshPalette();ide.recordUnsavedChanges()}}}button=new PushButtonMorph(null,function(){new VariableDialogMorph(null,addVar,myself).prompt("Variable name",null,myself.world())},"Make a variable");button.userMenu=this.helpMenu;button.selector="addVariable";button.showHelp=BlockMorph.prototype.showHelp;return button};SpriteMorph.prototype.deleteVariableButton=function(){var button,myself=this;button=new PushButtonMorph(null,function(){var menu=new MenuMorph(myself.deleteVariable,null,myself);myself.deletableVariableNames().forEach(name=>menu.addItem(name,name,null,null,null,null,null,null,true));menu.popUpAtHand(myself.world())},"Delete a variable");button.userMenu=this.helpMenu;button.selector="deleteVariable";button.showHelp=BlockMorph.prototype.showHelp;return button};SpriteMorph.prototype.categoryText=function(category){var txt=new StringMorph(localize(category[0].toUpperCase().concat(category.slice(1))),11,null,true);txt.setColor(this.paletteTextColor);txt.category=category;return txt};SpriteMorph.prototype.devModeText=function(){var txt=new TextMorph(localize("development mode \ndebugging primitives:"));txt.fontSize=9;txt.setColor(this.paletteTextColor);return txt};SpriteMorph.prototype.helpMenu=function(){var menu=new MenuMorph(this);menu.addItem("help...","showHelp");return menu};SpriteMorph.prototype.customBlockTemplatesForCategory=function(category,includeHidden){var ide=this.parentThatIsA(IDE_Morph),blocks=[],isInherited=false,block,inheritedBlocks;function addCustomBlock(definition){if((!definition.isHelper||includeHidden)&&definition.category===category){block=definition.templateInstance();if(isInherited){block.ghost()}blocks.push(block)}}if(ide&&ide.stage){ide.stage.globalBlocks.forEach(addCustomBlock);if(this.customBlocks.length){blocks.push("=")}}this.customBlocks.forEach(addCustomBlock);if(this.exemplar){inheritedBlocks=this.inheritedBlocks(true);if(this.customBlocks.length&&inheritedBlocks.length){blocks.push("=")}isInherited=true;inheritedBlocks.forEach(addCustomBlock)}return blocks};SpriteMorph.prototype.makeBlockButton=function(category){var button=new PushButtonMorph(this,"makeBlock","Make a block");button.userMenu=this.helpMenu;button.selector="addCustomBlock";button.showHelp=BlockMorph.prototype.showHelp;return button};SpriteMorph.prototype.makeBlock=function(){var ide=this.parentThatIsA(IDE_Morph),stage=this.parentThatIsA(StageMorph),category=ide.currentCategory==="unified"?ide.topVisibleCategoryInPalette():ide.currentCategory,clr=SpriteMorph.prototype.blockColorFor(category),dlg;dlg=new BlockDialogMorph(null,definition=>{if(definition.spec!==""){if(definition.isGlobal){stage.globalBlocks.push(definition)}else{this.customBlocks.push(definition)}ide.flushPaletteCache();ide.categories.refreshEmpty();ide.refreshPalette();ide.recordUnsavedChanges();new BlockEditorMorph(definition,this).popUp()}},this);if(category!=="variables"||category!=="unified"){dlg.category=category;dlg.categories.refresh();dlg.types.children.forEach(each=>{each.setColor(clr);each.refresh()})}dlg.prompt("Make a block",null,this.world())};SpriteMorph.prototype.getPrimitiveTemplates=function(category){var blocks=this.primitivesCache[category];if(!blocks){blocks=this.blockTemplates(category);if(this.isCachingPrimitives){this.primitivesCache[category]=blocks}}return blocks};SpriteMorph.prototype.palette=function(category){if(!this.paletteCache[category]){this.paletteCache[category]=this.freshPalette(category)}return this.paletteCache[category]};SpriteMorph.prototype.freshPalette=function(category){var myself=this,palette=new ScrollFrameMorph(null,null,this.sliderColor),unit=SyntaxElementMorph.prototype.fontSize,ide,showCategories,showButtons,x=0,y=5,ry=0,blocks,hideNextSpace=false,shade=new Color(140,140,140),searchButton,makeButton;palette.owner=this;palette.padding=unit/2;palette.color=this.paletteColor;palette.growth=new Point(0,MorphicPreferences.scrollBarSize);palette.toolBar=new AlignmentMorph("column");searchButton=new PushButtonMorph(this,"searchBlocks",new SymbolMorph("magnifierOutline",16));searchButton.alpha=.2;searchButton.padding=1;searchButton.hint=localize("find blocks")+"...";searchButton.labelShadowColor=shade;searchButton.edge=0;searchButton.padding=3;searchButton.fixLayout();palette.toolBar.add(searchButton);makeButton=new PushButtonMorph(this,"makeBlock",new SymbolMorph("cross",16));makeButton.alpha=.2;makeButton.padding=1;makeButton.hint=localize("Make a block")+"...";makeButton.labelShadowColor=shade;makeButton.edge=0;makeButton.padding=3;makeButton.fixLayout();palette.toolBar.add(makeButton);palette.toolBar.fixLayout();palette.add(palette.toolBar);palette.userMenu=function(){var menu=new MenuMorph;menu.addPair([new SymbolMorph("magnifyingGlass",MorphicPreferences.menuFontSize),localize("find blocks")+"..."],()=>myself.searchBlocks(),"^F");menu.addItem("hide blocks...",()=>new BlockVisibilityDialogMorph(myself).popUp(myself.world()));menu.addLine();menu.addItem("make a category...",()=>this.parentThatIsA(IDE_Morph).createNewCategory());if(SpriteMorph.prototype.customCategories.size){menu.addItem("delete a category...",()=>this.parentThatIsA(IDE_Morph).deleteUserCategory())}return menu};if(category==="unified"){ide=this.parentThatIsA(IDE_Morph);showCategories=ide.scene.showCategories;showButtons=ide.scene.showPaletteButtons;blocks=SpriteMorph.prototype.allCategories().reduce((blocks,category)=>{let header=[this.categoryText(category),"-"],primitives=this.getPrimitiveTemplates(category),customs=this.customBlockTemplatesForCategory(category),showHeader=showCategories&&!["lists","other"].includes(category)&&(primitives.some(item=>item instanceof BlockMorph)||customs.length);if(!showCategories&&category!=="variables"){primitives=primitives.filter(each=>each!=="-"&&each!=="=")}if(!showButtons&&category==="variables"){primitives=primitives.filter(each=>!(each instanceof PushButtonMorph&&!(each instanceof ToggleMorph)))}return blocks.concat(showHeader?header:[],primitives,showHeader?"=":null,customs,showHeader?"=":"-")},[])}else{blocks=this.getPrimitiveTemplates(category).slice()}if(category!=="unified"||showButtons){blocks.push("=");blocks.push(this.makeBlockButton(category))}if(category!=="unified"){blocks.push("=");blocks.push(...this.customBlockTemplatesForCategory(category))}if(category==="variables"){blocks.push(...this.customBlockTemplatesForCategory("lists"));blocks.push(...this.customBlockTemplatesForCategory("other"))}blocks.forEach(block=>{if(block===null){return}if(block==="-"){if(hideNextSpace){return}y+=unit*.8;hideNextSpace=true}else if(block==="="){if(hideNextSpace){return}y+=unit*1.6;hideNextSpace=true}else if(block==="#"){x=0;y=ry===0?y:ry}else{hideNextSpace=false;if(x===0){y+=unit*.3}block.setPosition(new Point(x,y));palette.addContents(block);if(block instanceof ToggleMorph){x=block.right()+unit/2}else if(block instanceof RingMorph){x=block.right()+unit/2;ry=block.bottom()}else{x=0;y+=block.height()}}});palette.scrollX(palette.padding);palette.scrollY(palette.padding);return palette};SpriteMorph.prototype.allPaletteBlocks=function(){var blocks=SpriteMorph.prototype.allCategories().reduce((blocks,category)=>{let primitives=this.blockTemplates(category,true),customs=this.customBlockTemplatesForCategory(category,true);return blocks.concat(primitives,customs)},[]);return blocks.filter(each=>each instanceof BlockMorph)};SpriteMorph.prototype.isHidingBlock=function(aBlock){var frame;if(aBlock.isCustomBlock){return(aBlock.isGlobal?aBlock.definition:this.getMethod(aBlock.semanticSpec)).isHelper}if(aBlock.selector==="reportGetVar"){frame=this.variables.silentFind(aBlock.blockSpec);if(!frame){return false}return frame.vars[aBlock.blockSpec].isHidden}return StageMorph.prototype.hiddenPrimitives[aBlock.selector]===true};SpriteMorph.prototype.isDisablingBlock=function(aBlock){var sel=aBlock.selector;if(sel==="reportJSFunction"){return!Process.prototype.enableJS}if(sel==="doApplyExtension"||sel==="reportApplyExtension"){return!SpriteMorph.prototype.showingExtensions}if(sel==="doMapCodeOrHeader"||sel==="doMapValueCode"||sel==="doMapListCode"||sel==="reportMappedCode"){return!StageMorph.prototype.enableCodeMapping}return false};SpriteMorph.prototype.changeBlockVisibility=function(aBlock,hideIt,quick){var ide=this.parentThatIsA(IDE_Morph),dict,cat;if(aBlock.isCustomBlock){(aBlock.isGlobal?aBlock.definition:this.getMethod(aBlock.semanticSpec)).isHelper=!!hideIt}else if(aBlock.selector==="reportGetVar"){this.variables.find(aBlock.blockSpec).vars[aBlock.blockSpec].isHidden=!!hideIt}else{if(hideIt){StageMorph.prototype.hiddenPrimitives[aBlock.selector]=true}else{delete StageMorph.prototype.hiddenPrimitives[aBlock.selector]}}if(quick){return}dict={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"};cat=dict[aBlock.selector]||aBlock.category;if(cat==="lists"){cat="variables"}ide.flushBlocksCache(cat);ide.refreshPalette()};SpriteMorph.prototype.emptyCategories=function(){var hasBlocks=any=>any instanceof BlockMorph&&!this.isHidingBlock(any);if(this.categoriesCache===null){this.categoriesCache={};SpriteMorph.prototype.allCategories().forEach(category=>this.categoriesCache[category]=this.getPrimitiveTemplates(category).some(hasBlocks)||this.customBlockTemplatesForCategory(category).some(hasBlocks))}return this.categoriesCache};SpriteMorph.prototype.blocksMatching=function(searchString,strictly,types,varNames){var blocks=[],blocksDict,search=searchString.toLowerCase(),stage=this.parentThatIsA(StageMorph),reporterized;if(!types||!types.length){types=["hat","command","reporter","predicate","ring"]}if(!varNames){varNames=[]}function labelOf(aBlockSpec){var words=BlockMorph.prototype.parseSpec(aBlockSpec),filtered=words.filter(each=>each.indexOf("%")!==0||each.length===1),slots=words.filter(each=>each.length>1&&each.indexOf("%")===0).map(spec=>menuOf(spec));return filtered.join(" ")+" "+slots.join(" ")}function menuOf(aSlotSpec){var info=BlockMorph.prototype.labelParts[aSlotSpec]||{},menu=info.menu;if(!menu){return""}if(isString(menu)){menu=InputSlotMorph.prototype[menu](true)}return Object.values(menu).map(entry=>{if(isNil(entry)){return""}if(entry instanceof Array){return localize(entry[0])}return entry.toString()}).join(" ")}function fillDigits(anInt,totalDigits,fillChar){var ans=String(anInt);while(ans.length<totalDigits){ans=fillChar+ans}return ans}function relevance(aBlockLabel,aSearchString){var lbl=" "+aBlockLabel.toLowerCase(),idx=lbl.indexOf(aSearchString),atWord;if(idx===-1){return-1}atWord=lbl.charAt(idx-1)===" ";if(strictly&&!atWord){return-1}return(atWord?"1":"2")+fillDigits(idx,4,"0")}function primitive(selector){var newBlock=SpriteMorph.prototype.blockForSelector(selector,true);newBlock.isTemplate=true;return newBlock}varNames.forEach(vName=>{var rel=relevance(vName,search);if(rel!==-1){blocks.push([this.variableBlock(vName),rel+"1"])}});[this.customBlocks,stage.globalBlocks].forEach(blocksList=>blocksList.forEach(definition=>{if(contains(types,definition.type)){var spec=definition.localizedSpec(),rel=relevance(labelOf(spec)+" "+definition.menuSearchWords(),search);if(rel!==-1){blocks.push([definition.templateInstance(),rel+"2"])}}}));blocksDict=SpriteMorph.prototype.blocks;Object.keys(blocksDict).forEach(selector=>{if(!StageMorph.prototype.hiddenPrimitives[selector]&&contains(types,blocksDict[selector].type)){var block=blocksDict[selector],spec=localize(block.alias||block.spec),rel=relevance(labelOf(spec),search);if(rel!==-1&&!block.dev&&(!block.only||block.only===this.constructor)){blocks.push([primitive(selector),rel+"3"])}}});if(contains(types,"reporter")){reporterized=this.reporterize(searchString);if(reporterized){blocks.push([reporterized,""])}}blocks.sort((x,y)=>x[1]<y[1]?-1:1);blocks=blocks.map(each=>each[0]);return blocks.filter(each=>!this.isHidingBlock(each)&&!this.isDisablingBlock(each))};SpriteMorph.prototype.searchBlocks=function(searchString,types,varNames,scriptFocus){var myself=this,unit=SyntaxElementMorph.prototype.fontSize,ide=this.parentThatIsA(IDE_Morph),oldTop=ide.palette.contents.top(),oldSearch="",searchBar=new InputFieldMorph(searchString||""),searchPane=ide.createPalette("forSearch"),blocksList=[],selection,focus;function showSelection(){if(focus){focus.destroy()}if(!selection||!scriptFocus){return}focus=selection.outline(MorphicPreferences.isFlat?new Color(150,200,255):WHITE,2);searchPane.contents.add(focus);focus.scrollIntoView()}function show(blocks){var x=searchPane.contents.left()+5,y=searchBar.bottom()+unit;blocksList=blocks;selection=null;if(blocks.length&&scriptFocus){selection=blocks[0]}searchPane.contents.children=[searchPane.contents.children[0]];blocks.forEach(block=>{block.setPosition(new Point(x,y));searchPane.addContents(block);y+=block.height();y+=unit*.3});showSelection();searchPane.changed()}searchPane.owner=this;searchPane.color=this.paletteColor;searchPane.contents.color=this.paletteColor;searchPane.addContents(searchBar);searchBar.setWidth(ide.logo.width()-30);searchBar.contrast=90;searchBar.setPosition(searchPane.contents.topLeft().add(new Point(10,10)));searchBar.fixLayout();searchPane.accept=function(){var search;if(scriptFocus){searchBar.cancel();if(selection){scriptFocus.insertBlock(selection)}if(ide){ide.recordUnsavedChanges()}}else{search=searchBar.getValue();if(search.length>0){show(myself.blocksMatching(search))}}};searchPane.reactToKeystroke=function(evt){var idx,code=evt?evt.keyCode:0;switch(code){case 38:if(!scriptFocus||!selection){return}idx=blocksList.indexOf(selection)-1;if(idx<0){idx=blocksList.length-1}selection=blocksList[idx];showSelection();return;case 40:if(!scriptFocus||!selection){return}idx=blocksList.indexOf(selection)+1;if(idx>=blocksList.length){idx=0}selection=blocksList[idx];showSelection();return;default:nop()}};searchPane.reactToInput=function(evt){var search=searchBar.getValue();if(search!==oldSearch){oldSearch=search;show(myself.blocksMatching(search,search.length<2,types,varNames))}};searchBar.cancel=function(){ide.refreshPalette();ide.palette.contents.setTop(oldTop);ide.palette.adjustScrollBars()};ide.fixLayout("refreshPalette");searchBar.edit();if(searchString){searchPane.reactToKeystroke()}};SpriteMorph.prototype.reporterize=function(expressionString){var ast;function parseInfix(expression,operator,already){var inputs=["",""],idx=0,ch;function format(value){return value instanceof Array||isNaN(+value)?value:+value}function nested(){var level=1,expr="";while(idx<expression.length){ch=expression[idx];idx+=1;switch(ch){case"(":level+=1;break;case")":level-=1;if(!level){return expr}break}expr+=ch}}while(idx<expression.length){ch=expression[idx];idx+=1;switch(ch){case" ":break;case"(":if(inputs[operator?1:0].length){inputs[operator?1:0]=[inputs[operator?1:0],parseInfix(nested())]}else{inputs[operator?1:0]=parseInfix(nested())}break;case"-":case"+":case"*":case"/":case"%":case"^":case"=":case"<":case">":case"&":case"|":if(!operator&&!inputs[0].length){inputs[0]=ch}else if(operator){if(!inputs[1].length){inputs[1]=ch}else{return parseInfix(expression.slice(idx),ch,[operator,already,format(inputs[1])])}}else{operator=ch;already=format(inputs[0])}break;default:inputs[operator?1:0]+=ch}}if(operator){return[operator,already,format(inputs[1])]}return format(inputs[0])}function blockFromAST(ast){var block,target,selectors,monads,alias,key,sel,i,inps,off=1,reverseDict={};selectors={"+":"reportVariadicSum","-":"reportDifference","*":"reportVariadicProduct","/":"reportQuotient","%":"reportModulus","^":"reportPower","=":"reportEquals","<":"reportLessThan",">":"reportGreaterThan","&":"reportAnd","|":"reportOr",round:"reportRound",not:"reportNot"};monads=["abs","neg","ceiling","floor","sqrt","sin","cos","tan","asin","acos","atan","ln","log","lg","id","round","not"];alias={ceil:"ceiling","!":"not"};monads.concat(["true","false"]).forEach(word=>reverseDict[localize(word).toLowerCase()]=word);key=alias[ast[0]]||reverseDict[ast[0].toLowerCase()]||ast[0];if(contains(monads,key)){sel=selectors[key];if(sel){block=SpriteMorph.prototype.blockForSelector(sel);inps=block.inputs()}else{block=SpriteMorph.prototype.blockForSelector("reportMonadic");inps=block.inputs();inps[0].setContents([key]);off=0}target=block}else{block=SpriteMorph.prototype.blockForSelector(selectors[key]);target=block;inps=block.inputs();if(inps[0]instanceof MultiArgMorph){target=inps[0];inps=target.inputs()}}for(i=1;i<ast.length;i+=1){if(ast[i]instanceof Array){target.replaceInput(inps[i-off],blockFromAST(ast[i]))}else if(isString(ast[i])){if(contains(["true","false"],reverseDict[ast[i]]||ast[i])){target.replaceInput(inps[i-off],SpriteMorph.prototype.blockForSelector((reverseDict[ast[i]]||ast[i])==="true"?"reportTrue":"reportFalse"))}else if(ast[i]!=="_"){target.replaceInput(inps[i-off],SpriteMorph.prototype.variableBlock(ast[i]))}}else{inps[i-off].setContents(ast[i])}}target.fixLayout();block.isDraggable=true;block.fixLayout();block.fixBlockColor(null,true);return block}if(expressionString.length>100){return null}try{ast=parseInfix(expressionString);return ast instanceof Array?blockFromAST(ast):null}catch(error){return null}};SpriteMorph.prototype.addVariable=function(name,isGlobal){var ide=this.parentThatIsA(IDE_Morph);if(isGlobal){this.globalVariables().addVar(name);if(ide){ide.flushBlocksCache("variables")}}else{this.variables.addVar(name);this.primitivesCache.variables=null}};SpriteMorph.prototype.deleteVariable=function(varName){var ide=this.parentThatIsA(IDE_Morph);if(!contains(this.inheritedVariableNames(true),varName)){this.deleteVariableWatcher(varName)}this.variables.deleteVar(varName);if(ide){ide.flushBlocksCache("variables");ide.refreshPalette();ide.recordUnsavedChanges()}};SpriteMorph.prototype.addCostume=function(costume){if(!costume.name){costume.name="costume"+(this.costumes.length()+1)}this.shadowAttribute("costumes");this.costumes.add(costume)};SpriteMorph.prototype.wearCostume=function(costume,noShadow){var x=this.xPosition?this.xPosition():null,y=this.yPosition?this.yPosition():null,idx=isNil(costume)?null:this.costumes.asArray().indexOf(costume);this.changed();this.costume=costume;this.fixLayout();this.rerender();if(x!==null){this.silentGotoXY(x,y,true)}if(this.positionTalkBubble){this.positionTalkBubble()}this.version=Date.now();if(!noShadow){this.shadowAttribute("costume #")}this.specimens().forEach(instance=>{if(instance.cachedPropagation){if(instance.inheritsAttribute("costume #")){if(idx===null){instance.wearCostume(null,true)}else if(idx===-1){instance.wearCostume(costume,true)}else{instance.doSwitchToCostume(idx+1,true)}}}})};SpriteMorph.prototype.getCostumeIdx=function(){if(this.inheritsAttribute("costume #")){return this.exemplar.getCostumeIdx()}return this.costumes.asArray().indexOf(this.costume)+1};SpriteMorph.prototype.doWearNextCostume=function(){var arr=this.costumes.asArray(),idx;if(arr.length>1){idx=arr.indexOf(this.costume);if(idx>-1){idx+=1;if(idx>arr.length-1){idx=0}this.wearCostume(arr[idx])}}};SpriteMorph.prototype.doWearPreviousCostume=function(){var arr=this.costumes.asArray(),idx;if(arr.length>1){idx=arr.indexOf(this.costume);if(idx>-1){idx-=1;if(idx<0){idx=arr.length-1}this.wearCostume(arr[idx])}}};SpriteMorph.prototype.doSwitchToCostume=function(id,noShadow){var w=0,h=0,stage;if(id instanceof List){if(this.costume){w=this.costume.width();h=this.costume.height()}if(w*h!==id.length()){stage=this.parentThatIsA(StageMorph);w=stage.dimensions.x;h=stage.dimensions.y}id=Process.prototype.reportNewCostume(id,w,h,this.newCostumeName(localize("snap")))}if(id instanceof Costume){this.wearCostume(id,noShadow);return}if(id instanceof Array&&id[0]==="current"){return}var num,arr=this.costumes.asArray(),costume;if(contains([localize("Turtle"),localize("Empty")],id instanceof Array?id[0]:null)){costume=null}else{if(id===-1){this.doWearPreviousCostume();return}costume=detect(arr,cst=>cst.name===id);if(costume===null){num=parseFloat(id);if(num===0){costume=null}else{costume=arr[num-1]||null}}}this.wearCostume(costume,noShadow)};SpriteMorph.prototype.reportCostumes=function(){return this.costumes};SpriteMorph.prototype.addSound=function(audio,name){var sound=new Sound(audio,name);this.shadowAttribute("sounds");this.sounds.add(sound);return sound};SpriteMorph.prototype.doPlaySound=function(name){var stage=this.parentThatIsA(StageMorph),sound=name instanceof Sound?name:typeof name==="number"?this.sounds.at(name):detect(this.sounds.asArray(),s=>s.name===name.toString()),ctx=this.audioContext(),gain=this.getGainNode(),pan=this.getPannerNode(),aud,source;if(sound){aud=document.createElement("audio");aud.src=sound.audio.src;ctx.resume();source=ctx.createMediaElementSource(aud);source.connect(gain);if(pan){gain.connect(pan);pan.connect(ctx.destination);this.setPan(this.getPan())}else{gain.connect(ctx.destination)}this.setVolume(this.getVolume());aud.play();if(stage){stage.activeSounds.push(aud);stage.activeSounds=stage.activeSounds.filter(snd=>!snd.ended&&!snd.terminated)}return aud}};SpriteMorph.prototype.reportSounds=function(){return this.sounds};SpriteMorph.prototype.setVolume=function(num,noShadow){this.volume=Math.max(Math.min(+num||0,100),0);this.getGainNode().gain.setValueAtTime(1/Math.pow(10,Math.log2(100/this.volume)),this.audioContext().currentTime);if(this instanceof StageMorph){return}if(!noShadow){this.shadowAttribute("volume")}this.instances.forEach(instance=>{if(instance.cachedPropagation){if(instance.inheritsAttribute("volume")){instance.setVolume(num,true)}}})};SpriteMorph.prototype.changeVolume=function(delta){this.setVolume(this.getVolume()+(+delta||0))};SpriteMorph.prototype.getVolume=function(){if(this.inheritsAttribute("volume")){return this.exemplar.getVolume()}return this.volume};SpriteMorph.prototype.getGainNode=function(){if(!this.gainNode){this.gainNode=this.audioContext().createGain()}return this.gainNode};SpriteMorph.prototype.audioContext=function(){return Note.prototype.getAudioContext()};SpriteMorph.prototype.setPan=function(num,noShadow){var panner=this.getPannerNode();if(!panner){return}this.pan=Math.max(Math.min(+num||0,100),-100);panner.pan.setValueAtTime(this.pan/100,this.audioContext().currentTime);if(this instanceof StageMorph){return}if(!noShadow){this.shadowAttribute("balance")}this.instances.forEach(instance=>{if(instance.cachedPropagation){if(instance.inheritsAttribute("balance")){instance.setPan(num,true)}}})};SpriteMorph.prototype.changePan=function(delta){this.setPan(this.getPan()+(+delta||0))};SpriteMorph.prototype.getPan=function(){if(this.inheritsAttribute("balance")){return this.exemplar.getPan()}return this.pan};SpriteMorph.prototype.getPannerNode=function(){var ctx;if(!this.pannerNode){ctx=this.audioContext();if(ctx.createStereoPanner){this.pannerNode=this.audioContext().createStereoPanner()}}return this.pannerNode};SpriteMorph.prototype.playFreq=function(hz){var note,ctx=this.audioContext(),gain=this.getGainNode(),pan=this.getPannerNode(),stage=this.parentThatIsA(StageMorph);if(!this.freqPlayer){this.freqPlayer=new Note}note=this.freqPlayer;note.fader=ctx.createGain();if(note.oscillator){note.oscillator.frequency.value=hz}else{note.oscillator=ctx.createOscillator();if(!note.oscillator.start){note.oscillator.start=note.oscillator.noteOn}if(!note.oscillator.stop){note.oscillator.stop=note.oscillator.noteOff}note.setInstrument(this.instrument);note.oscillator.frequency.value=hz;this.setVolume(this.getVolume());note.oscillator.connect(note.fader);note.fader.connect(gain);if(pan){gain.connect(pan);pan.connect(ctx.destination);this.setPan(this.pan)}else{gain.connect(ctx.destination)}note.ended=false;if(stage){stage.activeSounds.push(note);stage.activeSounds=stage.activeSounds.filter(snd=>!snd.ended&&!snd.terminated)}note.fader.gain.setValueCurveAtTime(note.fadeIn,ctx.currentTime,note.fadeTime);note.oscillator.start(0)}};SpriteMorph.prototype.stopFreq=function(){if(this.freqPlayer){this.freqPlayer.stop()}};SpriteMorph.prototype.userMenu=function(){var ide=this.parentThatIsA(IDE_Morph),menu=new MenuMorph(this),allParts,anchors;if(ide&&ide.isAppMode){return menu}if(!this.isTemporary){menu.addItem("duplicate","duplicate");if(StageMorph.prototype.enableInheritance){menu.addItem("clone","instantiate");menu.addLine()}}menu.addItem("delete","remove");menu.addItem("move","moveCenter");menu.addItem("rotate","setRotation");if(this.costume){menu.addItem("pivot","moveRotationCenter","edit the costume's\nrotation center")}if(this.isTemporary){if(StageMorph.prototype.enableInheritance){menu.addItem("edit","perpetuateAndEdit","make permanent and\nshow in the sprite corral")}}else{menu.addItem("edit","edit")}menu.addLine();if(this.anchor){menu.addItem(localize("detach from")+" "+this.anchor.name,"detachFromAnchor")}else{allParts=this.allParts();anchors=this.parent.children.filter(morph=>morph instanceof SpriteMorph&&!contains(allParts,morph));if(anchors.length){menu.addMenu("stick to",this.anchorsMenu(anchors))}}if(this.parts.length){menu.addItem("detach all parts","detachAllParts")}menu.addItem("export...","exportSprite");return menu};SpriteMorph.prototype.anchorsMenu=function(targets){var menu=new MenuMorph(this.attachTo,null,this);targets.forEach(sprite=>menu.addItem([sprite.thumbnail(new Point(24,24)),sprite.name],sprite));return menu};SpriteMorph.prototype.exportSprite=function(){if(this.isTemporary){return}var ide=this.parentThatIsA(IDE_Morph);if(ide){ide.exportSprite(this)}};SpriteMorph.prototype.edit=function(){var ide=this.parentThatIsA(IDE_Morph);if(ide&&!ide.isAppMode){ide.selectSprite(this)}};SpriteMorph.prototype.showOnStage=function(){var stage=this.parentThatIsA(StageMorph);if(stage){this.keepWithin(stage);stage.add(this)}this.show()};SpriteMorph.prototype.duplicate=function(){var ide=this.parentThatIsA(IDE_Morph);if(ide){ide.duplicateSprite(this)}};SpriteMorph.prototype.instantiate=function(){var ide=this.parentThatIsA(IDE_Morph);if(ide){ide.instantiateSprite(this)}};SpriteMorph.prototype.remove=function(){var ide=this.parentThatIsA(IDE_Morph);if(ide){ide.removeSprite(this)}};SpriteMorph.prototype.toXMLString=function(){var ide=this.parentThatIsA(IDE_Morph),all=this.allParts(),dependencies=[],categories=[],blocksXML="";function collect(item,array){if(!contains(array,item)){array.push(item)}}function collectAll(items,array){items.forEach(item=>collect(item,array))}all.forEach(sprite=>{sprite.scripts.children.filter(morph=>morph instanceof BlockMorph).forEach(script=>collectAll(script.dependencies(true),dependencies));sprite.customBlocks.forEach(def=>{collect(def.category,categories);collectAll(def.collectDependencies([],[],sprite).filter(each=>each.isGlobal),dependencies)})});if(dependencies.length||categories.length){blocksXML=ide.blocksLibraryXML(dependencies,categories)}return'<sprites app="'+ide.serializer.app+'" version="'+ide.serializer.version+'">'+blocksXML+ide.serializer.serialize(all)+"</sprites>"};SpriteMorph.prototype.createClone=function(immediately){var stage=this.parentThatIsA(StageMorph),clone;if(this.isCorpse){throw new Error("cannot operate on a deleted sprite")}if(stage&&stage.cloneCount<=5e3){clone=this.fullCopy(true);clone.clonify(stage,immediately)}return clone};SpriteMorph.prototype.newClone=function(immediately){var clone=this.createClone(immediately);if(isNil(clone)){throw new Error("exceeding maximum number of clones")}return clone};SpriteMorph.prototype.clonify=function(stage,immediately){var hats;this.parts.forEach(part=>part.clonify(stage));stage.cloneCount+=1;this.cloneOriginName=this.isTemporary?this.cloneOriginName:this.name;this.isTemporary=true;this.name="";stage.add(this);hats=this.allHatBlocksFor("__clone__init__");hats.forEach(block=>stage.threads.startProcess(block,this,stage.isThreadSafe,null,null,null,immediately));this.endWarp()};SpriteMorph.prototype.initClone=function(hats){var stage=this.parentThatIsA(StageMorph);if(stage){hats.forEach(block=>stage.threads.startProcess(block,this,stage.isThreadSafe));this.endWarp()}};SpriteMorph.prototype.removeClone=function(){var exemplar=this.exemplar;if(this.isTemporary){this.parent.threads.stopAllForReceiver(this);this.parts.slice().forEach(part=>{this.detachPart(part);part.removeClone()});this.corpsify();this.instances.forEach(child=>{if(child.isTemporary){child.setExemplar(exemplar)}});this.destroy();this.parent.cloneCount-=1}};SpriteMorph.prototype.perpetuate=function(){var stage=this.parentThatIsA(StageMorph),ide=this.parentThatIsA(IDE_Morph);if(this.exemplar){this.exemplar.perpetuate()}if(!this.isTemporary||!stage||!ide){return}this.isTemporary=false;this.name=ide.newSpriteName(this.cloneOriginName);this.cloneOriginName="";stage.cloneCount-=1;ide.corral.addSprite(this);ide.sprites.add(this);this.parts.forEach(part=>part.perpetuate())};SpriteMorph.prototype.perpetuateAndEdit=function(){var ide=this.parentThatIsA(IDE_Morph);if(ide){this.perpetuate();ide.selectSprite(this);ide.recordUnsavedChanges()}};SpriteMorph.prototype.release=function(){var stage=this.parentThatIsA(StageMorph),ide=this.parentThatIsA(IDE_Morph),idx;if(this.isTemporary||!this.exemplar||!stage||!ide){return}this.parts.forEach(part=>part.release());this.instances.forEach(inst=>inst.release());this.isTemporary=true;this.name="";this.cloneOriginName=this.exemplar.name;stage.cloneCount+=1;idx=ide.sprites.asArray().indexOf(this)+1;stage.watchers().forEach(watcher=>{if(watcher.object()===this){watcher.destroy()}});if(idx>0){ide.sprites.remove(idx)}ide.createCorral();ide.fixLayout();if(ide.currentSprite===this){ide.currentSprite=detect(stage.children,morph=>morph instanceof SpriteMorph&&!morph.isTemporary)||this.stage}ide.selectSprite(ide.currentSprite);if(ide.isAppMode){ide.toggleAppMode(true)}};SpriteMorph.prototype.corpsify=function(){this.isCorpse=true;this.version=Date.now()};SpriteMorph.prototype.show=function(){this.setVisibility(true)};SpriteMorph.prototype.hide=function(){this.setVisibility(false)};SpriteMorph.prototype.setVisibility=function(bool,noShadow){var bubble=this.talkBubble();if(bool){SpriteMorph.uber.show.call(this)}else{SpriteMorph.uber.hide.call(this)}if(bubble){if(bool){bubble.show()}else{bubble.hide()}}this.parts.forEach(part=>part.setVisibility(bool));if(!noShadow){this.shadowAttribute("shown?")}this.instances.forEach(instance=>{if(instance.cachedPropagation){if(instance.inheritsAttribute("shown?")){instance.setVisibility(bool,true)}}})};SpriteMorph.prototype.reportShown=function(){if(this.inheritsAttribute("shown?")){return this.exemplar.reportShown()}return this.isVisible};SpriteMorph.prototype.setColorDimension=function(idx,num){var x=this.xPosition(),y=this.yPosition(),n=+num;idx=+idx;if(idx<0||idx>3){return}if(idx===0){if(n<0||n>100){n=(n<0?100:0)+n%100}}else{n=Math.min(100,Math.max(0,n))}if(idx===3){this.color.a=1-n/100}else{this.cachedColorDimensions[idx]=n/100;this.color["set_"+this.penColorModel].apply(this.color,this.cachedColorDimensions)}if(!this.costume){this.rerender()}this.gotoXY(x,y)};SpriteMorph.prototype.getColorDimension=function(idx){idx=+idx;if(idx===3){return(1-this.color.a)*100}return(this.cachedColorDimensions[idx]||0)*100};SpriteMorph.prototype.changeColorDimension=function(idx,delta){this.setColorDimension(idx,this.getColorDimension(idx)+(+delta||0))};SpriteMorph.prototype.setColorRGBA=function(dta){var clr=this.color.copy(),num;if(dta instanceof List){switch(dta.length()){case 1:num=Math.max(0,Math.min(+dta.at(1),255));if(isNaN(num)){return}clr.r=num;clr.g=num;clr.b=num;break;case 2:num=Math.max(0,Math.min(+dta.at(1),255));if(isNaN(num)){return}clr.r=num;clr.g=num;clr.b=num;num=Math.max(0,Math.min(+dta.at(2),255));if(isNaN(num)){return}clr.a=num/255;break;case 3:num=Math.max(0,Math.min(+dta.at(1),255));if(isNaN(num)){return}clr.r=num;num=Math.max(0,Math.min(+dta.at(2),255));if(isNaN(num)){return}clr.g=num;num=Math.max(0,Math.min(+dta.at(3),255));if(isNaN(num)){return}clr.b=num;break;case 4:num=Math.max(0,Math.min(+dta.at(1),255));if(isNaN(num)){return}clr.r=num;num=Math.max(0,Math.min(+dta.at(2),255));if(isNaN(num)){return}clr.g=num;num=Math.max(0,Math.min(+dta.at(3),255));if(isNaN(num)){return}clr.b=num;num=Math.max(0,Math.min(+dta.at(4),255));if(isNaN(num)){return}clr.a=num/255;break;default:return}}else{num=Math.max(0,Math.min(+dta,255));if(isNaN(num)){return}clr.r=num;clr.g=num;clr.b=num}this.setColor(clr)};SpriteMorph.prototype.changeColorRGBA=function(dta){var clr=this.color.copy(),num;if(dta instanceof List){switch(dta.length()){case 1:num=+dta.at(1);if(isNaN(num)){return}clr.r=Math.max(0,Math.min(clr.r+num,255));clr.g=Math.max(0,Math.min(clr.g+num,255));clr.b=Math.max(0,Math.min(clr.b+num,255));break;case 2:num=+dta.at(1);if(isNaN(num)){return}clr.r=Math.max(0,Math.min(clr.r+num,255));clr.g=Math.max(0,Math.min(clr.g+num,255));clr.b=Math.max(0,Math.min(clr.b+num,255));num=+dta.at(2);if(isNaN(num)){return}clr.a=Math.max(0,Math.min(clr.a*255+num,255))/255;break;case 3:num=+dta.at(1);if(isNaN(num)){return}clr.r=Math.max(0,Math.min(clr.r+num,255));num=+dta.at(2);if(isNaN(num)){return}clr.g=Math.max(0,Math.min(clr.g+num,255));num=+dta.at(3);if(isNaN(num)){return}clr.b=Math.max(0,Math.min(clr.b+num,255));break;case 4:num=+dta.at(1);if(isNaN(num)){return}clr.r=Math.max(0,Math.min(clr.r+num,255));num=+dta.at(2);if(isNaN(num)){return}clr.g=Math.max(0,Math.min(clr.g+num,255));num=+dta.at(3);if(isNaN(num)){return}clr.b=Math.max(0,Math.min(clr.b+num,255));num=+dta.at(4);if(isNaN(num)){return}clr.a=Math.max(0,Math.min(clr.a*255+num,255))/255;break;default:return}}else{num=+dta;if(isNaN(num)){return}clr.r=Math.max(0,Math.min(clr.r+num,255));clr.g=Math.max(0,Math.min(clr.g+num,255));clr.b=Math.max(0,Math.min(clr.b+num,255))}this.setColor(clr)};SpriteMorph.prototype.setColor=function(aColor){var x=this.xPosition(),y=this.yPosition();if(!this.color.eq(aColor,true)){this.color=aColor.copy();if(!this.costume){this.rerender();this.silentGotoXY(x,y)}this.cachedColorDimensions=this.color[this.penColorModel]()}};SpriteMorph.prototype.setBackgroundColor=SpriteMorph.prototype.setColor;SpriteMorph.prototype.getPenAttribute=function(attrib){var name=attrib instanceof Array?attrib[0]:attrib.toString(),options=["hue","saturation","brightness","transparency"];if(name==="size"){return this.size||0}if(name==="r-g-b-a"){return new List([this.color.r,this.color.g,this.color.b,Math.round(this.color.a*255)])}return this.getColorDimension(options.indexOf(name))};SpriteMorph.prototype.comeToFront=function(){if(this.parent){this.parent.add(this);this.changed()}};SpriteMorph.prototype.goToBack=function(){if(this.parent){this.parent.addBack(this);this.changed()}};SpriteMorph.prototype.goBack=function(layers){var layer,newLayer=+layers,targetLayer;if(!this.parent){return null}layer=this.parent.children.indexOf(this);this.parent.removeChild(this);targetLayer=Math.max(layer-newLayer,0);this.parent.children.splice(targetLayer,null,this);this.parent.changed()};SpriteMorph.prototype.reportTouchingColor=function(aColor){var stage=this.parentThatIsA(StageMorph),data,len,i;if(stage){data=this.overlappingPixels(stage);if(!data){return false}len=data[0].length;for(i=3;i<len;i+=4){if(data[0][i]&&data[1][i]){if(data[1][i-3]===aColor.r&&data[1][i-2]===aColor.g&&data[1][i-1]===aColor.b){return true}}}}return false};SpriteMorph.prototype.reportColorIsTouchingColor=function(thisColor,thatColor){var stage=this.parentThatIsA(StageMorph),data,len,i;if(stage){data=this.overlappingPixels(stage);if(!data){return false}len=data[0].length;for(i=3;i<len;i+=4){if(data[0][i]&&data[1][i]){if(data[0][i-3]===thisColor.r&&data[0][i-2]===thisColor.g&&data[0][i-1]===thisColor.b&&data[1][i-3]===thatColor.r&&data[1][i-2]===thatColor.g&&data[1][i-1]===thatColor.b){return true}}}}return false};SpriteMorph.prototype.overlappingPixels=function(otherSprite){var oRect=this.bounds.intersect(otherSprite.bounds),thisImg=this.getImage(),thatImg=otherSprite.getImage();if(otherSprite instanceof StageMorph){thatImg=otherSprite.fancyThumbnail(otherSprite.extent(),this,true)}if(oRect.width()<1||oRect.height()<1||!thisImg||!thatImg||!thisImg.width||!thisImg.height||!thatImg.width||!thatImg.height){return false}if(thisImg.isRetinaEnabled!==thatImg.isRetinaEnabled){thisImg=normalizeCanvas(thisImg,true);thatImg=normalizeCanvas(thatImg,true)}return[thisImg.getContext("2d").getImageData(oRect.left()-this.left(),oRect.top()-this.top(),oRect.width(),oRect.height()).data,thatImg.getContext("2d").getImageData(oRect.left()-otherSprite.left(),oRect.top()-otherSprite.top(),oRect.width(),oRect.height()).data]};SpriteMorph.prototype.neighbors=function(aStage){var stage=aStage||this.parentThatIsA(StageMorph),myPerimeter=this.perimeter(stage);return new List(stage.children.filter(each=>{var eachPerimeter,distance;if(each instanceof SpriteMorph&&each.isVisible&&each!==this){eachPerimeter=each.perimeter(stage);distance=myPerimeter.center.distanceTo(eachPerimeter.center);return distance-myPerimeter.radius-eachPerimeter.radius<0}return false}))};SpriteMorph.prototype.perimeter=function(aStage){var stage=aStage||this.parentThatIsA(StageMorph),stageScale=this instanceof StageMorph?1:stage.scale,radius;if(this.costume){radius=Math.max(this.costume.width(),this.costume.height())*this.scale*stageScale}else{radius=Math.max(this.width(),this.height())}return{center:this.center(),radius:radius}};SpriteMorph.prototype.doStamp=function(){var stage=this.parent,ctx=stage.penTrails().getContext("2d"),img=this.getImage();if(img.width<1||img.height<1){return}ctx.save();ctx.scale(1/stage.scale,1/stage.scale);ctx.globalAlpha=this.alpha;ctx.drawImage(img,this.left()-stage.left(),this.top()-stage.top());ctx.restore();this.changed();stage.cachedPenTrailsMorph=null};SpriteMorph.prototype.clear=function(){this.parent.clearPenTrails()};SpriteMorph.prototype.write=function(text,size){if(typeof text!=="string"&&typeof text!=="number"){throw new Error(localize("can only write text or numbers, not a")+" "+typeof text)}var stage=this.parentThatIsA(StageMorph),context=stage.penTrails().getContext("2d"),rotation=radians(this.direction()-90),trans=new Point(this.rotationCenter().x-stage.left(),this.rotationCenter().y-stage.top()),len,pos;context.save();context.font=size+"px monospace";context.textAlign="left";context.textBaseline="alphabetic";context.fillStyle=this.color.toString();len=context.measureText(text).width;trans=trans.multiplyBy(1/stage.scale);context.translate(trans.x,trans.y);context.rotate(rotation);context.fillText(text,0,0);context.translate(-trans.x,-trans.y);context.restore();pos=new Point(len*Math.sin(radians(this.direction())),len*Math.cos(radians(this.direction())));pos=pos.add(new Point(this.xPosition(),this.yPosition()));this.gotoXY(pos.x,pos.y,false);this.changed();stage.changed()};SpriteMorph.prototype.setSize=function(size){if(!isNaN(size)){this.size=Math.min(Math.max(+size,1e-4),1e3)}};SpriteMorph.prototype.changeSize=function(delta){this.setSize(this.size+(+delta||0))};SpriteMorph.prototype.blitOn=function(target,mask="source-atop"){var sourceHeading=this.rotationStyle===1?this.heading:90,targetHeading=target.rotationStyle===1?target.heading:90,sourceCostume,targetCostume,ctx,relRot,relScale,stageScale,centerDist,centerDelta,centerAngleRadians,center,originDist,originAngleRadians,spriteCenter,thisCenter,relPos,pos;if(this===target){return}if(this.costume&&target.costume){sourceCostume=this.costume;if(sourceCostume instanceof SVG_Costume){sourceCostume=sourceCostume.rasterized()}if(target.costume instanceof SVG_Costume){targetCostume=target.costume.rasterized()}else{targetCostume=target.costume.copy()}}else{return}if(target instanceof SpriteMorph){if(this instanceof SpriteMorph){relRot=sourceHeading-targetHeading;relScale=this.scale/target.scale;stageScale=this.parentThatIsA(StageMorph).scale;centerDist=target.center().distanceTo(this.center());centerDelta=this.center().subtract(target.center());centerAngleRadians=Math.atan2(centerDelta.y,centerDelta.x);center=new Point(sourceCostume.width(),sourceCostume.height()).multiplyBy(.5*this.scale*stageScale);originDist=center.distanceTo(ZERO);originAngleRadians=Math.atan2(center.y,center.x);spriteCenter=new Point(target.costume.width(),target.costume.height()).multiplyBy(.5*target.scale*stageScale).rotateBy(radians(relRot));thisCenter=spriteCenter.distanceAngle(centerDist,degrees(centerAngleRadians)-sourceHeading+180);relPos=thisCenter.distanceAngle(originDist,degrees(originAngleRadians)-90);pos=relPos.divideBy(stageScale).divideBy(relScale).divideBy(target.scale)}else{relRot=90-targetHeading;relScale=1/target.scale;centerDist=target.center().distanceTo(this.position());centerDelta=this.position().subtract(target.center());centerAngleRadians=Math.atan2(centerDelta.y,centerDelta.x);center=new Point(target.costume.width(),target.costume.height()).multiplyBy(.5*target.scale).rotateBy(radians(90-targetHeading));pos=center.distanceAngle(centerDist/this.scale,degrees(centerAngleRadians)+90)}}else{relRot=sourceHeading-90;relScale=this.scale;center=this.center().subtract(target.position()).divideBy(this.scale*target.scale).rotateBy(radians(sourceHeading-90));pos=center.subtract(new Point(sourceCostume.width(),sourceCostume.height()).multiplyBy(.5))}ctx=targetCostume.contents.getContext("2d");ctx.rotate(radians(relRot));ctx.scale(relScale,relScale);ctx.globalCompositeOperation=mask;ctx.drawImage(sourceCostume.contents,pos.x,pos.y);target.doSwitchToCostume(targetCostume)};SpriteMorph.prototype.down=function(){this.setPenDown(true)};SpriteMorph.prototype.up=function(){this.setPenDown(false)};SpriteMorph.prototype.setPenDown=function(bool,noShadow){if(bool){SpriteMorph.uber.down.call(this)}else{SpriteMorph.uber.up.call(this)}if(!noShadow){this.shadowAttribute("pen down?")}this.instances.forEach(instance=>{if(instance.cachedPropagation){if(instance.inheritsAttribute("pen down?")){instance.setPenDown(bool,true)}}})};SpriteMorph.prototype.getPenDown=function(){if(this.inheritsAttribute("pen down?")){return this.exemplar.getPenDown()}return this.isDown};SpriteMorph.prototype.getScale=function(){if(this.inheritsAttribute("size")){return this.exemplar.getScale()}return this.scale*100};SpriteMorph.prototype.setScale=function(percentage,noShadow){var x=this.xPosition(),y=this.yPosition(),realScale,growth;realScale=(+percentage||0)/100;growth=realScale/this.nestingScale;this.nestingScale=realScale;this.scale=Math.max(realScale,.01);this.changed();this.fixLayout();this.rerender();this.silentGotoXY(x,y,true);this.positionTalkBubble();this.parts.forEach(part=>{var xDist=part.xPosition()-x,yDist=part.yPosition()-y;part.setScale(part.scale*100*growth);part.silentGotoXY(x+xDist*growth,y+yDist*growth)});if(!noShadow){this.shadowAttribute("size")}this.instances.forEach(instance=>{if(instance.cachedPropagation){if(instance.inheritsAttribute("size")){instance.setScale(percentage,true)}}})};SpriteMorph.prototype.changeScale=function(delta){this.setScale(this.getScale()+(+delta||0))};SpriteMorph.prototype.graphicsChanged=function(){return Object.keys(this.graphicsValues).some(any=>this.graphicsValues[any]<0||this.graphicsValues[any]>0)};SpriteMorph.prototype.applyGraphicsEffects=function(canvas){var ctx,imagedata,w,h;function transform_fisheye(imagedata,value){var pixels,newImageData,newPixels,centerX,centerY,w,h,x,y,dx,dy,r,angle,srcX,srcY,i,srcI;w=imagedata.width;h=imagedata.height;pixels=imagedata.data;newImageData=ctx.createImageData(w,h);newPixels=newImageData.data;centerX=w/2;centerY=h/2;value=Math.max(0,(value+100)/100);for(y=0;y<h;y++){for(x=0;x<w;x++){dx=(x-centerX)/centerX;dy=(y-centerY)/centerY;r=Math.pow(Math.sqrt(dx*dx+dy*dy),value);if(r<=1){angle=Math.atan2(dy,dx);srcX=Math.floor(centerX+r*Math.cos(angle)*centerX);srcY=Math.floor(centerY+r*Math.sin(angle)*centerY)}else{srcX=x;srcY=y}i=(y*w+x)*4;srcI=(srcY*w+srcX)*4;newPixels[i]=pixels[srcI];newPixels[i+1]=pixels[srcI+1];newPixels[i+2]=pixels[srcI+2];newPixels[i+3]=pixels[srcI+3]}}return newImageData}function transform_whirl(imagedata,value){var pixels,newImageData,newPixels,w,h,centerX,centerY,x,y,radius,scaleX,scaleY,whirlRadians,radiusSquared,dx,dy,d,factor,angle,srcX,srcY,i,srcI,sina,cosa;w=imagedata.width;h=imagedata.height;pixels=imagedata.data;newImageData=ctx.createImageData(w,h);newPixels=newImageData.data;centerX=w/2;centerY=h/2;radius=Math.min(centerX,centerY);if(w<h){scaleX=h/w;scaleY=1}else{scaleX=1;scaleY=w/h}whirlRadians=-radians(value);radiusSquared=radius*radius;for(y=0;y<h;y++){for(x=0;x<w;x++){dx=scaleX*(x-centerX);dy=scaleY*(y-centerY);d=dx*dx+dy*dy;if(d<radiusSquared){factor=1-Math.sqrt(d)/radius;angle=whirlRadians*(factor*factor);sina=Math.sin(angle);cosa=Math.cos(angle);srcX=Math.floor((cosa*dx-sina*dy)/scaleX+centerX);srcY=Math.floor((sina*dx+cosa*dy)/scaleY+centerY)}else{srcX=x;srcY=y}i=(y*w+x)*4;srcI=(srcY*w+srcX)*4;newPixels[i]=pixels[srcI];newPixels[i+1]=pixels[srcI+1];newPixels[i+2]=pixels[srcI+2];newPixels[i+3]=pixels[srcI+3]}}return newImageData}function transform_pixelate(imagedata,value){var pixels,newImageData,newPixels,w,h,x,y,srcX,srcY,i,srcI;w=imagedata.width;h=imagedata.height;pixels=imagedata.data;newImageData=ctx.createImageData(w,h);newPixels=newImageData.data;value=Math.floor(Math.abs(value/10)+1);for(y=0;y<h;y++){for(x=0;x<w;x++){srcX=Math.floor(x/value)*value;srcY=Math.floor(y/value)*value;i=(y*w+x)*4;srcI=(srcY*w+srcX)*4;newPixels[i]=pixels[srcI];newPixels[i+1]=pixels[srcI+1];newPixels[i+2]=pixels[srcI+2];newPixels[i+3]=pixels[srcI+3]}}return newImageData}function transform_mosaic(imagedata,value){var pixels,i,l,newImageData,newPixels,srcI;pixels=imagedata.data;newImageData=ctx.createImageData(imagedata.width,imagedata.height);newPixels=newImageData.data;value=Math.round((Math.abs(value)+10)/10);value=Math.max(0,Math.min(value,Math.min(imagedata.width,imagedata.height)));for(i=0,l=pixels.length;i<l;i+=4){srcI=i*value%l;newPixels[i]=pixels[srcI];newPixels[i+1]=pixels[srcI+1];newPixels[i+2]=pixels[srcI+2];newPixels[i+3]=pixels[srcI+3]}return newImageData}function transform_duplicate(imagedata,value){var pixels,i;pixels=imagedata.data;for(i=0;i<pixels.length;i+=4){pixels[i]=pixels[i*value];pixels[i+1]=pixels[i*value+1];pixels[i+2]=pixels[i*value+2];pixels[i+3]=pixels[i*value+3]}return imagedata}function transform_colorDimensions(imagedata,hueShift,saturationShift,brightnessShift){var pixels=imagedata.data,l=pixels.length,clr=new Color,index,dim;for(index=0;index<l;index+=4){clr.r=pixels[index];clr.g=pixels[index+1];clr.b=pixels[index+2];dim=clr[SpriteMorph.prototype.penColorModel]();dim[0]=dim[0]*100+hueShift;if(dim[0]<0||dim[0]>100){dim[0]=(dim[0]<0?100:0)+dim[0]%100}dim[0]=dim[0]/100;dim[1]=dim[1]+saturationShift/100;dim[2]=dim[2]+brightnessShift/100;clr["set_"+SpriteMorph.prototype.penColorModel].apply(clr,dim);pixels[index]=clr.r;pixels[index+1]=clr.g;pixels[index+2]=clr.b}return imagedata}function transform_negative(imagedata,value){var pixels,i,l,rcom,gcom,bcom;pixels=imagedata.data;for(i=0,l=pixels.length;i<l;i+=4){rcom=255-pixels[i];gcom=255-pixels[i+1];bcom=255-pixels[i+2];if(pixels[i]<rcom){pixels[i]+=value}else if(pixels[i]>rcom){pixels[i]-=value}if(pixels[i+1]<gcom){pixels[i+1]+=value}else if(pixels[i+1]>gcom){pixels[i+1]-=value}if(pixels[i+2]<bcom){pixels[i+2]+=value}else if(pixels[i+2]>bcom){pixels[i+2]-=value}}return imagedata}function transform_comic(imagedata,value){var pixels,i,l;pixels=imagedata.data;for(i=0,l=pixels.length;i<l;i+=4){pixels[i]+=Math.sin(i*value)*127+128;pixels[i+1]+=Math.sin(i*value)*127+128;pixels[i+2]+=Math.sin(i*value)*127+128}return imagedata}function transform_confetti(imagedata,value){var pixels,i,l;pixels=imagedata.data;for(i=0,l=pixels.length;i<l;i+=1){pixels[i]=Math.sin(value*pixels[i])*127+pixels[i]}return imagedata}if(this.graphicsChanged()){w=Math.ceil(this.width());h=Math.ceil(this.height());if(!canvas.width||!canvas.height||!w||!h){return canvas}ctx=canvas.getContext("2d");imagedata=ctx.getImageData(0,0,w,h);if(this.graphicsValues.fisheye){imagedata=transform_fisheye(imagedata,this.graphicsValues.fisheye)}if(this.graphicsValues.whirl){imagedata=transform_whirl(imagedata,this.graphicsValues.whirl)}if(this.graphicsValues.pixelate){imagedata=transform_pixelate(imagedata,this.graphicsValues.pixelate)}if(this.graphicsValues.mosaic){imagedata=transform_mosaic(imagedata,this.graphicsValues.mosaic)}if(this.graphicsValues.duplicate){imagedata=transform_duplicate(imagedata,this.graphicsValues.duplicate)}if(this.graphicsValues.color||this.graphicsValues.saturation||this.graphicsValues.brightness){imagedata=transform_colorDimensions(imagedata,this.graphicsValues.color,this.graphicsValues.saturation,this.graphicsValues.brightness)}if(this.graphicsValues.negative){imagedata=transform_negative(imagedata,this.graphicsValues.negative)}if(this.graphicsValues.comic){imagedata=transform_comic(imagedata,this.graphicsValues.comic)}if(this.graphicsValues.confetti){imagedata=transform_confetti(imagedata,this.graphicsValues.confetti)}ctx.putImageData(imagedata,0,0)}return canvas};SpriteMorph.prototype.setEffect=function(effect,value){var eff=effect instanceof Array?effect[0]:effect.toString();if(!contains(["color","saturation","brightness","ghost","fisheye","whirl","pixelate","mosaic","negative","duplicate","comic","confetti"],eff)){throw new Error(localize("unsupported graphic effect")+': "'+eff+'"')}if(eff==="ghost"){this.alpha=1-Math.min(Math.max(+value||0,0),100)/100}else{this.graphicsValues[eff]=+value}this.rerender()};SpriteMorph.prototype.getEffect=function(effect){var eff=effect instanceof Array?effect[0]:effect.toString();if(eff==="ghost"){return this.getGhostEffect()}return this.graphicsValues[eff]||0};SpriteMorph.prototype.getGhostEffect=function(){return(1-this.alpha)*100};SpriteMorph.prototype.changeEffect=function(effect,value){var eff=effect instanceof Array?effect[0]:effect.toString();if(eff==="ghost"){this.setEffect(effect,this.getGhostEffect()+(+value||0))}else{this.setEffect(effect,+this.graphicsValues[eff]+ +value)}};SpriteMorph.prototype.clearEffects=function(){var effect;for(effect in this.graphicsValues){if(this.graphicsValues.hasOwnProperty(effect)){this.setEffect([effect],0)}}this.setEffect(["ghost"],0)};SpriteMorph.prototype.stopTalking=function(){var bubble=this.talkBubble();if(bubble){bubble.destroy()}};SpriteMorph.prototype.doThink=function(data){this.bubble(data,true)};SpriteMorph.prototype.bubble=function(data,isThought,isQuestion){var bubble,stage=this.parentThatIsA(StageMorph);this.stopTalking();if(data===""||isNil(data)){return}bubble=new SpriteBubbleMorph(data,stage,isThought,isQuestion);this.add(bubble);this.positionTalkBubble()};SpriteMorph.prototype.talkBubble=function(){return detect(this.children,morph=>morph instanceof SpeechBubbleMorph)};SpriteMorph.prototype.positionTalkBubble=function(){var stage=this.parentThatIsA(StageMorph),stageScale=stage?stage.scale:1,bubble=this.talkBubble(),bottom=this.bottom(),step=this.extent().divideBy(10).max(new Point(5,5).scaleBy(stageScale)).multiplyBy(new Point(-1,1));if(!bubble){return null}bubble.show();if(!bubble.isPointingRight){bubble.isPointingRight=true;bubble.fixLayout();bubble.rerender()}bubble.setLeft(this.right());bubble.setBottom(this.top());while(!this.isTouching(bubble)&&bubble.bottom()<bottom){bubble.moveBy(step)}bubble.moveBy(step.mirror());if(!stage){return null}if(bubble.right()>stage.right()){bubble.isPointingRight=false;bubble.fixLayout();bubble.rerender();bubble.setRight(this.center().x)}bubble.keepWithin(stage)};SpriteMorph.prototype.prepareToBeGrabbed=function(hand){this.recordLayers();this.shadowAttribute("x position");this.shadowAttribute("y position");if(!this.bounds.containsPoint(hand.position())&&this.isCorrectingOutsideDrag()){this.setCenter(hand.position())}};SpriteMorph.prototype.isCorrectingOutsideDrag=function(){return!this.parts.length};SpriteMorph.prototype.justDropped=function(){var stage=this.parentThatIsA(StageMorph);if(stage){stage.enableCustomHatBlocks=true}if(this.exemplar){this.inheritedAttributes.forEach(att=>{if(contains(["direction","size","costume #"],att)){this.refreshInheritedAttribute(att)}})}this.restoreLayers();this.positionTalkBubble();this.receiveUserInteraction("dropped")};SpriteMorph.prototype.drawLine=function(start,dest){var stagePos=this.parent.bounds.origin,stageScale=this.parent.scale,context=this.parent.penTrails().getContext("2d"),from=start.subtract(stagePos).divideBy(stageScale),to=dest.subtract(stagePos).divideBy(stageScale),damagedFrom=from.multiplyBy(stageScale).add(stagePos),damagedTo=to.multiplyBy(stageScale).add(stagePos),damaged=damagedFrom.rectangle(damagedTo).expandBy(Math.max(this.size*stageScale/2,1)).intersect(this.parent.visibleBounds()).spread();if(this.isDown){if(StageMorph.prototype.enablePenLogging){this.parent.trailsLog.push([this.snapPoint(start),this.snapPoint(dest),this.color.copy(),this.size,this.useFlatLineEnds?"butt":"round"])}context.lineWidth=this.size;context.strokeStyle=this.color.toString();if(this.useFlatLineEnds){context.lineCap="butt";context.lineJoin="miter"}else{context.lineCap="round";context.lineJoin="round"}context.beginPath();context.moveTo(from.x,from.y);context.lineTo(to.x,to.y);context.stroke();if(this.isWarped===false){this.world().broken.push(damaged)}this.parent.cachedPenTrailsMorph=null}};SpriteMorph.prototype.floodFill=function(){if(!this.parent.bounds.containsPoint(this.rotationCenter())){return}this.parent.cachedPenTrailsMorph=null;if(this.color.a>1){this.color.a=this.color.a/255}var layer=normalizeCanvas(this.parent.penTrails()),width=layer.width,height=layer.height,ctx=layer.getContext("2d"),img=ctx.getImageData(0,0,width,height),dta=img.data,stack=[Math.floor(height/2-this.yPosition())*width+Math.floor(this.xPosition()+width/2)],clr=new Color(Math.round(Math.min(Math.max(this.color.r,0),255)),Math.round(Math.min(Math.max(this.color.g,0),255)),Math.round(Math.min(Math.max(this.color.b,0),255)),this.color.a),current,src;function read(p){var d=p*4;return[dta[d],dta[d+1],dta[d+2],dta[d+3]]}function check(p){return p[0]===src[0]&&p[1]===src[1]&&p[2]===src[2]&&p[3]===src[3]}src=read(stack[0]);if(src[0]===clr.r&&src[1]===clr.g&&src[2]===clr.b&&src[3]===Math.round(clr.a*255)){return}while(stack.length>0){current=stack.pop();if(check(read(current))){if(current%width>1){stack.push(current+1);stack.push(current-1)}if(current>0&&current<height*width){stack.push(current+width);stack.push(current-width)}}dta[current*4]=clr.r;dta[current*4+1]=clr.g;dta[current*4+2]=clr.b;dta[current*4+3]=Math.round(clr.a*255)}ctx.putImageData(img,0,0);this.parent.changed()};SpriteMorph.prototype.reportPenTrailsAsCostume=function(){var cst=new Costume(this.parentThatIsA(StageMorph).trailsCanvas,this.newCostumeName(localize("Costume")));cst.shrinkWrap();cst.rotationCenter=cst.rotationCenter.translateBy(new Point(this.xPosition(),-this.yPosition()));return cst};SpriteMorph.prototype.moveBy=function(delta,justMe){var start=this.isDown&&!justMe&&this.parent?this.rotationCenter():null;SpriteMorph.uber.moveBy.call(this,delta);if(start){this.drawLine(start,this.rotationCenter())}if(!justMe){this.parts.forEach(part=>part.moveBy(delta));this.instances.forEach(instance=>{if(instance.cachedPropagation){var inheritsX=instance.inheritsAttribute("x position"),inheritsY=instance.inheritsAttribute("y position");if(inheritsX&&inheritsY){instance.moveBy(delta)}else if(inheritsX){instance.moveBy(new Point(delta.x,0))}else if(inheritsY){instance.moveBy(new Point(0,delta.y))}}})}};SpriteMorph.prototype.rootForGrab=function(){if(this.anchor){return this.anchor.rootForGrab()}return SpriteMorph.uber.rootForGrab.call(this)};SpriteMorph.prototype.setCenter=function(aPoint,justMe){var delta=aPoint.subtract(this.center());this.moveBy(delta,justMe)};SpriteMorph.prototype.nestingBounds=function(){var result=this.bounds;if(!this.costume&&this.penBounds){result=this.penBounds.translateBy(this.position())}this.parts.forEach(part=>{if(part.isVisible){result=result.merge(part.nestingBounds())}});return result};SpriteMorph.prototype.setPosition=function(aPoint,justMe){var delta=aPoint.subtract(this.topLeft());if(delta.x!==0||delta.y!==0){this.moveBy(delta,justMe)}};SpriteMorph.prototype.forward=function(steps){var dest,dist=steps*this.parent.scale||0,dot=.1;if(dist===0&&this.isDown){this.isDown=false;this.forward(dot*-.5);this.isDown=true;this.forward(dot);this.isDown=false;this.forward(dot*-.5);this.isDown=true;return}else if(dist>=0){dest=this.position().distanceAngle(dist,this.heading)}else{dest=this.position().distanceAngle(Math.abs(dist),this.heading-180)}this.shadowAttribute("x position");this.shadowAttribute("y position");this.setPosition(dest);this.positionTalkBubble()};SpriteMorph.prototype.setHeading=function(degrees,noShadow){var x=this.xPosition(),y=this.yPosition(),dir=!isFinite(degrees)?0:+degrees,turn=dir-this.heading;if(this.rotationStyle){this.changed();SpriteMorph.uber.setHeading.call(this,dir);this.silentGotoXY(x,y,true);this.positionTalkBubble()}else{this.heading=(+degrees%360+360)%360}this.parts.forEach(part=>{var pos=new Point(part.xPosition(),part.yPosition()),trg=pos.rotateBy(radians(turn),new Point(x,y));if(part.rotatesWithAnchor){part.turn(turn)}part.gotoXY(trg.x,trg.y)});if(!noShadow){this.shadowAttribute("direction")}this.instances.forEach(instance=>{if(instance.cachedPropagation){if(instance.inheritsAttribute("direction")){instance.setHeading(degrees,true)}}})};SpriteMorph.prototype.faceToXY=function(x,y){this.setHeading(this.angleToXY(x,y))};SpriteMorph.prototype.angleToXY=function(x,y){var deltaX=(x-this.xPosition())*this.parent.scale,deltaY=(y-this.yPosition())*this.parent.scale,angle=Math.abs(deltaX)<.001?deltaY<0?90:270:Math.round((deltaX>=0?0:180)-Math.atan(deltaY/deltaX)*57.2957795131);return angle+90};SpriteMorph.prototype.turn=function(degrees){this.setHeading(this.heading+(+degrees||0))};SpriteMorph.prototype.turnLeft=function(degrees){this.setHeading(this.heading-(+degrees||0))};SpriteMorph.prototype.getPosition=function(){return new List([this.xPosition(),this.yPosition()])};SpriteMorph.prototype.xPosition=function(){if(this.inheritsAttribute("x position")){return this.exemplar.xPosition()}var stage=this.parentThatIsA(StageMorph);if(!stage&&this.parent.grabOrigin){stage=this.parent.grabOrigin.origin}if(stage){return(this.rotationCenter().x-stage.center().x)/stage.scale}return this.rotationCenter().x};SpriteMorph.prototype.yPosition=function(){if(this.inheritsAttribute("y position")){return this.exemplar.yPosition()}var stage=this.parentThatIsA(StageMorph);if(!stage&&this.parent.grabOrigin){stage=this.parent.grabOrigin.origin}if(stage){return(stage.center().y-this.rotationCenter().y)/stage.scale}return this.rotationCenter().y};SpriteMorph.prototype.direction=function(){if(this.inheritsAttribute("direction")){return this.exemplar.direction()}return this.heading};SpriteMorph.prototype.penSize=function(){return this.size};SpriteMorph.prototype.gotoXY=function(x,y,justMe,noShadow){var stage=this.parentThatIsA(StageMorph),newX,newY,dest;if(!stage){return}if(!noShadow){this.shadowAttribute("x position");this.shadowAttribute("y position")}x=!isFinite(+x)?0:+x;y=!isFinite(+y)?0:+y;newX=stage.center().x+x*stage.scale;newY=stage.center().y-y*stage.scale;if(this.costume){dest=new Point(newX,newY).subtract(this.rotationOffset)}else{dest=new Point(newX,newY).subtract(this.extent().divideBy(2))}this.setPosition(dest,justMe);this.positionTalkBubble()};SpriteMorph.prototype.silentGotoXY=function(x,y,justMe){var penState=this.isDown;this.isDown=false;this.gotoXY(x,y,justMe,true);this.isDown=penState};SpriteMorph.prototype.setXPosition=function(num){this.shadowAttribute("x position");this.gotoXY(+num||0,this.yPosition(),false,true)};SpriteMorph.prototype.changeXPosition=function(delta){this.setXPosition(this.xPosition()+(+delta||0))};SpriteMorph.prototype.setYPosition=function(num){this.shadowAttribute("y position");this.gotoXY(this.xPosition(),+num||0,false,true)};SpriteMorph.prototype.changeYPosition=function(delta){this.setYPosition(this.yPosition()+(+delta||0))};SpriteMorph.prototype.glide=function(duration,endX,endY,elapsed,startPoint){var fraction,endPoint,rPos;endPoint=new Point(endX,endY);fraction=Math.max(Math.min(elapsed/duration,1),0);rPos=startPoint.add(endPoint.subtract(startPoint).multiplyBy(fraction));this.gotoXY(rPos.x,rPos.y)};SpriteMorph.prototype.bounceOffEdge=function(){var stage=this.parentThatIsA(StageMorph),fb=this.nestingBounds(),dirX,dirY;if(!stage){return null}if(stage.bounds.containsRectangle(fb)){return null}dirX=Math.cos(radians(this.heading-90));dirY=-Math.sin(radians(this.heading-90));if(fb.left()<stage.left()){dirX=Math.abs(dirX)}if(fb.right()>stage.right()){dirX=-Math.abs(dirX)}if(fb.top()<stage.top()){dirY=-Math.abs(dirY)}if(fb.bottom()>stage.bottom()){dirY=Math.abs(dirY)}this.shadowAttribute("x position");this.shadowAttribute("y position");this.shadowAttribute("direction");this.setHeading(degrees(Math.atan2(-dirY,dirX))+90);this.setPosition(this.position().add(fb.amountToTranslateWithin(stage.bounds)));this.positionTalkBubble()};SpriteMorph.prototype.snapPoint=function(aPoint){var stage=this.parentThatIsA(StageMorph),origin=stage.center();return new Point((aPoint.x-origin.x)/stage.scale,(origin.y-aPoint.y)/stage.scale)};SpriteMorph.prototype.setRotationX=function(absoluteX){this.setRotationCenter(new Point(absoluteX,this.yPosition()))};SpriteMorph.prototype.setRotationY=function(absoluteY){this.setRotationCenter(new Point(this.xPosition(),absoluteY))};SpriteMorph.prototype.setRotationCenter=function(absoluteCoordinate){var delta,normal;if(!this.costume){throw new Error("setting the rotation center requires a costume")}this.shadowAttribute("costumes");delta=absoluteCoordinate.subtract(new Point(this.xPosition(),this.yPosition())).divideBy(this.scale).rotateBy(radians(90-this.heading));normal=this.costume.rotationCenter.add(new Point(delta.x,-delta.y));this.costume.rotationCenter=normal;this.changed();this.fixLayout();this.changed()};SpriteMorph.prototype.moveRotationCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"movePivot")};SpriteMorph.prototype.setPivot=function(worldCoordinate){var stage=this.parentThatIsA(StageMorph),ide=this.parentThatIsA(IDE_Morph),cntr;if(stage){cntr=stage.center();this.setRotationCenter(new Point((worldCoordinate.x-cntr.x)/stage.scale,(cntr.y-worldCoordinate.y)/stage.scale));if(ide){ide.recordUnsavedChanges()}}};SpriteMorph.prototype.xCenter=function(){var stage=this.parentThatIsA(StageMorph);if(!stage&&this.parent.grabOrigin){stage=this.parent.grabOrigin.origin}if(stage){return(this.center().x-stage.center().x)/stage.scale}return this.center().x};SpriteMorph.prototype.yCenter=function(){var stage=this.parentThatIsA(StageMorph);if(!stage&&this.parent.grabOrigin){stage=this.parent.grabOrigin.origin}if(stage){return(stage.center().y-this.center().y)/stage.scale}return this.center().y};SpriteMorph.prototype.xLeft=function(){var stage=this.parentThatIsA(StageMorph);if(!stage&&this.parent.grabOrigin){stage=this.parent.grabOrigin.origin}if(stage){return(this.left()-stage.center().x)/stage.scale}return this.left()};SpriteMorph.prototype.xRight=function(){var stage=this.parentThatIsA(StageMorph);if(!stage&&this.parent.grabOrigin){stage=this.parent.grabOrigin.origin}if(stage){return(this.right()-stage.center().x)/stage.scale}return this.right()};SpriteMorph.prototype.yTop=function(){var stage=this.parentThatIsA(StageMorph);if(!stage&&this.parent.grabOrigin){stage=this.parent.grabOrigin.origin}if(stage){return(stage.center().y-this.top())/stage.scale}return this.top()};SpriteMorph.prototype.yBottom=function(){var stage=this.parentThatIsA(StageMorph);if(!stage&&this.parent.grabOrigin){stage=this.parent.grabOrigin.origin}if(stage){return(stage.center().y-this.bottom())/stage.scale}return this.bottom()};SpriteMorph.prototype.allMessageNames=function(){var msgs=[];this.allScripts().forEach(script=>{script.allChildren().forEach(morph=>{var txt;if(morph instanceof InputSlotMorph&&morph.choices&&contains(["messagesMenu","messagesReceivedMenu"],morph.choices)){txt=morph.evaluate();if(isString(txt)&&txt!==""){if(!contains(msgs,txt)){msgs.push(txt)}}}})});return msgs};SpriteMorph.prototype.allSendersOf=function(message,receiverName,known){return this.allScripts().filter(script=>script.isSending&&script.isSending(message,receiverName,known))};SpriteMorph.prototype.allHatBlocksFor=function(message){if(typeof message==="number"){message=message.toString()}return this.scripts.children.filter(morph=>{var sel=morph.selector,event;if(sel){if(sel==="receiveMessage"){event=morph.inputs()[0].evaluate();return event===message||event instanceof Array&&event[0]==message||event instanceof Array&&message!=="__shout__go__"&&message!=="__clone__init__"}if(sel==="receiveGo"){return message==="__shout__go__"}if(sel==="receiveOnClone"){return message==="__clone__init__"}}return false})};SpriteMorph.prototype.allHatBlocksForKey=function(key){return this.scripts.children.filter(morph=>{if(morph.selector){if(morph.selector==="receiveKey"){var choice=morph.inputs()[0].evaluate(),evt=choice instanceof Array?choice[0]:choice;return evt===key||evt==="any key"}}return false})};SpriteMorph.prototype.allHatBlocksForInteraction=function(interaction){return this.scripts.children.filter(morph=>{if(morph.selector){if(morph.selector==="receiveInteraction"){return morph.inputs()[0].evaluate()[0]===interaction}}return false})};SpriteMorph.prototype.hasGenericHatBlocks=function(){return this.scripts.children.some(morph=>morph.selector==="receiveCondition")};SpriteMorph.prototype.allGenericHatBlocks=function(){return this.scripts.children.filter(morph=>{if(morph.selector){return morph.selector==="receiveCondition"}return false})};SpriteMorph.prototype.allScripts=function(){var all=this.scripts.children.slice();this.customBlocks.forEach(def=>{if(def.body){all.push(def.body.expression)}def.scripts.forEach(scr=>all.push(scr))});if(this.globalBlocks){this.globalBlocks.forEach(def=>{if(def.body){all.push(def.body.expression)}def.scripts.forEach(scr=>all.push(scr))})}return all};SpriteMorph.prototype.mouseClickLeft=function(){return this.receiveUserInteraction("clicked")};SpriteMorph.prototype.mouseEnter=function(){return this.receiveUserInteraction("mouse-entered")};SpriteMorph.prototype.mouseDownLeft=function(){return this.receiveUserInteraction("pressed")};SpriteMorph.prototype.mouseScroll=function(y){return this.receiveUserInteraction("scrolled-"+(y>0?"up":"down"))};SpriteMorph.prototype.receiveUserInteraction=function(interaction,rightAway,threadSafe){var stage=this.parentThatIsA(StageMorph),procs=[],hats;if(!stage){return}hats=this.allHatBlocksForInteraction(interaction);hats.forEach(block=>procs.push(stage.threads.startProcess(block,this,threadSafe||stage.isThreadSafe,null,null,null,rightAway,interaction==="stopped")));return procs};SpriteMorph.prototype.mouseDoubleClick=function(){if(this.isTemporary){return}this.edit()};SpriteMorph.prototype.getTimer=function(){var stage=this.parentThatIsA(StageMorph);if(stage){return stage.getTimer()}return 0};SpriteMorph.prototype.getTempo=function(){var stage=this.parentThatIsA(StageMorph);if(stage){return stage.getTempo()}return 0};SpriteMorph.prototype.getLastMessage=function(){var stage=this.parentThatIsA(StageMorph);if(stage){return stage.getLastMessage()}return""};SpriteMorph.prototype.getLastAnswer=function(){return this.parentThatIsA(StageMorph).lastAnswer};SpriteMorph.prototype.reportThreadCount=function(){var stage=this.parentThatIsA(StageMorph);if(stage){return stage.threads.processes.length}return 0};SpriteMorph.prototype.refactorVariableInstances=function(oldName,newName,isGlobal){if(isGlobal&&this.hasSpriteVariable(oldName)){return}this.scripts.children.forEach(child=>{if(child instanceof BlockMorph){child.refactorVarInStack(oldName,newName)}})};SpriteMorph.prototype.findVariableWatcher=function(varName){var stage=this.parentThatIsA(StageMorph),globals=this.globalVariables();if(stage===null){return null}return detect(stage.children,morph=>morph instanceof WatcherMorph&&(morph.target===this.variables||morph.target===globals)&&morph.getter===varName)};SpriteMorph.prototype.toggleVariableWatcher=function(varName,isGlobal){var stage=this.parentThatIsA(StageMorph),ide=this.parentThatIsA(IDE_Morph),globals=this.globalVariables(),watcher,others;if(stage===null){return null}if(isNil(isGlobal)){isGlobal=contains(globals.names(),varName)}watcher=this.findVariableWatcher(varName);if(watcher!==null){if(watcher.isVisible){watcher.hide()}else{watcher.show();watcher.fixLayout();watcher.keepWithin(stage)}if(isGlobal){ide.flushBlocksCache("variables");ide.refreshPalette()}return}watcher=new WatcherMorph(varName,this.blockColor.variables,isGlobal?globals:this.variables,varName);watcher.setPosition(stage.position().add(10));others=stage.watchers(watcher.left());if(others.length>0){watcher.setTop(others[others.length-1].bottom())}watcher.fixLayout();watcher.keepWithin(stage);stage.add(watcher);watcher.changed();return watcher};SpriteMorph.prototype.showingVariableWatcher=function(varName){var stage=this.parentThatIsA(StageMorph),watcher;if(stage===null){return false}watcher=this.findVariableWatcher(varName);if(watcher){return watcher.isVisible}return false};SpriteMorph.prototype.deleteVariableWatcher=function(varName){var stage=this.parentThatIsA(StageMorph),watcher;if(stage===null){return null}watcher=this.findVariableWatcher(varName);if(watcher!==null){watcher.destroy()}};SpriteMorph.prototype.toggleWatcher=function(selector,label,color){var stage=this.parentThatIsA(StageMorph),ide=this.parentThatIsA(IDE_Morph),watcher,others;if(!stage){return}watcher=this.watcherFor(stage,selector);if(watcher){if(watcher.isVisible){watcher.hide()}else{watcher.show();watcher.fixLayout();watcher.keepWithin(stage)}if(watcher.isGlobal(selector)){ide.flushBlocksCache();ide.refreshPalette()}return}watcher=new WatcherMorph(label,color,WatcherMorph.prototype.isGlobal(selector)?stage:this,selector);watcher.setPosition(stage.position().add(10));others=stage.watchers(watcher.left());if(others.length>0){watcher.setTop(others[others.length-1].bottom())}stage.add(watcher);watcher.fixLayout();watcher.keepWithin(stage);watcher.changed();if(watcher.isGlobal(selector)){ide.flushBlocksCache();ide.refreshPalette()}};SpriteMorph.prototype.showingWatcher=function(selector){var stage=this.parentThatIsA(StageMorph),watcher;if(stage===null){return false}watcher=this.watcherFor(stage,selector);if(watcher){return watcher.isVisible}return false};SpriteMorph.prototype.watcherFor=function(stage,selector){return detect(stage.children,morph=>morph instanceof WatcherMorph&&morph.getter===selector&&morph.target===(morph.isGlobal(selector)?stage:this))};SpriteMorph.prototype.deleteAllBlockInstances=function(definition){var stage,blocks=definition.isGlobal?this.allBlockInstances(definition):this.allIndependentInvocationsOf(definition.blockSpec());blocks.forEach(each=>each.deleteBlock());if(definition.isGlobal){stage=this.parentThatIsA(StageMorph);if(stage){stage.globalBlocks.forEach(def=>def.purgeCorpses());stage.children.concat(stage).forEach(sprite=>{if(sprite.isSnapObject){sprite.customBlocks.forEach(def=>def.purgeCorpses())}})}}else{this.allSpecimens().concat(this).forEach(sprite=>sprite.customBlocks.forEach(def=>def.purgeCorpses()))}};SpriteMorph.prototype.allBlockInstances=function(definition){var stage,objects,blocks=[],inDefinitions=[];if(definition.isGlobal){stage=this.parentThatIsA(StageMorph);objects=stage.children.filter(morph=>morph instanceof SpriteMorph);objects.push(stage);objects.forEach(sprite=>blocks=blocks.concat(sprite.allLocalBlockInstances(definition)));stage.globalBlocks.forEach(def=>{def.scripts.forEach(eachScript=>eachScript.allChildren().forEach(c=>{if(c.isCustomBlock&&c.definition===definition){inDefinitions.push(c)}}));if(def.body){def.body.expression.allChildren().forEach(c=>{if(c.isCustomBlock&&c.definition===definition){inDefinitions.push(c)}})}});return blocks.concat(inDefinitions).concat(stage.allBlockInstancesInData(definition))}return this.allLocalBlockInstances(definition)};SpriteMorph.prototype.allIndependentInvocationsOf=function(aSpec){var blocks;if(this.exemplar&&this.exemplar.getMethod(aSpec)){return[]}blocks=this.allInvocationsOf(aSpec);this.instances.forEach(sprite=>sprite.addAllInvocationsOf(aSpec,blocks));return blocks};SpriteMorph.prototype.allDependentInvocationsOf=function(aSpec){var blocks;blocks=this.allInvocationsOf(aSpec);this.instances.forEach(sprite=>sprite.addAllInvocationsOf(aSpec,blocks));return blocks.concat(this.parentThatIsA(StageMorph).allBlockInvocationsInData(aSpec,this))};SpriteMorph.prototype.allInvocationsOf=function(aSpec){var inScripts,inDefinitions,inBlockEditors,blocks;inScripts=this.scripts.allChildren().filter(c=>c.isCustomBlock&&!c.isGlobal&&c.blockSpec===aSpec);inDefinitions=[];this.customBlocks.forEach(def=>{def.scripts.forEach(eachScript=>eachScript.allChildren().forEach(c=>{if(c.isCustomBlock&&!c.isGlobal&&c.blockSpec===aSpec){inDefinitions.push(c)}}));if(def.body){def.body.expression.allChildren().forEach(c=>{if(c.isCustomBlock&&!c.isGlobal&&c.blockSpec===aSpec){inDefinitions.push(c)}})}});inBlockEditors=this.allEditorBlockInstances(null,aSpec);blocks=inScripts.concat(inDefinitions).concat(inBlockEditors);return blocks};SpriteMorph.prototype.addAllInvocationsOf=function(aSpec,anArray){if(!this.getLocalMethod(aSpec)){this.allInvocationsOf(aSpec).forEach(block=>anArray.push(block));this.instances.forEach(sprite=>sprite.addAllInvocationsOf(aSpec,anArray))}};SpriteMorph.prototype.allLocalBlockInstances=function(definition){var inScripts,inDefinitions,inBlockEditors,inPalette,result;inScripts=this.scripts.allChildren().filter(c=>c.isCustomBlock&&c.definition===definition);inDefinitions=[];this.customBlocks.forEach(def=>{if(def.body){def.body.expression.allChildren().forEach(c=>{if(c.isCustomBlock&&c.definition===definition){inDefinitions.push(c)}})}});inBlockEditors=this.allEditorBlockInstances(definition);inPalette=this.paletteBlockInstance(definition);result=inScripts.concat(inDefinitions).concat(inBlockEditors);if(inPalette){result.push(inPalette)}return result};SpriteMorph.prototype.allEditorBlockInstances=function(definition,spec){var inBlockEditors=[],world=this.world();if(!world){return[]}this.world().children.forEach(morph=>{if(morph instanceof BlockEditorMorph){morph.body.contents.allChildren().forEach(block=>{if(definition){if(!block.isPrototype&&!(block instanceof PrototypeHatBlockMorph)&&block.definition===definition){inBlockEditors.push(block)}}else{if(block.isCustomBlock&&!block.isGlobal&&!block.isPrototype&&!(block instanceof PrototypeHatBlockMorph)&&block.blockSpec===spec){inBlockEditors.push(block)}}})}});return inBlockEditors};SpriteMorph.prototype.paletteBlockInstance=function(definition){var ide=this.parentThatIsA(IDE_Morph);if(!ide){return null}return detect(ide.palette.contents.children,block=>block.isCustomBlock&&block.definition===definition)};SpriteMorph.prototype.usesBlockInstance=function(definition,forRemoval,skipGlobals,skipBlocks){var inDefinitions,inScripts=detect(this.scripts.allChildren(),c=>c.isCustomBlock&&c.definition===definition);if(inScripts){return true}if(definition.isGlobal&&!skipGlobals){inDefinitions=[];this.parentThatIsA(StageMorph).globalBlocks.forEach(def=>{if(forRemoval&&definition===def){return}if(skipBlocks&&contains(skipBlocks,def)){return}if(def.body){def.body.expression.allChildren().forEach(c=>{if(c.isCustomBlock&&c.definition===definition){inDefinitions.push(c)}})}});if(inDefinitions.length>0){return true}}inDefinitions=[];this.customBlocks.forEach(def=>{if(def.body){def.body.expression.allChildren().forEach(c=>{if(c.isCustomBlock&&c.definition===definition){inDefinitions.push(c)}})}});return inDefinitions.length>0};SpriteMorph.prototype.doubleDefinitionsFor=function(definition){var spec=definition.blockSpec(),blockList,idx,stage;if(definition.isGlobal){stage=this.parentThatIsA(StageMorph);if(!stage){return[]}blockList=stage.globalBlocks}else{blockList=this.customBlocks}idx=blockList.indexOf(definition);if(idx===-1){return[]}return blockList.filter((def,i)=>def.blockSpec()===spec&&i!==idx)};SpriteMorph.prototype.replaceDoubleDefinitionsFor=function(definition){var doubles=this.doubleDefinitionsFor(definition),stage,ide;doubles.forEach(double=>this.allBlockInstances(double).forEach(block=>{block.definition=definition;block.refresh()}));if(definition.isGlobal){stage=this.parentThatIsA(StageMorph);stage.globalBlocks=stage.globalBlocks.filter(def=>!contains(doubles,def))}else{this.customBlocks=this.customBlocks.filter(def=>!contains(doubles,def));this.allDependentInvocationsOf(definition.blockSpec()).reverse().forEach(block=>block.refresh(definition))}ide=this.parentThatIsA(IDE_Morph);if(ide){ide.flushPaletteCache();ide.refreshPalette()}};SpriteMorph.prototype.pauseGenericHatBlocks=function(){var stage=this.parentThatIsA(StageMorph),ide=this.parentThatIsA(IDE_Morph);if(this.hasGenericHatBlocks()){stage.enableCustomHatBlocks=true;stage.threads.pauseCustomHatBlocks=true;ide.controlBar.stopButton.refresh()}};SpriteMorph.prototype.chooseExemplar=function(){var stage=this.parentThatIsA(StageMorph),other=stage.children.filter(m=>m instanceof SpriteMorph&&!m.isTemporary&&!contains(m.allExemplars(),this)),menu;menu=new MenuMorph(aSprite=>this.setExemplar(aSprite),localize("current parent")+":\n"+(this.exemplar?this.exemplar.name:localize("none")));other.forEach(eachSprite=>menu.addItem(eachSprite.name,eachSprite,null,null,null,null,null,null,true));menu.addLine();menu.addItem(localize("none"),null);menu.popUpAtHand(this.world())};SpriteMorph.prototype.setExemplar=function(another,enableError){var ide;if(another instanceof SpriteMorph&&contains(another.allExemplars(),this)){if(enableError){throw new Error(localize("unable to inherit\n(disabled or circular?)"))}return}this.emancipate();this.exemplar=another;if(another){this.variables.parentFrame=another.variables;another.addSpecimen(this)}else{this.variables.parentFrame=this.globalVariables()}if(this.isTemporary){this.cloneOriginName=another.cloneOriginName||another.name}else{ide=this.parentThatIsA(IDE_Morph);if(ide){ide.flushBlocksCache();ide.refreshPalette()}}};SpriteMorph.prototype.prune=function(){this.instances.forEach(child=>{child.shadowAllAttributes();child.shadowAllMethods();child.shadowAllVars();child.exemplar=null});this.instances=[]};SpriteMorph.prototype.emancipate=function(){if(this.exemplar){if(!this.isTemporary){this.shadowAllAttributes();this.shadowAllMethods();this.shadowAllVars()}this.exemplar.removeSpecimen(this);this.exemplar=null}};SpriteMorph.prototype.allExemplars=function(){var all=[],current=this;while(!isNil(current)){all.push(current);current=current.exemplar}return all};SpriteMorph.prototype.specimens=function(){return this.instances};SpriteMorph.prototype.allSpecimens=function(){var all=this.instances.slice();this.instances.forEach(child=>all.push.apply(all,child.allSpecimens()));return all};SpriteMorph.prototype.addSpecimen=function(another){this.instances.push(another)};SpriteMorph.prototype.removeSpecimen=function(another){var idx=this.instances.indexOf(another);if(idx!==-1){this.instances.splice(idx,1)}};SpriteMorph.prototype.inheritsAttribute=function(aName){return!isNil(this.exemplar)&&contains(this.inheritedAttributes,aName)};SpriteMorph.prototype.updatePropagationCache=function(){this.cachedPropagation=!isNil(this.exemplar)&&detect(["x position","y position","direction","size","costume #","volume","balance","shown?","pen down?"],att=>contains(this.inheritedAttributes,att))};SpriteMorph.prototype.shadowedAttributes=function(){var inherited=this.inheritedAttributes;return this.attributes.filter(each=>!contains(inherited,each))};SpriteMorph.prototype.shadowAllAttributes=function(){this.attributes.forEach(att=>this.shadowAttribute(att))};SpriteMorph.prototype.shadowAttribute=function(aName){var ide,wardrobe,jukebox,pos;if(!this.inheritsAttribute(aName)){return}ide=this.parentThatIsA(IDE_Morph);this.inheritedAttributes=this.inheritedAttributes.filter(each=>each!==aName);if(aName==="costumes"){wardrobe=new List;this.costumes.asArray().forEach(costume=>{var cst=costume.copy();wardrobe.add(cst);if(costume===this.costume){this.wearCostume(cst)}});this.costumes=wardrobe;this.instances.forEach(obj=>{if(obj.inheritsAttribute("costumes")){obj.refreshInheritedAttribute("costumes")}})}else if(aName==="sounds"){jukebox=new List;this.sounds.asArray().forEach(sound=>jukebox.add(sound.copy()));this.sounds=jukebox;this.instances.forEach(obj=>{if(obj.inheritsAttribute("sounds")){obj.refreshInheritedAttribute("sounds")}})}else if(aName==="scripts"){ide.stage.threads.stopAllForReceiver(this);pos=this.scripts.position();this.scripts=this.exemplar.scripts.fullCopy();if(ide&&contains(ide.currentSprite.allExemplars(),this)){ide.createSpriteEditor();ide.fixLayout("selectSprite");this.scripts.fixMultiArgs();this.scripts.setPosition(pos);ide.spriteEditor.adjustScrollBars()}this.instances.forEach(obj=>{if(obj.inheritsAttribute("scripts")){obj.refreshInheritedAttribute("scripts")}})}else{this.updatePropagationCache();if(ide&&!this.isTemporary){ide.flushBlocksCache();ide.refreshPalette()}}};SpriteMorph.prototype.inheritAttribute=function(aName){var ide=this.parentThatIsA(IDE_Morph);if(!this.exemplar||!contains(this.attributes,aName)){return}if(!this.inheritsAttribute(aName)){this.inheritedAttributes.push(aName);this.refreshInheritedAttribute(aName);if(ide){ide.flushBlocksCache();ide.refreshPalette()}}};SpriteMorph.prototype.refreshInheritedAttribute=function(aName){var ide,idx;switch(aName){case"x position":case"y position":this.cachedPropagation=true;this.gotoXY(this.xPosition(),this.yPosition(),false,true);break;case"direction":this.cachedPropagation=true;this.setHeading(this.direction(),true);break;case"size":this.cachedPropagation=true;this.setScale(this.getScale(),true);break;case"costume #":this.cachedPropagation=true;if(this.inheritsAttribute("costumes")){this.wearCostume(this.exemplar.costume,true)}else{this.doSwitchToCostume(this.getCostumeIdx(),true)}break;case"volume":this.cachedPropagation=true;this.setVolume(this.getVolume(),true);break;case"shown?":this.cachedPropagation=true;this.setVisibility(this.reportShown(),true);break;case"pen down?":this.cachedPropagation=true;this.setPenDown(this.getPenDown(),true);break;case"balance":this.cachedPropagation=true;this.setPan(this.getPan(),true);break;case"costumes":idx=this.getCostumeIdx();this.costumes=this.exemplar.costumes;this.doSwitchToCostume(idx,true);this.instances.forEach(sprite=>{if(sprite.inheritsAttribute("costumes")){sprite.refreshInheritedAttribute("costumes")}});break;case"sounds":this.sounds=this.exemplar.sounds;this.instances.forEach(sprite=>{if(sprite.inheritsAttribute("sounds")){sprite.refreshInheritedAttribute("sounds")}});break;case"scripts":this.scripts=this.exemplar.scripts;ide=this.parentThatIsA(IDE_Morph);if(ide){ide.stage.threads.stopAllForReceiver(this);if(contains(ide.currentSprite.allExemplars(),this)){ide.createSpriteEditor();ide.fixLayout("selectSprite")}}this.instances.forEach(sprite=>{if(sprite.inheritsAttribute("scripts")){sprite.refreshInheritedAttribute("scripts")}});break;default:nop()}};SpriteMorph.prototype.toggleInheritanceForAttribute=function(aName){if(this.inheritsAttribute(aName)){this.shadowAttribute(aName)}else{this.inheritAttribute(aName)}};SpriteMorph.prototype.isVariableNameInUse=function(vName,isGlobal){if(isGlobal){return contains(this.variables.allNames(),vName)}if(contains(this.variables.names(),vName)){return true}return contains(this.globalVariables().names(),vName)};SpriteMorph.prototype.globalVariables=function(){var current=this.variables.parentFrame;while(current.owner){current=current.parentFrame}return current};SpriteMorph.prototype.shadowAllVars=function(){this.inheritedVariableNames().forEach(name=>this.shadowVar(name,this.variables.getVar(name)))};SpriteMorph.prototype.shadowVar=function(name,value){var ide;this.variables.addVar(name,value);if(!this.isTemporary){ide=this.parentThatIsA(IDE_Morph);if(ide){ide.flushBlocksCache("variables");ide.refreshPalette()}}};SpriteMorph.prototype.toggleInheritedVariable=function(vName){if(contains(this.inheritedVariableNames(true),vName)){this.deleteVariable(vName)}else if(contains(this.inheritedVariableNames(),vName)){this.shadowVar(vName,this.variables.getVar(vName))}};SpriteMorph.prototype.inheritedVariableNames=function(shadowedOnly){var names=[],own=this.variables.names(),current=this.variables.parentFrame;function test(each){return shadowedOnly?contains(own,each):!contains(own,each)}while(current.owner instanceof SpriteMorph){names.push.apply(names,current.names().filter(test));current=current.parentFrame}return names};SpriteMorph.prototype.deletableVariableNames=function(){var locals=this.variables.names(),inherited=this.inheritedVariableNames();return locals.concat(this.globalVariables().names().filter(each=>!contains(locals,each)&&!contains(inherited,each)))};SpriteMorph.prototype.hasSpriteVariable=function(varName){return contains(this.variables.names(),varName)};SpriteMorph.prototype.allLocalVariableNames=function(sorted,all){var exceptGlobals=this.globalVariables(),globalNames=exceptGlobals.names(all),data;function alphabetically(x,y){return x.toLowerCase()<y.toLowerCase()?-1:1}data=this.variables.allNames(exceptGlobals,all).filter(each=>!contains(globalNames,each));if(sorted){data.sort(alphabetically)}return data};SpriteMorph.prototype.reachableGlobalVariableNames=function(sorted,all){var locals=this.allLocalVariableNames(null,all),data;function alphabetically(x,y){return x.toLowerCase()<y.toLowerCase()?-1:1}data=this.globalVariables().names(all).filter(each=>!contains(locals,each));if(sorted){data.sort(alphabetically)}return data};SpriteMorph.prototype.getMethod=function(spec){return this.allBlocks()[spec]};SpriteMorph.prototype.getLocalMethod=function(spec){return this.ownBlocks()[spec]};SpriteMorph.prototype.ownBlocks=function(){var dict={};this.customBlocks.forEach(def=>dict[def.blockSpec()]=def);return dict};SpriteMorph.prototype.allBlocks=function(valuesOnly){var dict={};this.allExemplars().reverse().forEach(sprite=>sprite.customBlocks.forEach(def=>dict[def.blockSpec()]=def));if(valuesOnly){return Object.keys(dict).map(key=>dict[key])}return dict};SpriteMorph.prototype.inheritedBlocks=function(valuesOnly){var dict={},own=Object.keys(this.ownBlocks()),others=this.allExemplars().reverse();others.pop();others.forEach(sprite=>sprite.customBlocks.forEach(def=>{var spec=def.blockSpec();if(!contains(own,spec)){dict[spec]=def}}));if(valuesOnly){return Object.keys(dict).map(key=>dict[key])}return dict};SpriteMorph.prototype.shadowAllMethods=function(){var ide;this.inheritedMethods().forEach(dup=>this.customBlocks.push(dup));if(!this.isTemporary){ide=this.parentThatIsA(IDE_Morph);if(ide){ide.flushPaletteCache();ide.refreshPalette()}}};SpriteMorph.prototype.inheritedMethods=function(){return this.inheritedBlocks(true).map(def=>def.copyAndBindTo(this,true))};SpriteMorph.prototype.thumbnail=function(extentPoint,recycleMe,noCorpse){var src=this.getImage(),w=this.width(),h=this.height(),scale=Math.min(extentPoint.x/w,extentPoint.y/h),xOffset=(extentPoint.x-w*scale)/2,yOffset=(extentPoint.y-h*scale)/2,trg=newCanvas(extentPoint,false,recycleMe),ctx=trg.getContext("2d");function xOut(style,alpha,width){var inset=Math.min(extentPoint.x,extentPoint.y)/10;ctx.strokeStyle=style;ctx.globalAlpha=alpha;ctx.compositeOperation="lighter";ctx.lineWidth=width||1;ctx.moveTo(inset,inset);ctx.lineTo(trg.width-inset,trg.height-inset);ctx.moveTo(inset,trg.height-inset);ctx.lineTo(trg.width-inset,inset);ctx.stroke()}ctx.save();if(this.isCorpse&&!noCorpse){ctx.globalAlpha=.3}if(w&&h&&src.width&&src.height){ctx.scale(scale,scale);ctx.drawImage(src,Math.floor(xOffset/scale),Math.floor(yOffset/scale))}if(this.isCorpse&&!noCorpse){ctx.restore();xOut("white",.8,6);xOut("black",.8,1)}ctx.restore();return trg};SpriteMorph.prototype.fullThumbnail=function(extentPoint,recycleMe){var thumb=this.thumbnail(extentPoint,recycleMe),ctx=thumb.getContext("2d"),ext=extentPoint.divideBy(3),i=0;ctx.restore();if(this.anchor){ctx.drawImage(this.anchor.thumbnail(ext),0,0)}for(i=0;i<3;i+=1){if(this.parts[i]){ctx.drawImage(this.parts[i].thumbnail(ext),i*ext.x,extentPoint.y-ext.y)}}return thumb};SpriteMorph.prototype.booleanMorph=function(bool){var sym=new BooleanSlotMorph(bool);sym.isStatic=true;sym.fixLayout();return sym};SpriteMorph.prototype.attachTo=function(aSprite){aSprite.attachPart(this)};SpriteMorph.prototype.attachPart=function(aSprite){var v=Date.now();if(aSprite.anchor){aSprite.anchor.detachPart(aSprite)}this.parts.push(aSprite);this.version=v;aSprite.anchor=this;this.allParts().forEach(part=>part.nestingScale=part.scale);aSprite.version=v};SpriteMorph.prototype.detachPart=function(aSprite){var idx=this.parts.indexOf(aSprite),v;if(idx!==-1){v=Date.now();this.parts.splice(idx,1);this.version=v;aSprite.anchor=null;aSprite.version=v}};SpriteMorph.prototype.detachAllParts=function(){var v=Date.now();this.parts.forEach(part=>{part.anchor=null;part.version=v});this.parts=[];this.version=v};SpriteMorph.prototype.detachFromAnchor=function(){if(this.anchor){this.anchor.detachPart(this)}};SpriteMorph.prototype.allParts=function(){var result=[this];this.parts.forEach(part=>result=result.concat(part.allParts()));return result};SpriteMorph.prototype.allAnchors=function(){var result=[this];if(this.anchor!==null){result=result.concat(this.anchor.allAnchors())}return result};SpriteMorph.prototype.recordLayers=function(){var stage=this.parentThatIsA(StageMorph);if(!stage){this.layerCache=null;return}this.layers=this.allParts();this.layers.forEach(part=>{var bubble=part.talkBubble();if(bubble){bubble.hide()}});this.layers.sort((x,y)=>stage.children.indexOf(x)<stage.children.indexOf(y)?-1:1)};SpriteMorph.prototype.restoreLayers=function(){if(this.layers&&this.layers.length>1){this.layers.forEach(sprite=>{sprite.comeToFront();sprite.positionTalkBubble()})}this.layers=null};SpriteMorph.prototype.destroy=function(){if(this.anchor){this.anchor.detachPart(this)}this.emancipate();if(!this.isTemporary){this.prune()}SpriteMorph.uber.destroy.call(this)};SpriteMorph.prototype.flash=function(){var world=this.world();this.addHighlight();world.animations.push(new Animation(nop,nop,0,800,nop,()=>this.removeHighlight()))};SpriteMorph.prototype.addHighlight=function(oldHighlight){var isHidden=!this.isVisible,highlight;if(isHidden){this.show()}highlight=this.highlight(oldHighlight?oldHighlight.color:this.highlightColor,this.highlightBorder);this.addBack(highlight);this.fullChanged();if(isHidden){this.hide()}return highlight};SpriteMorph.prototype.removeHighlight=function(){var highlight=this.getHighlight();if(highlight!==null){this.fullChanged();this.removeChild(highlight)}return highlight};SpriteMorph.prototype.toggleHighlight=function(){if(this.getHighlight()){this.removeHighlight()}else{this.addHighlight()}};SpriteMorph.prototype.highlight=function(color,border){var highlight=new SpriteHighlightMorph,fb=this.bounds,edge=border,ctx;highlight.bounds.setExtent(fb.extent().add(edge*2));highlight.color=color;highlight.cachedImage=this.highlightImage(color,border);ctx=highlight.cachedImage.getContext("2d");ctx.drawImage(this.highlightImage(WHITE,4),border-4,border-4);ctx.drawImage(this.highlightImage(new Color(50,50,50),2),border-2,border-2);ctx.drawImage(this.highlightImage(WHITE,1),border-1,border-1);highlight.setPosition(fb.origin.subtract(new Point(edge,edge)));return highlight};SpriteMorph.prototype.highlightImage=function(color,border){var fb,img,hi,ctx,out;fb=this.extent();img=this.getImage();hi=newCanvas(fb.add(border*2));ctx=hi.getContext("2d");ctx.drawImage(img,0,0);ctx.drawImage(img,border,0);ctx.drawImage(img,border*2,0);ctx.drawImage(img,border*2,border);ctx.drawImage(img,border*2,border*2);ctx.drawImage(img,border,border*2);ctx.drawImage(img,0,border*2);ctx.drawImage(img,0,border);ctx.globalCompositeOperation="destination-out";ctx.drawImage(img,border,border);out=newCanvas(fb.add(border*2));ctx=out.getContext("2d");ctx.drawImage(hi,0,0);ctx.globalCompositeOperation="source-atop";ctx.fillStyle=color.toString();ctx.fillRect(0,0,out.width,out.height);return out};SpriteMorph.prototype.getHighlight=function(){var highlights=this.children.slice(0).reverse().filter(child=>child instanceof SpriteHighlightMorph);if(highlights.length!==0){return highlights[0]}return null};SpriteMorph.prototype.mouseEnterDragging=function(){var obj;if(!this.enableNesting){return}obj=this.world().hand.children[0];if(this.wantsDropOf(obj)){this.addHighlight()}};SpriteMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed");if(!this.enableNesting){return}this.removeHighlight()};SpriteMorph.prototype.wantsDropOf=function(morph){return this.enableNesting&&morph instanceof SpriteIconMorph&&!contains(morph.object.allParts(),this)};SpriteMorph.prototype.reactToDropOf=function(morph,hand){this.removeHighlight();this.attachPart(morph.object);this.world().add(morph);morph.slideBackTo(hand.grabOrigin)};SpriteMorph.prototype.newCostumeName=function(name,ignoredCostume){var ix=name.indexOf("("),stem=ix<0?name:name.substring(0,ix),count=1,newName=stem,all=this.costumes.asArray().filter(each=>each!==ignoredCostume).map(each=>each.name);while(contains(all,newName)){count+=1;newName=stem+"("+count+")"}return newName};SpriteMorph.prototype.doScreenshot=function(imgSource,data){var canvas,stage=this.parentThatIsA(StageMorph),costume;data=this.newCostumeName(data);if(imgSource[0]===undefined){return}if(imgSource[0]==="pen trails"){canvas=stage.trailsCanvas;costume=new Costume(canvas,data).copy()}else if(imgSource[0]==="stage image"){canvas=stage.fullImage();costume=new Costume(canvas,data)}this.addCostume(costume)};SpriteMorph.prototype.newSoundName=function(name,ignoredSound){var ix=name.indexOf("("),stem=ix<0?name:name.substring(0,ix),count=1,newName=stem,all=this.sounds.asArray().filter(each=>each!==ignoredSound).map(each=>each.name);while(contains(all,newName)){count+=1;newName=stem+"("+count+")"}return newName};SpriteHighlightMorph.prototype=new Morph;SpriteHighlightMorph.prototype.constructor=SpriteHighlightMorph;SpriteHighlightMorph.uber=Morph.prototype;function SpriteHighlightMorph(){this.init()}SpriteHighlightMorph.prototype.init=function(){SpriteHighlightMorph.uber.init.call(this);this.isCachingImage=true};StageMorph.prototype=new FrameMorph;StageMorph.prototype.constructor=StageMorph;StageMorph.uber=FrameMorph.prototype;StageMorph.prototype.dimensions=new Point(480,360);StageMorph.prototype.isCachingPrimitives=SpriteMorph.prototype.isCachingPrimitives;StageMorph.prototype.sliderColor=SpriteMorph.prototype.sliderColor;StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor;StageMorph.prototype.hiddenPrimitives={};StageMorph.prototype.codeMappings={};StageMorph.prototype.codeHeaders={};StageMorph.prototype.enableCodeMapping=true;StageMorph.prototype.enableInheritance=true;StageMorph.prototype.enableSublistIDs=false;StageMorph.prototype.enablePenLogging=false;function StageMorph(globals){this.init(globals)}StageMorph.prototype.init=function(globals){this.name=localize("Stage");this.dimensions=new Point(480,360);this.instrument=null;this.threads=new ThreadManager;this.variables=new VariableFrame(globals||null,this);this.scripts=new ScriptsMorph;this.customBlocks=[];this.globalBlocks=[];this.costumes=new List;this.costumes.type="costume";this.costume=null;this.sounds=new List;this.sounds.type="sound";this.version=Date.now();this.isFastTracked=false;this.enableCustomHatBlocks=true;this.cloneCount=0;this.timerStart=Date.now();this.tempo=60;this.lastMessage="";this.volume=100;this.gainNode=null;this.pan=0;this.pannerNode=null;this.freqPlayer=null;this.watcherUpdateFrequency=2;this.lastWatcherUpdate=Date.now();this.scale=1;this.cachedColorDimensions=[0,0,0];this.keysPressed={};this.primitivesCache={};this.paletteCache={};this.categoriesCache=null;this.lastAnswer="";this.activeSounds=[];this.trailsCanvas=null;this.trailsLog=[];this.isThreadSafe=false;this.microphone=new Microphone;this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0};this.cachedPenTrailsMorph=null;this.remixID=null;this.projectionSource=null;this.getProjectionImage=null;this.stopProjectionSource=null;this.continuousProjection=false;this.projectionCanvas=null;this.projectionTransparency=50;this.mirrorVideo=true;this.videoMotion=null;this.worldMap=new WorldMap;this.messageCallbacks={};StageMorph.uber.init.call(this);this.setExtent(this.dimensions);this.isCachingImage=true;this.cachedColorDimensions=this.color[SpriteMorph.prototype.penColorModel]();this.acceptsDrops=false;this.setColor(new Color(255,255,255))};StageMorph.prototype.setScale=function(number){var delta=number/this.scale,pos=this.position(),relativePos,bubble;if(delta===1){return}this.cachedPenTrailsMorph=null;this.scale=number;this.setExtent(this.dimensions.multiplyBy(number));this.children.forEach(morph=>{relativePos=morph.position().subtract(pos);morph.fixLayout();morph.setPosition(relativePos.multiplyBy(delta).add(pos),true);if(morph instanceof SpriteMorph){morph.rerender();bubble=morph.talkBubble();if(bubble){bubble.setScale(number);morph.positionTalkBubble()}}else if(morph instanceof StagePrompterMorph){if(this.scale<1){morph.setWidth(this.width()-10)}else{morph.setWidth(this.dimensions.x-20)}morph.setCenter(this.center());morph.setBottom(this.bottom())}else if(morph instanceof StagePickerMorph){morph.createItems(number);morph.popup(this,morph.position())}})};StageMorph.prototype.moveBy=function(delta){var children=this.children,i=children.length;this.changed();this.bounds=this.bounds.translateBy(delta);this.changed();for(i;i>0;i-=1){children[i-1].moveBy(delta,true)}};StageMorph.prototype.render=function(ctx){ctx.save();ctx.fillStyle=this.color.toString();ctx.fillRect(0,0,this.width(),this.height());if(this.costume&&!(this.costume.loaded instanceof Function)){ctx.scale(this.scale,this.scale);ctx.drawImage(this.costume.contents,(this.width()/this.scale-this.costume.width())/2,(this.height()/this.scale-this.costume.height())/2);this.cachedImage=this.applyGraphicsEffects(this.cachedImage)}ctx.restore();this.version=Date.now()};StageMorph.prototype.drawOn=function(ctx,rect){var clipped=rect.intersect(this.bounds),pos,src,w,h,sl,st,ws,hs;if(!this.isVisible||!clipped.extent().gt(ZERO)){return}StageMorph.uber.drawOn.call(this,ctx,rect);pos=this.position();src=clipped.translateBy(pos.neg());sl=src.left();st=src.top();w=src.width();h=src.height();ws=w/this.scale;hs=h/this.scale;ctx.save();ctx.scale(this.scale,this.scale);if(this.projectionSource){ctx.globalAlpha=1-this.projectionTransparency/100;ctx.drawImage(this.projectionLayer(),sl/this.scale,st/this.scale,ws,hs,clipped.left()/this.scale,clipped.top()/this.scale,ws,hs);this.version=Date.now()}ctx.globalAlpha=1;ctx.drawImage(this.penTrails(),sl/this.scale,st/this.scale,ws,hs,clipped.left()/this.scale,clipped.top()/this.scale,ws,hs);ctx.restore()};StageMorph.prototype.clearPenTrails=function(){this.cachedPenTrailsMorph=null;this.trailsCanvas=newCanvas(this.dimensions,null,this.trailsCanvas);this.trailsLog=[];this.changed()};StageMorph.prototype.penTrails=function(){if(!this.trailsCanvas){this.trailsCanvas=newCanvas(this.dimensions)}return this.trailsCanvas};StageMorph.prototype.penTrailsMorph=function(){var morph,trails,ctx;if(this.cachedPenTrailsMorph){return this.cachedPenTrailsMorph}morph=new Morph;morph.isCachingImage=true;trails=this.penTrails();morph.bounds=this.bounds.copy();morph.cachedImage=newCanvas(this.extent(),true);ctx=morph.cachedImage.getContext("2d");ctx.drawImage(trails,0,0,trails.width,trails.height,0,0,this.width(),this.height());this.cachedPenTrailsMorph=morph;return morph};StageMorph.prototype.projectionLayer=function(){if(!this.projectionCanvas){this.projectionCanvas=newCanvas(this.dimensions,true)}return this.projectionCanvas};StageMorph.prototype.clearProjectionLayer=function(){this.projectionCanvas=null;this.changed()};StageMorph.prototype.startVideo=function(){var myself=this;function noCameraSupport(){var dialog=new DialogBoxMorph;dialog.inform(localize("Camera not supported"),localize("Please make sure your web browser is up to date\n"+"and your camera is properly configured. \n\n"+"Some browsers also require you to access Snap!\n"+"through HTTPS to use the camera.\n\n"+'Please replace the "http://" part of the address\n'+'in your browser by "https://" and try again.'),this.world);dialog.fixLayout();if(myself.projectionSource){myself.projectionSource.remove();myself.projectionSource=null}}if(this.projectionSource){return}this.projectionSource=document.createElement("video");this.projectionSource.width=this.dimensions.x;this.projectionSource.height=this.dimensions.y;this.projectionSource.hidden=true;document.body.appendChild(this.projectionSource);if(!this.videoMotion){this.videoMotion=new VideoMotion(this.dimensions.x,this.dimensions.y)}if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){navigator.mediaDevices.getUserMedia({video:true}).then(function(stream){myself.getProjectionImage=myself.getVideoImage;myself.stopProjectionSource=myself.stopVideo;myself.continuousProjection=true;myself.projectionSource.srcObject=stream;myself.projectionSource.play().catch(noCameraSupport);myself.projectionSource.stream=stream}).catch(noCameraSupport)}};StageMorph.prototype.getVideoImage=function(){return this.projectionSource};StageMorph.prototype.stopVideo=function(){if(this.projectionSource&&this.projectionSource.stream){this.projectionSource.stream.getTracks().forEach(track=>track.stop())}this.videoMotion=null};StageMorph.prototype.stopProjection=function(){if(this.projectionSource){this.stopProjectionSource();this.projectionSource.remove();this.projectionSource=null;this.continuousProjection=false}this.clearProjectionLayer()};StageMorph.prototype.projectionSnap=function(){var snap=newCanvas(this.dimensions,true),ctx=snap.getContext("2d");ctx.drawImage(this.projectionLayer(),0,0);return new Costume(snap,this.newCostumeName(localize("snap")))};StageMorph.prototype.getPixelColor=function(aPoint){var point,context,data;if(this.trailsCanvas){point=aPoint.subtract(this.bounds.origin);context=this.penTrailsMorph().getImage().getContext("2d");data=context.getImageData(point.x,point.y,1,1);if(data.data[3]===0){if(this.projectionCanvas){point=point.divideBy(this.scale);context=this.projectionCanvas.getContext("2d");data=context.getImageData(point.x,point.y,1,1);return new Color(data.data[0],data.data[1],data.data[2],data.data[3]/255)}return StageMorph.uber.getPixelColor.call(this,aPoint)}return new Color(data.data[0],data.data[1],data.data[2],data.data[3]/255)}};StageMorph.prototype.watchers=function(leftPos){return this.children.filter(morph=>{if(morph instanceof WatcherMorph){if(leftPos){return morph.left()===leftPos}return morph.isVisible}return false})};StageMorph.prototype.resetTimer=function(){this.timerStart=Date.now()};StageMorph.prototype.getTimer=function(){var elapsed=Math.floor((Date.now()-this.timerStart)/100);return elapsed/10};StageMorph.prototype.setTempo=function(bpm){this.tempo=Math.max(20,+bpm||0)};StageMorph.prototype.changeTempo=function(delta){this.setTempo(this.getTempo()+(+delta||0))};StageMorph.prototype.getTempo=function(){return+this.tempo};StageMorph.prototype.getLastMessage=function(){return this.lastMessage||""};StageMorph.prototype.reportMouseX=function(){var world=this.world();if(world){return(world.hand.position().x-this.center().x)/this.scale}return 0};StageMorph.prototype.reportMouseY=function(){var world=this.world();if(world){return(this.center().y-world.hand.position().y)/this.scale}return 0};StageMorph.prototype.wantsDropOf=function(aMorph){return aMorph instanceof SpriteMorph||aMorph instanceof WatcherMorph||aMorph instanceof ListWatcherMorph||aMorph instanceof SpriteIconMorph};StageMorph.prototype.reactToDropOf=function(morph,hand){if(morph instanceof SpriteIconMorph){if(morph.object.anchor){morph.object.anchor.detachPart(morph.object)}this.world().add(morph);morph.slideBackTo(hand.grabOrigin)}};StageMorph.prototype.step=function(){var current,elapsed,leftover,ide,world=this.world();if(world.keyboardFocus===null){world.keyboardFocus=this}if(world.currentKey===null){this.keyPressed=null}if(this.enableCustomHatBlocks){this.stepGenericConditions()}if(this.isFastTracked&&this.threads.processes.length){while(this.isFastTracked&&Date.now()-this.lastTime<15){this.threads.step()}this.changed()}else{this.threads.step();if(this.threads.wantsToPause){ide=this.parentThatIsA(IDE_Morph);if(ide){ide.controlBar.pauseButton.refresh()}}}current=Date.now();elapsed=current-this.lastWatcherUpdate;leftover=1e3/this.watcherUpdateFrequency-elapsed;if(leftover<1){this.watchers().forEach(w=>w.update());this.lastWatcherUpdate=Date.now()}if(this.continuousProjection&&this.projectionSource){this.updateProjection()}};StageMorph.prototype.updateProjection=function(){var context=this.projectionLayer().getContext("2d");context.save();if(this.mirrorVideo){context.translate(this.dimensions.x,0);context.scale(-1,1)}context.drawImage(this.getProjectionImage(),0,0,this.projectionSource.width,this.projectionSource.height);if(this.videoMotion){this.videoMotion.addFrame(context.getImageData(0,0,this.projectionSource.width,this.projectionSource.height).data)}context.restore();this.changed()};StageMorph.prototype.stepGenericConditions=function(stopAll){var hatCount=0,ide;this.children.concat(this).forEach(morph=>{if(isSnapObject(morph)){morph.allGenericHatBlocks().forEach(block=>{hatCount+=1;this.threads.doWhen(block,morph,stopAll)})}});if(!hatCount){this.enableCustomHatBlocks=false;ide=this.parentThatIsA(IDE_Morph);if(ide){ide.controlBar.stopButton.refresh()}}};StageMorph.prototype.developersMenu=function(){var menu=StageMorph.uber.developersMenu.call(this);menu.addItem("stop",()=>this.threads.stopAll(),"terminate all running threads");return menu};StageMorph.prototype.processKeyDown=function(event){this.processKeyEvent(event,this.fireKeyEvent)};StageMorph.prototype.processKeyUp=function(event){this.processKeyEvent(event,this.removePressedKey)};StageMorph.prototype.processKeyEvent=function(event,action){var keyName;switch(event.keyCode){case 13:keyName="enter";if(event.ctrlKey||event.metaKey){keyName="ctrl enter"}else if(event.shiftKey){keyName="shift enter"}break;case 27:keyName="esc";break;case 32:keyName="space";break;case 37:keyName="left arrow";break;case 39:keyName="right arrow";break;case 38:keyName="up arrow";break;case 40:keyName="down arrow";break;default:keyName=event.key||String.fromCharCode(event.keyCode||event.charCode);if(event.ctrlKey||event.metaKey){keyName=(keyName==="Control"||keyName==="Meta"?"":"ctrl ")+(event.shiftKey?"shift ":"")+keyName}}action.call(this,keyName)};StageMorph.prototype.fireKeyEvent=function(key){var evt=key.toLowerCase(),procs=[],ide=this.parentThatIsA(IDE_Morph);this.keysPressed[evt]=true;if(evt==="ctrl enter"&&!ide.isAppMode){return this.fireGreenFlagEvent()}if(evt==="shift enter"){return this.editScripts()}if(evt==="ctrl f"){if(!ide.isAppMode){ide.currentSprite.searchBlocks()}return}if(evt==="ctrl z"){if(!ide.isAppMode){ide.currentSprite.scripts.undrop()}return}if(evt==="ctrl shift z"||evt==="ctrl y"){if(!ide.isAppMode){ide.currentSprite.scripts.redrop()}return}if(evt==="ctrl n"){if(!ide.isAppMode){ide.createNewProject()}return}if(evt==="ctrl o"){if(!ide.isAppMode){ide.openProjectsBrowser()}return}if(evt==="ctrl s"){if(!ide.isAppMode){ide.save()}return}if(evt==="ctrl shift s"){if(!ide.isAppMode){return ide.saveProjectsBrowser()}return}if(evt==="esc"&&!ide.isAppMode){return ide.stopAllScripts()}this.children.concat(this).forEach(morph=>{if(isSnapObject(morph)){morph.allHatBlocksForKey(evt).forEach(block=>{var varName=block.inputs()[1].evaluate()[0],varFrame;if(varName){varFrame=new VariableFrame;varFrame.addVar(varName,key==="space"?" ":key)}procs.push(this.threads.startProcess(block,morph,true,null,null,null,null,null,varFrame))})}});return procs};StageMorph.prototype.removePressedKey=function(key){delete this.keysPressed[key.toLowerCase()]};StageMorph.prototype.processKeyPress=function(event){nop(event)};StageMorph.prototype.inspectKeyEvent=CursorMorph.prototype.inspectKeyEvent;StageMorph.prototype.fireChangeOfSceneEvent=function(message,data){var procs=[];if(message==="__shout__go__"){this.removeAllClones()}this.children.concat(this).forEach(morph=>{if(isSnapObject(morph)){morph.allHatBlocksFor(message).forEach(block=>{var choice,varName,varFrame;if(block.selector==="receiveMessage"){varName=block.inputs()[1].evaluate()[0];if(varName){varFrame=new VariableFrame;choice=block.inputs()[0].evaluate();if(choice instanceof Array&&choice[0].indexOf("any")===0){varFrame.addVar(varName,data!==""?new List([message,data]):message)}else{varFrame.addVar(varName,data)}}procs.push(this.threads.startProcess(block,morph,this.isThreadSafe||block.inputs()[0].evaluate()instanceof Array,null,null,null,null,null,varFrame))}else{procs.push(this.threads.startProcess(block,morph,this.isThreadSafe))}})}});return procs};StageMorph.prototype.fireGreenFlagEvent=function(){var procs=[],ide=this.parentThatIsA(IDE_Morph);this.removeAllClones();this.children.concat(this).forEach(morph=>{if(isSnapObject(morph)){morph.allHatBlocksFor("__shout__go__").forEach(block=>{var varName,varFrame;if(block.selector==="receiveMessage"){varName=block.inputs()[1].evaluate()[0];if(varName){varFrame=new VariableFrame;varFrame.addVar(varName,"")}}procs.push(this.threads.startProcess(block,morph,this.isThreadSafe,null,null,null,null,null,varFrame))})}});if(ide){ide.controlBar.pauseButton.refresh()}return procs};StageMorph.prototype.runStopScripts=function(){this.receiveUserInteraction("stopped",true,true);this.children.forEach(morph=>{if(morph instanceof SpriteMorph){morph.receiveUserInteraction("stopped",true,true)}})};StageMorph.prototype.removeAllClones=function(){var clones=this.children.filter(morph=>morph instanceof SpriteMorph&&morph.isTemporary);clones.forEach(clone=>{this.threads.stopAllForReceiver(clone);clone.detachFromAnchor();clone.corpsify();clone.destroy()});this.cloneCount=0};StageMorph.prototype.editScripts=function(){var ide=this.parentThatIsA(IDE_Morph),scripts,sorted;if(ide.isAppMode||!ScriptsMorph.prototype.enableKeyboard){return}scripts=this.parentThatIsA(IDE_Morph).currentSprite.scripts.selectForEdit();scripts.edit(scripts.position());sorted=scripts.focus.sortedScripts();if(sorted.length){scripts.focus.element=sorted[0];if(scripts.focus.element instanceof HatBlockMorph){scripts.focus.nextCommand()}}else{scripts.focus.moveBy(new Point(50,50))}scripts.focus.fixLayout()};StageMorph.prototype.pauseGenericHatBlocks=function(){var ide=this.parentThatIsA(IDE_Morph);if(this.hasGenericHatBlocks()||ide.sprites.asArray().some(any=>any.hasGenericHatBlocks())){this.enableCustomHatBlocks=true;this.threads.pauseCustomHatBlocks=true;ide.controlBar.stopButton.refresh()}};StageMorph.prototype.blockTemplates=function(category="motion",all=false){var blocks=[],myself=this,varNames,txt;function block(selector){if(myself.hiddenPrimitives[selector]&&!all){return null}var newBlock=SpriteMorph.prototype.blockForSelector(selector,true);newBlock.isTemplate=true;return newBlock}function variableBlock(varName,isLocal){var newBlock=SpriteMorph.prototype.variableBlock(varName,isLocal);newBlock.isDraggable=false;newBlock.isTemplate=true;return newBlock}function watcherToggle(selector){if(myself.hiddenPrimitives[selector]){return null}var info=SpriteMorph.prototype.blocks[selector];return new ToggleMorph("checkbox",this,function(){myself.toggleWatcher(selector,localize(info.spec),myself.blockColor[info.category])},null,function(){return myself.showingWatcher(selector)},null)}function variableWatcherToggle(varName){return new ToggleMorph("checkbox",this,function(){myself.toggleVariableWatcher(varName)},null,function(){return myself.showingVariableWatcher(varName)},null)}if(category==="motion"){txt=new TextMorph(localize("Stage selected:\nno motion primitives"));txt.fontSize=9;txt.setColor(this.paletteTextColor);blocks.push(txt)}else if(category==="looks"){blocks.push(block("doSwitchToCostume"));blocks.push(block("doWearNextCostume"));blocks.push(watcherToggle("getCostumeIdx"));blocks.push(block("getCostumeIdx"));blocks.push("-");blocks.push(block("reportGetImageAttribute"));blocks.push(block("reportNewCostumeStretched"));blocks.push(block("reportNewCostume"));blocks.push("-");blocks.push(block("changeEffect"));blocks.push(block("setEffect"));blocks.push(block("clearEffects"));blocks.push(block("getEffect"));blocks.push("-");blocks.push(block("show"));blocks.push(block("hide"));blocks.push(watcherToggle("reportShown"));blocks.push(block("reportShown"));if(this.world().isDevMode){blocks.push("-");blocks.push(this.devModeText());blocks.push("-");blocks.push(block("log"));blocks.push(block("alert"));blocks.push("-");blocks.push(block("doScreenshot"))}}else if(category==="sound"){blocks.push(block("playSound"));blocks.push(block("doPlaySoundUntilDone"));blocks.push(block("doStopAllSounds"));blocks.push("-");blocks.push(block("doPlaySoundAtRate"));blocks.push(block("reportGetSoundAttribute"));blocks.push(block("reportNewSoundFromSamples"));blocks.push("-");blocks.push(block("doRest"));blocks.push(block("doPlayNote"));blocks.push(block("doSetInstrument"));blocks.push("-");blocks.push(block("doChangeTempo"));blocks.push(block("doSetTempo"));blocks.push(watcherToggle("getTempo"));blocks.push(block("getTempo"));blocks.push("-");blocks.push(block("changeVolume"));blocks.push(block("setVolume"));blocks.push(watcherToggle("getVolume"));blocks.push(block("getVolume"));blocks.push("-");blocks.push(block("changePan"));blocks.push(block("setPan"));blocks.push(watcherToggle("getPan"));blocks.push(block("getPan"));blocks.push("-");blocks.push(block("playFreq"));blocks.push(block("stopFreq"));if(this.world().isDevMode){blocks.push("-");blocks.push(this.devModeText());blocks.push("-");blocks.push(block("doPlayFrequency"))}}else if(category==="pen"){blocks.push(block("clear"));blocks.push("-");blocks.push(block("setBackgroundColor"));blocks.push(block("changeBackgroundColorDimension"));blocks.push(block("setBackgroundColorDimension"));blocks.push("-");blocks.push(block("reportPenTrailsAsCostume"));blocks.push("-");blocks.push(block("doPasteOn"));blocks.push(block("doCutFrom"))}else if(category==="control"){blocks.push(block("receiveGo"));blocks.push(block("receiveKey"));blocks.push(block("receiveInteraction"));blocks.push(block("receiveCondition"));blocks.push("-");blocks.push(block("receiveMessage"));blocks.push(block("doBroadcast"));blocks.push(block("doBroadcastAndWait"));blocks.push("-");blocks.push(block("doWarp"));blocks.push("-");blocks.push(block("doWait"));blocks.push(block("doWaitUntil"));blocks.push("-");blocks.push(block("doForever"));blocks.push(block("doRepeat"));blocks.push(block("doUntil"));blocks.push(block("doFor"));blocks.push("-");blocks.push(block("doIf"));blocks.push(block("doIfElse"));blocks.push(block("reportIfElse"));blocks.push("-");blocks.push(block("doReport"));blocks.push(block("doStopThis"));blocks.push("-");blocks.push(block("doRun"));blocks.push(block("fork"));blocks.push(block("evaluate"));blocks.push("-");blocks.push(block("doTellTo"));blocks.push(block("reportAskFor"));blocks.push("-");blocks.push(block("doCallCC"));blocks.push(block("reportCallCC"));blocks.push("-");blocks.push(block("createClone"));blocks.push(block("newClone"));blocks.push("-");blocks.push(block("doPauseAll"));blocks.push(block("doSwitchToScene"));blocks.push("-");blocks.push(block("doDefineBlock"));blocks.push(block("doDeleteBlock"));blocks.push(block("doSetBlockAttribute"));blocks.push(block("reportBlockAttribute"));blocks.push(block("reportThisContext"));if(this.world().isDevMode){blocks.push("-");blocks.push(this.devModeText());blocks.push("-");blocks.push(watcherToggle("getLastMessage"));blocks.push(block("getLastMessage"))}}else if(category==="sensing"){blocks.push(block("doAsk"));blocks.push(watcherToggle("getLastAnswer"));blocks.push(block("getLastAnswer"));blocks.push("-");blocks.push(block("reportMousePosition"));blocks.push(watcherToggle("reportMouseX"));blocks.push(block("reportMouseX"));blocks.push(watcherToggle("reportMouseY"));blocks.push(block("reportMouseY"));blocks.push(block("reportMouseDown"));blocks.push("-");blocks.push(block("reportKeyPressed"));blocks.push("-");blocks.push(block("reportAspect"));blocks.push("-");blocks.push(block("doResetTimer"));blocks.push(watcherToggle("getTimer"));blocks.push(block("getTimer"));blocks.push(block("reportDate"));blocks.push("-");blocks.push(block("reportAttributeOf"));if(SpriteMorph.prototype.enableFirstClass){blocks.push(block("reportGet"))}blocks.push(block("reportObject"));blocks.push("-");blocks.push(block("reportURL"));blocks.push(block("reportAudio"));blocks.push(block("reportVideo"));blocks.push(block("doSetVideoTransparency"));blocks.push("-");blocks.push(block("reportGlobalFlag"));blocks.push(block("doSetGlobalFlag"));if(this.world().isDevMode){blocks.push("-");blocks.push(this.devModeText());blocks.push("-");blocks.push(watcherToggle("reportThreadCount"));blocks.push(block("reportThreadCount"));blocks.push(block("reportStackSize"));blocks.push(block("reportFrameCount"));blocks.push(block("reportYieldCount"))}}if(category==="operators"){blocks.push(block("reifyScript"));blocks.push(block("reifyReporter"));blocks.push(block("reifyPredicate"));blocks.push("#");blocks.push("-");blocks.push(block("reportVariadicSum"));blocks.push(block("reportDifference"));blocks.push(block("reportVariadicProduct"));blocks.push(block("reportQuotient"));blocks.push(block("reportPower"));blocks.push("-");blocks.push(block("reportModulus"));blocks.push(block("reportRound"));blocks.push(block("reportMonadic"));blocks.push(block("reportRandom"));blocks.push("-");blocks.push(block("reportLessThan"));blocks.push(block("reportEquals"));blocks.push(block("reportGreaterThan"));blocks.push("-");blocks.push(block("reportAnd"));blocks.push(block("reportOr"));blocks.push(block("reportNot"));blocks.push(block("reportBoolean"));blocks.push("-");blocks.push(block("reportJoinWords"));blocks.push(block("reportTextSplit"));blocks.push(block("reportLetter"));blocks.push(block("reportStringSize"));blocks.push("-");blocks.push(block("reportUnicode"));blocks.push(block("reportUnicodeAsLetter"));blocks.push("-");blocks.push(block("reportIsA"));blocks.push(block("reportIsIdentical"));if(Process.prototype.enableJS){blocks.push("-");blocks.push(block("reportJSFunction"));if(Process.prototype.enableCompiling){blocks.push(block("reportCompiled"))}}if(this.world().isDevMode){blocks.push("-");blocks.push(this.devModeText());blocks.push("-");blocks.push(block("reportTypeOf"));blocks.push(block("reportTextFunction"))}}if(category==="variables"){blocks.push(this.makeVariableButton());if(this.variables.allNames().length>0){blocks.push(this.deleteVariableButton())}blocks.push("-");varNames=this.reachableGlobalVariableNames(true,all);if(varNames.length>0){varNames.forEach(name=>{blocks.push(variableWatcherToggle(name));blocks.push(variableBlock(name))});blocks.push("-")}varNames=this.allLocalVariableNames(true,all);if(varNames.length>0){varNames.forEach(name=>{blocks.push(variableWatcherToggle(name));blocks.push(variableBlock(name,true))});blocks.push("-")}blocks.push(block("doSetVar"));blocks.push(block("doChangeVar"));blocks.push(block("doShowVar"));blocks.push(block("doHideVar"));blocks.push(block("doDeclareVariables"));blocks.push("=");blocks.push(block("reportNewList"));blocks.push(block("reportNumbers"));blocks.push("-");blocks.push(block("reportCONS"));blocks.push(block("reportListItem"));blocks.push(block("reportCDR"));blocks.push("-");blocks.push(block("reportListAttribute"));blocks.push(block("reportListIndex"));blocks.push(block("reportListContainsItem"));blocks.push(block("reportListIsEmpty"));blocks.push("-");blocks.push(block("reportMap"));blocks.push(block("reportKeep"));blocks.push(block("reportFindFirst"));blocks.push(block("reportCombine"));blocks.push("-");blocks.push(block("doForEach"));blocks.push("-");blocks.push(block("doAddToList"));blocks.push(block("doDeleteFromList"));blocks.push(block("doInsertInList"));blocks.push(block("doReplaceInList"));blocks.push("-");blocks.push(block("reportConcatenatedLists"));blocks.push(block("reportReshape"));blocks.push(block("reportCrossproduct"));if(SpriteMorph.prototype.showingExtensions){blocks.push("=");blocks.push(block("doApplyExtension"));blocks.push(block("reportApplyExtension"))}if(StageMorph.prototype.enableCodeMapping){blocks.push("=");blocks.push(block("doMapCodeOrHeader"));blocks.push(block("doMapValueCode"));blocks.push(block("doMapListCode"));blocks.push("-");blocks.push(block("reportMappedCode"))}if(this.world().isDevMode){blocks.push("-");blocks.push(this.devModeText());blocks.push("-");blocks.push(block("doShowTable"))}}return blocks};StageMorph.prototype.clear=function(){this.clearPenTrails()};StageMorph.prototype.userMenu=function(){var ide=this.parentThatIsA(IDE_Morph),menu=new MenuMorph(this);if(ide&&ide.isAppMode){return menu}menu.addItem("edit","edit");menu.addItem("show all","showAll");menu.addItem("pic...",()=>ide.saveCanvasAs(this.fullImage(),this.name),"save a picture\nof the stage");menu.addLine();menu.addItem("pen trails",()=>{var costume=ide.currentSprite.reportPenTrailsAsCostume().copy();ide.currentSprite.addCostume(costume);ide.currentSprite.wearCostume(costume);ide.hasChangedMedia=true;ide.spriteBar.tabBar.tabTo("costumes")},ide.currentSprite instanceof SpriteMorph?"turn all pen trails and stamps\n"+"into a new costume for the\ncurrently selected sprite":"turn all pen trails and stamps\n"+"into a new background for the stage");if(this.trailsLog.length){menu.addItem("svg...","exportTrailsLogAsSVG","export pen trails\nline segments as SVG")}return menu};StageMorph.prototype.showAll=function(){this.children.forEach(m=>{if(m instanceof SpriteMorph){if(!m.anchor){m.show();m.keepWithin(this)}}else{m.show();m.keepWithin(this);if(m.fixLayout){m.fixLayout()}}})};StageMorph.prototype.edit=SpriteMorph.prototype.edit;StageMorph.prototype.fullImage=Morph.prototype.fullImage;StageMorph.prototype.thumbnail=function(extentPoint,recycleMe,noWatchers){return this.fancyThumbnail(extentPoint,null,false,recycleMe,noWatchers)};StageMorph.prototype.fancyThumbnail=function(extentPoint,excludedSprite,nonRetina,recycleMe,noWatchers){var src=this.getImage(),scale=Math.min(extentPoint.x/src.width,extentPoint.y/src.height),trg=newCanvas(extentPoint,nonRetina,recycleMe),ctx=trg.getContext("2d"),fb,fimg;ctx.save();ctx.scale(scale,scale);ctx.drawImage(src,0,0);ctx.drawImage(this.penTrails(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale);if(this.projectionSource){ctx.save();ctx.globalAlpha=1-this.projectionTransparency/100;ctx.drawImage(this.projectionLayer(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale);ctx.restore()}this.children.forEach(morph=>{if((isSnapObject(morph)||!noWatchers)&&morph.isVisible&&morph!==excludedSprite){fb=morph.fullBounds();fimg=morph.fullImage();if(fimg.width&&fimg.height){ctx.drawImage(morph.fullImage(),fb.origin.x-this.bounds.origin.x,fb.origin.y-this.bounds.origin.y)}}});ctx.restore();return trg};StageMorph.prototype.exportTrailsLogAsSVG=function(){var ide=this.parentThatIsA(IDE_Morph);ide.saveFileAs(this.trailsLogAsSVG().src,"image/svg",ide.projectName||this.name)};StageMorph.prototype.trailsLogAsSVG=function(){var bottomLeft=this.trailsLog[0][0],topRight=bottomLeft,maxWidth=this.trailsLog[0][3],shift,box,p1,p2,svg;this.trailsLog.forEach(line=>{bottomLeft=bottomLeft.min(line[0]);bottomLeft=bottomLeft.min(line[1]);topRight=topRight.max(line[0]);topRight=topRight.max(line[1]);maxWidth=Math.max(maxWidth,line[3])});box=bottomLeft.corner(topRight).expandBy(maxWidth/2);shift=new Point(-bottomLeft.x,topRight.y).translateBy(maxWidth/2);svg='<svg xmlns="http://www.w3.org/2000/svg" '+'preserveAspectRatio="none" '+'viewBox="0 0 '+box.width()+" "+box.height()+'" '+'width="'+box.width()+'" height="'+box.height()+'" '+">";svg+="\x3c!-- Generated by Snap! - http://snap.berkeley.edu/ --\x3e";this.trailsLog.forEach(line=>{p1=this.normalizePoint(line[0]).translateBy(shift);p2=this.normalizePoint(line[1]).translateBy(shift);svg+='<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+p2.x+'" y2="'+p2.y+'" '+'style="stroke:'+line[2].toRGBstring()+";"+"stroke-opacity:"+line[2].a+";"+"stroke-width:"+line[3]+";stroke-linecap:"+line[4]+'" />'});svg+="</svg>";return{src:svg,rot:new Point(-box.origin.x,box.corner.y)}};StageMorph.prototype.normalizePoint=function(snapPoint){return new Point(snapPoint.x,-snapPoint.y)};StageMorph.prototype.hide=function(){this.isVisible=false;this.changed()};StageMorph.prototype.show=function(){this.isVisible=true;this.changed()};StageMorph.prototype.reportShown=SpriteMorph.prototype.reportShown;StageMorph.prototype.createClone=nop;StageMorph.prototype.newClone=nop;StageMorph.prototype.setColorDimension=function(idx,num){var n=+num;idx=+idx;if(idx<0||idx>3){return}if(idx===0){if(n<0||n>100){n=(n<0?100:0)+n%100}}else{n=Math.min(100,Math.max(0,n))}if(idx===3){this.color.a=1-n/100}else{this.cachedColorDimensions[idx]=n/100;this.color["set_"+SpriteMorph.prototype.penColorModel].apply(this.color,this.cachedColorDimensions)}this.rerender()};StageMorph.prototype.getColorDimension=SpriteMorph.prototype.getColorDimension;StageMorph.prototype.changeColorDimension=SpriteMorph.prototype.changeColorDimension;StageMorph.prototype.setColorRGBA=SpriteMorph.prototype.setColorRGBA;StageMorph.prototype.changeColorRGBA=SpriteMorph.prototype.changeColorRGBA;StageMorph.prototype.setColor=function(aColor){if(!this.color.eq(aColor,true)){this.color=aColor.copy();this.rerender();this.cachedColorDimensions=this.color[SpriteMorph.prototype.penColorModel]()}};StageMorph.prototype.setBackgroundColor=StageMorph.prototype.setColor;StageMorph.prototype.getPenAttribute=SpriteMorph.prototype.getPenAttribute;StageMorph.prototype.blitOn=SpriteMorph.prototype.blitOn;StageMorph.prototype.categories=SpriteMorph.prototype.categories;StageMorph.prototype.blockColor=SpriteMorph.prototype.blockColor;StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor;StageMorph.prototype.setName=SpriteMorph.prototype.setName;StageMorph.prototype.reporterize=SpriteMorph.prototype.reporterize;StageMorph.prototype.variableBlock=SpriteMorph.prototype.variableBlock;StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher;StageMorph.prototype.addVariable=SpriteMorph.prototype.addVariable;StageMorph.prototype.deleteVariable=SpriteMorph.prototype.deleteVariable;StageMorph.prototype.makeBlock=SpriteMorph.prototype.makeBlock;StageMorph.prototype.helpMenu=SpriteMorph.prototype.helpMenu;StageMorph.prototype.makeBlockButton=SpriteMorph.prototype.makeBlockButton;StageMorph.prototype.makeVariableButton=SpriteMorph.prototype.makeVariableButton;StageMorph.prototype.categoryText=SpriteMorph.prototype.categoryText;StageMorph.prototype.devModeText=SpriteMorph.prototype.devModeText;StageMorph.prototype.deleteVariableButton=SpriteMorph.prototype.deleteVariableButton;StageMorph.prototype.customBlockTemplatesForCategory=SpriteMorph.prototype.customBlockTemplatesForCategory;StageMorph.prototype.getPrimitiveTemplates=SpriteMorph.prototype.getPrimitiveTemplates;StageMorph.prototype.palette=SpriteMorph.prototype.palette;StageMorph.prototype.freshPalette=SpriteMorph.prototype.freshPalette;StageMorph.prototype.blocksMatching=SpriteMorph.prototype.blocksMatching;StageMorph.prototype.searchBlocks=SpriteMorph.prototype.searchBlocks;StageMorph.prototype.allPaletteBlocks=SpriteMorph.prototype.allPaletteBlocks;StageMorph.prototype.isHidingBlock=SpriteMorph.prototype.isHidingBlock;StageMorph.prototype.changeBlockVisibility=SpriteMorph.prototype.changeBlockVisibility;StageMorph.prototype.changePrimitiveVisibility=SpriteMorph.prototype.changePrimitiveVisibility;StageMorph.prototype.changeCustomBlockVisibility=SpriteMorph.prototype.changeCustomBlockVisibility;StageMorph.prototype.changeVarBlockVisibility=SpriteMorph.prototype.changeVarBlockVisibility;StageMorph.prototype.emptyCategories=SpriteMorph.prototype.emptyCategories;StageMorph.prototype.neighbors=SpriteMorph.prototype.neighbors;StageMorph.prototype.perimeter=SpriteMorph.prototype.perimeter;StageMorph.prototype.doScreenshot=SpriteMorph.prototype.doScreenshot;StageMorph.prototype.newCostumeName=SpriteMorph.prototype.newCostumeName;StageMorph.prototype.blockForSelector=SpriteMorph.prototype.blockForSelector;StageMorph.prototype.findVariableWatcher=SpriteMorph.prototype.findVariableWatcher;StageMorph.prototype.toggleVariableWatcher=SpriteMorph.prototype.toggleVariableWatcher;StageMorph.prototype.showingVariableWatcher=SpriteMorph.prototype.showingVariableWatcher;StageMorph.prototype.deleteVariableWatcher=SpriteMorph.prototype.deleteVariableWatcher;StageMorph.prototype.addCostume=SpriteMorph.prototype.addCostume;StageMorph.prototype.wearCostume=SpriteMorph.prototype.wearCostume;StageMorph.prototype.getCostumeIdx=SpriteMorph.prototype.getCostumeIdx;StageMorph.prototype.doWearNextCostume=SpriteMorph.prototype.doWearNextCostume;StageMorph.prototype.doWearPreviousCostume=SpriteMorph.prototype.doWearPreviousCostume;StageMorph.prototype.doSwitchToCostume=SpriteMorph.prototype.doSwitchToCostume;StageMorph.prototype.reportCostumes=SpriteMorph.prototype.reportCostumes;StageMorph.prototype.graphicsChanged=SpriteMorph.prototype.graphicsChanged;StageMorph.prototype.applyGraphicsEffects=SpriteMorph.prototype.applyGraphicsEffects;StageMorph.prototype.setEffect=SpriteMorph.prototype.setEffect;StageMorph.prototype.getEffect=SpriteMorph.prototype.getEffect;StageMorph.prototype.getGhostEffect=SpriteMorph.prototype.getGhostEffect;StageMorph.prototype.changeEffect=SpriteMorph.prototype.changeEffect;StageMorph.prototype.clearEffects=SpriteMorph.prototype.clearEffects;StageMorph.prototype.addSound=SpriteMorph.prototype.addSound;StageMorph.prototype.doPlaySound=SpriteMorph.prototype.doPlaySound;StageMorph.prototype.stopAllActiveSounds=function(){this.activeSounds.forEach(audio=>audio.pause());this.activeSounds=[];if(this.microphone.modifier&&this.microphone.isReady){this.microphone.stop()}};StageMorph.prototype.pauseAllActiveSounds=function(){this.activeSounds.forEach(audio=>audio.pause())};StageMorph.prototype.resumeAllActiveSounds=function(){this.activeSounds.forEach(audio=>audio.play())};StageMorph.prototype.reportSounds=SpriteMorph.prototype.reportSounds;StageMorph.prototype.newSoundName=SpriteMorph.prototype.newSoundName;StageMorph.prototype.setVolume=SpriteMorph.prototype.setVolume;StageMorph.prototype.changeVolume=SpriteMorph.prototype.changeVolume;StageMorph.prototype.getVolume=SpriteMorph.prototype.getVolume;StageMorph.prototype.getGainNode=SpriteMorph.prototype.getGainNode;StageMorph.prototype.audioContext=SpriteMorph.prototype.audioContext;StageMorph.prototype.setPan=SpriteMorph.prototype.setPan;StageMorph.prototype.changePan=SpriteMorph.prototype.changePan;StageMorph.prototype.getPan=SpriteMorph.prototype.getPan;StageMorph.prototype.getPannerNode=SpriteMorph.prototype.getPannerNode;StageMorph.prototype.playFreq=SpriteMorph.prototype.playFreq;StageMorph.prototype.stopFreq=SpriteMorph.prototype.stopFreq;StageMorph.prototype.toggleWatcher=SpriteMorph.prototype.toggleWatcher;StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher;StageMorph.prototype.watcherFor=SpriteMorph.prototype.watcherFor;StageMorph.prototype.getLastAnswer=SpriteMorph.prototype.getLastAnswer;StageMorph.prototype.reportThreadCount=SpriteMorph.prototype.reportThreadCount;StageMorph.prototype.snapPoint=SpriteMorph.prototype.snapPoint;StageMorph.prototype.xCenter=function(){return 0};StageMorph.prototype.yCenter=function(){return 0};StageMorph.prototype.xLeft=function(){return this.dimensions.x*-.5};StageMorph.prototype.xRight=function(){return this.dimensions.x/2};StageMorph.prototype.yTop=function(){return this.dimensions.y/2};StageMorph.prototype.yBottom=function(){return this.dimensions.y*-.5};StageMorph.prototype.allMessageNames=SpriteMorph.prototype.allMessageNames;StageMorph.prototype.allSendersOf=SpriteMorph.prototype.allSendersOf;StageMorph.prototype.allHatBlocksFor=SpriteMorph.prototype.allHatBlocksFor;StageMorph.prototype.allHatBlocksForKey=SpriteMorph.prototype.allHatBlocksForKey;StageMorph.prototype.allHatBlocksForInteraction=SpriteMorph.prototype.allHatBlocksForInteraction;StageMorph.prototype.hasGenericHatBlocks=SpriteMorph.prototype.hasGenericHatBlocks;StageMorph.prototype.allGenericHatBlocks=SpriteMorph.prototype.allGenericHatBlocks;StageMorph.prototype.allScripts=SpriteMorph.prototype.allScripts;StageMorph.prototype.mouseClickLeft=SpriteMorph.prototype.mouseClickLeft;StageMorph.prototype.mouseEnter=SpriteMorph.prototype.mouseEnter;StageMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed")};StageMorph.prototype.mouseDownLeft=SpriteMorph.prototype.mouseDownLeft;StageMorph.prototype.mouseScroll=SpriteMorph.prototype.mouseScroll;StageMorph.prototype.receiveUserInteraction=SpriteMorph.prototype.receiveUserInteraction;StageMorph.prototype.deleteAllBlockInstances=SpriteMorph.prototype.deleteAllBlockInstances;StageMorph.prototype.allBlockInstances=SpriteMorph.prototype.allBlockInstances;StageMorph.prototype.allBlockInstancesInData=function(definition){var blocks=[];this.allContextsUsing(definition).forEach(context=>{if(context.expression instanceof BlockMorph){context.expression.allChildren().forEach(c=>{if(c.isCustomBlock&&c.definition===definition){blocks.push(c)}})}});return blocks};StageMorph.prototype.allContextsUsing=function(definition){var objects,contexts=[],charted=[];if(!definition.isGlobal){return[]}function scanVariables(varFrame){varFrame.names().forEach(vname=>{var value=varFrame.getVar(vname);if(value instanceof Context){scanContext(value)}else if(value instanceof List){scanList(value)}})}function scanContext(context){if(!charted.includes(context)){charted.push(context)}if(context.expression instanceof BlockMorph&&context.expression.allChildren().some(c=>c.isCustomBlock&&c.definition===definition)){contexts.push(context)}}function scanList(list){if(!charted.includes(list)){charted.push(list);list.map(each=>{if(each instanceof Context){scanContext(each)}else if(each instanceof List){scanList(each)}})}}objects=this.children.filter(morph=>morph instanceof SpriteMorph);objects.push(this);scanVariables(this.globalVariables());objects.forEach(sprite=>scanVariables(sprite.variables));this.threads.processes.forEach(proc=>{if(proc.context instanceof Context){scanContext(proc.context)}});return contexts};StageMorph.prototype.allBlockInvocationsInData=function(oldSpec,receiver){var blocks=[];this.allContextsInvoking(oldSpec,receiver).forEach(context=>{if(context.expression instanceof BlockMorph){context.expression.allChildren().forEach(c=>{if(c.isCustomBlock&&!c.isGlobal&&c.blockSpec===oldSpec){blocks.push(c)}})}});return blocks};StageMorph.prototype.allContextsInvoking=function(oldSpec,receiver){var objects,contexts=[],charted=[];function scanVariables(varFrame){varFrame.names().forEach(vname=>{var value=varFrame.getVar(vname);if(value instanceof Context){scanContext(value)}else if(value instanceof List){scanList(value)}})}function scanContext(context){if(!charted.includes(context)){charted.push(context)}if((context.receiver===receiver||context.receiver===null)&&context.expression instanceof BlockMorph&&context.expression.allChildren().some(c=>c.isCustomBlock&&!c.isGlobal&&c.blockSpec===oldSpec)){contexts.push(context)}}function scanList(list){if(!charted.includes(list)){charted.push(list);list.map(each=>{if(each instanceof Context){scanContext(each)}else if(each instanceof List){scanList(each)}})}}objects=this.children.filter(morph=>morph instanceof SpriteMorph);objects.push(this);scanVariables(this.globalVariables());objects.forEach(sprite=>scanVariables(sprite.variables));this.threads.processes.forEach(proc=>{if(proc.context instanceof Context){scanContext(proc.context)}});return contexts};StageMorph.prototype.allLocalBlockInstances=SpriteMorph.prototype.allLocalBlockInstances;StageMorph.prototype.allEditorBlockInstances=SpriteMorph.prototype.allEditorBlockInstances;StageMorph.prototype.paletteBlockInstance=SpriteMorph.prototype.paletteBlockInstance;StageMorph.prototype.usesBlockInstance=SpriteMorph.prototype.usesBlockInstance;StageMorph.prototype.doubleDefinitionsFor=SpriteMorph.prototype.doubleDefinitionsFor;StageMorph.prototype.replaceDoubleDefinitionsFor=SpriteMorph.prototype.replaceDoubleDefinitionsFor;StageMorph.prototype.allInvocationsOf=SpriteMorph.prototype.allInvocationsOf;StageMorph.prototype.allIndependentInvocationsOf=SpriteMorph.prototype.allInvocationsOf;StageMorph.prototype.allDependentInvocationsOf=SpriteMorph.prototype.allInvocationsOf;StageMorph.prototype.specimens=function(){return[]};StageMorph.prototype.allSpecimens=function(){return[]};StageMorph.prototype.shadowAttribute=nop;StageMorph.prototype.inheritsAttribute=function(){return false};StageMorph.prototype.isVariableNameInUse=SpriteMorph.prototype.isVariableNameInUse;StageMorph.prototype.globalVariables=SpriteMorph.prototype.globalVariables;StageMorph.prototype.inheritedVariableNames=function(){return[]};StageMorph.prototype.deletableVariableNames=function(){return this.variables.allNames()};StageMorph.prototype.allLocalVariableNames=SpriteMorph.prototype.allLocalVariableNames;StageMorph.prototype.reachableGlobalVariableNames=SpriteMorph.prototype.reachableGlobalVariableNames;StageMorph.prototype.getMethod=SpriteMorph.prototype.getMethod;StageMorph.prototype.getLocalMethod=SpriteMorph.prototype.getLocalMethod;StageMorph.prototype.ownBlocks=SpriteMorph.prototype.ownBlocks;StageMorph.prototype.allBlocks=function(valuesOnly){var dict=this.ownBlocks();if(valuesOnly){return Object.keys(dict).map(key=>dict[key])}return dict};StageMorph.prototype.inheritedBlocks=function(){return[]};StageMorph.prototype.hasSpriteVariable=SpriteMorph.prototype.hasSpriteVariable;StageMorph.prototype.refactorVariableInstances=SpriteMorph.prototype.refactorVariableInstances;StageMorph.prototype.reportPenTrailsAsCostume=function(){return new Costume(this.trailsCanvas,this.newCostumeName(localize("Background")))};StageMorph.prototype.globalBlocksSending=function(message,receiverName){var all=this.globalBlocks.filter(def=>def.isSending(message,receiverName));this.globalBlocks.forEach(def=>{if(def.collectDependencies().some(dep=>contains(all,dep))){all.push(def)}});return all};StageMorph.prototype.toXMLString=function(){var ide=this.parentThatIsA(IDE_Morph),dependencies=[],categories=[],blocksXML="",conversion,xml;function collect(item,array){if(!contains(array,item)){array.push(item)}}function collectAll(items,array){items.forEach(item=>collect(item,array))}this.scripts.children.filter(morph=>morph instanceof BlockMorph).forEach(script=>collectAll(script.dependencies(true),dependencies));this.customBlocks.forEach(def=>{collect(def.category,categories);collectAll(def.collectDependencies([],[],this).filter(each=>each.isGlobal),dependencies)});if(dependencies.length||categories.length){blocksXML=ide.blocksLibraryXML(dependencies,categories)}conversion=this.toXML;this.toXML=this.toSpriteXML;xml='<sprites app="'+ide.serializer.app+'" version="'+ide.serializer.version+'">'+blocksXML+ide.serializer.serialize([this])+"</sprites>";this.toXML=conversion;return xml};SpriteBubbleMorph.prototype=new SpeechBubbleMorph;SpriteBubbleMorph.prototype.constructor=SpriteBubbleMorph;SpriteBubbleMorph.uber=SpeechBubbleMorph.prototype;function SpriteBubbleMorph(data,stage,isThought,isQuestion){this.init(data,stage,isThought,isQuestion)}SpriteBubbleMorph.prototype.init=function(data,stage,isThought,isQuestion){var sprite=SpriteMorph.prototype;this.stage=stage;this.scale=stage?stage.scale:1;this.data=data;this.isQuestion=isQuestion;this.bubbleFontColor=BLACK;this.bubbleFontSize=sprite.bubbleFontSize;this.bubbleFontIsBold=sprite.bubbleFontIsBold;this.bubbleCorner=sprite.bubbleCorner;this.bubbleBorder=sprite.bubbleBorder;this.bubblePadding=this.bubbleCorner/2;SpriteBubbleMorph.uber.init.call(this,this.data,sprite.bubbleColor,null,null,isQuestion?sprite.blockColor.sensing:sprite.bubbleBorderColor,null,isThought,true);this.isCachingImage=true;this.rerender()};SpriteBubbleMorph.prototype.dataAsMorph=function(data){var contents,sprite=SpriteMorph.prototype,isText,img,scaledImg,width;if(data instanceof Morph){if(isSnapObject(data)){img=data.thumbnail(new Point(40,40));contents=new Morph;contents.isCachingImage=true;contents.bounds.setWidth(img.width);contents.bounds.setHeight(img.height);contents.cachedImage=img;contents.version=data.version;contents.step=function(){if(this.version!==data.version){img=data.thumbnail(new Point(40,40),this.cachedImage);this.cachedImage=img;this.version=data.version;this.changed()}}}else{contents=data}}else if(isString(data)){isText=true;contents=new TextMorph(data,this.bubbleFontSize*this.scale,null,this.bubbleFontIsBold,false,"center");contents.userMenu=function(){var menu=new MenuMorph(this),ide=this.parentThatIsA(IDE_Morph)||this.world().childThatIsA(IDE_Morph);if(ide.isAppMode){return}menu.addItem("export",()=>ide.saveFileAs(data,"text/plain;charset=utf-8",localize("data")));return menu}}else if(typeof data==="boolean"){img=sprite.booleanMorph(data).fullImage();contents=new Morph;contents.isCachingImage=true;contents.bounds.setWidth(img.width);contents.bounds.setHeight(img.height);contents.cachedImage=img}else if(data instanceof Costume){img=data.thumbnail(new Point(40,40));contents=new Morph;contents.isCachingImage=true;contents.bounds.setWidth(img.width);contents.bounds.setHeight(img.height);contents.cachedImage=img;contents.isDraggable=true;contents.selectForEdit=function(){var cst=data.copy(),icon,prepare,ide=this.parentThatIsA(IDE_Morph)||this.world().childThatIsA(IDE_Morph);cst.name=ide.currentSprite.newCostumeName(cst.name);icon=new CostumeIconMorph(cst);prepare=icon.prepareToBeGrabbed;icon.prepareToBeGrabbed=function(hand){hand.grabOrigin={origin:ide.palette,position:ide.palette.center()};this.prepareToBeGrabbed=prepare};if(ide.isAppMode){return}icon.setCenter(this.center());return icon};contents.userMenu=function(){var menu=new MenuMorph(this),ide=this.parentThatIsA(IDE_Morph)||this.world().childThatIsA(IDE_Morph);if(ide.isAppMode){return}menu.addItem("export",()=>{if(data instanceof SVG_Costume){ide.saveFileAs(data.contents.src,"text/svg",data.name)}else{ide.saveCanvasAs(data.contents,data.name)}});return menu}}else if(data instanceof Sound){contents=new SymbolMorph("notes",30);contents.isDraggable=true;contents.selectForEdit=function(){var snd=data.copy(),icon,prepare,ide=this.parentThatIsA(IDE_Morph)||this.world().childThatIsA(IDE_Morph);snd.name=ide.currentSprite.newSoundName(snd.name);icon=new SoundIconMorph(snd);prepare=icon.prepareToBeGrabbed;icon.prepareToBeGrabbed=function(hand){hand.grabOrigin={origin:ide.palette,position:ide.palette.center()};this.prepareToBeGrabbed=prepare};if(ide.isAppMode){return}icon.setCenter(this.center());return icon};contents.userMenu=function(){var menu=new MenuMorph(this),ide=this.parentThatIsA(IDE_Morph)||this.world().childThatIsA(IDE_Morph);if(ide.isAppMode){return}menu.addItem("export",()=>ide.saveAudioAs(data.audio,data.name));return menu}}else if(data instanceof HTMLCanvasElement){img=data;contents=new Morph;contents.isCachingImage=true;contents.bounds.setWidth(img.width);contents.bounds.setHeight(img.height);contents.cachedImage=img}else if(data instanceof List){if(data.isTable()){contents=new TableFrameMorph(new TableMorph(data,10));if(this.stage){contents.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding)))}}else{contents=new ListWatcherMorph(data);contents.update(true);contents.step=contents.update;if(this.stage){contents.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding)))}}contents.isDraggable=false}else if(data instanceof Context){img=data.image();contents=new Morph;contents.isCachingImage=true;contents.bounds.setWidth(img.width);contents.bounds.setHeight(img.height);contents.cachedImage=img;contents.version=data.version;contents.step=function(){if(this.version!==data.version){img=data.image();this.cachedImage=img;this.version=data.version;this.changed()}};contents.isDraggable=true;contents.selectForEdit=function(){var script=data.toBlock(),prepare=script.prepareToBeGrabbed,ide=this.parentThatIsA(IDE_Morph)||this.world().childThatIsA(IDE_Morph);script.prepareToBeGrabbed=function(hand){prepare.call(this,hand);hand.grabOrigin={origin:ide.palette,position:ide.palette.center()};this.prepareToBeGrabbed=prepare};if(ide.isAppMode){return}script.setPosition(this.position());return script}}else{contents=new TextMorph(data.toString(),this.bubbleFontSize*this.scale,null,this.bubbleFontIsBold,false,"center");contents.userMenu=function(){var menu=new MenuMorph(this),ide=this.parentThatIsA(IDE_Morph)||this.world().childThatIsA(IDE_Morph);if(ide.isAppMode){return}menu.addItem("export",()=>ide.saveFileAs(data.toString(),"text/plain;charset=utf-8",localize("data")));return menu}}if(contents instanceof TextMorph){width=Math.max(contents.width(),sprite.bubbleCorner*2*this.scale);if(isText){width=Math.min(width,sprite.bubbleMaxTextWidth*this.scale)}contents.color=this.bubbleFontColor;contents.setWidth(width)}else if(!(data instanceof List)){scaledImg=newCanvas(contents.extent().multiplyBy(this.scale));scaledImg.getContext("2d").drawImage(contents.getImage(),0,0,scaledImg.width,scaledImg.height);contents.cachedImage=scaledImg;contents.bounds=contents.bounds.scaleBy(this.scale)}return contents};SpriteBubbleMorph.prototype.setScale=function(scale){this.scale=scale;this.changed();this.fixLayout();this.rerender()};SpriteBubbleMorph.prototype.fixLayout=function(){if(!(this.contentsMorph instanceof ListWatcherMorph||this.contentsMorph instanceof TableFrameMorph)){this.contentsMorph.destroy();this.contentsMorph=this.dataAsMorph(this.data)}this.add(this.contentsMorph);this.edge=this.bubbleCorner*this.scale;this.border=this.bubbleBorder*this.scale;this.padding=this.bubblePadding*this.scale;this.bounds.setWidth(this.contentsMorph.width()+(this.padding?this.padding*2:this.edge*2));this.bounds.setHeight(this.contentsMorph.height()+this.edge+this.border*2+this.padding*2+2);this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))};function Costume(canvas,name,rotationCenter,noFit,maxExtent){this.contents=canvas?normalizeCanvas(canvas,true):newCanvas(null,true);if(!noFit){this.shrinkToFit(maxExtent||this.maxExtent())}this.name=name||null;this.rotationCenter=rotationCenter||this.center();this.embeddedData=null;this.version=Date.now();this.loaded=null}Costume.prototype.maxDimensions=new Point(480,360);Costume.prototype.maxExtent=function(){return this.maxDimensions};Costume.prototype.toString=function(){return"a Costume("+this.name+")"};Costume.prototype.extent=function(){return new Point(this.contents.width,this.contents.height)};Costume.prototype.center=function(){return this.extent().divideBy(2)};Costume.prototype.width=function(){return this.contents.width};Costume.prototype.height=function(){return this.contents.height};Costume.prototype.bounds=function(){return new Rectangle(0,0,this.width(),this.height())};Costume.prototype.shrinkWrap=function(){var bb=this.boundingBox(),ext=bb.extent(),pic=newCanvas(ext,true),ctx=pic.getContext("2d");ctx.drawImage(this.contents,bb.origin.x,bb.origin.y,ext.x,ext.y,0,0,ext.x,ext.y);this.rotationCenter=this.rotationCenter.subtract(bb.origin);this.contents=pic;this.version=Date.now()};Costume.prototype.canvasBoundingBox=function(pic){var row,col,w=pic.width,h=pic.height,ctx=pic.getContext("2d"),dta=ctx.getImageData(0,0,w,h);function getAlpha(x,y){return dta.data[y*w*4+x*4+3]}function getLeft(){for(col=0;col<w;col+=1){for(row=0;row<h;row+=1){if(getAlpha(col,row)){return col}}}return 0}function getTop(){for(row=0;row<h;row+=1){for(col=0;col<w;col+=1){if(getAlpha(col,row)){return row}}}return 0}function getRight(){for(col=w-1;col>=0;col-=1){for(row=h-1;row>=0;row-=1){if(getAlpha(col,row)){return Math.min(col+1,w)}}}return w}function getBottom(){for(row=h-1;row>=0;row-=1){for(col=w-1;col>=0;col-=1){if(getAlpha(col,row)){return Math.min(row+1,h)}}}return h}return new Rectangle(getLeft(),getTop(),getRight(),getBottom())};Costume.prototype.boundingBox=function(){return this.canvasBoundingBox(this.contents)};Costume.prototype.copy=function(){var canvas=newCanvas(this.extent(),true),cpy,ctx;ctx=canvas.getContext("2d");ctx.drawImage(this.contents,0,0);cpy=new Costume(canvas,this.name?copy(this.name):null);cpy.rotationCenter=this.rotationCenter.copy();return cpy};Costume.prototype.flipped=function(){var canvas=newCanvas(this.extent(),true),ctx=canvas.getContext("2d"),flipped;ctx.translate(this.width(),0);ctx.scale(-1,1);ctx.drawImage(this.contents,0,0);flipped=new Costume(canvas,this.name,new Point(this.width()-this.rotationCenter.x,this.rotationCenter.y),true);return flipped};Costume.prototype.stretched=function(w,h){w=(Math.sign(w)||1)*Math.max(1,Math.abs(w));h=(Math.sign(h)||1)*Math.max(1,Math.abs(h));var canvas=newCanvas(new Point(Math.abs(w),Math.abs(h)),true),ctx=canvas.getContext("2d"),xRatio=w/this.width(),yRatio=h/this.height(),center=this.rotationCenter.multiplyBy(new Point(xRatio,yRatio)),stretched;if(xRatio<0){center.x=canvas.width-Math.abs(center.x)}if(yRatio<0){center.y=canvas.height-Math.abs(center.y)}ctx.translate(Math.abs(Math.min(w,0)),Math.abs(Math.min(h,0)));ctx.scale(xRatio,yRatio);ctx.drawImage(this.rasterized().contents,0,0);stretched=new Costume(canvas,this.name,center,true);return stretched};Costume.prototype.edit=function(aWorld,anIDE,isnew,oncancel,onsubmit){var editor=new PaintEditorMorph;editor.oncancel=oncancel||nop;editor.openIn(aWorld,isnew?newCanvas(anIDE.stage.dimensions,true):this.contents,isnew?null:this.rotationCenter,(img,rc)=>{this.contents=img;this.rotationCenter=rc;this.version=Date.now();aWorld.changed();if(anIDE){if(anIDE.currentSprite instanceof SpriteMorph){this.shrinkWrap()}anIDE.currentSprite.wearCostume(this,true);anIDE.hasChangedMedia=true}(onsubmit||nop)()},anIDE)};Costume.prototype.editRotationPointOnly=function(aWorld,anIDE){var editor=new CostumeEditorMorph(this),action,dialog,txt;editor.fixLayout();action=()=>{editor.accept();anIDE.currentSprite.wearCostume(this,true)};dialog=new DialogBoxMorph(this,action);txt=new TextMorph(localize("click or drag crosshairs to move the rotation center"),dialog.fontSize,dialog.fontStyle,true,false,"center",null,null,new Point(1,1),WHITE);dialog.labelString="Costume Editor";dialog.createLabel();dialog.setPicture(editor);dialog.addBody(txt);dialog.addButton("ok","Ok");dialog.addButton("cancel","Cancel");dialog.fixLayout();dialog.popUp(aWorld)};Costume.prototype.shrinkToFit=function(extentPoint){if(extentPoint.x<this.width()||extentPoint.y<this.height()){this.contents=this.thumbnail(extentPoint,null,true)}};Costume.prototype.thumbnail=function(extentPoint,recycleMe,noPadding){var src=this.contents,w=src?src.width:1,h=src?src.height:1,scale=Math.min(extentPoint.x/w,extentPoint.y/h),xOffset=noPadding?0:Math.floor((extentPoint.x-w*scale)/2),yOffset=noPadding?0:Math.floor((extentPoint.y-h*scale)/2),trg,ctx;trg=newCanvas(noPadding?new Point(this.width()*scale,this.height()*scale):extentPoint,true,recycleMe);if(!src||src.width+src.height===0){return trg}ctx=trg.getContext("2d");ctx.save();ctx.scale(scale,scale);ctx.drawImage(src,Math.floor(xOffset/scale),Math.floor(yOffset/scale));ctx.restore();return trg};Costume.prototype.rasterized=function(){return this};Costume.prototype.pixels=function(){var pixels=[],src,i;if(!this.contents.width||!this.contents.height){return pixels}src=this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height);for(i=0;i<src.data.length;i+=4){pixels.push(new List([src.data[i],src.data[i+1],src.data[i+2],src.data[i+3]]))}return new List(pixels)};Costume.prototype.isTainted=function(){try{this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height)}catch(err){return true}return false};Costume.prototype.pngData=function(){return embedMetadataPNG(this.contents,this.embeddedData)};SVG_Costume.prototype=new Costume;SVG_Costume.prototype.constructor=SVG_Costume;SVG_Costume.uber=Costume.prototype;function SVG_Costume(svgImage,name,rotationCenter){this.contents=svgImage;this.shapes=[];this.shrinkToFit(this.maxExtent());this.name=name||null;this.rotationCenter=rotationCenter||this.center();this.version=Date.now();this.loaded=null}SVG_Costume.prototype.toString=function(){return"an SVG_Costume("+this.name+")"};SVG_Costume.prototype.copy=function(){var img=new Image,cpy;img.src=this.contents.src;cpy=new SVG_Costume(img,this.name?copy(this.name):null);cpy.rotationCenter=this.rotationCenter.copy();cpy.shapes=this.shapes.map(shape=>shape.copy());return cpy};SVG_Costume.prototype.shrinkToFit=function(extentPoint){nop(extentPoint);return};SVG_Costume.prototype.parseShapes=function(){var element=new XML_Element,contents=this.contents.src.replace(/^data:image\/.*?, */,"");if(this.contents.src.indexOf("base64")>-1){contents=atob(contents)}element.parseString(contents);if(this.shapes.length===0&&element.attributes.snap){this.shapes=element.children.map(child=>window[child.attributes.prototype].fromSVG(child))}};SVG_Costume.prototype.edit=function(aWorld,anIDE,isnew,oncancel,onsubmit){var editor=new VectorPaintEditorMorph,myself=this;editor.oncancel=oncancel||nop;editor.openIn(aWorld,isnew?newCanvas(anIDE.stage.dimensions):this.contents,isnew?new Point(240,180):this.rotationCenter,(img,rc,shapes)=>{myself.contents=img;myself.rotationCenter=rc;myself.shapes=shapes;myself.version=Date.now();aWorld.changed();if(anIDE){if(isnew){anIDE.currentSprite.addCostume(myself)}anIDE.currentSprite.wearCostume(myself);anIDE.hasChangedMedia=true}(onsubmit||nop)()},anIDE,this.shapes||[])};SVG_Costume.prototype.rasterized=function(){var canvas=newCanvas(this.extent(),true),ctx=canvas.getContext("2d"),rasterized;ctx.drawImage(this.contents,0,0);rasterized=new Costume(canvas,this.name,this.rotationCenter.copy());return rasterized};CostumeEditorMorph.prototype=new Morph;CostumeEditorMorph.prototype.constructor=CostumeEditorMorph;CostumeEditorMorph.uber=Morph.prototype;CostumeEditorMorph.prototype.size=Costume.prototype.maxExtent();function CostumeEditorMorph(costume){this.init(costume)}CostumeEditorMorph.prototype.init=function(costume){this.costume=costume||new Costume;this.rotationCenter=this.costume.rotationCenter.copy();this.margin=ZERO;CostumeEditorMorph.uber.init.call(this)};CostumeEditorMorph.prototype.accept=function(){this.costume.rotationCenter=this.rotationCenter.copy();this.costume.version=Date.now()};CostumeEditorMorph.prototype.fixLayout=function(){this.bounds.setExtent(this.size)};CostumeEditorMorph.prototype.render=function(ctx){var rp;this.margin=this.size.subtract(this.costume.extent()).divideBy(2);rp=this.rotationCenter.add(this.margin);if(!this.cachedTexture){this.cachedTexture=this.createTexture()}this.renderCachedTexture(ctx);ctx.drawImage(this.costume.contents,this.margin.x,this.margin.y);ctx.globalAlpha=.5;ctx.fillStyle="white";ctx.beginPath();ctx.arc(rp.x,rp.y,20,radians(0),radians(360),false);ctx.closePath();ctx.fill();ctx.stroke();ctx.beginPath();ctx.arc(rp.x,rp.y,10,radians(0),radians(360),false);ctx.stroke();ctx.beginPath();ctx.moveTo(0,rp.y);ctx.lineTo(this.costume.width()+this.margin.x*2,rp.y);ctx.stroke();ctx.beginPath();ctx.moveTo(rp.x,0);ctx.lineTo(rp.x,this.costume.height()+this.margin.y*2);ctx.stroke()};CostumeEditorMorph.prototype.createTexture=function(){var size=5,texture=newCanvas(new Point(size*2,size*2)),ctx=texture.getContext("2d"),grey=new Color(230,230,230);ctx.fillStyle="white";ctx.fillRect(0,0,size*2,size*2);ctx.fillStyle=grey.toString();ctx.fillRect(0,0,size,size);ctx.fillRect(size,size,size,size);return texture};CostumeEditorMorph.prototype.mouseDownLeft=function(pos){this.rotationCenter=pos.subtract(this.position().add(this.margin));this.rerender()};CostumeEditorMorph.prototype.mouseMove=CostumeEditorMorph.prototype.mouseDownLeft;function Sound(audio,name){this.audio=audio;this.name=name||"Sound";this.cachedSamples=null;this.audioBuffer=null;this.isDecoding=false;this.loaded=null}Sound.prototype.play=function(){var aud=document.createElement("audio");aud.src=this.audio.src;aud.play();return aud};Sound.prototype.copy=function(){var snd=document.createElement("audio"),cpy;snd.src=this.audio.src;cpy=new Sound(snd,this.name?copy(this.name):null);return cpy};Sound.prototype.toDataURL=function(){return this.audio.src};function Note(pitch){this.pitch=pitch===0?0:pitch||69;this.frequency=null;this.setupContext();this.oscillator=null;this.fader=null;this.ended=false}Note.prototype.audioContext=null;Note.prototype.fadeIn=new Float32Array(2);Note.prototype.fadeIn[0]=[0];Note.prototype.fadeIn[1]=[.2];Note.prototype.fadeOut=new Float32Array(2);Note.prototype.fadeOut[0]=[.2];Note.prototype.fadeOut[1]=[0];Note.prototype.fadeTime=.01;Note.prototype.setupContext=function(){if(this.audioContext){return}var AudioContext=function(){var ctx=window.AudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext||window.webkitAudioContext;if(!ctx.prototype.createGain){ctx.prototype.createGain=ctx.prototype.createGainNode}return ctx}();if(!AudioContext){throw new Error("Web Audio API is not supported\nin this browser")}Note.prototype.audioContext=new AudioContext};Note.prototype.getAudioContext=function(){if(!this.audioContext){this.setupContext()}this.audioContext.resume();return this.audioContext};Note.prototype.play=function(type,gainNode,pannerNode){if(!gainNode){gainNode=this.audioContext.createGain()}this.fader=this.audioContext.createGain();this.oscillator=this.audioContext.createOscillator();if(!this.oscillator.start){this.oscillator.start=this.oscillator.noteOn}if(!this.oscillator.stop){this.oscillator.stop=this.oscillator.noteOff}this.setInstrument(type);this.oscillator.frequency.value=isNil(this.frequency)?Math.pow(2,(this.pitch-69)/12)*440:this.frequency;this.oscillator.connect(this.fader);this.fader.connect(gainNode);if(pannerNode){gainNode.connect(pannerNode);pannerNode.connect(this.audioContext.destination)}else{gainNode.connect(this.audioContext.destination)}this.ended=false;this.fader.gain.setValueCurveAtTime(this.fadeIn,this.audioContext.currentTime,this.fadeTime);this.oscillator.start(0)};Note.prototype.setInstrument=function(type){if(this.oscillator){this.oscillator.type=["sine","square","sawtooth","triangle"][(type||1)-1]}};Note.prototype.stop=function(immediately){var fade=!immediately;if(immediately&&this.oscillator){this.oscillator.stop(0);return}if(this.fader){try{this.fader.gain.setValueCurveAtTime(this.fadeOut,this.audioContext.currentTime,this.fadeTime)}catch(err){fade=false}}if(this.oscillator){this.oscillator.stop(fade?this.audioContext.currentTime+this.fadeTime:0);this.oscillator=null}this.ended=true};Note.prototype.pause=function(){this.stop()};function Microphone(){this.audioContext=null;this.sourceStream=null;this.processor=null;this.analyser=null;this.resolution=2;this.GOOD_ENOUGH_CORRELATION=.96;this.modifier=null;this.compiledModifier=null;this.compilerProcess=null;this.correlations=[];this.wrapper=new List([0]);this.outChannels=[];this.volume=0;this.signals=[];this.output=[];this.frequencies=[];this.pitch=-1;this.isStarted=false;this.isReady=false;this.isAutoStop=location.protocol!=="file:";this.lastTime=Date.now()}Microphone.prototype.isOn=function(){if(this.isReady){this.lastTime=Date.now();return true}this.start();return false};Microphone.prototype.binSizes=[256,512,1024,2048,4096];Microphone.prototype.binSize=function(){return this.binSizes[this.resolution-1]};Microphone.prototype.setResolution=function(num){if(contains([1,2,3,4],num)){if(this.isReady){this.stop()}this.resolution=num}};Microphone.prototype.start=function(){if(this.isStarted){return}this.isStarted=true;this.isReady=false;this.audioContext=Note.prototype.getAudioContext();navigator.mediaDevices.getUserMedia({audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}}).then(stream=>this.setupNodes(stream)).catch(nop)};Microphone.prototype.stop=function(){this.processor.onaudioprocess=null;this.sourceStream.getTracks().forEach(track=>track.stop());this.processor.disconnect();this.analyser.disconnect();this.processor=null;this.analyser=null;this.audioContext=null;this.isReady=false;this.isStarted=false};Microphone.prototype.setupNodes=function(stream){this.sourceStream=stream;this.createProcessor();this.createAnalyser();this.analyser.connect(this.processor);this.processor.connect(this.audioContext.destination);this.audioContext.createMediaStreamSource(stream).connect(this.analyser);this.lastTime=Date.now()};Microphone.prototype.createAnalyser=function(){var bufLength;this.analyser=this.audioContext.createAnalyser();this.analyser.fftSize=this.binSizes[this.resolution];bufLength=this.analyser.frequencyBinCount;this.frequencies=new Uint8Array(bufLength);this.correlations=new Array(Math.floor(bufLength/2))};Microphone.prototype.createProcessor=function(){var myself=this;this.processor=this.audioContext.createScriptProcessor(this.binSizes[this.resolution-1]);this.processor.onaudioprocess=function(event){myself.stepAudio(event)};this.processor.clipping=false;this.processor.lastClip=0;this.processor.clipLevel=.98;this.processor.averaging=.95;this.processor.clipLag=750};Microphone.prototype.stepAudio=function(event){var channels,i;if(this.isAutoStop&&Date.now()-this.lastTime>5e3&&!this.modifier){this.stop();return}this.signals=event.inputBuffer.getChannelData(0);if(this.modifier){channels=event.outputBuffer.numberOfChannels;if(this.outChannels.length!==channels){this.outChannels=new Array(channels)}for(i=0;i<channels;i+=1){this.outChannels[i]=event.outputBuffer.getChannelData(i)}this.output=this.outChannels[0]}else{this.output=event.outputBuffer.getChannelData(0)}this.analyser.getByteFrequencyData(this.frequencies);this.pitch=this.detectPitchAndVolume(this.signals,this.audioContext.sampleRate);if(this.pitch>0){this.note=Math.round(12*(Math.log(this.pitch/440)/Math.log(2)))+69}this.isReady=true;this.isStarted=false};Microphone.prototype.detectPitchAndVolume=function(buf,sampleRate){var SIZE=buf.length,MAX_SAMPLES=Math.floor(SIZE/2),best_offset=-1,best_correlation=0,rms=0,foundGoodCorrelation=false,correlations=this.correlations,channels=this.outChannels.length,correlation,lastCorrelation,offset,shift,i,k,val,modified;for(i=0;i<SIZE;i+=1){val=buf[i];if(Math.abs(val)>=this.processor.clipLevel){this.processor.clipping=true;this.processor.lastClip=window.performance.now()}rms+=val*val;if(this.modifier){this.wrapper.contents[0]=val;modified=invoke(this.compiledModifier,this.wrapper,null,null,null,null,this.compilerProcess);for(k=0;k<channels;k+=1){this.outChannels[k][i]=modified}}}rms=Math.sqrt(rms/SIZE);this.volume=Math.max(rms,this.volume*this.processor.averaging);if(rms<.01)return this.pitch;lastCorrelation=1;for(offset=1;offset<MAX_SAMPLES;offset+=1){correlation=0;for(i=0;i<MAX_SAMPLES;i+=1){correlation+=Math.abs(buf[i]-buf[i+offset])}correlation=1-correlation/MAX_SAMPLES;correlations[offset]=correlation;if(correlation>this.GOOD_ENOUGH_CORRELATION&&correlation>lastCorrelation){foundGoodCorrelation=true;if(correlation>best_correlation){best_correlation=correlation;best_offset=offset}}else if(foundGoodCorrelation){shift=(correlations[best_offset+1]-correlations[best_offset-1])/correlations[best_offset];return sampleRate/(best_offset+8*shift)}lastCorrelation=correlation}if(best_correlation>.01){return sampleRate/best_offset}return this.pitch};CellMorph.prototype=new BoxMorph;CellMorph.prototype.constructor=CellMorph;CellMorph.uber=BoxMorph.prototype;function CellMorph(contents,color,idx,parentCell){this.init(contents,color,idx,parentCell)}CellMorph.prototype.init=function(contents,color,idx,parentCell){this.contents=contents===0?0:contents===false?false:contents||"";this.isEditable=isNil(idx)?false:true;this.idx=idx||null;this.parentCell=parentCell||null;CellMorph.uber.init.call(this,SyntaxElementMorph.prototype.corner,1,WHITE);this.color=color||new Color(255,140,0);this.isBig=false;this.version=null;this.fixLayout()};CellMorph.prototype.big=function(){this.isBig=true;this.changed();if(this.contentsMorph instanceof TextMorph){this.contentsMorph.setFontSize(SyntaxElementMorph.prototype.fontSize*1.5)}this.fixLayout(true);this.rerender()};CellMorph.prototype.normal=function(){this.isBig=false;this.changed();if(this.contentsMorph instanceof TextMorph){this.contentsMorph.setFontSize(SyntaxElementMorph.prototype.fontSize)}this.fixLayout(true);this.rerender()};CellMorph.prototype.isCircular=function(list){if(!this.parentCell){return false}if(list instanceof List){return this.contents===list||this.parentCell.isCircular(list)}return this.parentCell.isCircular(this.contents)};CellMorph.prototype.fixLayout=function(justMe){var isSameList=this.contentsMorph instanceof ListWatcherMorph&&this.contentsMorph.list===this.contents,isSameTable=this.contentsMorph instanceof TableFrameMorph&&this.contentsMorph.tableMorph.table===this.contents,listwatcher;if(justMe){return}this.createContents();this.bounds.setHeight(this.contentsMorph.height()+this.edge+this.border*2);this.bounds.setWidth(Math.max(this.contentsMorph.width()+this.edge*2,this.contents instanceof Context||this.contents instanceof List?0:SyntaxElementMorph.prototype.fontSize*3.5));if(!isSameList&&!isSameTable){this.contentsMorph.setCenter(this.center())}if(this.parent){this.parent.changed();this.parent.fixLayout();this.parent.rerender();listwatcher=this.parentThatIsA(ListWatcherMorph);if(listwatcher){listwatcher.changed();listwatcher.fixLayout();listwatcher.rerender()}}};CellMorph.prototype.createContents=function(){var txt,img,myself=this,fontSize=SyntaxElementMorph.prototype.fontSize,isSameList=this.contentsMorph instanceof ListWatcherMorph&&this.contentsMorph.list===this.contents,isSameTable=this.contentsMorph instanceof TableFrameMorph&&this.contentsMorph.tableMorph.table===this.contents;if(this.isBig){fontSize=fontSize*1.5}if(this.contentsMorph&&!isSameList&&!isSameTable){this.contentsMorph.destroy();this.version=null}if(!isSameList&&!isSameTable){if(this.contents instanceof Morph){if(isSnapObject(this.contents)){img=this.contents.thumbnail(new Point(40,40));this.contentsMorph=new Morph;this.contentsMorph.isCachingImage=true;this.contentsMorph.bounds.setWidth(img.width);this.contentsMorph.bounds.setHeight(img.height);this.contentsMorph.cachedImage=img;this.version=this.contents.version}else{this.contentsMorph=this.contents}}else if(isString(this.contents)){txt=this.contents.length>500?this.contents.slice(0,500)+"...":this.contents;this.contentsMorph=new TextMorph(txt,fontSize,null,true,false,"left");if(this.isEditable){this.contentsMorph.isEditable=true;this.contentsMorph.enableSelecting()}this.contentsMorph.setColor(WHITE)}else if(typeof this.contents==="boolean"){img=SpriteMorph.prototype.booleanMorph.call(null,this.contents).fullImage();this.contentsMorph=new Morph;this.contentsMorph.isCachingImage=true;this.contentsMorph.bounds.setWidth(img.width);this.contentsMorph.bounds.setHeight(img.height);this.contentsMorph.cachedImage=img}else if(this.contents instanceof HTMLCanvasElement){img=this.contents;this.contentsMorph=new Morph;this.contentsMorph.isCachingImage=true;this.contentsMorph.bounds.setWidth(img.width);this.contentsMorph.bounds.setHeight(img.height);this.contentsMorph.cachedImage=img}else if(this.contents instanceof Context){img=this.contents.image();this.contentsMorph=new Morph;this.contentsMorph.isCachingImage=true;this.contentsMorph.bounds.setWidth(img.width);this.contentsMorph.bounds.setHeight(img.height);this.contentsMorph.cachedImage=img;this.version=this.contents.version;this.contentsMorph.isDraggable=true;this.contentsMorph.selectForEdit=function(){var script=myself.contents.toBlock(),prepare=script.prepareToBeGrabbed,ide=this.parentThatIsA(IDE_Morph)||this.world().childThatIsA(IDE_Morph);script.prepareToBeGrabbed=function(hand){prepare.call(this,hand);hand.grabOrigin={origin:ide.palette,position:ide.palette.center()};this.prepareToBeGrabbed=prepare};if(ide.isAppMode){return}script.setPosition(this.position());return script}}else if(this.contents instanceof Costume){img=this.contents.thumbnail(new Point(40,40));this.contentsMorph=new Morph;this.contentsMorph.isCachingImage=true;this.contentsMorph.bounds.setWidth(img.width);this.contentsMorph.bounds.setHeight(img.height);this.contentsMorph.cachedImage=img;this.contentsMorph.isDraggable=true;this.contentsMorph.selectForEdit=function(){var cst=myself.contents.copy(),icon,prepare,ide=this.parentThatIsA(IDE_Morph)||this.world().childThatIsA(IDE_Morph);cst.name=ide.currentSprite.newCostumeName(cst.name);icon=new CostumeIconMorph(cst);prepare=icon.prepareToBeGrabbed;icon.prepareToBeGrabbed=function(hand){hand.grabOrigin={origin:ide.palette,position:ide.palette.center()};this.prepareToBeGrabbed=prepare};if(ide.isAppMode){return}icon.setCenter(this.center());return icon}}else if(this.contents instanceof Sound){this.contentsMorph=new SymbolMorph("notes",30);this.contentsMorph.isDraggable=true;this.contentsMorph.selectForEdit=function(){var snd=myself.contents.copy(),icon,prepare,ide=this.parentThatIsA(IDE_Morph)||this.world().childThatIsA(IDE_Morph);snd.name=ide.currentSprite.newCostumeName(snd.name);icon=new SoundIconMorph(snd);prepare=icon.prepareToBeGrabbed;icon.prepareToBeGrabbed=function(hand){hand.grabOrigin={origin:ide.palette,position:ide.palette.center()};this.prepareToBeGrabbed=prepare};if(ide.isAppMode){return}icon.setCenter(this.center());return icon}}else if(this.contents instanceof List){if(this.contents.isTable()){this.contentsMorph=new TableFrameMorph(new TableMorph(this.contents,10));this.contentsMorph.expand(new Point(200,150))}else{if(this.isCircular()){this.contentsMorph=new TextMorph("(...)",fontSize,null,false,true,"center");this.contentsMorph.setColor(WHITE)}else{this.contentsMorph=new ListWatcherMorph(this.contents,this)}}this.contentsMorph.isDraggable=false}else{this.contentsMorph=new TextMorph(!isNil(this.contents)?this.contents.toString():"",fontSize,null,true,false,"center");if(this.isEditable){this.contentsMorph.isEditable=true;this.contentsMorph.enableSelecting()}this.contentsMorph.setColor(WHITE)}this.add(this.contentsMorph)}};CellMorph.prototype.update=function(){if(!isSnapObject(this.contents)&&!(this.contents instanceof Costume)&&!(this.contents instanceof Context)){return}if(this.version!==this.contents.version){this.fixLayout();this.rerender();this.version=this.contents.version}};CellMorph.prototype.render=function(ctx){if(this.edge===0&&this.border===0){BoxMorph.uber.render.call(this,ctx);return null}ctx.fillStyle=this.color.toString();ctx.beginPath();this.outlinePath(ctx,Math.max(this.edge-this.border,0),this.border);ctx.closePath();ctx.fill();if(this.border>0&&!MorphicPreferences.isFlat){ctx.lineWidth=this.border;ctx.strokeStyle=this.borderColor.toString();ctx.beginPath();this.outlinePath(ctx,this.edge,this.border/2);ctx.closePath();ctx.stroke();if(useBlurredShadows){ctx.shadowOffsetX=this.border;ctx.shadowOffsetY=this.border;ctx.shadowBlur=this.border;ctx.shadowColor=this.color.darker(80).toString();this.drawShadow(ctx,this.edge,0)}}};CellMorph.prototype.drawShadow=function(context,radius,inset){var offset=radius+inset,w=this.width(),h=this.height();context.beginPath();context.moveTo(0,h-offset);context.lineTo(0,offset);context.arc(offset,offset,radius,radians(-180),radians(-90),false);context.lineTo(w-offset,0);context.stroke()};CellMorph.prototype.layoutChanged=function(){var listWatcher=this.parentThatIsA(ListWatcherMorph);this.bounds.setHeight(this.contentsMorph.height()+this.edge+this.border*2);this.bounds.setWidth(Math.max(this.contentsMorph.width()+this.edge*2,this.contents instanceof Context||this.contents instanceof List?0:this.height()*2));this.contentsMorph.setCenter(this.center());this.rerender();if(listWatcher){listWatcher.fixLayout()}};CellMorph.prototype.reactToEdit=function(textMorph){var listWatcher;if(!isNil(this.idx)){listWatcher=this.parentThatIsA(ListWatcherMorph);if(listWatcher){listWatcher.list.put(textMorph.text,this.idx+listWatcher.start-1)}}};CellMorph.prototype.mouseClickLeft=function(pos){if(this.isEditable&&this.contentsMorph instanceof TextMorph){this.contentsMorph.selectAllAndEdit()}else{this.escalateEvent("mouseClickLeft",pos)}};CellMorph.prototype.mouseDoubleClick=function(pos){if(List.prototype.enableTables&&this.currentValue instanceof List){new TableDialogMorph(this.contents).popUp(this.world())}else{this.escalateEvent("mouseDoubleClick",pos)}};WatcherMorph.prototype=new BoxMorph;WatcherMorph.prototype.constructor=WatcherMorph;WatcherMorph.uber=BoxMorph.prototype;function WatcherMorph(label,color,target,getter,isHidden){this.init(label,color,target,getter,isHidden)}WatcherMorph.prototype.init=function(label,color,target,getter,isHidden){this.labelText=label||"";this.version=null;this.objName="";this.isGhosted=false;WatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120));this.color=new Color(220,220,220);this.readoutColor=color;this.style="normal";this.target=target||null;this.getter=getter||null;this.currentValue=null;this.labelMorph=null;this.sliderMorph=null;this.cellMorph=null;this.isDraggable=true;this.fixLayout();this.update();if(isHidden){this.hide()}};WatcherMorph.prototype.isTemporary=function(){var stage=this.parentThatIsA(StageMorph);if(this.target instanceof VariableFrame){if(stage){if(this.target===stage.variables.parentFrame){return false}}return this.target.owner===null}return false};WatcherMorph.prototype.object=function(){return this.target instanceof VariableFrame?this.target.owner:this.target};WatcherMorph.prototype.isGlobal=function(selector){return contains(["getLastAnswer","getLastMessage","getTempo","getTimer","reportMouseX","reportMouseY","reportThreadCount"],selector)};WatcherMorph.prototype.setSliderMin=function(num,noUpdate){if(this.target instanceof VariableFrame){this.sliderMorph.setSize(1,noUpdate);this.sliderMorph.setStart(num,noUpdate);this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,noUpdate)}};WatcherMorph.prototype.setSliderMax=function(num,noUpdate){if(this.target instanceof VariableFrame){this.sliderMorph.setSize(1,noUpdate);this.sliderMorph.setStop(num,noUpdate);this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,noUpdate)}};WatcherMorph.prototype.update=function(){var newValue,sprite,num,att,isInherited=false;if(this.target&&this.getter){this.updateLabel();if(this.target instanceof VariableFrame){newValue=this.target.vars[this.getter]?this.target.vars[this.getter].value:undefined;if(newValue===undefined&&this.target.owner){sprite=this.target.owner;if(contains(sprite.inheritedVariableNames(),this.getter)){newValue=this.target.getVar(this.getter);this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables.lighter(35))}else{this.destroy();return}}else{this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables)}}else{newValue=this.target[this.getter]();att={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",getScale:"size",getVolume:"volume",getPan:"balance",reportShown:"shown?",getPenDown:"pen down?"}[this.getter];isInherited=att?this.target.inheritsAttribute(att):false}if(newValue!==""&&!isNil(newValue)){num=+newValue;if(typeof newValue!=="boolean"&&!isNaN(num)){newValue=Math.round(newValue*1e9)/1e9}}if(newValue===undefined){this.destroy();return}if(newValue!==this.currentValue||isInherited!==this.isGhosted||!isNil(newValue)&&newValue.version&&newValue.version!==this.version){this.changed();this.cellMorph.contents=newValue;this.isGhosted=isInherited;if(isSnapObject(this.target)){if(isInherited){this.cellMorph.setColor(this.readoutColor.lighter(35))}else{this.cellMorph.setColor(this.readoutColor)}}this.cellMorph.fixLayout();if(!isNaN(newValue)){this.sliderMorph.value=newValue;this.sliderMorph.fixLayout()}this.fixLayout();if(this.currentValue&&this.currentValue.version){this.version=this.currentValue.version}else{this.version=Date.now()}this.currentValue=newValue}}if(this.cellMorph.contentsMorph instanceof ListWatcherMorph){this.cellMorph.contentsMorph.update()}else if(isSnapObject(this.cellMorph.contents)){this.cellMorph.update()}};WatcherMorph.prototype.updateLabel=function(){var obj=this.object();if(!obj||this.isGlobal(this.getter)){return}if(obj.version!==this.version){this.objName=obj.name?obj.name+" ":" ";if(this.labelMorph){this.labelMorph.destroy();this.labelMorph=null;this.fixLayout()}}};WatcherMorph.prototype.fixLayout=function(){var fontSize=SyntaxElementMorph.prototype.fontSize,isList,myself=this;if(this.labelMorph===null){this.labelMorph=new StringMorph(this.objName+this.labelText,fontSize,null,true,false,false,MorphicPreferences.isFlat?new Point:new Point(1,1),WHITE);this.add(this.labelMorph)}if(this.cellMorph===null){this.cellMorph=new CellMorph("",this.readoutColor);this.add(this.cellMorph)}if(this.sliderMorph===null){this.sliderMorph=new SliderMorph(0,100,0,20,"horizontal");this.sliderMorph.alpha=1;this.sliderMorph.button.color=this.color.darker();this.sliderMorph.color=this.color.lighter(60);this.sliderMorph.button.highlightColor=this.color.darker();this.sliderMorph.button.highlightColor.b+=50;this.sliderMorph.button.pressColor=this.color.darker();this.sliderMorph.button.pressColor.b+=100;this.sliderMorph.setHeight(fontSize);this.sliderMorph.action=function(num){myself.target.setVar(myself.getter,Math.round(num),myself.target.owner)};this.add(this.sliderMorph)}isList=this.cellMorph.contents instanceof List;if(isList){this.style="normal"}if(this.style==="large"){this.labelMorph.hide();this.sliderMorph.hide();this.cellMorph.big();this.cellMorph.setPosition(this.position());this.bounds.setExtent(this.cellMorph.extent().subtract(1));return}this.labelMorph.show();this.sliderMorph.show();this.cellMorph.normal();this.labelMorph.setPosition(this.position().add(new Point(this.edge,this.border+SyntaxElementMorph.prototype.typeInPadding)));if(isList){this.cellMorph.setPosition(this.labelMorph.bottomLeft().add(new Point(0,SyntaxElementMorph.prototype.typeInPadding)))}else{this.cellMorph.setPosition(this.labelMorph.topRight().add(new Point(fontSize/3,0)));this.labelMorph.setTop(this.cellMorph.top()+(this.cellMorph.height()-this.labelMorph.height())/2)}if(this.style==="slider"){this.sliderMorph.setPosition(new Point(this.labelMorph.left(),this.cellMorph.bottom()+SyntaxElementMorph.prototype.typeInPadding));this.sliderMorph.setWidth(this.cellMorph.right()-this.labelMorph.left());this.bounds.setHeight(this.cellMorph.height()+this.sliderMorph.height()+this.border*2+SyntaxElementMorph.prototype.typeInPadding*3)}else{this.sliderMorph.hide();this.bounds.corner.y=this.cellMorph.bottom()+this.border+SyntaxElementMorph.prototype.typeInPadding}this.bounds.corner.x=Math.max(this.cellMorph.right(),this.labelMorph.right())+this.edge+SyntaxElementMorph.prototype.typeInPadding};WatcherMorph.prototype.mouseDoubleClick=function(pos){if(List.prototype.enableTables&&this.currentValue instanceof List){new TableDialogMorph(this.currentValue).popUp(this.world())}else{this.escalateEvent("mouseDoubleClick",pos)}};WatcherMorph.prototype.rootForGrab=function(){var ide=this.parentThatIsA(IDE_Morph);if(ide&&ide.isAppMode){return ide}return this};WatcherMorph.prototype.userMenu=function(){var myself=this,ide=this.parentThatIsA(IDE_Morph),shiftClicked=this.world().currentKey===16,menu=new MenuMorph(this),on="●",off="○",vNames;function monitor(vName){var stage=myself.parentThatIsA(StageMorph),varFrame=myself.currentValue.outerContext.variables;menu.addItem(vName+"...",function(){var watcher=detect(stage.children,morph=>morph instanceof WatcherMorph&&morph.target===varFrame&&morph.getter===vName),others;if(watcher!==null){watcher.show();watcher.fixLayout();return}watcher=new WatcherMorph(vName+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,varFrame,vName);watcher.setPosition(stage.position().add(10));others=stage.watchers(watcher.left());if(others.length>0){watcher.setTop(others[others.length-1].bottom())}stage.add(watcher);watcher.fixLayout()})}if(ide&&ide.isAppMode){return}menu.addItem((this.style==="normal"?on:off)+" "+localize("normal"),"styleNormal");menu.addItem((this.style==="large"?on:off)+" "+localize("large"),"styleLarge");if(this.target instanceof VariableFrame){menu.addItem((this.style==="slider"?on:off)+" "+localize("slider"),"styleSlider");menu.addLine();menu.addItem("slider min...","userSetSliderMin");menu.addItem("slider max...","userSetSliderMax");menu.addLine();menu.addItem("import...","importData");menu.addItem("raw data...",()=>this.importData(true),"import without attempting to\nparse or format data");if(shiftClicked){if(this.currentValue instanceof List&&this.currentValue.canBeCSV()){menu.addItem("export as CSV...",()=>ide.saveFileAs(this.currentValue.asCSV(),"text/csv;charset=utf-8",this.getter),null,new Color(100,0,0))}if(this.currentValue instanceof List&&this.currentValue.canBeJSON()){menu.addItem("export as JSON...",()=>ide.saveFileAs(this.currentValue.asJSON(true),"text/json;charset=utf-8",this.getter),null,new Color(100,0,0))}}if(isString(this.currentValue)||!isNaN(+this.currentValue)){if(shiftClicked){menu.addItem("parse","parseTxt","try to convert\nraw data into a list",new Color(100,0,0))}menu.addItem("export...",()=>ide.saveFileAs(this.currentValue.toString(),"text/plain;charset=utf-8",this.getter))}else if(this.currentValue instanceof Costume){menu.addItem("export...",()=>{if(this.currentValue instanceof SVG_Costume){ide.saveFileAs(this.currentValue.contents.src,"text/svg",this.currentValue.name)}else{ide.saveCanvasAs(this.currentValue.contents,this.currentValue.name)}})}else if(this.currentValue instanceof Sound){menu.addItem("export...",()=>ide.saveAudioAs(this.currentValue.audio,this.currentValue.name))}else if(this.currentValue instanceof List&&this.currentValue.canBeCSV()){menu.addItem("export...",()=>ide.saveFileAs(this.currentValue.asCSV(),"text/csv;charset=utf-8",this.getter));if(this.currentValue.canBeJSON()){menu.addItem("blockify",()=>{var world=ide.world();this.currentValue.blockify().pickUp(world);world.hand.grabOrigin={origin:ide.palette,position:ide.palette.center()}})}}else if(this.currentValue instanceof List&&this.currentValue.canBeJSON()){menu.addItem("export...",()=>ide.saveFileAs(this.currentValue.asJSON(true),"text/json;charset=utf-8",this.getter))}else if(this.currentValue instanceof Context){vNames=this.currentValue.outerContext.variables.names();if(vNames.length){menu.addLine();vNames.forEach(vName=>monitor(vName))}}}return menu};WatcherMorph.prototype.importData=function(raw){var inp=document.createElement("input"),ide=this.parentThatIsA(IDE_Morph),myself=this;function userImport(){function txtOnlyMsg(ftype,anyway){ide.confirm(localize('Snap! can only import "text" files.\n'+'You selected a file of type "'+ftype+'".')+"\n\n"+localize("Open anyway?"),"Unable to import",anyway)}function readText(aFile){var frd=new FileReader,ext=aFile.name.split(".").pop().toLowerCase();function isTextFile(aFile){return aFile.type.indexOf("text")!==-1||contains(["txt","csv","xml","json","tsv"],ext)}function isType(aFile,string){return aFile.type.indexOf(string)!==-1||ext===string}frd.onloadend=function(e){if(!raw&&isType(aFile,"csv")){myself.target.setVar(myself.getter,Process.prototype.parseCSV(e.target.result))}else if(!raw&&isType(aFile,"json")){myself.target.setVar(myself.getter,Process.prototype.parseJSON(e.target.result))}else{myself.target.setVar(myself.getter,e.target.result)}};if(raw||isTextFile(aFile)){frd.readAsText(aFile)}else{txtOnlyMsg(aFile.type,()=>frd.readAsText(aFile))}}document.body.removeChild(inp);ide.filePicker=null;if(inp.files.length>0){readText(inp.files[inp.files.length-1])}}if(ide.filePicker){document.body.removeChild(ide.filePicker);ide.filePicker=null}inp.type="file";inp.style.color="transparent";inp.style.backgroundColor="transparent";inp.style.border="none";inp.style.outline="none";inp.style.position="absolute";inp.style.top="0px";inp.style.left="0px";inp.style.width="0px";inp.style.height="0px";inp.style.display="none";inp.addEventListener("change",userImport,false);document.body.appendChild(inp);ide.filePicker=inp;inp.click()};WatcherMorph.prototype.parseTxt=function(){var src=this.target.vars[this.getter].value;this.target.setVar(this.getter,src.indexOf("[")===0?Process.prototype.parseJSON(src):Process.prototype.parseCSV(src))};WatcherMorph.prototype.setStyle=function(style){this.style=style;this.changed();this.fixLayout();this.rerender()};WatcherMorph.prototype.styleNormal=function(){this.setStyle("normal")};WatcherMorph.prototype.styleLarge=function(){this.setStyle("large")};WatcherMorph.prototype.styleSlider=function(){this.setStyle("slider")};WatcherMorph.prototype.userSetSliderMin=function(){new DialogBoxMorph(this,this.setSliderMin,this).prompt("Slider minimum value",this.sliderMorph.start.toString(),this.world(),null,null,null,true)};WatcherMorph.prototype.userSetSliderMax=function(){new DialogBoxMorph(this,this.setSliderMax,this).prompt("Slider maximum value",this.sliderMorph.stop.toString(),this.world(),null,null,null,true)};WatcherMorph.prototype.render=function(ctx){var gradient;if(MorphicPreferences.isFlat||this.edge===0&&this.border===0){BoxMorph.uber.render.call(this,ctx);return}gradient=ctx.createLinearGradient(0,0,0,this.height());gradient.addColorStop(0,this.color.lighter().toString());gradient.addColorStop(1,this.color.darker().toString());ctx.fillStyle=gradient;ctx.beginPath();this.outlinePath(ctx,Math.max(this.edge-this.border,0),this.border);ctx.closePath();ctx.fill();if(this.border>0){gradient=ctx.createLinearGradient(0,0,0,this.height());gradient.addColorStop(0,this.borderColor.lighter().toString());gradient.addColorStop(1,this.borderColor.darker().toString());ctx.lineWidth=this.border;ctx.strokeStyle=gradient;ctx.beginPath();this.outlinePath(ctx,this.edge,this.border/2);ctx.closePath();ctx.stroke()}};StagePrompterMorph.prototype=new BoxMorph;StagePrompterMorph.prototype.constructor=StagePrompterMorph;StagePrompterMorph.uber=BoxMorph.prototype;function StagePrompterMorph(question){this.init(question)}StagePrompterMorph.prototype.init=function(question){this.answer=null;this.isDone=false;if(question){this.label=new StringMorph(question,SpriteMorph.prototype.bubbleFontSize,null,SpriteMorph.prototype.bubbleFontIsBold,false,"left")}else{this.label=null}this.inputField=new InputFieldMorph;this.button=new PushButtonMorph(null,()=>this.accept(),"✓");StagePrompterMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,SpriteMorph.prototype.bubbleBorder,SpriteMorph.prototype.blockColor.sensing);this.color=WHITE;if(this.label){this.add(this.label)}this.add(this.inputField);this.add(this.button);this.fixLayout()};StagePrompterMorph.prototype.fixLayout=function(){var y=0;if(this.label){this.label.setPosition(new Point(this.left()+this.edge,this.top()+this.edge));y=this.label.bottom()-this.top()}this.inputField.setPosition(new Point(this.left()+this.edge,this.top()+y+this.edge));this.inputField.setWidth(this.width()-this.edge*2-this.button.width()-this.border);this.button.setCenter(this.inputField.center());this.button.setLeft(this.inputField.right()+this.border);this.bounds.setHeight(this.inputField.bottom()-this.top()+this.edge)};StagePrompterMorph.prototype.mouseClickLeft=function(){this.inputField.edit()};StagePrompterMorph.prototype.accept=function(){this.answer=this.inputField.getValue();this.isDone=true};StagePickerMorph.prototype=new MenuMorph;StagePickerMorph.prototype.constructor=StagePickerMorph;StagePickerMorph.uber=MenuMorph.prototype;function StagePickerMorph(options){this.init(options)}StagePickerMorph.prototype.init=function(options){var first=options.at(1),isSubmenu=this.isSubmenu(options),title=isSubmenu?first:null,items=isSubmenu?options.at(2):options;this.answer=null;this.isDone=false;this.scale=1;StagePickerMorph.uber.init.call(this,choice=>{var root=this.rootMenu();root.answer=choice;root.isDone=true},title,this,null);items.map(each=>{var key,value,isLine;if(this.isSubmenu(each)){this.addMenu(each.at(1),new StagePickerMorph(each.at(2)),null,true)}else{key=each;value=each;if(each instanceof List){isLine=each.isEmpty();if(this.isLeftQuote(each)){value=each.at(1);key=new SpriteBubbleMorph(value)}else if(this.isRightQuote(each)){value=each.at(2);key=new SpriteBubbleMorph(value);key.isPointingRight=false}else{key=each.at(1);if(key instanceof List){if(this.isLeftQuote(key)){key=new SpriteBubbleMorph(key.at(1))}else if(this.isRightQuote(key)){key=new SpriteBubbleMorph(key.at(2));key.isPointingRight=false}else if(this.isShortcut(key)){this.addPair(key.at(1).toString(),each.at(2),key.at(2).toString());return}else{key=key.itemsArray()}}value=each.at(2)}}if(isLine){this.addLine()}else{this.addItem(key,value,null,null,null,null,null,null,true)}}})};StagePickerMorph.prototype.isSubmenu=function(options){var first;if(!(options instanceof List)){return false}first=options.at(1);return(isString(first)||!isNaN(+first))&&first.toString().length&&options.length()===2&&options.rank()>1};StagePickerMorph.prototype.isLeftQuote=function(options){return options instanceof List&&!options.isEmpty()&&!options.at(2)};StagePickerMorph.prototype.isRightQuote=function(options){return options instanceof List&&!options.isEmpty()&&!options.at(1)&&options.at(1)!==false};StagePickerMorph.prototype.isShortcut=function(key){var types=["text","number"];return key instanceof List&&key.length()===2&&key.at(1)&&key.at(2)&&contains(types,Process.prototype.reportTypeOf(key.at(1)))&&contains(types,Process.prototype.reportTypeOf(key.at(2)))};StagePickerMorph.prototype.dataRepresentation=function(data){var sym,img;if(data instanceof SpeechBubbleMorph){data.bubbleFontSize=12;data.bubbleFontIsBold=false;data.bubbleCorner=5;data.bubbleBorder=0;data.bubblePadding=0;data.scale=this.scale;data.bubbleFontColor=data.isPointingRight?BLACK:WHITE;data.color=data.isPointingRight?new Color(220,220,220):SpriteMorph.prototype.blockColor.sensing;data.fixLayout();data.rerender();sym=data.fullImage();if(data.isPointingRight){return sym}img=newCanvas(new Point((SpriteMorph.prototype.bubbleMaxTextWidth+10)*this.scale,sym.height));img.getContext("2d").drawImage(sym,img.width-sym.width,0);return img}switch(Process.prototype.reportTypeOf(data)){case"costume":case"sprite":case"stage":return data.thumbnail(new Point(40,40).multiplyBy(this.scale));case"command":case"reporter":case"predicate":return data.image();case"Boolean":sym=new BooleanSlotMorph(data);sym.fontSize*=this.scale;sym.edge*=this.scale;sym.fixLayout();return sym.fullImage();case"sound":return new SymbolMorph("notes",30*this.scale).fullImage();default:return data.toString()}};StagePickerMorph.prototype.addItem=function(labelString,action,hint,color,bold,italic,doubleClickAction,shortcut,verbatim){this.items.push([verbatim?labelString:localize(labelString),action===0?0:action||nop,hint,color,bold||false,italic||false,doubleClickAction,shortcut,verbatim])};StagePickerMorph.prototype.popup=function(stage,pos){var scroller;this.setPosition(pos);this.keepWithin(stage);if(this.bottom()>stage.bottom()){scroller=this.scroll();this.bounds.corner.y=stage.bottom()-2;scroller.setHeight(stage.bottom()-scroller.top()-this.edge-2);scroller.adjustScrollBars()}if(this.items.length<1&&!this.title){return}stage.add(this);this.fullChanged()};StagePickerMorph.prototype.createLabel=function(){var text;if(this.label!==null){this.label.destroy()}text=new TextMorph(this.title,SpriteMorph.prototype.bubbleFontSize*this.scale,null,true,false,"center");text.alignment="center";text.color=WHITE;text.backgroundColor=this.borderColor;text.fixLayout();text.setWidth(Math.min(text.width(),SpriteMorph.prototype.bubbleMaxTextWidth*this.scale*2));this.label=new BoxMorph(this.edge,0);this.label.color=this.borderColor;this.label.borderColor=this.borderColor;this.label.outlinePath=function(ctx,corner,inset){var w=this.width(),h=this.height(),radius=Math.min(corner,(Math.min(w,h)-inset)/2),offset=radius+inset;ctx.arc(offset,offset,radius,radians(-180),radians(-90),false);ctx.arc(w-offset,offset,radius,radians(-90),radians(-0),false);ctx.lineTo(w,h);ctx.lineTo(0,h)};this.label.setExtent(text.extent().add(this.edge));this.label.add(text);this.label.text=text};StagePickerMorph.prototype.createItems=function(scale){var item,x,y,isLine=false;this.scale=scale;this.children.forEach(m=>m.destroy());this.children=[];this.edge=SyntaxElementMorph.prototype.rounding*this.scale;this.border=SpriteMorph.prototype.bubbleBorder*this.scale;this.color=WHITE;this.borderColor=SpriteMorph.prototype.blockColor.sensing;this.setExtent(new Point(0,0));y=this.border;x=this.left()+this.border;if(this.title){this.createLabel();this.label.setPosition(this.bounds.origin);this.add(this.label);y=this.label.bottom()}else{y=this.top()+this.edge}y+=1;this.items.forEach(tuple=>{isLine=false;if(tuple[0]===0){isLine=true;item=new Morph;item.color=this.borderColor;item.setHeight(tuple[1]*this.scale)}else{item=new StagePickerItemMorph(this.target,tuple[1],tuple[0]instanceof Array?[this.dataRepresentation(tuple[0][0]),tuple[0][1]]:this.dataRepresentation(tuple[0]),SpriteMorph.prototype.bubbleFontSize*this.scale,null,this.environment,tuple[2],tuple[3],tuple[4],tuple[5],tuple[6],tuple[7],this.scale)}if(isLine){y+=1}item.setPosition(new Point(x,y));this.add(item);y=y+item.height();if(isLine){y+=1}});this.adjustWidths();this.setExtent(this.fullBounds().extent().add(new Point(this.border,this.edge)));if(this.label){this.label.setWidth(this.width());this.label.text.setPosition(this.label.center().subtract(this.label.text.extent().floorDivideBy(2)))}};StagePickerMorph.prototype.maxWidth=function(){var w=0;if(this.parent instanceof FrameMorph){if(this.parent.scrollFrame instanceof ScrollFrameMorph){w=this.parent.scrollFrame.width()}}this.children.forEach(item=>{if(item instanceof MenuItemMorph){w=Math.max(w,item.label.width()+this.edge+(item.shortcut?item.shortcut.width()+this.border:0))}});if(this.label){w=Math.max(w,this.label.width()-this.border)}return w};StagePickerMorph.prototype.adjustWidths=function(){var w=this.maxWidth();this.children.forEach(item=>{item.setWidth(w);item.fixLayout()})};StagePickerMorph.prototype.destroy=function(){MenuMorph.uber.destroy.call(this)};StagePickerMorph.prototype.closeSubmenu=function(){if(this.submenu){this.submenu.destroy();this.submenu=null;this.unselectAllItems()}};StagePickerMorph.prototype.rootMenu=function(){return this.parent instanceof StagePickerMorph?this.parent.rootMenu():this};StagePickerItemMorph.prototype=new MenuItemMorph;StagePickerItemMorph.prototype.constructor=StagePickerItemMorph;StagePickerItemMorph.uber=MenuItemMorph.prototype;function StagePickerItemMorph(target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction,shortcut,scale){this.shortcutString=shortcut||null;this.shortcut=null;this.scale=scale||1;this.init(target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction);this.highlightColor=SpriteMorph.prototype.blockColor.sensing.lighter(75);this.pressColor=SpriteMorph.prototype.blockColor.sensing.lighter(25);if(this.shortcut){this.shortcut.setColor(SpriteMorph.prototype.blockColor.sensing)}}StagePickerItemMorph.prototype.createLabelString=function(string){var lbl=new TextMorph(string,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic);lbl.setWidth(Math.min(lbl.width(),SpriteMorph.prototype.bubbleMaxTextWidth*this.scale*2));lbl.setColor(this.labelColor);return lbl};StagePickerItemMorph.prototype.popUpSubmenu=function(){var menu=this.parentThatIsA(MenuMorph),stage=this.parentThatIsA(StageMorph),scroller;if(!(this.action instanceof MenuMorph)){return}this.action.createItems(menu.scale);this.action.setPosition(this.topRight().subtract(new Point(0,5)));this.action.keepWithin(stage);if(this.action.items.length<1&&!this.action.title){return}if(this.action.bottom()>stage.bottom()){scroller=this.action.scroll();this.action.bounds.corner.y=stage.bottom()-2;scroller.setHeight(stage.bottom()-scroller.top()-this.action.edge-2);scroller.adjustScrollBars()}menu.add(this.action);menu.submenu=this.action;this.action.fullChanged()};</script>
        <script>modules.scenes="2022-March-04";function Project(scenes,current){var projectScene;this.scenes=scenes||new List;this.currentScene=current;this.name=null;this.notes=null;this.thumbnail=null;projectScene=this.scenes.at(1);if(projectScene){this.name=projectScene.name;this.notes=projectScene.notes;this.thumbnail=normalizeCanvas(projectScene.stage.thumbnail(SnapSerializer.prototype.thumbnailSize))}this.sceneIdx=null;this.trash=[]}Project.prototype.initialize=function(){this.currentScene=this.scenes.at(+this.sceneIdx||1);return this};Project.prototype.addDefaultScene=function(){var scene=new Scene;scene.addDefaultSprite();this.scenes.add(scene)};function Scene(aStageMorph){this.name="";this.notes="";this.globalVariables=aStageMorph?aStageMorph.globalVariables():new VariableFrame;this.stage=aStageMorph||new StageMorph(this.globalVariables);this.hasUnsavedEdits=false;this.unifiedPalette=false;this.showCategories=true;this.showPaletteButtons=true;this.sprites=new List;this.currentSprite=null;this.hiddenPrimitives={};this.codeMappings={};this.codeHeaders={};this.customCategories=new Map;this.enableCodeMapping=false;this.enableInheritance=true;this.enableSublistIDs=false;this.enablePenLogging=false;this.useFlatLineEnds=false;this.enableLiveCoding=false;this.enableHyperOps=true;this.disableClickToRun=false;this.penColorModel="hsv";this.spritesDict={};this.targetStage=null;this.spriteIdx=null;this.trash=[]}Scene.prototype.initialize=function(){var objs=this.stage.children.filter(child=>child instanceof SpriteMorph);objs.sort((x,y)=>x.idx-y.idx);this.sprites=new List(objs);if(this.spriteIdx===null&&this.sprites.length()>0){this.currentSprite=this.sprites.at(1)}else if(this.spriteIdx===0){this.currentSprite=this.stage}else{this.currentSprite=this.sprites.at(this.spriteIdx)||this.stage}return this};Scene.prototype.addDefaultSprite=function(){var sprite=new SpriteMorph(this.globalVariables);sprite.setPosition(this.stage.center().subtract(sprite.extent().divideBy(2)));this.stage.add(sprite);this.sprites.add(sprite);this.currentSprite=sprite;return sprite};Scene.prototype.captureGlobalSettings=function(){this.hiddenPrimitives=StageMorph.prototype.hiddenPrimitives;this.codeMappings=StageMorph.prototype.codeMappings;this.codeHeaders=StageMorph.prototype.codeHeaders;this.enableCodeMapping=StageMorph.prototype.enableCodeMapping;this.enableInheritance=StageMorph.prototype.enableInheritance;this.enableSublistIDs=StageMorph.prototype.enableSublistIDs;this.enablePenLogging=StageMorph.prototype.enablePenLogging;this.useFlatLineEnds=SpriteMorph.prototype.useFlatLineEnds;this.enableLiveCoding=Process.prototype.enableLiveCoding;this.enableHyperOps=Process.prototype.enableHyperOps;this.customCategories=SpriteMorph.prototype.customCategories;this.disableClickToRun=ThreadManager.prototype.disableClickToRun;this.penColorModel=SpriteMorph.prototype.penColorModel};Scene.prototype.applyGlobalSettings=function(){Costume.prototype.maxDimensions=this.stage.dimensions;StageMorph.prototype.hiddenPrimitives=this.hiddenPrimitives;StageMorph.prototype.codeMappings=this.codeMappings;StageMorph.prototype.codeHeaders=this.codeHeaders;StageMorph.prototype.enableCodeMapping=this.enableCodeMapping;StageMorph.prototype.enableInheritance=this.enableInheritance;StageMorph.prototype.enableSublistIDs=this.enableSublistIDs;StageMorph.prototype.enablePenLogging=this.enablePenLogging;SpriteMorph.prototype.useFlatLineEnds=this.useFlatLineEnds;Process.prototype.enableLiveCoding=this.enableLiveCoding;Process.prototype.enableHyperOps=this.enableHyperOps;SpriteMorph.prototype.customCategories=this.customCategories;ThreadManager.prototype.disableClickToRun=this.disableClickToRun;SpriteMorph.prototype.penColorModel=this.penColorModel};Scene.prototype.updateTrash=function(){this.trash=this.trash.filter(sprite=>sprite.isCorpse)};Scene.prototype.stop=function(forGood){var ide;if(this.stage.enableCustomHatBlocks||forGood){this.stage.threads.pauseCustomHatBlocks=forGood?true:!this.stage.threads.pauseCustomHatBlocks}else{this.stage.threads.pauseCustomHatBlocks=false}this.stage.stopAllActiveSounds();this.stage.threads.resumeAll(this.stage);this.stage.keysPressed={};this.stage.runStopScripts();this.stage.threads.stopAll();if(this.stage.projectionSource){this.stage.stopProjection()}this.stage.children.forEach(morph=>{if(morph.stopTalking){morph.stopTalking()}});this.stage.removeAllClones();ide=this.stage.parentThatIsA(IDE_Morph);if(ide){ide.controlBar.pauseButton.refresh();ide.controlBar.stopButton.refresh()}};</script>
        <script>modules.gui="2022-August-04";var SnapVersion="8.0.0";var IDE_Morph;var ProjectDialogMorph;var LibraryImportDialogMorph;var SpriteIconMorph;var CostumeIconMorph;var TurtleIconMorph;var WardrobeMorph;var SoundIconMorph;var JukeboxMorph;var SceneIconMorph;var SceneAlbumMorph;var StageHandleMorph;var PaletteHandleMorph;var CamSnapshotDialogMorph;var SoundRecorderDialogMorph;IDE_Morph.prototype=new Morph;IDE_Morph.prototype.constructor=IDE_Morph;IDE_Morph.uber=Morph.prototype;IDE_Morph.prototype.setDefaultDesign=function(){MorphicPreferences.isFlat=false;SpriteMorph.prototype.paletteColor=new Color(30,30,30);SpriteMorph.prototype.paletteTextColor=new Color(230,230,230);StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor;StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor;SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30);IDE_Morph.prototype.buttonContrast=30;IDE_Morph.prototype.backgroundColor=new Color(10,10,10);IDE_Morph.prototype.frameColor=SpriteMorph.prototype.paletteColor;IDE_Morph.prototype.groupColor=SpriteMorph.prototype.paletteColor.lighter(5);IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor;IDE_Morph.prototype.buttonLabelColor=WHITE;IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.darker(50),IDE_Morph.prototype.groupColor.darker(25),IDE_Morph.prototype.groupColor];IDE_Morph.prototype.rotationStyleColors=IDE_Morph.prototype.tabColors;IDE_Morph.prototype.appModeColor=BLACK;IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture();IDE_Morph.prototype.padding=1;SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;SceneIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;SyntaxElementMorph.prototype.contrast=65;ScriptsMorph.prototype.feedbackColor=WHITE};IDE_Morph.prototype.setFlatDesign=function(){MorphicPreferences.isFlat=true;SpriteMorph.prototype.paletteColor=WHITE;SpriteMorph.prototype.paletteTextColor=new Color(70,70,70);StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor;StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor;SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor;IDE_Morph.prototype.buttonContrast=30;IDE_Morph.prototype.backgroundColor=new Color(220,220,230);IDE_Morph.prototype.frameColor=new Color(240,240,245);IDE_Morph.prototype.groupColor=WHITE;IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor;IDE_Morph.prototype.buttonLabelColor=new Color(70,70,70);IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor.lighter(50),IDE_Morph.prototype.groupColor];IDE_Morph.prototype.rotationStyleColors=IDE_Morph.prototype.tabColors;IDE_Morph.prototype.appModeColor=IDE_Morph.prototype.frameColor;IDE_Morph.prototype.scriptsPaneTexture=null;IDE_Morph.prototype.padding=1;SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;SceneIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;SyntaxElementMorph.prototype.contrast=25;ScriptsMorph.prototype.feedbackColor=new Color(153,255,213)};IDE_Morph.prototype.scriptsTexture=function(){var pic=newCanvas(new Point(100,100)),ctx=pic.getContext("2d"),i;for(i=0;i<100;i+=4){ctx.fillStyle=this.frameColor.toString();ctx.fillRect(i,0,1,100);ctx.fillStyle=this.groupColor.lighter(2).toString();ctx.fillRect(i+1,0,1,100);ctx.fillRect(i+3,0,1,100);ctx.fillStyle=this.groupColor.darker(2).toString();ctx.fillRect(i+2,0,1,100)}return pic};IDE_Morph.prototype.setFlatDesign();function IDE_Morph(isAutoFill){this.init(isAutoFill)}IDE_Morph.prototype.init=function(isAutoFill){MorphicPreferences.globalFontFamily="Helvetica, Arial";this.userLanguage=null;this.applySavedSettings();this.cloud=new Cloud;this.cloudMsg=null;this.source=null;this.serializer=new SnapSerializer;this.scenes=new List([new Scene]);this.scene=this.scenes.at(1);this.isAddingScenes=false;this.isAddingNextScene=false;this.globalVariables=this.scene.globalVariables;this.currentSprite=this.scene.addDefaultSprite();this.sprites=this.scene.sprites;this.currentCategory=this.scene.unifiedPalette?"unified":"motion";this.currentTab="scripts";this.logo=null;this.controlBar=null;this.categories=null;this.palette=null;this.paletteHandle=null;this.spriteBar=null;this.spriteEditor=null;this.stage=null;this.stageHandle=null;this.corralBar=null;this.corral=null;this.embedPlayButton=null;this.embedOverlay=null;this.isEmbedMode=false;this.isAutoFill=isAutoFill===undefined?true:isAutoFill;this.isAppMode=false;this.isSmallStage=false;this.filePicker=null;this.hasChangedMedia=false;this.isAnimating=true;this.paletteWidth=200;this.stageRatio=1;this.wasSingleStepping=false;this.loadNewProject=false;this.shield=null;this.savingPreferences=true;this.bulkDropInProgress=false;this.cachedSceneFlag=null;this.isImportingLocalFile=false;IDE_Morph.uber.init.call(this);this.color=this.backgroundColor};IDE_Morph.prototype.openIn=function(world){var hash,myself=this;function initUser(username){sessionStorage.username=username;myself.controlBar.cloudButton.refresh();if(username){myself.source="cloud";if(!myself.cloud.verified){(new DialogBoxMorph).inform("Unverified account","Your account is still unverified.\n"+"Please use the verification link that\n"+"was sent to your email address when you\n"+"signed up.\n\n"+"If you cannot find that email, please\n"+"check your spam folder. If you still\n"+'cannot find it, please use the "Resend\n'+'Verification Email..." option in the cloud\n'+"menu.",world,myself.cloudIcon(null,new Color(0,180,0)))}}}this.buildPanes();world.add(this);world.userMenu=this.userMenu;this.cloud.message=string=>{var m=new MenuMorph(null,string),intervalHandle;m.popUpCenteredInWorld(world);intervalHandle=setInterval(()=>{m.destroy();clearInterval(intervalHandle)},2e3)};world.reactToDropOf=morph=>{if(!(morph instanceof DialogBoxMorph||morph instanceof MenuMorph)){if(world.hand.grabOrigin){morph.slideBackTo(world.hand.grabOrigin)}else{world.hand.grab(morph)}}};this.reactToWorldResize(world.bounds);function applyFlags(dict){if(dict.noCloud){myself.cloud.disable()}if(dict.embedMode){myself.setEmbedMode()}if(dict.editMode){myself.toggleAppMode(false)}else{myself.toggleAppMode(true)}if(!dict.noRun){autoRun()}if(dict.hideControls){myself.controlBar.hide();window.onbeforeunload=nop}if(dict.noExitWarning){window.onbeforeunload=nop}if(dict.blocksZoom){myself.savingPreferences=false;myself.setBlocksScale(Math.max(1,Math.min(dict.blocksZoom,12)));myself.savingPreferences=true}if(!myself.isEmbedMode){world.worldCanvas.focus()}}function autoRun(){if(isLoadingAssets()){myself.world().animations.push(new Animation(nop,nop,0,200,nop,autoRun))}else{myself.runScripts()}}function isLoadingAssets(){return myself.sprites.asArray().concat([myself.stage]).some(any=>(any.costume?any.costume.loaded!==true:false)||any.costumes.asArray().some(each=>each.loaded!==true)||any.sounds.asArray().some(each=>each.loaded!==true))}function interpretUrlAnchors(){var dict,idx;if(location.hash.substr(0,6)==="#open:"){hash=location.hash.substr(6);if(hash.charAt(0)==="%"||hash.search(/\%(?:[0-9a-f]{2})/i)>-1){hash=decodeURIComponent(hash)}if(contains(["project","blocks","sprites","snapdata"].map(each=>hash.substr(0,8).indexOf(each)),1)){this.droppedText(hash)}else{idx=hash.indexOf("&");if(idx>0){dict=myself.cloud.parseDict(hash.substr(idx));dict.editMode=true;hash=hash.slice(0,idx);applyFlags(dict)}this.shield=new Morph;this.shield.alpha=0;this.shield.setExtent(this.parent.extent());this.parent.add(this.shield);this.showMessage("Fetching project...");this.getURL(hash,projectData=>{var msg;this.nextSteps([()=>msg=this.showMessage("Opening project..."),()=>{if(projectData.indexOf("<snapdata")===0){this.rawOpenCloudDataString(projectData)}else if(projectData.indexOf("<project")===0){this.rawOpenProjectString(projectData)}this.hasChangedMedia=true},()=>{this.shield.destroy();this.shield=null;msg.destroy();this.toggleAppMode(false)}])})}}else if(location.hash.substr(0,5)==="#run:"){dict="";hash=location.hash.substr(5);if(hash.charAt(0)==="%"||hash.search(/\%(?:[0-9a-f]{2})/i)>-1){hash=decodeURIComponent(hash)}idx=hash.indexOf("&");if(hash.substr(0,8)==="<project"){this.rawOpenProjectString(hash.slice(0,hash.indexOf("</project>")+10));applyFlags(myself.cloud.parseDict(hash.substr(hash.indexOf("</project>")+10)))}else if(idx==0){applyFlags(myself.cloud.parseDict(hash))}else{this.shield=new Morph;this.shield.alpha=0;this.shield.setExtent(this.parent.extent());this.parent.add(this.shield);this.showMessage("Fetching project...");if(idx>0){dict=myself.cloud.parseDict(hash.substr(idx));hash=hash.slice(0,idx)}this.getURL(hash,projectData=>{var msg;this.nextSteps([()=>msg=this.showMessage("Opening project..."),()=>{if(projectData.indexOf("<snapdata")===0){this.rawOpenCloudDataString(projectData)}else if(projectData.indexOf("<project")===0){this.rawOpenProjectString(projectData)}this.hasChangedMedia=true},()=>{this.shield.destroy();this.shield=null;msg.destroy();applyFlags(dict)}])})}}else if(location.hash.substr(0,9)==="#present:"){this.shield=new Morph;this.shield.color=this.color;this.shield.setExtent(this.parent.extent());this.parent.add(this.shield);myself.showMessage("Fetching project\nfrom the cloud...");dict=myself.cloud.parseDict(location.hash.substr(9));dict.Username=dict.Username.toLowerCase();myself.cloud.getPublicProject(dict.ProjectName,dict.Username,projectData=>{var msg;myself.nextSteps([()=>msg=myself.showMessage("Opening project..."),()=>{if(projectData.indexOf("<snapdata")===0){myself.rawOpenCloudDataString(projectData)}else if(projectData.indexOf("<project")===0){myself.rawOpenProjectString(projectData)}myself.hasChangedMedia=true},()=>{myself.shield.destroy();myself.shield=null;msg.destroy();applyFlags(dict)}])},this.cloudError())}else if(location.hash.substr(0,7)==="#cloud:"){this.shield=new Morph;this.shield.alpha=0;this.shield.setExtent(this.parent.extent());this.parent.add(this.shield);myself.showMessage("Fetching project\nfrom the cloud...");dict=myself.cloud.parseDict(location.hash.substr(7));myself.cloud.getPublicProject(dict.ProjectName,dict.Username,projectData=>{var msg;myself.nextSteps([()=>msg=myself.showMessage("Opening project..."),()=>{if(projectData.indexOf("<snapdata")===0){myself.rawOpenCloudDataString(projectData)}else if(projectData.indexOf("<project")===0){myself.rawOpenProjectString(projectData)}myself.hasChangedMedia=true},()=>{myself.shield.destroy();myself.shield=null;msg.destroy();myself.toggleAppMode(false)}])},this.cloudError())}else if(location.hash.substr(0,4)==="#dl:"){myself.showMessage("Fetching project\nfrom the cloud...");dict=myself.cloud.parseDict(location.hash.substr(4));dict.Username=dict.Username.toLowerCase();myself.cloud.getPublicProject(dict.ProjectName,dict.Username,projectData=>{myself.saveXMLAs(projectData,dict.ProjectName);myself.showMessage("Saved project\n"+dict.ProjectName,2)},this.cloudError())}else if(location.hash.substr(0,6)==="#lang:"){dict=myself.cloud.parseDict(location.hash.substr(6));applyFlags(dict)}else if(location.hash.substr(0,7)==="#signup"){this.createCloudAccount()}this.loadNewProject=false}function launcherLangSetting(){var langSetting=null;if(location.hash.substr(0,6)==="#lang:"){if(location.hash.charAt(8)==="_"){langSetting=location.hash.slice(6,11)}else{langSetting=location.hash.slice(6,8)}}langSetting=myself.cloud.parseDict(location.hash).lang||langSetting;return langSetting}if(launcherLangSetting()){this.loadNewProject=true;this.setLanguage(launcherLangSetting(),interpretUrlAnchors,true)}else if(this.userLanguage){this.loadNewProject=true;this.setLanguage(this.userLanguage,interpretUrlAnchors)}else{interpretUrlAnchors.call(this)}if(location.protocol!=="file:"){if(!sessionStorage.username){this.cloud.initSession(initUser)}else{this.cloud.checkCredentials(initUser)}}world.keyboardFocus=this.stage;this.warnAboutIE();this.warnAboutDev()};IDE_Morph.prototype.buildPanes=function(){this.createLogo();this.createControlBar();this.createCategories();this.createPalette();this.createStage();this.createSpriteBar();this.createSpriteEditor();this.createCorralBar();this.createCorral()};IDE_Morph.prototype.createLogo=function(){var myself=this;if(this.logo){this.logo.destroy()}this.logo=new Morph;this.logo.texture="data:image/png;base64,"+"iVBORw0KGgoAAAANSUhEUgAAACwAAAAYCAYAAACBbx+6AAAKiklEQVRYR5VXe3BU5RX/"+"ne+7924SwiOEJJvwUCAgCZFBEtRatIlVlATLIwlFsCgdeYWICu1MfbKUabVVtBoDQlUc"+"FCubEIpAAEUTrGhFGIXAAjZCFdhNQiTkQbK7997vdO7SREAo9P5zZ77HOb9zzu87D8JV"+"fOyBwGIwEdg5XrcmKRExcoSCNQKgWwXRTYKQDAKUQi1DbASrjzgsdqdM8zc6d6o80LIB"+"RR6oq1B52SN0pcteL+SUKbCdcw3lCUMsof2amAs0iVRNEoIhZYKoCcTtYBARxUUZ1IMZ"+"CIZxWDG9oVSv1/tP8Z12ZHAVNMqBdSW9l9uPAGYGoQwicqjQUQsmZ9kLSf8FGyhzzyCB"+"P8X1kO7TLaoREJuIxCeSzKNhWzRbKhgyRCwJZfcA2UOY+E4QTewZK2Ob2tQhIl6cPLmu"+"LKLPC+n8O2X/P+CJAXLAXXzpfLD+sqRHesaKF5vbHZtil4bCA98YeO+2f19J0Yl3+wzV"+"DH0GMz8cE0WxHSH8DZrxhPsX3x7rBO5YUFgI1Um3y8r0sCg8WOZgBQ54YPTJGNCPgehw"+"qNl/zfTmJoe3Dt9OeN15LgObTUs/JNB9prvA9/mljNvblCkyh+7l6p3AxVxt2JiQalty"+"IYB5AL5n5qWh1vqVA2cieCWjz+07AXd8C+eZAP71SY8Q6JlzfuajDPFMSkHg7brtSd1w"+"Vr2hVIymxX97f2IO2nCPP2be0EDaWZuMVttoP2tGBd5/dfCpToHnKMZUvWSJzP5ZNSin"+"uouv9RXX/MRW9lMgHkekaqCsVZDmZnfD4JMI7LXPPUgHXATaBVEvLDrg7tBgRDbrK9wz"+"GHwnM0Xrmsg3bT4eC5XV2FzfYnS/fkzK9zU7aQ7MXxbvnxkk8UhYUTcGTGJyMsM/Okw5"+"s3rVdY2Zs/foe1MyIw8UHjA8oCosEUA1cjw/AA94M/KUMOcQBW8gsptYuXYpa8Cr/aZW"+"7Sss9Mrhw33swWJkV1eL6uoc6wFPVVRDo3stmDN/xOFAed95EHYps7o/Jb/hrc6QTXt0"+"/4QzYa1Egd7TyCq3WEgBGkggMyGhbt2bnpyrDO8PJDizAYPbbS21Tw+rXk+BjzIQvhRF"+"8ub6MlhiF4h6dKU1J1M4xD+xvnc/CaMKpN5LntywqHM9d77vrwCNrCxNG32x0Oxs1lzp"+"vmtdQVnfe0DArGvsczNskUAaareWDP/SOT+2qKa/DkrtLu14k8HrW+JrsKbf1xFZN3ES"+"khrbJ7tPxYYMMRpsxQi4ajaVDjnobI8vrslWLLc6186lNYBqX041hiyoDR339ovWNGs7"+"GA3J+XUFneDGFft+T4zfCsYDm5enrzsfdF7R12lM1jsAfcPgNmJkMqE3AfEMWqYTlVpK"+"vcDAbSCcEUCcIO6jSyzWSW04a8rXmGAw4yQYg5nQkxi9GHhu6/L0pbnzfbcxoZIUFXd5"+"2KlEOR5Yfm/cACFduxnCl5zvv70TWN68/YNYauVSi77BNjs2CmDVQKF/WFIyJPTzh48m"+"GVbwCwK6E+MJJtpBLKUi+1kC3wNShbaF40KDrkM7FrQ0S5PmsyCMd5xAzHMVYRgzzbCV"+"/jkb4Z66En/WpGuisjryFIkGsFqrWN0XAXx+NQuUpyyJ70VPnz5jfapc7RNS7mltXLly"+"tj5nzipzbPG+gTrrTzIwQ2guTZmhHUoXxdteGnYkd/6hfUR8cMsr6dM6jcwt+nokkbkL"+"JBdseWXY6+dH5a6iw3dLUiuYsQJEPwXQurU07b7OM3c9ery3DLceAdHHgvl1xVQYIvzG"+"AUzshXCqTsP65NtsxioQWgAVw2w/kFLQuGfPykw9a84eqzPV3D2vZgQJ7UEp9YfYDtXa"+"mhwvLHs5QTRvKU2b3AW4+ND1YOwQQi3cXDJ8be78QwsZGCXAUgFDCdRPET8uGGMBiqlM"+"WDcBHo9yMkVZ2RQ7d75vEzMGMMmFUqqO0b2H/dMBGym/zBB1Fe6PwBAgvAxgBYMWpuQH"+"3nLq/5KdrA42f+Y69WXIdFKNA2pcsW+iYLzDjBIQZwHUWlmaNqnTsNzimiywtoFhL2PI"+"YQTOZfDbAH1B4CwCTSfiJxXTHQTun5gQk/emZ2Aw3XPA8HkywuOKfZXElFJZmjYykik9"+"LLrSWl1F0iyXIVaFgmqa5rI+NsO680LXJufXzedIo3ZhIv/Bi75qAvwMpEChrnJ52r1d"+"kSg6MlqStYZBxwFKZ4XpW1ek7XTuTiiq6W+SfA/Ez4FxB0EkbylNG3fem4ljoR1hoFLY"+"eJ50Kdtq/AcjHG7cFN/XDOu7AWpOzg+kH/DCiJdJXzFLocX7s5wK9+CivZnfne3WM0rD"+"4ZYwhWO7dbjskD6VSPwOij1MmE2E+srS9LFdmWXu4dtJU2VgOgxgqFDqKc0V827YDCaC"+"uIgYs1hxMQTdAubbFctJ21YM2z95ti85aGA5gFGsuISIHgNwshurWyKAAxXJy7q5sLA1"+"qGb1za9/zVnzlyeu6h7TbdbZjmNT3flYN3XBvj+22noRA8cY6CBCFJgSFdQaM6ReMlyi"+"nEDHKkvTZ3R5f77vTmIuZYlXSNEoEPKZcRiMehAsJ4URsEIJSiPmOQT+EKAWJhoEcIKm"+"xFxbKottVICwrrI0fTY5Pa5N8iunh2i3w2MGT2lqdhTWlSWNj4kxNp0Nth8Qoe/vSCph"+"c2rWgYk2EE8gYZNqs1l88feSjN0RPj908AZlo3X78uG1nYBnPHYoHh0dQweh+ZCzdgjx"+"eU5B0Q0+2MduOtAsY+Paw3qo1daeAXFSFJnLJIm+LIi6a+Hq1ctG+bwvfBq97pueg4TR"+"42jZi/07KFDh9ib20gpPnbH/4J4ceHLPSuhZc2AeW31tVFT34Fp3ojE50Gi9n5zqn0oj"+"0HSp0nmpNY/HIzwez1VNF+OLD35gM4W3lqbn/W/5TBRYn7iISPaxFXn7Fvi/9Hgg0tNB"+"zpRR571mIMtgSbcokXe2PcavKLaCYR4DFBT1qvWfnFZ984IFLU4rugRVoroaqKrKsZ0e"+"0OmxT3qzrlOC7pZojmbWmcggWylACNh2nBYb9VG4LTy9ZuqOJY/31my9dMziF3vGvDug"+"pSPb0GWzBdkEwWSdbs/aOPxXZZHIXTAidTbzzj9Srwns35QSgzDfJdjKBon+DM1m5gwi"+"dAjhL0yahG/+VZnqSt1dazoC9yZDZs6G5dwNbEhcBIXHAdpFZCu2NQ0kmahdWZyoubQj"+"aLMmbc/Z9pdR6a4Qv5bzYK2ufTwmZGUoTXxnsooxGByWetPTSRPC+yN9zeVC4OBd4gF5"+"zhsanUY/w4PwiQ19R0plvQWmpckFdd7Lyagrd29i4Nvkgrpix/DTHaboHa1HaCKMDFLh"+"9/lIo0c9/dmUOKkpXj36+TOuPm+KU8ZYSggfYGHYpMKSP+nwhzrnSnLCWZYOutyYEpm/"+"fOCLp9268uQXQOpGZnKKTBtLinaYAgJJojZWfCsDBSTlFPfEEzVXy/3/5UCHZlecmh0B"+"jrfLvBAJPlC/G1PlkNza0OkP4noGW4zVhkaTTAsWsTNnkDP02XSu82oTTPOSCgJvOw85"+"0xE09MezY9mpQp7i87IHwOJ0IiRcSNOIAdkRmZEJ5D9/VBCtnsd7nAAAAABJRU5ErkJg"+"gg==";this.logo.render=function(ctx){var gradient=ctx.createLinearGradient(0,0,this.width(),0);gradient.addColorStop(0,"black");gradient.addColorStop(.5,myself.frameColor.toString());ctx.fillStyle=MorphicPreferences.isFlat?myself.frameColor.toString():gradient;ctx.fillRect(0,0,this.width(),this.height());if(this.cachedTexture){this.renderCachedTexture(ctx)}else if(this.texture){this.renderTexture(this.texture,ctx)}};this.logo.renderCachedTexture=function(ctx){ctx.drawImage(this.cachedTexture,5,Math.round((this.height()-this.cachedTexture.height)/2));this.changed()};this.logo.mouseClickLeft=function(){myself.snapMenu()};this.logo.color=BLACK;this.logo.setExtent(new Point(200,28));this.add(this.logo)};IDE_Morph.prototype.createControlBar=function(){var padding=5,button,slider,stopButton,pauseButton,startButton,projectButton,settingsButton,stageSizeButton,appModeButton,steppingButton,cloudButton,x,colors=MorphicPreferences.isFlat?this.tabColors:[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)],activeColor=new Color(153,255,213),activeColors=[activeColor,activeColor.lighter(40),activeColor.lighter(40)],myself=this;if(this.controlBar){this.controlBar.destroy()}this.controlBar=new Morph;this.controlBar.color=this.frameColor;this.controlBar.setHeight(this.logo.height());this.controlBar.mouseClickLeft=function(){this.world().fillPage()};this.add(this.controlBar);button=new ToggleButtonMorph(null,this,"toggleStageSize",[new SymbolMorph("smallStage",14),new SymbolMorph("normalStage",14)],()=>this.isSmallStage);button.hasNeutralBackground=true;button.corner=12;button.color=colors[0];button.highlightColor=colors[1];button.pressColor=colors[0];button.labelMinExtent=new Point(36,18);button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.labelColor=MorphicPreferences.isFlat?WHITE:this.buttonLabelColor;button.contrast=this.buttonContrast;button.fixLayout();button.refresh();stageSizeButton=button;this.controlBar.add(stageSizeButton);this.controlBar.stageSizeButton=button;button=new ToggleButtonMorph(null,this,"toggleAppMode",[new SymbolMorph("fullScreen",14),new SymbolMorph("normalScreen",14)],()=>this.isAppMode);button.hasNeutralBackground=true;button.corner=12;button.color=colors[0];button.highlightColor=colors[1];button.pressColor=colors[0];button.labelMinExtent=new Point(36,18);button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.labelColor=this.buttonLabelColor;button.contrast=this.buttonContrast;button.fixLayout();button.refresh();appModeButton=button;this.controlBar.add(appModeButton);this.controlBar.appModeButton=appModeButton;button=new ToggleButtonMorph(null,this,"toggleSingleStepping",[new SymbolMorph("footprints",16),new SymbolMorph("footprints",16)],()=>Process.prototype.enableSingleStepping);button.corner=12;button.color=colors[0];button.highlightColor=colors[1];button.pressColor=activeColor;button.labelMinExtent=new Point(36,18);button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.labelColor=this.buttonLabelColor;button.contrast=this.buttonContrast;button.hint="Visible stepping";button.fixLayout();button.refresh();steppingButton=button;this.controlBar.add(steppingButton);this.controlBar.steppingButton=steppingButton;button=new ToggleButtonMorph(null,this,"stopAllScripts",[new SymbolMorph("octagon",14),new SymbolMorph("square",14)],()=>this.stage?myself.stage.enableCustomHatBlocks&&myself.stage.threads.pauseCustomHatBlocks:true);button.corner=12;button.color=colors[0];button.highlightColor=colors[1];button.pressColor=colors[2];button.labelMinExtent=new Point(36,18);button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.labelColor=new Color(MorphicPreferences.isFlat?128:200,0,0);button.contrast=this.buttonContrast;button.fixLayout();button.refresh();stopButton=button;this.controlBar.add(stopButton);this.controlBar.stopButton=stopButton;button=new ToggleButtonMorph(null,this,"togglePauseResume",[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)],()=>this.isPaused());button.hasNeutralBackground=true;button.corner=12;button.color=colors[0];button.highlightColor=colors[1];button.pressColor=colors[0];button.labelMinExtent=new Point(36,18);button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.labelColor=MorphicPreferences.isFlat?new Color(220,185,0):new Color(255,220,0);button.contrast=this.buttonContrast;button.fixLayout();button.refresh();pauseButton=button;this.controlBar.add(pauseButton);this.controlBar.pauseButton=pauseButton;button=new PushButtonMorph(this,"pressStart",new SymbolMorph("flag",14));button.corner=12;button.color=colors[0];button.highlightColor=colors[1];button.pressColor=colors[2];button.labelMinExtent=new Point(36,18);button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.fps=4;button.isActive=false;button.step=function(){var isRunning;if(!myself.stage){return}isRunning=!!myself.stage.threads.processes.length;if(isRunning===this.isActive){return}this.isActive=isRunning;if(isRunning){this.color=activeColors[0];this.highlightColor=activeColors[1];this.pressColor=activeColors[2]}else{this.color=colors[0];this.highlightColor=colors[1];this.pressColor=colors[2]}this.rerender()};button.labelColor=new Color(0,MorphicPreferences.isFlat?100:200,0);button.contrast=this.buttonContrast;button.fixLayout();startButton=button;this.controlBar.add(startButton);this.controlBar.startButton=startButton;slider=new SliderMorph(61,1,Process.prototype.flashTime*100+1,6,"horizontal");slider.action=num=>{Process.prototype.flashTime=(num-1)/100;this.controlBar.refreshResumeSymbol()};slider.color=activeColor;slider.alpha=.3;slider.setExtent(new Point(50,14));this.controlBar.add(slider);this.controlBar.steppingSlider=slider;button=new PushButtonMorph(this,"projectMenu",new SymbolMorph("file",14));button.corner=12;button.color=colors[0];button.highlightColor=colors[1];button.pressColor=colors[2];button.labelMinExtent=new Point(36,18);button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.labelColor=this.buttonLabelColor;button.contrast=this.buttonContrast;button.fixLayout();projectButton=button;this.controlBar.add(projectButton);this.controlBar.projectButton=projectButton;button=new PushButtonMorph(this,"settingsMenu",new SymbolMorph("gears",14));button.corner=12;button.color=colors[0];button.highlightColor=colors[1];button.pressColor=colors[2];button.labelMinExtent=new Point(36,18);button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.labelColor=this.buttonLabelColor;button.contrast=this.buttonContrast;button.fixLayout();settingsButton=button;this.controlBar.add(settingsButton);this.controlBar.settingsButton=settingsButton;button=new ToggleButtonMorph(null,this,"cloudMenu",[new SymbolMorph("cloudOutline",11),new SymbolMorph("cloud",11)],()=>!isNil(this.cloud.username));button.hasNeutralBackground=true;button.corner=12;button.color=colors[0];button.highlightColor=colors[1];button.pressColor=colors[0];button.labelMinExtent=new Point(36,18);button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.labelColor=this.buttonLabelColor;button.contrast=this.buttonContrast;button.fixLayout();button.refresh();cloudButton=button;this.controlBar.add(cloudButton);this.controlBar.cloudButton=cloudButton;this.controlBar.fixLayout=function(){x=this.right()-padding;[stopButton,pauseButton,startButton].forEach(button=>{button.setCenter(myself.controlBar.center());button.setRight(x);x-=button.width();x-=padding});x=Math.min(startButton.left()-(3*padding+2*stageSizeButton.width()),myself.right()-myself.stage.dimensions.x*(myself.isSmallStage?myself.stageRatio:1));[stageSizeButton,appModeButton].forEach(button=>{x+=padding;button.setCenter(myself.controlBar.center());button.setLeft(x);x+=button.width()});slider.setCenter(myself.controlBar.center());slider.setRight(stageSizeButton.left()-padding);steppingButton.setCenter(myself.controlBar.center());steppingButton.setRight(slider.left()-padding);settingsButton.setCenter(myself.controlBar.center());settingsButton.setLeft(this.left());projectButton.setCenter(myself.controlBar.center());if(myself.cloud.disabled){cloudButton.hide();projectButton.setRight(settingsButton.left()-padding)}else{cloudButton.setCenter(myself.controlBar.center());cloudButton.setRight(settingsButton.left()-padding);projectButton.setRight(cloudButton.left()-padding)}this.refreshSlider();this.updateLabel()};this.controlBar.refreshSlider=function(){if(Process.prototype.enableSingleStepping&&!myself.isAppMode){slider.fixLayout();slider.rerender();slider.show()}else{slider.hide()}this.refreshResumeSymbol()};this.controlBar.refreshResumeSymbol=function(){var pauseSymbols;if(Process.prototype.enableSingleStepping&&Process.prototype.flashTime>.5){myself.stage.threads.pauseAll(myself.stage);pauseSymbols=[new SymbolMorph("pause",12),new SymbolMorph("stepForward",14)]}else{pauseSymbols=[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)]}pauseButton.labelString=pauseSymbols;pauseButton.createLabel();pauseButton.fixLayout();pauseButton.refresh()};this.controlBar.updateLabel=function(){var prefix=myself.hasUnsavedEdits()?"✎ ":"",suffix=myself.world().isDevMode?" - "+localize("development mode"):"",name,scene,txt;if(this.label){this.label.destroy()}if(myself.isAppMode){return}scene=myself.scenes.at(1)!==myself.scene?" ("+myself.scene.name+")":"";name=myself.getProjectName()||localize("untitled");document.title="Snap! "+(myself.getProjectName()?name:SnapVersion);txt=new StringMorph(prefix+name+scene+suffix,14,"sans-serif",true,false,false,MorphicPreferences.isFlat?null:new Point(2,1),myself.frameColor.darker(myself.buttonContrast));txt.color=myself.buttonLabelColor;this.label=new FrameMorph;this.label.acceptsDrops=false;this.label.alpha=0;txt.setPosition(this.label.position());this.label.add(txt);this.label.setExtent(new Point(steppingButton.left()-settingsButton.right()-padding*2,txt.height()));this.label.setCenter(this.center());this.label.setLeft(this.settingsButton.right()+padding);this.add(this.label)}};IDE_Morph.prototype.createCategories=function(){var myself=this,categorySelectionAction=this.scene.unifiedPalette?scrollToCategory:changePalette,categoryQueryAction=this.scene.unifiedPalette?queryTopCategory:queryCurrentCategory,flag=true;if(this.categories){flag=this.categories.isVisible;this.categories.destroy()}this.categories=new Morph;this.categories.color=this.groupColor;this.categories.bounds.setWidth(this.paletteWidth);this.categories.buttons=[];this.categories.isVisible=flag;this.categories.droppedImage=(aCanvas,name,embeddedData)=>{this.droppedImage(aCanvas,name,embeddedData,"categories")};this.categories.refresh=function(){this.buttons.forEach(cat=>{cat.refresh();if(cat.state){cat.scrollIntoView()}})};this.categories.refreshEmpty=function(){var dict=myself.currentSprite.emptyCategories();dict.variables=dict.variables||dict.lists||dict.other;this.buttons.forEach(cat=>{if(dict[cat.category]){cat.enable()}else{cat.disable()}})};function changePalette(category){return()=>{myself.currentCategory=category;myself.categories.buttons.forEach(each=>each.refresh());myself.refreshPalette(true)}}function scrollToCategory(category){return()=>myself.scrollPaletteToCategory(category)}function queryCurrentCategory(category){return()=>myself.currentCategory===category}function queryTopCategory(category){return()=>myself.topVisibleCategoryInPalette()===category}function addCategoryButton(category){var labelWidth=75,colors=[myself.frameColor,myself.frameColor.darker(MorphicPreferences.isFlat?5:50),SpriteMorph.prototype.blockColor[category]],button;button=new ToggleButtonMorph(colors,myself,categorySelectionAction(category),category[0].toUpperCase().concat(category.slice(1)),categoryQueryAction(category),null,null,labelWidth,true);button.category=category;button.corner=8;button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.labelColor=myself.buttonLabelColor;if(MorphicPreferences.isFlat){button.labelPressColor=WHITE}button.fixLayout();button.refresh();myself.categories.add(button);myself.categories.buttons.push(button);return button}function addCustomCategoryButton(category,color){var labelWidth=168,colors=[myself.frameColor,myself.frameColor.darker(MorphicPreferences.isFlat?5:50),color],button;button=new ToggleButtonMorph(colors,myself,categorySelectionAction(category),category,categoryQueryAction(category),null,null,labelWidth,true);button.category=category;button.corner=8;button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.labelColor=myself.buttonLabelColor;if(MorphicPreferences.isFlat){button.labelPressColor=WHITE}button.fixLayout();button.refresh();myself.categories.add(button);myself.categories.buttons.push(button);return button}function fixCategoriesLayout(){var buttonWidth=myself.categories.children[0].width(),buttonHeight=myself.categories.children[0].height(),more=SpriteMorph.prototype.customCategories.size,border=3,xPadding=(200-border-buttonWidth*2)/3,yPadding=2,l=myself.categories.left(),t=myself.categories.top(),scroller,row,col,i;myself.categories.children.forEach((button,i)=>{row=i<8?i%4:i-4;col=i<4||i>7?1:2;button.setPosition(new Point(l+(col*xPadding+(col-1)*buttonWidth),t+((row+1)*yPadding+row*buttonHeight+border)+(i>7?border+2:0)))});if(more>6){scroller=new ScrollFrameMorph(null,null,myself.sliderColor);scroller.setColor(myself.groupColor);scroller.acceptsDrops=false;scroller.contents.acceptsDrops=false;scroller.setPosition(new Point(0,myself.categories.children[8].top()));scroller.setWidth(myself.paletteWidth);scroller.setHeight(buttonHeight*6+yPadding*5);for(i=0;i<more;i+=1){scroller.addContents(myself.categories.children[8])}myself.categories.add(scroller);myself.categories.scroller=scroller;myself.categories.setHeight((4+1)*yPadding+4*buttonHeight+6*(yPadding+buttonHeight)+border+2+2*border)}else{myself.categories.setHeight((4+1)*yPadding+4*buttonHeight+(more?more*(yPadding+buttonHeight)+border+2:0)+2*border)}}SpriteMorph.prototype.categories.forEach(cat=>{if(!contains(["lists","other"],cat)){addCategoryButton(cat)}});Array.from(SpriteMorph.prototype.customCategories.keys()).sort().forEach(name=>addCustomCategoryButton(name,SpriteMorph.prototype.customCategories.get(name)));fixCategoriesLayout();this.add(this.categories)};IDE_Morph.prototype.createPalette=function(forSearching){var myself=this,vScrollAction;if(this.palette){this.palette.destroy()}if(forSearching){this.palette=new ScrollFrameMorph(null,null,this.currentSprite.sliderColor);this.palette.isForSearching=true}else{this.palette=this.currentSprite.palette(this.currentCategory)}this.palette.isDraggable=false;this.palette.acceptsDrops=true;this.palette.enableAutoScrolling=false;this.palette.contents.acceptsDrops=false;if(this.scene.unifiedPalette){this.palette.adjustScrollBars=function(){ScrollFrameMorph.prototype.adjustScrollBars.call(this);myself.categories.refresh()};vScrollAction=this.palette.vBar.action;this.palette.vBar.action=function(num){vScrollAction(num);myself.categories.buttons.forEach(each=>each.refresh())}}this.palette.reactToDropOf=(droppedMorph,hand)=>{if(droppedMorph instanceof DialogBoxMorph){this.world().add(droppedMorph)}else if(droppedMorph instanceof SpriteMorph){this.removeSprite(droppedMorph)}else if(droppedMorph instanceof SpriteIconMorph){droppedMorph.destroy();this.removeSprite(droppedMorph.object)}else if(droppedMorph instanceof CostumeIconMorph){droppedMorph.perish(myself.isAnimating?200:0)}else if(droppedMorph instanceof BlockMorph){this.stage.threads.stopAllForBlock(droppedMorph);if(hand&&hand.grabOrigin.origin instanceof ScriptsMorph){hand.grabOrigin.origin.clearDropInfo();hand.grabOrigin.origin.lastDroppedBlock=droppedMorph;hand.grabOrigin.origin.recordDrop(hand.grabOrigin)}droppedMorph.perish(myself.isAnimating?200:0)}else{droppedMorph.perish(myself.isAnimating?200:0)}};this.palette.contents.reactToDropOf=droppedMorph=>{if(droppedMorph instanceof BlockMorph){droppedMorph.destroy()}};this.palette.droppedImage=(aCanvas,name,embeddedData)=>{this.droppedImage(aCanvas,name,embeddedData,"palette")};this.palette.setWidth(this.logo.width());this.add(this.palette);return this.palette};IDE_Morph.prototype.createPaletteHandle=function(){if(this.paletteHandle){this.paletteHandle.destroy()}this.paletteHandle=new PaletteHandleMorph(this.categories);this.add(this.paletteHandle)};IDE_Morph.prototype.createStage=function(){if(this.stage){this.stage.destroy()}this.add(this.scene.stage);this.stage=this.scene.stage};IDE_Morph.prototype.createStageHandle=function(){if(this.stageHandle){this.stageHandle.destroy()}this.stageHandle=new StageHandleMorph(this.stage);this.add(this.stageHandle)};IDE_Morph.prototype.createSpriteBar=function(){var rotationStyleButtons=[],thumbSize=new Point(45,45),nameField,padlock,thumbnail,tabCorner=15,tabColors=this.tabColors,tabBar=new AlignmentMorph("row",-tabCorner*2),tab,symbols=[new SymbolMorph("arrowRightThin",10),new SymbolMorph("turnAround",10),new SymbolMorph("arrowLeftRightThin",10)],labels=["don't rotate","can rotate","only face left/right"],myself=this;if(this.spriteBar){this.spriteBar.destroy()}this.spriteBar=new Morph;this.spriteBar.color=this.frameColor;this.add(this.spriteBar);function addRotationStyleButton(rotationStyle){var colors=myself.rotationStyleColors,button;button=new ToggleButtonMorph(colors,myself,()=>{if(myself.currentSprite instanceof SpriteMorph){myself.currentSprite.rotationStyle=rotationStyle;myself.currentSprite.changed();myself.currentSprite.fixLayout();myself.currentSprite.rerender();myself.recordUnsavedChanges()}rotationStyleButtons.forEach(each=>each.refresh())},symbols[rotationStyle],()=>myself.currentSprite instanceof SpriteMorph&&myself.currentSprite.rotationStyle===rotationStyle,null,localize(labels[rotationStyle]));button.corner=8;button.labelMinExtent=new Point(11,11);button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.labelColor=myself.buttonLabelColor;button.fixLayout();button.refresh();rotationStyleButtons.push(button);button.setPosition(myself.spriteBar.position().add(new Point(2,4)));button.setTop(button.top()+(rotationStyleButtons.length-1)*(button.height()+2));myself.spriteBar.add(button);if(myself.currentSprite instanceof StageMorph){button.hide()}return button}addRotationStyleButton(1);addRotationStyleButton(2);addRotationStyleButton(0);this.rotationStyleButtons=rotationStyleButtons;thumbnail=new Morph;thumbnail.isCachingImage=true;thumbnail.bounds.setExtent(thumbSize);thumbnail.cachedImage=this.currentSprite.thumbnail(thumbSize);thumbnail.setPosition(rotationStyleButtons[0].topRight().add(new Point(5,3)));this.spriteBar.add(thumbnail);thumbnail.fps=3;thumbnail.step=function(){if(thumbnail.version!==myself.currentSprite.version){thumbnail.cachedImage=myself.currentSprite.thumbnail(thumbSize,thumbnail.cachedImage);thumbnail.changed();thumbnail.version=myself.currentSprite.version}};nameField=new InputFieldMorph(this.currentSprite.name);nameField.setWidth(100);nameField.contrast=90;nameField.setPosition(thumbnail.topRight().add(new Point(10,3)));this.spriteBar.add(nameField);this.spriteBar.nameField=nameField;nameField.fixLayout();nameField.accept=function(){var newName=nameField.getValue();myself.currentSprite.setName(myself.newSpriteName(newName,myself.currentSprite));nameField.setContents(myself.currentSprite.name);myself.recordUnsavedChanges()};this.spriteBar.reactToEdit=nameField.accept;padlock=new ToggleMorph("checkbox",null,()=>{this.currentSprite.isDraggable=!this.currentSprite.isDraggable;this.recordUnsavedChanges()},localize("draggable"),()=>this.currentSprite.isDraggable);padlock.label.isBold=false;padlock.label.setColor(this.buttonLabelColor);padlock.color=tabColors[2];padlock.highlightColor=tabColors[0];padlock.pressColor=tabColors[1];padlock.tick.shadowOffset=MorphicPreferences.isFlat?ZERO:new Point(-1,-1);padlock.tick.shadowColor=BLACK;padlock.tick.color=this.buttonLabelColor;padlock.tick.isBold=false;padlock.tick.fixLayout();padlock.setPosition(nameField.bottomLeft().add(2));padlock.fixLayout();this.spriteBar.add(padlock);if(this.currentSprite instanceof StageMorph){padlock.hide()}tabBar.tabTo=function(tabString){var active;if(myself.currentTab===tabString){return}myself.world().hand.destroyTemporaries();myself.currentTab=tabString;this.children.forEach(each=>{each.refresh();if(each.state){active=each}});active.refresh();myself.createSpriteEditor();myself.fixLayout("tabEditor")};tab=new TabMorph(tabColors,null,()=>tabBar.tabTo("scripts"),localize("Scripts"),()=>this.currentTab==="scripts");tab.padding=3;tab.corner=tabCorner;tab.edge=1;tab.labelShadowOffset=new Point(-1,-1);tab.labelShadowColor=tabColors[1];tab.labelColor=this.buttonLabelColor;tab.getPressRenderColor=function(){if(MorphicPreferences.isFlat||SyntaxElementMorph.prototype.alpha>.85){return this.pressColor}return this.pressColor.mixed(Math.max(SyntaxElementMorph.prototype.alpha-.15,0),SpriteMorph.prototype.paletteColor)};tab.fixLayout();tabBar.add(tab);tab=new TabMorph(tabColors,null,()=>tabBar.tabTo("costumes"),localize(this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds"),()=>this.currentTab==="costumes");tab.padding=3;tab.corner=tabCorner;tab.edge=1;tab.labelShadowOffset=new Point(-1,-1);tab.labelShadowColor=tabColors[1];tab.labelColor=this.buttonLabelColor;tab.fixLayout();tabBar.add(tab);tab=new TabMorph(tabColors,null,()=>tabBar.tabTo("sounds"),localize("Sounds"),()=>this.currentTab==="sounds");tab.padding=3;tab.corner=tabCorner;tab.edge=1;tab.labelShadowOffset=new Point(-1,-1);tab.labelShadowColor=tabColors[1];tab.labelColor=this.buttonLabelColor;tab.fixLayout();tabBar.add(tab);tabBar.fixLayout();tabBar.children.forEach(each=>each.refresh());this.spriteBar.tabBar=tabBar;this.spriteBar.add(this.spriteBar.tabBar);this.spriteBar.fixLayout=function(){this.tabBar.setLeft(this.left());this.tabBar.setBottom(this.bottom()+myself.padding)}};IDE_Morph.prototype.createSpriteEditor=function(){var scripts=this.currentSprite.scripts;if(this.spriteEditor){this.spriteEditor.destroy()}if(this.currentTab==="scripts"){scripts.isDraggable=false;scripts.color=this.groupColor;scripts.cachedTexture=this.scriptsPaneTexture;this.spriteEditor=new ScrollFrameMorph(scripts,null,this.sliderColor);this.spriteEditor.color=this.groupColor;this.spriteEditor.padding=10;this.spriteEditor.growth=50;this.spriteEditor.isDraggable=false;this.spriteEditor.acceptsDrops=false;this.spriteEditor.contents.acceptsDrops=true;scripts.scrollFrame=this.spriteEditor;scripts.updateToolbar();this.add(this.spriteEditor);this.spriteEditor.scrollX(this.spriteEditor.padding);this.spriteEditor.scrollY(this.spriteEditor.padding)}else if(this.currentTab==="costumes"){this.spriteEditor=new WardrobeMorph(this.currentSprite,this.sliderColor);this.spriteEditor.color=this.groupColor;this.add(this.spriteEditor);this.spriteEditor.updateSelection();this.spriteEditor.acceptsDrops=false;this.spriteEditor.contents.acceptsDrops=false}else if(this.currentTab==="sounds"){this.spriteEditor=new JukeboxMorph(this.currentSprite,this.sliderColor);this.spriteEditor.color=this.groupColor;this.add(this.spriteEditor);this.spriteEditor.updateSelection();this.spriteEditor.acceptDrops=false;this.spriteEditor.contents.acceptsDrops=false}else{this.spriteEditor=new Morph;this.spriteEditor.color=this.groupColor;this.spriteEditor.acceptsDrops=true;this.spriteEditor.reactToDropOf=droppedMorph=>{if(droppedMorph instanceof DialogBoxMorph){this.world().add(droppedMorph)}else if(droppedMorph instanceof SpriteMorph){this.removeSprite(droppedMorph)}else{droppedMorph.destroy()}};this.add(this.spriteEditor)}this.spriteEditor.mouseEnterDragging=morph=>{if(morph instanceof BlockMorph){this.spriteBar.tabBar.tabTo("scripts")}else if(morph instanceof CostumeIconMorph){this.spriteBar.tabBar.tabTo("costumes")}else if(morph instanceof SoundIconMorph){this.spriteBar.tabBar.tabTo("sounds")}};this.spriteEditor.contents.mouseEnterDragging=this.spriteEditor.mouseEnterDragging};IDE_Morph.prototype.createCorralBar=function(){var padding=5,newbutton,paintbutton,cambutton,trashbutton,flag=true,myself=this,colors=MorphicPreferences.isFlat?this.tabColors:[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)];if(this.corralBar){flag=this.corralBar.isVisible;this.corralBar.destroy()}this.corralBar=new Morph;this.corralBar.color=this.frameColor;this.corralBar.isVisible=flag;this.corralBar.setHeight(this.logo.height());this.corralBar.setWidth(this.stage.width());this.add(this.corralBar);newbutton=new PushButtonMorph(this,"addNewSprite",new SymbolMorph("turtle",14));newbutton.corner=12;newbutton.color=colors[0];newbutton.highlightColor=colors[1];newbutton.pressColor=colors[2];newbutton.labelMinExtent=new Point(36,18);newbutton.padding=0;newbutton.labelShadowOffset=new Point(-1,-1);newbutton.labelShadowColor=colors[1];newbutton.labelColor=this.buttonLabelColor;newbutton.contrast=this.buttonContrast;newbutton.hint="add a new Turtle sprite";newbutton.fixLayout();newbutton.setCenter(this.corralBar.center());newbutton.setLeft(this.corralBar.left()+padding);this.corralBar.add(newbutton);paintbutton=new PushButtonMorph(this,"paintNewSprite",new SymbolMorph("brush",15));paintbutton.corner=12;paintbutton.color=colors[0];paintbutton.highlightColor=colors[1];paintbutton.pressColor=colors[2];paintbutton.labelMinExtent=new Point(36,18);paintbutton.padding=0;paintbutton.labelShadowOffset=new Point(-1,-1);paintbutton.labelShadowColor=colors[1];paintbutton.labelColor=this.buttonLabelColor;paintbutton.contrast=this.buttonContrast;paintbutton.hint="paint a new sprite";paintbutton.fixLayout();paintbutton.setCenter(this.corralBar.center());paintbutton.setLeft(this.corralBar.left()+padding+newbutton.width()+padding);this.corralBar.add(paintbutton);if(CamSnapshotDialogMorph.prototype.enableCamera){cambutton=new PushButtonMorph(this,"newCamSprite",new SymbolMorph("camera",15));cambutton.corner=12;cambutton.color=colors[0];cambutton.highlightColor=colors[1];cambutton.pressColor=colors[2];cambutton.labelMinExtent=new Point(36,18);cambutton.padding=0;cambutton.labelShadowOffset=new Point(-1,-1);cambutton.labelShadowColor=colors[1];cambutton.labelColor=this.buttonLabelColor;cambutton.contrast=this.buttonContrast;cambutton.hint="take a camera snapshot and\n"+"import it as a new sprite";cambutton.fixLayout();cambutton.setCenter(this.corralBar.center());cambutton.setLeft(this.corralBar.left()+padding+newbutton.width()+padding+paintbutton.width()+padding);this.corralBar.add(cambutton);document.addEventListener("cameraDisabled",event=>{cambutton.disable();cambutton.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage})}trashbutton=new PushButtonMorph(this,"undeleteSprites",new SymbolMorph("trash",18));trashbutton.corner=12;trashbutton.color=colors[0];trashbutton.highlightColor=colors[1];trashbutton.pressColor=colors[2];trashbutton.labelMinExtent=new Point(36,18);trashbutton.padding=0;trashbutton.labelShadowOffset=new Point(-1,-1);trashbutton.labelShadowColor=colors[1];trashbutton.labelColor=this.buttonLabelColor;trashbutton.contrast=this.buttonContrast;trashbutton.fixLayout();trashbutton.setCenter(this.corralBar.center());trashbutton.setRight(this.corralBar.right()-padding);this.corralBar.add(trashbutton);trashbutton.wantsDropOf=morph=>morph instanceof SpriteMorph||morph instanceof SpriteIconMorph;trashbutton.reactToDropOf=droppedMorph=>{if(droppedMorph instanceof SpriteMorph){this.removeSprite(droppedMorph)}else if(droppedMorph instanceof SpriteIconMorph){droppedMorph.destroy();this.removeSprite(droppedMorph.object)}};this.corralBar.fixLayout=function(){function updateDisplayOf(button){if(button&&button.right()>trashbutton.left()-padding){button.hide()}else{button.show()}}this.setWidth(myself.stage.width());trashbutton.setRight(this.right()-padding);updateDisplayOf(cambutton);updateDisplayOf(paintbutton)}};IDE_Morph.prototype.createCorral=function(keepSceneAlbum){var frame,padding=5,myself=this,album=this.corral?this.corral.album:null;this.createStageHandle();this.createPaletteHandle();if(this.corral){this.corral.destroy()}this.corral=new Morph;this.corral.color=this.groupColor;this.corral.getRenderColor=ScriptsMorph.prototype.getRenderColor;this.add(this.corral);this.corral.stageIcon=new SpriteIconMorph(this.stage);this.corral.stageIcon.isDraggable=false;this.corral.add(this.corral.stageIcon);frame=new ScrollFrameMorph(null,null,this.sliderColor);frame.acceptsDrops=false;frame.contents.acceptsDrops=false;frame.contents.wantsDropOf=morph=>morph instanceof SpriteIconMorph;frame.contents.reactToDropOf=spriteIcon=>this.corral.reactToDropOf(spriteIcon);frame.alpha=0;this.sprites.asArray().forEach(morph=>{if(!morph.isTemporary){frame.contents.add(new SpriteIconMorph(morph))}});this.corral.frame=frame;this.corral.add(frame);this.corral.album=keepSceneAlbum?album:new SceneAlbumMorph(this,this.sliderColor);this.corral.album.color=this.frameColor;this.corral.add(this.corral.album);this.corral.fixLayout=function(){this.stageIcon.setCenter(this.center());this.stageIcon.setLeft(this.left()+padding);if(myself.scenes.length()<2){this.album.hide()}else{this.stageIcon.setTop(this.top());this.album.show();this.album.setLeft(this.left());this.album.setTop(this.stageIcon.bottom()+padding);this.album.setWidth(this.stageIcon.width()+padding*2);this.album.setHeight(this.height()-this.stageIcon.height()-padding)}this.frame.setLeft(this.stageIcon.right()+padding);this.frame.setExtent(new Point(this.right()-this.frame.left(),this.height()));this.arrangeIcons();this.refresh()};this.corral.arrangeIcons=function(){var x=this.frame.left(),y=this.frame.top(),max=this.frame.right(),start=this.frame.left();this.frame.contents.children.forEach(icon=>{var w=icon.width();if(x+w>max){x=start;y+=icon.height()}icon.setPosition(new Point(x,y));x+=w});this.frame.contents.adjustBounds()};this.corral.addSprite=function(sprite){this.frame.contents.add(new SpriteIconMorph(sprite));this.fixLayout();myself.recordUnsavedChanges()};this.corral.refresh=function(){this.stageIcon.refresh();this.frame.contents.children.forEach(icon=>icon.refresh())};this.corral.wantsDropOf=morph=>morph instanceof SpriteIconMorph;this.corral.reactToDropOf=function(spriteIcon){var idx=1,pos=spriteIcon.position();spriteIcon.destroy();this.frame.contents.children.forEach(icon=>{if(pos.gt(icon.position())||pos.y>icon.bottom()){idx+=1}});myself.sprites.add(spriteIcon.object,idx);myself.createCorral(true);myself.fixLayout()}};IDE_Morph.prototype.fixLayout=function(situation){var padding=this.padding,flag,maxPaletteWidth;if(situation!=="refreshPalette"){this.controlBar.setPosition(this.logo.topRight());this.controlBar.setWidth(this.right()-this.controlBar.left());this.controlBar.fixLayout();this.categories.setLeft(this.logo.left());this.categories.setTop(this.logo.bottom());this.categories.setWidth(this.paletteWidth);if(this.categories.scroller){this.categories.scroller.setWidth(this.paletteWidth)}}this.palette.setLeft(this.logo.left());this.palette.setTop(this.categories.bottom());this.palette.setHeight(this.bottom()-this.palette.top());this.palette.setWidth(this.paletteWidth);if(situation!=="refreshPalette"){if(this.isEmbedMode){this.stage.setScale(Math.floor(Math.min(this.width()/this.stage.dimensions.x,this.height()/this.stage.dimensions.y)*100)/100);flag=this.embedPlayButton.flag;flag.size=Math.floor(Math.min(this.width(),this.height()))/5;flag.fixLayout();this.embedPlayButton.size=flag.size*1.6;this.embedPlayButton.fixLayout();if(this.embedOverlay){this.embedOverlay.setExtent(this.extent())}this.stage.setCenter(this.center());this.embedPlayButton.setCenter(this.stage.center());flag.setCenter(this.embedPlayButton.center());flag.setLeft(flag.left()+flag.size*.1)}else if(this.isAppMode){this.stage.setScale(Math.floor(Math.min((this.width()-padding*2)/this.stage.dimensions.x,(this.height()-this.controlBar.height()*2-padding*2)/this.stage.dimensions.y)*10)/10);this.stage.setCenter(this.center())}else{this.stage.setScale(this.isSmallStage?this.stageRatio:1);this.stage.setTop(this.logo.bottom()+padding);this.stage.setRight(this.right());maxPaletteWidth=Math.max(200,this.width()-this.stage.width()-this.spriteBar.tabBar.width()-this.padding*2);if(this.paletteWidth>maxPaletteWidth){this.paletteWidth=maxPaletteWidth;this.fixLayout()}this.stageHandle.fixLayout();this.paletteHandle.fixLayout()}this.spriteBar.setLeft(this.paletteWidth+padding);this.spriteBar.setTop(this.logo.bottom()+padding);this.spriteBar.setExtent(new Point(Math.max(0,this.stage.left()-padding-this.spriteBar.left()),this.spriteBar.top()+44));this.spriteBar.fixLayout();if(this.spriteEditor.isVisible){this.spriteEditor.setPosition(new Point(this.spriteBar.left(),this.spriteBar.bottom()+padding));this.spriteEditor.setExtent(new Point(this.spriteBar.width(),this.bottom()-this.spriteEditor.top()))}this.corralBar.setLeft(this.stage.left());this.corralBar.setTop(this.stage.bottom()+padding);this.corralBar.setWidth(this.stage.width());if(!contains(["selectSprite","tabEditor"],situation)){this.corral.setPosition(this.corralBar.bottomLeft());this.corral.setWidth(this.stage.width());this.corral.setHeight(this.bottom()-this.corral.top());this.corral.fixLayout()}}};IDE_Morph.prototype.getProjectName=function(){return this.scenes.at(1).name};IDE_Morph.prototype.setProjectName=function(string){var projectScene=this.scenes.at(1),name=this.newSceneName(string,projectScene);if(name!==projectScene.name){projectScene.name=name;projectScene.stage.version=Date.now();this.recordUnsavedChanges();if(projectScene===this.scene){this.controlBar.updateLabel()}}return name};IDE_Morph.prototype.getProjectNotes=function(){return this.scenes.at(1).notes};IDE_Morph.prototype.setProjectNotes=function(string){var projectScene=this.scenes.at(1);if(string!==projectScene.notes){projectScene.notes=string;projectScene.stage.version=Date.now();this.recordUnsavedChanges();if(projectScene===this.scene){this.controlBar.updateLabel()}}};IDE_Morph.prototype.setExtent=function(point){var padding=new Point(430,110),minExt,ext,maxWidth,minWidth,maxHeight,minRatio,maxRatio;if(this.isAppMode){if(this.isEmbedMode){minExt=new Point(100,100)}else{minExt=this.stage.dimensions.add(this.controlBar.height()+10)}}else{if(this.stageRatio>1){minExt=padding.add(this.stage.dimensions)}else{minExt=padding.add(this.stage.dimensions.multiplyBy(this.stageRatio))}}ext=point.max(minExt);maxWidth=ext.x-(200+this.spriteBar.tabBar.width()+this.padding*2);minWidth=SpriteIconMorph.prototype.thumbSize.x*3;maxHeight=ext.y-SpriteIconMorph.prototype.thumbSize.y*3.5;minRatio=minWidth/this.stage.dimensions.x;maxRatio=Math.min(maxWidth/this.stage.dimensions.x,maxHeight/this.stage.dimensions.y);this.stageRatio=Math.min(maxRatio,Math.max(minRatio,this.stageRatio));IDE_Morph.uber.setExtent.call(this,ext);this.fixLayout()};IDE_Morph.prototype.render=function(ctx){var frame;IDE_Morph.uber.render.call(this,ctx);if(this.isAppMode&&this.stage){frame=this.stage.bounds.translateBy(this.position().neg()).expandBy(2);ctx.strokeStyle=(MorphicPreferences.isFlat?this.backgroundColor:this.groupColor).toString();ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(frame.origin.x,frame.origin.y);ctx.lineTo(frame.corner.x,frame.origin.y);ctx.lineTo(frame.corner.x,frame.corner.y);ctx.lineTo(frame.origin.x,frame.corner.y);ctx.closePath();ctx.stroke()}};IDE_Morph.prototype.reactToWorldResize=function(rect){if(this.isAutoFill){this.setPosition(rect.origin);this.setExtent(rect.extent())}if(this.filePicker){document.body.removeChild(this.filePicker);this.filePicker=null;this.isImportingLocalFile=false}};IDE_Morph.prototype.beginBulkDrop=function(){this.bulkDropInProgress=true;this.cachedSceneFlag=this.isAddingScenes;this.isAddingScenes=true};IDE_Morph.prototype.endBulkDrop=function(){this.isAddingScenes=this.cachedSceneFlag;this.bulkDropInProgress=false};IDE_Morph.prototype.droppedImage=function(aCanvas,name,embeddedData,src){var costume=new Costume(aCanvas,this.currentSprite.newCostumeName(name?name.split(".")[0]:""));if(costume.isTainted()){this.inform("Unable to import this image","The picture you wish to import has been\n"+"tainted by a restrictive cross-origin policy\n"+"making it unusable for costumes in Snap!. \n\n"+"Try downloading this picture first to your\n"+"computer, and import it from there.");return}if(!this.isImportingLocalFile&&isString(embeddedData)&&["scripts","palette","categories"].includes(src)&&embeddedData[0]==="<"&&["blocks","block","script","sprite"].some(tag=>embeddedData.slice(1).startsWith(tag))){this.isImportingLocalFile=false;return this.droppedText(embeddedData,name,"")}this.isImportingLocalFile=false;costume.embeddedData=embeddedData||null;this.currentSprite.addCostume(costume);this.currentSprite.wearCostume(costume);this.spriteBar.tabBar.tabTo("costumes");this.hasChangedMedia=true;this.recordUnsavedChanges()};IDE_Morph.prototype.droppedSVG=function(anImage,name){var myself,viewBox,w=300,h=150,scale=1,svgNormalized,headerLenght=anImage.src.search("base64")+7,svgStrEncoded=anImage.src.substring(headerLenght),svgObj=(new DOMParser).parseFromString(atob(svgStrEncoded),"image/svg+xml").firstElementChild,normalizing=false;name=name.split(".")[0];if(svgObj.attributes.getNamedItem("width")&&svgObj.attributes.getNamedItem("height")){w=parseFloat(svgObj.attributes.getNamedItem("width").value);h=parseFloat(svgObj.attributes.getNamedItem("height").value)}else{normalizing=true}if(svgObj.attributes.getNamedItem("viewBox")){viewBox=svgObj.attributes.getNamedItem("viewBox").value;viewBox=viewBox.split(/[ ,]/).filter(item=>item);if(viewBox.length==4){if(normalizing){w=parseFloat(viewBox[2]);h=parseFloat(viewBox[3])}}}else{svgObj.setAttribute("viewBox","0 0 "+w+" "+h);normalizing=true}if(this.stage.dimensions.x<w||this.stage.dimensions.y<h){scale=Math.min(this.stage.dimensions.x/w,this.stage.dimensions.y/h);normalizing=true;w=w*scale;h=h*scale}if(normalizing){svgNormalized=new Image(w,h);svgObj.setAttribute("width",w);svgObj.setAttribute("height",h);svgNormalized.src="data:image/svg+xml;base64,"+btoa((new XMLSerializer).serializeToString(svgObj));myself=this;svgNormalized.onload=()=>myself.loadSVG(svgNormalized,name)}else{this.loadSVG(anImage,name)}};IDE_Morph.prototype.loadSVG=function(anImage,name){var costume=new SVG_Costume(anImage,name);this.currentSprite.addCostume(costume);this.currentSprite.wearCostume(costume);this.spriteBar.tabBar.tabTo("costumes");this.hasChangedMedia=true};IDE_Morph.prototype.droppedAudio=function(anAudio,name){if(anAudio.src.indexOf("data:audio")!==0){this.getURL(anAudio.src,blob=>{var reader=new window.FileReader;reader.readAsDataURL(blob);reader.onloadend=()=>{var base64=reader.result;base64="data:audio/ogg;base64,"+base64.split(",")[1];anAudio.src=base64;this.droppedAudio(anAudio,name)}},"blob")}else{this.currentSprite.addSound(anAudio,name.split(".")[0]);this.spriteBar.tabBar.tabTo("sounds");this.hasChangedMedia=true;this.recordUnsavedChanges()}};IDE_Morph.prototype.droppedText=function(aString,name,fileType){var lbl=name?name.split(".")[0]:"",ext=name?name.slice(name.lastIndexOf(".")+1).toLowerCase():"",setting=this.isAddingScenes;if(this.isAddingNextScene){this.isAddingScenes=true;if(aString.indexOf("<project")===0){location.hash="";this.openProjectString(aString)}else if(aString.indexOf("<snapdata")===0){location.hash="";this.openCloudDataString(aString)}this.isAddingScenes=setting;this.isAddingNextScene=false;return}if(aString.indexOf("<project")===0){this.backup(()=>{location.hash="";this.openProjectString(aString)});return}if(aString.indexOf("<snapdata")===0){location.hash="";return this.openCloudDataString(aString)}this.recordUnsavedChanges();if(aString.indexOf("<blocks")===0){return this.openBlocksString(aString,lbl,true)}if(aString.indexOf("<sprites")===0){return this.openSpritesString(aString)}if(aString.indexOf("<media")===0){return this.openMediaString(aString)}if(aString.indexOf("<block")===0){aString="<script>"+aString+"<\/script>"}if(aString.indexOf("<script")===0){return this.openScriptString(aString)}if(fileType.indexOf("csv")!==-1||ext==="csv"){return this.openDataString(aString,lbl,"csv")}if(fileType.indexOf("json")!==-1||ext==="json"){return this.openDataString(aString,lbl,"json")}this.openDataString(aString,lbl,"text")};IDE_Morph.prototype.droppedBinary=function(anArrayBuffer,name){var ypr=document.getElementById("ypr"),myself=this,suffix=name.substring(name.length-3);if(suffix.toLowerCase()!=="ypr"){return}function loadYPR(buffer,lbl){var reader=new sb.Reader,pname=lbl.split(".")[0];reader.onload=function(info){myself.droppedText((new sb.XMLWriter).write(pname,info))};reader.readYPR(new Uint8Array(buffer))}if(!ypr){ypr=document.createElement("script");ypr.id="ypr";ypr.onload=function(){loadYPR(anArrayBuffer,name)};document.head.appendChild(ypr);ypr.src=this.resourceURL("src","ypr.js")}else{loadYPR(anArrayBuffer,name)}};IDE_Morph.prototype.refreshPalette=function(shouldIgnorePosition){var oldTop=this.palette.contents.top();this.createPalette();if(this.isAppMode){this.palette.hide();return}this.fixLayout("refreshPalette");if(!shouldIgnorePosition){this.palette.contents.setTop(oldTop)}this.palette.adjustScrollBars()};IDE_Morph.prototype.scrollPaletteToCategory=function(category){var palette=this.palette,msecs=this.isAnimating?200:0,firstInCategory,delta;if(palette.isForSearching){this.refreshPalette();palette=this.palette}firstInCategory=palette.contents.children.find(block=>block.category===category);if(firstInCategory===undefined){return}delta=palette.top()-firstInCategory.top()+palette.padding;if(delta===0){return}this.world().animations.push(new Animation(y=>{palette.contents.setTop(y);palette.contents.keepInScrollFrame();palette.adjustScrollBars()},()=>palette.contents.top(),delta,msecs,t=>Math.pow(t,6),null))};IDE_Morph.prototype.topVisibleCategoryInPalette=function(){var top;if(!this.palette){return}top=this.palette.contents.children.find(morph=>morph.category&&morph.bounds.intersects(this.palette.bounds));if(top){if(top.category==="other"){if(top.selector==="doWarp"){return"control"}if(top instanceof RingMorph){return"operators"}return"variables"}if(top.category==="lists"){return"variables"}return top.category}return null};IDE_Morph.prototype.pressStart=function(){if(this.world().currentKey===16){this.toggleFastTracking()}else{this.stage.threads.pauseCustomHatBlocks=false;this.controlBar.stopButton.refresh();this.runScripts()}};IDE_Morph.prototype.toggleFastTracking=function(){if(this.stage.isFastTracked){this.stopFastTracking()}else{this.startFastTracking()}};IDE_Morph.prototype.toggleSingleStepping=function(){this.stage.threads.toggleSingleStepping();this.controlBar.steppingButton.refresh();this.controlBar.refreshSlider()};IDE_Morph.prototype.toggleCameraSupport=function(){CamSnapshotDialogMorph.prototype.enableCamera=!CamSnapshotDialogMorph.prototype.enableCamera;this.spriteBar.tabBar.tabTo(this.currentTab);this.createCorralBar();this.fixLayout()};IDE_Morph.prototype.startFastTracking=function(){this.stage.isFastTracked=true;this.controlBar.startButton.labelString=new SymbolMorph("flash",14);this.controlBar.startButton.createLabel();this.controlBar.startButton.fixLayout();this.controlBar.startButton.rerender()};IDE_Morph.prototype.stopFastTracking=function(){this.stage.isFastTracked=false;this.controlBar.startButton.labelString=new SymbolMorph("flag",14);this.controlBar.startButton.createLabel();this.controlBar.startButton.fixLayout();this.controlBar.startButton.rerender()};IDE_Morph.prototype.runScripts=function(){if(this.stage.threads.pauseCustomHatBlocks){this.stage.threads.pauseCustomHatBlocks=false;this.controlBar.stopButton.refresh()}this.stage.fireGreenFlagEvent()};IDE_Morph.prototype.togglePauseResume=function(){if(this.stage.threads.isPaused()){this.stage.threads.resumeAll(this.stage)}else{this.stage.threads.pauseAll(this.stage)}this.controlBar.pauseButton.refresh()};IDE_Morph.prototype.isPaused=function(){if(!this.stage){return false}return this.stage.threads.isPaused()};IDE_Morph.prototype.stopAllScripts=function(){if(this.world().currentKey===16){this.scenes.map(scn=>scn.stop(true))}else{this.scene.stop()}this.controlBar.stopButton.refresh()};IDE_Morph.prototype.selectSprite=function(sprite,noEmptyRefresh){if(detect(this.world().children,morph=>morph instanceof BlockEditorMorph||morph instanceof BlockDialogMorph||morph instanceof BlockVisibilityDialogMorph)){return}if(this.currentSprite&&this.currentSprite.scripts.focus){this.currentSprite.scripts.focus.stopEditing()}this.currentSprite=sprite;this.scene.currentSprite=sprite;if(!noEmptyRefresh){this.categories.refreshEmpty()}this.createPalette();this.createSpriteBar();this.createSpriteEditor();this.corral.refresh();this.fixLayout("selectSprite");this.currentSprite.scripts.fixMultiArgs()};IDE_Morph.prototype.toggleRetina=function(){if(isRetinaEnabled()){disableRetinaSupport()}else{enableRetinaSupport()}this.world().fillPage();if(!MorphicPreferences.isFlat){IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture()}this.stage.clearPenTrails();this.refreshIDE()};IDE_Morph.prototype.defaultDesign=function(){this.setDefaultDesign();this.refreshIDE();this.saveSetting("design","default")};IDE_Morph.prototype.flatDesign=function(){this.setFlatDesign();this.refreshIDE();this.removeSetting("design")};IDE_Morph.prototype.refreshIDE=function(){var projectData;this.scene.captureGlobalSettings();if(Process.prototype.isCatchingErrors){try{projectData=this.serializer.serialize(new Project(this.scenes,this.scene))}catch(err){this.showMessage("Serialization failed: "+err)}}else{projectData=this.serializer.serialize(new Project(this.scenes,this.scene))}SpriteMorph.prototype.initBlocks();this.buildPanes();this.fixLayout();if(this.loadNewProject){this.newProject()}else{this.openProjectString(projectData)}};IDE_Morph.prototype.applySavedSettings=function(){var design=this.getSetting("design"),zoom=this.getSetting("zoom"),fade=this.getSetting("fade"),language=this.getSetting("language"),click=this.getSetting("click"),longform=this.getSetting("longform"),plainprototype=this.getSetting("plainprototype"),keyboard=this.getSetting("keyboard"),tables=this.getSetting("tables"),tableLines=this.getSetting("tableLines"),autoWrapping=this.getSetting("autowrapping"),solidshadow=this.getSetting("solidshadow");if(design==="default"){this.setDefaultDesign()}else{this.setFlatDesign()}if(zoom){SyntaxElementMorph.prototype.setScale(Math.min(zoom,12));CommentMorph.prototype.refreshScale();SpriteMorph.prototype.initBlocks()}if(!isNil(fade)){this.setBlockTransparency(+fade)}if(language&&language!=="en"){this.userLanguage=language}else{this.userLanguage=null}if(click!=="false"&&!BlockMorph.prototype.snapSound){BlockMorph.prototype.toggleSnapSound()}if(longform==="false"){InputSlotDialogMorph.prototype.isLaunchingExpanded=false}if(keyboard==="false"){ScriptsMorph.prototype.enableKeyboard=false}else{ScriptsMorph.prototype.enableKeyboard=true}if(tables==="false"){List.prototype.enableTables=false}else{List.prototype.enableTables=true}if(tableLines){TableMorph.prototype.highContrast=true}else{TableMorph.prototype.highContrast=false}if(autoWrapping==="false"){ScriptsMorph.prototype.enableNestedAutoWrapping=false}else{ScriptsMorph.prototype.enableNestedAutoWrapping=true}if(plainprototype==="false"){BlockLabelPlaceHolderMorph.prototype.plainLabel=false}if(solidshadow){window.useBlurredShadows=false;this.rerender()}};IDE_Morph.prototype.saveSetting=function(key,value){if(!this.savingPreferences){return}if(this.hasLocalStorage()){localStorage["-snap-setting-"+key]=value}};IDE_Morph.prototype.getSetting=function(key){if(this.hasLocalStorage()){return localStorage["-snap-setting-"+key]}return null};IDE_Morph.prototype.removeSetting=function(key){if(this.hasLocalStorage()){delete localStorage["-snap-setting-"+key]}};IDE_Morph.prototype.hasLocalStorage=function(){try{return!isNil(localStorage)}catch(err){return false}};IDE_Morph.prototype.hasUnsavedEdits=function(){return this.scenes.itemsArray().some(any=>any.hasUnsavedEdits)};IDE_Morph.prototype.recordUnsavedChanges=function(){this.scene.hasUnsavedEdits=true;this.updateChanges()};IDE_Morph.prototype.recordSavedChanges=function(){this.scenes.itemsArray().forEach(scene=>scene.hasUnsavedEdits=false);this.updateChanges()};IDE_Morph.prototype.updateChanges=function(){if(this.hasLocalStorage()&&localStorage["-snap-bakuser-"]==this.cloud.username){localStorage["-snap-bakflag-"]="expired"}this.controlBar.updateLabel()};IDE_Morph.prototype.backup=function(callback){if(this.hasUnsavedEdits()){this.confirm("Replace the current project with a new one?","Unsaved Changes!",()=>this.backupAndDo(callback))}else{callback()}};IDE_Morph.prototype.backupAndDo=function(callback){var username=this.cloud.username;this.scene.captureGlobalSettings();try{localStorage["-snap-backup-"]=this.serializer.serialize(new Project(this.scenes,this.scene));delete localStorage["-snap-bakflag-"];if(username){localStorage["-snap-bakuser-"]=username}else{delete localStorage["-snap-bakuser-"]}callback()}catch(err){nop(err);this.confirm("Backup failed.\nThis cannot be undone, proceed anyway?","Unsaved Changes!",callback)}};IDE_Morph.prototype.clearBackup=function(){delete localStorage["-snap-bakflag-"];delete localStorage["-snap-bakuser-"];delete localStorage["-snap-backup-"]};IDE_Morph.prototype.availableBackup=function(anyway){var username=this.cloud.username,bak,ix;if(this.hasLocalStorage()){if(localStorage["-snap-bakuser-"]==username&&(!localStorage["-snap-bakflag-"]||anyway)){bak=localStorage["-snap-backup-"];if(bak){ix=bak.indexOf('"',15);if(ix>15){return bak.slice(15,ix)}}}}return null};IDE_Morph.prototype.restore=function(){var username=this.cloud.username,bak;if(this.hasLocalStorage()){if(localStorage["-snap-bakuser-"]==username){bak=localStorage["-snap-backup-"];if(bak){this.backup(()=>{this.openProjectString(bak,()=>this.recordUnsavedChanges())})}}}};IDE_Morph.prototype.addNewSprite=function(){var sprite=new SpriteMorph(this.globalVariables),rnd=Process.prototype.reportBasicRandom;sprite.name=this.newSpriteName(sprite.name);sprite.setCenter(this.stage.center());this.stage.add(sprite);sprite.fixLayout();sprite.rerender();sprite.setColorDimension(0,rnd.call(this,0,100));sprite.setColorDimension(1,100);sprite.setColorDimension(2,rnd.call(this,25,75));sprite.setXPosition(rnd.call(this,-220,220));sprite.setYPosition(rnd.call(this,-160,160));if(this.world().currentKey===16){sprite.turn(rnd.call(this,1,360))}this.sprites.add(sprite);this.corral.addSprite(sprite);this.selectSprite(sprite)};IDE_Morph.prototype.paintNewSprite=function(){var sprite=new SpriteMorph(this.globalVariables),cos=new Costume;sprite.name=this.newSpriteName(sprite.name);sprite.setCenter(this.stage.center());this.stage.add(sprite);this.sprites.add(sprite);this.corral.addSprite(sprite);this.selectSprite(sprite);cos.edit(this.world(),this,true,()=>this.removeSprite(sprite),()=>{sprite.addCostume(cos);sprite.wearCostume(cos);this.recordUnsavedChanges()})};IDE_Morph.prototype.newCamSprite=function(){var sprite=new SpriteMorph(this.globalVariables),camDialog;sprite.name=this.newSpriteName(sprite.name);sprite.setCenter(this.stage.center());this.stage.add(sprite);this.sprites.add(sprite);this.corral.addSprite(sprite);this.selectSprite(sprite);camDialog=new CamSnapshotDialogMorph(this,sprite,()=>this.removeSprite(sprite),function(costume){sprite.addCostume(costume);sprite.wearCostume(costume);this.close()});camDialog.popUp(this.world())};IDE_Morph.prototype.recordNewSound=function(){var soundRecorder;soundRecorder=new SoundRecorderDialogMorph(audio=>{var sound;if(audio){sound=this.currentSprite.addSound(audio,this.newSoundName("recording"));this.makeSureRecordingIsMono(sound);this.spriteBar.tabBar.tabTo("sounds");this.hasChangedMedia=true;this.recordUnsavedChanges()}});soundRecorder.key="microphone";soundRecorder.popUp(this.world())};IDE_Morph.prototype.makeSureRecordingIsMono=function(sound){decodeSound(sound,makeMono);function decodeSound(sound,callback){var base64,binaryString,len,bytes,i,arrayBuffer,audioCtx;if(sound.audioBuffer){return callback(sound)}base64=sound.audio.src.split(",")[1];binaryString=window.atob(base64);len=binaryString.length;bytes=new Uint8Array(len);for(i=0;i<len;i+=1){bytes[i]=binaryString.charCodeAt(i)}arrayBuffer=bytes.buffer;audioCtx=Note.prototype.getAudioContext();sound.isDecoding=true;audioCtx.decodeAudioData(arrayBuffer,buffer=>{sound.audioBuffer=buffer;return callback(sound)},err=>{throw err})}function makeMono(sound){var samples,audio,blob,reader;if(sound.audioBuffer.numberOfChannels===1){return}samples=sound.audioBuffer.getChannelData(0);audio=new Audio;blob=new Blob([audioBufferToWav(encodeSound(samples,44100).audioBuffer)],{type:"audio/wav"});reader=new FileReader;reader.onload=()=>{audio.src=reader.result;sound.audio=audio;sound.audioBuffer=null;sound.cachedSamples=null;sound.isDecoding=false};reader.readAsDataURL(blob)}function encodeSound(samples,rate){var ctx=Note.prototype.getAudioContext(),frameCount=samples.length,arrayBuffer=ctx.createBuffer(1,frameCount,+rate||44100),i,source;if(!arrayBuffer.copyToChannel){arrayBuffer.copyToChannel=function(src,channel){var buffer=this.getChannelData(channel);for(i=0;i<src.length;i+=1){buffer[i]=src[i]}}}arrayBuffer.copyToChannel(Float32Array.from(samples),0,0);source=ctx.createBufferSource();source.buffer=arrayBuffer;source.audioBuffer=source.buffer;return source}function audioBufferToWav(buffer,opt){var sampleRate=buffer.sampleRate,format=(opt||{}).float32?3:1,bitDepth=format===3?32:16,result;result=buffer.getChannelData(0);return encodeWAV(result,format,sampleRate,1,bitDepth)}function encodeWAV(samples,format,sampleRate,numChannels,bitDepth){var bytesPerSample=bitDepth/8,blockAlign=numChannels*bytesPerSample,buffer=new ArrayBuffer(44+samples.length*bytesPerSample),view=new DataView(buffer);function writeFloat32(output,offset,input){for(var i=0;i<input.length;i+=1,offset+=4){output.setFloat32(offset,input[i],true)}}function floatTo16BitPCM(output,offset,input){var i,s;for(i=0;i<input.length;i+=1,offset+=2){s=Math.max(-1,Math.min(1,input[i]));output.setInt16(offset,s<0?s*32768:s*32767,true)}}function writeString(view,offset,string){for(var i=0;i<string.length;i+=1){view.setUint8(offset+i,string.charCodeAt(i))}}writeString(view,0,"RIFF");view.setUint32(4,36+samples.length*bytesPerSample,true);writeString(view,8,"WAVE");writeString(view,12,"fmt ");view.setUint32(16,16,true);view.setUint16(20,format,true);view.setUint16(22,numChannels,true);view.setUint32(24,sampleRate,true);view.setUint32(28,sampleRate*blockAlign,true);view.setUint16(32,blockAlign,true);view.setUint16(34,bitDepth,true);writeString(view,36,"data");view.setUint32(40,samples.length*bytesPerSample,true);if(format===1){floatTo16BitPCM(view,44,samples)}else{writeFloat32(view,44,samples)}return buffer}};IDE_Morph.prototype.duplicateSprite=function(sprite){var duplicate=sprite.fullCopy();duplicate.isDown=false;duplicate.setPosition(this.world().hand.position());duplicate.appearIn(this);duplicate.keepWithin(this.stage);duplicate.isDown=sprite.isDown;this.selectSprite(duplicate);this.recordUnsavedChanges()};IDE_Morph.prototype.instantiateSprite=function(sprite){var instance=sprite.fullCopy(true),hats=instance.allHatBlocksFor("__clone__init__");instance.isDown=false;instance.appearIn(this);if(hats.length){instance.initClone(hats)}else{instance.setPosition(this.world().hand.position());instance.keepWithin(this.stage)}instance.isDown=sprite.isDown;this.selectSprite(instance);this.recordUnsavedChanges()};IDE_Morph.prototype.removeSprite=function(sprite){var idx;sprite.parts.slice().forEach(part=>this.removeSprite(part));idx=this.sprites.asArray().indexOf(sprite)+1;this.stage.threads.stopAllForReceiver(sprite);sprite.corpsify();sprite.destroy();this.stage.watchers().forEach(watcher=>{if(watcher.object()===sprite){watcher.destroy()}});if(idx>0){this.sprites.remove(idx)}this.createCorral(true);this.fixLayout();this.currentSprite=detect(this.stage.children,morph=>morph instanceof SpriteMorph&&!morph.isTemporary)||this.stage;this.selectSprite(this.currentSprite);this.recordUnsavedChanges();this.scene.trash.push(sprite)};IDE_Morph.prototype.newSoundName=function(name){var lastSound=this.currentSprite.sounds.at(this.currentSprite.sounds.length());return this.newName(name||lastSound.name,this.currentSprite.sounds.asArray().map(eachSound=>eachSound.name))};IDE_Morph.prototype.newSpriteName=function(name,ignoredSprite){var all=this.sprites.asArray().concat(this.stage).filter(each=>each!==ignoredSprite).map(each=>each.name);return this.newName(name,all)};IDE_Morph.prototype.newSceneName=function(name,ignoredScene){var sName=name.replace(/['"]/g,""),all=this.scenes.asArray().filter(each=>each!==ignoredScene).map(each=>each.name);return this.newName(sName,all)};IDE_Morph.prototype.newName=function(name,elements){var count=1,newName=name;while(contains(elements,newName)){count+=1;newName=name+"("+count+")"}return newName};IDE_Morph.prototype.removeBlock=function(aBlock,justThis){this.stage.threads.stopAllForBlock(aBlock);aBlock.destroy(justThis)};IDE_Morph.prototype.userMenu=function(){var menu=new MenuMorph(this);return menu};IDE_Morph.prototype.snapMenu=function(){var menu,world=this.world();menu=new MenuMorph(this);menu.addItem("About...","aboutSnap");menu.addLine();menu.addItem("Reference manual",()=>{var url=this.resourceURL("SnapManual.pdf");window.open(url,"SnapReferenceManual")});menu.addItem("Snap! website",()=>window.open("https://snap.berkeley.edu/","SnapWebsite"));menu.addItem("Download source",()=>window.open("https://github.com/jmoenig/Snap/releases/latest","SnapSource"));if(world.isDevMode){menu.addLine();menu.addItem("Switch back to user mode","switchToUserMode","disable deep-Morphic\ncontext menus"+"\nand show user-friendly ones",new Color(0,100,0))}else if(world.currentKey===16){menu.addLine();menu.addItem("Switch to dev mode","switchToDevMode","enable Morphic\ncontext menus\nand inspectors,"+"\nnot user-friendly!",new Color(100,0,0))}menu.popup(world,this.logo.bottomLeft())};IDE_Morph.prototype.cloudMenu=function(){var menu,world=this.world(),pos=this.controlBar.cloudButton.bottomLeft(),shiftClicked=world.currentKey===16;if(location.protocol==="file:"&&!shiftClicked){this.showMessage("cloud unavailable without a web server.");return}menu=new MenuMorph(this);if(shiftClicked){menu.addItem("url...","setCloudURL",null,new Color(100,0,0));menu.addLine()}if(!this.cloud.username){menu.addItem("Login...","initializeCloud");menu.addItem("Signup...","createCloudAccount");menu.addItem("Reset Password...","resetCloudPassword");menu.addItem("Resend Verification Email...","resendVerification")}else{menu.addItem(localize("Logout")+" "+this.cloud.username,"logout");menu.addItem("Change Password...","changeCloudPassword")}if(this.hasCloudProject()){menu.addLine();menu.addItem("Open in Community Site",()=>{var dict=this.urlParameters();window.open(this.cloud.showProjectPath(dict.Username,dict.ProjectName),"_blank")})}if(shiftClicked){menu.addLine();menu.addItem("export project media only...",()=>{var pn=this.getProjectName();if(pn){this.exportProjectMedia(pn)}else{this.prompt("Export Project As...",name=>this.exportProjectMedia(name),null,"exportProject")}},null,this.hasChangedMedia?new Color(100,0,0):new Color(0,100,0));menu.addItem("export project without media...",()=>{var pn=this.getProjectName();if(pn){this.exportProjectNoMedia(pn)}else{this.prompt("Export Project As...",name=>this.exportProjectNoMedia(name),null,"exportProject")}},null,new Color(100,0,0));menu.addItem("export project as cloud data...",()=>{var pn=this.getProjectName();if(pn){this.exportProjectAsCloudData(pn)}else{this.prompt("Export Project As...",name=>this.exportProjectAsCloudData(name),null,"exportProject")}},null,new Color(100,0,0));menu.addLine();menu.addItem("open shared project from cloud...",()=>{this.prompt("Author name…",usr=>{this.prompt("Project name...",prj=>{this.showMessage("Fetching project\nfrom the cloud...");this.cloud.getPublicProject(prj,usr.toLowerCase(),projectData=>{var msg;if(!Process.prototype.isCatchingErrors){window.open("data:text/xml,"+projectData)}this.nextSteps([()=>{msg=this.showMessage("Opening project...")},()=>{this.rawOpenCloudDataString(projectData);msg.destroy()}])},this.cloudError())},null,"project")},null,"project")},null,new Color(100,0,0))}menu.popup(world,pos)};IDE_Morph.prototype.settingsMenu=function(){var menu,stage=this.stage,world=this.world(),pos=this.controlBar.settingsButton.bottomLeft(),shiftClicked=world.currentKey===16,on=new SymbolMorph("checkedBox",MorphicPreferences.menuFontSize*.75),off=new SymbolMorph("rectangle",MorphicPreferences.menuFontSize*.75);function addPreference(label,toggle,test,onHint,offHint,hide){if(!hide||shiftClicked){menu.addItem([test?on:off,localize(label)],toggle,test?onHint:offHint,hide?new Color(100,0,0):null)}}function addSubPreference(label,toggle,test,onHint,offHint,hide){if(!hide||shiftClicked){menu.addItem([test?on:off,"  "+localize(label)],toggle,test?onHint:offHint,hide?new Color(100,0,0):null)}}menu=new MenuMorph(this);if(SnapTranslator.loadedAIO){menu.addPair([new SymbolMorph("globe",MorphicPreferences.menuFontSize),localize("Language...")],"languageMenu")};menu.addItem("Zoom blocks...","userSetBlocksScale");menu.addItem("Fade blocks...","userFadeBlocks");menu.addItem("Stage size...","userSetStageSize");if(shiftClicked){menu.addItem("Dragging threshold...","userSetDragThreshold","specify the distance the hand has to move\n"+"before it picks up an object",new Color(100,0,0))}menu.addItem("Microphone resolution...","microphoneMenu");menu.addLine();addPreference("JavaScript extensions",()=>{Process.prototype.enableJS=!Process.prototype.enableJS;this.flushBlocksCache("operators");this.refreshPalette();this.categories.refreshEmpty()},Process.prototype.enableJS,"uncheck to disable support for\nnative JavaScript functions","check to support\nnative JavaScript functions");addPreference("Extension blocks",()=>{SpriteMorph.prototype.showingExtensions=!SpriteMorph.prototype.showingExtensions;this.flushBlocksCache("variables");this.refreshPalette();this.categories.refreshEmpty()},SpriteMorph.prototype.showingExtensions,"uncheck to hide extension\nprimitives in the palette","check to show extension\nprimitives in the palette");if(isRetinaSupported()){addPreference("Retina display support","toggleRetina",isRetinaEnabled(),"uncheck for lower resolution,\nsaves computing resources","check for higher resolution,\nuses more computing resources",true)}addPreference("Input sliders","toggleInputSliders",MorphicPreferences.useSliderForInput,"uncheck to disable\ninput sliders for\nentry fields","check to enable\ninput sliders for\nentry fields");if(MorphicPreferences.useSliderForInput){addSubPreference("Execute on slider change","toggleSliderExecute",ArgMorph.prototype.executeOnSliderEdit,"uncheck to suppress\nrunning scripts\nwhen moving the slider","check to run\nthe edited script\nwhen moving the slider")}addPreference("Turbo mode","toggleFastTracking",this.stage.isFastTracked,"uncheck to run scripts\nat normal speed","check to prioritize\nscript execution");addPreference("Visible stepping","toggleSingleStepping",Process.prototype.enableSingleStepping,"uncheck to turn off\nvisible stepping","check to turn on\n visible stepping (slow)",false);addPreference("Log pen vectors",()=>StageMorph.prototype.enablePenLogging=!StageMorph.prototype.enablePenLogging,StageMorph.prototype.enablePenLogging,"uncheck to turn off\nlogging pen vectors","check to turn on\nlogging pen vectors",false);addPreference("Ternary Boolean slots",()=>BooleanSlotMorph.prototype.isTernary=!BooleanSlotMorph.prototype.isTernary,BooleanSlotMorph.prototype.isTernary,"uncheck to limit\nBoolean slots to true / false","check to allow\nempty Boolean slots",true);addPreference("Camera support","toggleCameraSupport",CamSnapshotDialogMorph.prototype.enableCamera,"uncheck to disable\ncamera support","check to enable\ncamera support",true);menu.addLine();addPreference("Blurred shadows","toggleBlurredShadows",useBlurredShadows,"uncheck to use solid drop\nshadows and highlights","check to use blurred drop\nshadows and highlights",true);addPreference("Zebra coloring","toggleZebraColoring",BlockMorph.prototype.zebraContrast,"uncheck to disable alternating\ncolors for nested block","check to enable alternating\ncolors for nested blocks",true);addPreference("Dynamic input labels","toggleDynamicInputLabels",SyntaxElementMorph.prototype.dynamicInputLabels,"uncheck to disable dynamic\nlabels for variadic inputs","check to enable dynamic\nlabels for variadic inputs",true);addPreference("Prefer empty slot drops","togglePreferEmptySlotDrops",ScriptsMorph.prototype.isPreferringEmptySlots,"uncheck to allow dropped\nreporters to kick out others","settings menu prefer empty slots hint",true);addPreference("Long form input dialog","toggleLongFormInputDialog",InputSlotDialogMorph.prototype.isLaunchingExpanded,"uncheck to use the input\ndialog in short form","check to always show slot\ntypes in the input dialog");addPreference("Plain prototype labels","togglePlainPrototypeLabels",BlockLabelPlaceHolderMorph.prototype.plainLabel,"uncheck to always show (+) symbols\nin block prototype labels","check to hide (+) symbols\nin block prototype labels");addPreference("Clicking sound",()=>{BlockMorph.prototype.toggleSnapSound();if(BlockMorph.prototype.snapSound){this.removeSetting("click")}else{this.saveSetting("click",false)}},BlockMorph.prototype.snapSound,"uncheck to turn\nblock clicking\nsound off","check to turn\nblock clicking\nsound on");addPreference("Animations",()=>this.isAnimating=!this.isAnimating,this.isAnimating,"uncheck to disable\nIDE animations","check to enable\nIDE animations",true);addPreference("Rasterize SVGs",()=>MorphicPreferences.rasterizeSVGs=!MorphicPreferences.rasterizeSVGs,MorphicPreferences.rasterizeSVGs,"uncheck for smooth\nscaling of vector costumes","check to rasterize\nSVGs on import",true);addPreference("Flat design",()=>{if(MorphicPreferences.isFlat){return this.defaultDesign()}this.flatDesign()},MorphicPreferences.isFlat,"uncheck for default\nGUI design","check for alternative\nGUI design",false);addPreference("Nested auto-wrapping",()=>{ScriptsMorph.prototype.enableNestedAutoWrapping=!ScriptsMorph.prototype.enableNestedAutoWrapping;if(ScriptsMorph.prototype.enableNestedAutoWrapping){this.removeSetting("autowrapping")}else{this.saveSetting("autowrapping",false)}},ScriptsMorph.prototype.enableNestedAutoWrapping,"uncheck to confine auto-wrapping\nto top-level block stacks","check to enable auto-wrapping\ninside nested block stacks",true);addPreference("Sprite Nesting",()=>SpriteMorph.prototype.enableNesting=!SpriteMorph.prototype.enableNesting,SpriteMorph.prototype.enableNesting,"uncheck to disable\nsprite composition","check to enable\nsprite composition",true);addPreference("First-Class Sprites",()=>{SpriteMorph.prototype.enableFirstClass=!SpriteMorph.prototype.enableFirstClass;this.flushBlocksCache("sensing");this.refreshPalette();this.categories.refreshEmpty()},SpriteMorph.prototype.enableFirstClass,"uncheck to disable support\nfor first-class sprites","check to enable support\n for first-class sprite",true);addPreference("Keyboard Editing",()=>{ScriptsMorph.prototype.enableKeyboard=!ScriptsMorph.prototype.enableKeyboard;this.currentSprite.scripts.updateToolbar();if(ScriptsMorph.prototype.enableKeyboard){this.removeSetting("keyboard")}else{this.saveSetting("keyboard",false)}},ScriptsMorph.prototype.enableKeyboard,"uncheck to disable\nkeyboard editing support","check to enable\nkeyboard editing support",true);addPreference("Table support",()=>{List.prototype.enableTables=!List.prototype.enableTables;if(List.prototype.enableTables){this.removeSetting("tables")}else{this.saveSetting("tables",false)}},List.prototype.enableTables,"uncheck to disable\nmulti-column list views","check for multi-column\nlist view support",true);if(List.prototype.enableTables){addPreference("Table lines",()=>{TableMorph.prototype.highContrast=!TableMorph.prototype.highContrast;if(TableMorph.prototype.highContrast){this.saveSetting("tableLines",true)}else{this.removeSetting("tableLines")}},TableMorph.prototype.highContrast,"uncheck for less contrast\nmulti-column list views","check for higher contrast\ntable views",true)}addPreference("Live coding support",()=>Process.prototype.enableLiveCoding=!Process.prototype.enableLiveCoding,Process.prototype.enableLiveCoding,"EXPERIMENTAL! uncheck to disable live\ncustom control structures","EXPERIMENTAL! check to enable\n live custom control structures",true);addPreference("JIT compiler support",()=>{Process.prototype.enableCompiling=!Process.prototype.enableCompiling;this.flushBlocksCache("operators");this.refreshPalette();this.categories.refreshEmpty()},Process.prototype.enableCompiling,"EXPERIMENTAL! uncheck to disable live\nsupport for compiling","EXPERIMENTAL! check to enable\nsupport for compiling",true);menu.addLine();addPreference("Thread safe scripts",()=>stage.isThreadSafe=!stage.isThreadSafe,this.stage.isThreadSafe,"uncheck to allow\nscript reentrance","check to disallow\nscript reentrance");addPreference("Flat line ends",()=>SpriteMorph.prototype.useFlatLineEnds=!SpriteMorph.prototype.useFlatLineEnds,SpriteMorph.prototype.useFlatLineEnds,"uncheck for round ends of lines","check for flat ends of lines");addPreference("Codification support",()=>{StageMorph.prototype.enableCodeMapping=!StageMorph.prototype.enableCodeMapping;this.flushBlocksCache("variables");this.refreshPalette();this.categories.refreshEmpty()},StageMorph.prototype.enableCodeMapping,"uncheck to disable\nblock to text mapping features","check for block\nto text mapping features",false);addPreference("Inheritance support",()=>{StageMorph.prototype.enableInheritance=!StageMorph.prototype.enableInheritance;this.flushBlocksCache("variables");this.refreshPalette();this.categories.refreshEmpty()},StageMorph.prototype.enableInheritance,"uncheck to disable\nsprite inheritance features","check for sprite\ninheritance features",true);addPreference("Hyper blocks support",()=>Process.prototype.enableHyperOps=!Process.prototype.enableHyperOps,Process.prototype.enableHyperOps,"uncheck to disable\nusing operators on lists and tables","check to enable\nusing operators on lists and tables",true);addPreference("Single palette",()=>this.toggleUnifiedPalette(),this.scene.unifiedPalette,"uncheck to show only the selected category's blocks","check to show all blocks in a single palette",false);if(this.scene.unifiedPalette){addSubPreference("Show categories",()=>this.toggleCategoryNames(),this.scene.showCategories,"uncheck to hide\ncategory names\nin the palette","check to show\ncategory names\nin the palette");addSubPreference("Show buttons",()=>this.togglePaletteButtons(),this.scene.showPaletteButtons,"uncheck to hide buttons\nin the palette","check to show buttons\nin the palette")}addPreference("Persist linked sublist IDs",()=>StageMorph.prototype.enableSublistIDs=!StageMorph.prototype.enableSublistIDs,StageMorph.prototype.enableSublistIDs,"uncheck to disable\nsaving linked sublist identities","check to enable\nsaving linked sublist identities",true);addPreference("Enable command drops in all rings",()=>RingReporterSlotMorph.prototype.enableCommandDrops=!RingReporterSlotMorph.prototype.enableCommandDrops,RingReporterSlotMorph.prototype.enableCommandDrops,"uncheck to disable\ndropping commands in reporter rings","check to enable\ndropping commands in all rings",true);addPreference("HSL pen color model",()=>{SpriteMorph.prototype.penColorModel=SpriteMorph.prototype.penColorModel==="hsl"?"hsv":"hsl";this.refreshIDE()},SpriteMorph.prototype.penColorModel==="hsl","uncheck to switch pen colors\nand graphic effects to HSV","check to switch pen colors\nand graphic effects to HSL",false);addPreference("Disable click-to-run",()=>ThreadManager.prototype.disableClickToRun=!ThreadManager.prototype.disableClickToRun,ThreadManager.prototype.disableClickToRun,"uncheck to enable\ndirectly running blocks\nby clicking on them","check to disable\ndirectly running blocks\nby clicking on them",false);menu.popup(world,pos)};IDE_Morph.prototype.projectMenu=function(){var menu,world=this.world(),pos=this.controlBar.projectButton.bottomLeft(),graphicsName=this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds",shiftClicked=world.currentKey===16,backup=this.availableBackup(shiftClicked);menu=new MenuMorph(this);menu.addItem("Notes...","editNotes");menu.addLine();menu.addPair("New","createNewProject","^N");menu.addPair("Open...","openProjectsBrowser","^O");menu.addPair("Save","save","^S");menu.addItem("Save As...","saveProjectsBrowser");if(backup){menu.addItem("Restore unsaved project","restore",backup,shiftClicked?new Color(100,0,0):null);if(shiftClicked){menu.addItem("Clear backup","clearBackup",backup,new Color(100,0,0))}}menu.addLine();menu.addItem("Import...","importLocalFile","file menu import hint");menu.addItem("Export project...",()=>{var pn=this.getProjectName();if(pn){this.exportProject(pn)}else{this.prompt("Export Project As...",name=>this.exportProject(name),null,"exportProject")}},"save project data as XML\nto your downloads folder");menu.addItem("Export summary...",()=>this.exportProjectSummary(),"save a summary\nof this project");if(shiftClicked){menu.addItem("Export summary with drop-shadows...",()=>this.exportProjectSummary(true),"download and save"+"\nwith a summary of this project"+"\nwith drop-shadows on all pictures."+"\nnot supported by all browsers",new Color(100,0,0));menu.addItem("Export all scripts as pic...",()=>this.exportScriptsPicture(),"show a picture of all scripts\nand block definitions",new Color(100,0,0))}menu.addLine();if(this.stage.globalBlocks.length){menu.addItem("Export blocks...",()=>this.exportGlobalBlocks(),"save global custom block\ndefinitions as XML");menu.addItem("Unused blocks...",()=>this.removeUnusedBlocks(),"find unused global custom blocks"+"\nand remove their definitions")}menu.addItem("Hide blocks...",()=>new BlockVisibilityDialogMorph(this.currentSprite).popUp(world));menu.addItem("New category...",()=>this.createNewCategory());if(SpriteMorph.prototype.customCategories.size){menu.addItem("Remove a category...",()=>this.deleteUserCategory(pos))}menu.addLine();if(this.scenes.length()>1){menu.addItem("Scenes...","scenesMenu")}menu.addPair("New scene","createNewScene");menu.addPair("Add scene...","addScene");menu.addLine();menu.addItem("Import Extended Blocks",()=>fetch('Extended Blocks.xml').then(r=>r.text()).then(r=>world.children[0].rawOpenBlocksString(r,'Extended Blocks')));/*menu.addItem("Libraries...",()=>{if(location.protocol==="file:"){this.importLocalFile();return}this.getURL(this.resourceURL("libraries","LIBRARIES"),txt=>{var libraries=this.parseResourceFile(txt);new LibraryImportDialogMorph(this,libraries).popUp()})},"Select categories of additional blocks to add to this project.");menu.addItem(localize(graphicsName)+"...",()=>{if(location.protocol==="file:"){this.importLocalFile();return}this.importMedia(graphicsName)},"Select a costume from the media library");menu.addItem(localize("Sounds")+"...",()=>{if(location.protocol==="file:"){this.importLocalFile();return}this.importMedia("Sounds")},"Select a sound from the media library");*/if(this.scene.trash.length){menu.addLine();menu.addItem("Undelete sprites...",()=>this.undeleteSprites(this.controlBar.projectButton.bottomLeft()),"Bring back deleted sprites")}menu.popup(world,pos)};IDE_Morph.prototype.resourceURL=function(){var args=Array.prototype.slice.call(arguments,0);return args.join("/")};IDE_Morph.prototype.getMediaList=function(dirname,callback){var url=this.resourceURL(dirname,dirname.toUpperCase()),async=callback instanceof Function,data;function alphabetically(x,y){return x.name.toLowerCase()<y.name.toLowerCase()?-1:1}if(async){this.getURL(url,txt=>{var data=this.parseResourceFile(txt);data.sort(alphabetically);callback.call(this,data)})}else{data=this.parseResourceFile(this.getURL(url));data.sort(alphabetically);return data}};IDE_Morph.prototype.parseResourceFile=function(text){var parts,items=[];text.split("\n").map(line=>line.trim()).filter(line=>line.length>0).forEach(line=>{parts=line.split("\t").map(str=>str.trim());if(parts.length<2){return}items.push({fileName:parts[0],name:parts[1],description:parts.length>2?parts[2]:""})});return items};IDE_Morph.prototype.importLocalFile=function(){var inp=document.createElement("input"),addingScenes=this.isAddingScenes,myself=this,world=this.world();if(this.filePicker){document.body.removeChild(this.filePicker);this.filePicker=null}inp.type="file";inp.style.color="transparent";inp.style.backgroundColor="transparent";inp.style.border="none";inp.style.outline="none";inp.style.position="absolute";inp.style.top="0px";inp.style.left="0px";inp.style.width="0px";inp.style.height="0px";inp.style.display="none";inp.addEventListener("change",()=>{document.body.removeChild(inp);this.filePicker=null;if(addingScenes){myself.isAddingNextScene=true}myself.isImportingLocalFile=true;world.hand.processDrop(inp.files)},false);document.body.appendChild(inp);this.filePicker=inp;inp.click()};IDE_Morph.prototype.importMedia=function(folderName){var msg=this.showMessage("Opening "+folderName+"...");this.getMediaList(folderName,items=>{msg.destroy();this.popupMediaImportDialog(folderName,items)})};IDE_Morph.prototype.popupMediaImportDialog=function(folderName,items){var dialog=(new DialogBoxMorph).withKey("import"+folderName),frame=new ScrollFrameMorph,selectedIcon=null,turtle=new SymbolMorph("turtle",60),myself=this,world=this.world(),handle;frame.acceptsDrops=false;frame.contents.acceptsDrops=false;frame.color=myself.groupColor;frame.fixLayout=nop;dialog.labelString=folderName;dialog.createLabel();dialog.addBody(frame);dialog.addButton("ok","Import");dialog.addButton("cancel","Cancel");dialog.ok=function(){if(selectedIcon){if(selectedIcon.object instanceof Sound){myself.droppedAudio(selectedIcon.object.copy().audio,selectedIcon.labelString)}else if(selectedIcon.object instanceof SVG_Costume){myself.droppedSVG(selectedIcon.object.contents,selectedIcon.labelString)}else{myself.droppedImage(selectedIcon.object.contents,selectedIcon.labelString)}}};dialog.fixLayout=function(){var th=fontHeight(this.titleFontSize)+this.titlePadding*2,x=0,y=0,fp,fw;this.buttons.fixLayout();this.body.setPosition(this.position().add(new Point(this.padding,th+this.padding)));this.body.setExtent(new Point(this.width()-this.padding*2,this.height()-this.padding*3-th-this.buttons.height()));fp=this.body.position();fw=this.body.width();frame.contents.children.forEach(function(icon){icon.setPosition(fp.add(new Point(x,y)));x+=icon.width();if(x+icon.width()>fw){x=0;y+=icon.height()}});frame.contents.adjustBounds();this.label.setCenter(this.center());this.label.setTop(this.top()+(th-this.label.height())/2);this.buttons.setCenter(this.center());this.buttons.setBottom(this.bottom()-this.padding);this.removeShadow();this.addShadow()};items.forEach(item=>{var url=this.resourceURL(folderName,item.fileName),img=new Image,suffix=url.slice(url.lastIndexOf(".")+1).toLowerCase(),isSVG=suffix==="svg"&&!MorphicPreferences.rasterizeSVGs,isSound=contains(["wav","mp3"],suffix),icon;if(isSound){icon=new SoundIconMorph(new Sound(new Audio,item.name))}else{icon=new CostumeIconMorph(new Costume(turtle.getImage(),item.name))}icon.isDraggable=false;icon.userMenu=nop;icon.action=function(){if(selectedIcon===icon){return}var prevSelected=selectedIcon;selectedIcon=icon;if(prevSelected){prevSelected.refresh()}};icon.doubleClickAction=dialog.ok;icon.query=function(){return icon===selectedIcon};frame.addContents(icon);if(isSound){icon.object.audio.onloadeddata=function(){icon.createThumbnail();icon.fixLayout();icon.refresh()};icon.object.audio.src=url;icon.object.audio.load()}else if(isSVG){img.onload=function(){icon.object=new SVG_Costume(img,item.name);icon.refresh()};this.getURL(url,txt=>img.src="data:image/svg+xml;base64,"+window.btoa(txt))}else{img.onload=function(){var canvas=newCanvas(new Point(img.width,img.height),true);canvas.getContext("2d").drawImage(img,0,0);icon.object=new Costume(canvas,item.name);icon.refresh()};img.src=url}});dialog.popUp(world);dialog.setExtent(new Point(400,300));dialog.setCenter(world.center());handle=new HandleMorph(dialog,300,280,dialog.corner,dialog.corner)};IDE_Morph.prototype.undeleteSprites=function(pos){var menu=new MenuMorph(sprite=>this.undelete(sprite,pos),null,this);pos=pos||this.corralBar.bottomRight();if(!this.scene.trash.length){this.showMessage("trash is empty");return}this.scene.trash.forEach(sprite=>menu.addItem([sprite.thumbnail(new Point(24,24),null,true),sprite.name],sprite));menu.popup(this.world(),pos)};IDE_Morph.prototype.undelete=function(aSprite,pos){var rnd=Process.prototype.reportBasicRandom;aSprite.setCenter(pos);this.world().add(aSprite);aSprite.glideTo(this.stage.center().subtract(aSprite.extent().divideBy(2)),this.isAnimating?100:0,null,()=>{aSprite.isCorpse=false;aSprite.version=Date.now();aSprite.name=this.newSpriteName(aSprite.name);this.stage.add(aSprite);aSprite.setXPosition(rnd.call(this,-50,50));aSprite.setYPosition(rnd.call(this,-50,59));aSprite.fixLayout();aSprite.rerender();this.sprites.add(aSprite);this.corral.addSprite(aSprite);this.selectSprite(aSprite);this.scene.updateTrash()})};IDE_Morph.prototype.aboutSnap=function(){var dlg,aboutTxt,noticeTxt,creditsTxt,versions="",translations,module,btn1,btn2,btn3,btn4,licenseBtn,translatorsBtn,world=this.world();aboutTxt="Snap! "+SnapVersion+"\nBuild Your Own Blocks\n\n"+"Copyright Ⓒ 2008-2022 Jens Mönig and "+"Brian Harvey\n"+"jens@moenig.org, bh@cs.berkeley.edu\n\n"+"        Snap! is developed by the University of California, "+"Berkeley and SAP        \n"+"with support from the National Science Foundation (NSF),\n"+"MIOsoft and YC Research.\n"+"The design of Snap! is influenced and inspired by Scratch,\n"+"from the Lifelong Kindergarten group at the MIT Media Lab\n\n"+"for more information see https://snap.berkeley.edu\n\n"+"MicroSnap! by teknixstuff";noticeTxt=localize("License")+"\n\n"+"Snap! is free software: you can redistribute it and/or modify\n"+"it under the terms of the GNU Affero General Public License as\n"+"published by the Free Software Foundation, either version 3 of\n"+"the License, or (at your option) any later version.\n\n"+"This program is distributed in the hope that it will be useful,\n"+"but WITHOUT ANY WARRANTY; without even the implied warranty of\n"+"MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n"+"GNU Affero General Public License for more details.\n\n"+"You should have received a copy of the\n"+"GNU Affero General Public License along with this program.\n"+"If not, see http://www.gnu.org/licenses/\n\n"+"Want to use Snap! but scared by the open-source license?\n"+"Get in touch with us, we'll make it work.";creditsTxt=localize("Contributors")+"\n\nNathan Dinsmore: Saving/Loading, Snap-Logo Design, "+"\ncountless bugfixes and optimizations"+"\nMichael Ball: Time/Date UI, Library Import Dialog,"+"\ncountless bugfixes and optimizations"+"\nBernat Romagosa: Countless contributions"+"\nBartosz Leper: Retina Display Support"+"\nDariusz Dorożalski: Web Serial Support"+"\nZhenlei Jia and Dariusz Dorożalski: IME text editing"+"\nKen Kahn: IME support and countless other contributions"+"\nJosep Ferràndiz: Video Motion Detection"+"\nJoan Guillén: Countless contributions"+"\nKartik Chandra: Paint Editor"+"\nCarles Paredes: Initial Vector Paint Editor"+'\n"Ava" Yuan Yuan, Dylan Servilla: Graphic Effects'+"\nKyle Hotchkiss: Block search design"+"\nBrian Broll: Many bugfixes and optimizations"+"\nEckart Modrow: SciSnap! Extension"+"\nBambi Brewer: Birdbrain Robotics Extension Support"+"\nGlen Bull & team: TuneScope Music Extension"+"\nIan Reynolds: UI Design, Event Bindings, "+"Sound primitives"+"\nJadga Hügle: Icons and countless other contributions"+"\nSimon Walters & Xavier Pi: MQTT extension"+"\nIvan Motyashov: Initial Squeak Porting"+"\nLucas Karahadian: Piano Keyboard Design"+"\nDavide Della Casa: Morphic Optimizations"+"\nAchal Dave: Web Audio"+"\nJoe Otto: Morphic Testing and Debugging"+"\n\n"+"Jahrd, Derec, and Jamet costumes are watercolor paintings"+"\nby Meghan Taylor and represent characters from her"+"\nwebcomic Prophecy of the Circle, licensed to us only"+"\nfor use in Snap! projects. Meghan also painted the Tad"+"\ncostumes, but that character is in the public domain.";for(module in modules){if(Object.prototype.hasOwnProperty.call(modules,module)){versions+="\n"+module+" ("+modules[module]+")"}}if(versions!==""){versions=localize("current module versions:")+" \n\n"+"morphic ("+morphicVersion+")"+versions}translations=localize("Translations")+"\n"+SnapTranslator.credits();dlg=new DialogBoxMorph;function txt(textString){var tm=new TextMorph(textString,dlg.fontSize,dlg.fontStyle,true,false,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE),scroller,maxHeight=world.height()-dlg.titleFontSize*10;if(tm.height()>maxHeight){scroller=new ScrollFrameMorph;scroller.acceptsDrops=false;scroller.contents.acceptsDrops=false;scroller.bounds.setWidth(tm.width());scroller.bounds.setHeight(maxHeight);scroller.addContents(tm);scroller.color=new Color(0,0,0,0);return scroller}return tm}dlg.inform("About Snap",aboutTxt,world,this.logo.cachedTexture);btn1=dlg.buttons.children[0];translatorsBtn=dlg.addButton(()=>{dlg.addBody(txt(translations));dlg.body.fixLayout();btn1.show();btn2.show();btn3.hide();btn4.hide();licenseBtn.hide();translatorsBtn.hide();dlg.fixLayout();dlg.setCenter(world.center())},"Translators...");btn2=dlg.addButton(()=>{dlg.addBody(txt(aboutTxt));dlg.body.fixLayout();btn1.show();btn2.hide();btn3.show();btn4.show();licenseBtn.show();translatorsBtn.hide();dlg.fixLayout();dlg.setCenter(world.center())},"Back...");btn2.hide();licenseBtn=dlg.addButton(()=>{dlg.addBody(txt(noticeTxt));dlg.body.fixLayout();btn1.show();btn2.show();btn3.hide();btn4.hide();licenseBtn.hide();translatorsBtn.hide();dlg.fixLayout();dlg.setCenter(world.center())},"License...");btn3=dlg.addButton(()=>{dlg.addBody(txt(versions));dlg.body.fixLayout();btn1.show();btn2.show();btn3.hide();btn4.hide();licenseBtn.hide();translatorsBtn.hide();dlg.fixLayout();dlg.setCenter(world.center())},"Modules...");btn4=dlg.addButton(()=>{dlg.addBody(txt(creditsTxt));dlg.body.fixLayout();btn1.show();btn2.show();translatorsBtn.show();btn3.hide();btn4.hide();licenseBtn.hide();dlg.fixLayout();dlg.setCenter(world.center())},"Credits...");translatorsBtn.hide();dlg.fixLayout()};IDE_Morph.prototype.scenesMenu=function(){var menu=new MenuMorph(scn=>this.switchToScene(scn),null,this),world=this.world(),pos=this.controlBar.projectButton.bottomLeft(),tick=new SymbolMorph("tick",MorphicPreferences.menuFontSize*.75),empty=tick.fullCopy();empty.render=nop;this.scenes.asArray().forEach(scn=>menu.addItem([this.scene===scn?tick:empty,scn.name],scn));menu.popup(world,pos)};IDE_Morph.prototype.editNotes=function(){var dialog=(new DialogBoxMorph).withKey("notes"),frame=new ScrollFrameMorph,text=new TextMorph(this.scenes.at(1).notes||""),size=250,world=this.world();frame.padding=6;frame.setWidth(size);frame.acceptsDrops=false;frame.contents.acceptsDrops=false;text.setWidth(size-frame.padding*2);text.setPosition(frame.topLeft().add(frame.padding));text.enableSelecting();text.isEditable=true;frame.setHeight(size);frame.fixLayout=nop;frame.edge=InputFieldMorph.prototype.edge;frame.fontSize=InputFieldMorph.prototype.fontSize;frame.typeInPadding=InputFieldMorph.prototype.typeInPadding;frame.contrast=InputFieldMorph.prototype.contrast;frame.render=InputFieldMorph.prototype.render;frame.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;frame.addContents(text);dialog.getInput=()=>text.text;dialog.target=this;dialog.action=note=>{this.scene.notes=note;this.recordUnsavedChanges()};dialog.justDropped=()=>text.edit();dialog.labelString="Notes";dialog.createLabel();dialog.addBody(frame);dialog.addButton("ok","OK");dialog.addButton("cancel","Cancel");dialog.fixLayout();dialog.popUp(world);dialog.setCenter(world.center());text.edit()};IDE_Morph.prototype.newProject=function(){var project=new Project;project.addDefaultScene();this.source=this.cloud.username?"cloud":null;if(location.hash.substr(0,6)!=="#lang:"){location.hash=""}this.openProject(project)};IDE_Morph.prototype.createNewScene=function(){var setting=this.isAddingScenes;this.isAddingScenes=true;this.newProject();this.isAddingScenes=setting};IDE_Morph.prototype.createNewCategory=function(){new DialogBoxMorph(this,cat=>this.addPaletteCategory(cat.name,cat.color),this).promptCategory("New Category",null,new Color(0,116,143),this.world(),null,"Blocks category name:")};IDE_Morph.prototype.addPaletteCategory=function(name,color){if(name===""){return}SpriteMorph.prototype.customCategories.set(name,color);this.createCategories();this.categories.refreshEmpty();this.createPaletteHandle();this.categories.fixLayout();this.fixLayout()};IDE_Morph.prototype.deleteUserCategory=function(pos){var menu=new MenuMorph(this.deletePaletteCategory,null,this);Array.from(SpriteMorph.prototype.customCategories.keys()).sort().forEach(name=>menu.addItem(name,name,null,null,null,null,null,null,true));if(pos){menu.popup(this.world(),pos)}else{menu.popUpAtHand(this.world())}};IDE_Morph.prototype.deletePaletteCategory=function(name){this.stage.globalBlocks.forEach(def=>{if(def.category===name){def.category="other";this.currentSprite.allBlockInstances(def).reverse().forEach(block=>block.refresh())}});this.sprites.asArray().concat(this.stage).forEach(obj=>{obj.customBlocks.forEach(def=>{if(def.category===name){def.category="other";obj.allDependentInvocationsOf(def.blockSpec()).reverse().forEach(block=>block.refresh(def))}})});SpriteMorph.prototype.customCategories.delete(name);this.createCategories();this.createPaletteHandle();this.categories.fixLayout();this.flushPaletteCache();this.refreshPalette(true);this.categories.refreshEmpty();this.fixLayout();this.recordUnsavedChanges()};IDE_Morph.prototype.save=function(){var pn=this.getProjectName();if(location.protocol==="file:"){if(pn){this.exportProject(pn)}else{this.prompt("Export Project As...",name=>this.exportProject(name),null,"exportProject")}return}if(this.source==="examples"||this.source==="local"){this.source=null}if(this.cloud.disabled){this.source="disk"}if(pn){if(this.source==="disk"){this.exportProject(pn)}else if(this.source==="cloud"){this.saveProjectToCloud(pn)}else{this.saveProjectsBrowser()}}else{this.saveProjectsBrowser()}};IDE_Morph.prototype.exportProject=function(name){var menu,str;if(name){name=this.setProjectName(name);this.scene.captureGlobalSettings();try{menu=this.showMessage("Exporting");str=this.serializer.serialize(new Project(this.scenes,this.scene));this.saveXMLAs(str,name);menu.destroy();this.recordSavedChanges();this.showMessage("Exported!",1)}catch(err){if(Process.prototype.isCatchingErrors){this.showMessage("Export failed: "+err)}else{throw err}}}};IDE_Morph.prototype.exportGlobalBlocks=function(){if(this.stage.globalBlocks.length>0){new BlockExportDialogMorph(this.serializer,this.stage.globalBlocks,this).popUp(this.world())}else{this.inform("Export blocks","this project doesn't have any\n"+"custom global blocks yet")}};IDE_Morph.prototype.removeUnusedBlocks=function(){var targets=this.sprites.asArray().concat([this.stage]),globalBlocks=this.stage.globalBlocks,unused=[],isDone=false,found;function scan(){return globalBlocks.filter(def=>{if(contains(unused,def)){return false}return targets.every((each,trgIdx)=>!each.usesBlockInstance(def,true,trgIdx,unused))})}while(!isDone){found=scan();if(found.length){unused=unused.concat(found)}else{isDone=true}}if(unused.length>0){new BlockRemovalDialogMorph(unused,this).popUp(this.world())}else{this.inform("Remove unused blocks","there are currently no unused\n"+"global custom blocks in this project")}};IDE_Morph.prototype.exportSprite=function(sprite){this.saveXMLAs(sprite.toXMLString(),sprite.name)};IDE_Morph.prototype.exportScriptsPicture=function(){var pics=[],pic,padding=20,w=0,h=0,y=0,ctx;this.sprites.asArray().forEach(sprite=>{pics.push(sprite.getImage());pics.push(sprite.scripts.scriptsPicture());sprite.customBlocks.forEach(def=>pics.push(def.scriptsPicture()))});pics.push(this.stage.getImage());pics.push(this.stage.scripts.scriptsPicture());this.stage.customBlocks.forEach(def=>pics.push(def.scriptsPicture()));this.stage.globalBlocks.forEach(def=>pics.push(def.scriptsPicture()));pics=pics.filter(each=>!isNil(each));pics.forEach(each=>{w=Math.max(w,each.width);h+=each.height;h+=padding});h-=padding;pic=newCanvas(new Point(w,h));ctx=pic.getContext("2d");pics.forEach(each=>{ctx.drawImage(each,0,y);y+=padding;y+=each.height});this.saveCanvasAs(pic,this.scene.name||localize("Untitled"))};IDE_Morph.prototype.exportProjectSummary=function(useDropShadows){var html,head,meta,css,body,pname,notes,toc,globalVars,stage=this.stage;function addNode(tag,node,contents){if(!node){node=body}return new XML_Element(tag,contents,node)}function add(contents,tag,node){if(!tag){tag="p"}if(!node){node=body}return new XML_Element(tag,contents,node)}function addImage(canvas,node,inline){if(!node){node=body}var para=!inline?addNode("p",node):null,pic=addNode("img",para||node);pic.attributes.src=canvas.toDataURL();return pic}function addVariables(varFrame){var names=varFrame.names().sort(),isFirst=true,ul;if(names.length){add(localize("Variables"),"h3");names.forEach(name=>{var watcher,listMorph,li,img;if(isFirst){ul=addNode("ul");isFirst=false}li=addNode("li",ul);watcher=new WatcherMorph(name,SpriteMorph.prototype.blockColor.variables,varFrame,name);listMorph=watcher.cellMorph.contentsMorph;if(listMorph instanceof ListWatcherMorph){listMorph.expand()}img=addImage(watcher.fullImage(),li);img.attributes.class="script"})}}function addBlocks(definitions){if(definitions.length){add(localize("Blocks"),"h3");SpriteMorph.prototype.categories.forEach(category=>{var isFirst=true,ul;definitions.forEach(def=>{var li,blockImg;if(def.category===category){if(isFirst){add(localize(category[0].toUpperCase().concat(category.slice(1))),"h4");ul=addNode("ul");isFirst=false}li=addNode("li",ul);blockImg=addImage(def.templateInstance().scriptPic(),li);blockImg.attributes.class="script";def.sortedElements().forEach(script=>{var defImg=addImage(script instanceof BlockMorph?script.scriptPic():script.fullImage(),li);defImg.attributes.class="script"})}})})}}pname=this.scene.name||localize("untitled");html=new XML_Element("html");html.attributes.lang=SnapTranslator.language;head=addNode("head",html);meta=addNode("meta",head);meta.attributes.charset="UTF-8";if(useDropShadows){css="img {"+"vertical-align: top;"+"filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));"+"-webkit-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));"+"-ms-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));"+"}"+".toc {"+"vertical-align: middle;"+"padding: 2px 1em 2px 1em;"+"}"}else{css="img {"+"vertical-align: top;"+"}"+".toc {"+"vertical-align: middle;"+"padding: 2px 1em 2px 1em;"+"}"+".sprite {"+"border: 1px solid lightgray;"+"}"}addNode("style",head,css);add(pname,"title",head);body=addNode("body",html);add(pname,"h1");if(location.hash.indexOf("#present:")===0){add(location.toString(),"a",body).attributes.href=location.toString();addImage(stage.thumbnail(stage.dimensions)).attributes.class="sprite";add(this.serializer.app,"h4")}else{add(this.serializer.app,"h4");addImage(stage.thumbnail(stage.dimensions)).attributes.class="sprite"}notes=Process.prototype.reportTextSplit(this.scene.notes,"line");notes.asArray().forEach(paragraph=>add(paragraph));add(localize("Contents"),"h4");toc=addNode("ul");this.sprites.asArray().concat([stage]).forEach(sprite=>{var tocEntry=addNode("li",toc),scripts=sprite.scripts.sortedElements(),cl=sprite.costumes.length(),pic,ol;addNode("hr");addImage(sprite.thumbnail(new Point(40,40)),tocEntry,true).attributes.class="toc";add(sprite.name,"a",tocEntry).attributes.href="#"+sprite.name;add(sprite.name,"h2").attributes.id=sprite.name;pic=addImage(sprite.thumbnail(sprite.extent().divideBy(stage.scale)));pic.attributes.class="sprite";if(sprite instanceof SpriteMorph){if(sprite.exemplar){addImage(sprite.exemplar.thumbnail(new Point(40,40)),add(localize("Kind of")+" "+sprite.exemplar.name),true).attributes.class="toc"}if(sprite.anchor){addImage(sprite.anchor.thumbnail(new Point(40,40)),add(localize("Part of")+" "+sprite.anchor.name),true).attributes.class="toc"}if(sprite.parts.length){add(localize("Parts"),"h3");ol=addNode("ul");sprite.parts.forEach(part=>{var li=addNode("li",ol,part.name);addImage(part.thumbnail(new Point(40,40)),li,true).attributes.class="toc"})}}if(cl>1||sprite.getCostumeIdx()!==cl){add(localize("Costumes"),"h3");ol=addNode("ol");sprite.costumes.asArray().forEach(costume=>{var li=addNode("li",ol,costume.name);addImage(costume.thumbnail(new Point(40,40)),li,true).attributes.class="toc"})}if(sprite.sounds.length()){add(localize("Sounds"),"h3");ol=addNode("ol");sprite.sounds.asArray().forEach(sound=>add(sound.name,"li",ol))}addVariables(sprite.variables);if(scripts.length){add(localize("Scripts"),"h3");scripts.forEach(script=>{var img=addImage(script instanceof BlockMorph?script.scriptPic():script.fullImage());img.attributes.class="script"})}addBlocks(sprite.customBlocks)});globalVars=stage.globalVariables();if(Object.keys(globalVars.vars).length||stage.globalBlocks.length){addNode("hr");add(localize("For all Sprites"),"a",addNode("li",toc)).attributes.href="#global";add(localize("For all Sprites"),"h2").attributes.id="global";addVariables(globalVars);addBlocks(stage.globalBlocks)}this.saveFileAs("<!DOCTYPE html>"+html.toString(),"text/html;charset=utf-8",pname)};IDE_Morph.prototype.openProjectString=function(str,callback){var msg;if(this.bulkDropInProgress||this.isAddingScenes){this.rawOpenProjectString(str);if(callback){callback()}return}this.nextSteps([()=>msg=this.showMessage("Opening project..."),()=>{this.rawOpenProjectString(str);msg.destroy();if(callback){callback()}}])};IDE_Morph.prototype.rawOpenProjectString=function(str){this.toggleAppMode(false);this.spriteBar.tabBar.tabTo("scripts");if(Process.prototype.isCatchingErrors){try{this.openProject(this.serializer.load(str,this))}catch(err){this.showMessage("Load failed: "+err)}}else{this.openProject(this.serializer.load(str,this))}this.stopFastTracking()};IDE_Morph.prototype.openCloudDataString=function(str){var msg,size=Math.round(str.length/1024);this.nextSteps([()=>msg=this.showMessage("Opening project\n"+size+" KB..."),()=>{this.rawOpenCloudDataString(str);msg.destroy()}])};IDE_Morph.prototype.rawOpenCloudDataString=function(str){var model,setting=this.isAddingScenes;if(this.isAddingNextScene){this.isAddingScenes=true}if(Process.prototype.isCatchingErrors){try{model=this.serializer.parse(str);this.serializer.loadMediaModel(model.childNamed("media"));this.openProject(this.serializer.loadProjectModel(model.childNamed("project"),this,model.attributes.remixID))}catch(err){this.showMessage("Load failed: "+err)}}else{model=this.serializer.parse(str);this.serializer.loadMediaModel(model.childNamed("media"));this.openProject(this.serializer.loadProjectModel(model.childNamed("project"),this,model.attributes.remixID))}this.stopFastTracking();this.isAddingScenes=setting;this.isAddingNextScene=false};IDE_Morph.prototype.openBlocksString=function(str,name,silently){var msg;this.nextSteps([()=>msg=this.showMessage("Opening blocks..."),()=>{this.rawOpenBlocksString(str,name,silently);msg.destroy()}])};IDE_Morph.prototype.rawOpenBlocksString=function(str,name,silently){var blocks;this.toggleAppMode(false);this.spriteBar.tabBar.tabTo("scripts");if(Process.prototype.isCatchingErrors){try{blocks=this.serializer.loadBlocks(str,this.stage)}catch(err){this.showMessage("Load failed: "+err)}}else{blocks=this.serializer.loadBlocks(str,this.stage)}if(silently){blocks.global.forEach(def=>{def.receiver=this.stage;this.stage.globalBlocks.push(def);this.stage.replaceDoubleDefinitionsFor(def)});blocks.local.forEach(def=>{def.receiver=this.currentSprite;this.currentSprite.customBlocks.push(def);this.currentSprite.replaceDoubleDefinitionsFor(def)});this.flushPaletteCache();this.refreshPalette();this.showMessage("Imported Blocks Module"+(name?": "+name:"")+".",2)}else{new BlockImportDialogMorph(blocks.global.concat(blocks.local),this.stage,name).popUp()}this.createCategories();this.categories.refreshEmpty();this.createPaletteHandle();this.categories.fixLayout();this.fixLayout()};IDE_Morph.prototype.openSpritesString=function(str){var msg;this.nextSteps([()=>msg=this.showMessage("Opening sprite..."),()=>{this.rawOpenSpritesString(str);msg.destroy()}])};IDE_Morph.prototype.rawOpenSpritesString=function(str){this.toggleAppMode(false);this.spriteBar.tabBar.tabTo("scripts");if(Process.prototype.isCatchingErrors){try{this.deserializeSpritesString(str)}catch(err){this.showMessage("Load failed: "+err)}}else{this.deserializeSpritesString(str)}};IDE_Morph.prototype.deserializeSpritesString=function(str){var xml=this.serializer.parse(str,true),blocksModel=xml.childNamed("blocks"),blocks;if(blocksModel){blocks=this.serializer.loadBlocksModel(blocksModel,this.stage);blocks.global.forEach(def=>{def.receiver=this.stage;this.stage.globalBlocks.push(def);this.stage.replaceDoubleDefinitionsFor(def)});this.flushPaletteCache();this.refreshPalette();this.createCategories();this.categories.refreshEmpty();this.createPaletteHandle();this.categories.fixLayout();this.fixLayout()}this.serializer.loadSpritesModel(xml,this)};IDE_Morph.prototype.openMediaString=function(str){if(Process.prototype.isCatchingErrors){try{this.serializer.loadMedia(str)}catch(err){this.showMessage("Load failed: "+err)}}else{this.serializer.loadMedia(str)}this.showMessage("Imported Media Module.",2)};IDE_Morph.prototype.openScriptString=function(str){var msg;this.nextSteps([()=>msg=this.showMessage("Opening script..."),()=>{this.rawOpenScriptString(str);msg.destroy()}])};IDE_Morph.prototype.rawOpenScriptString=function(str){var world=this.world(),script;if(Process.prototype.isCatchingErrors){try{script=this.deserializeScriptString(str)}catch(err){this.showMessage("Load failed: "+err)}}else{script=this.deserializeScriptString(str)}this.spriteBar.tabBar.tabTo("scripts");script.pickUp(world);world.hand.grabOrigin={origin:this.palette,position:this.palette.center()};this.showMessage("Imported Script.",2)};IDE_Morph.prototype.deserializeScriptString=function(str){var xml=this.serializer.parse(str,true),blocksModel=xml.childNamed("blocks"),scriptModel=xml.childNamed("script")||xml,blocks;if(blocksModel){blocks=this.serializer.loadBlocksModel(blocksModel,this.stage);blocks.global.forEach(def=>{def.receiver=this.stage;this.stage.globalBlocks.push(def);this.stage.replaceDoubleDefinitionsFor(def)});blocks.local.forEach(def=>{def.receiver=this.currentSprite;this.currentSprite.customBlocks.push(def);this.currentSprite.replaceDoubleDefinitionsFor(def)});this.flushPaletteCache();this.refreshPalette();this.createCategories();this.categories.refreshEmpty();this.createPaletteHandle();this.categories.fixLayout();this.fixLayout()}return this.serializer.loadScriptModel(scriptModel,this.currentSprite)};IDE_Morph.prototype.openDataString=function(str,name,type){var msg;this.nextSteps([()=>msg=this.showMessage("Opening data..."),()=>{this.rawOpenDataString(str,name,type);msg.destroy()}])};IDE_Morph.prototype.rawOpenDataString=function(str,name,type){var data,vName,dlg,globals=this.currentSprite.globalVariables();function newVarName(name){var existing=globals.names(),ix=name.indexOf("("),stem=ix<0?name:name.substring(0,ix),count=1,newName=stem;while(contains(existing,newName)){count+=1;newName=stem+"("+count+")"}return newName}switch(type){case"csv":data=Process.prototype.parseCSV(str);break;case"json":data=Process.prototype.parseJSON(str);break;default:data=str}vName=newVarName(name||"data");globals.addVar(vName);globals.setVar(vName,data);this.currentSprite.toggleVariableWatcher(vName,true);this.flushBlocksCache("variables");this.currentCategory="variables";this.categories.refresh();this.refreshPalette(true);if(data instanceof List){dlg=new TableDialogMorph(data);dlg.labelString=localize(dlg.labelString)+": "+vName;dlg.createLabel();dlg.popUp(this.world())}};IDE_Morph.prototype.openProjectName=function(name){var str;if(name){this.showMessage("opening project\n"+name);this.setProjectName(name);str=localStorage["-snap-project-"+name];this.openProjectString(str)}};IDE_Morph.prototype.openProject=function(project){if(this.isAddingScenes){project.scenes.itemsArray().forEach(scene=>{scene.name=this.newSceneName(scene.name,scene);this.scenes.add(scene)})}else{this.scenes=project.scenes}this.switchToScene(project.currentScene||project.scenes.at(1),true,null,null,true)};IDE_Morph.prototype.switchToScene=function(scene,refreshAlbum,msg,data,pauseHats){var appMode=this.isAppMode;if(!scene||!scene.stage){return}this.siblings().forEach(morph=>morph.destroy());this.scene.captureGlobalSettings();this.scene=scene;this.globalVariables=scene.globalVariables;this.stage.destroy();this.add(scene.stage);this.stage=scene.stage;this.sprites=scene.sprites;if(pauseHats){this.stage.pauseGenericHatBlocks()}this.createCorral(!refreshAlbum);this.selectSprite(this.scene.currentSprite,true);this.corral.album.updateSelection();this.fixLayout();this.corral.album.contents.children.forEach(function(morph){if(morph.state){morph.scrollIntoView()}});scene.applyGlobalSettings();if(!SpriteMorph.prototype.allCategories().includes(this.currentCategory)){this.currentCategory="motion"}if(!this.setUnifiedPalette(scene.unifiedPalette)){this.createCategories();this.createPaletteHandle();this.categories.fixLayout();this.fixLayout();this.flushBlocksCache();this.categories.refreshEmpty();this.currentSprite.palette(this.currentCategory);this.refreshPalette(true)}this.toggleAppMode(appMode);this.controlBar.stopButton.refresh();this.world().keyboardFocus=this.stage;if(msg){this.stage.fireChangeOfSceneEvent(msg,data)}};IDE_Morph.prototype.saveFileAs=function(contents,fileType,fileName){var blobIsSupported=false,world=this.world(),fileExt,dialog;fileExt=fileType.split("/")[1].split(";")[0];fileExt="."+(fileExt==="plain"?"txt":fileExt);function dataURItoBlob(text,mimeType){var i,data=text,components=text.split(","),hasTypeStr=text.indexOf("data:")===0;if(hasTypeStr&&components[0].indexOf("base64")>-1){text=atob(components[1]);data=new Uint8Array(text.length);i=text.length;while(i--){data[i]=text.charCodeAt(i)}}else if(hasTypeStr){text=text.replace(/^data:image\/.*?, */,"");data=new Uint8Array(text.length);i=text.length;while(i--){data[i]=text.charCodeAt(i)}}return new Blob([data],{type:mimeType})}try{blobIsSupported=!!new Blob}catch(e){}if(blobIsSupported){if(!(contents instanceof Blob)){contents=dataURItoBlob(contents,fileType)}saveAs(contents,fileName+fileExt,false)}else{dialog=new DialogBoxMorph;dialog.inform(localize("Could not export")+" "+fileName,"unable to export text",world);dialog.fixLayout()}};IDE_Morph.prototype.saveCanvasAs=function(canvas,fileName){this.saveFileAs(canvas.toDataURL(),"image/png",fileName)};IDE_Morph.prototype.saveAudioAs=function(audio,fileName){this.saveFileAs(audio.src,"audio/wav",fileName)};IDE_Morph.prototype.saveXMLAs=function(xml,fileName){this.saveFileAs(xml,"text/xml;chartset=utf-8",fileName)};IDE_Morph.prototype.switchToUserMode=function(){var world=this.world();world.isDevMode=false;Process.prototype.isCatchingErrors=true;this.controlBar.updateLabel();this.isAutoFill=true;this.isDraggable=false;this.reactToWorldResize(world.bounds.copy());this.siblings().forEach(morph=>{if(morph instanceof DialogBoxMorph){world.add(morph)}else{morph.destroy()}});this.flushBlocksCache();this.refreshPalette();this.categories.refreshEmpty();world.reactToDropOf=morph=>{if(!(morph instanceof DialogBoxMorph||morph instanceof MenuMorph)){if(world.hand.grabOrigin){morph.slideBackTo(world.hand.grabOrigin)}else{world.hand.grab(morph)}}};this.showMessage("entering user mode",1)};IDE_Morph.prototype.switchToDevMode=function(){var world=this.world();world.isDevMode=true;Process.prototype.isCatchingErrors=false;this.controlBar.updateLabel();this.isAutoFill=false;this.isDraggable=true;this.setExtent(world.extent().subtract(100));this.setPosition(world.position().add(20));this.flushBlocksCache();this.refreshPalette();this.categories.refreshEmpty();delete world.reactToDropOf;this.showMessage("entering development mode.\n\n"+"error catching is turned off,\n"+"use the browser's web console\n"+"to see error messages.")};IDE_Morph.prototype.flushBlocksCache=function(category){if(category&&category!=="unified"){this.stage.primitivesCache[category]=null;this.stage.children.forEach(m=>{if(m instanceof SpriteMorph){m.primitivesCache[category]=null}})}else{this.stage.primitivesCache={};this.stage.children.forEach(m=>{if(m instanceof SpriteMorph){m.primitivesCache={}}})}this.flushPaletteCache(category)};IDE_Morph.prototype.flushPaletteCache=function(category){if(category){this.stage.paletteCache[category]=null;this.stage.paletteCache.unified=null;this.stage.children.forEach(m=>{if(m instanceof SpriteMorph){m.paletteCache[category]=null;m.paletteCache.unified=null}})}else{this.stage.paletteCache={};this.stage.children.forEach(m=>{if(m instanceof SpriteMorph){m.paletteCache={}}})}this.stage.categoriesCache=null;this.stage.children.forEach(m=>{if(m instanceof SpriteMorph){m.categoriesCache=null}})};IDE_Morph.prototype.toggleZebraColoring=function(){var scripts=[];if(!BlockMorph.prototype.zebraContrast){BlockMorph.prototype.zebraContrast=40}else{BlockMorph.prototype.zebraContrast=0}this.stage.children.concat(this.stage).forEach(morph=>{if(isSnapObject(morph)){scripts=scripts.concat(morph.scripts.children.filter(morph=>morph instanceof BlockMorph))}});scripts.forEach(topBlock=>topBlock.fixBlockColor(null,true))};IDE_Morph.prototype.toggleDynamicInputLabels=function(){SyntaxElementMorph.prototype.dynamicInputLabels=!SyntaxElementMorph.prototype.dynamicInputLabels;this.refreshIDE()};IDE_Morph.prototype.toggleBlurredShadows=function(){window.useBlurredShadows=!useBlurredShadows;this.rerender();if(window.useBlurredShadows){this.removeSetting("solidshadow")}else{this.saveSetting("solidshadow",false)}};IDE_Morph.prototype.toggleLongFormInputDialog=function(){InputSlotDialogMorph.prototype.isLaunchingExpanded=!InputSlotDialogMorph.prototype.isLaunchingExpanded;if(InputSlotDialogMorph.prototype.isLaunchingExpanded){this.removeSetting("longform")}else{this.saveSetting("longform",false)}};IDE_Morph.prototype.togglePlainPrototypeLabels=function(){BlockLabelPlaceHolderMorph.prototype.plainLabel=!BlockLabelPlaceHolderMorph.prototype.plainLabel;if(BlockLabelPlaceHolderMorph.prototype.plainLabel){this.removeSetting("plainprototype")}else{this.saveSetting("plainprototype",false)}};IDE_Morph.prototype.togglePreferEmptySlotDrops=function(){ScriptsMorph.prototype.isPreferringEmptySlots=!ScriptsMorph.prototype.isPreferringEmptySlots};IDE_Morph.prototype.toggleInputSliders=function(){MorphicPreferences.useSliderForInput=!MorphicPreferences.useSliderForInput};IDE_Morph.prototype.toggleSliderExecute=function(){ArgMorph.prototype.executeOnSliderEdit=!ArgMorph.prototype.executeOnSliderEdit};IDE_Morph.prototype.setEmbedMode=function(){var myself=this;this.isEmbedMode=true;this.appModeColor=new Color(243,238,235);this.embedOverlay=new Morph;this.embedOverlay.color=new Color(128,128,128);this.embedOverlay.alpha=.5;this.embedPlayButton=new SymbolMorph("circleSolid");this.embedPlayButton.color=new Color(64,128,64);this.embedPlayButton.alpha=.75;this.embedPlayButton.flag=new SymbolMorph("flag");this.embedPlayButton.flag.color=new Color(128,255,128);this.embedPlayButton.flag.alpha=.75;this.embedPlayButton.add(this.embedPlayButton.flag);this.embedPlayButton.mouseClickLeft=function(){myself.runScripts();myself.embedOverlay.destroy();this.destroy()};this.controlBar.hide();this.add(this.embedOverlay);this.add(this.embedPlayButton);this.fixLayout()};IDE_Morph.prototype.toggleAppMode=function(appMode){var world=this.world(),elements=[this.logo,this.controlBar.cloudButton,this.controlBar.projectButton,this.controlBar.settingsButton,this.controlBar.steppingButton,this.controlBar.stageSizeButton,this.paletteHandle,this.stageHandle,this.corral,this.corralBar,this.spriteEditor,this.spriteBar,this.palette,this.categories];this.isAppMode=isNil(appMode)?!this.isAppMode:appMode;if(this.isAppMode){this.wasSingleStepping=Process.prototype.enableSingleStepping;if(this.wasSingleStepping){this.toggleSingleStepping()}this.setColor(this.appModeColor);this.controlBar.setColor(this.color);this.controlBar.appModeButton.refresh();elements.forEach(e=>e.hide());world.children.forEach(morph=>{if(morph instanceof DialogBoxMorph){morph.hide()}});if(world.keyboardFocus instanceof ScriptFocusMorph){world.keyboardFocus.stopEditing()}}else{if(this.wasSingleStepping&&!Process.prototype.enableSingleStepping){this.toggleSingleStepping()}this.setColor(this.backgroundColor);this.controlBar.setColor(this.frameColor);elements.forEach(e=>e.show());this.stage.setScale(1);world.children.forEach(morph=>{if(morph instanceof DialogBoxMorph){morph.show()}});world.allChildren().filter(c=>c instanceof ScrollFrameMorph).forEach(s=>s.adjustScrollBars());if(this.currentSprite===this.stage){this.spriteBar.children.forEach(child=>{if(child instanceof PushButtonMorph){child.hide()}})}this.currentSprite.scripts.updateToolbar()}this.setExtent(this.world().extent())};IDE_Morph.prototype.toggleStageSize=function(isSmall,forcedRatio){var myself=this,smallRatio=forcedRatio||.5,msecs=this.isAnimating?100:0,world=this.world(),shiftClicked=world.currentKey===16,altClicked=world.currentKey===18;function toggle(){myself.isSmallStage=isNil(isSmall)?!myself.isSmallStage:isSmall}function zoomTo(targetRatio){myself.isSmallStage=true;world.animations.push(new Animation(ratio=>{myself.stageRatio=ratio;myself.setExtent(world.extent())},()=>myself.stageRatio,targetRatio-myself.stageRatio,msecs,null,()=>{myself.isSmallStage=targetRatio!==1;myself.controlBar.stageSizeButton.refresh()}))}if(shiftClicked){smallRatio=SpriteIconMorph.prototype.thumbSize.x*3/this.stage.dimensions.x;if(!this.isSmallStage||smallRatio===this.stageRatio){toggle()}}else if(altClicked){smallRatio=this.width()/2/this.stage.dimensions.x;if(!this.isSmallStage||smallRatio===this.stageRatio){toggle()}}else{toggle()}if(this.isSmallStage){zoomTo(smallRatio)}else{zoomTo(1)}};IDE_Morph.prototype.toggleUnifiedPalette=function(){this.setUnifiedPalette(!this.scene.unifiedPalette);this.recordUnsavedChanges()};IDE_Morph.prototype.setUnifiedPalette=function(bool){if(this.scene.unifiedPalette===bool&&bool===(this.currentCategory==="unified")){return false}this.scene.unifiedPalette=bool;this.currentCategory=bool?"unified":"motion";this.createCategories();this.createPaletteHandle();this.categories.fixLayout();this.fixLayout();this.flushBlocksCache();this.categories.refreshEmpty();this.currentSprite.palette(this.currentCategory);this.refreshPalette(true);return true};IDE_Morph.prototype.toggleCategoryNames=function(){this.scene.showCategories=!this.scene.showCategories;this.flushBlocksCache();this.refreshPalette();this.recordUnsavedChanges()};IDE_Morph.prototype.togglePaletteButtons=function(){this.scene.showPaletteButtons=!this.scene.showPaletteButtons;this.flushBlocksCache();this.refreshPalette();this.recordUnsavedChanges()};IDE_Morph.prototype.setPaletteWidth=function(newWidth){var msecs=this.isAnimating?100:0,world=this.world();world.animations.push(new Animation(newWidth=>{this.paletteWidth=newWidth;this.setExtent(world.extent())},()=>this.paletteWidth,newWidth-this.paletteWidth,msecs))};IDE_Morph.prototype.createNewProject=function(){this.backup(()=>this.newProject())};IDE_Morph.prototype.addScene=function(){var setting=this.isAddingScenes;if(location.protocol==="file:"){this.isAddingScenes=true;this.importLocalFile();this.isAddingScenes=setting;return}new ProjectDialogMorph(this,"add").popUp()};IDE_Morph.prototype.openProjectsBrowser=function(){if(location.protocol==="file:"){this.importLocalFile();return}new ProjectDialogMorph(this,"open").popUp()};IDE_Morph.prototype.saveProjectsBrowser=function(){if(location.protocol==="file:"){this.prompt("Export Project As...",name=>this.exportProject(name),null,"exportProject");return}if(this.source==="examples"){this.source=null}new ProjectDialogMorph(this,"save").popUp()};IDE_Morph.prototype.microphoneMenu=function(){var menu=new MenuMorph(this),world=this.world(),pos=this.controlBar.settingsButton.bottomLeft(),resolutions=["low","normal","high","max"],microphone=this.stage.microphone,tick=new SymbolMorph("tick",MorphicPreferences.menuFontSize*.75),on=new SymbolMorph("checkedBox",MorphicPreferences.menuFontSize*.75),empty=tick.fullCopy();empty.render=nop;if(microphone.isReady){menu.addItem([on,localize("Microphone")],()=>microphone.stop());menu.addLine()}resolutions.forEach((res,i)=>{menu.addItem([microphone.resolution===i+1?tick:empty,localize(res)],()=>microphone.setResolution(i+1))});menu.popup(world,pos)};IDE_Morph.prototype.languageMenu=function(){var menu=new MenuMorph(this),world=this.world(),pos=this.controlBar.settingsButton.bottomLeft(),tick=new SymbolMorph("tick",MorphicPreferences.menuFontSize*.75),empty=tick.fullCopy();empty.render=nop;SnapTranslator.languages().forEach(lang=>menu.addItem([SnapTranslator.language===lang?tick:empty,SnapTranslator.languageName(lang)],()=>{this.loadNewProject=false;this.setLanguage(lang)}));menu.popup(world,pos)};IDE_Morph.prototype.setLanguage=function(lang,callback,noSave){this.reflectLanguage(lang,callback,noSave);};IDE_Morph.prototype.reflectLanguage=function(lang,callback,noSave){var projectData,urlBar=location.hash;SnapTranslator.language=lang;if(!this.loadNewProject){this.scene.captureGlobalSettings();if(Process.prototype.isCatchingErrors){try{projectData=this.serializer.serialize(new Project(this.scenes,this.scene))}catch(err){this.showMessage("Serialization failed: "+err)}}else{projectData=this.serializer.serialize(new Project(this.scenes,this.scene))}}SpriteMorph.prototype.initBlocks();this.spriteBar.tabBar.tabTo("scripts");this.createCategories();this.categories.refreshEmpty();this.createCorralBar();this.fixLayout();if(this.loadNewProject){this.newProject();location.hash=urlBar;if(callback){callback.call(this)}}else{this.openProjectString(projectData,callback)}if(!noSave){this.saveSetting("language",lang)}};IDE_Morph.prototype.userSetBlocksScale=function(){var scrpt,blck,shield,sample,action,dlg;scrpt=new CommandBlockMorph;scrpt.color=SpriteMorph.prototype.blockColor.motion;scrpt.setSpec(localize("build"));blck=new CommandBlockMorph;blck.color=SpriteMorph.prototype.blockColor.sound;blck.setSpec(localize("your own"));scrpt.nextBlock(blck);blck=new CommandBlockMorph;blck.color=SpriteMorph.prototype.blockColor.operators;blck.setSpec(localize("blocks"));scrpt.bottomBlock().nextBlock(blck);sample=new FrameMorph;sample.acceptsDrops=false;sample.color=IDE_Morph.prototype.groupColor;if(SyntaxElementMorph.prototype.alpha>.8){sample.cachedTexture=this.scriptsPaneTexture}sample.setExtent(new Point(250,180));scrpt.setPosition(sample.position().add(10));sample.add(scrpt);shield=new Morph;shield.alpha=0;shield.setExtent(sample.extent());shield.setPosition(sample.position());sample.add(shield);action=num=>{scrpt.blockSequence().forEach(block=>{block.setScale(num);block.setSpec(block.blockSpec)});scrpt.fullChanged()};dlg=new DialogBoxMorph(null,num=>this.setBlocksScale(Math.min(num,12))).withKey("zoomBlocks");if(MorphicPreferences.isTouchDevice){dlg.isDraggable=false}dlg.prompt("Zoom blocks",SyntaxElementMorph.prototype.scale.toString(),this.world(),sample,{"normal (1x)":1,"demo (1.2x)":1.2,"presentation (1.4x)":1.4,"big (2x)":2,"huge (4x)":4,"giant (8x)":8,"monstrous (10x)":10},false,true,1,5,action)};IDE_Morph.prototype.setBlocksScale=function(num){var projectData;this.scene.captureGlobalSettings();if(Process.prototype.isCatchingErrors){try{projectData=this.serializer.serialize(new Project(this.scenes,this.scene))}catch(err){this.showMessage("Serialization failed: "+err)}}else{projectData=this.serializer.serialize(new Project(this.scenes,this.scene))}SyntaxElementMorph.prototype.setScale(num);CommentMorph.prototype.refreshScale();SpriteMorph.prototype.initBlocks();this.spriteBar.tabBar.tabTo("scripts");this.createCategories();this.categories.refreshEmpty();this.createCorralBar();this.fixLayout();this.openProjectString(projectData);this.saveSetting("zoom",num)};IDE_Morph.prototype.userFadeBlocks=function(){var dlg,initial=100-SyntaxElementMorph.prototype.alpha*100;dlg=new DialogBoxMorph(null,num=>this.setBlockTransparency(num,true)).withKey("fadeBlocks");if(MorphicPreferences.isTouchDevice){dlg.isDraggable=false}dlg.cancel=()=>{this.setBlockTransparency(initial);dlg.destroy()};dlg.prompt("Fade blocks",initial.toString(),this.world(),null,{"block-solid (0)":0,"medium (50)":50,"light (70)":70,"shimmering (80)":80,"elegant (90)":90,"subtle (95)":95,"text-only (100)":100},false,true,0,100,num=>this.setBlockTransparency(num),0)};IDE_Morph.prototype.setBlockTransparency=function(num,save){SyntaxElementMorph.prototype.setAlphaScaled(100-num);this.changed();if(save){if(num===0){this.removeSetting("fade")}else{this.saveSetting("fade",num)}}};IDE_Morph.prototype.userSetStageSize=function(){new DialogBoxMorph(this,this.setStageExtent,this).promptVector("Stage size",this.stage.dimensions,new Point(480,360),"Stage width","Stage height",this.world(),null,null)};IDE_Morph.prototype.setStageExtent=function(aPoint){var myself=this,world=this.world(),ext=aPoint.max(new Point(240,180));function zoom(){myself.step=function(){var delta=ext.subtract(myself.stage.dimensions).divideBy(2);if(delta.abs().lt(new Point(5,5))){myself.stage.dimensions=ext;delete myself.step}else{myself.stage.dimensions=myself.stage.dimensions.add(delta)}myself.stage.setExtent(myself.stage.dimensions);myself.stage.clearPenTrails();myself.fixLayout();this.setExtent(world.extent())}}this.stageRatio=1;this.isSmallStage=false;this.controlBar.stageSizeButton.refresh();this.stage.stopVideo();this.setExtent(world.extent());Costume.prototype.maxDimensions=aPoint;if(this.isAnimating){zoom()}else{this.stage.dimensions=ext;this.stage.setExtent(this.stage.dimensions);this.stage.clearPenTrails();this.fixLayout();this.setExtent(world.extent())}};IDE_Morph.prototype.userSetDragThreshold=function(){new DialogBoxMorph(this,num=>MorphicPreferences.grabThreshold=Math.min(Math.max(+num,0),200),this).prompt("Dragging threshold",MorphicPreferences.grabThreshold.toString(),this.world(),null,null,null,true)};IDE_Morph.prototype.initializeCloud=function(){var world=this.world();new DialogBoxMorph(null,user=>this.cloud.login(user.username.toLowerCase(),user.password,user.choice,(username,role,response)=>{sessionStorage.username=username;this.controlBar.cloudButton.refresh();this.source="cloud";if(!isNil(response.days_left)){var duration=response.days_left+" day"+(response.days_left>1?"s":"");(new DialogBoxMorph).inform("Unverified account: "+duration+" left"+"You are now logged in, and your account\n"+"is enabled for "+duration+".\n"+"Please use the verification link that\n"+"was sent to your email address when you\n"+"signed up.\n\n"+"If you cannot find that email, please\n"+"check your spam folder. If you still\n"+'cannot find it, please use the "Resend\n'+'Verification Email..." option in the cloud\n'+"menu.\n\n"+"You have "+duration+" left.",world,this.cloudIcon(null,new Color(0,180,0)))}else{this.showMessage(response.message,2)}},this.cloudError())).withKey("cloudlogin").promptCredentials("Sign in","login",null,null,null,null,"stay signed in on this computer\nuntil logging out",world,this.cloudIcon(),this.cloudMsg)};IDE_Morph.prototype.createCloudAccount=function(){var world=this.world();new DialogBoxMorph(null,user=>this.cloud.signup(user.username,user.password,user.passwordRepeat,user.email,(txt,title)=>(new DialogBoxMorph).inform(title,txt+".\n\nYou can now log in.",world,this.cloudIcon(null,new Color(0,180,0))),this.cloudError())).withKey("cloudsignup").promptCredentials("Sign up","signup","https://snap.berkeley.edu/tos.html","Terms of Service...","https://snap.berkeley.edu/privacy.html","Privacy...","I have read and agree\nto the Terms of Service",world,this.cloudIcon(),this.cloudMsg)};IDE_Morph.prototype.resetCloudPassword=function(){var world=this.world();new DialogBoxMorph(null,user=>this.cloud.resetPassword(user.username,(txt,title)=>(new DialogBoxMorph).inform(title,txt+"\n\nAn e-mail with a link to\n"+"reset your password\n"+"has been sent to the address provided",world,this.cloudIcon(null,new Color(0,180,0))),this.cloudError())).withKey("cloudresetpassword").promptCredentials("Reset password","resetPassword",null,null,null,null,null,world,this.cloudIcon(),this.cloudMsg)};IDE_Morph.prototype.resendVerification=function(){var world=this.world();new DialogBoxMorph(null,user=>this.cloud.resendVerification(user.username,(txt,title)=>(new DialogBoxMorph).inform(title,txt,world,this.cloudIcon(null,new Color(0,180,0))),this.cloudError())).withKey("cloudresendverification").promptCredentials("Resend verification email","resendVerification",null,null,null,null,null,world,this.cloudIcon(),this.cloudMsg)};IDE_Morph.prototype.changeCloudPassword=function(){var world=this.world();new DialogBoxMorph(null,user=>this.cloud.changePassword(user.oldpassword,user.password,user.passwordRepeat,()=>this.showMessage("password has been changed.",2),this.cloudError())).withKey("cloudpassword").promptCredentials("Change Password","changePassword",null,null,null,null,null,world,this.cloudIcon(),this.cloudMsg)};IDE_Morph.prototype.logout=function(){this.cloud.logout(()=>{delete sessionStorage.username;this.controlBar.cloudButton.refresh();this.showMessage("disconnected.",2)},()=>{delete sessionStorage.username;this.controlBar.cloudButton.refresh();this.showMessage("disconnected.",2)})};IDE_Morph.prototype.buildProjectRequest=function(){var proj=new Project(this.scenes,this.scene),body,xml;this.scene.captureGlobalSettings();this.serializer.isCollectingMedia=true;xml=this.serializer.serialize(proj);body={notes:proj.notes,xml:xml,media:this.serializer.mediaXML(proj.name),thumbnail:proj.thumbnail.toDataURL(),remixID:this.stage.remixID};this.serializer.isCollectingMedia=false;this.serializer.flushMedia();return body};IDE_Morph.prototype.verifyProject=function(body){var encodedBody=JSON.stringify(body);if(encodedBody.length>Cloud.MAX_FILE_SIZE){(new DialogBoxMorph).inform("Snap!Cloud - Cannot Save Project","The media inside this project exceeds 10 MB.\n"+"Please reduce the size of costumes or sounds.\n",this.world(),this.cloudIcon(null,new Color(180,0,0)));return false}try{this.serializer.parse(body.xml)}catch(err){this.showMessage("Serialization of program data failed:\n"+err);return false}if(body.media!==null){try{this.serializer.parse(body.media)}catch(err){this.showMessage("Serialization of media failed:\n"+err);return false}}this.serializer.isCollectingMedia=false;this.serializer.flushMedia();return encodedBody.length};IDE_Morph.prototype.saveProjectToCloud=function(name){var projectBody,projectSize;if(name){name=this.setProjectName(name)}this.showMessage("Saving project\nto the cloud...");projectBody=this.buildProjectRequest();projectSize=this.verifyProject(projectBody);if(!projectSize){return}this.showMessage("Uploading "+Math.round(projectSize/1024)+" KB...");this.cloud.saveProject(this.getProjectName(),projectBody,()=>{this.recordSavedChanges();this.showMessage("saved.",2)},this.cloudError())};IDE_Morph.prototype.exportProjectMedia=function(name){var menu,media;this.scene.captureGlobalSettings();this.serializer.isCollectingMedia=true;if(name){this.setProjectName(name);try{menu=this.showMessage("Exporting");this.serializer.serialize(new Project(this.scenes,this.scene));media=this.serializer.mediaXML(name);this.saveXMLAs(media,this.getProjectName()+" media");menu.destroy();this.showMessage("Exported!",1)}catch(err){if(Process.prototype.isCatchingErrors){this.serializer.isCollectingMedia=false;this.showMessage("Export failed: "+err)}else{throw err}}}this.serializer.isCollectingMedia=false;this.serializer.flushMedia()};IDE_Morph.prototype.exportProjectNoMedia=function(name){var menu,str;this.scene.captureGlobalSettings();this.serializer.isCollectingMedia=true;if(name){name=this.setProjectName(name);if(Process.prototype.isCatchingErrors){try{menu=this.showMessage("Exporting");str=this.serializer.serialize(new Project(this.scenes,this.scene));this.saveXMLAs(str,name);menu.destroy();this.showMessage("Exported!",1)}catch(err){this.serializer.isCollectingMedia=false;this.showMessage("Export failed: "+err)}}else{menu=this.showMessage("Exporting");str=this.serializer.serialize(new Project(this.scenes,this.scene));this.saveXMLAs(str,name);menu.destroy();this.showMessage("Exported!",1)}}this.serializer.isCollectingMedia=false;this.serializer.flushMedia()};IDE_Morph.prototype.exportProjectAsCloudData=function(name){var menu,str,media,dta;this.scene.captureGlobalSettings();this.serializer.isCollectingMedia=true;if(name){name=this.setProjectName(name);if(Process.prototype.isCatchingErrors){try{menu=this.showMessage("Exporting");str=this.serializer.serialize(new Project(this.scenes,this.scene));media=this.serializer.mediaXML(name);dta="<snapdata>"+str+media+"</snapdata>";this.saveXMLAs(dta,name);menu.destroy();this.showMessage("Exported!",1)}catch(err){this.serializer.isCollectingMedia=false;this.showMessage("Export failed: "+err)}}else{menu=this.showMessage("Exporting");str=this.serializer.serialize(new Project(this.scenes,this.scene));media=this.serializer.mediaXML(name);dta="<snapdata>"+str+media+"</snapdata>";this.saveXMLAs(str,name);menu.destroy();this.showMessage("Exported!",1)}}this.serializer.isCollectingMedia=false;this.serializer.flushMedia()};IDE_Morph.prototype.cloudAcknowledge=function(){return(responseText,url)=>{nop(responseText);(new DialogBoxMorph).inform("Cloud Connection","Successfully connected to:\n"+"http://"+url,this.world(),this.cloudIcon(null,new Color(0,180,0)))}};IDE_Morph.prototype.cloudResponse=function(){return(responseText,url)=>{var response=responseText;if(response.length>50){response=response.substring(0,50)+"..."}(new DialogBoxMorph).inform("Snap!Cloud","http://"+url+":\n\n"+"responds:\n"+response,this.world(),this.cloudIcon(null,new Color(0,180,0)))}};IDE_Morph.prototype.cloudError=function(){return(responseText,url)=>{var response=responseText,explanation=null;if(this.shield){this.shield.destroy();this.shield=null}if(explanation){this.showMessage(explanation);return}(new DialogBoxMorph).inform("Snap!Cloud",(url?url+"\n":"")+response,this.world(),this.cloudIcon(null,new Color(180,0,0)))}};IDE_Morph.prototype.cloudIcon=function(height,color){var clr=color||DialogBoxMorph.prototype.titleBarColor,isFlat=MorphicPreferences.isFlat,icon=new SymbolMorph(isFlat?"cloud":"cloudGradient",height||50,clr,isFlat?null:new Point(-1,-1),clr.darker(50));if(!isFlat){icon.addShadow(new Point(1,1),1,clr.lighter(95))}return icon};IDE_Morph.prototype.setCloudURL=function(){new DialogBoxMorph(null,url=>{this.cloud.url=url;this.cloud.checkCredentials(()=>this.controlBar.cloudButton.refresh(),()=>this.controlBar.cloudButton.refresh())}).withKey("cloudURL").prompt("Cloud URL",this.cloud.url,this.world(),null,this.cloud.knownDomains)};IDE_Morph.prototype.urlParameters=function(){var parameters=location.hash.slice(location.hash.indexOf(":")+1);return this.cloud.parseDict(parameters)};IDE_Morph.prototype.hasCloudProject=function(){var params=this.urlParameters();return params.hasOwnProperty("Username")&&params.hasOwnProperty("ProjectName")};IDE_Morph.prototype.getURL=function(url,callback,responseType){var request=new XMLHttpRequest,async=callback instanceof Function,rsp;if(async){request.responseType=responseType||"text"}rsp=!async||request.responseType==="text"?"responseText":"response";try{request.open("GET",url,async);if(async){request.onreadystatechange=()=>{if(request.readyState===4){if(request[rsp]){callback.call(this,request[rsp])}else{this.showMessage("unable to retrieve "+url);throw new Error("unable to retrieve "+url)}}}}request.send();if(!async){if(request.status===200){return request[rsp]}throw new Error("unable to retrieve "+url)}}catch(err){this.showMessage(err.toString());if(async){callback.call(this)}else{return request[rsp]}}};IDE_Morph.prototype.blocksLibraryXML=function(definitions,moreCategories,asFile){var globals=definitions.filter(def=>def.isGlobal),locals=definitions.filter(def=>!def.isGlobal),glbStr=globals.length?this.serializer.serialize(globals,true):"",locStr=locals.length?this.serializer.serialize(locals,true):"",cats=moreCategories||[],appStr=' app="'+this.serializer.app+'" version="'+this.serializer.version+'"';return"<blocks"+(asFile?appStr:"")+">"+this.paletteXML(definitions.map(def=>def.category).concat(cats))+(globals.length?glbStr:"")+(locals.length?"<local>"+locStr+"</local>":"")+"</blocks>"};IDE_Morph.prototype.paletteXML=function(categoryNames){var palette=new Map;categoryNames.forEach(cat=>{if(SpriteMorph.prototype.customCategories.has(cat)){palette.set(cat,SpriteMorph.prototype.customCategories.get(cat))}});return this.serializer.paletteToXML(palette)};IDE_Morph.prototype.showMessage=function(message,secs){var m=new MenuMorph(null,message),intervalHandle;m.popUpCenteredInWorld(this.world());if(secs){intervalHandle=setInterval(()=>{m.destroy();clearInterval(intervalHandle)},secs*1e3)}return m};IDE_Morph.prototype.inform=function(title,message){(new DialogBoxMorph).inform(title,localize(message),this.world())};IDE_Morph.prototype.confirm=function(message,title,action){new DialogBoxMorph(null,action).askYesNo(title,localize(message),this.world())};IDE_Morph.prototype.prompt=function(message,callback,choices,key){new DialogBoxMorph(null,callback).withKey(key).prompt(message,"",this.world(),null,choices)};IDE_Morph.prototype.warnAboutIE=function(){var dlg,txt;if(this.isIE()){dlg=new DialogBoxMorph;txt=new TextMorph("Please do not use Internet Explorer.\n"+"Snap! runs best in a web-standards\n"+"compliant browser",dlg.fontSize,dlg.fontStyle,true,false,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE);dlg.key="IE-Warning";dlg.labelString="Internet Explorer";dlg.createLabel();dlg.addBody(txt);dlg.fixLayout();dlg.popUp(this.world())}};IDE_Morph.prototype.isIE=function(){var ua=navigator.userAgent;return ua.indexOf("MSIE ")>-1||ua.indexOf("Trident/")>-1};IDE_Morph.prototype.warnAboutDev=function(){if(!SnapVersion.includes("-dev")){return}this.inform("CAUTION! Development Version","This version of Snap! is being developed.\n"+"*** It is NOT supported for end users. ***\n"+"Saving a project in THIS version is likely to\n"+"make it UNUSABLE or DEFECTIVE for current and\n"+"even future official versions!\n\n"+"visit https://snap.berkeley.edu/run\n"+"for the official Snap! installation.")};ProjectDialogMorph.prototype=new DialogBoxMorph;ProjectDialogMorph.prototype.constructor=ProjectDialogMorph;ProjectDialogMorph.uber=DialogBoxMorph.prototype;function ProjectDialogMorph(ide,label){this.init(ide,label)}ProjectDialogMorph.prototype.init=function(ide,task){this.ide=ide;this.task=task||"open";this.source=ide.source;this.projectList=[];this.handle=null;this.srcBar=null;this.nameField=null;this.filterField=null;this.magnifyingGlass=null;this.listField=null;this.preview=null;this.notesText=null;this.notesField=null;this.deleteButton=null;this.shareButton=null;this.unshareButton=null;this.publishButton=null;this.unpublishButton=null;this.recoverButton=null;ProjectDialogMorph.uber.init.call(this,this,null,null);switch(this.task){case"save":this.labelString="Save Project";break;case"add":this.labelString="Add Scene";break;default:this.task="open";this.labelString="Open Project"}this.createLabel();this.key="project"+task;if((task==="open"||task==="add")&&this.source==="disk"){this.source=null;this.buildContents();this.projectList=[];this.listField.hide();this.source="disk"}else{this.buildContents();this.onNextStep=()=>this.setSource(this.source)}};ProjectDialogMorph.prototype.buildContents=function(){var thumbnail,notification;this.addBody(new Morph);this.body.color=this.color;this.srcBar=new AlignmentMorph("column",this.padding/2);if(this.ide.cloudMsg){notification=new TextMorph(this.ide.cloudMsg,10,null,false,null,null,null,null,new Point(1,1),WHITE);notification.refresh=nop;this.srcBar.add(notification)}if(!this.ide.cloud.disabled){this.addSourceButton("cloud",localize("Cloud"),"cloud")}if(this.task==="open"||this.task==="add"){this.buildFilterField();this.addSourceButton("examples",localize("Examples"),"poster");if(this.hasLocalProjects()||this.ide.world().currentKey===16){this.addSourceButton("local",localize("Browser"),"globe")}}this.addSourceButton("disk",localize("Computer"),"storage");this.srcBar.fixLayout();this.body.add(this.srcBar);if(this.task==="save"){this.nameField=new InputFieldMorph(this.ide.getProjectName());this.body.add(this.nameField)}this.listField=new ListMorph([]);this.fixListFieldItemColors();this.listField.fixLayout=nop;this.listField.edge=InputFieldMorph.prototype.edge;this.listField.fontSize=InputFieldMorph.prototype.fontSize;this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.listField.contrast=InputFieldMorph.prototype.contrast;this.listField.render=InputFieldMorph.prototype.render;this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.body.add(this.listField);this.preview=new Morph;this.preview.fixLayout=nop;this.preview.edge=InputFieldMorph.prototype.edge;this.preview.fontSize=InputFieldMorph.prototype.fontSize;this.preview.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.preview.contrast=InputFieldMorph.prototype.contrast;this.preview.render=function(ctx){InputFieldMorph.prototype.render.call(this,ctx);if(this.cachedTexture){this.renderCachedTexture(ctx)}else if(this.texture){this.renderTexture(this.texture,ctx)}};this.preview.renderCachedTexture=function(ctx){ctx.drawImage(this.cachedTexture,this.edge,this.edge)};this.preview.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.preview.setExtent(this.ide.serializer.thumbnailSize.add(this.preview.edge*2));this.body.add(this.preview);if(this.task==="save"){thumbnail=this.ide.scenes.at(1).stage.thumbnail(SnapSerializer.prototype.thumbnailSize);this.preview.texture=null;this.preview.cachedTexture=thumbnail;this.preview.rerender()}this.notesField=new ScrollFrameMorph;this.notesField.fixLayout=nop;this.notesField.edge=InputFieldMorph.prototype.edge;this.notesField.fontSize=InputFieldMorph.prototype.fontSize;this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.notesField.contrast=InputFieldMorph.prototype.contrast;this.notesField.render=InputFieldMorph.prototype.render;this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.notesField.acceptsDrops=false;this.notesField.contents.acceptsDrops=false;if(this.task==="open"||this.task==="add"){this.notesText=new TextMorph("")}else{this.notesText=new TextMorph(this.ide.getProjectNotes());this.notesText.isEditable=true;this.notesText.enableSelecting()}this.notesField.isTextLineWrapping=true;this.notesField.padding=3;this.notesField.setContents(this.notesText);this.notesField.setWidth(this.preview.width());this.body.add(this.notesField);if(this.task==="open"){this.addButton("openProject","Open");this.action="openProject";this.recoverButton=this.addButton("recoveryDialog","Recover",true);this.recoverButton.hide()}else if(this.task==="add"){this.addButton("addScene","Add");this.action="addScene";this.recoverButton=this.addButton("recoveryDialog","Recover",true);this.recoverButton.hide()}else{this.addButton("saveProject","Save");this.action="saveProject"}this.shareButton=this.addButton("shareProject","Share",true);this.unshareButton=this.addButton("unshareProject","Unshare",true);this.shareButton.hide();this.unshareButton.hide();this.publishButton=this.addButton("publishProject","Publish",true);this.unpublishButton=this.addButton("unpublishProject","Unpublish",true);this.publishButton.hide();this.unpublishButton.hide();this.deleteButton=this.addButton("deleteProject","Delete");this.addButton("cancel","Cancel");if(notification){this.setExtent(new Point(500,360).add(notification.extent()))}else{this.setExtent(new Point(500,360))}this.fixLayout()};ProjectDialogMorph.prototype.popUp=function(wrrld){var world=wrrld||this.ide.world();if(world){ProjectDialogMorph.uber.popUp.call(this,world);this.handle=new HandleMorph(this,350,330,this.corner,this.corner)}};ProjectDialogMorph.prototype.createButtons=function(){if(this.buttons){this.buttons.destroy()}this.buttons=new AlignmentMorph("column",this.padding/3);this.buttons.bottomRow=new AlignmentMorph("row",this.padding);this.buttons.topRow=new AlignmentMorph("row",this.padding);this.buttons.add(this.buttons.topRow);this.buttons.add(this.buttons.bottomRow);this.add(this.buttons);this.buttons.fixLayout=function(){if(this.topRow.children.some(function(any){return any.isVisible})){this.topRow.show();this.topRow.fixLayout()}else{this.topRow.hide()}this.bottomRow.fixLayout();AlignmentMorph.prototype.fixLayout.call(this)}};ProjectDialogMorph.prototype.addButton=function(action,label,topRow){var button=new PushButtonMorph(this,action||"ok","  "+localize(label||"OK")+"  ");button.fontSize=this.buttonFontSize;button.corner=this.buttonCorner;button.edge=this.buttonEdge;button.outline=this.buttonOutline;button.outlineColor=this.buttonOutlineColor;button.outlineGradient=this.buttonOutlineGradient;button.padding=this.buttonPadding;button.contrast=this.buttonContrast;button.fixLayout();if(topRow){this.buttons.topRow.add(button)}else{this.buttons.bottomRow.add(button)}return button};ProjectDialogMorph.prototype.addSourceButton=function(source,label,symbol){var lbl1=new StringMorph(label,10,null,true,null,null,new Point(1,1),WHITE),lbl2=new StringMorph(label,10,null,true,null,null,new Point(-1,-1),this.titleBarColor.darker(50),WHITE),l1=new Morph,l2=new Morph,button;lbl1.add(new SymbolMorph(symbol,24,this.titleBarColor.darker(20),new Point(1,1),this.titleBarColor.darker(50)));lbl1.children[0].setCenter(lbl1.center());lbl1.children[0].setBottom(lbl1.top()-this.padding/2);l1.isCachingImage=true;l1.cachedImage=lbl1.fullImage();l1.bounds=lbl1.fullBounds();lbl2.add(new SymbolMorph(symbol,24,WHITE,new Point(-1,-1),this.titleBarColor.darker(50)));lbl2.children[0].setCenter(lbl2.center());lbl2.children[0].setBottom(lbl2.top()-this.padding/2);l2.isCachingImage=true;l2.cachedImage=lbl2.fullImage();l2.bounds=lbl2.fullBounds();button=new ToggleButtonMorph(null,this,()=>this.setSource(source),[l1,l2],()=>this.source===source);button.corner=this.buttonCorner;button.edge=this.buttonEdge;button.outline=this.buttonOutline;button.outlineColor=this.buttonOutlineColor;button.outlineGradient=this.buttonOutlineGradient;button.labelMinExtent=new Point(60,0);button.padding=this.buttonPadding;button.contrast=this.buttonContrast;button.pressColor=this.titleBarColor.darker(20);button.fixLayout();button.refresh();this.srcBar.add(button)};ProjectDialogMorph.prototype.fixListFieldItemColors=function(){this.listField.contents.children[0].alpha=0;this.listField.contents.children[0].children.forEach(item=>{item.pressColor=this.titleBarColor.darker(20);item.color=new Color(0,0,0,0)})};ProjectDialogMorph.prototype.buildFilterField=function(){var myself=this;this.filterField=new InputFieldMorph("");this.magnifyingGlass=new SymbolMorph("magnifyingGlass",this.filterField.height(),this.titleBarColor.darker(50));this.body.add(this.magnifyingGlass);this.body.add(this.filterField);this.filterField.reactToInput=function(evt){var text=this.getValue();myself.listField.elements=myself.projectList.filter(aProject=>{var name=aProject.projectname||aProject.name,notes=aProject.notes||"";return name.toLowerCase().indexOf(text.toLowerCase())>-1||notes.toLowerCase().indexOf(text.toLowerCase())>-1});if(myself.listField.elements.length===0){myself.listField.elements.push("(no matches)")}myself.clearDetails();myself.listField.buildListContents();myself.fixListFieldItemColors();myself.listField.adjustScrollBars();myself.listField.scrollY(myself.listField.top());myself.fixLayout()}};ProjectDialogMorph.prototype.setSource=function(source){var msg,setting;this.source=source;this.srcBar.children.forEach(button=>button.refresh());switch(this.source){case"cloud":msg=this.ide.showMessage("Updating\nproject list...");this.projectList=[];this.ide.cloud.getProjectList(response=>{if(this.source==="cloud"){this.installCloudProjectList(response.projects)}msg.destroy()},(err,lbl)=>{msg.destroy();this.ide.cloudError().call(null,err,lbl)});return;case"examples":this.projectList=this.getExamplesProjectList();break;case"local":this.projectList=this.getLocalProjectList();break;case"disk":if(this.task==="save"){this.projectList=[]}else{this.destroy();if(this.task==="add"){setting=this.ide.isAddingScenes;this.ide.isAddingScenes=true;this.ide.importLocalFile();this.ide.isAddingScenes=setting}else{this.ide.importLocalFile()}return}break}this.listField.destroy();this.listField=new ListMorph(this.projectList,this.projectList.length>0?element=>{return element.name||element}:null,null,()=>this.ok());if(this.source==="disk"){this.listField.hide()}this.fixListFieldItemColors();this.listField.fixLayout=nop;this.listField.edge=InputFieldMorph.prototype.edge;this.listField.fontSize=InputFieldMorph.prototype.fontSize;this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.listField.contrast=InputFieldMorph.prototype.contrast;this.listField.render=InputFieldMorph.prototype.render;this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;if(this.source==="local"){this.listField.action=item=>{var src,xml;if(item===undefined){return}if(this.nameField){this.nameField.setContents(item.name||"")}if(this.task==="open"){src=localStorage["-snap-project-"+item.name];if(src){xml=this.ide.serializer.parse(src);this.notesText.text=xml.childNamed("notes").contents||"";this.notesText.rerender();this.notesField.contents.adjustBounds();this.preview.texture=xml.childNamed("thumbnail").contents||null;this.preview.cachedTexture=null;this.preview.rerender()}}this.edit()}}else{this.listField.action=item=>{var src,xml;if(item===undefined){return}if(this.nameField){this.nameField.setContents(item.name||"")}src=this.ide.getURL(this.ide.resourceURL("Examples",item.fileName));xml=this.ide.serializer.parse(src);this.notesText.text=xml.childNamed("notes").contents||"";this.notesText.rerender();this.notesField.contents.adjustBounds();this.preview.texture=xml.childNamed("thumbnail").contents||null;this.preview.cachedTexture=null;this.preview.rerender();this.edit()}}this.body.add(this.listField);this.shareButton.hide();this.unshareButton.hide();if(this.task==="open"||this.task==="add"){this.recoverButton.hide()}this.publishButton.hide();this.unpublishButton.hide();if(this.source==="local"){this.deleteButton.show()}else{this.deleteButton.hide()}this.buttons.fixLayout();this.fixLayout();if(this.task==="open"||this.task==="add"){this.clearDetails()}};ProjectDialogMorph.prototype.hasLocalProjects=function(){return Object.keys(localStorage).some(any=>any.indexOf("-snap-project-")===0)};ProjectDialogMorph.prototype.getLocalProjectList=function(){var stored,name,dta,projects=[];for(stored in localStorage){if(Object.prototype.hasOwnProperty.call(localStorage,stored)&&stored.substr(0,14)==="-snap-project-"){name=stored.substr(14);dta={name:name,thumb:null,notes:null};projects.push(dta)}}projects.sort((x,y)=>x.name.toLowerCase()<y.name.toLowerCase()?-1:1);return projects};ProjectDialogMorph.prototype.getExamplesProjectList=function(){return this.ide.getMediaList("Examples")};ProjectDialogMorph.prototype.installCloudProjectList=function(pl){this.projectList=pl[0]?pl:[];this.projectList.sort((x,y)=>x.projectname.toLowerCase()<y.projectname.toLowerCase()?-1:1);this.listField.destroy();this.listField=new ListMorph(this.projectList,this.projectList.length>0?element=>{return element.projectname||element}:null,[["bold",proj=>proj.ispublic],["italic",proj=>proj.ispublished]],()=>this.ok());this.fixListFieldItemColors();this.listField.fixLayout=nop;this.listField.edge=InputFieldMorph.prototype.edge;this.listField.fontSize=InputFieldMorph.prototype.fontSize;this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.listField.contrast=InputFieldMorph.prototype.contrast;this.listField.render=InputFieldMorph.prototype.render;this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.listField.action=item=>{if(item===undefined){return}if(this.nameField){this.nameField.setContents(item.projectname||"")}if(this.task==="open"||this.task==="add"){this.notesText.text=item.notes||"";this.notesText.rerender();this.notesField.contents.adjustBounds();this.preview.texture="";this.preview.rerender();this.ide.cloud.getThumbnail(null,item.projectname,thumbnail=>{this.preview.texture=thumbnail;this.preview.cachedTexture=null;this.preview.rerender()});new SpeechBubbleMorph(new TextMorph(localize("last changed")+"\n"+item.lastupdated,null,null,null,null,"center")).popUp(this.world(),this.preview.rightCenter().add(new Point(2,0)))}if(item.ispublic){this.shareButton.hide();this.unshareButton.show();if(item.ispublished){this.publishButton.hide();this.unpublishButton.show()}else{this.publishButton.show();this.unpublishButton.hide()}}else{this.unshareButton.hide();this.shareButton.show();this.publishButton.hide();this.unpublishButton.hide()}this.buttons.fixLayout();this.fixLayout();this.edit()};this.body.add(this.listField);if(this.task==="open"||this.task==="add"){this.recoverButton.show()}this.shareButton.show();this.unshareButton.hide();this.deleteButton.show();this.buttons.fixLayout();this.fixLayout();if(this.task==="open"||this.task==="add"){this.clearDetails()}};ProjectDialogMorph.prototype.clearDetails=function(){this.notesText.text="";this.notesText.rerender();this.notesField.contents.adjustBounds();this.preview.texture=null;this.preview.cachedTexture=null;this.preview.rerender()};ProjectDialogMorph.prototype.recoveryDialog=function(){var proj=this.listField.selected;if(!proj){return}this.removeShadow();this.hide();new ProjectRecoveryDialogMorph(this.ide,proj.projectname,this).popUp()};ProjectDialogMorph.prototype.addScene=function(){var proj=this.listField.selected,src;if(!proj){return}this.ide.isAddingNextScene=true;this.ide.source=this.source;if(this.source==="cloud"){this.addCloudScene(proj)}else if(this.source==="examples"){src=this.ide.getURL(this.ide.resourceURL("Examples",proj.fileName));this.ide.openProjectString(src);this.destroy()}else{this.ide.source=null;this.ide.openProjectName(proj.name);this.destroy()}};ProjectDialogMorph.prototype.openProject=function(){var proj=this.listField.selected,src;if(!proj){return}this.ide.source=this.source;if(this.source==="cloud"){this.openCloudProject(proj)}else if(this.source==="examples"){src=this.ide.getURL(this.ide.resourceURL("Examples",proj.fileName));this.ide.backup(()=>this.ide.openProjectString(src));this.destroy()}else{this.ide.source=null;this.ide.backup(()=>this.ide.openProjectName(proj.name));this.destroy()}};ProjectDialogMorph.prototype.addCloudScene=function(project,delta){this.ide.nextSteps([()=>this.ide.showMessage("Fetching project\nfrom the cloud..."),()=>this.rawOpenCloudProject(project,delta)])};ProjectDialogMorph.prototype.openCloudProject=function(project,delta){this.ide.backup(()=>{this.ide.nextSteps([()=>this.ide.showMessage("Fetching project\nfrom the cloud..."),()=>this.rawOpenCloudProject(project,delta)])})};ProjectDialogMorph.prototype.rawOpenCloudProject=function(proj,delta){this.ide.cloud.getProject(proj.projectname,delta,clouddata=>{this.ide.source="cloud";this.ide.nextSteps([()=>this.ide.openCloudDataString(clouddata)]);location.hash="";if(proj.ispublic){location.hash="#present:Username="+encodeURIComponent(this.ide.cloud.username)+"&ProjectName="+encodeURIComponent(proj.projectname)}},this.ide.cloudError());this.destroy()};ProjectDialogMorph.prototype.saveProject=function(){var name=this.nameField.contents().text.text,notes=this.notesText.text;if(this.ide.getProjectNotes()!==notes){this.ide.setProjectNotes(notes)}if(name){if(this.source==="cloud"){if(detect(this.projectList,item=>item.projectname===name)){this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+name+'"?',"Replace Project",()=>{this.ide.setProjectName(name);this.saveCloudProject()})}else{this.ide.setProjectName(name);this.saveCloudProject()}}else if(this.source==="disk"){this.ide.exportProject(name);this.ide.source="disk";this.destroy()}}};ProjectDialogMorph.prototype.saveCloudProject=function(){this.ide.source="cloud";this.ide.saveProjectToCloud();this.destroy()};ProjectDialogMorph.prototype.deleteProject=function(){var proj,idx,name;if(this.source==="cloud"){proj=this.listField.selected;if(proj){this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+proj.projectname+'"?',"Delete Project",()=>this.ide.cloud.deleteProject(proj.projectname,null,()=>{this.ide.hasChangedMedia=true;idx=this.projectList.indexOf(proj);this.projectList.splice(idx,1);this.installCloudProjectList(this.projectList)},this.ide.cloudError()))}}else{if(this.listField.selected){name=this.listField.selected.name;this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+name+'"?',"Delete Project",()=>{delete localStorage["-snap-project-"+name];this.setSource(this.source)})}}};ProjectDialogMorph.prototype.shareProject=function(){var ide=this.ide,proj=this.listField.selected,entry=this.listField.active;if(proj){this.ide.confirm(localize("Are you sure you want to share")+'\n"'+proj.projectname+'"?',"Share Project",()=>{ide.showMessage("sharing\nproject...");ide.cloud.shareProject(proj.projectname,null,()=>{proj.ispublic=true;this.unshareButton.show();this.shareButton.hide();this.publishButton.show();this.unpublishButton.hide();entry.label.isBold=true;entry.label.rerender();this.buttons.fixLayout();this.rerender();this.ide.showMessage("shared.",2);if(proj.projectname===ide.getProjectName()){var usr=ide.cloud.username,projectId="Username="+encodeURIComponent(usr.toLowerCase())+"&ProjectName="+encodeURIComponent(proj.projectname);location.hash="present:"+projectId}},this.ide.cloudError())})}};ProjectDialogMorph.prototype.unshareProject=function(){var ide=this.ide,proj=this.listField.selected,entry=this.listField.active;if(proj){this.ide.confirm(localize("Are you sure you want to unshare")+'\n"'+proj.projectname+'"?',"Unshare Project",()=>{ide.showMessage("unsharing\nproject...");ide.cloud.unshareProject(proj.projectname,null,()=>{proj.ispublic=false;this.shareButton.show();this.unshareButton.hide();this.publishButton.hide();this.unpublishButton.hide();entry.label.isBold=false;entry.label.isItalic=false;entry.label.rerender();this.buttons.fixLayout();this.rerender();this.ide.showMessage("unshared.",2);if(proj.projectname===ide.getProjectName()){location.hash=""}},this.ide.cloudError())})}};ProjectDialogMorph.prototype.publishProject=function(){var ide=this.ide,proj=this.listField.selected,entry=this.listField.active;if(proj){this.ide.confirm(localize("Are you sure you want to publish")+'\n"'+proj.projectname+'"?',"Publish Project",()=>{ide.showMessage("publishing\nproject...");ide.cloud.publishProject(proj.projectname,null,()=>{proj.ispublished=true;this.unshareButton.show();this.shareButton.hide();this.publishButton.hide();this.unpublishButton.show();entry.label.isItalic=true;entry.label.rerender();this.buttons.fixLayout();this.rerender();this.ide.showMessage("published.",2);if(proj.projectname===ide.getProjectName()){var usr=ide.cloud.username,projectId="Username="+encodeURIComponent(usr.toLowerCase())+"&ProjectName="+encodeURIComponent(proj.projectname);location.hash="present:"+projectId}},this.ide.cloudError())})}};ProjectDialogMorph.prototype.unpublishProject=function(){var proj=this.listField.selected,entry=this.listField.active;if(proj){this.ide.confirm(localize("Are you sure you want to unpublish")+'\n"'+proj.projectname+'"?',"Unpublish Project",()=>{this.ide.showMessage("unpublishing\nproject...");this.ide.cloud.unpublishProject(proj.projectname,null,()=>{proj.ispublished=false;this.unshareButton.show();this.shareButton.hide();this.publishButton.show();this.unpublishButton.hide();entry.label.isItalic=false;entry.label.rerender();this.buttons.fixLayout();this.rerender();this.ide.showMessage("unpublished.",2)},this.ide.cloudError())})}};ProjectDialogMorph.prototype.edit=function(){if(this.nameField){this.nameField.edit()}else if(this.filterField){this.filterField.edit()}};ProjectDialogMorph.prototype.fixLayout=function(){var th=fontHeight(this.titleFontSize)+this.titlePadding*2,thin=this.padding/2,inputField=this.nameField||this.filterField;if(this.buttons&&this.buttons.children.length>0){this.buttons.fixLayout()}if(this.body){this.body.setPosition(this.position().add(new Point(this.padding,th+this.padding)));this.body.setExtent(new Point(this.width()-this.padding*2,this.height()-this.padding*3-th-this.buttons.height()));this.srcBar.setPosition(this.body.position());inputField.setWidth(this.body.width()-this.srcBar.width()-this.padding*6);inputField.setLeft(this.srcBar.right()+this.padding*3);inputField.setTop(this.srcBar.top());this.listField.setLeft(this.srcBar.right()+this.padding);this.listField.setWidth(this.body.width()-this.srcBar.width()-this.preview.width()-this.padding-thin);this.listField.contents.children[0].adjustWidths();this.listField.setTop(inputField.bottom()+this.padding);this.listField.setHeight(this.body.height()-inputField.height()-this.padding);if(this.magnifyingGlass){this.magnifyingGlass.setTop(inputField.top());this.magnifyingGlass.setLeft(this.listField.left())}this.preview.setRight(this.body.right());this.preview.setTop(inputField.bottom()+this.padding);this.notesField.setTop(this.preview.bottom()+thin);this.notesField.setLeft(this.preview.left());this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-thin)}if(this.label){this.label.setCenter(this.center());this.label.setTop(this.top()+(th-this.label.height())/2)}if(this.buttons&&this.buttons.children.length>0){this.buttons.setCenter(this.center());this.buttons.setBottom(this.bottom()-this.padding)}this.removeShadow();this.addShadow()};ProjectRecoveryDialogMorph.prototype=new DialogBoxMorph;ProjectRecoveryDialogMorph.prototype.constructor=ProjectRecoveryDialogMorph;ProjectRecoveryDialogMorph.uber=DialogBoxMorph.prototype;function ProjectRecoveryDialogMorph(ide,project,browser){this.init(ide,project,browser)}ProjectRecoveryDialogMorph.prototype.init=function(ide,projectName,browser){ProjectRecoveryDialogMorph.uber.init.call(this,this,null,null);this.ide=ide;this.browser=browser;this.key="recoverProject";this.projectName=projectName;this.versions=null;this.handle=null;this.listField=null;this.preview=null;this.notesText=null;this.notesField=null;this.labelString="Recover project";this.createLabel();this.buildContents()};ProjectRecoveryDialogMorph.prototype.buildContents=function(){this.addBody(new Morph);this.body.color=this.color;this.buildListField();this.preview=new Morph;this.preview.fixLayout=nop;this.preview.edge=InputFieldMorph.prototype.edge;this.preview.fontSize=InputFieldMorph.prototype.fontSize;this.preview.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.preview.contrast=InputFieldMorph.prototype.contrast;this.preview.render=function(ctx){InputFieldMorph.prototype.render.call(this,ctx);if(this.cachedTexture){this.renderCachedTexture(ctx)}else if(this.texture){this.renderTexture(this.texture,ctx)}};this.preview.renderCachedTexture=function(ctx){ctx.drawImage(this.cachedTexture,this.edge,this.edge)};this.preview.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.preview.setExtent(this.ide.serializer.thumbnailSize.add(this.preview.edge*2));this.body.add(this.preview);this.notesField=new ScrollFrameMorph;this.notesField.fixLayout=nop;this.notesField.edge=InputFieldMorph.prototype.edge;this.notesField.fontSize=InputFieldMorph.prototype.fontSize;this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.notesField.contrast=InputFieldMorph.prototype.contrast;this.notesField.render=InputFieldMorph.prototype.render;this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.notesField.acceptsDrops=false;this.notesField.contents.acceptsDrops=false;this.notesText=new TextMorph("");this.notesField.isTextLineWrapping=true;this.notesField.padding=3;this.notesField.setContents(this.notesText);this.notesField.setWidth(this.preview.width());this.body.add(this.notesField);this.addButton("recoverProject","Recover",true);this.addButton("cancel","Cancel");this.setExtent(new Point(360,300));this.fixLayout()};ProjectRecoveryDialogMorph.prototype.buildListField=function(){this.listField=new ListMorph([]);this.fixListFieldItemColors();this.listField.fixLayout=nop;this.listField.edge=InputFieldMorph.prototype.edge;this.listField.fontSize=InputFieldMorph.prototype.fontSize;this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.listField.contrast=InputFieldMorph.prototype.contrast;this.listField.render=InputFieldMorph.prototype.render;this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.listField.action=item=>{var version;if(item===undefined){return}version=detect(this.versions,version=>version.lastupdated===item);this.notesText.text=version.notes||"";this.notesText.rerender();this.notesField.contents.adjustBounds();this.preview.texture=version.thumbnail;this.preview.cachedTexture=null;this.preview.rerender()};this.ide.cloud.getProjectVersionMetadata(this.projectName,versions=>{var today=new Date,yesterday=new Date;yesterday.setDate(today.getDate()-1);this.versions=versions;this.versions.forEach(version=>{var date=new Date((new Date).getTime()-version.lastupdated*1e3);if(date.toDateString()===today.toDateString()){version.lastupdated=localize("Today, ")+date.toLocaleTimeString()}else if(date.toDateString()===yesterday.toDateString()){version.lastupdated=localize("Yesterday, ")+date.toLocaleTimeString()}else{version.lastupdated=date.toLocaleString()}});this.listField.elements=this.versions.map(version=>version.lastupdated);this.clearDetails();this.listField.buildListContents();this.fixListFieldItemColors();this.listField.adjustScrollBars();this.listField.scrollY(this.listField.top());this.fixLayout()},this.ide.cloudError());this.body.add(this.listField)};ProjectRecoveryDialogMorph.prototype.cancel=function(){this.browser.show();this.browser.listField.select(detect(this.browser.projectList,item=>item.projectname===this.projectName));ProjectRecoveryDialogMorph.uber.cancel.call(this)};ProjectRecoveryDialogMorph.prototype.recoverProject=function(){var lastupdated=this.listField.selected,version=detect(this.versions,version=>version.lastupdated===lastupdated);this.browser.openCloudProject({projectname:this.projectName},version.delta);this.destroy()};ProjectRecoveryDialogMorph.prototype.popUp=function(){var world=this.ide.world();if(world){ProjectRecoveryDialogMorph.uber.popUp.call(this,world);this.handle=new HandleMorph(this,300,300,this.corner,this.corner)}};ProjectRecoveryDialogMorph.prototype.fixListFieldItemColors=ProjectDialogMorph.prototype.fixListFieldItemColors;ProjectRecoveryDialogMorph.prototype.clearDetails=ProjectDialogMorph.prototype.clearDetails;ProjectRecoveryDialogMorph.prototype.fixLayout=function(){var titleHeight=fontHeight(this.titleFontSize)+this.titlePadding*2,thin=this.padding/2;if(this.body){this.body.setPosition(this.position().add(new Point(this.padding,titleHeight+this.padding)));this.body.setExtent(new Point(this.width()-this.padding*2,this.height()-this.padding*3-titleHeight-this.buttons.height()));this.listField.setWidth(this.body.width()-this.preview.width()-this.padding);this.listField.contents.children[0].adjustWidths();this.listField.setPosition(this.body.position());this.listField.setHeight(this.body.height());this.preview.setRight(this.body.right());this.preview.setTop(this.listField.top());this.notesField.setTop(this.preview.bottom()+thin);this.notesField.setLeft(this.preview.left());this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-thin)}if(this.label){this.label.setCenter(this.center());this.label.setTop(this.top()+(titleHeight-this.label.height())/2)}if(this.buttons){this.buttons.fixLayout();this.buttons.setCenter(this.center());this.buttons.setBottom(this.bottom()-this.padding)}this.removeShadow();this.addShadow()};LibraryImportDialogMorph.prototype=new DialogBoxMorph;LibraryImportDialogMorph.prototype.constructor=LibraryImportDialogMorph;LibraryImportDialogMorph.uber=DialogBoxMorph.prototype;function LibraryImportDialogMorph(ide,librariesData){this.init(ide,librariesData)}LibraryImportDialogMorph.prototype.init=function(ide,librariesData){this.isLoadingLibrary=false;this.originalCategories=null;this.captureOriginalCategories();LibraryImportDialogMorph.uber.init.call(this,this,null,null);this.ide=ide;this.key="importLibrary";this.action="importLibrary";this.librariesData=librariesData;this.libraryCache=new Map;this.handle=null;this.listField=null;this.palette=null;this.notesText=null;this.notesField=null;this.labelString="Import library";this.createLabel();this.buildContents()};LibraryImportDialogMorph.prototype.captureOriginalCategories=function(){this.originalCategories=new Map;SpriteMorph.prototype.customCategories.forEach((color,name)=>this.originalCategories.set(name,color))};LibraryImportDialogMorph.prototype.buildContents=function(){this.addBody(new Morph);this.body.color=this.color;this.initializePalette();this.initializeLibraryDescription();this.installLibrariesList();this.addButton("ok","Import");this.addButton("cancel","Cancel");this.setExtent(new Point(460,455));this.fixLayout()};LibraryImportDialogMorph.prototype.initializePalette=function(){if(this.palette){this.palette.destroy()}this.palette=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor);this.palette.color=SpriteMorph.prototype.paletteColor;this.palette.padding=4;this.palette.isDraggable=false;this.palette.acceptsDrops=false;this.palette.contents.acceptsDrops=false;this.body.add(this.palette)};LibraryImportDialogMorph.prototype.initializeLibraryDescription=function(){if(this.notesField){this.notesField.destroy()}this.notesField=new ScrollFrameMorph;this.notesField.fixLayout=nop;this.notesField.edge=InputFieldMorph.prototype.edge;this.notesField.fontSize=InputFieldMorph.prototype.fontSize;this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.notesField.contrast=InputFieldMorph.prototype.contrast;this.notesField.render=InputFieldMorph.prototype.render;this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.notesField.acceptsDrops=false;this.notesField.contents.acceptsDrops=false;this.notesText=new TextMorph("");this.notesField.isTextLineWrapping=true;this.notesField.padding=3;this.notesField.setContents(this.notesText);this.notesField.setHeight(100);this.body.add(this.notesField)};LibraryImportDialogMorph.prototype.installLibrariesList=function(){if(this.listField){this.listField.destroy()}this.listField=new ListMorph(this.librariesData,element=>element.name,null,()=>this.importLibrary(),"~",false);this.fixListFieldItemColors();this.listField.fixLayout=nop;this.listField.edge=InputFieldMorph.prototype.edge;this.listField.fontSize=InputFieldMorph.prototype.fontSize;this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.listField.contrast=InputFieldMorph.prototype.contrast;this.listField.render=InputFieldMorph.prototype.render;this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.listField.action=({name,fileName,description})=>{if(isNil(name)){return}this.notesText.text=localize(description)||"";this.notesText.rerender();this.notesField.contents.adjustBounds();if(this.hasCached(fileName)){this.displayBlocks(fileName)}else{this.showMessage(`${localize("Loading")}\n${localize(name)}`);this.ide.getURL(this.ide.resourceURL("libraries",fileName),libraryXML=>{let serializer=this.ide.serializer,palette=serializer.parse(libraryXML).childNamed("palette");this.cacheLibrary(fileName,serializer.loadBlocks(libraryXML),palette?serializer.loadPalette(palette):{});this.displayBlocks(fileName)})}};this.listField.setWidth(200);this.body.add(this.listField);this.fixLayout()};LibraryImportDialogMorph.prototype.popUp=function(){var world=this.ide.world();if(world){LibraryImportDialogMorph.uber.popUp.call(this,world);this.handle=new HandleMorph(this,300,300,this.corner,this.corner)}};LibraryImportDialogMorph.prototype.destroy=function(){LibraryImportDialogMorph.uber.destroy.call(this);if(!this.isLoadingLibrary){SpriteMorph.prototype.customCategories=this.originalCategories}};LibraryImportDialogMorph.prototype.fixListFieldItemColors=ProjectDialogMorph.prototype.fixListFieldItemColors;LibraryImportDialogMorph.prototype.clearDetails=ProjectDialogMorph.prototype.clearDetails;LibraryImportDialogMorph.prototype.fixLayout=function(){var titleHeight=fontHeight(this.titleFontSize)+this.titlePadding*2,thin=this.padding/2;if(this.body){this.body.setPosition(this.position().add(new Point(this.padding,titleHeight+this.padding)));this.body.setExtent(new Point(this.width()-this.padding*2,this.height()-this.padding*3-titleHeight-this.buttons.height()));this.listField.setExtent(new Point(200,this.body.height()));this.notesField.setExtent(new Point(this.body.width()-this.listField.width()-thin,100));this.palette.setExtent(new Point(this.notesField.width(),this.body.height()-this.notesField.height()-thin));this.listField.contents.children[0].adjustWidths();this.listField.setPosition(this.body.position());this.palette.setPosition(this.listField.topRight().add(new Point(thin,0)));this.notesField.setPosition(this.palette.bottomLeft().add(new Point(0,thin)))}if(this.label){this.label.setCenter(this.center());this.label.setTop(this.top()+(titleHeight-this.label.height())/2)}if(this.buttons){this.buttons.fixLayout();this.buttons.setCenter(this.center());this.buttons.setBottom(this.bottom()-this.padding)}this.removeShadow();this.addShadow()};LibraryImportDialogMorph.prototype.hasCached=function(key){return this.libraryCache.hasOwnProperty(key)};LibraryImportDialogMorph.prototype.cacheLibrary=function(key,blocks,palette){this.libraryCache.set(key,{blocks:blocks,palette:palette})};LibraryImportDialogMorph.prototype.cachedLibrary=function(key){return this.libraryCache.get(key).blocks};LibraryImportDialogMorph.prototype.cachedPalette=function(key){return this.libraryCache.get(key).palette};LibraryImportDialogMorph.prototype.importLibrary=function(){if(!this.listField.selected){return}var ide=this.ide,selectedLibrary=this.listField.selected.fileName,libraryName=this.listField.selected.name;SpriteMorph.prototype.customCategories=this.originalCategories;if(this.hasCached(selectedLibrary)){this.cachedLibrary(selectedLibrary).forEach(def=>{def.receiver=ide.stage;ide.stage.globalBlocks.push(def);ide.stage.replaceDoubleDefinitionsFor(def)});this.cachedPalette(selectedLibrary).forEach((value,key)=>SpriteMorph.prototype.customCategories.set(key,value));ide.showMessage(localize("Imported")+" "+localize(libraryName),2)}else{ide.showMessage(localize("Loading")+" "+localize(libraryName));ide.getURL(ide.resourceURL("libraries",selectedLibrary),libraryText=>{ide.droppedText(libraryText,libraryName);this.isLoadingLibrary=true})}};LibraryImportDialogMorph.prototype.displayBlocks=function(libraryKey){var x,y,blockImage,blockContainer,text,padding=4,libraryBlocks=this.cachedLibrary(libraryKey),blocksByCategory=new Map(SpriteMorph.prototype.allCategories().map(cat=>[cat,[]]));this.initializePalette();x=this.palette.left()+padding;y=this.palette.top();libraryBlocks.global.concat(libraryBlocks.local).forEach(definition=>{if(!definition.isHelper){blocksByCategory.get(definition.category).push(definition)}});blocksByCategory.forEach((blocks,category)=>{if(blocks.length>0){text=SpriteMorph.prototype.categoryText(category);text.setPosition(new Point(x,y));this.palette.addContents(text);y+=text.fullBounds().height()+padding}blocks.forEach(definition=>{blockImage=definition.templateInstance().fullImage();blockContainer=new Morph;blockContainer.isCachingImage=true;blockContainer.bounds.setWidth(blockImage.width);blockContainer.bounds.setHeight(blockImage.height);blockContainer.cachedImage=blockImage;blockContainer.setPosition(new Point(x,y));this.palette.addContents(blockContainer);y+=blockContainer.fullBounds().height()+padding})});this.palette.scrollX(padding);this.palette.scrollY(padding);this.fixLayout()};LibraryImportDialogMorph.prototype.showMessage=function(msgText){var msg=new MenuMorph(null,msgText);this.initializePalette();this.fixLayout();msg.popUpCenteredInWorld(this.palette.contents)};SpriteIconMorph.prototype=new ToggleButtonMorph;SpriteIconMorph.prototype.constructor=SpriteIconMorph;SpriteIconMorph.uber=ToggleButtonMorph.prototype;SpriteIconMorph.prototype.thumbSize=new Point(40,40);SpriteIconMorph.prototype.labelShadowOffset=null;SpriteIconMorph.prototype.labelShadowColor=null;SpriteIconMorph.prototype.labelColor=WHITE;SpriteIconMorph.prototype.fontSize=9;function SpriteIconMorph(aSprite){this.init(aSprite)}SpriteIconMorph.prototype.init=function(aSprite){var colors,action,query,hover;colors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor];action=()=>{var ide=this.parentThatIsA(IDE_Morph);if(ide){ide.selectSprite(this.object)}};query=()=>{var ide=this.parentThatIsA(IDE_Morph);if(ide){return ide.currentSprite===this.object}return false};hover=()=>{if(!aSprite.exemplar){return null}return localize("parent")+":\n"+aSprite.exemplar.name};this.object=aSprite||new SpriteMorph;this.version=this.object.version;this.thumbnail=null;this.rotationButton=null;SpriteIconMorph.uber.init.call(this,colors,null,action,this.object.name,query,null,hover);this.isDraggable=true;this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout();this.fps=1};SpriteIconMorph.prototype.createThumbnail=function(){if(this.thumbnail){this.thumbnail.destroy()}this.thumbnail=new Morph;this.thumbnail.isCachingImage=true;this.thumbnail.bounds.setExtent(this.thumbSize);if(this.object instanceof SpriteMorph){this.thumbnail.cachedImage=this.object.fullThumbnail(this.thumbSize,this.thumbnail.cachedImage);this.add(this.thumbnail);this.createRotationButton()}else{this.thumbnail.cachedImage=this.object.thumbnail(this.thumbSize,this.thumbnail.cachedImage);this.add(this.thumbnail)}};SpriteIconMorph.prototype.createLabel=function(){var txt;if(this.label){this.label.destroy()}txt=new StringMorph(this.object.name,this.fontSize,this.fontStyle,true,false,false,this.labelShadowOffset,this.labelShadowColor,this.labelColor);this.label=new FrameMorph;this.label.acceptsDrops=false;this.label.alpha=0;this.label.setExtent(txt.extent());txt.setPosition(this.label.position());this.label.add(txt);this.add(this.label)};SpriteIconMorph.prototype.createRotationButton=function(){var button;if(this.rotationButton){this.rotationButton.destroy();this.roationButton=null}if(!this.object.anchor){return}button=new ToggleButtonMorph(null,null,()=>this.object.rotatesWithAnchor=!this.object.rotatesWithAnchor,["→","↻"],()=>this.object.rotatesWithAnchor);button.corner=8;button.labelMinExtent=new Point(11,11);button.padding=0;button.pressColor=button.color;button.fixLayout();button.refresh();this.rotationButton=button;this.add(this.rotationButton)};SpriteIconMorph.prototype.step=function(){if(this.version!==this.object.version){this.createThumbnail();this.createLabel();this.fixLayout();this.version=this.object.version;this.refresh()}};SpriteIconMorph.prototype.fixLayout=function(){if(!this.thumbnail||!this.label){return null}this.bounds.setWidth(this.thumbnail.width()+this.outline*2+this.edge*2+this.padding*2);this.bounds.setHeight(this.thumbnail.height()+this.outline*2+this.edge*2+this.padding*3+this.label.height());this.thumbnail.setCenter(this.center());this.thumbnail.setTop(this.top()+this.outline+this.edge+this.padding);if(this.rotationButton){this.rotationButton.setTop(this.top());this.rotationButton.setRight(this.right())}this.label.setWidth(Math.min(this.label.children[0].width(),this.thumbnail.width()));this.label.setCenter(this.center());this.label.setTop(this.thumbnail.bottom()+this.padding)};SpriteIconMorph.prototype.userMenu=function(){var menu=new MenuMorph(this);if(this.object instanceof StageMorph){menu.addItem("pic...",()=>{var ide=this.parentThatIsA(IDE_Morph);ide.saveCanvasAs(this.object.fullImage(),this.object.name)},"save a picture\nof the stage");if(this.object.trailsLog.length){menu.addItem("svg...",()=>this.object.exportTrailsLogAsSVG(),"export pen trails\nline segments as SVG")}return menu}if(!(this.object instanceof SpriteMorph)){return null}menu.addItem("show","showSpriteOnStage");menu.addLine();menu.addItem("duplicate","duplicateSprite");if(StageMorph.prototype.enableInheritance){menu.addItem("clone","instantiateSprite")}menu.addItem("delete","removeSprite");menu.addLine();if(StageMorph.prototype.enableInheritance){menu.addItem("parent...","chooseExemplar");if(this.object.exemplar){menu.addItem("release","releaseSprite","make temporary and\nhide in the sprite corral")}}if(this.object.anchor){menu.addItem(localize("detach from")+" "+this.object.anchor.name,()=>this.object.detachFromAnchor())}if(this.object.parts.length){menu.addItem("detach all parts",()=>this.object.detachAllParts())}menu.addItem("export...","exportSprite");return menu};SpriteIconMorph.prototype.duplicateSprite=function(){var ide=this.parentThatIsA(IDE_Morph);if(ide){ide.duplicateSprite(this.object)}};SpriteIconMorph.prototype.instantiateSprite=function(){var ide=this.parentThatIsA(IDE_Morph);if(ide){ide.instantiateSprite(this.object)}};SpriteIconMorph.prototype.removeSprite=function(){var ide=this.parentThatIsA(IDE_Morph);if(ide){ide.removeSprite(this.object)}};SpriteIconMorph.prototype.exportSprite=function(){this.object.exportSprite()};SpriteIconMorph.prototype.chooseExemplar=function(){this.object.chooseExemplar()};SpriteIconMorph.prototype.releaseSprite=function(){var ide=this.parentThatIsA(IDE_Morph);this.object.release();if(ide){ide.recordUnsavedChanges()}};SpriteIconMorph.prototype.showSpriteOnStage=function(){this.object.showOnStage()};SpriteIconMorph.prototype.mouseDoubleClick=function(){if(this.object instanceof SpriteMorph){this.object.flash()}};SpriteIconMorph.prototype.render=function(ctx){switch(this.userState){case"highlight":this.drawBackground(ctx,this.highlightColor);break;case"pressed":this.drawOutline(ctx);this.drawBackground(ctx,this.pressColor);this.drawEdges(ctx,this.pressColor,this.pressColor.lighter(40),this.pressColor.darker(40));break;default:this.drawBackground(ctx,this.getRenderColor())}};SpriteIconMorph.prototype.getRenderColor=ScriptsMorph.prototype.getRenderColor;SpriteIconMorph.prototype.prepareToBeGrabbed=function(){var ide=this.parentThatIsA(IDE_Morph),idx;this.mouseClickLeft();this.alpha=.85;if(ide){idx=ide.sprites.asArray().indexOf(this.object);ide.sprites.remove(idx+1);ide.createCorral(true);ide.fixLayout()}};SpriteIconMorph.prototype.justDropped=function(){this.alpha=1};SpriteIconMorph.prototype.wantsDropOf=function(morph){return morph instanceof BlockMorph||morph instanceof CommentMorph||morph instanceof CostumeIconMorph||morph instanceof SoundIconMorph};SpriteIconMorph.prototype.reactToDropOf=function(morph,hand){if(morph instanceof BlockMorph||morph instanceof CommentMorph){this.copyStack(morph)}else if(morph instanceof CostumeIconMorph){this.copyCostume(morph.object)}else if(morph instanceof SoundIconMorph){this.copySound(morph.object)}this.world().add(morph);morph.slideBackTo(hand.grabOrigin)};SpriteIconMorph.prototype.copyStack=function(block){var sprite=this.object,dup=block.fullCopy(),y=Math.max(sprite.scripts.children.map(stack=>stack.fullBounds().bottom()).concat([sprite.scripts.top()]));dup.setPosition(new Point(sprite.scripts.left()+20,y+20));sprite.scripts.add(dup);if(dup instanceof BlockMorph){dup.allComments().forEach(comment=>comment.align(dup))}sprite.scripts.adjustBounds();dup.allChildren().forEach(morph=>{if(morph.isCustomBlock&&!morph.isGlobal&&!sprite.getMethod(morph.blockSpec)){morph.deleteBlock()}})};SpriteIconMorph.prototype.copyCostume=function(costume){var dup=costume.copy();dup.name=this.object.newCostumeName(dup.name);this.object.addCostume(dup);this.object.wearCostume(dup)};SpriteIconMorph.prototype.copySound=function(sound){var dup=sound.copy();this.object.addSound(dup.audio,dup.name)};SpriteIconMorph.prototype.flash=function(){var world=this.world(),isFlat=MorphicPreferences.isFlat,highlight=SpriteMorph.prototype.highlightColor,previousColor=isFlat?this.pressColor:this.outlineColor,previousOutline=this.outline,previousState=this.userState;if(isFlat){this.pressColor=highlight}else{this.outlineColor=highlight;this.outline=2}this.userState="pressed";this.rerender();world.animations.push(new Animation(nop,nop,0,800,nop,()=>{if(isFlat){this.pressColor=previousColor}else{this.outlineColor=previousColor;this.outline=previousOutline}this.userState=previousState;this.rerender()}))};CostumeIconMorph.prototype=new ToggleButtonMorph;CostumeIconMorph.prototype.constructor=CostumeIconMorph;CostumeIconMorph.uber=ToggleButtonMorph.prototype;CostumeIconMorph.prototype.thumbSize=new Point(80,60);CostumeIconMorph.prototype.labelShadowOffset=null;CostumeIconMorph.prototype.labelShadowColor=null;CostumeIconMorph.prototype.labelColor=WHITE;CostumeIconMorph.prototype.fontSize=9;function CostumeIconMorph(aCostume){this.init(aCostume)}CostumeIconMorph.prototype.init=function(aCostume){var colors,action,query;colors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor];action=()=>{var ide=this.parentThatIsA(IDE_Morph),wardrobe=this.parentThatIsA(WardrobeMorph);if(ide){ide.currentSprite.wearCostume(this.object)}if(wardrobe){wardrobe.updateSelection()}};query=()=>{var ide=this.parentThatIsA(IDE_Morph);if(ide){return ide.currentSprite.costume===this.object}return false};this.object=aCostume||new Costume;this.version=this.object.version;this.thumbnail=null;CostumeIconMorph.uber.init.call(this,colors,null,action,this.object.name,query,null,null);this.isDraggable=true;this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout();this.fps=1};CostumeIconMorph.prototype.createThumbnail=function(){var watermark,txt;SpriteIconMorph.prototype.createThumbnail.call(this);watermark=this.object instanceof SVG_Costume?"svg":this.object.embeddedData?this.typeOfStringData(this.object.embeddedData)==="data"?"dta":"</>":null;if(watermark){txt=new StringMorph(watermark,this.fontSize*.8,this.fontStyle,false,false,false,this.labelShadowOffset,this.labelShadowColor,this.labelColor);txt.setBottom(this.thumbnail.bottom());this.thumbnail.add(txt)}};CostumeIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel;CostumeIconMorph.prototype.step=SpriteIconMorph.prototype.step;CostumeIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout;CostumeIconMorph.prototype.userMenu=function(){var menu=new MenuMorph(this);if(!(this.object instanceof Costume)){return null}menu.addItem("edit","editCostume");if(this.world().currentKey===16){menu.addItem("edit rotation point only...","editRotationPointOnly",null,new Color(100,0,0))}menu.addItem("rename","renameCostume");menu.addLine();menu.addItem("duplicate","duplicateCostume");menu.addItem("delete","removeCostume");menu.addLine();if(this.object.embeddedData){menu.addItem("get"+" "+this.typeOfStringData(this.object.embeddedData),"importEmbeddedData")}menu.addItem("export","exportCostume");return menu};CostumeIconMorph.prototype.editCostume=function(){this.disinherit();if(this.object instanceof SVG_Costume&&this.object.shapes.length===0){try{this.object.parseShapes()}catch(e){this.editRotationPointOnly();return}}this.object.edit(this.world(),this.parentThatIsA(IDE_Morph),false)};CostumeIconMorph.prototype.editRotationPointOnly=function(){var ide=this.parentThatIsA(IDE_Morph);this.object.editRotationPointOnly(this.world(),ide);ide.hasChangedMedia=true;ide.recordUnsavedChanges()};CostumeIconMorph.prototype.renameCostume=function(){this.disinherit();var costume=this.object,wardrobe=this.parentThatIsA(WardrobeMorph),ide=this.parentThatIsA(IDE_Morph);new DialogBoxMorph(null,answer=>{if(answer&&answer!==costume.name){costume.name=wardrobe.sprite.newCostumeName(answer,costume);costume.version=Date.now();ide.hasChangedMedia=true;ide.recordUnsavedChanges()}}).prompt(ide.currentSprite instanceof SpriteMorph?"rename costume":"rename background",costume.name,this.world())};CostumeIconMorph.prototype.duplicateCostume=function(){var wardrobe=this.parentThatIsA(WardrobeMorph),ide=this.parentThatIsA(IDE_Morph),newcos=this.object.copy();newcos.name=wardrobe.sprite.newCostumeName(newcos.name);wardrobe.sprite.addCostume(newcos);wardrobe.updateList();if(ide){ide.currentSprite.wearCostume(newcos)}};CostumeIconMorph.prototype.removeCostume=function(){var wardrobe=this.parentThatIsA(WardrobeMorph),idx=this.parent.children.indexOf(this),off=CamSnapshotDialogMorph.prototype.enableCamera?3:2,ide=this.parentThatIsA(IDE_Morph);wardrobe.removeCostumeAt(idx-off);if(ide.currentSprite.costume===this.object){ide.currentSprite.wearCostume(null)}};CostumeIconMorph.prototype.importEmbeddedData=function(){var ide=this.parentThatIsA(IDE_Morph);ide.spriteBar.tabBar.tabTo("scripts");ide.droppedText(this.object.embeddedData,this.object.name,"")};CostumeIconMorph.prototype.typeOfStringData=function(aString){if(aString[0]==="<"){if(["project","snapdata","blocks","sprites","block","script"].some(tag=>aString.slice(1).startsWith(tag))){return"blocks"}}return"data"};CostumeIconMorph.prototype.exportCostume=function(){var ide=this.parentThatIsA(IDE_Morph);if(this.object instanceof SVG_Costume){ide.saveFileAs(this.object.contents.src,"text/svg",this.object.name)}else if(this.object.embeddedData){ide.saveFileAs(this.object.pngData(),"image/png",this.object.name)}else{ide.saveCanvasAs(this.object.contents,this.object.name)}};CostumeIconMorph.prototype.render=SpriteIconMorph.prototype.render;CostumeIconMorph.prototype.disinherit=function(){var wardrobe=this.parentThatIsA(WardrobeMorph),idx=this.parent.children.indexOf(this);if(wardrobe.sprite.inheritsAttribute("costumes")){wardrobe.sprite.shadowAttribute("costumes");this.object=wardrobe.sprite.costumes.at(idx-3)}};CostumeIconMorph.prototype.prepareToBeGrabbed=function(){this.disinherit();this.mouseClickLeft();this.removeCostume()};TurtleIconMorph.prototype=new ToggleButtonMorph;TurtleIconMorph.prototype.constructor=TurtleIconMorph;TurtleIconMorph.uber=ToggleButtonMorph.prototype;TurtleIconMorph.prototype.thumbSize=new Point(80,60);TurtleIconMorph.prototype.labelShadowOffset=null;TurtleIconMorph.prototype.labelShadowColor=null;TurtleIconMorph.prototype.labelColor=WHITE;TurtleIconMorph.prototype.fontSize=9;function TurtleIconMorph(aSpriteOrStage){this.init(aSpriteOrStage)}TurtleIconMorph.prototype.init=function(aSpriteOrStage){var colors,action,query;colors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor];action=()=>{var ide=this.parentThatIsA(IDE_Morph),wardrobe=this.parentThatIsA(WardrobeMorph);if(ide){ide.currentSprite.wearCostume(null)}if(wardrobe){wardrobe.updateSelection()}};query=()=>{var ide=this.parentThatIsA(IDE_Morph);if(ide){return ide.currentSprite.costume===null}return false};this.object=aSpriteOrStage;this.version=this.object.version;this.thumbnail=null;TurtleIconMorph.uber.init.call(this,colors,null,action,"default",query,null,null);this.isDraggable=false;this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout()};TurtleIconMorph.prototype.createThumbnail=function(){var isFlat=MorphicPreferences.isFlat;if(this.thumbnail){this.thumbnail.destroy()}if(this.object instanceof SpriteMorph){this.thumbnail=new SymbolMorph("turtle",this.thumbSize.y,this.labelColor,isFlat?null:new Point(-1,-1),new Color(0,0,0))}else{this.thumbnail=new SymbolMorph("stage",this.thumbSize.y,this.labelColor,isFlat?null:new Point(-1,-1),new Color(0,0,0))}this.add(this.thumbnail)};TurtleIconMorph.prototype.createLabel=function(){var txt;if(this.label){this.label.destroy()}txt=new StringMorph(localize(this.object instanceof SpriteMorph?"Turtle":"Empty"),this.fontSize,this.fontStyle,true,false,false,this.labelShadowOffset,this.labelShadowColor,this.labelColor);this.label=new FrameMorph;this.label.acceptsDrops=false;this.label.alpha=0;this.label.setExtent(txt.extent());txt.setPosition(this.label.position());this.label.add(txt);this.add(this.label)};TurtleIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout;TurtleIconMorph.prototype.render=SpriteIconMorph.prototype.render;TurtleIconMorph.prototype.userMenu=function(){var menu=new MenuMorph(this,"pen"),on="●",off="○";if(this.object instanceof StageMorph){return null}menu.addItem((this.object.penPoint==="tip"?on:off)+" "+localize("tip"),()=>{this.object.penPoint="tip";this.object.changed();this.object.fixLayout();this.object.rerender()});menu.addItem((this.object.penPoint==="middle"?on:off)+" "+localize("middle"),()=>{this.object.penPoint="middle";this.object.changed();this.object.fixLayout();this.object.rerender()});return menu};WardrobeMorph.prototype=new ScrollFrameMorph;WardrobeMorph.prototype.constructor=WardrobeMorph;WardrobeMorph.uber=ScrollFrameMorph.prototype;function WardrobeMorph(aSprite,sliderColor){this.init(aSprite,sliderColor)}WardrobeMorph.prototype.init=function(aSprite,sliderColor){this.sprite=aSprite||new SpriteMorph;this.costumesVersion=null;this.spriteVersion=null;WardrobeMorph.uber.init.call(this,null,null,sliderColor);this.updateList()};WardrobeMorph.prototype.updateList=function(){var x=this.left()+5,y=this.top()+5,padding=4,toolsPadding=5,oldPos=this.contents.position(),icon,txt,paintbutton,cambutton;this.changed();this.contents.destroy();this.contents=new FrameMorph(this);this.contents.acceptsDrops=false;this.contents.reactToDropOf=icon=>{this.reactToDropOf(icon)};this.addBack(this.contents);icon=new TurtleIconMorph(this.sprite);icon.setPosition(new Point(x,y));this.addContents(icon);y=icon.bottom()+padding;paintbutton=new PushButtonMorph(this,"paintNew",new SymbolMorph("brush",15));paintbutton.padding=0;paintbutton.corner=12;paintbutton.color=IDE_Morph.prototype.groupColor;paintbutton.highlightColor=IDE_Morph.prototype.frameColor.darker(50);paintbutton.pressColor=paintbutton.highlightColor;paintbutton.labelMinExtent=new Point(36,18);paintbutton.labelShadowOffset=new Point(-1,-1);paintbutton.labelShadowColor=paintbutton.highlightColor;paintbutton.labelColor=TurtleIconMorph.prototype.labelColor;paintbutton.contrast=this.buttonContrast;paintbutton.hint="Paint a new costume";paintbutton.setPosition(new Point(x,y));paintbutton.fixLayout();paintbutton.setCenter(icon.center());paintbutton.setLeft(icon.right()+padding*4);this.addContents(paintbutton);if(CamSnapshotDialogMorph.prototype.enableCamera){cambutton=new PushButtonMorph(this,"newFromCam",new SymbolMorph("camera",15));cambutton.padding=0;cambutton.corner=12;cambutton.color=IDE_Morph.prototype.groupColor;cambutton.highlightColor=IDE_Morph.prototype.frameColor.darker(50);cambutton.pressColor=paintbutton.highlightColor;cambutton.labelMinExtent=new Point(36,18);cambutton.labelShadowOffset=new Point(-1,-1);cambutton.labelShadowColor=paintbutton.highlightColor;cambutton.labelColor=TurtleIconMorph.prototype.labelColor;cambutton.contrast=this.buttonContrast;cambutton.hint="Import a new costume from your webcam";cambutton.setPosition(new Point(x,y));cambutton.fixLayout();cambutton.setCenter(paintbutton.center());cambutton.setLeft(paintbutton.right()+toolsPadding);this.addContents(cambutton);if(!CamSnapshotDialogMorph.prototype.enabled){cambutton.disable();cambutton.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage}document.addEventListener("cameraDisabled",()=>{cambutton.disable();cambutton.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage})}txt=new TextMorph(localize("costumes tab help"));txt.fontSize=9;txt.setColor(SpriteMorph.prototype.paletteTextColor);txt.setPosition(new Point(x,y));this.addContents(txt);y=txt.bottom()+padding;this.sprite.costumes.asArray().forEach(costume=>{icon=new CostumeIconMorph(costume);icon.setPosition(new Point(x,y));this.addContents(icon);y=icon.bottom()+padding});this.costumesVersion=this.sprite.costumes.lastChanged;this.contents.setPosition(oldPos);this.adjustScrollBars();this.changed();this.updateSelection()};WardrobeMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(morph){if(morph.refresh){morph.refresh()}});this.spriteVersion=this.sprite.version};WardrobeMorph.prototype.step=function(){if(this.costumesVersion!==this.sprite.costumes.lastChanged){this.updateList()}if(this.spriteVersion!==this.sprite.version){this.updateSelection()}};WardrobeMorph.prototype.removeCostumeAt=function(idx){this.sprite.shadowAttribute("costumes");this.sprite.costumes.remove(idx);this.updateList()};WardrobeMorph.prototype.paintNew=function(){var ide=this.parentThatIsA(IDE_Morph),cos=new Costume(newCanvas(null,true),this.sprite.newCostumeName(localize("Untitled")),null,null,ide.stage.dimensions);cos.edit(this.world(),ide,true,null,()=>{this.sprite.shadowAttribute("costumes");this.sprite.addCostume(cos);this.updateList();if(ide){ide.currentSprite.wearCostume(cos);ide.recordUnsavedChanges()}})};WardrobeMorph.prototype.newFromCam=function(){var camDialog,ide=this.parentThatIsA(IDE_Morph),sprite=this.sprite;camDialog=new CamSnapshotDialogMorph(ide,sprite,nop,costume=>{sprite.addCostume(costume);sprite.wearCostume(costume);this.updateList();ide.recordUnsavedChanges()});camDialog.key="camera";camDialog.popUp(this.world())};WardrobeMorph.prototype.wantsDropOf=function(morph){return morph instanceof CostumeIconMorph};WardrobeMorph.prototype.reactToDropOf=function(icon){var idx=0,costume=icon.object,top=icon.top();icon.destroy();this.contents.children.forEach(item=>{if(item instanceof CostumeIconMorph&&item.top()<top-4){idx+=1}});this.sprite.shadowAttribute("costumes");this.sprite.costumes.add(costume,idx+1);this.updateList();icon.mouseClickLeft()};SoundIconMorph.prototype=new ToggleButtonMorph;SoundIconMorph.prototype.constructor=SoundIconMorph;SoundIconMorph.uber=ToggleButtonMorph.prototype;SoundIconMorph.prototype.thumbSize=new Point(80,60);SoundIconMorph.prototype.labelShadowOffset=null;SoundIconMorph.prototype.labelShadowColor=null;SoundIconMorph.prototype.labelColor=WHITE;SoundIconMorph.prototype.fontSize=9;function SoundIconMorph(aSound){this.init(aSound)}SoundIconMorph.prototype.init=function(aSound){var colors,action,query;colors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor];action=nop;query=()=>false;this.object=aSound;this.version=this.object.version;this.thumbnail=null;SoundIconMorph.uber.init.call(this,colors,null,action,this.object.name,query,null,null);this.isDraggable=true;this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout();this.fps=1};SoundIconMorph.prototype.createThumbnail=function(){var label;if(this.thumbnail){this.thumbnail.destroy()}this.thumbnail=new Morph;this.thumbnail.bounds.setExtent(this.thumbSize);this.add(this.thumbnail);label=new StringMorph(this.createInfo(),"16","",true,false,false,this.labelShadowOffset,this.labelShadowColor,new Color(200,200,200));this.thumbnail.add(label);label.setCenter(new Point(40,15));this.button=new PushButtonMorph(this,"toggleAudioPlaying",this.object.previewAudio?"Stop":"Play");this.button.hint="Play sound";this.button.fixLayout();this.thumbnail.add(this.button);this.button.setCenter(new Point(40,40))};SoundIconMorph.prototype.createInfo=function(){var dur=Math.round(this.object.audio.duration||0),mod=dur%60;return Math.floor(dur/60).toString()+":"+(mod<10?"0":"")+mod.toString()};SoundIconMorph.prototype.toggleAudioPlaying=function(){if(!this.object.previewAudio){this.button.labelString="Stop";this.button.hint="Stop sound";this.object.previewAudio=this.object.play();this.object.previewAudio.addEventListener("ended",()=>this.audioHasEnded(),false)}else{this.button.labelString="Play";this.button.hint="Play sound";this.object.previewAudio.pause();this.object.previewAudio.terminated=true;this.object.previewAudio=null}this.button.createLabel()};SoundIconMorph.prototype.audioHasEnded=function(){this.button.trigger();this.button.mouseLeave()};SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel;SoundIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout;SoundIconMorph.prototype.userMenu=function(){var menu=new MenuMorph(this);if(!(this.object instanceof Sound)){return null}menu.addItem("rename","renameSound");menu.addItem("delete","removeSound");menu.addLine();menu.addItem("export","exportSound");return menu};SoundIconMorph.prototype.renameSound=function(){var sound=this.object,ide=this.parentThatIsA(IDE_Morph);this.disinherit();new DialogBoxMorph(null,answer=>{if(answer&&answer!==sound.name){sound.name=answer;sound.version=Date.now();this.createLabel();this.fixLayout();ide.hasChangedMedia=true;ide.recordUnsavedChanges()}}).prompt("rename sound",sound.name,this.world())};SoundIconMorph.prototype.removeSound=function(){var jukebox=this.parentThatIsA(JukeboxMorph),idx=this.parent.children.indexOf(this)-1;jukebox.removeSound(idx)};SoundIconMorph.prototype.exportSound=function(){var ide=this.parentThatIsA(IDE_Morph);ide.saveAudioAs(this.object.audio,this.object.name)};SoundIconMorph.prototype.render=SpriteIconMorph.prototype.render;SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel;SoundIconMorph.prototype.disinherit=function(){var jukebox=this.parentThatIsA(JukeboxMorph),idx=this.parent.children.indexOf(this);if(jukebox.sprite.inheritsAttribute("sounds")){jukebox.sprite.shadowAttribute("sounds");this.object=jukebox.sprite.sounds.at(idx-1)}};SoundIconMorph.prototype.prepareToBeGrabbed=function(){this.disinherit();this.userState="pressed";this.state=true;this.rerender();this.removeSound()};JukeboxMorph.prototype=new ScrollFrameMorph;JukeboxMorph.prototype.constructor=JukeboxMorph;JukeboxMorph.uber=ScrollFrameMorph.prototype;function JukeboxMorph(aSprite,sliderColor){this.init(aSprite,sliderColor)}JukeboxMorph.prototype.init=function(aSprite,sliderColor){this.sprite=aSprite||new SpriteMorph;this.soundsVersion=null;this.spriteVersion=null;JukeboxMorph.uber.init.call(this,null,null,sliderColor);this.acceptsDrops=false;this.updateList()};JukeboxMorph.prototype.updateList=function(){var x=this.left()+5,y=this.top()+5,padding=4,icon,txt,ide=this.sprite.parentThatIsA(IDE_Morph),recordButton;this.changed();this.contents.destroy();this.contents=new FrameMorph(this);this.contents.acceptsDrops=false;this.contents.reactToDropOf=icon=>this.reactToDropOf(icon);this.addBack(this.contents);txt=new TextMorph(localize("import a sound from your computer\nby dragging it into here"));txt.fontSize=9;txt.setColor(SpriteMorph.prototype.paletteTextColor);txt.setPosition(new Point(x,y));this.addContents(txt);recordButton=new PushButtonMorph(ide,"recordNewSound",new SymbolMorph("circleSolid",15));recordButton.padding=0;recordButton.corner=12;recordButton.color=IDE_Morph.prototype.groupColor;recordButton.highlightColor=IDE_Morph.prototype.frameColor.darker(50);recordButton.pressColor=recordButton.highlightColor;recordButton.labelMinExtent=new Point(36,18);recordButton.labelShadowOffset=new Point(-1,-1);recordButton.labelShadowColor=recordButton.highlightColor;recordButton.labelColor=TurtleIconMorph.prototype.labelColor;recordButton.contrast=this.buttonContrast;recordButton.hint="Record a new sound";recordButton.fixLayout();recordButton.label.setColor(new Color(255,20,20));recordButton.setPosition(txt.bottomLeft().add(new Point(0,padding*2)));this.addContents(recordButton);y=recordButton.bottom()+padding;this.sprite.sounds.asArray().forEach(sound=>{icon=new SoundIconMorph(sound);icon.setPosition(new Point(x,y));this.addContents(icon);y=icon.bottom()+padding});this.soundsVersion=this.sprite.sounds.lastChanged;this.changed();this.updateSelection()};JukeboxMorph.prototype.updateSelection=function(){this.contents.children.forEach(morph=>{if(morph.refresh){morph.refresh()}});this.spriteVersion=this.sprite.version};JukeboxMorph.prototype.step=function(){if(this.soundsVersion!==this.sprite.sounds.lastChanged){this.updateList()}if(this.spriteVersion!==this.sprite.version){this.updateSelection()}};JukeboxMorph.prototype.removeSound=function(idx){this.sprite.sounds.remove(idx);this.updateList()};JukeboxMorph.prototype.wantsDropOf=function(morph){return morph instanceof SoundIconMorph};JukeboxMorph.prototype.reactToDropOf=function(icon){var idx=0,costume=icon.object,top=icon.top();icon.destroy();this.contents.children.forEach(item=>{if(item instanceof SoundIconMorph&&item.top()<top-4){idx+=1}});this.sprite.shadowAttribute("sounds");this.sprite.sounds.add(costume,idx+1);this.updateList()};SceneIconMorph.prototype=new ToggleButtonMorph;SceneIconMorph.prototype.constructor=SceneIconMorph;SceneIconMorph.uber=ToggleButtonMorph.prototype;SceneIconMorph.prototype.thumbSize=new Point(40,30);SceneIconMorph.prototype.labelShadowOffset=null;SceneIconMorph.prototype.labelShadowColor=null;SceneIconMorph.prototype.labelColor=WHITE;SceneIconMorph.prototype.fontSize=9;function SceneIconMorph(aScene){this.init(aScene)}SceneIconMorph.prototype.init=function(aScene){var colors,action,query;colors=[IDE_Morph.prototype.frameColor,IDE_Morph.prototype.groupColor,IDE_Morph.prototype.groupColor];action=()=>{var ide=this.parentThatIsA(IDE_Morph),album=this.parentThatIsA(SceneAlbumMorph);album.scene=this.object;ide.switchToScene(this.object)};query=()=>{var album=this.parentThatIsA(SceneAlbumMorph);if(album){return album.scene===this.object}return false};this.object=aScene||new Scene;this.version=this.object.stage.version;this.thumbnail=null;SceneIconMorph.uber.init.call(this,colors,null,action,this.object.name||localize("untitled"),query,null,null);this.isDraggable=true;this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout();this.fps=1};SceneIconMorph.prototype.createThumbnail=function(){if(this.thumbnail){this.thumbnail.destroy()}this.thumbnail=new Morph;this.thumbnail.isCachingImage=true;this.thumbnail.bounds.setExtent(this.thumbSize);this.thumbnail.cachedImage=this.object.stage.thumbnail(this.thumbSize,this.thumbnail.cachedImage);this.add(this.thumbnail)};SceneIconMorph.prototype.createLabel=function(){var txt;if(this.label){this.label.destroy()}txt=new StringMorph(this.object.name||localize("untitled"),this.fontSize,this.fontStyle,false,false,false,this.labelShadowOffset,this.labelShadowColor,this.labelColor);this.label=new FrameMorph;this.label.acceptsDrops=false;this.label.alpha=0;this.label.setExtent(txt.extent());txt.setPosition(this.label.position());this.label.add(txt);this.add(this.label)};SceneIconMorph.prototype.step=function(){if(this.version!==this.object.stage.version){this.createThumbnail();this.createLabel();this.fixLayout();this.version=this.object.stage.version;this.refresh()}};SceneIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout;SceneIconMorph.prototype.userMenu=function(){var menu=new MenuMorph(this);if(!(this.object instanceof Scene)){return null}if(!this.isProjectScene()){menu.addItem("rename","renameScene");menu.addItem("delete","removeScene")}menu.addItem("export","exportScene");return menu};SceneIconMorph.prototype.renameScene=function(){var scene=this.object,ide=this.parentThatIsA(IDE_Morph);new DialogBoxMorph(null,answer=>{if(answer&&answer!==scene.name){scene.name=ide.newSceneName(answer,scene);scene.stage.version=Date.now();if(scene===ide.scene){ide.controlBar.updateLabel()}ide.recordUnsavedChanges()}}).prompt("rename scene",scene.name,this.world())};SceneIconMorph.prototype.removeScene=function(){var album=this.parentThatIsA(SceneAlbumMorph),idx=this.parent.children.indexOf(this)+1,off=0,ide=this.parentThatIsA(IDE_Morph);album.removeSceneAt(idx-off);if(ide.scene===this.object){ide.switchToScene(ide.scenes.at(1))}};SceneIconMorph.prototype.exportScene=function(){var menu,str,ide=this.parentThatIsA(IDE_Morph),name=this.object.name||localize("untitled");try{menu=ide.showMessage("Exporting");str=ide.serializer.serialize(new Project(new List([this.object]),this.object));ide.saveXMLAs(str,name);menu.destroy();ide.showMessage("Exported!",1)}catch(err){if(Process.prototype.isCatchingErrors){ide.showMessage("Export failed: "+err)}else{throw err}}};SceneIconMorph.prototype.isProjectScene=function(anIDE){var ide=anIDE||this.parentThatIsA(IDE_Morph);return ide.scenes.indexOf(this.object)===1};SceneIconMorph.prototype.render=SpriteIconMorph.prototype.render;SceneIconMorph.prototype.rootForGrab=function(){return this};SceneIconMorph.prototype.prepareToBeGrabbed=function(){this.mouseClickLeft();this.removeScene()};SceneAlbumMorph.prototype=new ScrollFrameMorph;SceneAlbumMorph.prototype.constructor=SceneAlbumMorph;SceneAlbumMorph.uber=ScrollFrameMorph.prototype;function SceneAlbumMorph(anIDE,sliderColor){this.init(anIDE,sliderColor)}SceneAlbumMorph.prototype.init=function(anIDE,sliderColor){this.ide=anIDE;this.scene=anIDE.scene;this.version=null;SceneAlbumMorph.uber.init.call(this,null,null,sliderColor);this.updateList();this.updateSelection()};SceneAlbumMorph.prototype.updateList=function(){var x=this.left()+5,y=this.top()+5,padding=4,oldPos=this.contents.position(),icon;this.changed();this.contents.destroy();this.contents=new FrameMorph(this);this.contents.acceptsDrops=false;this.contents.reactToDropOf=icon=>{this.reactToDropOf(icon)};this.addBack(this.contents);this.ide.scenes.asArray().forEach((scene,i)=>{icon=new SceneIconMorph(scene);if(i<1){icon.isDraggable=false}icon.setPosition(new Point(x,y));this.addContents(icon);y=icon.bottom()+padding});this.version=this.ide.scenes.lastChanged;this.contents.setPosition(oldPos);this.adjustScrollBars();this.changed();this.updateSelection()};SceneAlbumMorph.prototype.updateSelection=function(){this.scene=this.ide.scene;this.contents.children.forEach(function(morph){if(morph.refresh){morph.refresh()}})};SceneAlbumMorph.prototype.step=function(){if(this.version!==this.ide.scenes.lastChanged){this.updateList()}if(this.scene!==this.ide.scene){this.updateSelection()}};SceneAlbumMorph.prototype.removeSceneAt=function(idx){this.ide.scenes.remove(idx);this.updateList()};SceneAlbumMorph.prototype.wantsDropOf=function(morph){return morph instanceof SceneIconMorph};SceneAlbumMorph.prototype.reactToDropOf=function(icon){var idx=0,scene=icon.object,top=icon.top();icon.destroy();this.contents.children.forEach(item=>{if(item instanceof SceneIconMorph&&item.top()<top-4){idx+=1}});idx=Math.max(idx,1);this.ide.scenes.add(scene,idx+1);this.updateList();icon.mouseClickLeft()};StageHandleMorph.prototype=new Morph;StageHandleMorph.prototype.constructor=StageHandleMorph;StageHandleMorph.uber=Morph.prototype;function StageHandleMorph(target){this.init(target)}StageHandleMorph.prototype.init=function(target){this.target=target||null;this.userState="normal";HandleMorph.uber.init.call(this);this.color=MorphicPreferences.isFlat?IDE_Morph.prototype.backgroundColor:new Color(190,190,190);this.isDraggable=false;this.setExtent(new Point(12,50))};StageHandleMorph.prototype.render=function(ctx){if(this.userState==="highlight"){this.renderOn(ctx,MorphicPreferences.isFlat?new Color(245,245,255):new Color(100,100,255),this.color)}else{this.renderOn(ctx,this.color)}};StageHandleMorph.prototype.renderOn=function(ctx,color,shadowColor){var l=this.height()/8,w=this.width()/6,r=w/2,x,y,i;ctx.lineWidth=w;ctx.lineCap="round";y=this.height()/2;ctx.strokeStyle=color.toString();x=this.width()/12;for(i=0;i<3;i+=1){if(i>0){ctx.beginPath();ctx.moveTo(x,y-(l-r));ctx.lineTo(x,y+(l-r));ctx.stroke()}x+=w*2;l*=2}if(shadowColor){ctx.strokeStyle=shadowColor.toString();x=this.width()/12+w;l=this.height()/8;for(i=0;i<3;i+=1){if(i>0){ctx.beginPath();ctx.moveTo(x,y-(l-r));ctx.lineTo(x,y+(l-r));ctx.stroke()}x+=w*2;l*=2}}};StageHandleMorph.prototype.fixLayout=function(){if(!this.target){return}var ide=this.target.parentThatIsA(IDE_Morph);this.setTop(this.target.top()+10);this.setRight(this.target.left());if(ide){ide.add(this)}};StageHandleMorph.prototype.step=null;StageHandleMorph.prototype.mouseDownLeft=function(pos){var world=this.world(),offset=this.right()-pos.x,ide=this.target.parentThatIsA(IDE_Morph);if(!this.target){return null}ide.isSmallStage=true;ide.controlBar.stageSizeButton.refresh();this.step=function(){var newPos,newWidth;if(world.hand.mouseButton){newPos=world.hand.bounds.origin.x+offset;newWidth=this.target.right()-newPos;ide.stageRatio=newWidth/this.target.dimensions.x;ide.setExtent(world.extent())}else{this.step=null;ide.isSmallStage=ide.stageRatio!==1;ide.controlBar.stageSizeButton.refresh()}}};StageHandleMorph.prototype.mouseEnter=function(){this.userState="highlight";this.rerender()};StageHandleMorph.prototype.mouseLeave=function(){this.userState="normal";this.rerender()};StageHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).toggleStageSize(true,1)};PaletteHandleMorph.prototype=new Morph;PaletteHandleMorph.prototype.constructor=PaletteHandleMorph;PaletteHandleMorph.uber=Morph.prototype;function PaletteHandleMorph(target){this.init(target)}PaletteHandleMorph.prototype.init=function(target){this.target=target||null;this.userState="normal";HandleMorph.uber.init.call(this);this.color=MorphicPreferences.isFlat?IDE_Morph.prototype.backgroundColor:new Color(190,190,190);this.isDraggable=false;this.setExtent(new Point(12,50))};PaletteHandleMorph.prototype.render=StageHandleMorph.prototype.render;PaletteHandleMorph.prototype.renderOn=StageHandleMorph.prototype.renderOn;PaletteHandleMorph.prototype.fixLayout=function(){if(!this.target){return}var ide=this.target.parentThatIsA(IDE_Morph);this.setTop(this.target.top()+10);this.setRight(this.target.right());if(ide){ide.add(this)}};PaletteHandleMorph.prototype.step=null;PaletteHandleMorph.prototype.mouseDownLeft=function(pos){var world=this.world(),offset=this.right()-pos.x,ide=this.target.parentThatIsA(IDE_Morph);if(!this.target){return null}this.step=function(){var newPos;if(world.hand.mouseButton){newPos=world.hand.bounds.origin.x+offset;ide.paletteWidth=Math.min(Math.max(200,newPos),ide.stageHandle.left()-ide.spriteBar.tabBar.width());ide.setExtent(world.extent())}else{this.step=null}}};PaletteHandleMorph.prototype.mouseEnter=StageHandleMorph.prototype.mouseEnter;PaletteHandleMorph.prototype.mouseLeave=StageHandleMorph.prototype.mouseLeave;PaletteHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).setPaletteWidth(200)};CamSnapshotDialogMorph.prototype=new DialogBoxMorph;CamSnapshotDialogMorph.prototype.constructor=CamSnapshotDialogMorph;CamSnapshotDialogMorph.uber=DialogBoxMorph.prototype;CamSnapshotDialogMorph.prototype.enableCamera=true;CamSnapshotDialogMorph.prototype.enabled=true;CamSnapshotDialogMorph.prototype.notSupportedMessage="Please make sure your web browser is up to date\n"+"and your camera is properly configured. \n\n"+"Some browsers also require you to access Snap!\n"+"through HTTPS to use the camera.\n\n"+'Plase replace the "http://" part of the address\n'+'in your browser by "https://" and try again.';function CamSnapshotDialogMorph(ide,sprite,onCancel,onAccept){this.init(ide,sprite,onCancel,onAccept)}CamSnapshotDialogMorph.prototype.init=function(ide,sprite,onCancel,onAccept){this.ide=ide;this.sprite=sprite;this.padding=10;this.oncancel=onCancel;this.accept=onAccept;this.videoElement=null;this.videoView=new Morph;this.videoView.isCachingImage=true;CamSnapshotDialogMorph.uber.init.call(this);this.labelString="Camera";this.createLabel();this.buildContents()};CamSnapshotDialogMorph.prototype.buildContents=function(){var myself=this,stage=this.sprite.parentThatIsA(StageMorph);function noCameraSupport(){myself.disable();myself.ide.inform("Camera not supported",CamSnapshotDialogMorph.prototype.notSupportedMessage);if(myself.videoElement){myself.videoElement.remove()}myself.cancel()}this.videoElement=document.createElement("video");this.videoElement.hidden=true;this.videoElement.width=stage.dimensions.x;this.videoElement.height=stage.dimensions.y;document.body.appendChild(this.videoElement);if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{this.videoElement.srcObject=stream;this.videoElement.play().catch(noCameraSupport);this.videoElement.stream=stream}).catch(noCameraSupport)}this.videoView.setExtent(stage.dimensions);this.videoView.cachedImage=newCanvas(stage.dimensions,true,this.videoView.cachedImage);this.videoView.drawOn=function(ctx,rect){var videoWidth=myself.videoElement.videoWidth,videoHeight=myself.videoElement.videoHeight,w=stage.dimensions.x,h=stage.dimensions.y,clippingWidth,clippingHeight;if(!videoWidth){return}ctx.save();ctx.translate(w,0);ctx.scale(-1,1);if(videoWidth/w>videoHeight/h){clippingWidth=w*(videoHeight/h);clippingHeight=videoHeight}else{clippingWidth=videoWidth;clippingHeight=h*(videoWidth/w)}ctx.drawImage(myself.videoElement,0,0,clippingWidth,clippingHeight,this.left()*-1,this.top(),w,h);ctx.restore()};this.videoView.step=function(){this.changed()};this.addBody(new AlignmentMorph("column",this.padding/2));this.body.add(this.videoView);this.body.fixLayout();this.addButton("ok","Save");this.addButton("cancel","Cancel");this.fixLayout();this.rerender()};CamSnapshotDialogMorph.prototype.ok=function(){this.accept(new Costume(this.videoView.fullImage(),this.sprite.newCostumeName("camera"),null,true).flipped())};CamSnapshotDialogMorph.prototype.disable=function(){CamSnapshotDialogMorph.prototype.enabled=false;document.dispatchEvent(new Event("cameraDisabled"))};CamSnapshotDialogMorph.prototype.destroy=function(){this.oncancel.call(this);this.close()};CamSnapshotDialogMorph.prototype.close=function(){if(this.videoElement&&this.videoElement.stream){this.videoElement.stream.getTracks()[0].stop();this.videoElement.remove()}CamSnapshotDialogMorph.uber.destroy.call(this)};SoundRecorderDialogMorph.prototype=new DialogBoxMorph;SoundRecorderDialogMorph.prototype.constructor=SoundRecorderDialogMorph;SoundRecorderDialogMorph.uber=DialogBoxMorph.prototype;function SoundRecorderDialogMorph(onAccept){this.init(onAccept)}SoundRecorderDialogMorph.prototype.init=function(onAccept){var myself=this;this.padding=10;this.accept=onAccept;this.mediaRecorder=null;this.audioElement=document.createElement("audio");this.audioElement.hidden=true;this.audioElement.onended=function(event){myself.stop()};document.body.appendChild(this.audioElement);this.recordButton=null;this.stopButton=null;this.playButton=null;this.progressBar=new BoxMorph;SoundRecorderDialogMorph.uber.init.call(this);this.labelString="Sound Recorder";this.createLabel();this.buildContents()};SoundRecorderDialogMorph.prototype.buildContents=function(){var audioChunks=[];this.recordButton=new PushButtonMorph(this,"record",new SymbolMorph("circleSolid",10));this.stopButton=new PushButtonMorph(this,"stop",new SymbolMorph("rectangleSolid",10));this.playButton=new PushButtonMorph(this,"play",new SymbolMorph("pointRight",10));this.buildProgressBar();this.addBody(new AlignmentMorph("row",this.padding));this.body.add(this.recordButton);this.body.add(this.stopButton);this.body.add(this.playButton);this.body.add(this.progressBar);this.body.fixLayout();if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){navigator.mediaDevices.getUserMedia({audio:{channelCount:1}}).then(stream=>{this.mediaRecorder=new MediaRecorder(stream);this.mediaRecorder.ondataavailable=event=>{audioChunks.push(event.data)};this.mediaRecorder.onstop=event=>{var buffer=new Blob(audioChunks),reader=new window.FileReader;reader.readAsDataURL(buffer);reader.onloadend=()=>{var base64=reader.result;base64="data:audio/ogg;base64,"+base64.split(",")[1];this.audioElement.src=base64;this.audioElement.load();audioChunks=[]}}})}this.addButton("ok","Save");this.addButton("cancel","Cancel");this.fixLayout();this.rerender()};SoundRecorderDialogMorph.prototype.buildProgressBar=function(){var line=new Morph,myself=this;this.progressBar.setExtent(new Point(150,20));this.progressBar.setColor(new Color(200,200,200));this.progressBar.setBorderWidth(1);this.progressBar.setBorderColor(new Color(150,150,150));line.setExtent(new Point(130,2));line.setColor(new Color(50,50,50));line.setCenter(this.progressBar.center());this.progressBar.add(line);this.progressBar.indicator=new Morph;this.progressBar.indicator.setExtent(new Point(5,15));this.progressBar.indicator.setColor(new Color(50,200,50));this.progressBar.indicator.setCenter(line.leftCenter());this.progressBar.add(this.progressBar.indicator);this.progressBar.setPercentage=function(percentage){this.indicator.setLeft(line.left()+line.width()/100*percentage-this.indicator.width()/2)};this.progressBar.step=function(){if(myself.audioElement.duration){this.setPercentage(myself.audioElement.currentTime/myself.audioElement.duration*100)}else{this.setPercentage(0)}}};SoundRecorderDialogMorph.prototype.record=function(){if(this.mediaRecorder&&this.mediaRecorder.state!=="inactive"){this.stop();return}this.mediaRecorder.start();this.recordButton.label.setColor(new Color(255,0,0));this.playButton.label.setColor(new Color(0,0,0))};SoundRecorderDialogMorph.prototype.stop=function(){if(this.mediaRecorder&&this.mediaRecorder.state!=="inactive"){this.mediaRecorder.stop()}this.audioElement.pause();this.audioElement.currentTime=0;this.recordButton.label.setColor(new Color(0,0,0));this.playButton.label.setColor(new Color(0,0,0))};SoundRecorderDialogMorph.prototype.play=function(){this.stop();this.audioElement.oncanplaythrough=function(){this.play();this.oncanplaythrough=nop};this.playButton.label.setColor(new Color(0,255,0))};SoundRecorderDialogMorph.prototype.ok=function(){var myself=this;this.stop();this.audioElement.oncanplaythrough=function(){if(this.duration&&this.duration!==Infinity){myself.accept(this);this.oncanplaythrough=nop;myself.destroy()}else{myself.buttons.children.forEach(button=>button.disable());this.play()}}};SoundRecorderDialogMorph.prototype.destroy=function(){this.stop();this.audioElement.remove();if(this.mediaRecorder&&this.mediaRecorder.stream){this.mediaRecorder.stream.getTracks()[0].stop()}SoundRecorderDialogMorph.uber.destroy.call(this)};</script>
        <script>modules.paint="2021-July-05";var PaintEditorMorph;var PaintCanvasMorph;var PaintColorPickerMorph;PaintEditorMorph.prototype=new DialogBoxMorph;PaintEditorMorph.prototype.constructor=PaintEditorMorph;PaintEditorMorph.uber=DialogBoxMorph.prototype;PaintEditorMorph.prototype.padding=10;function PaintEditorMorph(){this.init()}PaintEditorMorph.prototype.init=function(){this.ide=null;this.paper=null;this.oncancel=null;PaintEditorMorph.uber.init.call(this);this.labelString="Paint Editor";this.createLabel()};PaintEditorMorph.prototype.buildContents=function(){var myself=this;this.paper=new PaintCanvasMorph(function(){return myself.shift});this.paper.setExtent(this.ide.stage.dimensions);this.addBody(new AlignmentMorph("row",this.padding));this.controls=new AlignmentMorph("column",this.padding/2);this.controls.alignment="center";this.edits=new AlignmentMorph("row",this.padding/2);this.buildEdits();this.controls.add(this.edits);this.body.color=this.color;this.body.add(this.controls);this.body.add(this.paper);this.toolbox=new BoxMorph;this.toolbox.color=SpriteMorph.prototype.paletteColor.lighter(8);this.toolbox.borderColor=this.toolbox.color.lighter(40);if(MorphicPreferences.isFlat){this.toolbox.edge=0}this.buildToolbox();this.controls.add(this.toolbox);this.scaleBox=new AlignmentMorph("row",this.padding/2);this.buildScaleBox();this.controls.add(this.scaleBox);this.propertiesControls={colorpicker:null,penSizeSlider:null,penSizeField:null,primaryColorButton:null,primaryColorViewer:null,constrain:null};this.populatePropertiesMenu();this.addButton("ok","OK");this.addButton("cancel","Cancel");this.refreshToolButtons();this.fixLayout()};PaintEditorMorph.prototype.buildToolbox=function(){var tools={brush:"Paintbrush tool\n(free draw)",rectangle:"Stroked Rectangle\n(shift: square)",circle:"Stroked Ellipse\n(shift: circle)",eraser:"Eraser tool",crosshairs:"Set the rotation center",line:"Line tool\n(shift: vertical/horizontal)",rectangleSolid:"Filled Rectangle\n(shift: square)",circleSolid:"Filled Ellipse\n(shift: circle)",paintbucket:"Fill a region",pipette:"Pipette tool\n(pick a color anywhere)"},myself=this,left=this.toolbox.left(),top=this.toolbox.top(),padding=2,inset=5,x=0,y=0;Object.keys(tools).forEach(function(tool){var btn=myself.toolButton(tool,tools[tool]);btn.setPosition(new Point(left+x,top+y));x+=btn.width()+padding;if(tool==="crosshairs"){x=0;y+=btn.height()+padding;myself.paper.drawcrosshair()}myself.toolbox[tool]=btn;myself.toolbox.add(btn)});this.toolbox.bounds=this.toolbox.fullBounds().expandBy(inset*2)};PaintEditorMorph.prototype.buildEdits=function(){var myself=this,paper=this.paper;this.edits.add(this.pushButton("undo",function(){paper.undo()}));this.edits.add(this.pushButton("clear",function(){paper.clearCanvas()}));this.edits.add(this.pushButton("Vector",function(){if(myself.paper.undoBuffer.length>0){myself.ide.confirm("This will erase your current drawing.\n"+"Are you sure you want to continue?","Switch to vector editor?",()=>{setTimeout(()=>{myself.switchToVector()})})}else{myself.switchToVector()}}));this.edits.fixLayout()};PaintEditorMorph.prototype.buildScaleBox=function(){var paper=this.paper;this.scaleBox.add(this.pushButton(new SymbolMorph("grow",18),function(){paper.scale(.05,.05)},"grow"));this.scaleBox.add(this.pushButton(new SymbolMorph("shrink",18),function(){paper.scale(-.05,-.05)},"shrink"));this.scaleBox.add(this.pushButton(new SymbolMorph("flipHorizontal",18),function(){paper.scale(-2,0)},"flip horizontal"));this.scaleBox.add(this.pushButton(new SymbolMorph("flipVertical",18),function(){paper.scale(0,-2)},"flip vertical"));this.scaleBox.fixLayout()};PaintEditorMorph.prototype.openIn=function(world,oldim,oldrc,callback,anIDE){var myself=this;this.oldim=oldim;this.callback=callback||nop;this.ide=anIDE;this.buildContents();this.processKeyUp=function(){myself.shift=false;myself.propertiesControls.constrain.refresh()};this.processKeyDown=function(){myself.shift=myself.world().currentKey===16;myself.propertiesControls.constrain.refresh()};if(this.oldim){this.paper.automaticCrosshairs=isNil(oldrc);this.paper.centermerge(this.oldim,this.paper.paper);this.paper.rotationCenter=(oldrc||new Point(0,0)).add(new Point((this.paper.paper.width-this.oldim.width)/2,(this.paper.paper.height-this.oldim.height)/2));this.paper.drawNew()}this.key="paint";this.popUp(world)};PaintEditorMorph.prototype.fixLayout=function(){this.changed();if(this.paper){this.paper.buildContents();this.paper.drawNew()}if(this.controls){this.controls.fixLayout()}if(this.body){this.body.fixLayout()}PaintEditorMorph.uber.fixLayout.call(this);this.changed()};PaintEditorMorph.prototype.refreshToolButtons=function(){this.toolbox.children.forEach(function(toggle){toggle.refresh()})};PaintEditorMorph.prototype.ok=function(){this.paper.updateAutomaticCenter();this.callback(this.paper.paper,this.paper.rotationCenter);this.destroy()};PaintEditorMorph.prototype.cancel=function(){if(this.oncancel){this.oncancel()}this.destroy()};PaintEditorMorph.prototype.switchToVector=function(){this.object=new SVG_Costume(new Image,"",new Point(0,0));this.object.edit(this.world(),this.ide,true)};PaintEditorMorph.prototype.populatePropertiesMenu=function(){var c=this.controls,myself=this,pc=this.propertiesControls,alpen=new AlignmentMorph("row",this.padding),brushControl=new AlignmentMorph("column",3);brushControl.alignment="left";pc.primaryColorViewer=new Morph;pc.primaryColorViewer.isCachingImage=true;pc.primaryColorViewer.render=function(ctx){var color=myself.paper.settings.primarycolor,i,j;if(color==="transparent"){for(i=0;i<180;i+=5){for(j=0;j<15;j+=5){ctx.fillStyle=(j+i)/5%2===0?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)";ctx.fillRect(i,j,5,5)}}}else{ctx.fillStyle=color.toString();ctx.fillRect(0,0,180,15)}ctx.strokeStyle="black";ctx.lineWidth=Math.min(myself.paper.settings.linewidth,20);ctx.beginPath();ctx.lineCap="round";ctx.moveTo(20,30);ctx.lineTo(160,30);ctx.stroke()};pc.primaryColorViewer.setExtent(new Point(180,40));pc.primaryColorViewer.color=new Color(0,0,0);pc.colorpicker=new PaintColorPickerMorph(new Point(180,100),function(color){myself.paper.settings.primarycolor=color;pc.primaryColorViewer.rerender()});pc.colorpicker.isCachingImage=true;pc.colorpicker.action(new Color(0,0,0));pc.penSizeSlider=new SliderMorph(0,20,5,5);pc.penSizeSlider.orientation="horizontal";pc.penSizeSlider.setHeight(15);pc.penSizeSlider.setWidth(150);pc.penSizeSlider.action=function(num){if(pc.penSizeField){pc.penSizeField.setContents(num)}myself.paper.settings.linewidth=num;pc.colorpicker.action(myself.paper.settings.primarycolor)};pc.penSizeField=new InputFieldMorph("5",true,null,false);pc.penSizeField.contents().minWidth=20;pc.penSizeField.setWidth(25);pc.penSizeField.accept=function(){var val=parseFloat(pc.penSizeField.getValue());pc.penSizeSlider.value=val;pc.penSizeSlider.updateValue();this.setContents(val);myself.paper.settings.linewidth=val;this.world().keyboardFocus=myself;pc.colorpicker.action(myself.paper.settings.primarycolor)};alpen.add(pc.penSizeSlider);alpen.add(pc.penSizeField);alpen.color=myself.color;alpen.fixLayout();pc.penSizeField.fixLayout();pc.constrain=new ToggleMorph("checkbox",this,function(){myself.shift=!myself.shift},"Constrain proportions of shapes?\n(you can also hold shift)",function(){return myself.shift});pc.constrain.label.isBold=false;c.add(pc.colorpicker);c.add(pc.primaryColorViewer);brushControl.add(new StringMorph(localize("Brush size")+":",10,null,true));brushControl.add(alpen);brushControl.add(pc.constrain);brushControl.fixLayout();c.add(brushControl)};PaintEditorMorph.prototype.toolButton=function(icon,hint){var button,myself=this;button=new ToggleButtonMorph(null,this,function(){myself.paper.currentTool=icon;myself.paper.toolChanged(icon);myself.refreshToolButtons();if(icon==="pipette"){myself.getUserColor()}},new SymbolMorph(icon,18),function(){return myself.paper.currentTool===icon});button.hint=hint;return button};PaintEditorMorph.prototype.pushButton=function(title,action,hint){return new PushButtonMorph(this,action,title,null,hint)};PaintEditorMorph.prototype.getUserColor=function(){var myself=this,world=this.world(),hand=world.hand,posInDocument=getDocumentPositionOf(world.worldCanvas),mouseMoveBak=hand.processMouseMove,mouseDownBak=hand.processMouseDown,mouseUpBak=hand.processMouseUp;hand.processMouseMove=function(event){var color;hand.setPosition(new Point(event.pageX-posInDocument.x,event.pageY-posInDocument.y));color=world.getGlobalPixelColor(hand.position());if(!color.a){return}color.a=1;myself.propertiesControls.colorpicker.action(color)};hand.processMouseDown=nop;hand.processMouseUp=function(){myself.paper.currentTool="brush";myself.paper.toolChanged("brush");myself.refreshToolButtons();hand.processMouseMove=mouseMoveBak;hand.processMouseDown=mouseDownBak;hand.processMouseUp=mouseUpBak}};PaintColorPickerMorph.prototype=new Morph;PaintColorPickerMorph.prototype.constructor=PaintColorPickerMorph;PaintColorPickerMorph.uber=Morph.prototype;function PaintColorPickerMorph(extent,action){this.init(extent,action)}PaintColorPickerMorph.prototype.init=function(extent,action){this.isCachingImage=true;this.setExtent(extent||new Point(200,100));this.action=action||nop};PaintColorPickerMorph.prototype.render=function(ctx){var x=0,y=0,colorselection,r;for(x=0;x<this.width();x+=1){for(y=0;y<this.height()-20;y+=1){ctx.fillStyle="hsl("+360*x/this.width()+","+"100%,"+y*100/(this.height()-20)+"%)";ctx.fillRect(x,y,1,1)}}for(x=0;x<this.width();x+=1){r=Math.floor(255*x/this.width());ctx.fillStyle="rgb("+r+", "+r+", "+r+")";ctx.fillRect(x,this.height()-20,1,10)}colorselection=["black","white","gray"];for(x=0;x<colorselection.length;x+=1){ctx.fillStyle=colorselection[x];ctx.fillRect(x*this.width()/colorselection.length,this.height()-10,this.width()/colorselection.length,10)}for(x=this.width()*2/3;x<this.width();x+=2){for(y=this.height()-10;y<this.height();y+=2){if((x+y)/2%2===0){ctx.fillStyle="#DDD";ctx.fillRect(x,y,2,2)}}}};PaintColorPickerMorph.prototype.mouseDownLeft=function(pos){if(pos.subtract(this.position()).x>this.width()*2/3&&pos.subtract(this.position()).y>this.height()-10){this.action("transparent")}else{this.action(this.getPixelColor(pos))}};PaintColorPickerMorph.prototype.mouseMove=PaintColorPickerMorph.prototype.mouseDownLeft;PaintCanvasMorph.prototype=new Morph;PaintCanvasMorph.prototype.constructor=PaintCanvasMorph;PaintCanvasMorph.uber=Morph.prototype;function PaintCanvasMorph(shift){this.init(shift)}PaintCanvasMorph.prototype.init=function(shift){this.rotationCenter=new Point(240,180);this.dragRect=null;this.previousDragPoint=null;this.currentTool="brush";this.dragRect=new Rectangle;this.mask=null;this.paper=null;this.erasermask=null;this.background=null;this.settings={primarycolor:new Color(0,0,0,255),secondarycolor:new Color(0,0,0,255),linewidth:3};this.brushBuffer=[];this.undoBuffer=[];this.isShiftPressed=shift||function(){var key=this.world().currentKey;return key===16};this.automaticCrosshairs=true;this.isCachingImage=true;this.buildContents();this.drawNew()};PaintCanvasMorph.prototype.calculateCanvasCenter=function(canvas){var canvasBounds=Costume.prototype.canvasBoundingBox(canvas);if(canvasBounds===null){return null}return new Point((canvasBounds.origin.x+canvasBounds.corner.x)/2,(canvasBounds.origin.y+canvasBounds.corner.y)/2)};PaintCanvasMorph.prototype.updateAutomaticCenter=function(){if(this.automaticCrosshairs){var rotationCenter=this.calculateCanvasCenter(this.paper);if(rotationCenter!==null){this.rotationCenter=rotationCenter}}};PaintCanvasMorph.prototype.scale=function(x,y){this.updateAutomaticCenter();this.mask=newCanvas(this.extent(),true);var c=newCanvas(this.extent(),true);c.getContext("2d").save();c.getContext("2d").translate(this.rotationCenter.x,this.rotationCenter.y);c.getContext("2d").scale(1+x,1+y);c.getContext("2d").drawImage(this.paper,-this.rotationCenter.x,-this.rotationCenter.y);c.getContext("2d").restore();this.paper=c;this.drawNew();this.changed()};PaintCanvasMorph.prototype.cacheUndo=function(){var cachecan=newCanvas(this.extent(),true);this.merge(this.paper,cachecan);this.undoBuffer.push(cachecan)};PaintCanvasMorph.prototype.undo=function(){if(this.undoBuffer.length>0){this.paper=newCanvas(this.extent(),true);this.mask.width=this.mask.width+1-1;this.merge(this.undoBuffer.pop(),this.paper);this.drawNew();this.changed()}};PaintCanvasMorph.prototype.merge=function(a,b){b.getContext("2d").drawImage(a,0,0)};PaintCanvasMorph.prototype.centermerge=function(a,b){b.getContext("2d").drawImage(a,(b.width-a.width)/2,(b.height-a.height)/2)};PaintCanvasMorph.prototype.clearCanvas=function(){this.buildContents();this.drawNew();this.changed()};PaintCanvasMorph.prototype.toolChanged=function(tool){this.mask=newCanvas(this.extent(),true,this.mask);if(tool==="crosshairs"){this.updateAutomaticCenter();this.drawcrosshair()}this.drawNew();this.changed()};PaintCanvasMorph.prototype.drawcrosshair=function(context){var ctx=context||this.mask.getContext("2d"),rp=this.rotationCenter;ctx.save();ctx.lineWidth=1;ctx.strokeStyle="black";ctx.clearRect(0,0,this.mask.width,this.mask.height);ctx.globalAlpha=.5;ctx.fillStyle="white";ctx.beginPath();ctx.arc(rp.x,rp.y,20,radians(0),radians(360),false);ctx.closePath();ctx.fill();ctx.stroke();ctx.beginPath();ctx.arc(rp.x,rp.y,10,radians(0),radians(360),false);ctx.stroke();ctx.beginPath();ctx.moveTo(0,rp.y);ctx.lineTo(this.mask.width,rp.y);ctx.stroke();ctx.beginPath();ctx.moveTo(rp.x,0);ctx.lineTo(rp.x,this.mask.height);ctx.stroke();ctx.restore();this.drawNew()};PaintCanvasMorph.prototype.floodfill=function(sourcepoint){var width=this.paper.width,height=this.paper.height,ctx=this.paper.getContext("2d"),img=ctx.getImageData(0,0,width,height),data=img.data,stack=[Math.round(Math.round(sourcepoint.y)*width+sourcepoint.x)],currentpoint,read,sourcecolor,checkpoint;read=function(p){var d=p*4;return[data[d],data[d+1],data[d+2],data[d+3]]};sourcecolor=read(stack[0]);checkpoint=function(p){return p[0]===sourcecolor[0]&&p[1]===sourcecolor[1]&&p[2]===sourcecolor[2]&&p[3]===sourcecolor[3]};if(sourcecolor[3]===0&&this.settings.primarycolor==="transparent"){return}if(sourcecolor[0]===this.settings.primarycolor.r&&sourcecolor[1]===this.settings.primarycolor.g&&sourcecolor[2]===this.settings.primarycolor.b&&sourcecolor[3]===this.settings.primarycolor.a*255){return}if(sourcecolor[3]===0&&this.settings.primarycolor.a===0){return}while(stack.length>0){currentpoint=stack.pop();if(checkpoint(read(currentpoint))){if(currentpoint%width>1){stack.push(currentpoint+1);stack.push(currentpoint-1)}if(currentpoint>0&&currentpoint<height*width){stack.push(currentpoint+width);stack.push(currentpoint-width)}}if(this.settings.primarycolor==="transparent"){data[currentpoint*4+3]=0}else{data[currentpoint*4]=this.settings.primarycolor.r;data[currentpoint*4+1]=this.settings.primarycolor.g;data[currentpoint*4+2]=this.settings.primarycolor.b;data[currentpoint*4+3]=this.settings.primarycolor.a*255}}ctx.putImageData(img,0,0);this.drawNew();this.changed()};PaintCanvasMorph.prototype.mouseDownLeft=function(pos){this.cacheUndo();this.dragRect.origin=pos.subtract(this.bounds.origin);this.dragRect.corner=pos.subtract(this.bounds.origin);this.previousDragPoint=this.dragRect.corner.copy();if(this.currentTool==="crosshairs"){this.rotationCenter=pos.subtract(this.bounds.origin);this.drawcrosshair();return}if(this.currentTool==="paintbucket"){return this.floodfill(pos.subtract(this.bounds.origin))}if(this.settings.primarycolor==="transparent"&&this.currentTool!=="crosshairs"){this.erasermask=newCanvas(this.extent(),true,this.erasermask);this.merge(this.paper,this.erasermask)}};PaintCanvasMorph.prototype.mouseMove=function(pos){if(this.currentTool==="paintbucket"){return}var relpos=pos.subtract(this.bounds.origin),mctx=this.mask.getContext("2d"),pctx=this.paper.getContext("2d"),x=this.dragRect.origin.x,y=this.dragRect.origin.y,p=relpos.x,q=relpos.y,w=(p-x)/2,h=(q-y)/2,i,width=this.paper.width;mctx.save();function newW(){return Math.max(Math.abs(w),Math.abs(h))*(w/Math.abs(w))}function newH(){return Math.max(Math.abs(w),Math.abs(h))*(h/Math.abs(h))}this.brushBuffer.push([p,q]);mctx.lineWidth=this.settings.linewidth;mctx.clearRect(0,0,this.bounds.width(),this.bounds.height());this.dragRect.corner=relpos.subtract(this.dragRect.origin);if(this.settings.primarycolor==="transparent"&&this.currentTool!=="crosshairs"){this.merge(this.erasermask,this.mask);pctx.clearRect(0,0,this.bounds.width(),this.bounds.height());mctx.globalCompositeOperation="destination-out"}else{mctx.fillStyle=this.settings.primarycolor.toString();mctx.strokeStyle=this.settings.primarycolor.toString()}switch(this.currentTool){case"rectangle":if(this.isShiftPressed()){mctx.strokeRect(x,y,newW()*2,newH()*2)}else{mctx.strokeRect(x,y,w*2,h*2)}break;case"rectangleSolid":if(this.isShiftPressed()){mctx.fillRect(x,y,newW()*2,newH()*2)}else{mctx.fillRect(x,y,w*2,h*2)}break;case"brush":mctx.lineCap="round";mctx.lineJoin="round";mctx.beginPath();mctx.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]);for(i=0;i<this.brushBuffer.length;i+=1){mctx.lineTo(this.brushBuffer[i][0],this.brushBuffer[i][1])}mctx.stroke();break;case"line":mctx.beginPath();mctx.moveTo(x,y);if(this.isShiftPressed()){if(Math.abs(h)>Math.abs(w)){mctx.lineTo(x,q)}else{mctx.lineTo(p,y)}}else{mctx.lineTo(p,q)}mctx.stroke();break;case"circle":case"circleSolid":mctx.beginPath();if(this.isShiftPressed()){mctx.arc(x,y,new Point(x,y).distanceTo(new Point(p,q)),0,Math.PI*2,false)}else{for(i=0;i<width;i+=1){mctx.lineTo(i,2*h*Math.sqrt(2-Math.pow((i-x)/(2*w),2))+y)}for(i=width;i>0;i-=1){mctx.lineTo(i,-1*(2*h)*Math.sqrt(2-Math.pow((i-x)/(2*w),2))+y)}}mctx.closePath();if(this.currentTool==="circleSolid"){mctx.fill()}else{if(this.currentTool==="circle"){mctx.stroke()}}break;case"crosshairs":this.automaticCrosshairs=false;this.rotationCenter=relpos.copy();this.drawcrosshair(mctx);break;case"eraser":this.merge(this.paper,this.mask);mctx.save();mctx.globalCompositeOperation="destination-out";mctx.beginPath();mctx.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]);for(i=0;i<this.brushBuffer.length;i+=1){mctx.lineTo(this.brushBuffer[i][0],this.brushBuffer[i][1])}mctx.stroke();mctx.restore();this.paper=newCanvas(this.extent(),true);this.merge(this.mask,this.paper);break;default:nop()}this.previousDragPoint=relpos;this.drawNew();mctx.restore();this.changed()};PaintCanvasMorph.prototype.mouseClickLeft=function(){if(this.currentTool!=="crosshairs"){this.merge(this.mask,this.paper)}this.brushBuffer=[]};PaintCanvasMorph.prototype.mouseLeaveDragging=PaintCanvasMorph.prototype.mouseClickLeft;PaintCanvasMorph.prototype.buildContents=function(){this.background=newCanvas(this.extent(),false,this.background);this.paper=newCanvas(this.extent(),true,this.paper);this.mask=newCanvas(this.extent(),true,this.mask);this.erasermask=newCanvas(this.extent(),true,this.erasermask);var i,j,bkctx=this.background.getContext("2d");for(i=0;i<this.background.width;i+=5){for(j=0;j<this.background.height;j+=5){if((i+j)/5%2===1){bkctx.fillStyle="rgba(255, 255, 255, 1)"}else{bkctx.fillStyle="rgba(255, 255, 255, 0.3)"}bkctx.fillRect(i,j,5,5)}}};PaintCanvasMorph.prototype.drawNew=function(){var can=newCanvas(this.extent(),true,this.cachedImage);this.merge(this.background,can);this.merge(this.paper,can);this.merge(this.mask,can);this.cachedImage=can;this.drawFrame()};PaintCanvasMorph.prototype.rerender=PaintCanvasMorph.prototype.drawNew;PaintCanvasMorph.prototype.drawFrame=function(){var context,borderColor;context=this.cachedImage.getContext("2d");if(this.parent){this.color=this.parent.color.lighter(this.contrast*.75);borderColor=this.parent.color}else{borderColor=new Color(120,120,120)}context.fillStyle=this.color.toString();this.cachedClr=borderColor.toString();this.cachedClrBright=borderColor.lighter(this.contrast).toString();this.cachedClrDark=borderColor.darker(this.contrast).toString();this.drawRectBorder(context)};PaintCanvasMorph.prototype.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;PaintCanvasMorph.prototype.edge=InputFieldMorph.prototype.edge;PaintCanvasMorph.prototype.fontSize=InputFieldMorph.prototype.fontSize;PaintCanvasMorph.prototype.typeInPadding=InputFieldMorph.prototype.typeInPadding;PaintCanvasMorph.prototype.contrast=InputFieldMorph.prototype.contrast;</script>
        <script>modules.lists="2022-July-19";var List;var ListWatcherMorph;function List(array){this.type=null;this.contents=array||[];this.first=null;this.rest=null;this.isLinked=false;this.lastChanged=Date.now()}List.prototype.enableTables=true;List.prototype.toString=function(){return"a List ["+this.length()+" elements]"};List.prototype.changed=function(){this.lastChanged=Date.now()};List.prototype.cons=function(car,cdr){var answer=new List;if(!(cdr instanceof List||isNil(cdr))){throw new Error("cdr isn't a list: "+cdr)}answer.first=isNil(car)?null:car;answer.rest=cdr||null;answer.isLinked=true;return answer};List.prototype.cdr=function(){var result,i;if(this.isLinked){return this.rest||new List}if(this.contents.length<2){return new List}result=new List;for(i=this.contents.length;i>1;i-=1){result=this.cons(this.at(i),result)}return result};List.prototype.add=function(element,index){var idx=Math.round(+index)||this.length()+1,obj=isNil(element)?null:element;this.becomeArray();this.contents.splice(idx-1,0,obj);this.changed()};List.prototype.put=function(element,index){var idx=Math.round(+index)||0,data=element===0?0:element===false?false:element||null;this.becomeArray();if(idx<1||idx>this.contents.length){return}this.contents[idx-1]=data;this.changed()};List.prototype.remove=function(index){this.becomeArray();this.contents.splice(Math.round(+index||0)-1,1);this.changed()};List.prototype.clear=function(){this.contents=[];this.first=null;this.rest=null;this.isLinked=false;this.changed()};List.prototype.map=function(callback){return new List(this.itemsArray().map(callback))};List.prototype.deepMap=function(callback){return this.map(item=>item instanceof List?item.deepMap(callback):callback(item))};List.prototype.length=function(){if(this.isLinked){var pair=this,result=0;while(pair&&pair.isLinked){result+=1;pair=pair.rest}return result+(pair?pair.contents.length:0)}return this.contents.length};List.prototype.at=function(index){var value,idx=Math.round(+index||0),pair=this;while(pair.isLinked){if(idx>1){pair=pair.rest;idx-=1}else{return pair.first}}value=pair.contents[idx-1];return isNil(value)?"":value};List.prototype.contains=function(element){var pair=this;while(pair.isLinked){if(snapEquals(pair.first,element)){return true}pair=pair.rest}return pair.contents.some(any=>snapEquals(any,element))};List.prototype.isEmpty=function(){if(this.isLinked){return isNil(this.first)}return!this.contents.length};List.prototype.indexOf=function(element){var pair=this,idx=1,i,len;while(pair.isLinked){if(snapEquals(pair.first,element)){return idx}pair=pair.rest;idx+=1}len=pair.contents.length;for(i=0;i<len;i+=1){if(snapEquals(pair.contents[i],element)){return idx+i}}return 0};List.prototype.isTable=function(){return this.enableTables&&(this.length()>100||this.cols()>1)};List.prototype.get=function(col,row){var r,len,cols;if(!col){if(!row){return[this.length()]}if(row>this.rows()){return null}return this.rowName(row)}else if(!row){if(this.cols()===1){return localize("items")}return this.colName(col)}r=this.at(row);if(r instanceof List){len=r.length();cols=this.cols();if(col>len){return null}else if(cols===1&&len>1){return[r]}else if(col>=cols&&len>cols){return new Variable(r.at(col))}return r.at(col)}if(col===1&&row<=this.rows()){return[r]}return null};List.prototype.rows=function(){return this.length()};List.prototype.cols=function(){var len=Math.min(10,this.length()),count=1,r,i;for(i=1;i<=len;i+=1){r=this.at(i);if(r instanceof List){count=Math.max(count,r.length())}}return count};List.prototype.colName=function(col){if(col>this.cols()){return null}return String.fromCharCode(64+(col%26||26)).repeat(Math.floor((col-1)/26)+1)};List.prototype.rowName=function(row){return row};List.prototype.columnNames=function(){return[]};List.prototype.version=function(startRow,rows,startCol,cols){var l=Math.min(startRow+rows,this.length()),v=this.lastChanged,r,i;for(i=startRow;i<=l;i+=1){r=this.at(i);if(r instanceof Costume){v=Math.max(v,r.version)}else if(r instanceof List){v=Math.max(v,r.version(startCol,cols))}else{v=Math.max(v,r.lastChanged?r.lastChanged:0)}}return v};List.prototype.query=function(indices){var first,select;if(indices.isEmpty()){return this.map(e=>e)}if(indices.rank()===1){return indices.map(i=>this.at(i))}first=indices.at(1);if(first instanceof List){select=first.isEmpty()?this.range(1,this.length()):first}else{select=new List([first])}return select.map(i=>this.at(i)).map(e=>e instanceof List?e.query(indices.cdr()):e)};List.prototype.slice=function(indices){var first,select;if(indices.isEmpty()){return this.map(e=>e)}if(indices.rank()===1){return this.rangify(indices).map(i=>this.at(i))}first=indices.at(1);if(first instanceof List){select=first.isEmpty()?this.range(1,this.length()):this.rangify(first)}else{select=this.rangify(new List([first]))}return select.map(i=>this.at(i)).map(e=>e instanceof List?e.slice(indices.cdr()):e)};List.prototype.rangify=function(indices){var result=[],len=this.length(),current=0,start,end;indices.itemsArray().forEach(idx=>{idx=+idx;if(idx>0){result.push(idx);current=idx}else{end=len+idx;if(current!==end){start=current<end?current+1:current-1;this.range(start,end).itemsArray().forEach(num=>result.push(num))}}});return new List(result)};List.prototype.range=function(start,end){return new List([...Array(Math.abs(end-start)+1)].map((e,i)=>start<end?start+i:start-i))};List.prototype.items=function(indices){return makeSelector(this.rank(),indices.cdr(),makeLeafSelector(indices.at(1)))(this);function makeSelector(rank,indices,next){if(rank===1){return next}return makeSelector(rank-1,indices.cdr(),makeBranch(indices.at(1)||new List,next))}function makeBranch(indices,next){return function(data){if(indices.isEmpty()){return data.map(item=>next(item))}return indices.map(idx=>next(data.at(idx)))}}function makeLeafSelector(indices){return function(data){if(indices.isEmpty()){return data.map(item=>item)}return indices.map(idx=>data.at(idx))}}};List.prototype.size=function(){var count=0;this.deepMap(()=>count+=1);return count};List.prototype.ravel=function(){var all=[];this.deepMap(atom=>all.push(atom));return new List(all)};List.prototype.rank=function(){var rank=1,len=this.length(),item,i;for(i=1;i<=len;i+=1){item=this.at(i);if(item instanceof List){rank=Math.max(rank,1+item.rank())}}return rank};List.prototype.shape=function(){var dim,rank=this.rank(),shp=new List([this.length()]),max,items,i,len;for(dim=2;dim<=rank;dim+=1){max=0;items=this.getDimension(dim);len=items.length();for(i=1;i<=len;i+=1){max=Math.max(max,items.at(i).length())}shp.add(max)}return shp};List.prototype.getDimension=function(rank=0){if(rank<1){return new List}if(rank===1){return this.map(item=>item)}if(rank===2){return new List(this.itemsArray().filter(item=>item instanceof List))}return new List(this.getDimension(rank-1).flatten().itemsArray().filter(value=>value instanceof List))};List.prototype.width=function(){var i,item,width=0,len=this.length();for(i=1;i<=len;i+=1){item=this.at(i);width=Math.max(width,item instanceof List?item.length():0)}return width};List.prototype.flatten=function(){var flat=[];this.itemsArray().forEach(item=>{if(item instanceof List){item.itemsArray().forEach(value=>flat.push(value))}else{flat.push(item)}});return new List(flat)};List.prototype.transpose=function(){if(this.rank()>2){return this.strideTranspose()}return this.columns()};List.prototype.columns=function(){var col,src,i,width=Math.max(this.width(),1),table=[];src=this.map(row=>row instanceof List?row:new List(new Array(width).fill(row)));col=(tab,c)=>tab.map(row=>row.at(c));for(i=1;i<=width;i+=1){table.push(col(src,i))}return new List(table)};List.prototype.reshape=function(dimensions){var src=this.ravel().itemsArray(),i=0,size,trg;if(dimensions.isEmpty()){return src[0]}size=dimensions.itemsArray().reduce((a,b)=>a*b);if(size<src.length){trg=src.slice(0,size)}else{if(size>src.length&&dimensions.length()>2&&size>1e6){throw new Error("exceeding the size limit for reshape")}trg=src.slice();while(trg.length<size){if(i>=src.length){i=0}trg.push(src[i]);i+=1}}return new List(trg).folded(dimensions)};List.prototype.folded=function(dimensions){var len=dimensions.length(),trg=this,i;if(len<2){return this.map(e=>e)}for(i=len;i>1;i-=1){trg=trg.asChunksOf(dimensions.at(i))}return trg};List.prototype.asChunksOf=function(size){var trg=new List,len=this.length(),sub,i;for(i=0;i<len;i+=1){if(i%size===0){sub=new List;trg.add(sub)}sub.add(this.at(i+1))}return trg};List.prototype.crossproduct=function(){var result=new List,len=this.length(),lengths=this.map(each=>each.length()),size=lengths.itemsArray().reduce((a,b)=>a*b),i,k,row,factor;if(size>1e6){throw new Error("exceeding the size limit for cross product")}for(i=1;i<=size;i+=1){row=new List;factor=1;for(k=1;k<=len;k+=1){row.add(this.at(k).at((Math.ceil(i/(size/lengths.at(k)*factor))-1)%lengths.at(k)+1));factor/=lengths.at(k)}result.add(row)}return result};List.prototype.strideTranspose=function(){var oldShape=this.shape(),newShape=oldShape.reversed(),oldSizes=new List([1]),newSizes=new List([1]),oldFlat=this.ravel(),newFlat=new List(new Array(oldFlat.length())),product=1,i;function newIndex(old,os,ns){var foo;if(os.isEmpty()){return 0}foo=Math.floor(old/ns.at(1));return foo*os.at(1)+newIndex(old%ns.at(1),os.cdr(),ns.cdr())}for(i=oldShape.length();i>1;i-=1){product*=oldShape.at(i);newSizes.add(product,1)}product=1;for(i=1;i<=oldShape.length()-1;i+=1){product*=oldShape.at(i);oldSizes.add(product)}for(i=1;i<=oldFlat.length();i+=1){newFlat.put(oldFlat.at(i),newIndex(i-1,oldSizes,newSizes)+1)}return newFlat.reshape(newShape)};List.prototype.reversed=function(){return new List(this.itemsArray().slice().reverse())};List.prototype.asArray=function(){this.becomeArray();return this.contents};List.prototype.itemsArray=function(){if(this.isLinked){var next=this,result=[],i;while(next&&next.isLinked){result.push(next.first);next=next.rest}if(next){for(i=1;i<=next.contents.length;i+=1){result.push(next.at(i))}}return result}return this.contents};List.prototype.asText=function(){var result="",length,element,pair=this,i;while(pair.isLinked){element=pair.first;if(element instanceof List){result=result.concat(element.asText())}else{element=isNil(element)?"":element.toString();result=result.concat(element)}pair=pair.rest}length=pair.length();for(i=1;i<=length;i+=1){element=pair.at(i);if(element instanceof List){result=result.concat(element.asText())}else{element=isNil(element)?"":element.toString();result=result.concat(element)}}return result};List.prototype.becomeArray=function(){if(this.isLinked){this.contents=this.itemsArray();this.isLinked=false;this.first=null;this.rest=null}};List.prototype.becomeLinked=function(){var i,stop,tail=this;if(!this.isLinked){stop=this.length();for(i=0;i<stop;i+=1){tail.first=this.contents[i];if(i<stop){tail.rest=new List;tail.isLinked=true;tail=tail.rest}}this.contents=[];this.isLinked=true}};List.prototype.asCSV=function(){var items=this.itemsArray(),rows=[];function encodeCell(atomicValue){var string=isNil(atomicValue)?"":atomicValue.toString(),cell;if(string.indexOf('"')===-1&&string.indexOf("\n")===-1&&string.indexOf(",")===-1){return string}cell=['"'];Array.from(string).forEach(letter=>{cell.push(letter);if(letter==='"'){cell.push(letter)}});cell.push('"');return cell.join("")}if(items.some(any=>any instanceof List)){items.forEach(item=>{if(item instanceof List){rows.push(item.itemsArray().map(encodeCell).join(","))}else{rows.push(encodeCell(item))}});return rows.join("\n")}return items.map(encodeCell).join(",")};List.prototype.asJSON=function(){function objectify(list){var items=list.itemsArray(),obj={};if(canBeObject(items)){items.forEach(pair=>{var value=pair.length()===2?pair.at(2):undefined;obj[pair.at(1)]=value instanceof List?objectify(value):value});return obj}return items.map(element=>element instanceof List?objectify(element):element)}function canBeObject(array){var keys;if(array.every(element=>element instanceof List&&element.length()===2)){keys=array.map(each=>each.at(1));return keys.every(each=>isString(each)&&isUniqueIn(each,keys))}return false}function isUniqueIn(element,array){return array.indexOf(element)===array.lastIndexOf(element)}return JSON.stringify(objectify(this))};List.prototype.canBeTXT=function(){return this.itemsArray().every(item=>isString(item)||typeof item==="number")};List.prototype.asTXT=function(){return this.itemsArray().join("\n")};List.prototype.equalTo=function(other){var myself=this,it=other,i,j,loopcount;if(!(other instanceof List)){return false}while(myself.isLinked&&it.isLinked){if(!snapEquals(myself.first,it.first)){return false}myself=myself.rest;it=it.rest}if(it.isLinked){i=it;it=myself;myself=i}j=0;while(myself.isLinked){if(!snapEquals(myself.first,it.contents[j])){return false}myself=myself.rest;j+=1}i=0;if(myself.contents.length!==it.contents.length-j){return false}loopcount=myself.contents.length;while(loopcount>0){loopcount-=1;if(!snapEquals(myself.contents[i],it.contents[j])){return false}i+=1;j+=1}return true};List.prototype.canBeCSV=function(){return this.itemsArray().every(value=>{return!isNaN(+value)&&typeof value!=="boolean"||isString(value)||value instanceof List&&value.hasOnlyAtomicData()})};List.prototype.canBeJSON=function(){return this.itemsArray().every(value=>{return!isNaN(+value)||isString(value)||value===true||value===false||value instanceof List&&value.canBeJSON()})};List.prototype.hasOnlyAtomicData=function(){return this.itemsArray().every(value=>{return!isNaN(+value)&&typeof value!=="boolean"||isString(value)})};List.prototype.blockify=function(limit=500,count=[0]){var block=SpriteMorph.prototype.blockForSelector("reportNewList"),slots=block.inputs()[0],len=this.length(),bool,i,value;block.isDraggable=true;slots.removeInput();for(i=0;i<len&&count[0]<limit;i+=1){value=this.at(i+1);if(value instanceof List){slots.replaceInput(slots.addInput(),value.blockify(limit,count))}else if(typeof value==="boolean"){bool=SpriteMorph.prototype.blockForSelector("reportBoolean");bool.inputs()[0].setContents(value);bool.isDraggable=true;slots.replaceInput(slots.addInput(),bool)}else{slots.addInput(value)}count[0]+=1}slots.fixBlockColor(null,true);return block};ListWatcherMorph.prototype=new BoxMorph;ListWatcherMorph.prototype.constructor=ListWatcherMorph;ListWatcherMorph.uber=BoxMorph.prototype;ListWatcherMorph.prototype.cellColor=SpriteMorph.prototype.blockColor.lists;function ListWatcherMorph(list,parentCell){this.init(list,parentCell)}ListWatcherMorph.prototype.init=function(list,parentCell){var myself=this,readOnly;this.list=list||new List;this.start=1;this.range=100;this.lastUpdated=0;this.lastCell=null;this.parentCell=parentCell||null;this.label=new StringMorph(localize("length: ")+this.list.length(),SyntaxElementMorph.prototype.fontSize,null,false,false,false,MorphicPreferences.isFlat?ZERO:new Point(1,1),WHITE);this.label.mouseClickLeft=function(){myself.startIndexMenu()};this.frame=new ScrollFrameMorph(null,10);this.frame.alpha=0;this.frame.acceptsDrops=false;this.frame.contents.acceptsDrops=false;this.handle=new HandleMorph(this,80,70,3,3);this.handle.setExtent(new Point(13,13));this.arrow=new ArrowMorph("down",SyntaxElementMorph.prototype.fontSize);this.arrow.mouseClickLeft=function(){myself.startIndexMenu()};this.arrow.setRight(this.handle.right());this.arrow.setBottom(this.handle.top());this.handle.add(this.arrow);readOnly=this.list.type&&!contains(["text","number"],this.list.type);if(readOnly){this.plusButton=null}else{this.plusButton=new PushButtonMorph(this.list,"add","+");this.plusButton.padding=0;this.plusButton.edge=0;this.plusButton.outlineColor=this.color;this.plusButton.fixLayout()}ListWatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1,new Color(120,120,120));this.color=new Color(220,220,220);this.isDraggable=false;this.setExtent(new Point(80,70).multiplyBy(SyntaxElementMorph.prototype.scale));this.add(this.label);this.add(this.frame);if(!readOnly){this.add(this.plusButton)}this.add(this.handle);this.handle.fixLayout();this.update();this.fixLayout()};ListWatcherMorph.prototype.update=function(anyway){var i,idx,ceil,morphs,cell,cnts,label,button,max,starttime,maxtime=1e3;this.frame.contents.children.forEach(m=>{if(m instanceof CellMorph){if(m.contentsMorph instanceof ListWatcherMorph){m.contentsMorph.update()}else if(isSnapObject(m.contents)||m.contents instanceof Costume||m.contents instanceof Context){m.update()}}});if(this.lastUpdated===this.list.lastChanged&&!anyway){return null}this.updateLength(true);this.start=Math.max(Math.min(this.start,Math.floor((this.list.length()-1)/this.range)*this.range+1),1);max=Math.min(this.start+this.range-1,this.list.length());ceil=Math.min((max-this.start+1)*3,this.frame.contents.children.length);for(i=0;i<ceil;i+=3){idx=this.start+i/3;cell=this.frame.contents.children[i];label=this.frame.contents.children[i+1];button=this.frame.contents.children[i+2];cnts=this.list.at(idx);if(cell.contents!==cnts){cell.contents=cnts;cell.fixLayout();if(this.lastCell){cell.setLeft(this.lastCell.left())}}this.lastCell=cell;if(label.text!==idx.toString()){label.text=idx.toString();label.fixLayout()}button.action=idx}morphs=(max-this.start+1)*3;while(this.frame.contents.children.length>morphs){this.frame.contents.children[morphs].destroy()}ceil=morphs;i=this.frame.contents.children.length;starttime=Date.now();if(ceil>i+1){for(i;i<ceil;i+=3){if(Date.now()-starttime>maxtime){this.fixLayout();this.frame.contents.adjustBounds();this.frame.contents.setLeft(this.frame.left());return null}idx=this.start+i/3;label=new StringMorph(idx.toString(),SyntaxElementMorph.prototype.fontSize,null,false,false,false,MorphicPreferences.isFlat?ZERO:new Point(1,1),WHITE);cell=new CellMorph(this.list.at(idx),this.cellColor,idx,this.parentCell);button=new PushButtonMorph(this.list.remove,idx,"-",this.list);button.padding=1;button.edge=0;button.corner=1;button.outlineColor=this.color.darker();button.fixLayout();this.frame.contents.add(cell);if(this.lastCell){cell.setPosition(this.lastCell.bottomLeft())}else{cell.setTop(this.frame.contents.top())}this.lastCell=cell;label.setCenter(cell.center());label.setRight(cell.left()-2);this.frame.contents.add(label);this.frame.contents.add(button)}}this.lastCell=null;this.fixLayout();this.frame.contents.adjustBounds();this.frame.contents.setLeft(this.frame.left());this.updateLength();this.lastUpdated=this.list.lastChanged};ListWatcherMorph.prototype.updateLength=function(notDone){this.label.text=localize("length: ")+this.list.length();if(notDone){this.label.color=new Color(0,0,100)}else{this.label.color=new Color(0,0,0)}this.label.fixLayout();this.label.setCenter(this.center());this.label.setBottom(this.bottom()-3)};ListWatcherMorph.prototype.startIndexMenu=function(){var i,range,items=Math.ceil(this.list.length()/this.range),menu=new MenuMorph(idx=>this.setStartIndex(idx),null,this);menu.addItem("1...",1);for(i=1;i<items;i+=1){range=i*100+1;menu.addItem(range+"...",range)}menu.popUpAtHand(this.world())};ListWatcherMorph.prototype.setStartIndex=function(index){this.start=index;this.list.changed();this.update()};ListWatcherMorph.prototype.fixLayout=function(){if(!this.label){return}if(this.frame){this.arrangeCells();this.frame.setPosition(this.position().add(3));this.frame.bounds.corner=this.bounds.corner.subtract(new Point(3,17));this.frame.fixLayout();this.frame.contents.adjustBounds()}this.label.setCenter(this.center());this.label.setBottom(this.bottom()-3);if(this.plusButton){this.plusButton.setLeft(this.left()+3);this.plusButton.setBottom(this.bottom()-3)}if(this.parent){this.parent.changed();this.parent.fixLayout();this.parent.rerender()}};ListWatcherMorph.prototype.arrangeCells=function(){var i,cell,label,button,lastCell,end=this.frame.contents.children.length;for(i=0;i<end;i+=3){cell=this.frame.contents.children[i];label=this.frame.contents.children[i+1];button=this.frame.contents.children[i+2];if(lastCell){cell.setTop(lastCell.bottom())}if(label){label.setTop(cell.center().y-label.height()/2);label.setRight(cell.left()-2)}if(button){button.setCenter(cell.center());button.setLeft(cell.right()+2)}lastCell=cell}this.frame.contents.adjustBounds()};ListWatcherMorph.prototype.expand=function(maxExtent){var fe=this.frame.contents.extent(),ext=new Point(fe.x+6,fe.y+this.label.height()+6);if(maxExtent){ext=ext.min(maxExtent)}this.setExtent(ext);this.handle.setRight(this.right()-3);this.handle.setBottom(this.bottom()-3)};ListWatcherMorph.prototype.userMenu=function(){var world=this.world(),ide=detect(world.children,m=>m instanceof IDE_Morph);if(!List.prototype.enableTables||ide.isAppMode){return this.escalateEvent("userMenu")}var menu=new MenuMorph(this);menu.addItem("table view...","showTableView");if(this.list.canBeJSON()){menu.addItem("blockify",()=>{this.list.blockify().pickUp(world);world.hand.grabOrigin={origin:ide.palette,position:ide.palette.center()}});menu.addItem("export",()=>{if(this.list.canBeCSV()){ide.saveFileAs(this.list.asCSV(),"text/csv;charset=utf-8",localize("data"))}else{ide.saveFileAs(this.list.asJSON(),"text/json;charset=utf-8",localize("data"))}})}menu.addLine();menu.addItem("open in dialog...",()=>new TableDialogMorph(this.list).popUp(this.world()));return menu};ListWatcherMorph.prototype.showTableView=function(){var view=this.parentThatIsA(SpriteBubbleMorph,SpeechBubbleMorph,CellMorph);if(!view){return}if(view instanceof SpriteBubbleMorph){view.contentsMorph.destroy();view.contentsMorph=new TableFrameMorph(new TableMorph(this.list,10));view.contentsMorph.expand(this.extent());view.parent.positionTalkBubble()}else if(view instanceof SpeechBubbleMorph){view.contents=new TableFrameMorph(new TableMorph(this.list,10));view.contents.expand(this.extent())}else{view.changed();view.contentsMorph.destroy();view.contentsMorph=new TableFrameMorph(new TableMorph(this.list,10));view.add(view.contentsMorph);view.contentsMorph.setPosition(this.position());view.contentsMorph.expand(this.extent())}view.fixLayout();view.rerender()};ListWatcherMorph.prototype.mouseDoubleClick=function(pos){if(List.prototype.enableTables){new TableDialogMorph(this.list).popUp(this.world())}else{this.escalateEvent("mouseDoubleClick",pos)}};ListWatcherMorph.prototype.show=function(){ListWatcherMorph.uber.show.call(this);this.frame.contents.adjustBounds()};ListWatcherMorph.prototype.render=WatcherMorph.prototype.render;</script>
        <script>modules.byob="2022-August-01";var CustomBlockDefinition;var CustomCommandBlockMorph;var CustomReporterBlockMorph;var BlockDialogMorph;var BlockEditorMorph;var PrototypeHatBlockMorph;var BlockLabelFragment;var BlockLabelFragmentMorph;var BlockInputFragmentMorph;var BlockLabelPlaceHolderMorph;var InputSlotDialogMorph;var VariableDialogMorph;var JaggedBlockMorph;var BlockExportDialogMorph;var BlockImportDialogMorph;var BlockRemovalDialogMorph;var BlockVisibilityDialogMorph;function CustomBlockDefinition(spec,receiver){this.body=null;this.scripts=[];this.category=null;this.isGlobal=false;this.type="command";this.spec=spec||"";this.declarations=new Map;this.variableNames=[];this.comment=null;this.isHelper=false;this.codeMapping=null;this.codeHeader=null;this.translations={};this.receiver=receiver||null;this.editorDimensions=null;this.cachedIsRecursive=null;this.cachedTranslation=null;this.storedSemanticSpec=null}CustomBlockDefinition.prototype.blockInstance=function(storeTranslations){var block;if(this.type==="command"){block=new CustomCommandBlockMorph(this)}else{block=new CustomReporterBlockMorph(this,this.type==="predicate")}block.isDraggable=true;if(storeTranslations){block.storedTranslations=this.translationsAsText()}return block};CustomBlockDefinition.prototype.templateInstance=function(){var block;block=this.blockInstance();block.refreshDefaults(this);block.isDraggable=false;block.isTemplate=true;return block};CustomBlockDefinition.prototype.prototypeInstance=function(){var block,slot;if(this.type==="command"){block=new CustomCommandBlockMorph(this,true)}else{block=new CustomReporterBlockMorph(this,this.type==="predicate",true)}block.parts().forEach(part=>{if(part instanceof BlockInputFragmentMorph){slot=this.declarations.get(part.fragment.labelString);if(slot){part.fragment.type=slot[0];part.fragment.defaultValue=slot[1];part.fragment.options=slot[2];part.fragment.isReadOnly=slot[3]||false}}});return block};CustomBlockDefinition.prototype.copyAndBindTo=function(sprite,headerOnly){var c=copy(this);delete c[XML_Serializer.prototype.idProperty];c.receiver=sprite;c.declarations=new Map;for(var[key,val]of this.declarations){c.declarations.set(key,val)}if(headerOnly){c.body=null;return c}if(c.body){c.body=Process.prototype.reify.call(null,this.body.expression,new List(this.inputNames()));c.body.outerContext=null}return c};CustomBlockDefinition.prototype.blockSpec=function(){if(this.storedSemanticSpec){return this.storedSemanticSpec}var ans=[],parts=this.parseSpec(this.spec),spec;parts.forEach(part=>{if(part[0]==="%"&&part.length>1){spec=this.typeOf(part.slice(1))}else if(part==="$nl"){spec="%br"}else{spec=part}ans.push(spec);ans.push(" ")});return"".concat.apply("",ans).trim()};CustomBlockDefinition.prototype.helpSpec=function(){var ans=[],parts=this.parseSpec(this.spec);parts.forEach(part=>{if(part[0]!=="%"){ans.push(part)}});return"".concat.apply("",ans).replace(/\?/g,"")};CustomBlockDefinition.prototype.typeOf=function(inputName){if(this.declarations.has(inputName)){return this.declarations.get(inputName)[0]}return"%s"};CustomBlockDefinition.prototype.defaultValueOf=function(inputName){if(this.declarations.has(inputName)){return this.declarations.get(inputName)[1]}return""};CustomBlockDefinition.prototype.defaultValueOfInputIdx=function(idx){var inputName=this.inputNames()[idx];return this.defaultValueOf(inputName)};CustomBlockDefinition.prototype.dropDownMenuOfInputIdx=function(idx){var inputName=this.inputNames()[idx];return this.dropDownMenuOf(inputName)};CustomBlockDefinition.prototype.isReadOnlyInputIdx=function(idx){var inputName=this.inputNames()[idx];return this.isReadOnlyInput(inputName)};CustomBlockDefinition.prototype.inputOptionsOfIdx=function(idx){var inputName=this.inputNames()[idx];return this.inputOptionsOf(inputName)};CustomBlockDefinition.prototype.dropDownMenuOf=function(inputName){var fname;if(this.declarations.has(inputName)&&this.declarations.get(inputName)[2]){if(this.declarations.get(inputName)[2].indexOf("§_")===0){fname=this.declarations.get(inputName)[2].slice(2);if(contains(["messagesMenu","messagesReceivedMenu","objectsMenu","costumesMenu","soundsMenu","getVarNamesDict","pianoKeyboardMenu","directionDialMenu"],fname)||fname.indexOf("ext_")===0){return fname}}return this.parseChoices(this.declarations.get(inputName)[2])}return null};CustomBlockDefinition.prototype.parseChoices=function(string){var dict={},stack=[dict],params,body;if(string.match(/^function\s*\(.*\)\s*{.*\n/)){params=string.match(/^function\s*\((.*)\)/)[1].split(",");body=string.split("\n").slice(1,-1).join("\n");return Function.apply(null,params.concat([body]))}string.split("\n").forEach(line=>{var pair=line.split("=");if(pair[0]==="}"){stack.pop();dict=stack[stack.length-1]}else if(pair[1]==="{"){dict={};stack[stack.length-1][pair[0]]=dict;stack.push(dict)}else{dict[pair[0]]=isNil(pair[1])?pair[0]:pair[1]}});return dict};CustomBlockDefinition.prototype.encodeChoices=function(list){var encode=dta=>dta instanceof List?encodeList(dta):dta.toString(),encodeList=dta=>dta.length()===2?encodePair(dta):dta.itemsArray().reduce((a,b)=>encode(a)+"\n"+encode(b)),encodePair=dta=>encode(dta.at(1))+"="+(dta.at(2)instanceof List?encodeSub(dta.at(2)):encode(dta.at(2))),encodeSub=dta=>"{\n"+encode(dta)+"\n}";if(list.isEmpty()){return""}return list.itemsArray().reduce((a,b)=>encode(a)+"\n"+encode(b))};CustomBlockDefinition.prototype.decodeChoices=function(choices){var list=new List,key;for(key in choices){if(Object.prototype.hasOwnProperty.call(choices,key)){if(key[0]==="~"){list.add(key[0])}else if(choices[key]instanceof Object&&!(choices[key]instanceof Array)&&typeof choices[key]!=="function"){list.add(new List([key,this.decodeChoices(choices[key])]))}else if(choices[key]instanceof Array&&isString(choices[key][0])){list.add(choices[key][0]===key?key:new List([key,choices[key][0]]))}else if(choices[key]instanceof Array&&choices[key][0]instanceof Object&&typeof choices[key][0]!=="function"){list.add(new List([key,this.decodeChoices(choices[key][0])]))}else{list.add(choices[key]===key?key:new List([key,choices[key]]))}}}return list};CustomBlockDefinition.prototype.menuSearchWords=function(){var terms=[];this.inputNames().forEach(slot=>{var menu=this.dropDownMenuOf(slot);if(menu){if(isString(menu)){if(typeof InputSlotMorph.prototype[menu]==="function"){menu=InputSlotMorph.prototype[menu](true);terms.push(Object.values(menu).map(entry=>{if(isNil(entry)){return""}if(entry instanceof Array){return localize(entry[0])}return entry.toString()}).join(" "))}}else{terms.push(Object.keys(menu).join(" "))}}});return terms.join(" ").toLowerCase()};CustomBlockDefinition.prototype.isReadOnlyInput=function(inputName){return this.declarations.has(inputName)&&this.declarations.get(inputName)[3]===true};CustomBlockDefinition.prototype.inputOptionsOf=function(inputName){return[this.dropDownMenuOf(inputName),this.isReadOnlyInput(inputName)]};CustomBlockDefinition.prototype.inputNames=function(){var vNames=[],parts=this.parseSpec(this.spec);parts.forEach(part=>{if(part[0]==="%"&&part.length>1){vNames.push(part.slice(1))}});return vNames};CustomBlockDefinition.prototype.parseSpec=function(spec){var parts=[],word="",i,quoted=false,c;for(i=0;i<spec.length;i+=1){c=spec[i];if(c==="'"){quoted=!quoted}else if(c===" "&&!quoted){parts.push(word);word=""}else{word=word.concat(c)}}parts.push(word);return parts};CustomBlockDefinition.prototype.isDirectlyRecursive=function(){var myspec;if(this.cachedIsRecursive!==null){return this.cachedIsRecursive}if(!this.body){this.cachedIsRecursive=false}else{myspec=this.blockSpec();this.cachedIsRecursive=this.body.expression.anyChild(function(morph){return morph.isCustomBlock&&morph.blockSpec===myspec})}return this.cachedIsRecursive};CustomBlockDefinition.prototype.localizedSpec=function(){if(this.cachedTranslation){return this.cachedTranslation}var loc=this.translations[SnapTranslator.language],sem=this.blockSpec(),locParts,inputs,i=-1;function isInput(str){return str.length>1&&str[0]==="%"}if(isNil(loc)){return sem}inputs=BlockMorph.prototype.parseSpec(sem).filter(str=>isInput(str));locParts=BlockMorph.prototype.parseSpec(loc);if(locParts.some(str=>isInput(str))||locParts.filter(str=>str==="_").length!==inputs.length){this.cachedTranslation=sem}else{locParts=locParts.map(str=>{if(str==="_"){i+=1;return inputs[i]}return str});this.cachedTranslation=locParts.join(" ")}return this.cachedTranslation};CustomBlockDefinition.prototype.abstractBlockSpec=function(){return BlockMorph.prototype.parseSpec(this.blockSpec()).map(str=>str.length>1&&str[0]==="%"?"_":str).join(" ")};CustomBlockDefinition.prototype.translationsAsText=function(){var txt="";Object.keys(this.translations).forEach(lang=>txt+=lang+":"+this.translations[lang]+"\n");return txt};CustomBlockDefinition.prototype.updateTranslations=function(text){var lines=text.split("\n").filter(txt=>txt.length);this.translations={};lines.forEach(txt=>{var idx=txt.indexOf(":"),key=txt.slice(0,idx).trim(),val=txt.slice(idx+1).trim();if(idx){this.translations[key]=val}})};CustomBlockDefinition.prototype.setBlockLabel=function(abstractSpec){var parts=abstractSpec.split(" ").filter(each=>each.length&&each!==" "),count=parts.filter(each=>each==="_").length,inputNames=this.inputNames(),spec="",idx=0;if(count!==inputNames.length){throw new Error("expecting the number of inputs to match")}parts.forEach(part=>{if(part==="_"){spec+=inputNames[idx]?"%'"+inputNames[idx]+"' ":"";idx+=1}else{spec+=part+" "}});this.spec=spec.trim()};CustomBlockDefinition.prototype.setBlockDefinition=function(aContext){var oldInputs=this.inputNames(),newInputs=aContext.inputs,declarations=this.declarations,parts=[],body=aContext,idx=0,reportBlock,spec;this.addInputs(newInputs.length-oldInputs.length);spec=this.abstractBlockSpec();oldInputs=this.inputNames();parts=spec.split(" ").filter(each=>each.length&&each!==" ");spec="";parts.forEach(part=>{if(part==="_"){spec+=newInputs[idx]?"%'"+newInputs[idx]+"' ":"";idx+=1}else{spec+=part+" "}});this.spec=spec.trim();this.declarations=new Map;for(var[key,val]of declarations){this.declarations.set(newInputs[oldInputs.indexOf(key)],val)}if(body.expression instanceof Array){this.body=null;return}else if(body.expression instanceof ReporterBlockMorph){body=copy(aContext);reportBlock=SpriteMorph.prototype.blockForSelector("doReport");reportBlock.replaceInput(reportBlock.inputs()[0],body.expression.fullCopy());body.expression=reportBlock}this.body=body};CustomBlockDefinition.prototype.addInputs=function(count){var inputNames,i;if(count===0){return}else if(count<0){return this.removeInputs(-count)}inputNames=this.inputNames();for(i=0;i<count;i+=1){inputNames.push(this.gensym(inputNames))}this.spec=this.parseSpec(this.spec).concat(inputNames.slice(-count).map(str=>"%"+str)).join(" ").trim();inputNames.slice(-count).forEach(name=>this.declarations.set(name,["%s"]))};CustomBlockDefinition.prototype.removeInputs=function(count){var surplus=this.inputNames().slice(-count);this.spec=this.parseSpec(this.spec).filter(str=>!(str.length>1&&str[0]==="%"&&surplus.includes(str.slice(1)))).join(" ").trim();surplus.forEach(name=>this.declarations.delete(name))};CustomBlockDefinition.prototype.gensym=function(existing){var count=1;while(contains(existing,"#"+count)){count+=1}return"#"+count};CustomBlockDefinition.prototype.scriptsPicture=function(){return this.scriptsModel().scriptsPicture()};CustomBlockDefinition.prototype.sortedElements=function(){return this.scriptsModel().sortedElements()};CustomBlockDefinition.prototype.scriptsModel=function(){var scripts,proto,block,comment,template;scripts=new ScriptsMorph;scripts.cleanUpMargin=10;proto=new PrototypeHatBlockMorph(this);proto.setPosition(scripts.position().add(10));if(this.comment!==null){comment=this.comment.fullCopy();proto.comment=comment;comment.block=proto}if(this.body!==null){proto.nextBlock(this.body.expression.fullCopy())}scripts.add(proto);proto.fixBlockColor(null,true);this.scripts.forEach(element=>{block=element.fullCopy();block.setPosition(scripts.position().add(element.position()));scripts.add(block);if(block instanceof BlockMorph){block.allComments().forEach(comment=>comment.align(block))}});proto.allComments().forEach(comment=>comment.align(proto));template=proto.parts()[0];template.fixLayout();template.forceNormalColoring();template.fixBlockColor(proto,true);scripts.fixMultiArgs();return scripts};CustomBlockDefinition.prototype.purgeCorpses=function(){if(this.body&&this.body.expression.isCorpse){this.body=null}this.scripts=this.scripts.filter(topBlock=>!topBlock.isCorpse)};CustomBlockDefinition.prototype.collectDependencies=function(excluding,result,localReceiver){if(!this.isGlobal&&!localReceiver){throw new Error("cannot collect dependencies for local\n"+"custom blocks of an unspecified sprite")}excluding.push(this);this.scripts.concat(this.body?[this.body.expression]:[]).forEach(script=>{script.forAllChildren(morph=>{var def;if(morph.isCustomBlock){def=morph.isGlobal?morph.definition:localReceiver.getMethod(morph.blockSpec);if(!contains(excluding,def)&&!contains(result,def)){result.push(def);def.collectDependencies(excluding,result,localReceiver)}}})});return result};CustomBlockDefinition.prototype.isSending=function(message,receiverName){return this.scripts.concat(this.body?[this.body.expression]:[]).some(script=>script instanceof BlockMorph&&script.isSending(message,receiverName))};CustomCommandBlockMorph.prototype=new CommandBlockMorph;CustomCommandBlockMorph.prototype.constructor=CustomCommandBlockMorph;CustomCommandBlockMorph.uber=CommandBlockMorph.prototype;CustomCommandBlockMorph.prototype.isCustomBlock=true;function CustomCommandBlockMorph(definition,isProto){this.init(definition,isProto)}CustomCommandBlockMorph.prototype.init=function(definition,isProto){this.definition=definition;this.semanticSpec="";this.isGlobal=definition?definition.isGlobal:false;this.isPrototype=isProto||false;CustomCommandBlockMorph.uber.init.call(this);if(isProto){this.isTemplate=true}this.category=definition.category;this.selector="evaluateCustomBlock";this.variables=null;this.storedTranslations=null;this.initializeVariables();if(definition){this.refresh()}};CustomCommandBlockMorph.prototype.reactToTemplateCopy=function(){var def;if(this.isPrototype){def=this.definition;this.isPrototype=false;this.setSpec(" ");this.refresh();this.refreshDefaults(def)}CustomCommandBlockMorph.uber.reactToTemplateCopy.call(this)};CustomCommandBlockMorph.prototype.initializeVariables=function(oldVars){this.variables=new VariableFrame;if(!this.isGlobal){return}this.definition.variableNames.forEach(name=>{var v=oldVars?oldVars[name]:null;this.variables.addVar(name,v instanceof Variable?v.value:null)})};CustomCommandBlockMorph.prototype.refresh=function(aDefinition){var def=aDefinition||this.definition,newSpec=this.isPrototype?def.spec:def.localizedSpec(),oldInputs;this.semanticSpec=def.blockSpec();if(!this.isGlobal&&!this.isPrototype){this.definition=null}this.setCategory(def.category);if(this.blockSpec!==newSpec){oldInputs=this.inputs();if(!this.zebraContrast){this.forceNormalColoring()}else{this.fixBlockColor()}this.setSpec(newSpec,def);this.fixLabelColor();this.restoreInputs(oldInputs)}else{this.inputs().forEach((inp,i)=>{if(inp instanceof InputSlotMorph){inp.setChoices.apply(inp,def.inputOptionsOfIdx(i))}})}this.cachedInputs=null;this.inputs().forEach((inp,idx)=>{if(inp instanceof TemplateSlotMorph&&inp.contents()===" "){inp.setContents(def.inputNames()[idx])}});if(this.isGlobal){this.initializeVariables(this.variables.vars)}this.forceNormalColoring();this.fixBlockColor(null,true)};CustomCommandBlockMorph.prototype.restoreInputs=function(oldInputs){var newInputs=this.inputs(),len=Math.max(oldInputs.length,newInputs.length),scripts=this.parentThatIsA(ScriptsMorph),old,inp,i;function preserve(item){if(item instanceof MultiArgMorph){return item.inputs().forEach(slot=>preserve(slot))}if(item instanceof BlockMorph&&scripts){scripts.add(item);item.moveBy(new Point(20,20));item.fixBlockColor()}}if(this.isPrototype){return}this.cachedInputs=null;for(i=0;i<len;i+=1){inp=newInputs[i];old=oldInputs[i];if(old instanceof ArgLabelMorph){old=old.argMorph()}if(old instanceof ReporterBlockMorph&&inp&&!(inp instanceof TemplateSlotMorph)){this.replaceInput(inp,old.fullCopy())}else if(old instanceof InputSlotMorph&&inp instanceof InputSlotMorph){if(old.isEmptySlot()){inp.setContents("")}else{inp.setContents(old.evaluate())}}else if(old instanceof BooleanSlotMorph&&inp instanceof BooleanSlotMorph){inp.setContents(old.evaluate())}else if(old instanceof TemplateSlotMorph&&inp instanceof TemplateSlotMorph){inp.setContents(old.evaluate())}else if(old instanceof CSlotMorph&&inp instanceof CSlotMorph){inp.nestedBlock(old.evaluate())}else if(old instanceof MultiArgMorph&&inp instanceof MultiArgMorph&&old.slotSpec===inp.slotSpec){this.replaceInput(inp,old.fullCopy())}else{preserve(old)}}this.cachedInputs=null};CustomCommandBlockMorph.prototype.refreshDefaults=function(definition){var inputs=this.inputs(),idx=0;inputs.forEach(inp=>{if(inp instanceof InputSlotMorph||inp instanceof BooleanSlotMorph){inp.setContents((definition||this.definition).defaultValueOfInputIdx(idx))}idx+=1});this.cachedInputs=null};CustomCommandBlockMorph.prototype.refreshPrototype=function(){var hat,protoSpec,frags=[],myself=this,words,newFrag,i=0;if(!this.isPrototype){return null}hat=this.parentThatIsA(PrototypeHatBlockMorph);this.parts().forEach(part=>{if(!part.fragment.isDeleted){if(part.fragment.type){frags.push(part.fragment)}else{words=myself.definition.parseSpec(part.fragment.labelString);words.forEach(word=>{newFrag=part.fragment.copy();newFrag.labelString=word;frags.push(newFrag)})}}});protoSpec=this.specFromFragments()||this.blockSpec;if(this instanceof CustomCommandBlockMorph&&(hat.type==="reporter"||hat.type==="predicate")){myself=new CustomReporterBlockMorph(this.definition,hat.type==="predicate",true);hat.replaceInput(this,myself)}else if(this instanceof CustomReporterBlockMorph){if(hat.type==="command"){myself=new CustomCommandBlockMorph(this.definition,true);hat.replaceInput(this,myself)}else{this.isPredicate=hat.type==="predicate";this.fixLayout();this.rerender()}}myself.setCategory(hat.blockCategory||"other");hat.fixBlockColor();myself.setSpec(protoSpec);myself.parts().forEach(part=>{if(!(part instanceof BlockLabelPlaceHolderMorph)){if(frags[i]){part.fragment=frags[i]}i+=1}});this.refreshPrototypeSlotTypes();hat.fixLayout()};CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes=function(){this.parts().forEach(part=>{if(part instanceof BlockInputFragmentMorph){part.template().instantiationSpec=part.contents();part.setContents(part.fragment.defTemplateSpecFragment())}});this.fixBlockColor(null,true)};CustomCommandBlockMorph.prototype.inputFragmentNames=function(){var ans=[];this.parts().forEach(part=>{if(!part.fragment.isDeleted&&part.fragment.type){ans.push(part.fragment.labelString)}});return ans};CustomCommandBlockMorph.prototype.upvarFragmentNames=function(){var ans=[];this.parts().forEach(part=>{if(!part.fragment.isDeleted&&part.fragment.type==="%upvar"){ans.push(part.fragment.labelString)}});return ans};CustomCommandBlockMorph.prototype.upvarFragmentName=function(idx){return this.upvarFragmentNames()[idx]||"↑"};CustomCommandBlockMorph.prototype.specFromFragments=function(){var ans="";this.parts().forEach(part=>{if(!part.fragment.isDeleted){ans=ans+part.fragment.defSpecFragment()+" "}});return ans.trim()};CustomCommandBlockMorph.prototype.blockSpecFromFragments=function(){var ans="";this.parts().forEach(part=>{if(!part.fragment.isDeleted){ans=ans+part.fragment.blockSpecFragment()+" "}});return ans.trim()};CustomCommandBlockMorph.prototype.declarationsFromFragments=function(){var ans=new Map;this.parts().forEach(part=>{if(part instanceof BlockInputFragmentMorph){ans.set(part.fragment.labelString,[part.fragment.type,part.fragment.defaultValue,part.fragment.options,part.fragment.isReadOnly])}});return ans};CustomCommandBlockMorph.prototype.parseSpec=function(spec){if(!this.isPrototype){return CustomCommandBlockMorph.uber.parseSpec.call(this,spec)}return CustomBlockDefinition.prototype.parseSpec(spec)};CustomCommandBlockMorph.prototype.mouseClickLeft=function(){if(!this.isPrototype){return CustomCommandBlockMorph.uber.mouseClickLeft.call(this)}this.edit()};CustomCommandBlockMorph.prototype.edit=function(){var def=this.definition,editor,block,hat,rcvr;if(this.isPrototype){block=this.definition.blockInstance();block.addShadow();hat=this.parentThatIsA(PrototypeHatBlockMorph);new BlockDialogMorph(null,definition=>{if(definition){hat.blockCategory=definition.category;hat.type=definition.type;this.refreshPrototype()}},this).openForChange("Change block",hat.blockCategory,hat.type,this.world(),block.doWithAlpha(1,()=>block.fullImage()),this.isInUse())}else{rcvr=this.scriptTarget();if(!this.isGlobal){if(contains(Object.keys(rcvr.inheritedBlocks()),this.blockSpec)){this.duplicateBlockDefinition();return}def=rcvr.getMethod(this.semanticSpec)}editor=new BlockEditorMorph(def,rcvr);editor.popUp();editor.changed()}};CustomCommandBlockMorph.prototype.labelPart=function(spec){if(!this.isPrototype){return CustomCommandBlockMorph.uber.labelPart.call(this,spec)}if(spec[0]==="%"&&spec.length>1){return new BlockInputFragmentMorph(spec.replace(/%/g,""))}return new BlockLabelFragmentMorph(spec,CustomCommandBlockMorph.uber.labelPart.call(this,spec))};CustomCommandBlockMorph.prototype.placeHolder=function(){var part;part=new BlockLabelPlaceHolderMorph;part.fontSize=this.fontSize*1.4;part.color=new Color(45,45,45);part.fixLayout();return part};CustomCommandBlockMorph.prototype.attachTargets=function(){if(this.isPrototype){return[]}return CustomCommandBlockMorph.uber.attachTargets.call(this)};CustomCommandBlockMorph.prototype.isInUse=function(){var def=this.definition,rcvr=this.scriptTarget(),ide=rcvr.parentThatIsA(IDE_Morph);if(def.isGlobal&&ide){return ide.sprites.asArray().concat([ide.stage]).some((any,idx)=>any.usesBlockInstance(def,false,idx))}return rcvr.allDependentInvocationsOf(this.blockSpec).length>0};CustomCommandBlockMorph.prototype.userMenu=function(){var hat=this.parentThatIsA(PrototypeHatBlockMorph),rcvr=this.scriptTarget(),myself=this,dlg,menu;function addOption(label,toggle,test,onHint,offHint){menu.addItem([test?new SymbolMorph("checkedBox",MorphicPreferences.menuFontSize*.75):new SymbolMorph("rectangle",MorphicPreferences.menuFontSize*.75),localize(label)],toggle,test?onHint:offHint)}function monitor(vName){var stage=rcvr.parentThatIsA(StageMorph),varFrame=myself.variables;menu.addItem(vName+"...",function(){var watcher=detect(stage.children,function(morph){return morph instanceof WatcherMorph&&morph.target===varFrame&&morph.getter===vName}),others;if(watcher!==null){watcher.show();watcher.fixLayout();return}watcher=new WatcherMorph(vName+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,varFrame,vName);watcher.setPosition(stage.position().add(10));others=stage.watchers(watcher.left());if(others.length>0){watcher.setTop(others[others.length-1].bottom())}stage.add(watcher);watcher.fixLayout()})}if(this.isPrototype){menu=new MenuMorph(this);menu.addItem("script pic...",function(){var ide=this.world().children[0],top=this.topBlock(),xml=ide.blocksLibraryXML([top.definition].concat(top.definition.collectDependencies([],[],top.scriptTarget())),null,true);ide.saveFileAs(embedMetadataPNG(top.scriptPic(),xml),"image/png",(ide.getProjectName()||localize("untitled"))+" "+localize("script pic"))},"save a picture\nof this script");menu.addItem("translations...",function(){hat.parentThatIsA(BlockEditorMorph).editTranslations()});if(this.isGlobal){if(hat.inputs().length<2){menu.addItem("block variables...",function(){hat.enableBlockVars()})}else{menu.addItem("remove block variables...",function(){hat.enableBlockVars(false)})}}addOption("in palette",()=>hat.isHelper=!hat.isHelper,!hat.isHelper,"uncheck to\nhide in palette","check to\nshow in palette");menu.addItem("export...",()=>hat.exportBlockDefinition(),"including dependencies")}else{menu=this.constructor.uber.userMenu.call(this);dlg=this.parentThatIsA(DialogBoxMorph);if(dlg&&!(dlg instanceof BlockEditorMorph)){return menu}if(!menu){menu=new MenuMorph(this)}else{menu.addLine()}if(this.isTemplate){if(this.isGlobal){menu.addItem("delete block definition...","deleteBlockDefinition")}else{if(contains(Object.keys(rcvr.inheritedBlocks()),this.blockSpec)){addOption("inherited",function(){var ide=myself.parentThatIsA(IDE_Morph);rcvr.customBlocks.push(rcvr.getMethod(myself.blockSpec).copyAndBindTo(rcvr));if(ide){ide.flushPaletteCache();ide.refreshPalette()}},true,"uncheck to\ndisinherit",null)}else if(rcvr.exemplar&&rcvr.exemplar.getMethod(this.blockSpec)){addOption("inherited","deleteBlockDefinition",false,null,localize("check to inherit\nfrom")+" "+rcvr.exemplar.name)}else{menu.addItem("delete block definition...","deleteBlockDefinition")}}menu.addItem("duplicate block definition...","duplicateBlockDefinition");menu.addItem("export block definition...","exportBlockDefinition","including dependencies")}else{if(this.isGlobal||contains(Object.keys(rcvr.ownBlocks()),this.blockSpec)){menu.addItem("delete block definition...","deleteBlockDefinition")}}this.variables.names().forEach(vName=>monitor(vName))}menu.addItem("edit...","edit");return menu};CustomCommandBlockMorph.prototype.exportBlockDefinition=function(){var rcvr=this.scriptTarget(),ide=rcvr.parentThatIsA(IDE_Morph),def=this.isGlobal||this instanceof PrototypeHatBlockMorph?this.definition:rcvr.getMethod(this.blockSpec);new BlockExportDialogMorph(ide.serializer,[def].concat(def.collectDependencies([],[],rcvr)),ide).popUp(this.world())};CustomCommandBlockMorph.prototype.duplicateBlockDefinition=function(){var rcvr=this.scriptTarget(),ide=this.parentThatIsA(IDE_Morph),def=this.isGlobal?this.definition:rcvr.getMethod(this.blockSpec),dup=def.copyAndBindTo(rcvr),spec=dup.spec,exp=dup.body?dup.body.expression:null,count=1;function rebindRecursiveCalls(topBlock){topBlock.forAllChildren(morph=>{if(morph.definition===def){morph.definition=dup;morph.refresh()}})}if(this.isGlobal){ide.stage.globalBlocks.push(dup)}else{rcvr.customBlocks.push(dup)}while(rcvr.doubleDefinitionsFor(dup).length>0){count+=1;dup.spec=spec+" ("+count+")"}dup.scripts.forEach(script=>rebindRecursiveCalls(script));if(exp instanceof BlockMorph){rebindRecursiveCalls(exp)}ide.flushPaletteCache();ide.refreshPalette();ide.recordUnsavedChanges();new BlockEditorMorph(dup,rcvr).popUp()};CustomCommandBlockMorph.prototype.deleteBlockDefinition=function(){var idx,stage,ide,method,block,rcvr=this.scriptTarget();if(this.isPrototype){return null}method=this.isGlobal?this.definition:rcvr.getLocalMethod(this.blockSpec);block=method.blockInstance();new DialogBoxMorph(this,()=>{rcvr.deleteAllBlockInstances(method);if(method.isGlobal){stage=rcvr.parentThatIsA(StageMorph);idx=stage.globalBlocks.indexOf(method);if(idx!==-1){stage.globalBlocks.splice(idx,1)}}else{idx=rcvr.customBlocks.indexOf(method);if(idx!==-1){rcvr.customBlocks.splice(idx,1)}method=rcvr.getMethod(this.blockSpec);if(method){rcvr.allDependentInvocationsOf(this.blockSpec).forEach(block=>block.refresh(method))}}ide=rcvr.parentThatIsA(IDE_Morph);if(ide){ide.flushPaletteCache();ide.categories.refreshEmpty();ide.refreshPalette();ide.recordUnsavedChanges()}},this).askYesNo("Delete Custom Block",localize("block deletion dialog text"),this.world(),block.doWithAlpha(1,()=>{block.addShadow();return block.fullImage()}))};CustomCommandBlockMorph.prototype.relabel=function(alternatives){var menu=new MenuMorph(this),oldInputs=this.inputs().map(each=>each.fullCopy());alternatives.forEach(def=>{var block=def.blockInstance();block.restoreInputs(oldInputs);block.fixBlockColor(null,true);block.addShadow(new Point(3,3));menu.addItem(block.doWithAlpha(1,()=>block.fullImage()),()=>{this.definition=def;this.isGlobal=def.isGlobal;this.refresh();this.scriptTarget().parentThatIsA(IDE_Morph).recordUnsavedChanges()})});menu.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))};CustomCommandBlockMorph.prototype.alternatives=function(){var rcvr=this.scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),allDefs=rcvr.customBlocks.concat(stage.globalBlocks),type=this instanceof CommandBlockMorph?"command":this.isPredicate?"predicate":"reporter";return allDefs.filter(each=>each!==this.definition&&each.type===type)};CustomReporterBlockMorph.prototype=new ReporterBlockMorph;CustomReporterBlockMorph.prototype.constructor=CustomReporterBlockMorph;CustomReporterBlockMorph.uber=ReporterBlockMorph.prototype;CustomReporterBlockMorph.prototype.isCustomBlock=true;function CustomReporterBlockMorph(definition,isPredicate,isProto){this.init(definition,isPredicate,isProto)}CustomReporterBlockMorph.prototype.init=function(definition,isPredicate,isProto){this.definition=definition;this.semanticSpec="";this.isGlobal=definition?definition.isGlobal:false;this.isPrototype=isProto||false;CustomReporterBlockMorph.uber.init.call(this,isPredicate,true);if(isProto){this.isTemplate=true}this.category=definition.category;this.storedTranslations=null;this.variables=new VariableFrame;this.initializeVariables();this.selector="evaluateCustomBlock";if(definition){this.refresh()}};CustomReporterBlockMorph.prototype.initializeVariables=CustomCommandBlockMorph.prototype.initializeVariables;CustomReporterBlockMorph.prototype.reactToTemplateCopy=CustomCommandBlockMorph.prototype.reactToTemplateCopy;CustomReporterBlockMorph.prototype.refresh=function(aDefinition){var def=aDefinition||this.definition;CustomCommandBlockMorph.prototype.refresh.call(this,aDefinition,true);if(!this.isPrototype){this.isPredicate=def.type==="predicate"}if(this.parent instanceof SyntaxElementMorph){this.parent.cachedInputs=null}this.fixLayout()};CustomReporterBlockMorph.prototype.mouseClickLeft=function(){if(!this.isPrototype){return CustomReporterBlockMorph.uber.mouseClickLeft.call(this)}this.edit()};CustomReporterBlockMorph.prototype.placeHolder=CustomCommandBlockMorph.prototype.placeHolder;CustomReporterBlockMorph.prototype.parseSpec=CustomCommandBlockMorph.prototype.parseSpec;CustomReporterBlockMorph.prototype.edit=CustomCommandBlockMorph.prototype.edit;CustomReporterBlockMorph.prototype.labelPart=CustomCommandBlockMorph.prototype.labelPart;CustomReporterBlockMorph.prototype.upvarFragmentNames=CustomCommandBlockMorph.prototype.upvarFragmentNames;CustomReporterBlockMorph.prototype.upvarFragmentName=CustomCommandBlockMorph.prototype.upvarFragmentName;CustomReporterBlockMorph.prototype.inputFragmentNames=CustomCommandBlockMorph.prototype.inputFragmentNames;CustomReporterBlockMorph.prototype.specFromFragments=CustomCommandBlockMorph.prototype.specFromFragments;CustomReporterBlockMorph.prototype.blockSpecFromFragments=CustomCommandBlockMorph.prototype.blockSpecFromFragments;CustomReporterBlockMorph.prototype.declarationsFromFragments=CustomCommandBlockMorph.prototype.declarationsFromFragments;CustomReporterBlockMorph.prototype.refreshPrototype=CustomCommandBlockMorph.prototype.refreshPrototype;CustomReporterBlockMorph.prototype.refreshPrototypeSlotTypes=CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes;CustomReporterBlockMorph.prototype.restoreInputs=CustomCommandBlockMorph.prototype.restoreInputs;CustomReporterBlockMorph.prototype.refreshDefaults=CustomCommandBlockMorph.prototype.refreshDefaults;CustomReporterBlockMorph.prototype.isInUse=CustomCommandBlockMorph.prototype.isInUse;CustomReporterBlockMorph.prototype.userMenu=CustomCommandBlockMorph.prototype.userMenu;CustomReporterBlockMorph.prototype.duplicateBlockDefinition=CustomCommandBlockMorph.prototype.duplicateBlockDefinition;CustomReporterBlockMorph.prototype.deleteBlockDefinition=CustomCommandBlockMorph.prototype.deleteBlockDefinition;CustomReporterBlockMorph.prototype.exportBlockDefinition=CustomCommandBlockMorph.prototype.exportBlockDefinition;CustomReporterBlockMorph.prototype.bubbleHelp=CustomCommandBlockMorph.prototype.bubbleHelp;CustomReporterBlockMorph.prototype.popUpbubbleHelp=CustomCommandBlockMorph.prototype.popUpbubbleHelp;CustomReporterBlockMorph.prototype.relabel=CustomCommandBlockMorph.prototype.relabel;CustomReporterBlockMorph.prototype.alternatives=CustomCommandBlockMorph.prototype.alternatives;JaggedBlockMorph.prototype=new ReporterBlockMorph;JaggedBlockMorph.prototype.constructor=JaggedBlockMorph;JaggedBlockMorph.uber=ReporterBlockMorph.prototype;function JaggedBlockMorph(spec){this.init(spec)}JaggedBlockMorph.prototype.init=function(spec){JaggedBlockMorph.uber.init.call(this);if(spec){this.setSpec(spec)}if(spec==="%cs"||spec==="%ca"){this.minWidth=25;this.fixLayout()}};JaggedBlockMorph.prototype.outlinePath=function(ctx,inset){var w=this.width(),h,jags,delta,pos=this.position(),y=0,i;ctx.moveTo(inset,inset);ctx.lineTo(w-inset,inset);this.cSlots().forEach(slot=>{slot.outlinePath(ctx,inset,slot.position().subtract(pos));y+=slot.height()});h=this.height()-y-inset;jags=Math.round(h/this.jag);delta=h/jags;for(i=0;i<jags;i+=1){y+=delta/2;ctx.lineTo(w-this.jag/2-inset,y);y+=delta/2;ctx.lineTo(w-inset,y)}h=this.height()-inset;jags=Math.round(h/this.jag);delta=h/jags;ctx.lineTo(inset,h-inset);y=h;for(i=0;i<jags;i+=1){y-=delta/2;ctx.lineTo(this.jag/2+inset,y);y-=delta/2;ctx.lineTo(inset,y)}};JaggedBlockMorph.prototype.drawEdges=function(ctx){var w=this.width(),h=this.height(),jags=Math.round(h/this.jag),delta=h/jags,shift=this.edge/2,gradient,i,y;ctx.lineWidth=this.edge;ctx.lineJoin="round";ctx.lineCap="round";gradient=ctx.createLinearGradient(0,0,0,this.edge);gradient.addColorStop(0,this.cachedClrBright);gradient.addColorStop(1,this.cachedClr);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(shift,shift);ctx.lineTo(w-shift,shift);ctx.stroke();if(!this.cSlots().length){y=0;for(i=0;i<jags;i+=1){ctx.strokeStyle=this.cachedClrDark;ctx.beginPath();ctx.moveTo(w-shift,y);y+=delta/2;ctx.lineTo(w-this.jag/2-shift,y);ctx.stroke();y+=delta/2}}gradient=ctx.createLinearGradient(0,h-this.edge,0,h);gradient.addColorStop(0,this.cachedClr);gradient.addColorStop(1,this.cachedClrDark);ctx.strokeStyle=gradient;ctx.beginPath();ctx.moveTo(w-shift,h-shift);ctx.lineTo(shift,h-shift);ctx.stroke();y=h;for(i=0;i<jags;i+=1){ctx.strokeStyle=this.cachedClrBright;ctx.beginPath();ctx.moveTo(shift,y);y-=delta/2;ctx.lineTo(this.jag/2+shift,y);ctx.stroke();y-=delta/2}};BlockDialogMorph.prototype=new DialogBoxMorph;BlockDialogMorph.prototype.constructor=BlockDialogMorph;BlockDialogMorph.uber=DialogBoxMorph.prototype;function BlockDialogMorph(target,action,environment){this.init(target,action,environment)}BlockDialogMorph.prototype.init=function(target,action,environment){this.blockType="command";this.category="other";this.isGlobal=true;this.types=null;this.categories=null;BlockDialogMorph.uber.init.call(this,target,action,environment);this.key="makeABlock";this.types=new AlignmentMorph("row",this.padding);this.add(this.types);this.scopes=new AlignmentMorph("row",this.padding);this.add(this.scopes);this.categories=new BoxMorph;this.categories.color=SpriteMorph.prototype.paletteColor.lighter(8);this.categories.borderColor=this.categories.color.lighter(40);this.categories.buttons=[];this.categories.refresh=function(){this.buttons.forEach(cat=>{cat.refresh();if(cat.state){cat.scrollIntoView()}})};this.createCategoryButtons();this.fixCategoriesLayout();this.add(this.categories);this.createTypeButtons();this.createScopeButtons();this.fixLayout()};BlockDialogMorph.prototype.openForChange=function(title,category,type,world,pic,preventTypeChange){var clr=SpriteMorph.prototype.blockColorFor(category);this.key="changeABlock";this.category=category;this.blockType=type;this.categories.refresh();this.types.children.forEach(each=>{each.setColor(clr);each.refresh()});this.labelString=title;this.createLabel();if(pic){this.setPicture(pic)}this.addButton("ok","OK");this.addButton("cancel","Cancel");if(preventTypeChange){this.types.destroy();this.types=null}this.scopes.destroy();this.scopes=null;this.fixLayout();this.rerender();this.popUp(world)};BlockDialogMorph.prototype.createCategoryButtons=function(){SpriteMorph.prototype.categories.forEach(cat=>this.addCategoryButton(cat));Array.from(SpriteMorph.prototype.customCategories.keys()).sort().forEach(name=>this.addCustomCategoryButton(name,SpriteMorph.prototype.customCategories.get(name)))};BlockDialogMorph.prototype.addCategoryButton=function(category){var labelWidth=75,colors=[IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor.darker(MorphicPreferences.isFlat?5:50),SpriteMorph.prototype.blockColorFor(category)],button;button=new ToggleButtonMorph(colors,this,()=>{this.category=category;this.categories.refresh();if(this.types){this.types.children.forEach(each=>each.setColor(colors[2]))}this.edit()},category[0].toUpperCase().concat(category.slice(1)),()=>this.category===category,null,null,labelWidth,true);button.corner=8;button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.labelColor=IDE_Morph.prototype.buttonLabelColor;if(MorphicPreferences.isFlat){button.labelPressColor=WHITE}button.contrast=this.buttonContrast;button.fixLayout();button.refresh();this.categories.add(button);this.categories.buttons.push(button);return button};BlockDialogMorph.prototype.addCustomCategoryButton=function(category,clr){var labelWidth=172,colors=[IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor.darker(MorphicPreferences.isFlat?5:50),clr],button;button=new ToggleButtonMorph(colors,this,()=>{this.category=category;this.categories.refresh();if(this.types){this.types.children.forEach(each=>each.setColor(colors[2]))}this.edit()},category,()=>this.category===category,null,null,labelWidth,true);button.corner=8;button.padding=0;button.labelShadowOffset=new Point(-1,-1);button.labelShadowColor=colors[1];button.labelColor=IDE_Morph.prototype.buttonLabelColor;if(MorphicPreferences.isFlat){button.labelPressColor=WHITE}button.contrast=this.buttonContrast;button.fixLayout();button.refresh();this.categories.add(button);this.categories.buttons.push(button);return button};BlockDialogMorph.prototype.fixCategoriesLayout=function(){var buttonWidth=this.categories.children[0].width(),buttonHeight=this.categories.children[0].height(),more=SpriteMorph.prototype.customCategories.size,xPadding=15,yPadding=2,border=10,l=this.categories.left(),t=this.categories.top(),scroller,row,col,i;this.categories.setWidth(3*xPadding+2*buttonWidth);this.categories.children.forEach((button,i)=>{if(i<8){row=i%4;col=Math.ceil((i+1)/4)}else if(i<10){row=4;col=3-(10-i)}else{row=i-5;col=1}button.setPosition(new Point(l+(col*xPadding+(col-1)*buttonWidth),t+((row+1)*yPadding+row*buttonHeight+border)+(i>9?border/2:0)))});if(MorphicPreferences.isFlat){this.categories.corner=0;this.categories.border=0;this.categories.edge=0}if(more>6){scroller=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor.lighter());scroller.setColor(this.categories.color);scroller.acceptsDrops=false;scroller.contents.acceptsDrops=false;scroller.setPosition(new Point(this.categories.left()+this.categories.border,this.categories.children[10].top()));scroller.setWidth(this.categories.width()-this.categories.border*2);scroller.setHeight(buttonHeight*6+yPadding*5);for(i=0;i<more;i+=1){scroller.addContents(this.categories.children[10])}this.categories.add(scroller);this.categories.setHeight((5+1)*yPadding+5*buttonHeight+6*(yPadding+buttonHeight)+border+2+2*border)}else{this.categories.setHeight((5+1)*yPadding+5*buttonHeight+(more?more*(yPadding+buttonHeight)+border/2:0)+2*border)}};BlockDialogMorph.prototype.createTypeButtons=function(){var block,clr=SpriteMorph.prototype.blockColorFor(this.category);block=new CommandBlockMorph;block.setColor(clr);block.setSpec(localize("Command"));this.addBlockTypeButton(()=>this.setType("command"),block,()=>this.blockType==="command");block=new ReporterBlockMorph;block.setColor(clr);block.setSpec(localize("Reporter"));this.addBlockTypeButton(()=>this.setType("reporter"),block,()=>this.blockType==="reporter");block=new ReporterBlockMorph(true);block.setColor(clr);block.setSpec(localize("Predicate"));this.addBlockTypeButton(()=>this.setType("predicate"),block,()=>this.blockType==="predicate")};BlockDialogMorph.prototype.addBlockTypeButton=function(action,element,query){var button=new ToggleElementMorph(this,action,element,query,null,null,"rebuild");button.refresh();button.fixLayout();this.types.add(button);return button};BlockDialogMorph.prototype.addTypeButton=function(action,label,query){var button=new ToggleMorph("radiobutton",this,action,label,query);button.edge=this.buttonEdge/2;button.outline=this.buttonOutline/2;button.outlineColor=this.buttonOutlineColor;button.outlineGradient=this.buttonOutlineGradient;button.contrast=this.buttonContrast;button.fixLayout();this.types.add(button);return button};BlockDialogMorph.prototype.setType=function(blockType){this.blockType=blockType||this.blockType;this.types.children.forEach(c=>c.refresh());this.edit()};BlockDialogMorph.prototype.createScopeButtons=function(){this.addScopeButton(()=>this.setScope("global"),"for all sprites",()=>this.isGlobal);this.addScopeButton(()=>this.setScope("local"),"for this sprite only",()=>!this.isGlobal)};BlockDialogMorph.prototype.addScopeButton=function(action,label,query){var button=new ToggleMorph("radiobutton",this,action,label,query);button.edge=this.buttonEdge/2;button.outline=this.buttonOutline/2;button.outlineColor=this.buttonOutlineColor;button.outlineGradient=this.buttonOutlineGradient;button.contrast=this.buttonContrast;button.fixLayout();this.scopes.add(button);return button};BlockDialogMorph.prototype.setScope=function(varType){this.isGlobal=varType==="global";this.scopes.children.forEach(c=>c.refresh());this.edit()};BlockDialogMorph.prototype.getInput=function(){var spec,def,body;if(this.body instanceof InputFieldMorph){spec=this.normalizeSpaces(this.body.getValue())}def=new CustomBlockDefinition(spec);def.type=this.blockType;def.category=this.category;def.isGlobal=this.isGlobal;if(def.type==="reporter"||def.type==="predicate"){body=Process.prototype.reify.call(null,SpriteMorph.prototype.blockForSelector("doReport"),new List,true);body.outerContext=null;def.body=body}return def};BlockDialogMorph.prototype.fixLayout=function(){var th=fontHeight(this.titleFontSize)+this.titlePadding*2;if(this.body){this.body.setPosition(this.position().add(new Point(this.padding,th+this.padding)));this.bounds.setWidth(this.body.width()+this.padding*2);this.bounds.setHeight(this.body.height()+this.padding*2+th);if(this.categories){this.categories.setCenter(this.body.center());this.categories.setTop(this.body.top());this.body.setTop(this.categories.bottom()+this.padding);this.bounds.setHeight(this.height()+this.categories.height()+this.padding)}}else if(this.head){if(this.types){this.types.fixLayout();this.bounds.setWidth(Math.max(this.types.width(),this.head.width())+this.padding*2)}else{this.bounds.setWidth(Math.max(this.categories.width(),this.head.width())+this.padding*2)}this.head.setCenter(this.center());this.head.setTop(th+this.padding);this.bounds.setHeight(this.head.height()+this.padding*2+th);if(this.categories){this.categories.setCenter(this.center());this.categories.setTop(this.head.bottom()+this.padding);this.bounds.setHeight(this.height()+this.categories.height()+this.padding)}}if(this.label){this.label.setCenter(this.center());this.label.setTop(this.top()+(th-this.label.height())/2)}if(this.types){this.types.fixLayout();this.bounds.setHeight(this.height()+this.types.height()+this.padding);this.bounds.setWidth(Math.max(this.width(),this.types.width()+this.padding*2));this.types.setCenter(this.center());if(this.body){this.types.setTop(this.body.bottom()+this.padding)}else if(this.categories){this.types.setTop(this.categories.bottom()+this.padding)}}if(this.scopes){this.scopes.fixLayout();this.bounds.setHeight(this.height()+this.scopes.height()+this.padding/3);this.bounds.setWidth(Math.max(this.width(),this.scopes.width()+this.padding*2));this.scopes.setCenter(this.center());if(this.types){this.scopes.setTop(this.types.bottom()+this.padding/3)}}if(this.buttons&&this.buttons.children.length>0){this.buttons.fixLayout();this.bounds.setHeight(this.height()+this.buttons.height()+this.padding);this.buttons.setCenter(this.center());this.buttons.setBottom(this.bottom()-this.padding)}this.removeShadow();this.addShadow()};BlockDialogMorph.prototype.accept=function(){if(this.body instanceof InputFieldMorph&&this.normalizeSpaces(this.body.getValue())===""){this.edit()}else{BlockDialogMorph.uber.accept.call(this)}};BlockEditorMorph.prototype=new DialogBoxMorph;BlockEditorMorph.prototype.constructor=BlockEditorMorph;BlockEditorMorph.uber=DialogBoxMorph.prototype;function BlockEditorMorph(definition,target){this.init(definition,target)}BlockEditorMorph.prototype.init=function(definition,target){var scripts,proto,scriptsFrame,block,comment,isLive=Process.prototype.enableLiveCoding||Process.prototype.enableSingleStepping;this.definition=definition;this.translations=definition.translationsAsText();this.handle=null;BlockEditorMorph.uber.init.call(this,target,()=>this.updateDefinition(),target);this.key="editBlock"+definition.spec;this.labelString=this.definition.isGlobal?"Block Editor":"Method Editor";this.createLabel();scripts=new ScriptsMorph;scripts.rejectsHats=true;scripts.isDraggable=false;scripts.color=IDE_Morph.prototype.groupColor;scripts.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture;scripts.cleanUpMargin=10;proto=new PrototypeHatBlockMorph(this.definition);proto.setPosition(scripts.position().add(10));if(definition.comment!==null){comment=definition.comment.fullCopy();proto.comment=comment;comment.block=proto}if(definition.body!==null){proto.nextBlock(isLive?definition.body.expression:definition.body.expression.fullCopy())}scripts.add(proto);this.definition.scripts.forEach(element=>{block=element.fullCopy();block.setPosition(scripts.position().add(element.position()));scripts.add(block);if(block instanceof BlockMorph){block.allComments().forEach(comment=>comment.align(block))}});proto.allComments().forEach(comment=>comment.align(proto));scriptsFrame=new ScrollFrameMorph(scripts);scriptsFrame.padding=10;scriptsFrame.growth=50;scriptsFrame.isDraggable=false;scriptsFrame.acceptsDrops=false;scriptsFrame.contents.acceptsDrops=true;scripts.scrollFrame=scriptsFrame;scripts.updateToolbar();this.addBody(scriptsFrame);this.addButton("ok","OK");if(!isLive){this.addButton("updateDefinition","Apply");this.addButton("cancel","Cancel")}this.setExtent(new Point(375,300));this.fixLayout();scripts.fixMultiArgs();block=proto.parts()[0];block.forceNormalColoring();proto.fixBlockColor(null,true)};BlockEditorMorph.prototype.popUp=function(){var world=this.target.world();if(world){BlockEditorMorph.uber.popUp.call(this,world);this.setInitialDimensions();this.handle=new HandleMorph(this,280,220,this.corner,this.corner);world.keyboardFocus=null}};BlockEditorMorph.prototype.justDropped=function(){nop()};BlockEditorMorph.prototype.accept=function(origin){if(origin instanceof CursorMorph){return}if(this.action){if(typeof this.target==="function"){if(typeof this.action==="function"){this.target.call(this.environment,this.action.call())}else{this.target.call(this.environment,this.action)}}else{if(typeof this.action==="function"){this.action.call(this.target,this.getInput())}else{this.target[this.action](this.getInput())}}}this.close()};BlockEditorMorph.prototype.cancel=function(origin){if(origin instanceof CursorMorph){return}this.close()};BlockEditorMorph.prototype.close=function(){var doubles,block;if(this.definition.isGlobal){block=detect(this.body.contents.allChildren(),morph=>morph.isCustomBlock&&!morph.isGlobal);if(block){block=block.scriptTarget().getMethod(block.semanticSpec).blockInstance();block.addShadow();(new DialogBoxMorph).inform("Local Block(s) in Global Definition","This global block definition contains one or more\n"+"local custom blocks which must be removed first.",this.world(),block.doWithAlpha(1,()=>block.fullImage()));return}}doubles=this.target.doubleDefinitionsFor(this.definition);if(doubles.length>0){block=doubles[0].blockInstance();block.addShadow();new DialogBoxMorph(this,"consolidateDoubles",this).askYesNo("Same Named Blocks","Another custom block with this name exists.\n"+"Would you like to replace it?",this.world(),block.doWithAlpha(1,()=>block.fullImage()));return}this.destroy()};BlockEditorMorph.prototype.consolidateDoubles=function(){this.target.replaceDoubleDefinitionsFor(this.definition);this.destroy()};BlockEditorMorph.prototype.refreshAllBlockInstances=function(oldSpec){var def=this.definition,template=this.target.paletteBlockInstance(def);function isMajorTypeChange(oldType){var rep=["reporter","predicate"],type=def.type;return type==="command"&&rep.includes(oldType)||oldType=="command"&&rep.includes(type)}if(def.isGlobal){this.target.allBlockInstances(def).reverse().forEach(block=>block.refresh());this.target.parentThatIsA(StageMorph).allContextsUsing(def).forEach(context=>{if(context.expression.isCustomBlock&&context.expression.isUnattached()&&isMajorTypeChange(context.expression.type())){context.expression=def.blockInstance()}context.changed()})}else{this.target.allDependentInvocationsOf(oldSpec).reverse().forEach(block=>block.refresh(def));this.target.parentThatIsA(StageMorph).allContextsInvoking(def.blockSpec(),this.target).forEach(context=>{if(context.expression.isCustomBlock&&context.expression.isUnattached()&&isMajorTypeChange(context.expression.type())){context.expression=def.blockInstance()}context.changed()})}if(template){template.refreshDefaults()}};BlockEditorMorph.prototype.updateDefinition=function(){var head,ide,oldSpec=this.definition.blockSpec(),pos=this.body.contents.position(),count=1,spec,element;this.definition.receiver=this.target;this.definition.spec=this.prototypeSpec();this.definition.declarations=this.prototypeSlots();this.definition.variableNames=this.variableNames();this.definition.scripts=[];this.definition.updateTranslations(this.translations);this.definition.cachedTranslation=null;this.definition.editorDimensions=this.bounds.copy();this.definition.cachedIsRecursive=null;this.body.contents.children.forEach(morph=>{if(morph instanceof PrototypeHatBlockMorph){head=morph}else if(morph instanceof BlockMorph||morph instanceof CommentMorph&&!morph.block){element=morph.fullCopy();element.parent=null;element.setPosition(morph.position().subtract(pos));this.definition.scripts.push(element)}});if(head){if(this.definition.category!==head.blockCategory){this.target.shadowAttribute("scripts")}this.definition.category=head.blockCategory;this.definition.type=head.type;this.definition.isHelper=head.isHelper;if(head.comment){this.definition.comment=head.comment.fullCopy();this.definition.comment.block=true}else{this.definition.comment=null}}this.definition.body=this.context(head);spec=this.definition.spec;while(this.target.doubleDefinitionsFor(this.definition).length>0){count+=1;this.definition.spec=spec+" ("+count+")"}this.refreshAllBlockInstances(oldSpec);ide=this.target.parentThatIsA(IDE_Morph);ide.flushPaletteCache();ide.categories.refreshEmpty();ide.refreshPalette();ide.recordUnsavedChanges()};BlockEditorMorph.prototype.context=function(prototypeHat){var head,topBlock,stackFrame;head=prototypeHat||detect(this.body.contents.children,c=>c instanceof PrototypeHatBlockMorph);topBlock=head.nextBlock();if(topBlock===null){return null}topBlock.allChildren().forEach(c=>{if(c instanceof BlockMorph){c.cachedInputs=null}});stackFrame=Process.prototype.reify.call(null,topBlock,new List(this.definition.inputNames()),true);stackFrame.outerContext=null;return stackFrame};BlockEditorMorph.prototype.prototypeSpec=function(){return detect(this.body.contents.children,c=>c instanceof PrototypeHatBlockMorph).parts()[0].specFromFragments()};BlockEditorMorph.prototype.prototypeSlots=function(){return detect(this.body.contents.children,c=>c instanceof PrototypeHatBlockMorph).parts()[0].declarationsFromFragments()};BlockEditorMorph.prototype.variableNames=function(){return detect(this.body.contents.children,c=>c instanceof PrototypeHatBlockMorph).variableNames()};BlockEditorMorph.prototype.isHelper=function(){return detect(this.body.contents.children,c=>c instanceof PrototypeHatBlockMorph).isHelper};BlockEditorMorph.prototype.editTranslations=function(){var block=this.definition.blockInstance();block.addShadow(new Point(3,3));new DialogBoxMorph(this,text=>this.translations=text,this).promptCode("Custom Block Translations",this.translations,this.world(),block.doWithAlpha(1,()=>block.fullImage()),this.definition.abstractBlockSpec()+"\n\n"+localize("Enter one translation per line. "+'use colon (":") as lang/spec delimiter\n'+'and underscore ("_") as placeholder for an input, '+"e.g.:\n\nen:say _ for _ secs"))};BlockEditorMorph.prototype.setInitialDimensions=function(){var world=this.world(),mex=world.extent().subtract(new Point(this.padding,this.padding)),th=fontHeight(this.titleFontSize)+this.titlePadding*2,bh=this.buttons.height();if(this.definition.editorDimensions){this.setPosition(this.definition.editorDimensions.origin);this.setExtent(this.definition.editorDimensions.extent().min(mex));this.keepWithin(world);return}this.setExtent(this.body.contents.extent().add(new Point(this.padding,this.padding+th+bh)).min(mex));this.setCenter(this.world().center())};BlockEditorMorph.prototype.fixLayout=function(){var th=fontHeight(this.titleFontSize)+this.titlePadding*2;if(this.buttons&&this.buttons.children.length>0){this.buttons.fixLayout()}if(this.body){this.body.setPosition(this.position().add(new Point(this.padding,th+this.padding)));this.body.setExtent(new Point(this.width()-this.padding*2,this.height()-this.padding*3-th-this.buttons.height()))}if(this.label){this.label.setCenter(this.center());this.label.setTop(this.top()+(th-this.label.height())/2)}if(this.buttons&&this.buttons.children.length>0){this.buttons.setCenter(this.center());this.buttons.setBottom(this.bottom()-this.padding)}this.removeShadow();this.addShadow()};PrototypeHatBlockMorph.prototype=new HatBlockMorph;PrototypeHatBlockMorph.prototype.constructor=PrototypeHatBlockMorph;PrototypeHatBlockMorph.uber=HatBlockMorph.prototype;function PrototypeHatBlockMorph(definition){this.init(definition)}PrototypeHatBlockMorph.prototype.init=function(definition){var proto=definition.prototypeInstance(),vars;this.definition=definition;this.blockCategory=definition?definition.category:null;this.type=definition?definition.type:null;this.isHelper=definition?definition.isHelper:false;HatBlockMorph.uber.init.call(this);this.color=SpriteMorph.prototype.blockColor.control;this.category="control";this.add(proto);if(definition.variableNames.length){vars=this.labelPart("%blockVars");this.add(this.labelPart("%br"));this.add(vars);definition.variableNames.forEach(name=>vars.addInput(name))}proto.refreshPrototypeSlotTypes();this.fixLayout();proto.fixBlockColor(this,true)};PrototypeHatBlockMorph.prototype.mouseClickLeft=function(){if(this.world().currentKey===16){return this.focus()}this.parts()[0].mouseClickLeft()};PrototypeHatBlockMorph.prototype.userMenu=function(){return this.parts()[0].userMenu()};PrototypeHatBlockMorph.prototype.exportBlockDefinition=CustomCommandBlockMorph.prototype.exportBlockDefinition;PrototypeHatBlockMorph.prototype.fixBlockColor=function(nearestBlock,isForced){var nearest=this.parts()[0]||nearestBlock;if(!this.zebraContrast&&!isForced){return}if(!this.zebraContrast&&isForced){return this.forceNormalColoring()}if(nearest.category===this.category){if(nearest.color.eq(this.color)){this.alternateBlockColor()}}else if(this.category&&!this.color.eq(SpriteMorph.prototype.blockColorFor(this.category))){this.alternateBlockColor()}if(isForced){this.fixChildrensBlockColor(true)}};PrototypeHatBlockMorph.prototype.variableNames=function(choice){var parts=this.parts();if(parts.length<3){return[]}return parts[2].evaluate()};PrototypeHatBlockMorph.prototype.enableBlockVars=function(choice){var prot=this.parts()[0];if(choice===false){this.setSpec("%s",true)}else{this.setSpec("%s %br %blockVars",true)}this.replaceInput(this.parts()[0],prot);this.spec=null};function BlockLabelFragment(labelString){this.labelString=labelString||"";this.type="%s";this.defaultValue="";this.options="";this.isReadOnly=false;this.isDeleted=false}BlockLabelFragment.prototype.defSpecFragment=function(){var pref=this.type?"%'":"";return this.isDeleted?"":pref+this.labelString+(this.type?"'":"")};BlockLabelFragment.prototype.defTemplateSpecFragment=function(){var suff="";if(!this.type){return this.defSpecFragment()}if(this.isUpvar()){suff=" ↑"}else if(this.isMultipleInput()){suff="..."}else if(this.type==="%cs"||this.type==="%ca"){suff=" λ"}else if(this.type==="%b"){suff=" ?"}else if(this.type==="%l"){suff=" ︙"}else if(this.type==="%obj"){suff=" %turtleOutline"}else if(contains(["%cmdRing","%repRing","%predRing","%anyUE","%boolUE"],this.type)){suff=" λ"}else if(this.defaultValue){if(this.type==="%n"){suff=" # = "+this.defaultValue.toString()}else if(contains(["%mlt","%code"],this.type)){suff=" ¶ = "+this.defaultValue.toString()}else{suff=" = "+this.defaultValue.toString()}}else if(this.type==="%n"){suff=" #"}else if(contains(["%mlt","%code"],this.type)){suff=" ¶"}return this.labelString+suff};BlockLabelFragment.prototype.blockSpecFragment=function(){return this.isDeleted?"":this.type||this.labelString};BlockLabelFragment.prototype.copy=function(){var ans=new BlockLabelFragment(this.labelString);ans.type=this.type;ans.defaultValue=this.defaultValue;ans.options=this.options;ans.isReadOnly=this.isReadOnly;return ans};BlockLabelFragment.prototype.hasOptions=function(){return this.options!==""&&!this.hasSpecialMenu()};BlockLabelFragment.prototype.hasSpecialMenu=function(){return contains(["§_messagesMenu","§_messagesReceivedMenu","§_objectsMenu","§_costumesMenu","§_soundsMenu","§_getVarNamesDict","§_pianoKeyboardMenu","§_directionDialMenu"],this.options)};BlockLabelFragment.prototype.hasExtensionMenu=function(){return contains(Array.from(SnapExtensions.menus.keys()).map(str=>"§_ext_"+str),this.options)};BlockLabelFragment.prototype.isSingleInput=function(){return!this.isMultipleInput()&&this.type!=="%upvar"};BlockLabelFragment.prototype.isMultipleInput=function(){if(!this.type){return false}return this.type.indexOf("%mult")>-1};BlockLabelFragment.prototype.isUpvar=function(){if(!this.type){return false}return this.type==="%upvar"};BlockLabelFragment.prototype.setToSingleInput=function(){if(!this.type){return null}if(this.type==="%upvar"){this.type="%s"}else{this.type=this.singleInputType()}};BlockLabelFragment.prototype.setToMultipleInput=function(){if(!this.type){return null}if(this.type==="%upvar"){this.type="%s"}else if(this.type==="%ca"){this.type="%cs"}this.type="%mult".concat(this.singleInputType())};BlockLabelFragment.prototype.setToUpvar=function(){if(!this.type){return null}this.type="%upvar"};BlockLabelFragment.prototype.singleInputType=function(){if(!this.type){return null}if(this.isMultipleInput()){return this.type.substr(5)}return this.type};BlockLabelFragment.prototype.setSingleInputType=function(type){if(!this.type||!this.isMultipleInput()){this.type=type}else{this.type="%mult".concat(type)}};BlockLabelFragmentMorph.prototype=new Morph;BlockLabelFragmentMorph.prototype.constructor=BlockLabelFragmentMorph;BlockLabelFragmentMorph.uber=Morph.prototype;function BlockLabelFragmentMorph(spec,shape){this.init(spec,shape)}BlockLabelFragmentMorph.prototype.init=function(spec,shape){BlockLabelFragmentMorph.uber.init.call(this);this.spec=spec;this.fragment=new BlockLabelFragment(spec);this.fragment.type=null;this.sO=null;this.shape=shape;this.add(shape)};BlockLabelFragmentMorph.prototype.fixLayout=function(){this.bounds=this.shape.bounds};BlockLabelFragmentMorph.prototype.render=nop;BlockLabelFragmentMorph.prototype.mouseEnter=function(){this.sO=this.shape.shadowOffset;this.shape.shadowOffset=this.sO.neg();this.shape.fixLayout();this.shape.rerender();this.fixLayout()};BlockLabelFragmentMorph.prototype.mouseLeave=function(){this.shape.shadowOffset=this.sO;this.shape.fixLayout();this.shape.rerender();this.fixLayout()};BlockLabelFragmentMorph.prototype.mouseClickLeft=function(){var frag=this.fragment.copy(),isPlaceHolder=this instanceof BlockLabelPlaceHolderMorph,isOnlyElement=this.parent.parseSpec(this.parent.blockSpec).length<2;new InputSlotDialogMorph(frag,null,()=>this.updateBlockLabel(frag),this.spec,this.parent.definition.category).open(this instanceof BlockLabelFragmentMorph?"Edit label fragment":isPlaceHolder?"Create input name":"Edit input name",frag.labelString,this.world(),null,isPlaceHolder||isOnlyElement)};BlockLabelFragmentMorph.prototype.updateBlockLabel=function(newFragment){var prot=this.parentThatIsA(BlockMorph);this.fragment=newFragment;if(prot){prot.refreshPrototype()}};BlockLabelFragmentMorph.prototype.userMenu=function(){var symbolColor=new Color(100,100,130),menu=new MenuMorph(string=>{var tuple=this.spec.split("-");this.changed();tuple[0]="$"+string;this.text=tuple.join("-");this.fragment.labelString=this.spec;this.parent.parent.changed();this.fixLayout();this.parent.parent.fixLayout();this.parent.parent.changed()},null,this,this.fontSize);SymbolMorph.prototype.names.forEach(name=>menu.addItem([new SymbolMorph(name,menu.fontSize,symbolColor),localize(name)],name));menu.addLine();menu.addItem("⏎ "+localize("new line"),"nl");return menu};BlockLabelPlaceHolderMorph.prototype=new Morph;BlockLabelPlaceHolderMorph.prototype.constructor=BlockLabelPlaceHolderMorph;BlockLabelPlaceHolderMorph.uber=Morph.prototype;BlockLabelPlaceHolderMorph.prototype.plainLabel=true;function BlockLabelPlaceHolderMorph(){this.init()}BlockLabelPlaceHolderMorph.prototype.init=function(){this.fragment=new BlockLabelFragment("");this.fragment.type="%s";this.fragment.isDeleted=true;this.isHighlighted=false;BlockLabelFragmentMorph.uber.init.call(this)};BlockLabelPlaceHolderMorph.prototype.fixLayout=function(){var h=fontHeight(SyntaxElementMorph.prototype.fontSize*1.4);this.bounds.setHeight(h);this.bounds.setWidth(this.isHighlighted||!this.plainLabel?h/2:SyntaxElementMorph.prototype.scale);if(this.parent){if(this.parent.fixLayout){this.parent.fixLayout()}if(this.parent.parent instanceof PrototypeHatBlockMorph){this.parent.parent.fixLayout()}}};BlockLabelPlaceHolderMorph.prototype.render=function(ctx){var cx=this.width()/2,cy=this.height()/2,r=Math.min(cx,cy),unit=SyntaxElementMorph.prototype.scale;if(this.isHighlighted){ctx.fillStyle=this.color.toString();ctx.beginPath();ctx.arc(cx,cy,r,radians(0),radians(360),false);ctx.closePath();ctx.fill()}if(!this.plainLabel||this.isHighlighted){ctx.strokeStyle=this.isHighlighted?"white":this.color.toString();ctx.lineWidth=unit;ctx.beginPath();ctx.moveTo(unit,cy);ctx.lineTo(r*2-unit,cy);ctx.moveTo(r,cy-r+unit);ctx.lineTo(r,cy+r-unit);ctx.stroke()}};BlockLabelPlaceHolderMorph.prototype.mouseEnter=function(){var hat=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=true;if(this.plainLabel&&hat){hat.changed();this.fixLayout();hat.changed()}else{this.fixLayout();this.rerender()}};BlockLabelPlaceHolderMorph.prototype.mouseLeave=function(){var hat=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=false;if(this.plainLabel&&hat){hat.changed();this.fixLayout();hat.changed()}else{this.fixLayout();this.rerender()}};BlockLabelPlaceHolderMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft;BlockLabelPlaceHolderMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel;BlockInputFragmentMorph.prototype=new TemplateSlotMorph;BlockInputFragmentMorph.prototype.constructor=BlockInputFragmentMorph;BlockInputFragmentMorph.uber=TemplateSlotMorph.prototype;function BlockInputFragmentMorph(text){this.init(text)}BlockInputFragmentMorph.prototype.init=function(text){this.fragment=new BlockLabelFragment(text);this.fragment.type="%s";BlockInputFragmentMorph.uber.init.call(this,text)};BlockInputFragmentMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft;BlockInputFragmentMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel;InputSlotDialogMorph.prototype=new DialogBoxMorph;InputSlotDialogMorph.prototype.constructor=InputSlotDialogMorph;InputSlotDialogMorph.uber=DialogBoxMorph.prototype;InputSlotDialogMorph.prototype.isLaunchingExpanded=true;function InputSlotDialogMorph(fragment,target,action,environment,category){this.init(fragment,target,action,environment,category)}InputSlotDialogMorph.prototype.init=function(fragment,target,action,environment,category){var scale=SyntaxElementMorph.prototype.scale,fh=fontHeight(10)/1.2*scale;this.fragment=fragment||new BlockLabelFragment;this.textfield=null;this.types=null;this.slots=null;this.isExpanded=false;this.category=category||"other";this.noDelete=false;BlockDialogMorph.uber.init.call(this,target,action,environment);this.types=new AlignmentMorph("row",this.padding);this.types.respectHiddens=true;this.add(this.types);this.slots=new BoxMorph;this.slots.color=new Color(55,55,55);this.slots.borderColor=this.slots.color.lighter(50);this.slots.setExtent(new Point((fh+10)*24,(fh+10*scale)*10.4));this.add(this.slots);this.createSlotTypeButtons();this.fixSlotsLayout();this.addSlotsMenu();this.createTypeButtons();this.fixLayout()};InputSlotDialogMorph.prototype.createTypeButtons=function(){var block,arrow,clr=SpriteMorph.prototype.blockColorFor(this.category);block=new JaggedBlockMorph(localize("Title text"));block.setColor(clr);this.addBlockTypeButton(()=>this.setType(null),block,()=>this.fragment.type===null);block=new JaggedBlockMorph("%inputName");block.setColor(clr);this.addBlockTypeButton(()=>this.setType("%s"),block,()=>this.fragment.type!==null);arrow=new ArrowMorph("right",PushButtonMorph.prototype.fontSize+4,2);arrow.noticesTransparentClick=true;this.types.add(arrow);this.types.fixLayout();arrow.refresh=()=>{if(this.fragment.type===null){this.isExpanded=false;arrow.hide()}else{arrow.show();if(this.isExpanded){arrow.direction="down"}else{arrow.direction="right"}arrow.fixLayout();arrow.rerender()}};arrow.mouseClickLeft=()=>{if(arrow.isVisible){this.isExpanded=!this.isExpanded;this.types.children.forEach(c=>c.refresh());this.changed();this.fixLayout();this.rerender();this.edit()}};arrow.refresh()};InputSlotDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton;InputSlotDialogMorph.prototype.addBlockTypeButton=BlockDialogMorph.prototype.addBlockTypeButton;InputSlotDialogMorph.prototype.setType=function(fragmentType){this.textfield.choices=fragmentType?null:this.symbolMenu;this.textfield.fixLayout();this.fragment.type=fragmentType||null;this.types.children.forEach(c=>c.refresh());this.slots.children.forEach(c=>c.refresh());if(isNil(fragmentType)){this.isExpanded=false;this.types.children.forEach(c=>c.refresh());this.changed();this.fixLayout();this.rerender()}this.edit()};InputSlotDialogMorph.prototype.getInput=function(){var lbl;if(this.body instanceof InputFieldMorph){lbl=this.normalizeSpaces(this.body.getValue())}if(lbl){this.fragment.labelString=lbl;if(contains(["%b","%boolUE"],this.fragment.type)){this.fragment.defaultValue=this.slots.defaultSwitch.evaluate()}else{this.fragment.defaultValue=this.slots.defaultInputField.getValue()}return lbl}this.fragment.isDeleted=true;return null};InputSlotDialogMorph.prototype.fixLayout=function(){var maxWidth,left=this.left(),th=fontHeight(this.titleFontSize)+this.titlePadding*2;if(!this.isExpanded){if(this.slots){this.slots.hide()}return BlockDialogMorph.prototype.fixLayout.call(this)}this.slots.show();maxWidth=this.slots.width();this.body.setPosition(this.position().add(new Point(this.padding+(maxWidth-this.body.width())/2,th+this.padding)));this.label.setLeft(left+this.padding+(maxWidth-this.label.width())/2);this.label.setTop(this.top()+(th-this.label.height())/2);this.types.fixLayout();this.types.setTop(this.body.bottom()+this.padding);this.types.setLeft(left+this.padding+(maxWidth-this.types.width())/2);this.slots.setPosition(new Point(this.left()+this.padding,this.types.bottom()+this.padding));this.slots.children.forEach(c=>c.refresh());this.buttons.fixLayout();this.buttons.setTop(this.slots.bottom()+this.padding);this.buttons.setLeft(left+this.padding+(maxWidth-this.buttons.width())/2);this.bounds.setHeight(this.buttons.bottom()-this.top()+this.padding);this.bounds.setWidth(this.slots.right()-this.left()+this.padding);this.removeShadow();this.addShadow()};InputSlotDialogMorph.prototype.open=function(title,defaultString,world,pic,noDeleteButton){var txt=new InputFieldMorph(defaultString);if(!this.fragment.type){txt.choices=this.symbolMenu}this.isExpanded=this.isLaunchingExpanded;txt.setWidth(250);this.labelString=title;this.createLabel();if(pic){this.setPicture(pic)}this.addBody(txt);this.textfield=txt;this.addButton("ok","OK");if(!noDeleteButton){this.addButton("deleteFragment","Delete")}else{this.noDelete=true}this.addButton("cancel","Cancel");this.fixLayout();this.popUp(world);this.add(this.types);this.changed()};InputSlotDialogMorph.prototype.symbolMenu=function(){var symbols=[],symbolColor=new Color(100,100,130);SymbolMorph.prototype.names.forEach(sym=>symbols.push([[new SymbolMorph(sym,this.fontSize,symbolColor),localize(sym)],"$"+sym]));symbols.push(["⏎ "+localize("new line"),"$nl"]);return symbols};InputSlotDialogMorph.prototype.deleteFragment=function(){this.fragment.isDeleted=true;this.accept()};InputSlotDialogMorph.prototype.createSlotTypeButtons=function(){var defLabel,defInput,defSwitch,loopArrow,settingsButton;this.addSlotTypeButton("Object","%obj");this.addSlotTypeButton("Text","%txt");this.addSlotTypeButton("List","%l");this.addSlotTypeButton("Number","%n");this.addSlotTypeButton("Any type","%s");this.addSlotTypeButton("Boolean (T/F)","%b");this.addSlotTypeButton("Command\n(inline)","%cmdRing");this.addSlotTypeButton("Reporter","%repRing");this.addSlotTypeButton("Predicate","%predRing");this.addSlotTypeButton("Command\n(C-shape)",["%cs","%ca"]);this.addSlotTypeButton("Any\n(unevaluated)","%anyUE");this.addSlotTypeButton("Boolean\n(unevaluated)","%boolUE");this.slots.radioButtonSingle=this.addSlotArityButton(()=>this.setSlotArity("single"),"Single input.",()=>this.fragment.isSingleInput());this.addSlotArityButton(()=>this.setSlotArity("multiple"),"Multiple inputs (value is list of inputs)",()=>this.fragment.isMultipleInput());this.addSlotArityButton(()=>this.setSlotArity("upvar"),"Upvar - make internal variable visible to caller",()=>this.fragment.isUpvar());defLabel=new StringMorph(localize("Default Value:"));defLabel.fontSize=this.slots.radioButtonSingle.fontSize;defLabel.setColor(WHITE);defLabel.refresh=()=>{if(this.isExpanded&&contains(["%s","%n","%txt","%anyUE","%b","%boolUE","%mlt","%code"],this.fragment.type)){defLabel.show()}else{defLabel.hide()}};this.slots.defaultInputLabel=defLabel;this.slots.add(defLabel);defInput=new InputFieldMorph(this.fragment.defaultValue);defInput.contents().fontSize=defLabel.fontSize;defInput.contrast=90;defInput.setWidth(50);defInput.refresh=()=>{if(this.isExpanded&&contains(["%s","%n","%txt","%anyUE","%mlt","%code"],this.fragment.type)){defInput.show();if(this.fragment.type==="%n"){defInput.setIsNumeric(true)}else{defInput.setIsNumeric(false)}}else{defInput.hide()}};this.slots.defaultInputField=defInput;this.slots.add(defInput);defSwitch=new BooleanSlotMorph(this.fragment.defaultValue);defSwitch.refresh=()=>{if(this.isExpanded&&contains(["%b","%boolUE"],this.fragment.type)){defSwitch.show()}else{defSwitch.hide()}};this.slots.defaultSwitch=defSwitch;this.slots.add(defSwitch);loopArrow=new ToggleMorph("checkbox",this,()=>{if(this.fragment.type==="%ca"){this.setType("%cs")}else{this.setType("%ca")}},null,()=>this.fragment.type==="%ca",null,null,new SymbolMorph("loop",this.fontSize*.7,WHITE).getImage(),null);loopArrow.refresh=()=>{ToggleMorph.prototype.refresh.call(loopArrow);if(this.isExpanded&&contains(["%cs","%ca"],this.fragment.type)){loopArrow.show()}else{loopArrow.hide()}};this.slots.loopArrow=loopArrow;this.slots.add(loopArrow);settingsButton=new PushButtonMorph(this.slots,()=>this.slots.userMenu().popUpAtHand(this.world()),new SymbolMorph("gearPartial",this.fontSize*1.5));settingsButton.padding=0;settingsButton.fixLayout();settingsButton.refresh=nop;this.slots.settingsButton=settingsButton;this.slots.add(settingsButton)};InputSlotDialogMorph.prototype.setSlotType=function(type){this.fragment.setSingleInputType(type);this.slots.children.forEach(c=>c.refresh());this.edit()};InputSlotDialogMorph.prototype.setSlotArity=function(arity){if(arity==="single"){this.fragment.setToSingleInput()}else if(arity==="multiple"){this.fragment.setToMultipleInput()}else if(arity==="upvar"){this.fragment.setToUpvar()}this.slots.children.forEach(c=>c.refresh());this.edit()};InputSlotDialogMorph.prototype.setSlotOptions=function(text){this.fragment.options=text};InputSlotDialogMorph.prototype.addSlotTypeButton=function(label,spec){var action=()=>{this.setSlotType(spec instanceof Array?spec[0]:spec)},query,element=new JaggedBlockMorph(spec instanceof Array?spec[0]:spec),button;query=()=>{return spec instanceof Array?contains(spec,this.fragment.singleInputType()):this.fragment.singleInputType()===spec};element.setCategory(this.category);element.rebuild();button=new ToggleMorph("radiobutton",this,action,label,query,null,null,element.doWithAlpha(1,()=>element.fullImage()),"rebuild");button.edge=this.buttonEdge/2;button.outline=this.buttonOutline/2;button.outlineColor=this.buttonOutlineColor;button.outlineGradient=this.buttonOutlineGradient;button.fixLayout();button.label.isBold=false;button.label.setColor(WHITE);this.slots.add(button);return button};InputSlotDialogMorph.prototype.addSlotArityButton=function(action,label,query){var button=new ToggleMorph("radiobutton",this,action,label,query,null,null);button.edge=this.buttonEdge/2;button.outline=this.buttonOutline/2;button.outlineColor=this.buttonOutlineColor;button.outlineGradient=this.buttonOutlineGradient;button.fixLayout();button.label.setColor(WHITE);this.slots.add(button);return button};InputSlotDialogMorph.prototype.fixSlotsLayout=function(){var slots=this.slots,scale=SyntaxElementMorph.prototype.scale,xPadding=10*scale,ypadding=14*scale,bh=(fontHeight(10)/1.2+15)*scale,ah=(fontHeight(10)/1.2+10)*scale,size=12,cols=[slots.left()+xPadding,slots.left()+slots.width()/3,slots.left()+slots.width()*2/3],rows=[slots.top()+ypadding,slots.top()+ypadding+bh,slots.top()+ypadding+bh*2,slots.top()+ypadding+bh*3,slots.top()+ypadding+bh*4,slots.top()+ypadding+bh*5,slots.top()+ypadding+bh*5+ah,slots.top()+ypadding+bh*5+ah*2],idx,row=-1,col;for(idx=0;idx<size;idx+=1){col=idx%3;if(idx%3===0){row+=1}slots.children[idx].setPosition(new Point(cols[col],rows[row]))}col=0;row=5;for(idx=size;idx<size+3;idx+=1){slots.children[idx].setPosition(new Point(cols[col],rows[row+idx-size]))}this.slots.defaultInputLabel.setPosition(this.slots.radioButtonSingle.label.topRight().add(new Point(5,0)));this.slots.defaultInputField.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultInputField.width()/2+this.slots.defaultInputLabel.width()/2+5,0)));this.slots.defaultSwitch.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultSwitch.width()/2+this.slots.defaultInputLabel.width()/2+5,0)));this.slots.loopArrow.setPosition(this.slots.defaultInputLabel.position());this.slots.settingsButton.setPosition(this.slots.bottomRight().subtract(this.slots.settingsButton.extent().add(this.padding+this.slots.border)));this.slots.changed()};InputSlotDialogMorph.prototype.addSlotsMenu=function(){this.slots.userMenu=()=>{if(contains(["%s","%n","%txt","%anyUE","%mlt","%code"],this.fragment.type)){var menu=new MenuMorph(this),on="☑ ",off="☐ ";menu.addItem((this.fragment.hasOptions()?on:off)+localize("options")+"...","editSlotOptions");menu.addItem((this.fragment.isReadOnly?on:off)+localize("read-only"),()=>this.fragment.isReadOnly=!this.fragment.isReadOnly);menu.addLine();menu.addMenu((this.fragment.hasSpecialMenu()?on:off)+localize("menu"),this.specialOptionsMenu());menu.addMenu((contains(["%mlt","%code"],this.fragment.type)?on:off)+localize("special"),this.specialSlotsMenu());if(this.world().currentKey===16){menu.addMenu((this.fragment.hasExtensionMenu()?on:off)+localize("extension"),this.extensionOptionsMenu())}return menu}return this.specialSlotsMenu()}};InputSlotDialogMorph.prototype.editSlotOptions=function(){new DialogBoxMorph(this,options=>this.fragment.options=options.trim(),this).promptCode("Input Slot Options",this.fragment.options,this.world(),null,localize("Enter one option per line.\n"+'Optionally use "=" as key/value delimiter '+"and {} for submenus. "+"e.g.\n   the answer=42"))};InputSlotDialogMorph.prototype.specialSlotsMenu=function(){var menu=new MenuMorph(this.setSlotType,null,this),myself=this,on="⚫ ",off="⚪ ";function addSpecialSlotType(label,spec){menu.addItem((myself.fragment.type===spec?on:off)+localize(label),spec)}addSpecialSlotType("multi-line","%mlt");addSpecialSlotType("code","%code");return menu};InputSlotDialogMorph.prototype.specialOptionsMenu=function(){var menu=new MenuMorph(this.setSlotOptions,null,this),myself=this,on="⚫ ",off="⚪ ";function addSpecialOptions(label,selector){menu.addItem((myself.fragment.options===selector?on:off)+localize(label),selector)}addSpecialOptions("(none)","");addSpecialOptions("messages","§_messagesMenu");addSpecialOptions("objects","§_objectsMenu");addSpecialOptions("costumes","§_costumesMenu");addSpecialOptions("sounds","§_soundsMenu");addSpecialOptions("variables","§_getVarNamesDict");addSpecialOptions("piano keyboard","§_pianoKeyboardMenu");addSpecialOptions("360° dial","§_directionDialMenu");return menu};InputSlotDialogMorph.prototype.extensionOptionsMenu=function(){var menu=new MenuMorph(this.setSlotOptions,null,this),myself=this,selectors=Array.from(SnapExtensions.menus.keys()),on="⚫ ",off="⚪ ";function addSpecialOptions(label,selector){menu.addItem((myself.fragment.options===selector?on:off)+localize(label),selector)}selectors.forEach(sel=>{addSpecialOptions(sel.slice(4),"§_ext_"+sel)});return menu};InputSlotDialogMorph.prototype.hide=function(){this.isVisible=false;this.changed()};InputSlotDialogMorph.prototype.show=function(){this.isVisible=true;this.changed()};VariableDialogMorph.prototype=new DialogBoxMorph;VariableDialogMorph.prototype.constructor=VariableDialogMorph;VariableDialogMorph.uber=DialogBoxMorph.prototype;function VariableDialogMorph(target,action,environment){this.init(target,action,environment)}VariableDialogMorph.prototype.init=function(target,action,environment){this.types=null;this.isGlobal=true;BlockDialogMorph.uber.init.call(this,target,action,environment);this.types=new AlignmentMorph("row",this.padding);this.add(this.types);this.createTypeButtons()};VariableDialogMorph.prototype.createTypeButtons=function(){this.addTypeButton(()=>this.setType("global"),"for all sprites",()=>this.isGlobal);this.addTypeButton(()=>this.setType("local"),"for this sprite only",()=>!this.isGlobal)};VariableDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton;VariableDialogMorph.prototype.setType=function(varType){this.isGlobal=varType==="global";this.types.children.forEach(c=>c.refresh());this.edit()};VariableDialogMorph.prototype.getInput=function(){var name=this.normalizeSpaces(this.body.getValue());return name?[name,this.isGlobal]:null};VariableDialogMorph.prototype.fixLayout=function(){var th=fontHeight(this.titleFontSize)+this.titlePadding*2;if(this.body){this.body.setPosition(this.position().add(new Point(this.padding,th+this.padding)));this.bounds.setWidth(this.body.width()+this.padding*2);this.bounds.setHeight(this.body.height()+this.padding*2+th)}if(this.label){this.label.setCenter(this.center());this.label.setTop(this.top()+(th-this.label.height())/2)}if(this.types){this.types.fixLayout();this.bounds.setHeight(this.height()+this.types.height()+this.padding);this.bounds.setWidth(Math.max(this.width(),this.types.width()+this.padding*2));this.types.setCenter(this.center());if(this.body){this.types.setTop(this.body.bottom()+this.padding)}else if(this.categories){this.types.setTop(this.categories.bottom()+this.padding)}}if(this.buttons&&this.buttons.children.length>0){this.buttons.fixLayout();this.bounds.setHeight(this.height()+this.buttons.height()+this.padding);this.buttons.setCenter(this.center());this.buttons.setBottom(this.bottom()-this.padding)}this.removeShadow();this.addShadow()};BlockExportDialogMorph.prototype=new DialogBoxMorph;BlockExportDialogMorph.prototype.constructor=BlockExportDialogMorph;BlockExportDialogMorph.uber=DialogBoxMorph.prototype;BlockExportDialogMorph.prototype.key="blockExport";function BlockExportDialogMorph(serializer,blocks,target){this.init(serializer,blocks,target)}BlockExportDialogMorph.prototype.init=function(serializer,blocks,target){this.serializer=serializer;this.blocks=blocks.slice(0);this.handle=null;BlockExportDialogMorph.uber.init.call(this,target,()=>this.exportBlocks(),null);this.labelString="Export blocks";this.createLabel();this.buildContents()};BlockExportDialogMorph.prototype.buildContents=function(){var palette,x,y,block,checkBox,lastCat,padding=4;palette=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor);palette.color=SpriteMorph.prototype.paletteColor;palette.padding=padding;palette.isDraggable=false;palette.acceptsDrops=false;palette.contents.acceptsDrops=false;x=palette.left()+padding;y=palette.top()+padding;SpriteMorph.prototype.allCategories().forEach(category=>{this.blocks.forEach(definition=>{if(definition.category===category){if(lastCat&&category!==lastCat){y+=padding}lastCat=category;block=definition.templateInstance();block.isToggleLabel=true;checkBox=new ToggleMorph("checkbox",this,()=>{var idx=this.blocks.indexOf(definition);if(idx>-1){this.blocks.splice(idx,1)}else{this.blocks.push(definition)}this.collectDependencies()},null,()=>contains(this.blocks,definition),null,null,this.target?block:block.fullImage());checkBox.setPosition(new Point(x,y+(checkBox.top()-checkBox.toggleElement.top())));palette.addContents(checkBox);y+=checkBox.fullBounds().height()+padding}})});palette.scrollX(padding);palette.scrollY(padding);this.addBody(palette);this.addButton("ok","OK");this.addButton("cancel","Cancel");this.setExtent(new Point(220,300));this.fixLayout()};BlockExportDialogMorph.prototype.popUp=function(wrrld){var world=wrrld||this.target.world();if(world){BlockExportDialogMorph.uber.popUp.call(this,world);this.handle=new HandleMorph(this,200,220,this.corner,this.corner)}};BlockExportDialogMorph.prototype.userMenu=function(){var menu=new MenuMorph(this,"select");menu.addItem("all","selectAll");menu.addItem("none","selectNone");return menu};BlockExportDialogMorph.prototype.selectAll=function(){this.body.contents.children.forEach(checkBox=>{if(!checkBox.state){checkBox.trigger()}})};BlockExportDialogMorph.prototype.selectNone=function(){this.blocks=[];this.body.contents.children.forEach(checkBox=>{checkBox.refresh()})};BlockExportDialogMorph.prototype.collectDependencies=function(){this.dependencies().forEach(def=>{if(!contains(this.blocks,def)){this.blocks.push(def)}});this.body.contents.children.forEach(checkBox=>{checkBox.refresh()})};BlockExportDialogMorph.prototype.dependencies=function(){var deps=[];this.blocks.forEach(def=>def.collectDependencies([],deps,def.receiver));return deps};BlockExportDialogMorph.prototype.exportBlocks=function(){var ide=this.world().children[0];if(this.blocks.length){ide.saveXMLAs(ide.blocksLibraryXML(this.blocks,null,true),(ide.getProjectName()||localize("untitled"))+" "+localize("blocks"))}else{(new DialogBoxMorph).inform("Export blocks","no blocks were selected",this.world())}};BlockExportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;BlockImportDialogMorph.prototype=new DialogBoxMorph;BlockImportDialogMorph.prototype.constructor=BlockImportDialogMorph;BlockImportDialogMorph.uber=DialogBoxMorph.prototype;BlockImportDialogMorph.prototype.key="blockImport";function BlockImportDialogMorph(blocks,target,name){this.init(blocks,target,name)}BlockImportDialogMorph.prototype.init=function(blocks,target,name){this.blocks=blocks.slice(0);this.handle=null;BlockExportDialogMorph.uber.init.call(this,target,()=>this.importBlocks(name),null);this.labelString=localize("Import blocks")+(name?": ":"")+name||"";this.createLabel();this.buildContents()};BlockImportDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents;BlockImportDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp;BlockImportDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu;BlockImportDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll;BlockImportDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone;BlockImportDialogMorph.prototype.importBlocks=function(name){var ide=this.target.parentThatIsA(IDE_Morph);if(!ide){return}if(this.blocks.length>0){this.blocks.forEach(def=>{if(def.isGlobal){def.receiver=ide.stage;ide.stage.globalBlocks.push(def);ide.stage.replaceDoubleDefinitionsFor(def)}else{def.receiver=ide.currentSprite;ide.currentSprite.customBlocks.push(def);ide.currentSprite.replaceDoubleDefinitionsFor(def)}});ide.flushPaletteCache();ide.categories.refreshEmpty();ide.refreshPalette();ide.showMessage("Imported Blocks Module"+(name?": "+name:"")+".",2)}else{(new DialogBoxMorph).inform("Import blocks","no blocks were selected",this.world())}};BlockImportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;BlockRemovalDialogMorph.prototype=new DialogBoxMorph;BlockRemovalDialogMorph.prototype.constructor=BlockImportDialogMorph;BlockRemovalDialogMorph.uber=DialogBoxMorph.prototype;BlockRemovalDialogMorph.prototype.key="blockRemove";function BlockRemovalDialogMorph(blocks,target){this.init(blocks,target)}BlockRemovalDialogMorph.prototype.init=function(blocks,target){this.blocks=blocks.slice(0);this.handle=null;BlockExportDialogMorph.uber.init.call(this,target,()=>this.removeBlocks(),null);this.labelString=localize("Remove unused blocks")+(name?": ":"")+name||"";this.createLabel();this.buildContents()};BlockRemovalDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents;BlockRemovalDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp;BlockRemovalDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu;BlockRemovalDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll;BlockRemovalDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone;BlockRemovalDialogMorph.prototype.removeBlocks=function(){var ide=this.target;if(!ide){return}if(this.blocks.length>0){this.blocks.forEach(def=>{var idx=ide.stage.globalBlocks.indexOf(def);if(idx!==-1){ide.stage.globalBlocks.splice(idx,1)}});ide.flushPaletteCache();ide.categories.refreshEmpty();ide.refreshPalette();ide.showMessage(this.blocks.length+" "+localize("unused block(s) removed"),2)}else{(new DialogBoxMorph).inform("Remove unused blocks","no blocks were selected",this.world())}};BlockRemovalDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;BlockVisibilityDialogMorph.prototype=new DialogBoxMorph;BlockVisibilityDialogMorph.prototype.constructor=BlockVisibilityDialogMorph;BlockVisibilityDialogMorph.uber=DialogBoxMorph.prototype;BlockVisibilityDialogMorph.prototype.key="blockVisibility";function BlockVisibilityDialogMorph(target){this.init(target)}BlockVisibilityDialogMorph.prototype.init=function(target){this.blocks=target.allPaletteBlocks();this.selection=this.blocks.filter(each=>target.isHidingBlock(each));this.handle=null;BlockVisibilityDialogMorph.uber.init.call(this,target,()=>this.hideBlocks(),null);this.labelString=localize("Hide blocks in palette")+(name?": ":"")+name||"";this.createLabel();this.buildContents()};BlockVisibilityDialogMorph.prototype.buildContents=function(){var palette,x,y,checkBox,lastCat,padding=4;palette=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor);palette.color=SpriteMorph.prototype.paletteColor;palette.padding=padding;palette.isDraggable=false;palette.acceptsDrops=false;palette.contents.acceptsDrops=false;x=palette.left()+padding;y=palette.top()+padding;this.blocks.forEach(block=>{if(lastCat&&block.category!==lastCat){y+=padding}lastCat=block.category;block.isToggleLabel=true;checkBox=new ToggleMorph("checkbox",this,()=>{var idx=this.selection.indexOf(block);if(idx>-1){this.selection.splice(idx,1)}else{this.selection.push(block)}},null,()=>contains(this.selection,block),null,null,block);checkBox.setPosition(new Point(x,y+(checkBox.top()-checkBox.toggleElement.top())));palette.addContents(checkBox);y+=checkBox.fullBounds().height()+padding});palette.scrollX(padding);palette.scrollY(padding);this.addBody(palette);this.addButton("ok","OK");this.addButton("cancel","Cancel");this.setExtent(new Point(220,300));this.fixLayout()};BlockVisibilityDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp;BlockVisibilityDialogMorph.prototype.userMenu=function(){var menu=new MenuMorph(this,"select");menu.addItem("all","selectAll");menu.addItem("none","selectNone");menu.addLine();menu.addItem("unused","selectUnused");return menu};BlockVisibilityDialogMorph.prototype.selectAll=function(){this.selection=this.blocks.slice(0);this.body.contents.children.forEach(checkBox=>{checkBox.refresh()})};BlockVisibilityDialogMorph.prototype.selectNone=function(){this.selection=[];this.body.contents.children.forEach(checkBox=>{checkBox.refresh()})};BlockVisibilityDialogMorph.prototype.selectUnused=function(){var used=this.target.scripts.allChildren().filter(m=>m instanceof BlockMorph),uPrim=[],uCust=[],uVars=[];used.forEach(b=>{if(b.isCustomBlock){uCust.push(b.isGlobal?b.definition:this.target.getMethod(b.semanticSpec))}else if(b.selector==="reportGetVar"){uVars.push(b.blockSpec)}else{uPrim.push(b.selector)}});this.selection=this.blocks.filter(b=>{if(b.isCustomBlock){return!contains(uCust,b.isGlobal?b.definition:this.target.getMethod(b.semanticSpec))}else if(b.selector==="reportGetVar"){return!contains(uVars,b.blockSpec)}else{return!contains(uPrim,b.selector)}});this.body.contents.children.forEach(checkBox=>{checkBox.refresh()})};BlockVisibilityDialogMorph.prototype.hideBlocks=function(){var ide=this.target.parentThatIsA(IDE_Morph);this.blocks.forEach(block=>this.target.changeBlockVisibility(block,contains(this.selection,block),true));if(this.selection.length===0){StageMorph.prototype.hiddenPrimitives=[]}ide.flushBlocksCache();ide.refreshPalette();ide.categories.refreshEmpty();ide.recordUnsavedChanges()};BlockVisibilityDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;</script>
        <script>modules.tables="2022-January-28";var Table;var TableCellMorph;var TableMorph;var TableFrameMorph;function Table(cols,rows){this.colCount=+cols;this.rowCount=+rows;this.colNames=[];this.rowNames=[];this.contents=new Array(+rows);for(var i=0;i<rows;i+=1){this.contents[i]=new Array(+cols)}this.lastChanged=Date.now()}Table.prototype.demo=function(aWorld){var dlg;this.fillWithTestData();dlg=new TableDialogMorph(this);dlg.popUp(aWorld)};Table.prototype.changed=function(){this.lastChanged=Date.now()};Table.prototype.get=function(col,row){if(!col){if(!row){return[this.rowCount]}return this.rowName(row)}else if(!row){return this.colName(col)}if(col>this.colCount||row>this.rowCount){return null}return(this.contents[row-1]||[])[col-1]};Table.prototype.row=function(row){return this.contents[row-1]};Table.prototype.col=function(col){var dta=[],c=col-1,i;for(i=0;i<this.rowCount;i+=1){dta.push(this.contents[i][c])}return dta};Table.prototype.colName=function(col){if(col>this.colCount){return null}var name=this.colNames[col-1];if(name!==undefined){return name}return String.fromCharCode(64+(col%26||26)).repeat(Math.floor((col-1)/26)+1)};Table.prototype.rowName=function(row){if(row>this.rowCount){return null}return this.rowNames[row-1]||row};Table.prototype.rows=function(){return this.rowCount};Table.prototype.cols=function(){return this.colCount};Table.prototype.columnNames=function(){return this.colNames};Table.prototype.set=function(data,col,row){this.contents[row-1][col-1]=data;this.changed()};Table.prototype.setRows=function(rowsArray,colNames,rowNames){this.contents=rowsArray;if(colNames){this.colNames=colNames}if(rowNames){this.rowNames=rowNames}this.changed()};Table.prototype.setCols=function(colsArray,colNames,rowNames){var r,c;for(c=0;c<this.colCount;c+=1){for(r=0;r<this.rowCount;r+=1){this.contents[r][c]=colsArray[c][r]}}if(colNames){this.colNames=colNames}if(rowNames){this.rowNames=rowNames}this.changed()};Table.prototype.setColNames=function(array){this.colNames=array||[];this.changed()};Table.prototype.setRowNames=function(array){this.rowNames=array||[];this.changed()};Table.prototype.setColName=function(col,name){this.colNames[col+1]=name;this.changed()};Table.prototype.setRowName=function(row,name){this.rowNames[row+1]=name;this.changed()};Table.prototype.addRow=function(array,name){if(array){this.contents[this.rowCount]=array}else{this.contents[this.rowCount]=new Array(this.rowCount)}this.rowNames[this.rowCount]=name;this.rowCount+=1;this.changed()};Table.prototype.addCol=function(array,name){var i;if(array){for(i=0;i<this.col;i+=1){this.contents[i][this.colCount]=array[i]}}this.colNames[this.colCount]=name;this.colCount+=1;this.changed()};Table.prototype.toList=function(){return new List(this.contents.map(eachRow=>new List(eachRow)))};Table.prototype.fillWithTestData=function(){var c,r;for(c=1;c<=this.colCount;c+=1){for(r=1;r<=this.rowCount;r+=1){this.set(this.colName(c)+this.rowName(r),c,r)}}};TableCellMorph.prototype=new Morph;TableCellMorph.prototype.constructor=TableCellMorph;TableCellMorph.uber=Morph.prototype;TableCellMorph.prototype.cachedListSymbol=null;TableCellMorph.prototype.listSymbol=function(){if(!this.cachedListSymbol||this.cachedListSymbol.height()!==SyntaxElementMorph.prototype.fontSize){this.cachedListSymbol=new SymbolMorph("list",SyntaxElementMorph.prototype.fontSize,SpriteMorph.prototype.blockColor.lists.darker(50))}return this.cachedListSymbol.getImage()};function TableCellMorph(data,extent,isLabel){this.init(data,extent,isLabel)}TableCellMorph.prototype.init=function(data,extent,isLabel){this.data=data;this.isLabel=isLabel||false;this.labelString=null;TableCellMorph.uber.init.call(this,true);if(extent){this.bounds.setExtent(extent)}this.fixLayout()};TableCellMorph.prototype.setData=function(data,extent){this.data=data;if(extent&&!extent.eq(this.extent())){this.bounds.setExtent(extent)}this.rerender()};TableCellMorph.prototype.getData=function(){return this.data instanceof Array?this.data[0]:this.data};TableCellMorph.prototype.render=function(ctx){var dta=this.labelString||this.dataRepresentation(this.data),fontSize=SyntaxElementMorph.prototype.fontSize,empty=TableMorph.prototype.highContrast?"rgb(220, 220, 220)":"transparent",orphaned="rgb(217, 77, 17)",fontStyle=this.isLabel?this.data instanceof Array?"italic":"":this.shouldBeList()?"bold":"",font=fontStyle+" "+fontSize+"px Helvetica, Arial, sans-serif",background=this.labelString?"rgb(220, 220, 250)":this.isLabel?empty:this.shouldBeList()?orphaned:this.isOvershooting()?"white":isNil(this.data)?empty:"white",foreground=!this.isLabel&&this.shouldBeList()?"white":"black",width=this.width(),height=this.height(),txtWidth,txtHeight,x,y;this.isDraggable=this.data instanceof Context||this.data instanceof Costume||this.data instanceof Sound;ctx.fillStyle=background;if(this.shouldBeList()){BoxMorph.prototype.outlinePath.call(this,ctx,SyntaxElementMorph.prototype.corner+1,0);ctx.fill()}else if(this.isOvershooting()){this.raggedBoxPath(ctx);ctx.fill()}else{ctx.fillRect(0,0,width,height)}if(!dta){return}if(dta instanceof HTMLCanvasElement){x=Math.max((width-dta.width)/2,0);y=Math.max((height-dta.height)/2,0);if(useBlurredShadows){ctx.shadowOffsetX=4;ctx.shadowOffsetY=4;ctx.shadowBlur=4;ctx.shadowColor="lightgray"}ctx.drawImage(dta,x,y)}else{ctx.font=font;ctx.textAlign="left";ctx.textBaseline="bottom";txtWidth=ctx.measureText(dta).width;txtHeight=fontHeight(fontSize);ctx.fillStyle=foreground;x=Math.max((width-txtWidth)/2,0);y=Math.max((height-txtHeight)/2,0);ctx.fillText(dta,x,txtHeight+y)}};TableCellMorph.prototype.dataRepresentation=function(dta){if(dta instanceof Morph){if(isSnapObject(dta)){return dta.thumbnail(new Point(40,40),null,true)}else{return dta.fullImage()}}else if(isString(dta)){return dta.length>100?dta.slice(0,100)+"...":dta}else if(typeof dta==="number"){return dta.toString()}else if(typeof dta==="boolean"){return SpriteMorph.prototype.booleanMorph.call(null,dta).fullImage()}else if(dta instanceof Array){return this.dataRepresentation(dta[0])}else if(dta instanceof Variable){return this.dataRepresentation(dta.value)}else if(dta instanceof HTMLCanvasElement){return dta}else if(dta instanceof Context){return dta.image()}else if(dta instanceof Costume){return dta.thumbnail(new Point(40,40))}else if(dta instanceof Sound){return new SymbolMorph("notes",SyntaxElementMorph.prototype.fontSize).getImage()}else if(dta instanceof List){return this.listSymbol()}else{return dta?dta.toString():dta===0?"0":null}};TableCellMorph.prototype.raggedBoxPath=function(context){var width=this.width(),height=this.height(),x=width*.75,step=height/6,y=0;context.beginPath();context.moveTo(0,0);context.lineTo(width,0);for(y=0;y<height;y+=step*2){context.lineTo(x,y+step);context.lineTo(width,y+step*2)}context.lineTo(width,height);context.lineTo(0,height);context.closePath()};TableCellMorph.prototype.shouldBeList=function(){return this.data instanceof Array};TableCellMorph.prototype.isOvershooting=function(){return this.data instanceof Variable};TableCellMorph.prototype.mouseDoubleClick=function(pos){if(this.data instanceof Table||this.data instanceof List){new TableDialogMorph(this.data).popUp(this.world())}else if(this.data instanceof Array&&this.data[0]instanceof List){new TableDialogMorph(this.data[0]).popUp(this.world())}else{this.escalateEvent("mouseDoubleClick",pos)}};TableCellMorph.prototype.mouseEnter=function(){var tm,x,c;if(this.isLabel){tm=this.parentThatIsA(TableMorph);x=tm.world().hand.left()-tm.left();c=tm.columnAt(x);if(c>0){this.labelString=c;this.rerender()}}};TableCellMorph.prototype.mouseLeave=function(){if(this.isLabel){this.labelString=null;this.rerender()}};TableCellMorph.prototype.selectForEdit=function(){if(this.data instanceof Context){return this.selectContextForEdit()}if(this.data instanceof Costume){return this.selectCostumeForEdit()}if(this.data instanceof Sound){return this.selectSoundForEdit()}};TableCellMorph.prototype.selectContextForEdit=function(){var script=this.data.toBlock(),prepare=script.prepareToBeGrabbed,ide=this.parentThatIsA(IDE_Morph)||this.world().childThatIsA(IDE_Morph);script.prepareToBeGrabbed=function(hand){prepare.call(this,hand);hand.grabOrigin={origin:ide.palette,position:ide.palette.center()};this.prepareToBeGrabbed=prepare};if(ide.isAppMode){return}script.setPosition(this.position());return script};TableCellMorph.prototype.selectCostumeForEdit=function(){var cst=this.data.copy(),icon,prepare,ide=this.parentThatIsA(IDE_Morph)||this.world().childThatIsA(IDE_Morph);cst.name=ide.currentSprite.newCostumeName(cst.name);icon=new CostumeIconMorph(cst);prepare=icon.prepareToBeGrabbed;icon.prepareToBeGrabbed=function(hand){hand.grabOrigin={origin:ide.palette,position:ide.palette.center()};this.prepareToBeGrabbed=prepare};if(ide.isAppMode){return}icon.setCenter(this.center());return icon};TableCellMorph.prototype.selectSoundForEdit=function(){var snd=this.data.copy(),icon,prepare,ide=this.parentThatIsA(IDE_Morph)||this.world().childThatIsA(IDE_Morph);snd.name=ide.currentSprite.newSoundName(snd.name);icon=new SoundIconMorph(snd);prepare=icon.prepareToBeGrabbed;icon.prepareToBeGrabbed=function(hand){hand.grabOrigin={origin:ide.palette,position:ide.palette.center()};this.prepareToBeGrabbed=prepare};if(ide.isAppMode){return}icon.setCenter(this.center());return icon};TableMorph.prototype=new FrameMorph;TableMorph.prototype.constructor=TableMorph;TableMorph.uber=FrameMorph.prototype;TableMorph.prototype.highContrast=false;function TableMorph(table,scrollBarSize,extent,startRow,startCol,globalColWidth,colWidths,rowHeight,colLabelHeight,padding){this.init(table,scrollBarSize,extent,startRow,startCol,globalColWidth,colWidths,rowHeight,colLabelHeight,padding)}TableMorph.prototype.init=function(table,scrollBarSize,extent,startRow,startCol,globalColWidth,colWidths,rowHeight,colLabelHeight,padding){this.table=table;this.scrollBarSize=scrollBarSize||MorphicPreferences.scrollBarSize;this.startRow=startRow||1;this.startCol=startCol||1;this.textHeight=Math.ceil(fontHeight(SyntaxElementMorph.prototype.fontSize)*1.3);this.rowHeight=rowHeight||this.textHeight;this.colWidths=colWidths||[];this.globalColWidth=globalColWidth||Math.ceil(this.textHeight*3.5);this.colLabelHeight=colLabelHeight||this.textHeight;this.padding=padding||SyntaxElementMorph.prototype.scale;this.tableVersion=this.table.lastChanged;this.hBar=null;this.vBar=null;this.rowLabelWidth=0;this.columns=[];this.rows=0;this.maxStartRow=null;this.maxStartCol=null;this.dragAnchor=null;this.resizeAnchor=null;this.resizeCol=null;this.resizeRow=null;this.wantsUpdate=false;Morph.prototype.init.call(this,true);if(extent){this.bounds.setExtent(extent)}this.initScrollBars();this.fixLayout()};TableMorph.prototype.initScrollBars=function(){var myself=this;this.hBar=new SliderMorph(1,null,null,null,"horizontal");this.hBar.setHeight(this.scrollBarSize);this.hBar.action=function(num){myself.showData(num,null,true)};this.hBar.isDraggable=false;this.add(this.hBar);this.vBar=new SliderMorph(1,null,null,null,"vertical");this.vBar.setWidth(this.scrollBarSize);this.vBar.action=function(num){myself.showData(null,num,true)};this.vBar.isDraggable=false;this.add(this.vBar)};TableMorph.prototype.updateScrollBars=function(){if(this.maxStartCol===1){this.hBar.hide()}else{this.hBar.show();this.hBar.stop=this.maxStartCol;this.hBar.value=this.startCol;this.hBar.size=Math.max(this.hBar.rangeSize()*this.columns.length/this.table.cols(),this.hBar.rangeSize()/10);this.hBar.fixLayout()}this.vBar.stop=this.maxStartRow;this.vBar.value=this.startRow;if(this.maxStartRow===1){this.vBar.hide()}else{this.vBar.show();this.vBar.size=Math.max(this.vBar.rangeSize()*this.rows/this.table.rows(),this.vBar.rangeSize()/10);this.vBar.fixLayout()}};TableMorph.prototype.fixLayout=function(){TableMorph.uber.fixLayout.call(this);this.rowLabelWidth=this.rowLabelsWidth();this.columns=this.columnsLayout();this.rows=this.visibleRows();this.buildCells();this.hBar.setWidth(this.width()-this.vBar.width());this.hBar.setLeft(this.left());this.hBar.setBottom(this.bottom());this.vBar.setHeight(this.height()-this.hBar.height());this.vBar.setRight(this.right());this.vBar.setTop(this.top())};TableMorph.prototype.render=function(ctx){var w,i;ctx.fillStyle="rgb(220, 220, 220)";BoxMorph.prototype.outlinePath.call(this,ctx,SyntaxElementMorph.prototype.corner+1,0);ctx.fill();if(this.highContrast&&this.table.cols()>1){w=this.padding;for(i=this.startCol;i<=this.table.cols();i+=1){w+=this.colWidth(i)+this.padding}ctx.fillStyle="darkGray";ctx.fillRect(this.padding+this.rowLabelWidth,this.padding+this.colLabelHeight,w,(this.rowHeight+this.padding)*(this.table.rows()+1-this.startRow)+this.padding)}};TableMorph.prototype.buildCells=function(){var cell,r,c,pos=this.position();this.children=[];for(c=0;c<=this.columns.length;c+=1){for(r=0;r<=this.rows;r+=1){cell=new TableCellMorph(this.table.get(!c?c:c+this.startCol-1,!r?r:r+this.startRow-1),new Point(!c?this.rowLabelWidth:this.colWidth(c+this.startCol-1),!r?this.colLabelHeight:this.rowHeight),!(r&&c),false);cell.setPosition(new Point(!c?this.padding:this.columns[c-1],!r?this.padding:this.padding*2+this.colLabelHeight+(r-1)*(this.rowHeight+this.padding)).add(pos));this.add(cell);if(isSnapObject(cell.getData())){this.wantsUpdate=true}}}this.add(this.hBar);this.add(this.vBar);this.updateScrollBars()};TableMorph.prototype.drawData=function(noScrollUpdate){var cell,cellIdx=0,r,c;for(c=0;c<=this.columns.length;c+=1){for(r=0;r<=this.rows;r+=1){cell=this.children[cellIdx];cellIdx+=1;cell.setData(this.table.get(!c?c:c+this.startCol-1,!r?r:r+this.startRow-1));if(isSnapObject(cell.getData())){this.wantsUpdate=true}}}if(!noScrollUpdate){this.updateScrollBars()}this.changed()};TableMorph.prototype.scroll=function(xSteps,ySteps){this.showData(Math.min(this.maxStartCol,Math.max(1,this.startCol+Math.round(xSteps))),Math.min(this.maxStartRow,Math.max(1,this.startRow+Math.round(ySteps))));this.updateScrollBars()};TableMorph.prototype.showData=function(startCol,startRow,noScrollUpdate){var c=startCol||this.startCol,r=startRow||this.startRow;if(c===this.startCol){if(r===this.startRow){return}this.startRow=r;this.rows=this.visibleRows();this.drawData(noScrollUpdate)}else{this.startCol=c;this.startRow=r;this.rows=this.visibleRows();if(this.colWidths.length){this.columns=this.columnsLayout();this.buildCells()}else{this.drawData(noScrollUpdate)}}};TableMorph.prototype.step=function(){if(this.dragAnchor){this.shiftCells(this.world().hand.position())}else if(this.resizeAnchor){this.resizeCells(this.world().hand.position())}this.update()};TableMorph.prototype.update=function(){var oldCols,oldRows,version=this.table instanceof List?this.table.version(this.startRow,this.rows,this.startCol,this.columns.length):this.table.lastChanged;if(this.tableVersion===version&&!this.wantsUpdate){return}this.wantsUpdate=false;if(this.table instanceof List){oldCols=this.columns.length;oldRows=this.rows;this.rowLabelWidth=this.rowLabelsWidth();this.columns=this.columnsLayout();this.rows=this.visibleRows();if(this.columns.length!==oldCols||this.rows!==oldRows){this.buildCells()}else{this.drawData()}}else{this.drawData()}this.tableVersion=version};TableMorph.prototype.rowLabelsWidth=function(){var ctx=StringMorph.prototype.measureCtx;ctx.font="italic "+SyntaxElementMorph.prototype.fontSize+"px Helvetica, Arial, sans-serif";return Math.max(0,Math.max.apply(null,this.table.columnNames().map(name=>name?ctx.measureText(name).width:0)))||ctx.measureText(this.table.rows().toString()).width+6*SyntaxElementMorph.prototype.scale};TableMorph.prototype.columnsLayout=function(){var c=[],x=this.padding*2+this.rowLabelWidth,colNum,w;colNum=this.table.cols();w=x;while(w<this.width()&&colNum>0){w+=this.colWidth(colNum);colNum-=1}if(colNum===0&&w<this.width()){this.maxStartCol=1}else{this.maxStartCol=Math.min(colNum+2,this.table.cols())}this.startCol=Math.min(this.startCol,this.maxStartCol);colNum=this.startCol;while(x<this.width()&&colNum<this.table.cols()+this.startCol){w=this.colWidth(colNum);c.push(x);x+=w;x+=this.padding;colNum+=1}return c};TableMorph.prototype.colWidth=function(col){return this.colWidths[col-1]||this.globalColWidth};TableMorph.prototype.visibleRows=function(){var rest=this.height()-this.colLabelHeight-this.padding,possible;if(rest<0){return 0}possible=Math.ceil(rest/(this.rowHeight+this.padding));this.maxStartRow=Math.max(1,this.table.rows()-possible+2);this.startRow=Math.min(this.startRow,this.maxStartRow);return Math.min(this.table.rows(),possible)};TableMorph.prototype.globalExtent=function(){var i,w=this.rowLabelsWidth()+2,cols=this.table.cols();for(i=0;i<cols;i+=1){w+=this.colWidth(i+1);w+=this.padding}if(cols===1){w+=this.scrollBarSize;w+=this.padding*2}return new Point(w+this.padding,this.colLabelHeight+this.padding*2+(this.rowHeight+this.padding)*this.table.rows())};TableMorph.prototype.mouseScroll=function(y,x){this.scroll(-(+x*MorphicPreferences.mouseScrollAmount/4),-(+y*MorphicPreferences.mouseScrollAmount))};TableMorph.prototype.mouseDownLeft=function(pos){var rel=pos.subtract(this.position());if(rel.x<=this.rowLabelWidth||rel.y<=this.colLabelHeight){if(this.world().currentKey===16){this.resizeCol=0}else{this.resizeCol=this.columnAt(rel.x)}this.resizeRow=rel.y>this.colLabelHeight;this.resizeAnchor=pos}else{this.resizeRow=null;this.dragAnchor=pos}};TableMorph.prototype.mouseClickLeft=function(pos){this.dragAnchor=null;this.resizeAnchor=null;this.resizeRow=null};TableMorph.prototype.mouseLeaveDragging=function(pos){this.dragAnchor=null;this.resizeAnchor=null;this.resizeRow=null};TableMorph.prototype.mouseDoubleClick=function(pos){if(this.parentThatIsA(TableDialogMorph)){this.escalateEvent("mouseDoubleClick",pos)}else{new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world())}};TableMorph.prototype.shiftCells=function(pos){var delta=this.dragAnchor.subtract(pos),scrollX=Math.round(delta.x/this.globalColWidth),scrollY=Math.round(delta.y/this.rowHeight);if(scrollX||scrollY){this.scroll(scrollX,scrollY);this.dragAnchor=pos}};TableMorph.prototype.resizeCells=function(pos){var delta=pos.subtract(this.resizeAnchor),i;if(this.resizeCol){this.colWidths[this.resizeCol-1]=Math.max(16,(this.colWidths[this.resizeCol-1]||this.globalColWidth)+delta.x)}else if(this.resizeRow){this.rowHeight=Math.max(16,this.rowHeight+delta.y)}else{this.globalColWidth=Math.max(16,this.globalColWidth+delta.x);for(i=0;i<this.colWidths.length;i+=1){if(this.colWidths[i]){this.colWidths[i]=Math.max(16,this.colWidths[i]+delta.x)}}}this.rowLabelWidth=this.rowLabelsWidth();this.columns=this.columnsLayout();this.rows=this.visibleRows();this.buildCells();this.resizeAnchor=pos;this.changed()};TableMorph.prototype.columnAt=function(relativeX){var c=0;if(relativeX<this.columns[0]){return 0}while(relativeX>this.columns[c]){c+=1}return c+this.startCol-1};TableMorph.prototype.userMenu=function(){var menu=new MenuMorph(this),world=this.world(),ide=detect(world.children,m=>m instanceof IDE_Morph);if(ide.isAppMode){return}if(this.parentThatIsA(TableDialogMorph)){if(this.colWidths.length){menu.addItem("reset columns","resetColumns");menu.addLine()}if(this.table instanceof List&&this.table.canBeJSON()){menu.addItem("blockify",()=>{this.table.blockify().pickUp(world);world.hand.grabOrigin={origin:ide.palette,position:ide.palette.center()}});menu.addItem("export",()=>{if(this.table.canBeCSV()){ide.saveFileAs(this.table.asCSV(),"text/csv;charset=utf-8",localize("data"))}else{ide.saveFileAs(this.table.asJSON(true),"text/json;charset=utf-8",localize("data"))}})}menu.addItem("open in another dialog...","openInDialog");return menu}if(this.colWidths.length){menu.addItem("reset columns","resetColumns")}menu.addItem("list view...","showListView");if(this.table instanceof List&&this.table.canBeJSON()){menu.addItem("blockify",()=>{this.table.blockify().pickUp(world);world.hand.grabOrigin={origin:ide.palette,position:ide.palette.center()}});menu.addItem("export",()=>{if(this.table.canBeCSV()){ide.saveFileAs(this.table.asCSV(),"text/csv;charset=utf-8",localize("data"))}else{ide.saveFileAs(this.table.asJSON(true),"text/json;charset=utf-8",localize("data"))}})}menu.addLine();menu.addItem("open in dialog...","openInDialog");return menu};TableMorph.prototype.resetColumns=function(){this.colWidths=[];this.rowLabelWidth=this.rowLabelsWidth();this.columns=this.columnsLayout();this.rows=this.visibleRows();this.buildCells();this.changed()};TableMorph.prototype.openInDialog=function(){new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world())};TableMorph.prototype.showListView=function(){var view=this.parentThatIsA(SpriteBubbleMorph,SpeechBubbleMorph,CellMorph);if(!view){return}if(view instanceof SpriteBubbleMorph){view.changed();view.contentsMorph.destroy();view.contentsMorph=new ListWatcherMorph(this.table);view.contentsMorph.step=view.contents.update;view.contentsMorph.expand(this.extent());view.parent.positionTalkBubble()}else if(view instanceof SpeechBubbleMorph){view.contents=new ListWatcherMorph(this.table);view.contents.step=view.contents.update;view.contents.expand(this.extent())}else{view.changed();view.contentsMorph.destroy();view.contentsMorph=new ListWatcherMorph(this.table);view.add(view.contentsMorph);view.contentsMorph.setPosition(this.position());view.contentsMorph.expand(this.extent())}view.fixLayout();view.rerender()};TableMorph.prototype.show=function(){TableMorph.uber.show.call(this);this.updateScrollBars()};TableFrameMorph.prototype=new Morph;TableFrameMorph.prototype.constructor=TableFrameMorph;TableFrameMorph.uber=Morph.prototype;function TableFrameMorph(tableMorph,noResize){this.init(tableMorph,noResize)}TableFrameMorph.prototype.init=function(tableMorph,noResize){this.tableMorph=tableMorph;this.handle=null;TableFrameMorph.uber.init.call(this,true);this.color="transparent";this.bounds=this.tableMorph.bounds.copy();this.add(this.tableMorph);if(!noResize){this.handle=new HandleMorph(this,80,25,null,null)}this.fixLayout()};TableFrameMorph.prototype.fixLayout=function(){var ext=this.extent();if(this.tableMorph.extent().eq(ext)){return}this.tableMorph.setExtent(this.extent());if(this.parent){this.parent.changed();this.parent.fixLayout();this.parent.rerender()}};TableFrameMorph.prototype.expand=function(maxExtent){var ext=this.tableMorph.globalExtent();if(maxExtent){ext=ext.min(maxExtent)}this.setExtent(ext);this.handle.setRight(this.right());this.handle.setBottom(this.bottom())};TableDialogMorph.prototype=new DialogBoxMorph;TableDialogMorph.prototype.constructor=TableDialogMorph;TableDialogMorph.uber=DialogBoxMorph.prototype;function TableDialogMorph(data,globalColWidth,colWidths,rowHeight){this.init(data,globalColWidth,colWidths,rowHeight)}TableDialogMorph.prototype.init=function(data,globalColWidth,colWidths,rowHeight){this.handle=null;this.data=data;this.tableView=null;TableDialogMorph.uber.init.call(this);this.labelString="Table view";this.createLabel();this.buildContents(data,globalColWidth,colWidths,rowHeight)};TableDialogMorph.prototype.buildContents=function(data,globalColWidth,colWidths,rowHeight){this.tableView=new TableMorph(data,null,null,null,null,globalColWidth,colWidths,rowHeight,null,null);this.addBody(new TableFrameMorph(this.tableView,true));this.addButton("ok","OK")};TableDialogMorph.prototype.setInitialDimensions=function(){var world=this.world(),mex=world.extent().subtract(new Point(this.padding,this.padding)),th=fontHeight(this.titleFontSize)+this.titlePadding*3,bh=this.buttons.height();this.setExtent(this.tableView.globalExtent().add(new Point(this.padding*2,this.padding*2+th+bh)).min(mex).max(new Point(100,100)));this.setCenter(this.world().center())};TableDialogMorph.prototype.popUp=function(world){if(world){TableDialogMorph.uber.popUp.call(this,world);this.setInitialDimensions();this.handle=new HandleMorph(this,100,100,this.corner,this.corner)}};TableDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;</script>
        <script>modules.sketch="2021-November-03";var VectorShape;var VectorRectangle;var VectorLine;var VectorEllipse;var VectorPolygon;var VectorSelection;var VectorPaintEditorMorph;var VectorPaintCanvasMorph;VectorShape.prototype={};VectorShape.prototype.constructor=VectorShape;VectorShape.uber=Object.prototype;function VectorShape(borderWidth,borderColor,fillColor){this.init(borderWidth,borderColor,fillColor)}VectorShape.prototype.init=function(borderWidth,borderColor,fillColor){this.borderWidth=borderColor&&borderColor.a?borderWidth:0;this.borderColor=borderColor||new Color(0,0,0,0);this.fillColor=fillColor||new Color(0,0,0,0);this.image=newCanvas();this.isPolygon=false;this.isSelection=false;this.isCrosshair=false;this.origin=new Point;this.destination=new Point};VectorShape.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])};VectorShape.prototype.asSVG=function(tagName){var svg=new XML_Element(tagName);if(this.borderColor&&this.borderColor.a){svg.attributes.stroke=this.borderColor.toRGBstring();svg.attributes["stroke-linejoin"]="miter";svg.attributes["stroke-width"]=this.borderWidth}else{svg.attributes.stroke="none"}if(this.fillColor&&this.fillColor.a){svg.attributes.fill=this.fillColor.toRGBstring()}else{svg.attributes.fill="none"}svg.attributes.prototype=this.constructor.name;return svg};VectorShape.prototype.imageURL=function(){var svg=new XML_Element("svg"),bounds=this.bounds();svg.attributes.xmlns="http://www.w3.org/2000/svg";svg.attributes.version="1.1";svg.attributes.preserveAspectRatio="xMinYMin meet";svg.attributes.viewBox=bounds.left()+" "+bounds.top()+" "+(bounds.right()-bounds.left())+" "+(bounds.bottom()-bounds.top());svg.attributes.width=bounds.right()-bounds.left();svg.attributes.height=bounds.bottom()-bounds.top();svg.children=[this.asSVG()];return"data:image/svg+xml;base64,"+svg};VectorShape.prototype.copy=function(newShape){var shape=newShape||new VectorShape(this.borderWidth,this.borderColor,this.fillColor);shape.image.width=this.image.width;shape.image.height=this.image.height;shape.image.getContext("2d").drawImage(this.image,0,0);return shape};VectorShape.prototype.bounds=function(){return new Rectangle(Math.min(this.origin.x,this.destination.x)-this.borderWidth/2,Math.min(this.origin.y,this.destination.y)-this.borderWidth/2,Math.max(this.origin.x,this.destination.x)+this.borderWidth/2,Math.max(this.origin.y,this.destination.y)+this.borderWidth/2)};VectorShape.prototype.containsPoint=function(aPoint){return this.bounds().containsPoint(aPoint)};VectorShape.prototype.update=function(newPoint,constrain){this.destination=constrain?this.constraintPoint(newPoint):newPoint};VectorShape.prototype.constraintPoint=function(aPoint){var newPoint=aPoint,delta=newPoint.subtract(this.origin),constraintPos=new Point(Math.max(Math.abs(delta.x),Math.abs(delta.y))*(delta.x/Math.abs(delta.x)),Math.max(Math.abs(delta.x),Math.abs(delta.y))*(delta.y/Math.abs(delta.y)));newPoint=this.origin.add(constraintPos);return newPoint};VectorShape.prototype.setColor=function(color,isSecondary){if(isSecondary){this.borderColor=color}else{this.fillColor=color}};VectorShape.prototype.setBorderWidth=function(width){if(this.borderColor&&this.borderColor.a){this.borderWidth=width}};VectorShape.prototype.moveBy=function(delta){this.origin=this.origin.add(delta);this.destination=this.destination.add(delta)};VectorShape.prototype.resizeBy=function(delta,origin){this.origin=this.origin.subtract(origin).multiplyBy(delta).add(origin);this.destination=this.destination.subtract(origin).multiplyBy(delta).add(origin)};VectorShape.prototype.drawOn=function(aCanvasMorph){var myself=this,origin=this.bounds().origin.subtract(aCanvasMorph.position()),img=new Image;this.image=newCanvas(aCanvasMorph.extent());img.onload=function(){myself.image.getContext("2d").drawImage(img,origin.x,origin.y);aCanvasMorph.redraw=true};img.src=this.imageURL()};VectorRectangle.prototype=new VectorShape;VectorRectangle.prototype.constructor=VectorRectangle;VectorRectangle.uber=VectorShape.prototype;function VectorRectangle(borderWidth,borderColor,fillColor,origin,destination){VectorRectangle.uber.init.call(this,borderWidth,borderColor,fillColor);this.init(origin,destination)}VectorRectangle.prototype.init=function(origin,destination){this.origin=origin;this.destination=destination};VectorRectangle.fromSVG=function(svg){var attributes=svg.attributes;return new VectorRectangle(parseInt(attributes["stroke-width"]),attributes.stroke==="none"?null:Color.fromString(attributes.stroke),attributes.fill==="none"?null:Color.fromString(attributes.fill),new Point(parseInt(attributes.x),parseInt(attributes.y)),new Point(parseInt(attributes.x)+parseInt(attributes.width),parseInt(attributes.y)+parseInt(attributes.height)))};VectorRectangle.prototype.copy=function(){var newRectangle=new VectorRectangle(this.borderWidth,this.borderColor,this.fillColor,this.origin.copy(),this.destination.copy());return VectorRectangle.uber.copy.call(this,newRectangle)};VectorRectangle.prototype.toString=function(){return VectorRectangle.uber.toString.call(this)+this.bounds().toString()};VectorRectangle.prototype.width=function(){return Math.abs(this.origin.x-this.destination.x)};VectorRectangle.prototype.height=function(){return Math.abs(this.origin.y-this.destination.y)};VectorRectangle.prototype.x=function(){return Math.min(this.origin.x,this.destination.x)};VectorRectangle.prototype.y=function(){return Math.min(this.origin.y,this.destination.y)};VectorRectangle.prototype.asSVG=function(){var svg=VectorRectangle.uber.asSVG.call(this,"rect");svg.attributes.width=this.width();svg.attributes.height=this.height();svg.attributes.x=this.x();svg.attributes.y=this.y();return svg};VectorRectangle.prototype.drawOn=function(aCanvasMorph){var context,canvasPosition=aCanvasMorph.position();this.image=newCanvas(aCanvasMorph.extent());context=this.image.getContext("2d");context.beginPath();context.rect(this.x()-canvasPosition.x,this.y()-canvasPosition.y,this.width(),this.height());if(this.fillColor.a>0){context.fillStyle=this.fillColor.toRGBstring();context.fill()}if(this.borderColor.a>0){context.lineWidth=this.borderWidth;context.strokeStyle=this.borderColor.toRGBstring();context.stroke()}aCanvasMorph.redraw=true};VectorLine.prototype=new VectorShape;VectorLine.prototype.constructor=VectorLine;VectorLine.uber=VectorShape.prototype;function VectorLine(borderWidth,borderColor,origin,destination){VectorLine.uber.init.call(this,borderWidth,borderColor);this.init(origin,destination)}VectorLine.prototype.init=function(origin,destination){this.origin=origin;this.destination=destination};VectorLine.fromSVG=function(svg){var attributes=svg.attributes;return new VectorLine(parseInt(attributes["stroke-width"]),Color.fromString(attributes.stroke),new Point(parseInt(attributes.x1),parseInt(attributes.y1)),new Point(parseInt(attributes.x2),parseInt(attributes.y2)))};VectorLine.prototype.copy=function(){var newLine=new VectorLine(this.borderWidth,this.borderColor.copy(),this.origin.copy(),this.destination.copy());return VectorLine.uber.copy.call(this,newLine)};VectorLine.prototype.containsPoint=function(aPoint){var lineLength=this.origin.distanceTo(this.destination),distancesSum=aPoint.distanceTo(this.origin)+aPoint.distanceTo(this.destination);return Math.abs(lineLength-distancesSum)<=Math.sqrt(this.borderWidth/2)/2};VectorLine.prototype.constraintPoint=function(aPoint){var angle,newPoint=aPoint;angle=newPoint.subtract(this.origin).abs().degrees();if(angle<22.5){newPoint.y=this.origin.y}else if(angle>67.5){newPoint.x=this.origin.x}else{newPoint=VectorLine.uber.constraintPoint.call(this,aPoint)}return newPoint};VectorLine.prototype.setColor=function(color,isSecondary){VectorLine.uber.setColor.call(this,color,!isSecondary)};VectorLine.prototype.toString=function(){return VectorLine.uber.toString.call(this)+this.bounds().toString()};VectorLine.prototype.asSVG=function(){var svg=VectorLine.uber.asSVG.call(this,"line");svg.attributes.x1=this.origin.x;svg.attributes.y1=this.origin.y;svg.attributes.x2=this.destination.x;svg.attributes.y2=this.destination.y;return svg};VectorLine.prototype.drawOn=function(aCanvasMorph){var context,origin=this.origin.subtract(aCanvasMorph.position()),destination=this.destination.subtract(aCanvasMorph.position());this.image=newCanvas(aCanvasMorph.extent());context=this.image.getContext("2d");context.beginPath();if(this.borderColor.a>0){context.lineWidth=this.borderWidth;context.strokeStyle=this.borderColor.toRGBstring();context.moveTo(origin.x,origin.y);context.lineTo(destination.x,destination.y);context.stroke()}aCanvasMorph.redraw=true};VectorEllipse.prototype=new VectorShape;VectorEllipse.prototype.constructor=VectorEllipse;VectorEllipse.uber=VectorShape.prototype;function VectorEllipse(borderWidth,borderColor,fillColor,origin,destination){VectorEllipse.uber.init.call(this,borderWidth,borderColor,fillColor);this.init(origin,destination)}VectorEllipse.prototype.init=function(origin,destination){this.origin=origin;this.destination=destination};VectorEllipse.fromSVG=function(svg){var attributes=svg.attributes;return new VectorEllipse(parseInt(attributes["stroke-width"]),attributes.stroke==="none"?null:Color.fromString(attributes.stroke),attributes.fill==="none"?null:Color.fromString(attributes.fill),new Point(parseInt(attributes.cx),parseInt(attributes.cy)),new Point(parseInt(attributes.cx)+parseInt(attributes.rx),parseInt(attributes.cy)+parseInt(attributes.ry)))};VectorEllipse.prototype.copy=function(){var newEllipse=new VectorEllipse(this.borderWidth,this.borderColor,this.fillColor,this.origin.copy(),this.destination.copy());return VectorEllipse.uber.copy.call(this,newEllipse)};VectorEllipse.prototype.hRadius=function(){return Math.abs(this.destination.x-this.origin.x)};VectorEllipse.prototype.vRadius=function(){return Math.abs(this.destination.y-this.origin.y)};VectorEllipse.prototype.toString=function(){return VectorEllipse.uber.toString.call(this)+" center: "+this.origin.toString()+" radii: "+this.hRadius().toString()+","+this.vRadius().toString()};VectorEllipse.prototype.bounds=function(){var hRadius=this.hRadius(),vRadius=this.vRadius();return new Rectangle(this.origin.x-hRadius-this.borderWidth/2,this.origin.y-vRadius-this.borderWidth/2,this.origin.x+hRadius+this.borderWidth/2,this.origin.y+vRadius+this.borderWidth/2)};VectorEllipse.prototype.containsPoint=function(aPoint){return Math.pow(aPoint.x-this.origin.x,2)/Math.pow(this.hRadius()+this.borderWidth/2,2)+Math.pow(aPoint.y-this.origin.y,2)/Math.pow(this.vRadius()+this.borderWidth/2,2)<1};VectorEllipse.prototype.asSVG=function(){var svg=VectorEllipse.uber.asSVG.call(this,"ellipse");svg.attributes.cx=this.origin.x;svg.attributes.cy=this.origin.y;svg.attributes.rx=this.hRadius();svg.attributes.ry=this.vRadius();return svg};VectorEllipse.prototype.drawOn=function(aCanvasMorph){var context,canvasPosition=aCanvasMorph.position();this.image=newCanvas(aCanvasMorph.extent());context=this.image.getContext("2d");context.beginPath();context.ellipse(this.origin.x-canvasPosition.x,this.origin.y-canvasPosition.y,this.hRadius(),this.vRadius(),0,0,2*Math.PI,true);if(this.fillColor&&this.fillColor.a>0){context.fillStyle=this.fillColor.toRGBstring();context.fill()}if(this.borderColor.a>0){context.lineWidth=this.borderWidth;context.strokeStyle=this.borderColor.toRGBstring();context.stroke()}aCanvasMorph.redraw=true};VectorPolygon.prototype=new VectorShape;VectorPolygon.prototype.constructor=VectorPolygon;VectorPolygon.uber=VectorShape.prototype;function VectorPolygon(borderWidth,borderColor,fillColor,points,isClosed,isFreeHand){VectorPolygon.uber.init.call(this,borderWidth,borderColor,fillColor);this.init(points,isClosed,isFreeHand)}VectorPolygon.prototype.init=function(points,isClosed,isFreeHand){this.points=points||[];this.isClosed=isClosed;this.isFreeHand=isFreeHand;this.isPolygon=true};VectorPolygon.fromSVG=function(svg){var attributes=svg.attributes,points=attributes.d.slice(1).split(/L */).map(function(pointString){var pointArray=pointString.split(" ");return new Point(parseInt(pointArray[0]),parseInt(pointArray[1]))});return new VectorPolygon(parseInt(attributes["stroke-width"]),attributes.stroke==="none"?null:Color.fromString(attributes.stroke),attributes.fill==="none"?null:Color.fromString(attributes.fill),points,points[0].eq(points[points.length-1]),false)};VectorPolygon.prototype.copy=function(){var newPolygon=new VectorPolygon(this.borderWidth,this.borderColor,this.fillColor,this.points.map(function(point){return point.copy()}),this.isClosed,this.isFreeHand);return VectorPolygon.uber.copy.call(this,newPolygon)};VectorPolygon.prototype.toString=function(){return VectorPolygon.uber.toString.call(this)+this.points};VectorPolygon.prototype.bounds=function(){var left=this.points[0].x,top=this.points[0].y,right=this.points[this.points.length-1].x,bottom=this.points[this.points.length-1].y;this.points.forEach(function(point){left=Math.min(left,point.x);top=Math.min(top,point.y);right=Math.max(right,point.x);bottom=Math.max(bottom,point.y)});return new Rectangle(left-this.borderWidth/2,top-this.borderWidth/2,right+this.borderWidth/2,bottom+this.borderWidth/2)};VectorPolygon.prototype.containsPoint=function(aPoint){var myself=this,pointCount=this.points.length,inside=false,i,j;for(i=1;i<pointCount;i+=1){if(pointIsBetween(this.points[i-1],this.points[i])){return true}}if(this.isClosed){for(i=0,j=pointCount-1;i<pointCount;i+=1){if(this.points[i].y>aPoint.y!==this.points[j].y>aPoint.y&&aPoint.x<(this.points[j].x-this.points[i].x)*(aPoint.y-this.points[i].y)/(this.points[j].y-this.points[i].y)+this.points[i].x){inside=!inside}j=i}return inside}function pointIsBetween(a,b){return Math.abs(a.distanceTo(b)-(aPoint.distanceTo(a)+aPoint.distanceTo(b)))<=Math.sqrt(myself.borderWidth/2)/2}return false};VectorPolygon.prototype.update=function(newPoint,constrain){if(this.isFreeHand||this.points.length===1){this.points.push(newPoint)}else if(!this.isFreeHand){if(constrain){this.origin=this.points[this.points.length-2];newPoint=VectorLine.prototype.constraintPoint.call(this,newPoint)}this.points[this.points.length-1]=newPoint}};VectorPolygon.prototype.setColor=function(color,isSecondary){VectorPolygon.uber.setColor.call(this,color,!this.isClosed||isSecondary)};VectorPolygon.prototype.moveBy=function(delta){this.points.forEach(function(eachPoint){eachPoint.x+=delta.x;eachPoint.y+=delta.y})};VectorPolygon.prototype.resizeBy=function(delta,origin){this.points=this.points.map(function(point){return point.subtract(origin).multiplyBy(delta).add(origin)})};VectorPolygon.prototype.close=function(){if(this.isClosed){this.points.push(this.points[0].copy())}};VectorPolygon.prototype.asSVG=function(){var svg=VectorPolygon.uber.asSVG.call(this,"path");svg.attributes["stroke-linejoin"]="round";svg.attributes["stroke-linecap"]="round";svg.attributes.d="M"+this.points[0].x+" "+this.points[0].y;this.points.slice(1).forEach(function(point){svg.attributes.d+=" L "+point.x+" "+point.y});return svg};VectorPolygon.prototype.drawOn=function(aCanvasMorph){var context,points=this.points.map(function(eachPoint){return eachPoint.subtract(aCanvasMorph.position())});this.image=newCanvas(aCanvasMorph.extent());context=this.image.getContext("2d");context.lineCap="round";context.lineJoin="round";context.beginPath();context.moveTo(points[0].x,points[0].y);points.slice(1).forEach(function(point){context.lineTo(point.x,point.y)});if(this.fillColor&&this.fillColor.a>0){context.fillStyle=this.fillColor.toRGBstring();context.fill()}if(this.borderColor.a>0){context.lineWidth=this.borderWidth;context.strokeStyle=this.borderColor.toRGBstring();context.stroke()}else if(this.points.length===2){context.lineWidth=1;context.strokeStyle=this.fillColor.toRGBstring();context.stroke()}aCanvasMorph.redraw=true};VectorSelection.prototype=new VectorRectangle;VectorSelection.prototype.constructor=VectorSelection;VectorSelection.uber=VectorRectangle.prototype;function VectorSelection(origin,destination){VectorRectangle.uber.init.call(this,1,new Color(0,0,0,255),null);this.init(origin,destination)}VectorSelection.prototype.init=function(origin,destination){VectorSelection.uber.init.call(this,origin,destination);this.isSelection=true;this.threshold=5};VectorSelection.prototype.corners=function(){var bounds=this.bounds();return[bounds.topLeft(),bounds.topRight(),bounds.bottomLeft(),bounds.bottomRight()]};VectorSelection.prototype.cornerAt=function(aPoint){var threshold=this.threshold;return this.corners().find(function(corner){return aPoint.distanceTo(corner)<=threshold})};VectorSelection.prototype.cornerOppositeTo=function(aPoint){return this.corners().reduce(function(a,b){return aPoint.distanceTo(a)>aPoint.distanceTo(b)?a:b})};VectorSelection.prototype.drawOn=function(aCanvasMorph){var context,bounds=this.bounds(),canvasPosition=aCanvasMorph.position(),origin=bounds.origin.subtract(canvasPosition),circleRadius=this.threshold;this.image=newCanvas(aCanvasMorph.extent());context=this.image.getContext("2d");context.rect(origin.x,origin.y,this.width(),this.height());context.setLineDash([5]);context.stroke();context.setLineDash([]);function drawCircle(x,y){context.beginPath();context.arc(x-canvasPosition.x,y-canvasPosition.y,circleRadius,0,2*Math.PI);context.stroke()}drawCircle(bounds.left(),bounds.top());drawCircle(bounds.left(),bounds.bottom());drawCircle(bounds.right(),bounds.top());drawCircle(bounds.right(),bounds.bottom());aCanvasMorph.redraw=true};Crosshair.prototype=VectorShape;Crosshair.prototype.constructor=Crosshair;Crosshair.uber=VectorShape.prototype;function Crosshair(center,paper){this.init(center,paper)}Crosshair.prototype.init=function(center,paper){this.center=center;this.paper=paper;this.image=newCanvas();this.isCrosshair=true};Crosshair.prototype.update=function(newPosition){this.center=newPosition.subtract(this.paper.position())};Crosshair.prototype.moveBy=function(delta){this.center=this.center.add(delta)};Crosshair.prototype.drawOn=function(aCanvasMorph){this.image=newCanvas(aCanvasMorph.extent());aCanvasMorph.rotationCenter=this.center.copy();aCanvasMorph.drawcrosshair(this.image.getContext("2d"));aCanvasMorph.redraw=true};VectorPaintEditorMorph.prototype=new PaintEditorMorph;VectorPaintEditorMorph.prototype.constructor=VectorPaintEditorMorph;VectorPaintEditorMorph.uber=PaintEditorMorph.prototype;function VectorPaintEditorMorph(){this.init()}VectorPaintEditorMorph.prototype.init=function(){this.paper=null;this.shapes=[];this.selection=[];this.selecting=false;this.originalSelection=null;this.moving=false;this.resizing=false;this.lastDragPosition=null;this.history=[];this.clipboard=[];this.currentShape=null;VectorPaintEditorMorph.uber.init.call(this);this.labelString="Vector Paint Editor";this.createLabel();this.fixLayout()};VectorPaintEditorMorph.prototype.buildEdits=function(){var myself=this;this.edits.add(this.pushButton("undo",function(){myself.undo()}));this.edits.add(this.pushButton("clear",function(){myself.paper.clearCanvas()}));this.edits.add(this.pushButton("Bitmap",function(){if(myself.shapes.length>0){myself.ide.confirm("This will convert your vector objects into\n"+"bitmaps, and you will not be able to convert\n"+"them back into vector drawings.\n"+"Are you sure you want to continue?","Convert to bitmap?",()=>{setTimeout(()=>{myself.convertToBitmap()})})}else{myself.convertToBitmap()}}));this.edits.fixLayout()};VectorPaintEditorMorph.prototype.convertToBitmap=function(){var canvas=newCanvas(this.ide.stage.dimensions),myself=this;this.object=new Costume;this.shapes.forEach(function(each){canvas.getContext("2d").drawImage(each.image,0,0)});this.object.rotationCenter=this.paper.rotationCenter.copy();this.object.contents=canvas;this.object.edit(this.world(),this.ide,false,null,()=>{myself.ide.currentSprite.shadowAttribute("costumes");myself.ide.currentSprite.addCostume(myself.object);myself.ide.spriteEditor.updateList();if(myself.ide){myself.ide.currentSprite.wearCostume(myself.object)}})};VectorPaintEditorMorph.prototype.buildScaleBox=function(){var myself=this;["Top","Bottom","Up","Down"].forEach(function(label){myself.scaleBox.add(myself.pushButton(label,function(){myself.changeSelectionLayer(label.toLowerCase())}))});this.scaleBox.fixLayout()};VectorPaintEditorMorph.prototype.openIn=function(world,oldim,oldrc,callback,anIDE,shapes){var myself=this,isEmpty=isNil(shapes)||shapes.length===0;VectorPaintEditorMorph.uber.openIn.call(this,world,null,oldrc,callback,anIDE);this.ide=anIDE;this.paper.drawNew();this.paper.changed();shapes.forEach(function(shape){shape.drawOn(myself.paper)});this.shapes=shapes.map(function(eachShape){return eachShape.copy()});this.shapes.forEach(function(shape){shape.drawOn(myself.paper)});if(oldrc&&!isEmpty){this.paper.automaticCrosshairs=false;this.paper.rotationCenter=this.getBounds(this.shapes).origin.subtract(this.paper.bounds.origin).add(oldrc)}else{this.paper.automaticCrosshairs=true}this.updateHistory();this.processKeyUp=function(){myself.shift=false;myself.ctrl=false;myself.propertiesControls.constrain.refresh()};this.processKeyDown=function(event){var pos;myself.shift=myself.world().currentKey===16;myself.ctrl=event.ctrlKey;switch(myself.world().currentKey){case 46:case 8:myself.sortSelection();myself.selection.slice().reverse().forEach(function(shape){myself.shapes.splice(myself.shapes.indexOf(shape),1)});myself.clearSelection();myself.updateHistory();break;case 13:if(myself.currentShape&&myself.currentShape.isPolygon){myself.currentShape.close();myself.currentShape.drawOn(myself.paper);myself.shapes.push(myself.currentShape);myself.currentShape=null;myself.updateHistory()}break;case 33:myself.changeSelectionLayer("up");break;case 34:myself.changeSelectionLayer("down");break;case 35:myself.changeSelectionLayer("bottom");break;case 36:myself.changeSelectionLayer("top");break;case 90:if(myself.ctrl){myself.undo()}break;case 67:if(myself.ctrl&&myself.selection.length){myself.clipboard=myself.selection.map(function(each){return each.copy()})}break;case 86:pos=myself.world().hand.position();if(myself.ctrl&&myself.paper.bounds.containsPoint(pos)){myself.paper.pasteAt(pos);myself.updateHistory()}break;case 65:if(myself.ctrl){myself.paper.currentTool="selection";myself.paper.toolChanged("selection");myself.refreshToolButtons();myself.paper.selectShapes(myself.shapes)}break;case 27:myself.clearSelection();break;case 37:myself.moveSelectionBy(new Point(-1,0));myself.updateHistory();break;case 38:myself.moveSelectionBy(new Point(0,-1));myself.updateHistory();break;case 39:myself.moveSelectionBy(new Point(1,0));myself.updateHistory();break;case 40:myself.moveSelectionBy(new Point(0,1));myself.updateHistory();break;default:nop()}myself.propertiesControls.constrain.refresh()}};VectorPaintEditorMorph.prototype.buildContents=function(){var myself=this;VectorPaintEditorMorph.uber.buildContents.call(this);this.paper.destroy();this.paper=new VectorPaintCanvasMorph(myself.shift);this.paper.setExtent(this.ide.stage.dimensions);this.body.add(this.paper);this.refreshToolButtons();this.fixLayout()};VectorPaintEditorMorph.prototype.buildToolbox=function(){var tools={brush:"Paintbrush tool\n(free draw)",rectangle:"Rectangle\n(shift: square)",ellipse:"Ellipse\n(shift: circle)",selection:"Selection tool",crosshairs:"Set the rotation center",line:"Line tool\n(shift: constrain to 45º)",closedBrush:"Closed brush\n(free draw)",polygon:"Polygon",paintbucket:"Paint a shape\n(shift: edge color)",pipette:"Pipette tool\n(pick a color from anywhere\nshift: fill color)"},myself=this,left=this.toolbox.left(),top=this.toolbox.top(),padding=2,inset=5,x=0,y=0;Object.keys(tools).forEach(function(toolName){var button=myself.toolButton(toolName,tools[toolName]);button.setPosition(new Point(left+x,top+y));x+=button.width()+padding;if(toolName==="crosshairs"){x=0;y+=button.height()+padding;myself.paper.drawcrosshair()}myself.toolbox[toolName]=button;myself.toolbox.add(button)});this.toolbox.bounds=this.toolbox.fullBounds().expandBy(inset*2)};VectorPaintEditorMorph.prototype.populatePropertiesMenu=function(){var c=this.controls,myself=this,pc=this.propertiesControls,alpen=new AlignmentMorph("row",this.padding),alignColor=new AlignmentMorph("row",this.padding),alignNames=new AlignmentMorph("row",this.padding),brushControl=new AlignmentMorph("column",3);brushControl.alignment="left";pc.primaryColorViewer=new Morph;pc.primaryColorViewer.color=new Color(0,0,0);pc.primaryColorViewer.setExtent(new Point(85,15));pc.primaryColorViewer.render=function(ctx){myself.renderColorSelection(ctx,myself.paper.settings.primaryColor)};pc.secondaryColorViewer=new Morph;pc.secondaryColorViewer.color=new Color(0,0,0);pc.secondaryColorViewer.setExtent(new Point(85,15));pc.secondaryColorViewer.render=function(ctx){myself.renderColorSelection(ctx,myself.paper.settings.secondaryColor)};pc.colorpicker=new PaintColorPickerMorph(new Point(180,100),function(color,isSecondary){myself.selectColor(color,!isSecondary)});pc.colorpicker.mouseDownRight=function(pos){if(pos.subtract(this.position()).x>this.width()*2/3&&pos.subtract(this.position()).y>this.height()-10){this.action("transparent",true)}else{this.action(this.getPixelColor(pos),true)}};pc.colorpicker.mouseClickRight=pc.colorpicker.mouseDownRight;pc.colorpicker.action(new Color(0,0,0));pc.colorpicker.action("transparent",true);pc.penSizeSlider=new SliderMorph(0,20,5,5);pc.penSizeSlider.orientation="horizontal";pc.penSizeSlider.setHeight(15);pc.penSizeSlider.setWidth(150);pc.penSizeSlider.action=function(num){if(pc.penSizeField){pc.penSizeField.setContents(num)}myself.paper.settings.lineWidth=num;myself.selection.forEach(function(shape){shape.setBorderWidth(num);shape.drawOn(myself.paper);myself.paper.updateSelection()});myself.updateHistory()};pc.penSizeField=new InputFieldMorph("3",true,null,false);pc.penSizeField.contents().minWidth=20;pc.penSizeField.setWidth(25);pc.penSizeField.accept=function(num){var val=parseFloat(pc.penSizeField.getValue());pc.penSizeSlider.value=val;pc.penSizeSlider.updateValue();this.setContents(val);myself.paper.settings.lineWidth=val;this.world().keyboardFocus=myself;myself.selection.forEach(function(shape){shape.setBorderWidth(num);shape.drawOn(myself.paper);myself.paper.updateSelection()});myself.updateHistory()};alpen.add(pc.penSizeSlider);alpen.add(pc.penSizeField);alpen.color=myself.color;alpen.fixLayout();pc.constrain=new ToggleMorph("checkbox",this,function(){myself.shift=!myself.shift},"Constrain proportions of shapes?\n(you can also hold shift)",function(){return myself.shift});pc.constrain.label.isBold=false;alignColor.add(pc.secondaryColorViewer);alignColor.add(pc.primaryColorViewer);alignColor.fixLayout();alignNames.add(new TextMorph(localize("Edge color\n(left click)"),10,null,null,null,"center",85));alignNames.add(new TextMorph(localize("Fill color\n(right click)"),10,null,null,null,"center",85));alignNames.fixLayout();c.add(pc.colorpicker);c.add(alignNames);c.add(alignColor);brushControl.add(new StringMorph(localize("Brush size")+":",10,null,true));brushControl.add(alpen);brushControl.add(pc.constrain);brushControl.fixLayout();c.add(brushControl)};VectorPaintEditorMorph.prototype.selectColor=function(color,secondary){var myself=this,isSecondary=this.paper.isShiftPressed()?false:secondary,propertyName=(isSecondary?"secondary":"primary")+"Color";this.paper.settings[propertyName]=color;if(this.selection.length){this.selection.forEach(function(shape){shape.setColor(color,isSecondary);shape.drawOn(myself.paper)});this.updateHistory()}this.propertiesControls[propertyName+"Viewer"].rerender()};VectorPaintEditorMorph.prototype.renderColorSelection=function(ctx,color="transparent"){var i,j;if(color==="transparent"||color.a===0){for(i=0;i<180;i+=5){for(j=0;j<15;j+=5){ctx.fillStyle=(j+i)/5%2===0?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)";ctx.fillRect(i,j,5,5)}}}else{ctx.fillStyle=color.toString();ctx.fillRect(0,0,180,15)}};VectorPaintEditorMorph.prototype.changeSelectionLayer=function(destination){var myself=this;this.sortSelection();switch(destination){case"top":this.selection.forEach(function(shape){myself.shapes.splice(myself.shapes.indexOf(shape),1);myself.shapes.push(shape)});break;case"bottom":this.selection.slice().reverse().forEach(function(shape){myself.shapes.splice(myself.shapes.indexOf(shape),1);myself.shapes.splice(0,0,shape)});break;case"up":this.selection.forEach(function(shape){var index=myself.shapes.indexOf(shape);myself.shapes.splice(index,1);myself.shapes.splice(index+myself.selection.length,0,shape)});break;case"down":if(this.shapes[0]!==this.selection[0]){this.selection.forEach(function(shape){var index=myself.shapes.indexOf(shape);myself.shapes.splice(index,1);myself.shapes.splice(index-1,0,shape)})}break}this.updateHistory();this.paper.redraw=true};VectorPaintEditorMorph.prototype.dragSelection=function(pos){var origin,ratio,delta;if(this.lastDragPosition){if(this.moving){delta=pos.subtract(this.lastDragPosition);this.moveSelectionBy(delta)}else if(this.resizing){if(this.shift){origin=this.originalSelection.origin;ratio=Math.max((pos.x-origin.x)/(this.originalSelection.destination.x-origin.x),(pos.y-origin.y)/(this.originalSelection.destination.y-origin.y));pos=this.originalSelection.destination.subtract(origin).multiplyBy(ratio).add(origin)}delta=pos.subtract(this.currentShape.origin).divideBy(this.lastDragPosition.subtract(this.currentShape.origin));this.resizeSelectionBy(delta)}}else if(this.resizing){this.originalSelection=this.currentShape.copy()}this.lastDragPosition=pos};VectorPaintEditorMorph.prototype.moveSelectionBy=function(delta){var paper=this.paper;this.selection.forEach(function(shape){shape.moveBy(delta);shape.drawOn(paper)});if(this.currentShape&&this.currentShape.isSelection){this.currentShape.moveBy(delta);this.currentShape.drawOn(paper)}};VectorPaintEditorMorph.prototype.resizeSelectionBy=function(delta){var paper=this.paper,selectionShape;if(this.currentShape&&this.currentShape.isSelection){selectionShape=this.currentShape;this.selection.forEach(function(shape){shape.resizeBy(delta,selectionShape.origin);shape.drawOn(paper)});selectionShape.resizeBy(delta,selectionShape.origin);selectionShape.drawOn(paper)}};VectorPaintEditorMorph.prototype.sortSelection=function(){var myself=this;this.selection.sort(function(a,b){return myself.shapes.indexOf(a)>myself.shapes.indexOf(b)})};VectorPaintEditorMorph.prototype.clearSelection=function(){this.currentShape=null;this.selection=[];this.paper.redraw=true};VectorPaintEditorMorph.prototype.getSVG=function(){var svg=new XML_Element("svg"),bounds=this.getBounds(this.shapes);svg.attributes.xmlns="http://www.w3.org/2000/svg";svg.attributes.snap="http://snap.berkeley.edu/run";svg.attributes.version="1.1";svg.attributes.preserveAspectRatio="none meet";svg.attributes.viewBox=bounds.left()+" "+bounds.top()+" "+(bounds.right()-bounds.left())+" "+(bounds.bottom()-bounds.top());svg.attributes.width=bounds.right()-bounds.left();svg.attributes.height=bounds.bottom()-bounds.top();svg.children=this.shapes.map(function(shape){return shape.asSVG()});return window.btoa(svg)};VectorPaintEditorMorph.prototype.getBounds=function(shapeCollection){var shapeBounds=shapeCollection.map(function(each){return each.bounds()});if(shapeBounds.length===0){return null}return shapeBounds.reduce(function(previous,current){return new Rectangle(Math.min(previous.left(),current.left()),Math.min(current.top(),previous.top()),Math.max(previous.right(),current.right()),Math.max(previous.bottom(),current.bottom()))})};VectorPaintEditorMorph.prototype.silentMoveBy=function(delta){VectorPaintEditorMorph.uber.silentMoveBy.call(this,delta);if(this.currentShape){this.currentShape.moveBy(delta)}this.shapes.forEach(function(shape){shape.moveBy(delta)})};VectorPaintEditorMorph.prototype.ok=function(){var myself=this,img=new Image,shapeOrigin,originDelta;if(this.shapes.length===0){this.cancel();return}shapeOrigin=this.getBounds(this.shapes).origin;originDelta=shapeOrigin.subtract(this.paper.bounds.origin);this.paper.updateAutomaticCenter();img.src="data:image/svg+xml;base64,"+this.getSVG().toString();img.onload=function(){myself.callback(img,myself.paper.rotationCenter.subtract(originDelta),myself.shapes)};this.destroy()};VectorPaintEditorMorph.prototype.updateHistory=function(){this.history.push(this.shapes.map(function(shape){return shape.copy()}))};VectorPaintEditorMorph.prototype.undo=function(){var paper=this.paper,oldSum=this.checksum(),newSum=oldSum;function draw(shape){shape.drawOn(paper)}while(this.shapes.length&&oldSum==newSum){this.shapes=this.history.pop()||[];this.shapes.forEach(draw);newSum=this.checksum()}this.clearSelection()};VectorPaintEditorMorph.prototype.checksum=function(){return JSON.stringify(this.shapes).split("").reduce(function(previousSum,currentChar){return previousSum+currentChar.charCodeAt(0)},0)};VectorPaintCanvasMorph.prototype=new PaintCanvasMorph;VectorPaintCanvasMorph.prototype.constructor=VectorPaintCanvasMorph;VectorPaintCanvasMorph.uber=PaintCanvasMorph.prototype;function VectorPaintCanvasMorph(shift){this.init(shift)}VectorPaintCanvasMorph.prototype.init=function(shift){VectorPaintCanvasMorph.uber.init.call(this,shift);this.isCachingImage=true;this.pointBuffer=[];this.currentTool="brush";this.settings={primaryColor:new Color(0,0,0,0),secondaryColor:new Color(0,0,0,255),lineWidth:3}};VectorPaintCanvasMorph.prototype.calculateCanvasCenter=function(){var canvasBounds=this.bounds;return new Point(canvasBounds.width()/2,canvasBounds.height()/2)};VectorPaintCanvasMorph.prototype.updateAutomaticCenter=function(){var editor=this.parentThatIsA(VectorPaintEditorMorph),shapeBounds=editor.getBounds(editor.shapes),relativePosition;if(this.automaticCrosshairs&&shapeBounds){relativePosition=shapeBounds.origin.subtract(this.bounds.origin);this.rotationCenter=new Point(shapeBounds.width()/2,shapeBounds.height()/2).add(relativePosition)}else if(this.automaticCrosshairs){this.calculateCanvasCenter()}};VectorPaintCanvasMorph.prototype.clearCanvas=function(){var editor=this.parentThatIsA(VectorPaintEditorMorph);editor.updateHistory();editor.shapes=[];editor.clearSelection();this.mask.getContext("2d").clearRect(0,0,this.bounds.width(),this.bounds.height());this.redraw=true};VectorPaintCanvasMorph.prototype.toolChanged=function(tool){var editor=this.parentThatIsA(VectorPaintEditorMorph);VectorPaintCanvasMorph.uber.toolChanged.call(this,tool);if(editor.currentShape&&editor.currentShape.isPolygon){editor.currentShape.close();editor.currentShape.drawOn(this);editor.shapes.push(editor.currentShape)}if(tool==="crosshairs"){editor.clearSelection();editor.currentShape=new Crosshair(this.rotationCenter,this);editor.currentShape.drawOn(this);this.automaticCrosshairs=false}else if(tool==="pipette"&&editor.selection){return}else{editor.clearSelection();editor.currentShape=null}};VectorPaintCanvasMorph.prototype.drawNew=function(){var myself=this,editor=this.parentThatIsA(VectorPaintEditorMorph),canvas=newCanvas(this.extent(),false,this.cachedImage);this.merge(this.background,canvas);this.merge(this.paper,canvas);if(editor){editor.shapes.forEach(function(each){myself.merge(each.image,canvas)});if(editor.currentShape){this.merge(editor.currentShape.image,canvas)}}this.cachedImage=canvas;this.drawFrame()};VectorPaintCanvasMorph.prototype.render=VectorPaintCanvasMorph.prototype.drawNew;VectorPaintCanvasMorph.prototype.step=function(){if(this.redraw){this.drawNew();this.changed();this.redraw=false}};VectorPaintCanvasMorph.prototype.mouseMove=function(pos){var editor=this.parentThatIsA(VectorPaintEditorMorph),primaryColor=this.settings.primaryColor,secondaryColor=this.settings.secondaryColor,borderWidth=this.settings.lineWidth,selectionCorner,oppositeCorner;if(this.currentTool==="paintbucket"){return}else if(editor.currentShape&&editor.currentShape.isSelection&&!editor.selecting){selectionCorner=editor.currentShape.cornerAt(pos);if(editor.resizing||editor.moving){editor.dragSelection(pos)}else if(selectionCorner){oppositeCorner=editor.currentShape.cornerOppositeTo(selectionCorner);editor.currentShape=new VectorSelection(oppositeCorner,selectionCorner);editor.currentShape.drawOn(this);editor.resizing=true;document.body.style.cursor="move"}else if(editor.currentShape.containsPoint(pos)){editor.moving=true;document.body.style.cursor="move"}}else if(!editor.currentShape||editor.currentShape.isSelection&&!editor.selecting){this.beginShape(borderWidth,primaryColor,secondaryColor,pos);editor.currentShape.drawOn(this)}else{editor.currentShape.update(pos,editor.shift);editor.currentShape.drawOn(this)}};VectorPaintCanvasMorph.prototype.mouseEnter=function(){if(this.currentTool==="selection"){document.body.style.cursor="crosshair"}else{document.body.style.cursor="default"}};VectorPaintCanvasMorph.prototype.mouseLeave=function(){document.body.style.cursor="default"};VectorPaintCanvasMorph.prototype.mouseClickLeft=function(pos){var editor=this.parentThatIsA(VectorPaintEditorMorph),shape=editor.currentShape;if(shape){if(shape.isPolygon&&!shape.isFreeHand){shape.points.push(shape.points[shape.points.length-1].copy())}else if(shape.isPolygon){shape.close();shape.drawOn(this);editor.shapes.push(shape);editor.currentShape=null}else if(shape.isSelection){if(editor.selecting){shape.destination=pos;this.selectInside(shape);editor.selecting=false}else if(editor.moving||editor.resizing){editor.moving=false;editor.resizing=false;this.updateSelection()}else{this.selectAtPoint(pos)}}else if(shape.isCrosshair){this.rotationCenter=pos.subtract(this.bounds.origin)}else{shape.update(pos,editor.shift);editor.shapes.push(shape);editor.currentShape=null}}else if(this.currentTool==="selection"){this.selectAtPoint(pos)}editor.lastDragPosition=null;this.mouseEnter();editor.updateHistory()};VectorPaintCanvasMorph.prototype.mouseDoubleClick=function(pos){var editor=this.parentThatIsA(VectorPaintEditorMorph),shape=editor.currentShape;if(shape&&shape.isPolygon){shape.close();shape.drawOn(this);editor.shapes.push(shape);editor.currentShape=null;editor.updateHistory()}};VectorPaintCanvasMorph.prototype.beginShape=function(borderWidth,primaryColor,secondaryColor,pos){switch(this.currentTool){case"brush":this.beginPolygon(borderWidth,secondaryColor,null,pos,false,true);break;case"line":this.beginLine(borderWidth,secondaryColor,pos);break;case"rectangle":this.beginRectangle(borderWidth,secondaryColor,primaryColor,pos);break;case"ellipse":this.beginEllipse(borderWidth,secondaryColor,primaryColor,pos);break;case"polygon":this.beginPolygon(borderWidth,secondaryColor,primaryColor,pos,true,false);break;case"closedBrush":this.beginPolygon(borderWidth,secondaryColor,primaryColor,pos,true,true);break;case"selection":this.beginSelection(pos);break}};VectorPaintCanvasMorph.prototype.beginPolygon=function(borderWidth,borderColor,fillColor,origin,isClosed,isFreeHand){var editor=this.parentThatIsA(VectorPaintEditorMorph);editor.currentShape=new VectorPolygon(borderWidth,borderColor,fillColor,[origin],isClosed,isFreeHand)};VectorPaintCanvasMorph.prototype.beginLine=function(borderWidth,borderColor,origin){var editor=this.parentThatIsA(VectorPaintEditorMorph);editor.currentShape=new VectorLine(borderWidth,borderColor,origin,origin)};VectorPaintCanvasMorph.prototype.beginRectangle=function(borderWidth,borderColor,fillColor,origin){var editor=this.parentThatIsA(VectorPaintEditorMorph);editor.currentShape=new VectorRectangle(borderWidth,borderColor,fillColor,origin,origin)};VectorPaintCanvasMorph.prototype.beginEllipse=function(borderWidth,borderColor,fillColor,origin){var editor=this.parentThatIsA(VectorPaintEditorMorph);editor.currentShape=new VectorEllipse(borderWidth,borderColor,fillColor,origin,origin)};VectorPaintCanvasMorph.prototype.beginSelection=function(origin){var editor=this.parentThatIsA(VectorPaintEditorMorph);editor.currentShape=new VectorSelection(origin,origin);editor.selecting=true};VectorPaintCanvasMorph.prototype.selectInside=function(selectionShape){var selectionBounds=selectionShape.bounds(),editor=this.parentThatIsA(VectorPaintEditorMorph);editor.selection=editor.shapes.filter(function(eachShape){return selectionBounds.containsRectangle(eachShape.bounds())});if(editor.selection.length>0){selectionBounds=editor.getBounds(editor.selection);selectionShape.origin=selectionBounds.topLeft();selectionShape.destination=selectionBounds.bottomRight();selectionShape.drawOn(this)}else{editor.currentShape=null;this.redraw=true}};VectorPaintCanvasMorph.prototype.selectAtPoint=function(position){var editor=this.parentThatIsA(VectorPaintEditorMorph),shape=this.shapeAt(position),bounds,index;if(shape){if(editor.shift){index=editor.selection.indexOf(shape);if(index>-1){editor.selection.splice(index,1)}else{editor.selection.push(shape)}}else{editor.selection=[shape]}bounds=editor.getBounds(editor.selection)}if(bounds){editor.currentShape=new VectorSelection(bounds.topLeft(),bounds.bottomRight());editor.currentShape.drawOn(this)}else{editor.clearSelection()}};VectorPaintCanvasMorph.prototype.selectShapes=function(shapes){var editor=this.parentThatIsA(VectorPaintEditorMorph),bounds;if(shapes.length>0){bounds=editor.getBounds(shapes);editor.selection=shapes;editor.currentShape=new VectorSelection(bounds.topLeft(),bounds.bottomRight());editor.currentShape.drawOn(this)}};VectorPaintCanvasMorph.prototype.updateSelection=function(){var editor=this.parentThatIsA(VectorPaintEditorMorph);this.selectShapes(editor.selection)};VectorPaintCanvasMorph.prototype.shapeAt=function(position){var editor=this.parentThatIsA(VectorPaintEditorMorph);return detect(editor.shapes.slice().reverse(),function(shape){return shape.containsPoint(position)})};VectorPaintCanvasMorph.prototype.pasteAt=function(position){var editor=this.parentThatIsA(VectorPaintEditorMorph),myself=this,clipboard=editor.clipboard,delta,copies=[];if(clipboard.length>0){delta=position.subtract(clipboard[0].bounds().origin)}clipboard.forEach(function(shape){var copy=shape.copy();copy.moveBy(delta);editor.selection.push(copy);editor.shapes.push(copy);copy.drawOn(myself);copies.push(copy)});if(copies.length>0){this.selectShapes(copies);editor.updateHistory()}};VectorPaintCanvasMorph.prototype.floodfill=function(sourcepoint){var editor=this.parentThatIsA(VectorPaintEditorMorph),shape=this.shapeAt(sourcepoint.add(this.position()));if(shape){shape.setColor(editor.shift?this.settings.secondaryColor:this.settings.primaryColor,editor.shift);shape.drawOn(this)}};</script>
        <script>modules.video="2019-May-22";var VideoMotion;function VideoMotion(width,height){this.width=width;this.height=height;this.frameNumber=0;this.winSize=8;this.lastAnalyzedFrame=0;this.motionAmount=0;this.motionDirection=0;this.imageBuffer=new ArrayBuffer(this.width*this.height*2);this.curr=new Uint8ClampedArray(this.imageBuffer,0,this.width*this.height);this.prev=new Uint8ClampedArray(this.imageBuffer,this.width*this.height,this.width*this.height);this.threshold=30;this.amountScale=100;this.toDegree=180/Math.PI}VideoMotion.prototype.reset=function(width,height){this.width=width;this.height=height;this.frameNumber=0;this.lastAnalyzedFrame=0;this.imageBuffer=new ArrayBuffer(this.width*this.height*2);this.curr=new Uint8ClampedArray(this.imageBuffer,0,this.width*this.height);this.prev=new Uint8ClampedArray(this.imageBuffer,this.width*this.height,this.width*this.height)};VideoMotion.prototype.addFrame=function(imageData){var i,temp=this.prev,frame=new Uint32Array(imageData.buffer.slice(0));this.frameNumber++;this.prev=this.curr;this.curr=temp;for(i=0;i<frame.length;i++){this.curr[i]=frame[i]&255}};VideoMotion.prototype.getStageMotion=function(){var uu=0,vv=0,n=0,vector={u:0,v:0},i,j,address,nextAddress,maxAddress,winStep=this.winSize*2+1,wmax=this.width-this.winSize-1,hmax=this.height-this.winSize-1,A2,A1B2,B1,C1,C2,gradX,gradY,gradT;if(!this.curr||!this.prev){this.motionAmount=this.motionDirection=-1;return}if(this.lastAnalyzedFrame===this.frameNumber){return}this.lastAnalyzedFrame=this.frameNumber;for(i=this.winSize+1;i<hmax;i+=winStep){for(j=this.winSize+1;j<wmax;j+=winStep){A2=0;A1B2=0;B1=0;C1=0;C2=0;address=(i-this.winSize)*this.width+j-this.winSize;nextAddress=address+winStep;maxAddress=(i+this.winSize)*this.width+j+this.winSize;for(;address<=maxAddress;address+=this.width-winStep,nextAddress+=this.width){for(;address<=nextAddress;address+=1){gradT=this.prev[address]-this.curr[address];gradX=this.curr[address-1]-this.curr[address+1];gradY=this.curr[address-this.width]-this.curr[address+this.width];A2+=gradX*gradX;A1B2+=gradX*gradY;B1+=gradY*gradY;C2+=gradX*gradT;C1+=gradY*gradT}}vector=this.getMotionVector(A2,A1B2,B1,C2,C1);if(-winStep<vector.u&&vector.u<winStep&&-winStep<vector.v&&vector.v<winStep){uu+=vector.u;vv+=vector.v;n++}}}uu/=n;vv/=n;this.motionAmount=Math.round(this.amountScale*Math.hypot(uu,vv));if(this.motionAmount>this.threshold){this.motionDirection=((Math.atan2(vv,uu)*this.toDegree+270)%360-180).toFixed(2)}};VideoMotion.prototype.getMotionVector=function(A2,A1B2,B1,C2,C1){var norm,IGradNorm,delta=A1B2*A1B2-A2*B1,deltaX,deltaY,Idelta,motionVector={u:0,v:0};if(delta){deltaX=-(C1*A1B2-C2*B1);deltaY=-(A1B2*C2-A2*C1);Idelta=8/delta;motionVector.u=deltaX*Idelta;motionVector.v=deltaY*Idelta}else{norm=(A1B2+A2)*(A1B2+A2)+(B1+A1B2)*(B1+A1B2);if(norm){IGradNorm=8/norm;motionVector.u=(A1B2+A2)*(-(C1+C2)*IGradNorm);motionVector.v=(B1+A1B2)*(-(C1+C2)*IGradNorm)}else{motionVector.u=0;motionVector.v=0}}return motionVector};VideoMotion.prototype.getLocalMotion=function(aSprite){var stage=aSprite.parentThatIsA(StageMorph),activePixelNum=0,i,j,xmin,xmax,ymin,ymax,gradT,gradX,gradY,spriteWidth=Math.floor(aSprite.width()/stage.scale),winSize=this.winSize,vector={u:0,v:0},A2=0,A1B2=0,B1=0,C1=0,C2=0,localThreshold=this.threshold/3,localMaxAmount=100,localAmountScale=this.amountScale*2e-4,scaleFactor=0,address=0,spriteImage,cb,pixel;if(!this.curr||!this.prev){aSprite.motionAmount=aSprite.motionDirection=-1;return}if(aSprite.frameNumber!==this.frameNumber){spriteImage=aSprite.getImageData();cb=getClippedBounds(aSprite);xmin=Math.max(Math.floor((aSprite.left()-stage.left())/stage.scale),0);ymin=Math.max(Math.floor((aSprite.top()-stage.top())/stage.scale),0);xmax=Math.min(cb.sw+xmin,stage.dimensions.x);ymax=Math.min(cb.sh+ymin,stage.dimensions.y-1);pixel=cb.sy*spriteWidth+cb.sx;for(i=ymin;i<ymax;i++,pixel+=spriteWidth-cb.sw){for(j=xmin;j<xmax;j++,++pixel){if(j>0&&j<this.width&&i>0&&i<this.height&&(spriteImage[pixel]>>24&255)==255){address=i*this.width+j;gradT=this.prev[address]-this.curr[address];gradX=this.curr[address-1]-this.curr[address+1];gradY=this.curr[address-this.width]-this.curr[address+this.width];A2+=gradX*gradX;A1B2+=gradX*gradY;B1+=gradY*gradY;C2+=gradX*gradT;C1+=gradY*gradT;scaleFactor++}}}vector=this.getMotionVector(A2,A1B2,B1,C2,C1);if(scaleFactor){activePixelNum=scaleFactor;scaleFactor/=2*winSize*2*winSize;vector.u=vector.u/scaleFactor;vector.v=vector.v/scaleFactor}aSprite.motionAmount=Math.round(localAmountScale*activePixelNum*Math.hypot(vector.u,vector.v));if(aSprite.motionAmount>localMaxAmount){aSprite.motionAmount=Math.min(localMaxAmount,100)}if(aSprite.motionAmount>localThreshold){aSprite.motionDirection=((Math.atan2(vector.v,vector.u)*this.toDegree+270)%360-180).toFixed(2)}aSprite.frameNumber=this.frameNumber}function getClippedBounds(sprite){var stage=sprite.parentThatIsA(StageMorph),scale=stage.scale,bounds={sx:0,sy:0,sw:Math.floor(sprite.extent().x/scale),sh:Math.floor(sprite.extent().y/scale)};if(sprite.left()<stage.left()){bounds.sw=Math.max(Math.floor((sprite.right()-stage.left())/scale),0);bounds.sx=Math.floor(sprite.width()/scale-bounds.sw)}if(sprite.right()>stage.right()){bounds.sw=Math.max(Math.floor((stage.right()-sprite.left())/scale),0)}if(sprite.top()<stage.top()){bounds.sh=Math.max(Math.floor((sprite.bottom()-stage.top())/scale),0);bounds.sy=Math.floor(sprite.height()/scale-bounds.sh)}if(sprite.bottom()>stage.bottom()){bounds.sh=Math.max(Math.floor((stage.bottom()-sprite.top())/scale),0)}return bounds}};</script>
        <script>modules.maps="2021-June-15";function WorldMap(host){this.tileServers={OpenStreetMap:{url:"tile.openstreetmap.org",type:"zxy",subdomains:["a","b","c"],key:null,min:0,max:19,credits:"Map data © OpenStreetMap contributors"+"CC-BY-SA, Imagery © Mapnik"},Wikimedia:{url:"maps.wikimedia.org/osm-intl",type:"zxy",subdomains:null,key:null,min:0,max:19,credits:"Map data © OpenStreetMap contributors, "+"CC-BY-SA, Imagery © Wikimedia"},Watercolor:{url:"stamen-tiles.a.ssl.fastly.net/watercolor",type:"zxy",subdomains:null,key:null,min:0,max:20,credits:"Map data © OpenStreetMap contributors, "+"CC-BY-SA, Imagery © Stamen, CC-BY-3.0."},Toner:{url:"stamen-tiles.a.ssl.fastly.net/toner",type:"zxy",subdomains:null,key:null,min:0,max:20,credits:"Map data © OpenStreetMap contributors, "+"CC-BY-SA, Imagery © Stamen, CC-BY-3.0."},Terrain:{url:"stamen-tiles.a.ssl.fastly.net/terrain",type:"zxy",subdomains:null,key:null,min:0,max:16,credits:"Map data © OpenStreetMap contributors, "+"CC-BY-SA, Imagery © Stamen, CC-BY-3.0."},Topographic:{url:"tile.opentopomap.org",type:"zxy",subdomains:null,key:null,min:0,max:17,credits:"Map data © OpenStreetMap contributors, "+"CC-BY-SA, Imagery © Opentopomaps"},Satellite:{url:"services.arcgisonline.com/ArcGIS/rest/services/"+"World_Imagery/MapServer/tile",type:"zyx",subdomains:null,key:null,min:0,max:19,credits:"Imagery © ArcGIS"},Streets:{url:"services.arcgisonline.com/ArcGIS/rest/services/"+"World_Street_Map/MapServer/tile",type:"zyx",subdomains:null,key:null,min:0,max:19,credits:"Imagery © ArcGIS"},Shading:{url:"services.arcgisonline.com/ArcGIS/rest/services/"+"World_Topo_Map/MapServer/tile",type:"zyx",subdomains:null,key:null,min:0,max:19,credits:"Imagery © ArcGIS"},"Mapbox (experimental)":{url:"api.tiles.mapbox.com/v4/mapbox.streets",type:"zxy",subdomains:null,key:"?access_token="+"pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycX"+"BndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw",min:0,max:20,credits:"Map data © OpenStreetMap contributors, "+"CC-BY-SA, Imagery © Mapbox"}};this.api=this.tileServers[host||"OpenStreetMap"];this.lon=-122.257852;this.lat=37.872099;this.zoom=13;this.position=new Point(this.tileXfromLon(this.lon),this.tileYfromLat(this.lat));this.extent=new Point(480,360);this.tileSize=256;this.canvas=null;this.creditsTxt=null;this.creditsBG=null;this.initializeCredits();this.loading=0}WorldMap.prototype.setHost=function(host){this.api=this.tileServers[host||"Wikimedia"];this.initializeCredits();this.setZoom(this.zoom)};WorldMap.prototype.setView=function(lon,lat){this.lat=lat;this.lon=lon;this.refresh()};WorldMap.prototype.setZoom=function(num){this.zoom=Math.max(Math.min(this.api.max,Math.floor(num)),this.api.min);this.refresh()};WorldMap.prototype.panBy=function(x,y){this.lon=this.lonFromTileX(this.position.x+x/this.tileSize);this.lat=this.latFromTileY(this.position.y+y/this.tileSize);this.refresh()};WorldMap.prototype.refresh=function(){this.position=new Point(this.wrapTile(this.tileXfromLon(this.lon)),this.tileYfromLat(this.lat))};WorldMap.prototype.wrapTile=function(n){var max=Math.pow(2,this.zoom);return n<0?max+n:n%max};WorldMap.prototype.tileXfromLon=function(lon){return(parseFloat(lon)+180)/360*Math.pow(2,this.zoom)};WorldMap.prototype.tileYfromLat=function(lat){return(1-Math.log(Math.tan(parseFloat(lat)*Math.PI/180)+1/Math.cos(parseFloat(lat)*Math.PI/180))/Math.PI)/2*Math.pow(2,this.zoom)};WorldMap.prototype.lonFromTileX=function(x){return x/Math.pow(2,this.zoom)*360-180};WorldMap.prototype.latFromTileY=function(y){var n=Math.PI-2*Math.PI*y/Math.pow(2,this.zoom);return 180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))};WorldMap.prototype.lonFromSnapX=function(x){return this.lonFromTileX(this.position.x+x/this.tileSize)};WorldMap.prototype.latFromSnapY=function(y){return this.latFromTileY(this.position.y-y/this.tileSize)};WorldMap.prototype.snapXfromLon=function(lon){return(this.tileXfromLon(lon)-this.position.x)*this.tileSize};WorldMap.prototype.snapYfromLat=function(lat){return(this.tileYfromLat(lat)-this.position.y)*-this.tileSize};WorldMap.prototype.distanceInKm=function(lat1,lon1,lat2,lon2){var R=6371,dLat=radians(+lat2-lat1),dLon=radians(+lon2-lon1),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(radians(+lat1))*Math.cos(radians(+lat2))*Math.sin(dLon/2)*Math.sin(dLon/2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c};WorldMap.prototype.render=function(){var cntr=this.extent.divideBy(2),size=this.tileSize,tile=this.position.floor(),off=new Point(this.position.x%1,this.position.y%1).multiplyBy(size),tileOrigin=cntr.subtract(off),tileDistance=tileOrigin.floorDivideBy(size).add(1),tileGrid=this.extent.floorDivideBy(size).add(2),originTile=tile.subtract(tileDistance),mapOrigin=tileOrigin.subtract(tileDistance.multiplyBy(size)),sub=0,myself=this,max=Math.pow(2,this.zoom),x,y,img,ctx,tileX,tileY,coords;function ok(){myself.loading-=1;ctx.drawImage(this,mapOrigin.x+this.cx*size,mapOrigin.y+this.cy*size);crd()}function err(){myself.loading-=1;crd()}function crd(){if(!myself.loading){myself.addCredits()}}this.canvas=newCanvas(this.extent,true);ctx=this.canvas.getContext("2d");for(x=0;x<tileGrid.x;x+=1){for(y=0;y<tileGrid.y;y+=1){tileX=this.wrapTile(originTile.x+x);tileY=originTile.y+y;if(tileX>=0&&tileX<max&&(tileY>=0&&tileY<max)){img=new Image;img.cx=x;img.cy=y;img.crossOrigin="";img.onload=ok;img.onerror=err;myself.loading+=1;switch(this.api.type){case"zxy":coords=""+this.zoom+"/"+tileX+"/"+tileY;break;case"zyx":coords=""+this.zoom+"/"+tileY+"/"+tileX;break;case"xyz":coords=""+tileX+"/"+tileY+"/"+this.zoom;break}img.src="https://"+(this.api.subdomains?this.api.subdomains[sub]+".":"")+this.api.url+"/"+coords+".png"+(this.api.key||"");if(this.api.subdomains){sub+=1;if(sub===this.api.subdomains.length){sub=0}}}}}};WorldMap.prototype.initializeCredits=function(){var ctx;this.creditsTxt=new StringMorph(" "+this.api.credits+" ",8);this.creditsTxt.isCachingImage=true;this.creditsTxt.cachedImage=normalizeCanvas(this.creditsTxt.getImage(),true);this.creditsBG=newCanvas(this.creditsTxt.extent(),true);ctx=this.creditsBG.getContext("2d");ctx.fillStyle="white";ctx.fillRect(0,0,this.creditsBG.width,this.creditsBG.height)};WorldMap.prototype.addCredits=function(){var ctx=this.canvas.getContext("2d"),crd=this.creditsTxt.getImage();ctx.globalAlpha=.5;ctx.drawImage(this.creditsBG,this.canvas.width-crd.width,this.canvas.height-crd.height);ctx.globalAlpha=1;ctx.drawImage(crd,this.canvas.width-crd.width,this.canvas.height-crd.height)};</script>
        <script>modules.extensions="2022-July-11";var SnapExtensions={primitives:new Map,menus:new Map,scripts:[],urls:["libraries/","https://snap.berkeley.edu/","https://ecraft2learn.github.io/ai/","https://microworld.edc.org/"]};SnapExtensions.primitives.set("err_error(msg)",function(msg){throw new Error(msg,{cause:"user"})});SnapExtensions.primitives.set("err_try(cmd, catch, err)",function(action,exception,errVarName,proc){proc.tryCatch(action,exception,errVarName)});SnapExtensions.primitives.set("err_reset",function(proc){proc.resetErrorHandling()});SnapExtensions.primitives.set("err_ignore",nop);SnapExtensions.primitives.set("lst_sort(list, fn)",function(data,fn,proc){return proc.reportAtomicSort(data,fn)});SnapExtensions.primitives.set("lst_linked(list)",function(data){return data.isLinked});SnapExtensions.primitives.set("txt_lowercase(txt)",function(txt){return txt.toLowerCase()});SnapExtensions.primitives.set("txt_indexof(sub, txt)",function(sub,txt){return txt.indexOf(sub)+1});SnapExtensions.primitives.set("bit_and(a, b)",function(a,b){return a&b});SnapExtensions.primitives.set("bit_or(a, b)",function(a,b){return a|b});SnapExtensions.primitives.set("bit_xor(a, b)",function(a,b){return a^b});SnapExtensions.primitives.set("bit_not(a)",function(a){return~a});SnapExtensions.primitives.set("bit_left_shift(a, b)",function(a,b){return a<<b});SnapExtensions.primitives.set("bit_right_shift(a, b)",function(a,b){return a>>b});SnapExtensions.primitives.set("bit_unsigned_right_shift(a, b)",function(a,b){return a>>>b});SnapExtensions.primitives.set("dta_analyze(list)",function(list,proc){var dict=new Map,result=[],data=list.itemsArray(),len=data.length,item,i;for(i=0;i<len;i+=1){item=proc.reportIsA(data[i],"number")?data[i].toString():data[i];if(dict.has(item)){dict.set(item,dict.get(item)+1)}else{dict.set(item,1)}}dict.forEach(function(value,key){result.push(new List([key,value]))});return new List(result)});SnapExtensions.primitives.set("dta_group(list, fn)",function(data,fn,proc){return proc.reportAtomicGroup(data,fn)});SnapExtensions.primitives.set("dta_transpose(list)",function(data,proc){proc.assertType(data,"list");return data.transpose()});SnapExtensions.primitives.set("dta_crossproduct(list)",function(data,proc){proc.assertType(data,"list");return data.crossproduct()});SnapExtensions.primitives.set("map_zoom",function(){return this.parentThatIsA(StageMorph).worldMap.zoom});SnapExtensions.primitives.set("map_zoom(n)",function(num){this.parentThatIsA(StageMorph).worldMap.setZoom(num)});SnapExtensions.primitives.set("map_lon(x)",function(x){return this.parentThatIsA(StageMorph).worldMap.lonFromSnapX(x)});SnapExtensions.primitives.set("map_lat(y)",function(y){return this.parentThatIsA(StageMorph).worldMap.latFromSnapY(y)});SnapExtensions.primitives.set("map_view(lon, lat)",function(lon,lat){this.parentThatIsA(StageMorph).worldMap.setView(lon,lat)});SnapExtensions.primitives.set("map_y(lat)",function(lat){return this.parentThatIsA(StageMorph).worldMap.snapYfromLat(lat)});SnapExtensions.primitives.set("map_x(lon)",function(lon){return this.parentThatIsA(StageMorph).worldMap.snapXfromLon(lon)});SnapExtensions.primitives.set("map_pan(x, y)",function(x,y){this.parentThatIsA(StageMorph).worldMap.panBy(x,y)});SnapExtensions.primitives.set("map_dist(lat1, lon1, lat2, lon2)",function(lat1,lon1,lat2,lon2){return this.parentThatIsA(StageMorph).worldMap.distanceInKm(lat1,lon1,lat2,lon2)});SnapExtensions.primitives.set("map_update",function(){var stage=this.parentThatIsA(StageMorph);stage.worldMap.extent=stage.dimensions;stage.worldMap.render()});SnapExtensions.primitives.set("map_loaded",function(){return!this.parentThatIsA(StageMorph).worldMap.loading});SnapExtensions.primitives.set("map_costume",function(){return new Costume(this.parentThatIsA(StageMorph).worldMap.canvas,"map")});SnapExtensions.primitives.set("map_style(name)",function(name){this.parentThatIsA(StageMorph).worldMap.setHost(name)});SnapExtensions.primitives.set("tts_speak(txt, lang, pitch, rate)",function(msg,accent,pitch,rate){var utter=new SpeechSynthesisUtterance(msg),isDone=false;utter.lang=accent;utter.pitch=pitch;utter.rate=rate;utter.onend=()=>isDone=true;window.speechSynthesis.speak(utter);return()=>isDone});SnapExtensions.primitives.set("xhr_request(mth, url, dta, hdrs)",function(method,url,data,headers,proc){var response,i,header;url=decodeURI(url);Process.prototype.checkURLAllowed(url);if(!proc.httpRequest){proc.httpRequest=new XMLHttpRequest;proc.httpRequest.open(method,url,true);proc.assertType(headers,"list");for(i=1;i<=headers.length();i+=1){header=headers.at(i);proc.assertType(header,"list");proc.httpRequest.setRequestHeader(header.at(1),header.at(2))}proc.httpRequest.send(data||null)}else if(proc.httpRequest.readyState===4){response=proc.httpRequest.responseText;proc.httpRequest=null;return response}proc.pushContext("doYield");proc.pushContext()});SnapExtensions.primitives.set("geo_location(acc?)",function(includeAccuracy){var crd=new List,myself=this,options={enableHighAccuracy:true,timeout:5e3,maximumAge:0};function success(pos){crd=new List([pos.coords.latitude,pos.coords.longitude]);if(includeAccuracy){crd.add(pos.coords.accuracy)}}function error(err){crd=new List([37.872099,-122.257852]);myself.inform("Warning:\nGeolocation failed.")}navigator.geolocation.getCurrentPosition(success,error,options);return()=>crd});SnapExtensions.primitives.set("mda_snap",function(){var camDialog,result=false;camDialog=new CamSnapshotDialogMorph(this.parentThatIsA(IDE_Morph),this,()=>result=null,function(costume){result=costume;this.close()});camDialog.key="camera";camDialog.popUp(this.world());return()=>result});SnapExtensions.primitives.set("mda_record",function(){var soundRecorder,result=false;soundRecorder=new SoundRecorderDialogMorph(function(audio){if(audio){result=new Sound(audio,"recording")}else{result=null;this.destroy()}});soundRecorder.cancel=function(){result=null;this.destroy()};soundRecorder.key="microphone";soundRecorder.popUp(this.world());return()=>result});SnapExtensions.primitives.set("db_store(key, val)",function(key,value,proc){proc.assertType(key,["text","number"]);proc.assertType(value,["text","number"]);window.localStorage.setItem("-snap-project-"+key,""+value)});SnapExtensions.primitives.set("db_getall",function(){var str=window.localStorage,len=str.length,result=[],key,i;for(i=0;i<len;i+=1){key=str.key(i);if(key.startsWith("-snap-project-")){result.push(new List([key.slice(14),str.getItem(key)]))}}return new List(result)});SnapExtensions.primitives.set("db_remove(key)",function(key,proc){proc.assertType(key,["text","number"]);window.localStorage.removeItem("-snap-project-"+key)});SnapExtensions.primitives.set("db_get(key)",function(key){var str=window.localStorage,result=str.getItem("-snap-project-"+key);if(!result){return false}return result});SnapExtensions.primitives.set("obj_name(obj, name)",function(obj,name,proc){var ide=this.parentThatIsA(IDE_Morph);proc.assertType(obj,["sprite","stage","costume","sound"]);if(isSnapObject(obj)){obj.setName(ide.newSpriteName(name,obj));ide.recordUnsavedChanges()}else if(obj instanceof Costume){obj.name=this.newCostumeName(name,obj);obj.version=Date.now();ide.hasChangedMedia=true;ide.recordUnsavedChanges()}else if(obj instanceof Sound){obj.name=ide.newSoundName(name);ide.hasChangedMedia=true;ide.recordUnsavedChanges()}});SnapExtensions.primitives.set("cst_load(url)",function(url,proc){if(!proc.context.accumulator){proc.context.accumulator={img:new Image,cst:null};proc.context.accumulator.img.onload=function(){var canvas=newCanvas(new Point(this.width,this.height));canvas.getContext("2d").drawImage(this,0,0);proc.context.accumulator.cst=new Costume(canvas)};proc.context.accumulator.img.src=url}else if(proc.context.accumulator.cst){return proc.context.accumulator.cst}proc.pushContext("doYield");proc.pushContext()});SnapExtensions.primitives.set("cst_embed(cst, data)",function(cst,data,proc){var ide=this.parentThatIsA(IDE_Morph);proc.assertType(cst,"costume");proc.assertType(data,"text");if(cst instanceof SVG_Costume){throw new Error("option currently not supported for SVG costumes")}cst.embeddedData=data||null;cst.version=Date.now();ide.recordUnsavedChanges()});SnapExtensions.primitives.set("var_declare(scope, name)",function(scope,name,proc){var ide,frame;proc.assertType(name,"text");if(name===""){return}if(scope==="script"){frame=proc.context.isInCustomBlock()?proc.homeContext.variables:proc.context.outerContext.variables}else if(scope==="sprite"){frame=this.variables}else{frame=this.globalVariables()}if(frame.vars[name]===undefined){frame.addVar(name);ide=this.parentThatIsA(IDE_Morph);ide.flushBlocksCache("variables");ide.refreshPalette()}});SnapExtensions.primitives.set("var_names(scope)",function(scope,proc){var frame;if(scope==="script"){frame=proc.context.isInCustomBlock()?proc.homeContext.variables:proc.context.outerContext.variables}else if(scope==="sprite"){frame=this.variables}else{frame=this.globalVariables()}return new List(frame.allNames())});SnapExtensions.primitives.set("var_delete(name)",function(name,proc){var local;proc.assertType(name,"text");if(name===""){return}local=proc.context.isInCustomBlock()?proc.homeContext.variables:proc.context.outerContext.variables;if(local.vars[name]!==undefined){delete local.vars[name]}else if(this.deletableVariableNames().indexOf(name)>-1){this.deleteVariable(name)}});SnapExtensions.primitives.set("var_get(name)",function(name,proc){proc.assertType(name,"text");return proc.homeContext.variables.getVar(name)});SnapExtensions.primitives.set("var_set(name, val)",function(name,val,proc){var local;proc.assertType(name,"text");if(name===""){return}local=proc.context.isInCustomBlock()?proc.homeContext.variables:proc.context.outerContext.variables;local.setVar(name,val)});SnapExtensions.primitives.set("var_show(name)",function(name,proc){proc.doShowVar(name,proc.context.isInCustomBlock()?proc.homeContext:proc.context.outerContext)});SnapExtensions.primitives.set("var_hide(name)",function(name,proc){proc.doHideVar(name,proc.context.isInCustomBlock()?proc.homeContext:proc.context.outerContext)});SnapExtensions.primitives.set("var_showing(name)?",function(name,proc){var stage=this.parentThatIsA(StageMorph),frame=proc.context.isInCustomBlock()?proc.homeContext.variables:proc.context.outerContext.variables,target=frame.silentFind(name),watcher;if(!target){return false}watcher=detect(stage.children,morph=>morph instanceof WatcherMorph&&morph.target===target&&morph.getter===name);return watcher?watcher.isVisible:false});SnapExtensions.primitives.set("ide_hide(block)",function(context,proc){proc.assertType(context,["command","reporter","predicate"]);this.changeBlockVisibility(context.expression,true)});SnapExtensions.primitives.set("ide_show(block)",function(context,proc){proc.assertType(context,["command","reporter","predicate"]);this.changeBlockVisibility(context.expression,false)});SnapExtensions.primitives.set("ide_translate(text)",function(text,proc){if(proc.enableHyperOps){if(text instanceof List){return text.map(each=>SnapExtensions.primitives.get("ide_translate(text)")(each,proc))}}proc.assertType(text,["text","number"]);return localize(text)});SnapExtensions.primitives.set("ide_translateback(text)",function(text,proc){var dict;if(proc.enableHyperOps){if(text instanceof List){return text.map(each=>SnapExtensions.primitives.get("ide_translateback(text)")(each,proc))}}dict=SnapTranslator.dict[SnapTranslator.language];proc.assertType(text,["text","number"]);return detect(Object.keys(dict),key=>dict[key]===text)||text});SnapExtensions.primitives.set("ide_language()",function(){return SnapTranslator.language});SnapExtensions.primitives.set("ide_setlang(language, [msg])",function(lang,msg,proc){var ide=this.parentThatIsA(IDE_Morph),disabled=["receiveGo","receiveCondition","receiveMessage"],flag=ide.isAppMode,restoreMode=()=>ide.toggleAppMode(flag),callback=restoreMode;proc.assertType(lang,"text");ide.loadNewProject=false;if(isString(msg)&&!contains(disabled,proc.topBlock.selector)){callback=()=>{restoreMode();ide.broadcast(msg)}}ide.setLanguage(lang,callback,true)});SnapExtensions.primitives.set("ide_translations()",function(){return new List(SnapTranslator.languages().map(lang=>new List([SnapTranslator.languageName(lang),lang])))});SnapExtensions.primitives.set("clr_rgba(r, g, b, a)",function(r,g,b,a){return new Color(r,g,b,a)});SnapExtensions.primitives.set("clr_channel(clr, rgba)",function(clr,rgba){if(contains(["r","g","b","a"],rgba)){return clr[rgba]}throw new Error('unknown rgba color channel "'+rgba+'"')});SnapExtensions.primitives.set("clr_hsv(clr)",function(clr){return new List(clr.hsv())});SnapExtensions.primitives.set("clr_hsv(h, s, v)",function(h,s,v){var c=new Color;c.set_hsv(h,s,v);return c});SnapExtensions.primitives.set("clr_hsl(clr)",function(clr){return new List(clr.hsl())});SnapExtensions.primitives.set("clr_hsl(h, s, l)",function(h,s,l){var c=new Color;c.set_hsl(h,s,l);return c});SnapExtensions.primitives.set("clr_setpen(clr)",function(clr){this.setColor(clr)});SnapExtensions.primitives.set("clr_pen",function(){return this.color});SnapExtensions.primitives.set("srl_open(baud, buffer)",function(baud,buf,proc){var acc=proc.context.accumulator;async function forceClose(port){try{if(!port?.writable){return}if(port._reader){await port._reader.cancel()}if(port?.readable){await port.readable.cancel()}if(port?.writable){await port.writable.abort()}if(port?.writable){await port.close()}}catch(e){acc.result=e}}if(!acc){acc=proc.context.accumulator={result:false};(async function(baud){try{var port;port=await navigator.serial.requestPort();await forceClose(port);await port.open({baudRate:baud,bufferSize:buf||15e3});acc.result=port;port._bklog=[]}catch(e){acc.result=e}})(baud||115200)}else if(acc.result!==false){if(acc.result instanceof Error){throw acc.result}return acc.result}proc.pushContext("doYield");proc.pushContext()});SnapExtensions.primitives.set("srl_close(port)",function(port,proc){var acc=proc.context.accumulator;if(!acc){acc=proc.context.accumulator={result:false};(async function(port){try{if(port._reader){await port._reader.cancel()}if(port?.readable){await port.readable.cancel()}if(port?.writable){await port.writable.abort()}if(port?.readable||port?.writable){await port.close()}acc.result=true}catch(e){acc.result=e}})(port)}else if(acc.result!==false){if(acc.result instanceof Error){throw acc.result}return}proc.pushContext("doYield");proc.pushContext()});SnapExtensions.primitives.set("srl_read(port)",function(port,proc){var acc={result:false};if(!port?.readable){throw Error("Port not opened.")}if(port.readable?.locked){return port._bklog?.length>0?port._bklog.splice(0):true}(async function(port){var reader,data;try{reader=port._reader=port.readable.getReader();data=await reader.read();delete port._reader;if(data.value){port._bklog.push(...data.value)}}catch(e){await reader.cancel();acc.result=e}if(reader){await reader.releaseLock()}})(port);if(acc.result!==false){if(acc.result instanceof Error){throw acc.result}return acc.result}return port._bklog?.length>0?new List(Array.from(port._bklog.splice(0))):true});SnapExtensions.primitives.set("srl_write(port, bytes)",function(port,bytes,proc){var acc=proc.context.accumulator;if(!acc){acc=proc.context.accumulator={result:false};(async function(port,bytes){var writer;try{if(!port?.writable){throw Error("Port not opened.")}try{writer=port.writable.getWriter();await writer.write(Uint8Array.from(bytes.itemsArray()));acc.result=true}finally{await writer.close()}}catch(e){acc.result=e}})(port,bytes)}else if(acc.result!==false){if(acc.result instanceof Error){throw acc.result}return}proc.pushContext("doYield");proc.pushContext()});SnapExtensions.primitives.set("src_load(url)",function(url,proc){var scriptElement;if(!proc.context.accumulator){proc.context.accumulator={done:false};if(contains(SnapExtensions.scripts,url)){return}if(Process.prototype.enableJS||SnapExtensions.urls.some(any=>url.indexOf(any)===0)){scriptElement=document.createElement("script");scriptElement.onload=()=>{SnapExtensions.scripts.push(url);proc.context.accumulator.done=true};document.head.appendChild(scriptElement);scriptElement.src=url}else{throw new Error('unlisted extension url:\n"'+url+'"\n'+"JavaScript extensions for Snap!\nare turned off")}}else if(proc.context.accumulator.done){return}proc.pushContext("doYield");proc.pushContext()});SnapExtensions.menus.set("clr_numbers",function(){var menuName=this.parent.inputs()[0].evaluate(),output,menus={"color number":["0 black=0","14 white=14","20 spectral red=20","25 darkest red=25","30 saddle brown=30","35 darkest brown=35","40 spectral orange=40","45 darkest orange=45","50 spectral yellow=50","55 darkest yellow=55","60 spectral green=60","65 darkest green=65","70 spectral cyan=70","75 darkest cyan=75","80 spectral blue=80","85 darkest blue=85","90 spectral violet=90","95 magenta=95"],"fair hue":["0 red=0","12.5 brown=12.5","25 orange=25","37.5 yellow=37.5","50 green=50","62.5 cyan=62.5","75 blue=75","87.5 violet=87.5"],crayon:["grays",["0 black #000000=0","1 gray7 #121212=1","2 gray14 #242424=2","3 gray21 #363636=3","4 gray28 #484848=4","5 gray36 #5c5c5c=5","6 gray43 #6d6d6d=6","7 gray50 #7f7f7f=7","8 gray57 #919191=8","9 gray64 #a3a3a3=9","10 gray71 #b5b5b5=10","11 gray78 #c8c8c8=11","12 gray85 #dadada=12","13 gray92 #ececec=13","14 white #ffffff=14"],"pinks",["15 deep pink #ff1493=15","16 hot pink #ff69b4=16","17 bright pink #ff007f=17","18 raspberry #e30b5d=18","19 amaranth #e52b50=19"],"reds",["20 red #ff0000=20","21 burgundy #900020=21","22 cherry #990000=22","23 dark candy apple red #a40000=23","24 sanguine #c00000=24","25 maroon #800000=25","26 crimson #c90016=26","27 Lists #d94d11=27","28 candy apple red #ff0800=28","29 coquelicot #ff3800=29"],"browns",["30 saddle brown #8b4513=30","31 chocolate #7b3f00=31","32 kobicha #6b4423=32","33 sepia #704214=33","34 chestnut #954535=34","35 dark brown #654321=35","36 brown #964b00=36","37 golden brown #996515=37","38 cinnamon #b87333=38","39 copper #d2691e=39"],"oranges",["40 orange #ff7f00=40","41 Pantone orange #ff5800=41","42 pumpkin #ff7518=42","43 Variables #f3761d=43","44 Spanish orange #e86100=44","45 burnt orange #cc5500=45","46 sinopia #cb410b=46","47 ochre #cc7722=47","48 carrot #ed9121=48","49 tangerine #f28500=49"],"yellows",["50 yellow #ffff00=50","51 Control #e6a822=51","52 dark goldenrod #b8860b=52","53 goldenrod #daa520=53","54 saffron #f4c430=54","55 sandstorm #ecd540=55","56 mustard #ffdb58=56","57 gold #ffd700=57","58 egg yolk #fee33e=58","59 rubber duck #fbe108=59"],"greens",["60 lime #00ff00=60","61 apple green #8db600=61","62 Operators #62c213=62","63 forest green #228b22=63","64 green #008000=64","65 dark green #006400=65","66 dark pastel green #03c03c=66","67 emerald #50c878=67","68 mint #3eb489=68","69 Pen #00a178=69"],"cyans",["70 aqua (cyan) #00ffff=70","71 dark cyan #008b8b=71","72 cerulean #007ba7=72","73 iceberg #71a6d2=73","74 Sensing #0494dc=74","75 teal #008080=75","76 light sky blue #87cefa=76","77 deep sky blue #00bfff=77","78 dodger blue #1e90ff=78","79 azure #007fff=79"],"blues",["80 blue #0000ff=80","81 midnight blue #191970=81","82 dark powder blue #003399=82","83 cobalt #0047ab=83","84 denim #1560bd=84","85 navy blue #000080=85","86 steel blue #4682b4=86","87 Motion #4a6cd4=87","88 cornflower #6495ed=88","89 slate blue #6a5acd=89"],"purples",["90 violet #8000ff=90","91 Looks #8f56e3=91","92 grape #6f2da8=92","93 indigo #4b0082=93","94 x11 purple #a020f0=94","95 magenta (fuchia) #ff00ff=95","96 dark orchid #9932cc=96","97 Sound #cf4ad9=97","98 purple #7f007f=98","99 dark magenta #8b008b=99"]]};function makeMenuHelper(items,output){var i=0,label,possiblyNested,hasEquals,nestingOutput;while(i<items.length){label=items[i];possiblyNested=items[i+1];if(possiblyNested===undefined){hasEquals=label.split("=");if(hasEquals.length===2){output[hasEquals[0]]=hasEquals[1];i+=1}else if(hasEquals.length===3){output[hasEquals[0]+" "+"="+" "+hasEquals[2]]=hasEquals[0]+" "+"="+" "+hasEquals[2];i+=1}else{output[label]=label;i+=1}}else if(typeof possiblyNested=="string"){hasEquals=label.split("=");if(hasEquals.length==2){output[hasEquals[0]]=hasEquals[1];i+=1}else if(hasEquals.length==3){output[hasEquals[0]+" "+"="+" "+hasEquals[2]]=hasEquals[0]+" "+"="+" "+hasEquals[2];i+=1}else{output[label]=label;i+=1}}else if(Array.isArray(possiblyNested)){nestingOutput={};makeMenuHelper(possiblyNested,nestingOutput);output[label]=nestingOutput;i+=2}else{throw new Error("Bad value at index "+i)}}}try{output={};makeMenuHelper(menus[menuName],output);return output}catch(err){nop(err)}});</script>
        <script>modules.xml="2021-July-05";var ReadStream;var XML_Element;function ReadStream(arrayOrString){this.contents=arrayOrString||"";this.index=0}ReadStream.prototype.nonSpace=/\S|$/g;ReadStream.prototype.nonWord=/[\s\>\/\=]|$/g;ReadStream.prototype.next=function(count){var element,start;if(count===undefined){element=this.contents[this.index];this.index+=1;return element}start=this.index;this.index+=count;return this.contents.slice(start,this.index)};ReadStream.prototype.peek=function(){return this.contents[this.index]};ReadStream.prototype.skip=function(count){this.index+=count||1};ReadStream.prototype.atEnd=function(){return this.index>this.contents.length-1};ReadStream.prototype.upTo=function(str){var i=this.contents.indexOf(str,this.index);return i===-1?"":this.contents.slice(this.index,this.index=i)};ReadStream.prototype.peekUpTo=function(str){var i=this.contents.indexOf(str,this.index);return i===-1?"":this.contents.slice(this.index,i)};ReadStream.prototype.skipSpace=function(){this.nonSpace.lastIndex=this.index;var result=this.nonSpace.exec(this.contents);if(result)this.index=result.index};ReadStream.prototype.word=function(){this.nonWord.lastIndex=this.index;var result=this.nonWord.exec(this.contents);return result?this.contents.slice(this.index,this.index=result.index):""};XML_Element.prototype=Object.create(Node.prototype);XML_Element.prototype.constructor=XML_Element;XML_Element.uber=Node.prototype;XML_Element.prototype.indentation="  ";function XML_Element(tag,contents,parent){this.init(tag,contents,parent)}XML_Element.prototype.init=function(tag,contents,parent){this.tag=tag||"unnamed";this.attributes={};this.contents=contents||"";XML_Element.uber.init.call(this);if(parent)parent.addChild(this)};XML_Element.prototype.require=function(tagName,fallback){var child=this.childNamed(tagName);if(!child){if(fallback instanceof Function){return fallback()}if(!isNil(fallback)){return fallback}throw new Error("Missing required element <"+tagName+">!")}return child};XML_Element.prototype.childNamed=function(tagName){return detect(this.children,child=>child.tag===tagName)};XML_Element.prototype.childrenNamed=function(tagName){return this.children.filter(child=>child.tag===tagName)};XML_Element.prototype.parentNamed=function(tagName){if(this.tag===tagName){return this}if(!this.parent){return null}return this.parent.parentNamed(tagName)};XML_Element.prototype.toString=function(isFormatted,indentationLevel){var result="",indent="",level=indentationLevel||0,key,i;if(isFormatted){for(i=0;i<level;i+=1){indent+=this.indentation}result+=indent}result+="<"+this.tag;for(key in this.attributes){if(Object.prototype.hasOwnProperty.call(this.attributes,key)&&this.attributes[key]){result+=" "+key+'="'+this.escape(this.attributes[key])+'"'}}if(!this.contents.length&&!this.children.length){result+="/>"}else{result+=">";result+=this.escape(this.contents);this.children.forEach(element=>{if(isFormatted){result+="\n"}result+=element.toString(isFormatted,level+1)});if(isFormatted&&this.children.length){result+="\n"+indent}result+="</"+this.tag+">"}return result};XML_Element.prototype.escape=function(string,ignoreQuotes){var src=isNil(string)?"":string.toString(),result="",i,ch;for(i=0;i<src.length;i+=1){ch=src[i];switch(ch){case"'":result+="&apos;";break;case'"':result+=ignoreQuotes?ch:"&quot;";break;case"<":result+="&lt;";break;case">":result+="&gt;";break;case"&":result+="&amp;";break;case"\n":result+="&#xD;";break;case"~":result+="&#126;";break;default:result+=ch}}return result};XML_Element.prototype.unescape=function(string){return string.replace(/&(amp|apos|quot|lt|gt|#xD|#126);/g,(_,name)=>{switch(name){case"amp":return"&";case"apos":return"'";case"quot":return'"';case"lt":return"<";case"gt":return">";case"#xD":return"\n";case"#126":return"~";default:console.warn("unreachable")}})};XML_Element.prototype.parseString=function(string){var stream=new ReadStream(string);stream.upTo("<");stream.skip();this.parseStream(stream)};XML_Element.prototype.parseStream=function(stream){var key,value,ch,child;this.tag=stream.word();stream.skipSpace();ch=stream.peek();while(ch!==">"&&ch!=="/"){key=stream.word();stream.skipSpace();if(stream.next()!=="="){throw new Error('Expected "=" after attribute name')}stream.skipSpace();ch=stream.next();if(ch!=='"'&&ch!=="'"){throw new Error("Expected single- or double-quoted attribute value")}value=stream.upTo(ch);stream.skip(1);stream.skipSpace();this.attributes[key]=this.unescape(value);ch=stream.peek()}if(ch==="/"){stream.skip();if(stream.next()!==">"){throw new Error('Expected ">" after "/" in empty tag')}return}if(stream.next()!==">"){throw new Error('Expected ">" after tag name and attributes')}while(!stream.atEnd()){ch=stream.next();if(ch==="<"){if(stream.peek()==="/"){stream.skip();if(stream.word()!==this.tag){throw new Error("Expected to close "+this.tag)}stream.upTo(">");stream.skip();this.contents=this.unescape(this.contents);return}child=new XML_Element(null,null,this);child.parseStream(stream)}else{this.contents+=ch}}};</script>
        <script>modules.store="2022-August-01";function XML_Serializer(){this.contents=[];this.media=[];this.root={};this.isCollectingMedia=false;this.isExportingBlocksLibrary=false}XML_Serializer.prototype.idProperty="serializationID";XML_Serializer.prototype.mediaIdProperty="serializationMediaID";XML_Serializer.prototype.mediaDetectionProperty="isMedia";XML_Serializer.prototype.version=2;XML_Serializer.prototype.serialize=function(object,forBlocksLibrary){var xml;this.flush();this.flushMedia();this.isExportingBlocksLibrary=forBlocksLibrary;xml=this.store(object);this.flush();return xml};XML_Serializer.prototype.store=function(object,mediaID){if(isNil(object)||!object.toXML){return""}if(object instanceof Scene){this.root=object}if(this.isCollectingMedia&&object[this.mediaDetectionProperty]){this.addMedia(object,mediaID);return this.format('<ref mediaID="@"></ref>',object[this.mediaIdProperty])}if(object[this.idProperty]){return this.format('<ref id="@"></ref>',object[this.idProperty])}this.add(object);return object.toXML(this,mediaID).replace("~",this.format('id="@"',object[this.idProperty]))};XML_Serializer.prototype.mediaXML=function(){var xml="<media>";this.media.forEach(object=>{var str=object.toXML(this).replace("~",this.format('mediaID="@"',object[this.mediaIdProperty]));xml=xml+str});return xml+"</media>"};XML_Serializer.prototype.add=function(object){if(object[this.idProperty]){return-1}this.contents.push(object);object[this.idProperty]=this.contents.length;return this.contents.length};XML_Serializer.prototype.addMedia=function(object,mediaID){if(object[this.mediaIdProperty]){return-1}this.media.push(object);if(mediaID){object[this.mediaIdProperty]=mediaID+"_"+object.name}else{object[this.mediaIdProperty]=this.media.length}return this.media.length};XML_Serializer.prototype.at=function(integer){return this.contents[integer-1]};XML_Serializer.prototype.flush=function(){this.contents.forEach(obj=>delete obj[this.idProperty]);this.contents=[];this.root={}};XML_Serializer.prototype.flushMedia=function(){if(this.media instanceof Array){this.media.forEach(obj=>delete obj[this.mediaIdProperty])}this.media=[];this.isExportingBlocksLibrary=false};XML_Serializer.prototype.escape=XML_Element.prototype.escape;XML_Serializer.prototype.unescape=XML_Element.prototype.unescape;XML_Serializer.prototype.format=function(string){var i=-1,values=arguments,value;return string.replace(/[@$%]([\d]+)?/g,(spec,index)=>{index=parseInt(index,10);if(isNaN(index)){i+=1;value=values[i+1]}else{value=values[index+1]}return spec==="@"?this.escape(value):spec==="$"?this.escape(value,true):value})};XML_Serializer.prototype.load=function(xmlString){nop(xmlString);throw new Error("loading should be implemented in heir of XML_Serializer")};XML_Serializer.prototype.parse=function(xmlString,assertVersion){var element=new XML_Element;element.parseString(xmlString);if(assertVersion){if(+element.attributes.version>this.version){throw"Module uses newer version of Serializer"}}return element};var SnapSerializer;SnapSerializer.prototype=new XML_Serializer;SnapSerializer.prototype.constructor=SnapSerializer;SnapSerializer.uber=XML_Serializer.prototype;SnapSerializer.prototype.app="Snap! 7, https://snap.berkeley.edu";SnapSerializer.prototype.thumbnailSize=new Point(160,120);SnapSerializer.prototype.watcherLabels={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",reportShown:"shown?",getTempo:"tempo",getVolume:"volume",getPan:"balance",getPenDown:"pen down?",getLastAnswer:"answer",getLastMessage:"message",getTimer:"timer",getCostumeIdx:"costume #",reportMouseX:"mouse x",reportMouseY:"mouse y",reportThreadCount:"processes"};function SnapSerializer(){this.init()}SnapSerializer.prototype.init=function(){this.scene=new Scene;this.objects={};this.mediaDict={}};XML_Serializer.prototype.mediaXML=function(name){var xml='<media name="'+(name||"untitled")+'" app="'+this.app+'" version="'+this.version+'">';this.media.forEach(object=>{var str=object.toXML(this).replace("~",this.format('mediaID="@"',object[this.mediaIdProperty]));xml=xml+str});return xml+"</media>"};SnapSerializer.prototype.load=function(xmlString,ide){return this.loadProjectModel(this.parse(xmlString),ide)};SnapSerializer.prototype.loadProjectModel=function(xmlNode,ide,remixID){var appInfo=xmlNode.attributes.app,app=appInfo?appInfo.split(" ")[0]:null,scenesModel=xmlNode.childNamed("scenes"),project=new Project;if(ide&&app&&app!==this.app.split(" ")[0]){ide.inform(app+" Project","This project has been created by a different app:\n\n"+app+"\n\nand may be incompatible or fail to load here.")}if(scenesModel){if(scenesModel.attributes.select){project.sceneIdx=+scenesModel.attributes.select}scenesModel.childrenNamed("scene").forEach(model=>{ide.scene.captureGlobalSettings();project.scenes.add(this.loadScene(model));ide.scene.applyGlobalSettings()})}else{project.scenes.add(this.loadScene(xmlNode,remixID))}return project.initialize()};SnapSerializer.prototype.loadScene=function(xmlNode,remixID){var scene=new Scene,model,nameID;this.scene=scene;model={scene:xmlNode};if(+xmlNode.attributes.version>this.version){throw"Project uses newer version of Serializer"}this.objects={};scene.name=model.scene.attributes.name;if(!scene.name){nameID=1;while(Object.prototype.hasOwnProperty.call(localStorage,"-snap-project-Untitled "+nameID)){nameID+=1}scene.name="Untitled "+nameID}scene.unifiedPalette=model.scene.attributes.palette==="single";scene.showCategories=model.scene.attributes.categories!=="false";scene.showPaletteButtons=model.scene.attributes.buttons!=="false";scene.disableClickToRun=model.scene.attributes.clickrun==="false";scene.penColorModel=model.scene.attributes.colormodel==="hsl"?"hsl":"hsv";model.notes=model.scene.childNamed("notes");if(model.notes){scene.notes=model.notes.contents}model.palette=model.scene.childNamed("palette");if(model.palette){scene.customCategories=this.loadPalette(model.palette);SpriteMorph.prototype.customCategories=scene.customCategories}model.globalVariables=model.scene.childNamed("variables");model.stage=model.scene.require("stage");scene.stage.remixID=remixID;if(Object.prototype.hasOwnProperty.call(model.stage.attributes,"id")){this.objects[model.stage.attributes.id]=scene.stage}if(model.stage.attributes.name){scene.stage.name=model.stage.attributes.name}if(model.stage.attributes.color){scene.stage.color=this.loadColor(model.stage.attributes.color);scene.stage.cachedColorDimensions=scene.stage.color[SpriteMorph.prototype.penColorModel]()}if(model.stage.attributes.volume){scene.stage.volume=+model.stage.attributes.volume}if(model.stage.attributes.pan){scene.stage.pan=+model.stage.attributes.pan}if(model.stage.attributes.penlog){scene.enablePenLogging=model.stage.attributes.penlog==="true"}model.pentrails=model.stage.childNamed("pentrails");if(model.pentrails){scene.pentrails=new Image;scene.pentrails.onload=function(){if(scene.stage.trailsCanvas){normalizeCanvas(scene.stage.trailsCanvas);var context=scene.stage.trailsCanvas.getContext("2d");context.drawImage(scene.pentrails,0,0);scene.stage.changed()}};scene.pentrails.src=model.pentrails.contents}scene.stage.setTempo(model.stage.attributes.tempo);if(model.stage.attributes.width){scene.stage.dimensions.x=Math.max(+model.stage.attributes.width,240)}if(model.stage.attributes.height){scene.stage.dimensions.y=Math.max(+model.stage.attributes.height,180)}scene.stage.setExtent(scene.stage.dimensions);scene.useFlatLineEnds=model.stage.attributes.lines==="flat";BooleanSlotMorph.prototype.isTernary=model.stage.attributes.ternary!=="false";scene.enableHyperOps=model.stage.attributes.hyperops!=="false";scene.stage.isThreadSafe=model.stage.attributes.threadsafe==="true";scene.enableCodeMapping=model.stage.attributes.codify==="true";scene.enableInheritance=model.stage.attributes.inheritance!=="false";scene.enableSublistIDs=model.stage.attributes.sublistIDs==="true";model.hiddenPrimitives=model.scene.childNamed("hidden");if(model.hiddenPrimitives){model.hiddenPrimitives.contents.split(" ").forEach(sel=>{var selector,migration;if(sel){migration=SpriteMorph.prototype.blockMigrations[sel];selector=migration?migration.selector:sel;scene.hiddenPrimitives[selector]=true}})}model.codeHeaders=model.scene.childNamed("headers");if(model.codeHeaders){model.codeHeaders.children.forEach(xml=>scene.codeHeaders[xml.tag]=xml.contents)}model.codeMappings=model.scene.childNamed("code");if(model.codeMappings){model.codeMappings.children.forEach(xml=>scene.codeMappings[xml.tag]=xml.contents)}model.globalBlocks=model.scene.childNamed("blocks");if(model.globalBlocks){this.loadCustomBlocks(scene.stage,model.globalBlocks,true);this.populateCustomBlocks(scene.stage,model.globalBlocks,true)}this.loadObject(scene.stage,model.stage);model.sprites=model.stage.require("sprites");if(model.sprites.attributes.select){scene.spriteIdx=+model.sprites.attributes.select}scene.spritesDict[scene.stage.name]=scene.stage;model.sprites.childrenNamed("sprite").forEach(model=>this.loadValue(model));this.scene.stage.children.forEach(sprite=>{var exemplar,anchor;if(sprite.inheritanceInfo){exemplar=this.scene.spritesDict[sprite.inheritanceInfo.exemplar];if(exemplar){sprite.setExemplar(exemplar)}sprite.inheritedAttributes=sprite.inheritanceInfo.delegated||[];sprite.updatePropagationCache()}if(sprite.nestingInfo){anchor=this.scene.spritesDict[sprite.nestingInfo.anchor];if(anchor){anchor.attachPart(sprite)}sprite.rotatesWithAnchor=sprite.nestingInfo.synch==="true"}});this.scene.stage.children.forEach(sprite=>{var costume;if(sprite.nestingInfo){sprite.nestingScale=+(sprite.nestingInfo.scale||sprite.scale);delete sprite.nestingInfo}["scripts","costumes","sounds"].forEach(att=>{if(sprite.inheritsAttribute(att)){sprite.refreshInheritedAttribute(att)}});if(sprite.inheritsAttribute("costumes")){if(sprite.inheritsAttribute("costume #")){costume=sprite.exemplar.costume}else{costume=sprite.costumes.asArray()[sprite.inheritanceInfo.costumeNumber-1]}if(costume){if(costume.loaded){sprite.wearCostume(costume,true)}else{costume.loaded=function(){this.loaded=true;sprite.wearCostume(costume,true)}}}}delete sprite.inheritanceInfo});if(model.globalVariables){this.loadVariables(scene.globalVariables,model.globalVariables)}this.objects={};model.sprites.childrenNamed("watcher").forEach(model=>{var watcher,color,target,hidden,extX,extY;color=this.loadColor(model.attributes.color);target=Object.prototype.hasOwnProperty.call(model.attributes,"scope")?scene.spritesDict[model.attributes.scope]:null;hidden=Object.prototype.hasOwnProperty.call(model.attributes,"hidden")&&model.attributes.hidden!=="false";if(Object.prototype.hasOwnProperty.call(model.attributes,"var")){watcher=new WatcherMorph(model.attributes["var"],color,isNil(target)?scene.globalVariables:target.variables,model.attributes["var"],hidden)}else{watcher=new WatcherMorph(localize(this.watcherLabels[model.attributes.s]),color,target,model.attributes.s,hidden)}watcher.setStyle(model.attributes.style||"normal");if(watcher.style==="slider"){watcher.setSliderMin(model.attributes.min||"1",true);watcher.setSliderMax(model.attributes.max||"100",true)}watcher.setPosition(scene.stage.topLeft().add(new Point(+model.attributes.x||0,+model.attributes.y||0)).multiplyBy(scene.stage.scale));scene.stage.add(watcher);watcher.onNextStep=function(){this.currentValue=null};if(watcher.currentValue instanceof List&&watcher.cellMorph.contentsMorph){extX=model.attributes.extX;if(extX){watcher.cellMorph.contentsMorph.setWidth(+extX)}extY=model.attributes.extY;if(extY){watcher.cellMorph.contentsMorph.setHeight(+extY)}watcher.cellMorph.contentsMorph.handle.fixLayout()}});this.scene.stage.children.forEach(sprite=>sprite.inheritedMethodsCache=[]);this.objects={};return scene.initialize()};SnapSerializer.prototype.loadBlocks=function(xmlString,targetStage){var model=this.parse(xmlString);if(+model.attributes.version>this.version){throw"Module uses newer version of Serializer"}return this.loadBlocksModel(model,targetStage)};SnapSerializer.prototype.loadBlocksModel=function(model,targetStage){var stage;this.scene=new Scene;this.scene.targetStage=targetStage;stage=this.scene.stage;model.palette=model.childNamed("palette");if(model.palette){this.loadPalette(model.palette).forEach((value,key)=>SpriteMorph.prototype.customCategories.set(key,value))}model.removeChild(model.palette);this.loadCustomBlocks(stage,model,true);this.populateCustomBlocks(stage,model,true);model.local=model.childNamed("local");if(model.local){this.loadCustomBlocks(stage,model.local,false);this.populateCustomBlocks(stage,model.local,false)}this.objects={};stage.globalBlocks.forEach(def=>def.receiver=null);this.objects={};this.scene=new Scene;this.mediaDict={};return{global:stage.globalBlocks,local:stage.customBlocks}};SnapSerializer.prototype.loadSpritesModel=function(xmlNode,ide){var model=xmlNode,scene;this.scene=new Scene(ide.stage);scene=this.scene;scene.spritesDict[scene.stage.name]=scene.stage;model.childrenNamed("sprite").forEach(model=>{var sprite=new SpriteMorph(scene.globalVariables);if(model.attributes.id){this.objects[model.attributes.id]=sprite}if(model.attributes.name){sprite.name=ide.newSpriteName(model.attributes.name);scene.spritesDict[sprite.name]=sprite}if(model.attributes.color){sprite.color=this.loadColor(model.attributes.color);sprite.cachedColorDimensions=sprite.color[sprite.penColorModel]()}if(model.attributes.pen){sprite.penPoint=model.attributes.pen}if(model.attributes.volume){sprite.volume=+model.attributes.volume}if(model.attributes.pan){sprite.pan=+model.attributes.pan}scene.stage.add(sprite);ide.sprites.add(sprite);sprite.scale=parseFloat(model.attributes.scale||"1");sprite.rotationStyle=parseFloat(model.attributes.rotation||"1");sprite.isDraggable=model.attributes.draggable!=="false";sprite.isVisible=model.attributes.hidden!=="true";sprite.heading=parseFloat(model.attributes.heading)||0;sprite.gotoXY(+model.attributes.x||0,+model.attributes.y||0);this.loadObject(sprite,model);sprite.fixLayout();sprite.pauseGenericHatBlocks()});scene.stage.children.forEach(sprite=>{var exemplar,anchor;if(sprite.inheritanceInfo){exemplar=scene.spritesDict[sprite.inheritanceInfo.exemplar];if(exemplar){sprite.setExemplar(exemplar)}}if(sprite.nestingInfo){anchor=scene.spritesDict[sprite.nestingInfo.anchor];if(anchor){anchor.attachPart(sprite)}sprite.rotatesWithAnchor=sprite.nestingInfo.synch==="true"}});scene.stage.children.forEach(sprite=>{delete sprite.inheritanceInfo;if(sprite.nestingInfo){sprite.nestingScale=+(sprite.nestingInfo.scale||sprite.scale);delete sprite.nestingInfo}});this.objects={};this.scene=new Scene;this.mediaDict={};ide.stage.fixLayout();ide.stage.rerender();ide.createCorral();ide.fixLayout();ide.toggleAppMode(ide.isAppMode)};SnapSerializer.prototype.loadMedia=function(xmlString){return this.loadMediaModel(this.parse(xmlString))};SnapSerializer.prototype.loadMediaModel=function(xmlNode){var model=xmlNode;this.mediaDict={};if(+model.attributes.version>this.version){throw"Module uses newer version of Serializer"}model.children.forEach(model=>this.loadValue(model));return this.mediaDict};SnapSerializer.prototype.loadObject=function(object,model){var blocks=model.require("blocks"),dispatches=model.childNamed("dispatches"),node,costume;if(model.attributes.instrument){object.instrument=+model.attributes.instrument}this.loadInheritanceInfo(object,model);this.loadNestingInfo(object,model);node=model.childNamed("wear");if(node){node=node.childNamed("costume")||node.childNamed("ref");if(!node){console.log(object.name+": missing costume to wear")}else{costume=this.loadValue(node,object);if(costume.loaded){object.wearCostume(costume,true)}else{costume.loaded=function(){this.loaded=true;object.wearCostume(costume,true)}}}}if(!(object.inheritanceInfo&&object.inheritanceInfo.delegated instanceof Array&&contains(object.inheritanceInfo.delegated,"costumes"))){this.loadCostumes(object,model)}if(!(object.inheritanceInfo&&object.inheritanceInfo.delegated instanceof Array&&contains(object.inheritanceInfo.delegated,"sounds"))){this.loadSounds(object,model)}this.loadCustomBlocks(object,blocks);if(dispatches){this.loadCustomBlocks(object,dispatches,false,true)}this.populateCustomBlocks(object,blocks);this.loadVariables(object.variables,model.require("variables"),object);if(!(object.inheritanceInfo&&object.inheritanceInfo.delegated instanceof Array&&contains(object.inheritanceInfo.delegated,"scripts"))){this.loadScripts(object,object.scripts,model.require("scripts"))}};SnapSerializer.prototype.loadInheritanceInfo=function(object,model){var info=model.childNamed("inherit"),delegated;if(info){object.inheritanceInfo=info.attributes;delegated=info.childNamed("list");if(delegated){object.inheritanceInfo.delegated=this.loadValue(delegated).asArray()}object.inheritanceInfo.costumeNumber=model.attributes.costume}};SnapSerializer.prototype.loadNestingInfo=function(object,model){var info=model.childNamed("nest");if(info){object.nestingInfo=info.attributes}};SnapSerializer.prototype.loadCostumes=function(object,model){var costumes=model.childNamed("costumes"),costume;if(costumes){object.costumes=this.loadValue(costumes.require("list",function(){console.log(object.name+": missing required costumes list, "+"improvising...");return new XML_Element("list")}));object.costumes.type="costume"}if(Object.prototype.hasOwnProperty.call(model.attributes,"costume")){costume=object.costumes.asArray()[model.attributes.costume-1];if(costume){if(costume.loaded){object.wearCostume(costume,true)}else{costume.loaded=function(){this.loaded=true;object.wearCostume(costume,true)}}}}};SnapSerializer.prototype.loadSounds=function(object,model){var sounds=model.childNamed("sounds");if(sounds){object.sounds=this.loadValue(sounds.require("list",function(){console.log(object.name+": missing required sounds list, "+"improvising...");return new XML_Element("list")}));object.sounds.type="sound"}};SnapSerializer.prototype.loadVariables=function(varFrame,element,object){element.children.forEach(child=>{var v,value;if(child.tag!=="variable"){return}value=child.children[0];v=new Variable;v.isTransient=child.attributes.transient==="true";v.isHidden=child.attributes.hidden==="true";v.value=v.isTransient||!value?0:this.loadValue(value,object);varFrame.vars[child.attributes.name]=v})};SnapSerializer.prototype.loadCustomBlocks=function(object,element,isGlobal,isDispatch){element.children.forEach(child=>{var definition,names,inputs,vars,header,code,trans,comment,i;if(child.tag!=="block-definition"){return}definition=new CustomBlockDefinition(child.attributes.s||"",object);definition.category=child.attributes.category||"other";if(!SpriteMorph.prototype.allCategories().includes(definition.category)){definition.category="other"}definition.type=child.attributes.type||"command";definition.isHelper=child.attributes.helper==="true"||false;definition.isGlobal=isGlobal===true;if(isDispatch){object.inheritedMethodsCache.push(definition)}else{if(definition.isGlobal){object.globalBlocks.push(definition)}else{object.customBlocks.push(definition)}}names=definition.parseSpec(definition.spec).filter(str=>str.charAt(0)==="%"&&str.length>1).map(str=>str.substr(1));definition.names=names;inputs=child.childNamed("inputs");if(inputs){i=-1;inputs.children.forEach(child=>{var options=child.childNamed("options");if(child.tag!=="input"){return}i+=1;definition.declarations.set(names[i],[child.attributes.type,contains(["%b","%boolUE"],child.attributes.type)?child.contents?child.contents==="true":null:child.contents,options?options.contents:undefined,child.attributes.readonly==="true"])})}vars=child.childNamed("variables");if(vars){definition.variableNames=this.loadValue(vars.require("list")).asArray()}header=child.childNamed("header");if(header){definition.codeHeader=header.contents}code=child.childNamed("code");if(code){definition.codeMapping=code.contents}trans=child.childNamed("translations");if(trans){definition.updateTranslations(trans.contents)}comment=child.childNamed("comment");if(comment){definition.comment=this.loadComment(comment)}})};SnapSerializer.prototype.populateCustomBlocks=function(object,element,isGlobal){element.children.forEach((child,index)=>{var definition,script,scripts;if(child.tag!=="block-definition"){return}definition=isGlobal?object.globalBlocks[index]:object.customBlocks[index];script=child.childNamed("script");if(script){definition.body=new Context(null,script?this.loadScript(script,object):null,null,object);definition.body.inputs=definition.names.slice(0)}scripts=child.childNamed("scripts");if(scripts){definition.scripts=this.loadScriptsArray(scripts,object)}delete definition.names})};SnapSerializer.prototype.loadScripts=function(object,scripts,model){var scale=SyntaxElementMorph.prototype.scale;scripts.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture;model.children.forEach(child=>{var element;if(child.tag==="script"){element=this.loadScript(child,object);if(!element){return}element.setPosition(new Point((+child.attributes.x||0)*scale,(+child.attributes.y||0)*scale).add(scripts.topLeft()));scripts.add(element);element.fixBlockColor(null,true);element.allComments().forEach(comment=>comment.align(element))}else if(child.tag==="comment"){element=this.loadComment(child);if(!element){return}element.setPosition(new Point((+child.attributes.x||0)*scale,(+child.attributes.y||0)*scale).add(scripts.topLeft()));scripts.add(element)}})};SnapSerializer.prototype.loadScriptsArray=function(model,object){var scale=SyntaxElementMorph.prototype.scale,scripts=[];model.children.forEach(child=>{var element;if(child.tag==="script"){element=this.loadScript(child,object);if(!element){return}element.setPosition(new Point((+child.attributes.x||0)*scale,(+child.attributes.y||0)*scale));scripts.push(element);element.fixBlockColor(null,true)}else if(child.tag==="comment"){element=this.loadComment(child);if(!element){return}element.setPosition(new Point((+child.attributes.x||0)*scale,(+child.attributes.y||0)*scale));scripts.push(element)}});return scripts};SnapSerializer.prototype.loadScriptModel=function(model,object){var script;this.scene=new Scene(object.parentThatIsA(StageMorph));script=this.loadScript(model,object);this.scene=new Scene;return script};SnapSerializer.prototype.loadScript=function(model,object){var topBlock,block,nextBlock;if(!this.scene.stage){this.scene.stage=object.parentThatIsA(StageMorph);this.scene.targetStage=this.scene.stage}model.children.forEach(child=>{nextBlock=this.loadBlock(child,false,object);if(!nextBlock){return}if(block){if(block.nextBlock&&nextBlock instanceof CommandBlockMorph){block.nextBlock(nextBlock)}else{console.log("SNAP: expecting a command but getting a reporter:\n"+"  "+block.blockSpec+"\n"+"  "+nextBlock.blockSpec);return topBlock}}else{topBlock=nextBlock}block=nextBlock});return topBlock};SnapSerializer.prototype.loadComment=function(model){var comment=new CommentMorph(model.contents),scale=SyntaxElementMorph.prototype.scale;comment.isCollapsed=model.attributes.collapsed==="true";comment.setTextWidth(+model.attributes.w*scale);return comment};SnapSerializer.prototype.loadBlock=function(model,isReporter,object){var block,info,inputs,isGlobal,receiver,migration,migrationOffset=0,migratoToVariadic=false;if(model.tag==="block"){if(Object.prototype.hasOwnProperty.call(model.attributes,"var")){block=SpriteMorph.prototype.variableBlock(model.attributes["var"])}else{block=SpriteMorph.prototype.blockForSelector(model.attributes.s);migration=SpriteMorph.prototype.blockMigrations[model.attributes.s];if(migration){migrationOffset=migration.offset||0;migratoToVariadic=migration.variadic}}}else if(model.tag==="custom-block"){isGlobal=model.attributes.scope?false:true;receiver=isGlobal?this.scene.stage:object;if(isGlobal){info=detect(receiver.globalBlocks,block=>block.blockSpec()===model.attributes.s);if(!info&&this.scene.targetStage){info=detect(this.scene.targetStage.globalBlocks,block=>block.blockSpec()===model.attributes.s)}}else{info=detect(receiver.customBlocks,block=>block.blockSpec()===model.attributes.s)||(receiver.inheritedMethodsCache?detect(receiver.inheritedMethodsCache,block=>block.blockSpec()===model.attributes.s):null)}if(!info||!contains(SpriteMorph.prototype.allCategories(),info.category)){return this.obsoleteBlock(isReporter)}block=info.type==="command"?new CustomCommandBlockMorph(info,false):new CustomReporterBlockMorph(info,info.type==="predicate",false)}if(block===null){block=this.obsoleteBlock(isReporter)}block.isDraggable=true;inputs=block.inputs();model.children.forEach((child,i)=>{if(child.tag==="variables"){this.loadVariables(block.variables,child,object)}else if(child.tag==="comment"){block.comment=this.loadComment(child);block.comment.block=block}else if(child.tag==="receiver"){nop()}else{if(migratoToVariadic){this.loadInput(child,inputs[0].inputs()[i],inputs[0],object)}else{this.loadInput(child,inputs[i+migrationOffset],block,object)}}});block.cachedInputs=null;return block};SnapSerializer.prototype.obsoleteBlock=function(isReporter){var block=isReporter?new ReporterBlockMorph:new CommandBlockMorph;block.selector="errorObsolete";block.color=new Color(200,0,20);block.setSpec("Undefined!");block.isDraggable=true;return block};SnapSerializer.prototype.loadInput=function(model,input,block,object){var inp,val;if(isNil(input)){return}if(model.tag==="script"){inp=this.loadScript(model,object);if(inp){if(block.selector==="reifyReporter"||block.selector==="reifyPredicate"){input.replaceInput(input.children[0],inp);input.fixLayout()}else{input.add(inp);input.fixLayout()}}}else if(model.tag==="autolambda"&&model.children[0]){inp=this.loadBlock(model.children[0],true,object);if(inp){input.replaceInput(input.children[0],inp);input.fixLayout()}}else if(model.tag==="list"){while(input.inputs().length>0&&input.removeInput){input.removeInput()}model.children.forEach(item=>{input.addInput();this.loadInput(item,input.children[input.children.length-2],input,object)});input.fixLayout()}else if(model.tag==="block"||model.tag==="custom-block"){if(input.slotSpec==="%rcv"){input.replaceInput(input.inputs()[0],this.loadBlock(model,true,object))}else{block.replaceInput(input,this.loadBlock(model,true,object))}}else if(model.tag==="color"){input.setColor(this.loadColor(model.contents))}else{val=this.loadValue(model);if(!isNil(val)&&!isNil(input)&&input.setContents){input.setContents(this.loadValue(model))}}};SnapSerializer.prototype.loadValue=function(model,object){var v,i,lst,items,el,center,image,name,audio,option,bool,origin,wish,def,myself=this;function record(){if(Object.prototype.hasOwnProperty.call(model.attributes,"id")){myself.objects[model.attributes.id]=v}if(Object.prototype.hasOwnProperty.call(model.attributes,"mediaID")){myself.mediaDict[model.attributes.mediaID]=v}}switch(model.tag){case"ref":if(Object.prototype.hasOwnProperty.call(model.attributes,"id")){return this.objects[model.attributes.id]}if(Object.prototype.hasOwnProperty.call(model.attributes,"mediaID")){return this.mediaDict[model.attributes.mediaID]}throw new Error("expecting a reference id");case"l":option=model.childNamed("option");if(option){return[option.contents]}bool=model.childNamed("bool");if(bool){return this.loadValue(bool)}wish=model.childNamed("wish");if(wish){return this.loadValue(wish)}return model.contents;case"bool":return model.contents==="true";case"list":if(model.attributes.hasOwnProperty("linked")){if(model.attributes.struct==="atomic"){v=Process.prototype.parseCSV(model.contents);v.becomeLinked();record();return v}v=new List;v.isLinked=true;record();lst=v;items=model.childrenNamed("item");items.forEach((item,i)=>{var value=item.children[0];if(!value){v.first=0}else{v.first=this.loadValue(value,object)}var tail=model.childNamed("list")||model.childNamed("ref");if(tail){v.rest=this.loadValue(tail,object)}else{if(i<items.length-1){v.rest=new List;v=v.rest;v.isLinked=true}}});return lst}if(model.attributes.struct==="atomic"){v=Process.prototype.parseCSV(model.contents);record();return v}v=new List;record();v.contents=model.childrenNamed("item").map(item=>{var value=item.children[0];if(!value){return 0}return this.loadValue(value,object)});return v;case"sprite":v=new SpriteMorph(this.scene.globalVariables);if(model.attributes.id){this.objects[model.attributes.id]=v}if(model.attributes.name){v.name=model.attributes.name;this.scene.spritesDict[model.attributes.name]=v}if(model.attributes.idx){v.idx=+model.attributes.idx}if(model.attributes.color){v.color=this.loadColor(model.attributes.color);v.cachedColorDimensions=v.color[v.penColorModel]()}if(model.attributes.pen){v.penPoint=model.attributes.pen}if(model.attributes.volume){v.volume=+model.attributes.volume}if(model.attributes.pan){v.pan=+model.attributes.pan}this.scene.stage.add(v);v.scale=parseFloat(model.attributes.scale||"1");v.rotationStyle=parseFloat(model.attributes.rotation||"1");v.isDraggable=model.attributes.draggable!=="false";v.isVisible=model.attributes.hidden!=="true";v.heading=parseFloat(model.attributes.heading)||0;v.gotoXY(+model.attributes.x||0,+model.attributes.y||0);this.loadObject(v,model);v.fixLayout();return v;case"context":v=new Context(null);record();el=model.childNamed("origin");if(el){el=el.childNamed("ref")||el.childNamed("sprite");if(el){v.origin=this.loadValue(el)}}el=model.childNamed("receiver");if(el){el=el.childNamed("ref")||el.childNamed("sprite");if(el){v.receiver=this.loadValue(el)}}origin=v.origin||v.receiver||object;el=model.childNamed("script");if(el){v.expression=this.loadScript(el,origin)}else{el=model.childNamed("block")||model.childNamed("custom-block");if(el){v.expression=this.loadBlock(el,null,origin)}else{el=model.childNamed("l");if(el){bool=el.childNamed("bool");if(bool){v.expression=new BooleanSlotMorph(this.loadValue(bool))}else{v.expression=new InputSlotMorph(el.contents)}}}}if(v.expression instanceof BlockMorph){i=0;v.expression.allEmptySlots().forEach(slot=>{i+=1;if(slot instanceof MultiArgMorph){slot.bindingID=["arguments"]}else{slot.bindingID=i}});v.emptySlots=i}el=model.childNamed("inputs");if(el){el.children.forEach(item=>{if(item.tag==="input"){v.inputs.push(item.contents)}})}el=model.childNamed("variables");if(el){this.loadVariables(v.variables,el,origin)}el=model.childNamed("context");if(el){v.outerContext=this.loadValue(el,origin)}if(v.outerContext&&v.receiver&&!v.outerContext.variables.parentFrame){v.outerContext.variables.parentFrame=v.receiver.variables}return v;case"costume":center=new Point;if(Object.prototype.hasOwnProperty.call(model.attributes,"center-x")){center.x=parseFloat(model.attributes["center-x"])}if(Object.prototype.hasOwnProperty.call(model.attributes,"center-y")){center.y=parseFloat(model.attributes["center-y"])}if(Object.prototype.hasOwnProperty.call(model.attributes,"name")){name=model.attributes.name}if(Object.prototype.hasOwnProperty.call(model.attributes,"image")){image=new Image;if(model.attributes.image.indexOf("data:image/svg+xml")===0&&!MorphicPreferences.rasterizeSVGs){v=new SVG_Costume(null,name,center);image.onload=function(){v.contents=image;v.version=+new Date;if(typeof v.loaded==="function"){v.loaded()}else{v.loaded=true}}}else{v=new Costume(null,name,center);image.onload=function(){var canvas=newCanvas(new Point(image.width,image.height),true),context=canvas.getContext("2d");context.drawImage(image,0,0);v.contents=canvas;v.version=+new Date;if(Object.prototype.hasOwnProperty.call(model.attributes,"embed")){v.embeddedData=model.attributes.embed}if(typeof v.loaded==="function"){v.loaded()}else{v.loaded=true}}}image.src=model.attributes.image}record();return v;case"sound":audio=new Audio;v=new Sound(audio,model.attributes.name);audio.oncanplaythrough=()=>v.loaded=true;audio.src=model.attributes.sound;if(Object.prototype.hasOwnProperty.call(model.attributes,"mediaID")){this.mediaDict[model.attributes.mediaID]=v}record();return v;case"wish":def=new CustomBlockDefinition(model.attributes.s);def.type=model.attributes.type;def.category=model.attributes.category;def.storedSemanticSpec=model.attributes.s;def.updateTranslations(model.contents);return def.blockInstance(true)}return undefined};SnapSerializer.prototype.loadColor=function(colorString){var c=(colorString||"").split(",");return new Color(parseFloat(c[0]),parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3]))};SnapSerializer.prototype.loadPalette=function(model){var p=new Map;model.childrenNamed("category").forEach(node=>p.set(node.attributes.name,this.loadColor(node.attributes.color)));return p};SnapSerializer.prototype.paletteToXML=function(aMap){var xml;if(aMap.size===0){return""}xml="<palette>";aMap.forEach((value,key)=>{xml+=this.format('<category name="@" color="%,%,%,%"/>',key,value.r,value.g,value.b,value.a)});xml+="</palette>";return xml};Array.prototype.toXML=function(serializer){return this.reduce((xml,item)=>xml+serializer.store(item),"")};Project.prototype.toXML=function(serializer){var thumbdata;try{thumbdata=this.thumbnail.toDataURL("image/png")}catch(error){thumbdata=null}return serializer.format('<project name="@" app="@" version="@">'+"<notes>$</notes>"+"<thumbnail>$</thumbnail>"+'<scenes select="@">%</scenes>'+"</project>",this.name||localize("Untitled"),serializer.app,serializer.version,this.notes||"",thumbdata,this.scenes.asArray().indexOf(this.currentScene)+1,serializer.store(this.scenes.itemsArray()))};Scene.prototype.toXML=function(serializer){var xml;function code(key){var str="";Object.keys(StageMorph.prototype[key]).forEach(selector=>{str+="<"+selector+">"+XML_Element.prototype.escape(StageMorph.prototype[key][selector])+"</"+selector+">"});return str}serializer.scene=this;xml=serializer.format('<scene name="@"%%%%%>'+"<notes>$</notes>"+"%"+"<hidden>$</hidden>"+"<headers>%</headers>"+"<code>%</code>"+"<blocks>%</blocks>"+"%"+"<variables>%</variables>"+"</scene>",this.name||localize("Untitled"),this.unifiedPalette?' palette="single"':"",this.unifiedPalette&&!this.showCategories?' categories="false"':"",this.unifiedPalette&&!this.showPaletteButtons?' buttons="false"':"",this.disableClickToRun?' clickrun="false"':"",this.penColorModel==="hsl"?' colormodel="hsl"':"",this.notes||"",serializer.paletteToXML(this.customCategories),Object.keys(this.hiddenPrimitives).reduce((a,b)=>a+" "+b,""),code("codeHeaders"),code("codeMappings"),serializer.store(this.stage.globalBlocks),serializer.store(this.stage),serializer.store(this.globalVariables));return xml};StageMorph.prototype.toXML=function(serializer){var costumeIdx=this.getCostumeIdx();this.removeAllClones();return serializer.format('<stage name="@" width="@" height="@" '+'costume="@" color="@,@,@,@" tempo="@" threadsafe="@" '+'penlog="@" '+"%"+'volume="@" '+'pan="@" '+'lines="@" '+'ternary="@" '+'hyperops="@" '+'codify="@" '+'inheritance="@" '+'sublistIDs="@" ~>'+"<pentrails>$</pentrails>"+"%"+"<costumes>%</costumes>"+"<sounds>%</sounds>"+"<variables>%</variables>"+"<blocks>%</blocks>"+"<scripts>%</scripts>"+'<sprites select="@">%</sprites>'+"</stage>",this.name,this.dimensions.x,this.dimensions.y,costumeIdx,this.color.r,this.color.g,this.color.b,this.color.a,this.getTempo(),this.isThreadSafe,this.enablePenLogging,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",this.volume,this.pan,SpriteMorph.prototype.useFlatLineEnds?"flat":"round",BooleanSlotMorph.prototype.isTernary,Process.prototype.enableHyperOps===true,this.enableCodeMapping,this.enableInheritance,this.enableSublistIDs,normalizeCanvas(this.trailsCanvas,true).toDataURL("image/png"),!costumeIdx&&this.costume?"<wear>"+serializer.store(this.costume)+"</wear>":"",serializer.store(this.costumes,this.name+"_cst"),serializer.store(this.sounds,this.name+"_snd"),serializer.store(this.variables),serializer.store(this.customBlocks),serializer.store(this.scripts),serializer.root.sprites.asArray().indexOf(serializer.root.currentSprite)+1,serializer.store(this.children))};StageMorph.prototype.toSpriteXML=function(serializer){var costumeIdx=this.getCostumeIdx();return serializer.format('<sprite name="@" idx="1" x="0" y="0"'+' heading="90"'+' scale="1"'+' volume="@"'+' pan="@"'+' rotation="0"'+"%"+' draggable="true"'+' costume="@" color="80,80,80,1" pen="tip" ~>'+"%"+"<costumes>%</costumes>"+"<sounds>%</sounds>"+"<blocks>%</blocks>"+"<variables>%</variables>"+"<scripts>%</scripts>"+"</sprite>",this.name,this.volume,this.pan,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",costumeIdx,!costumeIdx&&this.costume?"<wear>"+serializer.store(this.costume)+"</wear>":"",serializer.store(this.costumes,this.name+"_cst"),serializer.store(this.sounds,this.name+"_snd"),!this.customBlocks?"":serializer.store(this.customBlocks),serializer.store(this.variables),serializer.store(this.scripts))};SpriteMorph.prototype.toXML=function(serializer){var idx=serializer.scene.sprites.asArray().indexOf(this)+1,costumeIdx=this.getCostumeIdx(),noCostumes=this.inheritsAttribute("costumes"),noSounds=this.inheritsAttribute("sounds"),noScripts=this.inheritsAttribute("scripts");return serializer.format('<sprite name="@" idx="@" x="@" y="@"'+' heading="@"'+' scale="@"'+' volume="@"'+' pan="@"'+' rotation="@"'+"%"+' draggable="@"'+"%"+' costume="@" color="@,@,@,@" pen="@" ~>'+"%"+"%"+"%"+(noCostumes?"%":"<costumes>%</costumes>")+(noSounds?"%":"<sounds>%</sounds>")+"<blocks>%</blocks>"+"<variables>%</variables>"+(this.exemplar?"<dispatches>%</dispatches>":"%")+(noScripts?"%":"<scripts>%</scripts>")+"</sprite>",this.name,idx,this.xPosition(),this.yPosition(),this.heading,this.scale,this.volume,this.pan,this.rotationStyle,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",this.isDraggable,this.isVisible?"":' hidden="true"',costumeIdx,this.color.r,this.color.g,this.color.b,this.color.a,this.penPoint,this.exemplar?'<inherit exemplar="'+this.exemplar.name+'">'+(this.inheritedAttributes.length?serializer.store(new List(this.inheritedAttributes)):"")+"</inherit>":"",this.anchor?'<nest anchor="'+this.anchor.name+'" synch="'+this.rotatesWithAnchor+(this.scale===this.nestingScale?"":'"'+' scale="'+this.nestingScale)+'"/>':"",!costumeIdx&&this.costume?"<wear>"+serializer.store(this.costume)+"</wear>":"",noCostumes?"":serializer.store(this.costumes,this.name+"_cst"),noSounds?"":serializer.store(this.sounds,this.name+"_snd"),!this.customBlocks?"":serializer.store(this.customBlocks),serializer.store(this.variables),this.exemplar?serializer.store(this.inheritedMethods()):"",noScripts?"":serializer.store(this.scripts))};Costume.prototype[XML_Serializer.prototype.mediaDetectionProperty]=true;Costume.prototype.toXML=function(serializer){return serializer.format('<costume name="@" center-x="@" center-y="@" image="@"% ~/>',this.name,this.rotationCenter.x,this.rotationCenter.y,this instanceof SVG_Costume?this.contents.src:normalizeCanvas(this.contents).toDataURL("image/png"),this.embeddedData?serializer.format(' embed="@"',this.embeddedData):"")};Sound.prototype[XML_Serializer.prototype.mediaDetectionProperty]=true;Sound.prototype.toXML=function(serializer){return serializer.format('<sound name="@" sound="@" ~/>',this.name,this.toDataURL())};VariableFrame.prototype.toXML=function(serializer){return Object.keys(this.vars).reduce((vars,v)=>{var val=this.vars[v].value,transient=this.vars[v].isTransient,hidden=this.vars[v].isHidden,dta;if(transient||val===undefined||val===null){dta=serializer.format('<variable name="@"'+(transient?' transient="true"':"")+(hidden?' hidden="true"':"")+"/>",v)}else{dta=serializer.format('<variable name="@"'+(transient?' transient="true"':"")+(hidden?' hidden="true"':"")+">%</variable>",v,typeof val==="object"?isSnapObject(val)?"":serializer.store(val):typeof val==="boolean"?serializer.format("<bool>$</bool>",val):serializer.format("<l>$</l>",val))}return vars+dta},"")};WatcherMorph.prototype.toXML=function(serializer){var isVar=this.target instanceof VariableFrame,isList=this.currentValue instanceof List,color=this.readoutColor,position=this.parent?this.topLeft().subtract(this.parent.topLeft()).divideBy(this.parent.scale):this.topLeft();if(this.isTemporary()){return""}return serializer.format('<watcher% % style="@"% x="@" y="@" color="@,@,@"%%/>',isVar&&this.target.owner||!isVar&&this.target?serializer.format(' scope="@"',isVar?this.target.owner.name:this.target.name):"",serializer.format(isVar?'var="@"':'s="@"',this.getter),this.style,isVar&&this.style==="slider"?serializer.format(' min="@" max="@"',this.sliderMorph.start,this.sliderMorph.stop):"",position.x,position.y,color.r,color.g,color.b,!isList?"":serializer.format(' extX="@" extY="@"',this.cellMorph.contentsMorph.width(),this.cellMorph.contentsMorph.height()),this.isVisible?"":' hidden="true"')};ScriptsMorph.prototype.toXML=function(serializer){return this.children.reduce((xml,child)=>{if(child instanceof BlockMorph){return xml+child.toScriptXML(serializer,true)}if(child instanceof CommentMorph&&!child.block){return xml+child.toXML(serializer)}return xml},"")};BlockMorph.prototype.toXML=BlockMorph.prototype.toScriptXML=function(serializer,savePosition){var position,xml,scale=SyntaxElementMorph.prototype.scale,block=this;if(this.parent){position=this.topLeft().subtract(this.parent.topLeft())}else{position=this.topLeft()}if(savePosition){xml=serializer.format('<script x="@" y="@">',position.x/scale,position.y/scale)}else{xml="<script>"}do{xml+=block.toBlockXML(serializer);block=block.nextBlock()}while(block);xml+="<\/script>";return xml};BlockMorph.prototype.toBlockXML=function(serializer){return serializer.format('<block s="@">%%</block>',this.selector,serializer.store(this.inputs()),this.comment?this.comment.toXML(serializer):"")};ReporterBlockMorph.prototype.toXML=function(serializer){if(this.selector==="reportGetVar"){if(!this.comment){return serializer.format('<block var="@"/>',this.blockSpec)}else{return serializer.format('<block var="@">%</block>',this.blockSpec,this.comment.toXML(serializer))}}else{return this.toBlockXML(serializer)}};ReporterBlockMorph.prototype.toScriptXML=function(serializer,savePosition){var position,scale=SyntaxElementMorph.prototype.scale;if(this.parent){position=this.topLeft().subtract(this.parent.topLeft())}else{position=this.topLeft()}if(savePosition){return serializer.format('<script x="@" y="@">%<\/script>',position.x/scale,position.y/scale,this.toXML(serializer))}return serializer.format("<script>%<\/script>",this.toXML(serializer))};CustomCommandBlockMorph.prototype.toBlockXML=function(serializer){var scope=this.isGlobal?undefined:"local";return serializer.format('<custom-block s="@"%>%%%</custom-block>',this.semanticSpec,this.isGlobal?"":serializer.format(' scope="@"',scope),serializer.store(this.inputs()),this.isGlobal&&this.definition.variableNames.length&&!serializer.isExportingBlocksLibrary?"<variables>"+this.variables.toXML(serializer)+"</variables>":"",this.comment?this.comment.toXML(serializer):"")};CustomReporterBlockMorph.prototype.toBlockXML=CustomCommandBlockMorph.prototype.toBlockXML;CustomBlockDefinition.prototype.toXML=function(serializer){function encodeScripts(array){return array.reduce((xml,element)=>{if(element instanceof BlockMorph){return xml+element.toScriptXML(serializer,true)}if(element instanceof CommentMorph&&!element.block){return xml+element.toXML(serializer)}return xml},"")}return serializer.format('<block-definition s="@" type="@" category="@"%>'+"%"+(this.variableNames.length?"<variables>%</variables>":"@")+"<header>@</header>"+"<code>@</code>"+"<translations>@</translations>"+"<inputs>%</inputs>%%"+"</block-definition>",this.spec,this.type,this.category||"other",this.isHelper?' helper="true"':"",this.comment?this.comment.toXML(serializer):"",this.variableNames.length?serializer.store(new List(this.variableNames)):"",this.codeHeader||"",this.codeMapping||"",this.translationsAsText(),Array.from(this.declarations.keys()).reduce((xml,decl)=>{return xml+serializer.format('<input type="@"$>$%</input>',this.declarations.get(decl)[0],this.declarations.get(decl)[3]?' readonly="true"':"",this.declarations.get(decl)[1],this.declarations.get(decl)[2]?serializer.format("<options>@</options>",this.declarations.get(decl)[2]):"")},""),this.body?serializer.store(this.body.expression):"",this.scripts.length>0?"<scripts>"+encodeScripts(this.scripts)+"</scripts>":"")};ArgMorph.prototype.toXML=function(){return"<l/>"};BooleanSlotMorph.prototype.toXML=function(){return typeof this.value==="boolean"?"<l><bool>"+this.value+"</bool></l>":"<l/>"};InputSlotMorph.prototype.toXML=function(serializer){if(this.selectedBlock){return serializer.format('<l><wish s="@" type="@" category="@">@</wish></l>',this.selectedBlock.semanticSpec,this.selectedBlock instanceof CommandBlockMorph?"command":this.selectedBlock.isPredicate?"predicate":"reporter",this.selectedBlock.category,this.selectedBlock.storedTranslations)}if(this.constant){return serializer.format("<l><option>$</option></l>",this.constant)}return serializer.format("<l>$</l>",this.contents().text)};TemplateSlotMorph.prototype.toXML=function(serializer){return serializer.format("<l>$</l>",this.contents())};CommandSlotMorph.prototype.toXML=function(serializer){var block=this.nestedBlock();if(block instanceof BlockMorph){if(block instanceof ReporterBlockMorph){return serializer.format("<autolambda>%</autolambda>",serializer.store(block))}return serializer.store(block)}return"<script><\/script>"};FunctionSlotMorph.prototype.toXML=CommandSlotMorph.prototype.toXML;MultiArgMorph.prototype.toXML=function(serializer){return serializer.format("<list>%</list>",serializer.store(this.inputs()))};ArgLabelMorph.prototype.toXML=function(serializer){return serializer.format("%",serializer.store(this.inputs()[0]))};ColorSlotMorph.prototype.toXML=function(serializer){return serializer.format("<color>$,$,$,$</color>",this.color.r,this.color.g,this.color.b,this.color.a)};List.prototype.toXML=function(serializer,mediaContext){var xml,value;if(this.hasOnlyAtomicData()&&(!this.isLinked||!StageMorph.prototype.enableSublistIDs)){return serializer.format('<list struct="atomic" '+(this.isLinked?'linked="linked" ':"")+"~>@</list>",this.asCSV())}if(this.isLinked){if(StageMorph.prototype.enableSublistIDs){xml='<list linked="linked" ~>';value=this.first;if(!isNil(value)){xml+=serializer.format("<item>%</item>",typeof value==="object"?isSnapObject(value)?"":serializer.store(value,mediaContext):typeof value==="boolean"?serializer.format("<bool>$</bool>",value):serializer.format("<l>$</l>",value))}if(!isNil(this.rest)){xml+=serializer.store(this.rest,mediaContext)}return xml+"</list>"}return serializer.format('<list linked="linked" ~>%</list>',this.itemsArray().reduce((xml,item)=>{return xml+serializer.format("<item>%</item>",typeof item==="object"?isSnapObject(item)?"":serializer.store(item,mediaContext):typeof item==="boolean"?serializer.format("<bool>$</bool>",item):serializer.format("<l>$</l>",item))},""))}return serializer.format("<list ~>%</list>",this.contents.reduce((xml,item)=>{return xml+serializer.format("<item>%</item>",typeof item==="object"?isSnapObject(item)?"":serializer.store(item,mediaContext):typeof item==="boolean"?serializer.format("<bool>$</bool>",item):serializer.format("<l>$</l>",item))},""))};Context.prototype.toXML=function(serializer){if(this.isContinuation){return""}return serializer.format("<context ~><inputs>%</inputs><variables>%</variables>"+"%<receiver>%</receiver><origin>%</origin>%</context>",this.inputs.reduce((xml,input)=>{return xml+serializer.format("<input>$</input>",input)},""),this.variables?serializer.store(this.variables):"",this.expression?serializer.store(this.expression):"",this.receiver?serializer.store(this.receiver):"",this.receiver?serializer.store(this.origin):"",this.outerContext?serializer.store(this.outerContext):"")};CommentMorph.prototype.toXML=function(serializer){var position,scale=SyntaxElementMorph.prototype.scale;if(this.block){return serializer.format('<comment w="@" collapsed="@">%</comment>',this.textWidth()/scale,this.isCollapsed,serializer.escape(this.text()))}if(this.parent){position=this.topLeft().subtract(this.parent.topLeft())}else{position=this.topLeft()}return serializer.format('<comment x="@" y="@" w="@" collapsed="@">%</comment>',position.x/scale,position.y/scale,this.textWidth()/scale,this.isCollapsed,serializer.escape(this.text()))};</script>
        <script>modules.locale="2022-August-03";var Localizer;var SnapTranslator=new Localizer;function localize(string){return SnapTranslator.translate(string)}function Localizer(language,dict){this.language=language||"en";this.dict=dict||{}}Localizer.prototype.translate=function(string){var phrase=this.contextualize(string);return Object.prototype.hasOwnProperty.call(this.dict[this.language],phrase)?this.dict[this.language][phrase]:phrase};Localizer.prototype.languages=function(){var property,arr=[];for(property in this.dict){if(Object.prototype.hasOwnProperty.call(this.dict,property)){arr.push(property)}}return arr.sort()};Localizer.prototype.languageName=function(lang){return this.dict[lang].language_name||lang};Localizer.prototype.credits=function(){var txt="";this.languages().forEach(lang=>{txt=txt+"\n"+this.languageName(lang)+" ("+lang+") - "+this.dict[lang].language_translator+" - "+this.dict[lang].last_changed});return txt};Localizer.prototype.unload=function(){var dict,keep=["language_name","language_translator","last_changed"];this.languages().forEach(lang=>{var key;if(lang!=="en"){dict=this.dict[lang];for(key in dict){if(Object.prototype.hasOwnProperty.call(dict,key)&&!contains(keep,key)){delete dict[key]}}}})};Localizer.prototype.contextualize=function(string){switch(string){case"Error":return"Hmm...";case"brightness":return SpriteMorph.prototype.penColorModel==="hsl"?"lightness":string;case"r-g-b-a":return"RGBA";case"r-g-b(-a)":return"RGB(A)";default:return string}};SnapTranslator.dict.en={language_name:"English",language_translator:"Jens Mönig","translator_e-mail":"jens@moenig.org",last_changed:"2020-07-09",__shout__go__:"green flag clicked",any:"random","length of %s":"length of text %s","file menu import hint":"load an exported project file\nor block library, a costume\n"+"or a sound","settings menu prefer empty slots hint":"check to focus on empty slots\nwhen dragging & "+"dropping reporters","costumes tab help":"import a picture from another web page or from\n"+"a file on your computer by dropping it here\n","block deletion dialog text":"Are you sure you want to delete this\n"+"custom block and all its instances?","download to disk text":"This item could not be opened in a new tab.\n"+"It has been saved to your browser's downloads folder.","unable to export text":"This item could not be exported from Snap!.\n"+"It's likely that your project may contain a lot of media "+"(sounds and images) or that you are using an older browser."+"Please try using a recent version of Chrome, Firefox, or Safari."};SnapTranslator.dict.de={language_name:"Deutsch",language_translator:"Jens Mönig, Jadga Hügle","translator_e-mail":"jens@moenig.org, jadga.huegle@sap.com",last_changed:"2022-08-03"};SnapTranslator.dict.it={language_name:"Italiano",language_translator:"Stefano Federici, Alberto Firpo, Massimo Ghisalberti","translator_e-mail":"s_federici@yahoo.com, albertofirpo12@gmail.com, zairik@gmail.com",last_changed:"2022-91-03"};SnapTranslator.dict.ja={language_name:"日本語",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2020-07-03"};SnapTranslator.dict.ja_HIRA={language_name:"にほんご",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2018-10-23"};SnapTranslator.dict.ko={language_name:"한국어",language_translator:"Yunjae Jang","translator_e-mail":"janggoons@gmail.com",last_changed:"2015-01-21"};SnapTranslator.dict.pt={language_name:"Português",language_translator:"Manuel Menezes de Sequeira","translator_e-mail":"mmsequeira@gmail.com",last_changed:"2020-08-03"};SnapTranslator.dict.cs={language_name:"Česky",language_translator:"Michal Moc, Jan Tomsa","translator_e-mail":"info@iguru.eu, jan.tomsa.1976@gmail.com",last_changed:"2015-11-16"};SnapTranslator.dict.zh_CN={language_name:"简体中文",language_translator:"五百刀/邓江华/孟锡峰/曹儒林","translator_e-mail":"ubertao@qq.com/djh@rhjxx.cn/simon@snapontop.org",last_changed:"2022-01-17"};SnapTranslator.dict.eo={language_name:"Esperanto",language_translator:"Sebastian Cyprych","translator_e-mail":"sebacyp(heliko)gmail(punkto)com",last_changed:"2017-10-01"};SnapTranslator.dict.fr={language_name:"Français",language_translator:"Jean-Jacques Valliet, Mark Rafter, Martin Quinson, Damien Caselli","translator_e-mail":"i.scool@mac.com",last_changed:"2020-10-28"};SnapTranslator.dict.si={language_name:"Slovenščina",language_translator:"Sasa Divjak, Gorazd Breskvar","translator_e-mail":"sasa.divjak@fri.uni-lj.si",last_changed:"2016-04-22"};SnapTranslator.dict.ru={language_name:"Русский",language_translator:"Svetlana Ptashnaya, Проскурнёв Артём, Pavel Belousov","translator_e-mail":"svetlanap@berkeley.edu, tema@school830.ru, pbsite@mail.ru",last_changed:"2020-12-22"};SnapTranslator.dict.es={language_name:"Español",language_translator:"Víctor Manuel Muratalla Morales / Cristián Rizzi Iribarren / Alfonso Ruzafa","translator_e-mail":"victor.muratalla@yahoo.com / rizzi.cristian@gmail.com",last_changed:"2020-12-01"};SnapTranslator.dict.nl={language_name:"Nederlands",language_translator:"Joek van Montfort, Sjoerd Dirk Meijer, Frank Sierens, Jan-Gerard van der Toorn","translator_e-mail":"joek@xota.nl, sjoerddirk@fromScratchEd.nl, frank.sierens@telenet.be, jg.2019@xs4all.nl",last_changed:"2020-12-15"};SnapTranslator.dict.pl={language_name:"Polski",language_translator:"Witek Kranas & deKrain & Andrzej Batorski","translator_e-mail":"witek@oeiizk.waw.pl",last_changed:"2021-05-15"};SnapTranslator.dict.zh_TW={language_name:"繁體中文",language_translator:"cch","translator_e-mail":"cchuang2009@gmail.com",last_changed:"2013-8-14"};SnapTranslator.dict.no={language_name:"Norsk",language_translator:"Olav A Marschall","translator_e-mail":"olavmarschall@gmail.com",last_changed:"2020-08-19"};SnapTranslator.dict.dk={language_name:"Dansk",language_translator:"FAB, Pelle Hjek","translator_e-mail":"fab@nielsen.mail.dk, hjek@mail.com",last_changed:"2016-11-16"};SnapTranslator.dict.el={language_name:"Ελληνικά",language_translator:"Ino Samaras, Alexandros Prekates, HM100","translator_e-mail":"ino.samaras@berkeley.edu, aprekates@sch.gr",last_changed:"2022-07-30"};SnapTranslator.dict.ca={language_name:"Català",language_translator:"Bernat Romagosa Carrasquer, Joan Guillén i Pelegay","translator_e-mail":"bernat@snap4arduino.rocks, jguille2@xtec.cat",last_changed:"2022-01-05"};SnapTranslator.dict.ca_VA={language_name:"Català - Valencià",language_translator:"Bernat Romagosa Carrasquer, Joan Guillén i Pelegay, Pilar Embid","translator_e-mail":"bernat@snap4arduino.rocks, jguille2@xtec.cat, embid_mar@gva.es",last_changed:"2018-02-08"};SnapTranslator.dict.fi={language_name:"suomi",language_translator:"Jouni K. Seppänen","translator_e-mail":"jks@iki.fi",last_changed:"2014-04-18"};SnapTranslator.dict.sv={language_name:"svenska",language_translator:"Erik A. Olsson","translator_e-mail":"eolsson@gmail.com",last_changed:"2016-06-09"};SnapTranslator.dict.pt_BR={language_name:"Português do Brasil",language_translator:"Aldo von Wangenheim, Cassiano D'Andrea","translator_e-mail":"awangenh@inf.ufsc.br, cassiano.dandrea@tagview.com.br",last_changed:"2021-11-11"};SnapTranslator.dict.bn={language_name:"বাংলা",language_translator:"Dr. Mokter Hossain, Radman Siddiki","translator_e-mail":"mokter@gmail.com, radman.siddiki@outlook.com",last_changed:"2020-07-04"};SnapTranslator.dict.kn={language_name:"ಕನ್ನಡ",language_translator:"Vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2014-12-02"};SnapTranslator.dict.ml={language_name:"Malayalam",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"};SnapTranslator.dict.ta={language_name:"Tamil",language_translator:"vinayakumar R, Barthdry","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2021-01-25"};SnapTranslator.dict.te={language_name:"Telagu",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"};SnapTranslator.dict.tr={language_name:"Türkçe",language_translator:"Turgut Güneysu, Hakan Atas","translator_e-mail":"tguneysu@msn.com",last_changed:"2021-01-26"};SnapTranslator.dict.hu={language_name:"Magyar",language_translator:"Makány György, Faragó Attila","translator_e-mail":"makany.gyorgy@gmail.com, attila.farago@sap.com",last_changed:"2022-01-25"};SnapTranslator.dict.ia={language_name:"Interlingua",language_translator:"Ken Dickey","translator_e-mail":"Ken.Dickey@whidbey.com",last_changed:"2015-08-09"};SnapTranslator.dict.hr={language_name:"Hrvatski",language_translator:"Željko Hrvoj","translator_e-mail":"zeljko.hrvoj@zg.t-com.hr",last_changed:"2017-08-15"};SnapTranslator.dict.bg={language_name:"Български",language_translator:"Ivan Savov","translator_e-mail":"ivan.savov@gmail.com",last_changed:"2015-11-16"};SnapTranslator.dict.ro={language_name:"Român",language_translator:"Cristian Macarascu","translator_e-mail":"",last_changed:"2015-10-24"};SnapTranslator.dict.ar={language_name:"العربية",language_translator:"طارق جلال","translator_e-mail":"tarekgalal46@hotmail.com",last_changed:"2016-02-24"};SnapTranslator.dict.id={language_name:"Bahasa Indonesia",language_translator:"Alexander Raphael Liu, Emmanuella Rumanti","translator_e-mail":"raphaxander@gmail.com",last_changed:"2019-01-21"};SnapTranslator.dict.et={language_name:"Eesti",language_translator:"Hasso Tepper","translator_e-mail":"hasso.tepper@gmail.com",last_changed:"2016-05-03"};SnapTranslator.dict.gl={language_name:"Galego",language_translator:"tecnoloxia <2016>,Miguel A. Bouzada <2019>","translator_e-mail":"mbouzada@gmail.com",last_changed:"2019-07-29"};SnapTranslator.dict.eu={language_name:"Euskara",language_translator:"Asier Iturralde Sarasola","translator_e-mail":"aiturralde@iametza.eus",last_changed:"2018-06-26"};SnapTranslator.dict.ua={language_name:"Українська",language_translator:"Serhiy Kryzhanovsky","translator_e-mail":"kseryj@gmail.com",last_changed:"2018-08-21"};SnapTranslator.dict.sk={language_name:"Slovenčina",language_translator:"Peter Lukačovič","translator_e-mail":"peter_lukacovic@outlook.com",last_changed:"2019-12-10"};SnapTranslator.dict.he={language_name:"עברית",language_translator:"יוסי כהן","translator_e-mail":"cohenyossi81@gmail.com",last_changed:"2020-04-21"};SnapTranslator.dict.hi={language_name:"हिंदी",language_translator:"Barthdry","translator_e-mail":"barathkumarbasker2007@gmail.com",last_changed:"2021-05-08"};</script>
        <script>modules=modules||{};modules.cloud="2022-August-02";var Cloud;function Cloud(){this.init()}Cloud.prototype.init=function(){this.apiBasePath="/api/v1";this.url=this.determineCloudDomain()+this.apiBasePath;this.username=null;this.disabled=false};Cloud.prototype.disable=function(){this.disabled=true;this.username=null};Cloud.MAX_FILE_SIZE=10*1024*1024;Cloud.prototype.knownDomains={"Snap!Cloud":"https://snap.berkeley.edu","Snap!Cloud (cs10)":"https://snap-cloud.cs10.org","Snap!Cloud (staging)":"https://snap-staging.cs10.org",localhost:"http://localhost:8080","localhost (secure)":"https://localhost:4431"};Cloud.prototype.defaultDomain=Cloud.prototype.knownDomains["Snap!Cloud"];Cloud.prototype.determineCloudDomain=function(){var currentDomain=window.location.host,metaTag=document.head.querySelector("[name='snap-cloud-domain']"),cloudDomain=this.defaultDomain,domainMap=this.knownDomains;if(metaTag){return metaTag.getAttribute("location")}Object.keys(domainMap).some(function(name){var server=domainMap[name];if(Cloud.isMatchingDomain(currentDomain,server)){cloudDomain=server;return true}return false});return cloudDomain};Cloud.isMatchingDomain=function(client,server){var position=server.indexOf(client);switch(position){case-1:return false;case 0:return client===server;default:return/[\.\/]/.test(server[position-1])&&server.length===position+client.length}};Cloud.prototype.parseDict=function(src){var dict={};if(!src){return dict}src.split("&").forEach(function(entry){var pair=entry.split("="),key=decodeURIComponent(pair[0]),val=decodeURIComponent(pair[1]);dict[key]=val});return dict};Cloud.prototype.encodeDict=function(dict){var str="",pair,key;if(!dict){return null}for(key in dict){if(dict.hasOwnProperty(key)){pair=encodeURIComponent(key)+"="+encodeURIComponent(dict[key]);if(str.length>0){str+="&"}str+=pair}}return str};Cloud.genericErrorMessage="There was an error while trying to access\n"+"a Snap!Cloud service. Please try again later.";Cloud.prototype.genericError=function(){throw new Error(Cloud.genericErrorMessage)};Cloud.prototype.request=function(method,path,onSuccess,onError,errorMsg,wantsRawResponse,body){if(this.disabled){return}var request=new XMLHttpRequest,myself=this,fullPath=this.url+(path.indexOf("%username")>-1?path.replace("%username",encodeURIComponent(this.username)):path);try{request.open(method,fullPath,true);request.setRequestHeader("Content-Type","application/json; charset=utf-8");request.withCredentials=true;request.onreadystatechange=function(){if(request.readyState===4){if(request.responseText){var response=!wantsRawResponse||request.responseText.indexOf('{"errors"')===0?JSON.parse(request.responseText):request.responseText;if(response.errors){onError.call(null,response.errors[0],errorMsg)}else{if(onSuccess){onSuccess.call(null,response.message||response)}}}else{if(onError){onError.call(null,errorMsg||Cloud.genericErrorMessage,myself.url)}else{myself.genericError()}}}};request.send(typeof body==="object"?JSON.stringify(body):body)}catch(err){onError.call(this,err.toString(),"Cloud Error")}};Cloud.prototype.withCredentialsRequest=function(method,path,onSuccess,onError,errorMsg,wantsRawResponse,body){var myself=this;this.checkCredentials(function(username){if(username){myself.request(method,path,onSuccess,onError,errorMsg,wantsRawResponse,body)}else{onError.call(this,"You are not logged in","Snap!Cloud")}})};Cloud.prototype.initSession=function(onSuccess){var myself=this;if(location.protocol==="file:"){return}this.request("POST","/init",function(){myself.checkCredentials(onSuccess)},function(){},null,true)};Cloud.prototype.checkCredentials=function(onSuccess,onError,response){var myself=this;this.getCurrentUser(function(user){if(user.username){myself.username=user.username;myself.verified=user.verified}if(onSuccess){onSuccess.call(null,user.username,user.role,response?JSON.parse(response):null)}},onError)};Cloud.prototype.getCurrentUser=function(onSuccess,onError){this.request("GET","/users/c",onSuccess,onError,"Could not retrieve current user")};Cloud.prototype.getUser=function(username,onSuccess,onError){this.request("GET","/users/"+encodeURIComponent(username),onSuccess,onError,"Could not retrieve user")};Cloud.prototype.logout=function(onSuccess,onError){this.username=null;this.request("POST","/logout",onSuccess,onError,"logout failed")};Cloud.prototype.login=function(username,password,persist,onSuccess,onError){var myself=this;this.request("POST","/users/"+encodeURIComponent(username)+"/login?"+this.encodeDict({persist:persist}),function(response){myself.checkCredentials(onSuccess,onError,response)},onError,"login failed","false",hex_sha512(password))};Cloud.prototype.signup=function(username,password,passwordRepeat,email,onSuccess,onError){this.request("POST","/users/"+encodeURIComponent(username.trim())+"?"+this.encodeDict({email:email,password:hex_sha512(password),password_repeat:hex_sha512(passwordRepeat)}),onSuccess,onError,"signup failed")};Cloud.prototype.changePassword=function(password,newPassword,passwordRepeat,onSuccess,onError){this.withCredentialsRequest("POST","/users/%username/newpassword?"+this.encodeDict({oldpassword:hex_sha512(password),password_repeat:hex_sha512(passwordRepeat),newpassword:hex_sha512(newPassword)}),onSuccess,onError,"Could not change password")};Cloud.prototype.resetPassword=function(username,onSuccess,onError){this.request("POST","/users/"+encodeURIComponent(username)+"/password_reset",onSuccess,onError,"Password reset request failed")};Cloud.prototype.resendVerification=function(username,onSuccess,onError){this.request("POST","/users/"+encodeURIComponent(username)+"/resendverification",onSuccess,onError,"Could not send verification email")};Cloud.prototype.saveProject=function(projectName,body,onSuccess,onError){var myself=this;this.checkCredentials(function(username){if(username){myself.request("POST","/projects/"+encodeURIComponent(username)+"/"+encodeURIComponent(projectName),onSuccess,onError,"Project could not be saved",false,body)}else{onError.call(this,"You are not logged in","Snap!Cloud")}})};Cloud.prototype.getProjectList=function(onSuccess,onError,withThumbnail){var path="/projects/%username?updatingnotes=true";if(withThumbnail){path+="&withthumbnail=true"}this.withCredentialsRequest("GET",path,onSuccess,onError,"Could not fetch projects")};Cloud.prototype.getPublishedProjectList=function(username,page,pageSize,searchTerm,onSuccess,onError,withThumbnail){var path="/projects"+(username?"/"+encodeURIComponent(username):"")+"?ispublished=true";if(!username){path+="&filtered=true"}if(withThumbnail){path+="&withthumbnail=true"}if(page){path+="&page="+page+"&pagesize="+(pageSize||16)}if(searchTerm){path+="&matchtext="+encodeURIComponent(searchTerm)}this.request("GET",path,onSuccess,onError,"Could not fetch projects")};Cloud.prototype.getThumbnail=function(username,projectName,onSuccess,onError){this[username?"request":"withCredentialsRequest"]("GET","/projects/"+(username?encodeURIComponent(username):"%username")+"/"+encodeURIComponent(projectName)+"/thumbnail",onSuccess,onError,"Could not fetch thumbnail",true)};Cloud.prototype.getProject=function(projectName,delta,onSuccess,onError){this.withCredentialsRequest("GET","/projects/%username/"+encodeURIComponent(projectName)+(delta?"?delta="+delta:""),onSuccess,onError,"Could not fetch project "+projectName,true)};Cloud.prototype.getPublicProject=function(projectName,username,onSuccess,onError){this.request("GET","/projects/"+encodeURIComponent(username)+"/"+encodeURIComponent(projectName),onSuccess,onError,"Could not fetch project "+projectName,true)};Cloud.prototype.getProjectMetadata=function(projectName,username,onSuccess,onError){this.request("GET","/projects/"+encodeURIComponent(username)+"/"+encodeURIComponent(projectName)+"/metadata",onSuccess,onError,"Could not fetch metadata for "+projectName)};Cloud.prototype.getProjectVersionMetadata=function(projectName,onSuccess,onError){this.withCredentialsRequest("GET","/projects/%username/"+encodeURIComponent(projectName)+"/versions",onSuccess,onError,"Could not fetch versions for project "+projectName)};Cloud.prototype.getRemixes=function(username,projectName,page,pageSize,onSuccess,onError){var path="/projects/"+encodeURIComponent(username)+"/"+encodeURIComponent(projectName)+"/remixes";if(page){path+="?page="+page+"&pagesize="+(pageSize||16)}this.request("GET",path,onSuccess,onError,"Could not fetch remixes for project "+projectName)};Cloud.prototype.deleteProject=function(projectName,username,onSuccess,onError){this[username?"request":"withCredentialsRequest"]("DELETE","/projects/"+(username?encodeURIComponent(username):"%username")+"/"+encodeURIComponent(projectName),onSuccess,onError,"Could not delete project")};Cloud.prototype.shareProject=function(projectName,username,onSuccess,onError){this[username?"request":"withCredentialsRequest"]("POST","/projects/"+(username?encodeURIComponent(username):"%username")+"/"+encodeURIComponent(projectName)+"/metadata?ispublic=true",onSuccess,onError,"Could not share project")};Cloud.prototype.unshareProject=function(projectName,username,onSuccess,onError){this[username?"request":"withCredentialsRequest"]("POST","/projects/"+(username?encodeURIComponent(username):"%username")+"/"+encodeURIComponent(projectName)+"/metadata?ispublic=false&ispublished=false",onSuccess,onError,"Could not unshare project")};Cloud.prototype.publishProject=function(projectName,username,onSuccess,onError){this[username?"request":"withCredentialsRequest"]("POST","/projects/"+(username?encodeURIComponent(username):"%username")+"/"+encodeURIComponent(projectName)+"/metadata?ispublished=true",onSuccess,onError,"Could not publish project")};Cloud.prototype.unpublishProject=function(projectName,username,onSuccess,onError){this[username?"request":"withCredentialsRequest"]("POST","/projects/"+(username?encodeURIComponent(username):"%username")+"/"+encodeURIComponent(projectName)+"/metadata?ispublished=false",onSuccess,onError,"Could not unpublish project")};Cloud.prototype.updateNotes=function(projectName,notes,onSuccess,onError){this.withCredentialsRequest("POST","/projects/%username/"+encodeURIComponent(projectName)+"/metadata",onSuccess,onError,"Could not update project notes",false,{notes:notes})};Cloud.prototype.updateProjectName=function(projectName,newName,onSuccess,onError){this.withCredentialsRequest("POST","/projects/%username/"+encodeURIComponent(projectName)+"/metadata",onSuccess,onError,"Could not update project name",false,{projectname:newName})};Cloud.prototype.newCollection=function(collectionName,onSuccess,onError){this.withCredentialsRequest("POST","/users/%username/collections/"+encodeURIComponent(collectionName),onSuccess,onError,"Could not create collection")};Cloud.prototype.getCollectionMetadata=function(collectionUsername,collectionName,onSuccess,onError){this.request("GET","/users/"+(collectionUsername?encodeURIComponent(collectionUsername):"%username")+"/collections/"+encodeURIComponent(collectionName)+"/metadata",onSuccess,onError,"Could not fetch metadata for "+collectionName)};Cloud.prototype.getCollectionProjects=function(collectionUsername,page,pageSize,collectionName,onSuccess,onError,withThumbnail){var path="/users/"+(collectionUsername?encodeURIComponent(collectionUsername):"%username")+"/collections/"+encodeURIComponent(collectionName)+"/projects";if(page){path+="?page="+page+"&pagesize="+(pageSize||16)}if(withThumbnail){path+=(page?"&":"?")+"withthumbnail=true"}this.request("GET",path,onSuccess,onError,"Could not fetch projects")};Cloud.prototype.setCollectionThumbnail=function(collectionUsername,collectionName,thumbnailId,onSuccess,onError){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(collectionUsername)+"/collections/"+encodeURIComponent(collectionName)+"/thumbnail?id="+encodeURIComponent(thumbnailId),onSuccess,onError,"Could not set project thumbnail")};Cloud.prototype.updateCollectionDescription=function(collectionUsername,collectionName,description,onSuccess,onError){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(collectionUsername)+"/collections/"+encodeURIComponent(collectionName)+"/metadata",onSuccess,onError,"Could not update collection description",false,{description:description})};Cloud.prototype.updateCollectionName=function(collectionUsername,collectionName,newName,onSuccess,onError){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(collectionUsername)+"/collections/"+encodeURIComponent(collectionName)+"/metadata",onSuccess,onError,"Could not update collection name",false,{name:newName})};Cloud.prototype.shareCollection=function(collectionUsername,collectionName,onSuccess,onError){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(collectionUsername)+"/collections/"+encodeURIComponent(collectionName)+"/metadata?shared=true",onSuccess,onError,"Could not share collection")};Cloud.prototype.unshareCollection=function(collectionUsername,collectionName,onSuccess,onError){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(collectionUsername)+"/collections/"+encodeURIComponent(collectionName)+"/metadata?shared=false&published=false",onSuccess,onError,"Could not unshare collection")};Cloud.prototype.publishCollection=function(collectionUsername,collectionName,onSuccess,onError){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(collectionUsername)+"/collections/"+encodeURIComponent(collectionName)+"/metadata?published=true",onSuccess,onError,"Could not publish collection")};Cloud.prototype.unpublishCollection=function(collectionUsername,collectionName,onSuccess,onError){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(collectionUsername)+"/collections/"+encodeURIComponent(collectionName)+"/metadata?published=false",onSuccess,onError,"Could not unpublish collection")};Cloud.prototype.addProjectToCollection=function(collectionUsername,collectionName,projectUsername,projectName,onSuccess,onError){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(collectionUsername)+"/collections/"+encodeURIComponent(collectionName)+"/projects",onSuccess,onError,"Could not add project to collection",false,{username:projectUsername,projectname:projectName})};Cloud.prototype.removeProjectFromCollection=function(collectionUsername,collectionName,projectId,onSuccess,onError){this.withCredentialsRequest("DELETE","/users/"+encodeURIComponent(collectionUsername)+"/collections/"+encodeURIComponent(collectionName)+"/projects/"+encodeURIComponent(projectId),onSuccess,onError,"Could not remove project from collection")};Cloud.prototype.getUserCollections=function(collectionUsername,page,pageSize,searchTerm,onSuccess,onError){this[collectionUsername!==this.username?"request":"withCredentialsRequest"]("GET","/users/"+(collectionUsername?encodeURIComponent(collectionUsername):"%username")+"/collections?"+this.encodeDict(page>0?{page:page,pagesize:pageSize||16,matchtext:searchTerm?encodeURIComponent(searchTerm):""}:{}),onSuccess,onError,"Could not fetch collections")};Cloud.prototype.getCollectionsContainingProject=function(username,projectName,page,pageSize,onSuccess,onError){var path="/projects/"+encodeURIComponent(username)+"/"+encodeURIComponent(projectName)+"/collections";if(page){path+="?page="+page+"&pagesize="+(pageSize||16)}this.request("GET",path,onSuccess,onError,"Could not fetch collections for project "+projectName)};Cloud.prototype.getCollections=function(page,pageSize,searchTerm,onSuccess,onError){var dict={page:page,pagesize:page?pageSize||16:""};if(searchTerm){dict.matchtext=encodeURIComponent(searchTerm)}this.request("GET","/collections?"+this.encodeDict(dict),onSuccess,onError,"Could not fetch collections")};Cloud.prototype.deleteCollection=function(collectionUsername,collectionName,onSuccess,onError){this.withCredentialsRequest("DELETE","/users/"+encodeURIComponent(collectionUsername)+"/collections/"+encodeURIComponent(collectionName),onSuccess,onError,"Could not remove collection")};Cloud.prototype.addEditorToCollection=function(collectionUsername,collectionName,editorUsername,onSuccess,onError){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(collectionUsername)+"/collections/"+encodeURIComponent(collectionName)+"/editors",onSuccess,onError,"Could not add editor to collection",false,{editor_username:editorUsername})};Cloud.prototype.removeEditorFromCollection=function(collectionUsername,collectionName,editorUsername,onSuccess,onError){this.withCredentialsRequest("DELETE","/users/"+encodeURIComponent(collectionUsername)+"/collections/"+encodeURIComponent(collectionName)+"/editors/"+encodeURIComponent(editorUsername),onSuccess,onError,"Could not remove editor from collection")};Cloud.prototype.showProjectPath=function(username,projectname){return"/project?"+this.encodeDict({user:username,project:projectname})};</script>
        <script>modules.api="2022-July-19";window.onmessage=function(event){var ide=world.children[0];if(!isNil(event.data.selector)){window.top.postMessage({selector:event.data.selector,response:ide[event.data.selector].apply(ide,event.data.params)},"*")}};IDE_Morph.prototype.getScenes=function(){return this.scenes.itemsArray().map(each=>each.name)};IDE_Morph.prototype.getCurrentScene=function(){return this.scene.name};IDE_Morph.prototype.switchTo=function(sceneName){var scene=detect(this.scenes.itemsArray(),scn=>scn.name===sceneName);if(scene===null){throw new Error("cannot find scene "+sceneName)}this.switchToScene(scene)};IDE_Morph.prototype.isRunning=function(){return this.stage.threads.processes.length>0};IDE_Morph.prototype.stop=function(){var stage=this.stage;stage.keysPressed={};stage.threads.stopAll();stage.stopAllActiveSounds();stage.children.forEach(morph=>{if(morph.stopTalking){morph.stopTalking()}});stage.removeAllClones();stage.stopProjection();this.controlBar.pauseButton.refresh()};IDE_Morph.prototype.broadcast=function(message,callback){var rcvrs=this.sprites.contents.concat(this.stage),myself=this,procs=[];function wait(){if(procs.some(any=>any.isRunning())){return}if(callback instanceof Function){myself.onNextStep=function(){callback();callback=null}}}if(!isString(message)){throw new Error("message must be a String")}this.stage.lastMessage=message;rcvrs.forEach(morph=>{if(isSnapObject(morph)){morph.allHatBlocksFor(message).forEach(block=>{var varName,varFrame;if(block.selector==="receiveMessage"){varName=block.inputs()[1].evaluate()[0];if(varName){varFrame=new VariableFrame;varFrame.addVar(varName,message)}procs.push(this.stage.threads.startProcess(block,morph,this.stage.isThreadSafe,null,callback instanceof Function?wait:null,null,null,null,varFrame))}else{procs.push(this.stage.threads.startProcess(block,morph,this.stage.isThreadSafe))}})}});(this.stage.messageCallbacks[""]||[]).forEach(callback=>callback(message));(this.stage.messageCallbacks[message]||[]).forEach(callback=>callback())};IDE_Morph.prototype.addMessageListenerForAll=function(callback){this.addMessageListener("",callback)};IDE_Morph.prototype.addMessageListener=function(message,callback){var funcs;if(!isString(message)){throw new Error("message must be a String")}funcs=this.stage.messageCallbacks[message];if(funcs instanceof Array){funcs.push(callback)}else{this.stage.messageCallbacks[message]=[callback]}};IDE_Morph.prototype.getMessages=function(){var allNames=[],dict=new Map;this.sprites.contents.concat(this.stage).forEach(sprite=>{allNames=allNames.concat(sprite.allMessageNames())});allNames.forEach(name=>dict.set(name));return Array.from(dict.keys())};IDE_Morph.prototype.getVarNames=function(){return this.stage.globalVariables().names()};IDE_Morph.prototype.getVar=function(name){return this.stage.globalVariables().getVar(name)};IDE_Morph.prototype.setVar=function(name,value){this.stage.globalVariables().setVar(name,value)};IDE_Morph.prototype.newList=function(array){return new List(array)};IDE_Morph.prototype.getProjectXML=function(){return this.serializer.serialize(new Project(this.scenes,this.scene))};IDE_Morph.prototype.loadProjectXML=function(projectXML){this.onNextStep=null;this.world().animations=[];this.openProjectString(projectXML)};IDE_Morph.prototype.unsavedChanges=function(){return this.hasUnsavedEdits()};IDE_Morph.prototype.setTranslation=function(countryCode,callback){this.loadNewProject=false;this.setLanguage(countryCode,callback,true)};</script>
        <script>var hex_sha512=function(hex_sha512){var hexcase=0;function hex_sha512(s){return CryptoJS.SHA512(str2rstr_utf8(s)).toString(CryptoJS.enc.Hex)}function rstr_sha512(s){return binb2rstr(binb_sha512(rstr2binb(s),s.length*8))}var CryptoJS=CryptoJS||function(a,g){var m={},e=m.lib={},q=e.Base=function(){function a(){}return{extend:function(b){a.prototype=this;var d=new a;b&&d.mixIn(b);d.$super=this;return d},create:function(){var a=this.extend();a.init.apply(a,arguments);return a},init:function(){},mixIn:function(a){for(var k in a)a.hasOwnProperty(k)&&(this[k]=a[k]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.$super.extend(this)}}}(),r=e.WordArray=q.extend({init:function(a,b){a=this.words=a||[];this.sigBytes=b!=g?b:4*a.length},toString:function(a){return(a||n).stringify(this)},concat:function(a){var b=this.words,d=a.words,c=this.sigBytes,a=a.sigBytes;this.clamp();if(c%4)for(var i=0;i<a;i++)b[c+i>>>2]|=(d[i>>>2]>>>24-8*(i%4)&255)<<24-8*((c+i)%4);else if(65535<d.length)for(i=0;i<a;i+=4)b[c+i>>>2]=d[i>>>2];else b.push.apply(b,d);this.sigBytes+=a;return this},clamp:function(){var k=this.words,b=this.sigBytes;k[b>>>2]&=4294967295<<32-8*(b%4);k.length=a.ceil(b/4)},clone:function(){var a=q.clone.call(this);a.words=this.words.slice(0);return a},random:function(k){for(var b=[],d=0;d<k;d+=4)b.push(4294967296*a.random()|0);return r.create(b,k)}}),y=m.enc={},n=y.Hex={stringify:function(a){for(var b=a.words,a=a.sigBytes,d=[],c=0;c<a;c++){var i=b[c>>>2]>>>24-8*(c%4)&255;d.push((i>>>4).toString(16));d.push((i&15).toString(16))}return d.join("")},parse:function(a){for(var b=a.length,d=[],c=0;c<b;c+=2)d[c>>>3]|=parseInt(a.substr(c,2),16)<<24-4*(c%8);return r.create(d,b/2)}},l=y.Latin1={stringify:function(a){for(var b=a.words,a=a.sigBytes,d=[],c=0;c<a;c++)d.push(String.fromCharCode(b[c>>>2]>>>24-8*(c%4)&255));return d.join("")},parse:function(a){for(var b=a.length,d=[],c=0;c<b;c++)d[c>>>2]|=(a.charCodeAt(c)&255)<<24-8*(c%4);return r.create(d,b)}},da=y.Utf8={stringify:function(a){try{return decodeURIComponent(escape(l.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data")}},parse:function(a){return l.parse(unescape(encodeURIComponent(a)))}},h=e.BufferedBlockAlgorithm=q.extend({reset:function(){this._data=r.create();this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=da.parse(a));this._data.concat(a);this._nDataBytes+=a.sigBytes},_process:function(k){var b=this._data,d=b.words,c=b.sigBytes,i=this.blockSize,l=c/(4*i),l=k?a.ceil(l):a.max((l|0)-this._minBufferSize,0),k=l*i,c=a.min(4*k,c);if(k){for(var h=0;h<k;h+=i)this._doProcessBlock(d,h);h=d.splice(0,k);b.sigBytes-=c}return r.create(h,c)},clone:function(){var a=q.clone.call(this);a._data=this._data.clone();return a},_minBufferSize:0});e.Hasher=h.extend({init:function(){this.reset()},reset:function(){h.reset.call(this);this._doReset()},update:function(a){this._append(a);this._process();return this},finalize:function(a){a&&this._append(a);this._doFinalize();return this._hash},clone:function(){var a=h.clone.call(this);a._hash=this._hash.clone();return a},blockSize:16,_createHelper:function(a){return function(b,d){return a.create(d).finalize(b)}},_createHmacHelper:function(a){return function(b,d){return ea.HMAC.create(a,d).finalize(b)}}});var ea=m.algo={};return m}(Math);(function(a){var g=CryptoJS,m=g.lib,e=m.Base,q=m.WordArray,g=g.x64={};g.Word=e.extend({init:function(a,e){this.high=a;this.low=e}});g.WordArray=e.extend({init:function(e,y){e=this.words=e||[];this.sigBytes=y!=a?y:8*e.length},toX32:function(){for(var a=this.words,e=a.length,n=[],l=0;l<e;l++){var g=a[l];n.push(g.high);n.push(g.low)}return q.create(n,this.sigBytes)},clone:function(){for(var a=e.clone.call(this),g=a.words=this.words.slice(0),n=g.length,l=0;l<n;l++)g[l]=g[l].clone();return a}})})();(function(){function a(){return q.create.apply(q,arguments)}var g=CryptoJS,m=g.lib.Hasher,e=g.x64,q=e.Word,r=e.WordArray,e=g.algo,y=[a(1116352408,3609767458),a(1899447441,602891725),a(3049323471,3964484399),a(3921009573,2173295548),a(961987163,4081628472),a(1508970993,3053834265),a(2453635748,2937671579),a(2870763221,3664609560),a(3624381080,2734883394),a(310598401,1164996542),a(607225278,1323610764),a(1426881987,3590304994),a(1925078388,4068182383),a(2162078206,991336113),a(2614888103,633803317),a(3248222580,3479774868),a(3835390401,2666613458),a(4022224774,944711139),a(264347078,2341262773),a(604807628,2007800933),a(770255983,1495990901),a(1249150122,1856431235),a(1555081692,3175218132),a(1996064986,2198950837),a(2554220882,3999719339),a(2821834349,766784016),a(2952996808,2566594879),a(3210313671,3203337956),a(3336571891,1034457026),a(3584528711,2466948901),a(113926993,3758326383),a(338241895,168717936),a(666307205,1188179964),a(773529912,1546045734),a(1294757372,1522805485),a(1396182291,2643833823),a(1695183700,2343527390),a(1986661051,1014477480),a(2177026350,1206759142),a(2456956037,344077627),a(2730485921,1290863460),a(2820302411,3158454273),a(3259730800,3505952657),a(3345764771,106217008),a(3516065817,3606008344),a(3600352804,1432725776),a(4094571909,1467031594),a(275423344,851169720),a(430227734,3100823752),a(506948616,1363258195),a(659060556,3750685593),a(883997877,3785050280),a(958139571,3318307427),a(1322822218,3812723403),a(1537002063,2003034995),a(1747873779,3602036899),a(1955562222,1575990012),a(2024104815,1125592928),a(2227730452,2716904306),a(2361852424,442776044),a(2428436474,593698344),a(2756734187,3733110249),a(3204031479,2999351573),a(3329325298,3815920427),a(3391569614,3928383900),a(3515267271,566280711),a(3940187606,3454069534),a(4118630271,4000239992),a(116418474,1914138554),a(174292421,2731055270),a(289380356,3203993006),a(460393269,320620315),a(685471733,587496836),a(852142971,1086792851),a(1017036298,365543100),a(1126000580,2618297676),a(1288033470,3409855158),a(1501505948,4234509866),a(1607167915,987167468),a(1816402316,1246189591)],n=[];(function(){for(var l=0;80>l;l++)n[l]=a()})();e=e.SHA512=m.extend({_doReset:function(){this._hash=r.create([a(1779033703,4089235720),a(3144134277,2227873595),a(1013904242,4271175723),a(2773480762,1595750129),a(1359893119,2917565137),a(2600822924,725511199),a(528734635,4215389547),a(1541459225,327033209)])},_doProcessBlock:function(a,e){for(var h=this._hash.words,g=h[0],k=h[1],b=h[2],d=h[3],c=h[4],i=h[5],m=h[6],h=h[7],q=g.high,r=g.low,W=k.high,K=k.low,X=b.high,L=b.low,Y=d.high,M=d.low,Z=c.high,N=c.low,$=i.high,O=i.low,aa=m.high,P=m.low,ba=h.high,Q=h.low,t=q,o=r,E=W,C=K,F=X,D=L,T=Y,G=M,u=Z,p=N,R=$,H=O,S=aa,I=P,U=ba,J=Q,v=0;80>v;v++){var z=n[v];if(16>v)var s=z.high=a[e+2*v]|0,f=z.low=a[e+2*v+1]|0;else{var s=n[v-15],f=s.high,w=s.low,s=(w<<31|f>>>1)^(w<<24|f>>>8)^f>>>7,w=(f<<31|w>>>1)^(f<<24|w>>>8)^(f<<25|w>>>7),B=n[v-2],f=B.high,j=B.low,B=(j<<13|f>>>19)^(f<<3|j>>>29)^f>>>6,j=(f<<13|j>>>19)^(j<<3|f>>>29)^(f<<26|j>>>6),f=n[v-7],V=f.high,A=n[v-16],x=A.high,A=A.low,f=w+f.low,s=s+V+(f>>>0<w>>>0?1:0),f=f+j,s=s+B+(f>>>0<j>>>0?1:0),f=f+A,s=s+x+(f>>>0<A>>>0?1:0);z.high=s;z.low=f}var V=u&R^~u&S,A=p&H^~p&I,z=t&E^t&F^E&F,fa=o&C^o&D^C&D,w=(o<<4|t>>>28)^(t<<30|o>>>2)^(t<<25|o>>>7),B=(t<<4|o>>>28)^(o<<30|t>>>2)^(o<<25|t>>>7),j=y[v],ga=j.high,ca=j.low,j=J+((u<<18|p>>>14)^(u<<14|p>>>18)^(p<<23|u>>>9)),x=U+((p<<18|u>>>14)^(p<<14|u>>>18)^(u<<23|p>>>9))+(j>>>0<J>>>0?1:0),j=j+A,x=x+V+(j>>>0<A>>>0?1:0),j=j+ca,x=x+ga+(j>>>0<ca>>>0?1:0),j=j+f,x=x+s+(j>>>0<f>>>0?1:0),f=B+fa,z=w+z+(f>>>0<B>>>0?1:0),U=S,J=I,S=R,I=H,R=u,H=p,p=G+j|0,u=T+x+(p>>>0<G>>>0?1:0)|0,T=F,G=D,F=E,D=C,E=t,C=o,o=j+f|0,t=x+z+(o>>>0<j>>>0?1:0)|0}r=g.low=r+o|0;g.high=q+t+(r>>>0<o>>>0?1:0)|0;K=k.low=K+C|0;k.high=W+E+(K>>>0<C>>>0?1:0)|0;L=b.low=L+D|0;b.high=X+F+(L>>>0<D>>>0?1:0)|0;M=d.low=M+G|0;d.high=Y+T+(M>>>0<G>>>0?1:0)|0;N=c.low=N+p|0;c.high=Z+u+(N>>>0<p>>>0?1:0)|0;O=i.low=O+H|0;i.high=$+R+(O>>>0<H>>>0?1:0)|0;P=m.low=P+I|0;m.high=aa+S+(P>>>0<I>>>0?1:0)|0;Q=h.low=Q+J|0;h.high=ba+U+(Q>>>0<J>>>0?1:0)|0},_doFinalize:function(){var a=this._data,e=a.words,h=8*this._nDataBytes,g=8*a.sigBytes;e[g>>>5]|=128<<24-g%32;e[(g+128>>>10<<5)+31]=h;a.sigBytes=4*e.length;this._process();this._hash=this._hash.toX32()},blockSize:32});g.SHA512=m._createHelper(e);g.HmacSHA512=m._createHmacHelper(e)})();function rstr2hex(input){try{hexcase}catch(e){hexcase=0}var hex_tab=hexcase?"0123456789ABCDEF":"0123456789abcdef";var output="";var x;for(var i=0;i<input.length;i++){x=input.charCodeAt(i);output+=hex_tab.charAt(x>>>4&15)+hex_tab.charAt(x&15)}return output}function str2rstr_utf8(input){var output="";var i=-1;var x,y;while(++i<input.length){x=input.charCodeAt(i);y=i+1<input.length?input.charCodeAt(i+1):0;if(55296<=x&&x<=56319&&56320<=y&&y<=57343){x=65536+((x&1023)<<10)+(y&1023);i++}if(x<=127)output+=String.fromCharCode(x);else if(x<=2047)output+=String.fromCharCode(192|x>>>6&31,128|x&63);else if(x<=65535)output+=String.fromCharCode(224|x>>>12&15,128|x>>>6&63,128|x&63);else if(x<=2097151)output+=String.fromCharCode(240|x>>>18&7,128|x>>>12&63,128|x>>>6&63,128|x&63)}return output}function rstr2binb(input){var output=Array(input.length>>2);for(var i=0;i<output.length;i++)output[i]=0;for(var i=0;i<input.length*8;i+=8)output[i>>5]|=(input.charCodeAt(i/8)&255)<<24-i%32;return output}function binb2rstr(input){var output="";for(var i=0;i<input.length*32;i+=8)output+=String.fromCharCode(input[i>>5]>>>24-i%32&255);return output}var sha512_k;function binb_sha512(x,len){if(sha512_k==undefined){sha512_k=new Array(new int64(1116352408,-685199838),new int64(1899447441,602891725),new int64(-1245643825,-330482897),new int64(-373957723,-2121671748),new int64(961987163,-213338824),new int64(1508970993,-1241133031),new int64(-1841331548,-1357295717),new int64(-1424204075,-630357736),new int64(-670586216,-1560083902),new int64(310598401,1164996542),new int64(607225278,1323610764),new int64(1426881987,-704662302),new int64(1925078388,-226784913),new int64(-2132889090,991336113),new int64(-1680079193,633803317),new int64(-1046744716,-815192428),new int64(-459576895,-1628353838),new int64(-272742522,944711139),new int64(264347078,-1953704523),new int64(604807628,2007800933),new int64(770255983,1495990901),new int64(1249150122,1856431235),new int64(1555081692,-1119749164),new int64(1996064986,-2096016459),new int64(-1740746414,-295247957),new int64(-1473132947,766784016),new int64(-1341970488,-1728372417),new int64(-1084653625,-1091629340),new int64(-958395405,1034457026),new int64(-710438585,-1828018395),new int64(113926993,-536640913),new int64(338241895,168717936),new int64(666307205,1188179964),new int64(773529912,1546045734),new int64(1294757372,1522805485),new int64(1396182291,-1651133473),new int64(1695183700,-1951439906),new int64(1986661051,1014477480),new int64(-2117940946,1206759142),new int64(-1838011259,344077627),new int64(-1564481375,1290863460),new int64(-1474664885,-1136513023),new int64(-1035236496,-789014639),new int64(-949202525,106217008),new int64(-778901479,-688958952),new int64(-694614492,1432725776),new int64(-200395387,1467031594),new int64(275423344,851169720),new int64(430227734,-1194143544),new int64(506948616,1363258195),new int64(659060556,-544281703),new int64(883997877,-509917016),new int64(958139571,-976659869),new int64(1322822218,-482243893),new int64(1537002063,2003034995),new int64(1747873779,-692930397),new int64(1955562222,1575990012),new int64(2024104815,1125592928),new int64(-2067236844,-1578062990),new int64(-1933114872,442776044),new int64(-1866530822,593698344),new int64(-1538233109,-561857047),new int64(-1090935817,-1295615723),new int64(-965641998,-479046869),new int64(-903397682,-366583396),new int64(-779700025,566280711),new int64(-354779690,-840897762),new int64(-176337025,-294727304),new int64(116418474,1914138554),new int64(174292421,-1563912026),new int64(289380356,-1090974290),new int64(460393269,320620315),new int64(685471733,587496836),new int64(852142971,1086792851),new int64(1017036298,365543100),new int64(1126000580,-1676669620),new int64(1288033470,-885112138),new int64(1501505948,-60457430),new int64(1607167915,987167468),new int64(1816402316,1246189591))}var H=new Array(new int64(1779033703,-205731576),new int64(-1150833019,-2067093701),new int64(1013904242,-23791573),new int64(-1521486534,1595750129),new int64(1359893119,-1377402159),new int64(-1694144372,725511199),new int64(528734635,-79577749),new int64(1541459225,327033209));var T1=new int64(0,0),T2=new int64(0,0),a=new int64(0,0),b=new int64(0,0),c=new int64(0,0),d=new int64(0,0),e=new int64(0,0),f=new int64(0,0),g=new int64(0,0),h=new int64(0,0),s0=new int64(0,0),s1=new int64(0,0),Ch=new int64(0,0),Maj=new int64(0,0),r1=new int64(0,0),r2=new int64(0,0),r3=new int64(0,0);var j,i;var W=new Array(80);for(i=0;i<80;i++)W[i]=new int64(0,0);x[len>>5]|=128<<24-(len&31);x[(len+128>>10<<5)+31]=len;for(i=0;i<x.length;i+=32){int64copy(a,H[0]);int64copy(b,H[1]);int64copy(c,H[2]);int64copy(d,H[3]);int64copy(e,H[4]);int64copy(f,H[5]);int64copy(g,H[6]);int64copy(h,H[7]);for(j=0;j<16;j++){W[j].h=x[i+2*j];W[j].l=x[i+2*j+1]}for(j=16;j<80;j++){int64rrot(r1,W[j-2],19);int64revrrot(r2,W[j-2],29);int64shr(r3,W[j-2],6);s1.l=r1.l^r2.l^r3.l;s1.h=r1.h^r2.h^r3.h;int64rrot(r1,W[j-15],1);int64rrot(r2,W[j-15],8);int64shr(r3,W[j-15],7);s0.l=r1.l^r2.l^r3.l;s0.h=r1.h^r2.h^r3.h;int64add4(W[j],s1,W[j-7],s0,W[j-16])}for(j=0;j<80;j++){Ch.l=e.l&f.l^~e.l&g.l;Ch.h=e.h&f.h^~e.h&g.h;int64rrot(r1,e,14);int64rrot(r2,e,18);int64revrrot(r3,e,9);s1.l=r1.l^r2.l^r3.l;s1.h=r1.h^r2.h^r3.h;int64rrot(r1,a,28);int64revrrot(r2,a,2);int64revrrot(r3,a,7);s0.l=r1.l^r2.l^r3.l;s0.h=r1.h^r2.h^r3.h;Maj.l=a.l&b.l^a.l&c.l^b.l&c.l;Maj.h=a.h&b.h^a.h&c.h^b.h&c.h;int64add5(T1,h,s1,Ch,sha512_k[j],W[j]);int64add(T2,s0,Maj);int64copy(h,g);int64copy(g,f);int64copy(f,e);int64add(e,d,T1);int64copy(d,c);int64copy(c,b);int64copy(b,a);int64add(a,T1,T2)}int64add(H[0],H[0],a);int64add(H[1],H[1],b);int64add(H[2],H[2],c);int64add(H[3],H[3],d);int64add(H[4],H[4],e);int64add(H[5],H[5],f);int64add(H[6],H[6],g);int64add(H[7],H[7],h)}var hash=new Array(16);for(i=0;i<8;i++){hash[2*i]=H[i].h;hash[2*i+1]=H[i].l}return hash}function int64(h,l){this.h=h;this.l=l}function int64copy(dst,src){dst.h=src.h;dst.l=src.l}function int64rrot(dst,x,shift){dst.l=x.l>>>shift|x.h<<32-shift;dst.h=x.h>>>shift|x.l<<32-shift}function int64revrrot(dst,x,shift){dst.l=x.h>>>shift|x.l<<32-shift;dst.h=x.l>>>shift|x.h<<32-shift}function int64shr(dst,x,shift){dst.l=x.l>>>shift|x.h<<32-shift;dst.h=x.h>>>shift}function int64add(dst,x,y){var w0=(x.l&65535)+(y.l&65535);var w1=(x.l>>>16)+(y.l>>>16)+(w0>>>16);var w2=(x.h&65535)+(y.h&65535)+(w1>>>16);var w3=(x.h>>>16)+(y.h>>>16)+(w2>>>16);dst.l=w0&65535|w1<<16;dst.h=w2&65535|w3<<16}function int64add4(dst,a,b,c,d){var w0=(a.l&65535)+(b.l&65535)+(c.l&65535)+(d.l&65535);var w1=(a.l>>>16)+(b.l>>>16)+(c.l>>>16)+(d.l>>>16)+(w0>>>16);var w2=(a.h&65535)+(b.h&65535)+(c.h&65535)+(d.h&65535)+(w1>>>16);var w3=(a.h>>>16)+(b.h>>>16)+(c.h>>>16)+(d.h>>>16)+(w2>>>16);dst.l=w0&65535|w1<<16;dst.h=w2&65535|w3<<16}function int64add5(dst,a,b,c,d,e){var w0=(a.l&65535)+(b.l&65535)+(c.l&65535)+(d.l&65535)+(e.l&65535);var w1=(a.l>>>16)+(b.l>>>16)+(c.l>>>16)+(d.l>>>16)+(e.l>>>16)+(w0>>>16);var w2=(a.h&65535)+(b.h&65535)+(c.h&65535)+(d.h&65535)+(e.h&65535)+(w1>>>16);var w3=(a.h>>>16)+(b.h>>>16)+(c.h>>>16)+(d.h>>>16)+(e.h>>>16)+(w2>>>16);dst.l=w0&65535|w1<<16;dst.h=w2&65535|w3<<16}return hex_sha512}({});</script>
        <script>var saveAs=saveAs||function(e){"use strict";if(typeof e==="undefined"||typeof navigator!=="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent)){return}var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in r,a=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},i=/constructor/i.test(e.HTMLElement)||e.safari,f=/CriOS\/[\d]+/.test(navigator.userAgent),u=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},s="application/octet-stream",d=1e3*40,c=function(e){var t=function(){if(typeof e==="string"){n().revokeObjectURL(e)}else{e.remove()}};setTimeout(t,d)},l=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var o=e["on"+t[r]];if(typeof o==="function"){try{o.call(e,n||e)}catch(a){u(a)}}}},p=function(e){if(/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)){return new Blob([String.fromCharCode(65279),e],{type:e.type})}return e},v=function(t,u,d){if(!d){t=p(t)}var v=this,w=t.type,m=w===s,y,h=function(){l(v,"writestart progress write writeend".split(" "))},S=function(){if((f||m&&i)&&e.FileReader){var r=new FileReader;r.onloadend=function(){var t=f?r.result:r.result.replace(/^data:[^;]*;/,"data:attachment/file;");var n=e.open(t,"_blank");if(!n)e.location.href=t;t=undefined;v.readyState=v.DONE;h()};r.readAsDataURL(t);v.readyState=v.INIT;return}if(!y){y=n().createObjectURL(t)}if(m){e.location.href=y}else{var o=e.open(y,"_blank");if(!o){e.location.href=y}}v.readyState=v.DONE;h();c(y)};v.readyState=v.INIT;if(o){y=n().createObjectURL(t);setTimeout(function(){r.href=y;r.download=u;a(r);h();c(y);v.readyState=v.DONE});return}S()},w=v.prototype,m=function(e,t,n){return new v(e,t||e.name||"download",n)};if(typeof navigator!=="undefined"&&navigator.msSaveOrOpenBlob){return function(e,t,n){t=t||e.name||"download";if(!n){e=p(e)}return navigator.msSaveOrOpenBlob(e,t)}}w.abort=function(){};w.readyState=w.INIT=0;w.WRITING=1;w.DONE=2;w.error=w.onwritestart=w.onprogress=w.onwrite=w.onabort=w.onerror=w.onwriteend=null;return m}(typeof self!=="undefined"&&self||typeof window!=="undefined"&&window||this.content);if(typeof module!=="undefined"&&module.exports){module.exports.saveAs=saveAs}else if(typeof define!=="undefined"&&define!==null&&define.amd!==null){define("FileSaver.js",function(){return saveAs})}</script>
        <script src="langs.js"></script>
        <script>
            const urlParams = new URLSearchParams(window.location.search);
            var world,
                FPS = 67,
                lastTime = 0;
            window.onload = async function () {
                world = new WorldMorph(document.getElementById('world'));
                (ide = new IDE_Morph()).openIn(world);
                ide.hide();
                loop();
                ide.setUnifiedPalette(true);
                try {
                  data = await (fetch(urlParams.get('file') ?? 'Project.xml').then(r=>r.text()));
                } catch (error) {
                  ide.show();
                  new MenuMorph(null, `Load failed: fetch() error: ${error}`).popUpCenteredInWorld(world);
                  throw error;
                  return;
                }
                try {
                  const parser = new DOMParser();
                  const doc = parser.parseFromString(data, "application/xml");
                  const errorNode = doc.querySelector("parsererror");
                  if (errorNode !== null) {
                    ide.show();
                    new MenuMorph(null, `Load failed: XML Parsing error: ${errorNode}`).popUpCenteredInWorld(world);
                    throw errorNode;
                    return;
                  }
                } catch (error) {
                  ide.show();
                  new MenuMorph(null, `Load failed: error while checking for parsing errors: ${error}`).popUpCenteredInWorld(world);
                  throw error;
                  return;
                }
                ide.rawOpenProjectString(data);
                if (urlParams.get('devmode')) {
                  ide.show();
                } else {
                  ide.controlBar.hide();
                  ide.toggleAppMode(true);
                  ide.controlBar.hide();
                  var handle = setInterval(function () {
                      var allSpritesDone = true;
                      ide.stage.children.forEach(function (child) {
                          if (!child.costumes) { // If the child has no costumes it doesn't matter
                              return;
                          }
            
                          if (!child.costumes.length()) { // If the length of the costume array is 0 it's the same as if it has none
                              return;
                          }

                          var costumes = child.costumes.asArray();
                          const someCostumeNotLoaded = costumes.some(function (costume) {
                              return typeof costume.loaded === 'function';
                          });

                          if (someCostumeNotLoaded || !child.costume) {
                              allSpritesDone = false;
                          }
                      });

                      if (allSpritesDone) {
                          clearInterval(handle);
                          ide.show();
                          ide.runScripts();
                      }
                  }, 100);
                }
            };
            function loop(timestamp) {
                requestAnimationFrame(loop);
                if (timestamp - lastTime < 1000 / FPS) {
                    return;
                }
                world.doOneCycle();
                lastTime = timestamp;
            }
        </script>
    </head>
    <body style="margin: 0;">
        <canvas id="world" tabindex="1" style="position: absolute;"></canvas>
    </body>
</html>
